<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds             #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns        #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes            #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards       #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables   #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="annot"><span class="hs-comment">-- | Intended for qualified import</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Network.NodeToNode</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Handlers</span></span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Handlers"><span class="hs-identifier">Handlers</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#mkHandlers"><span class="hs-identifier">mkHandlers</span></a></span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Codecs</span></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier">Codecs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#defaultCodecs"><span class="hs-identifier">defaultCodecs</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#identityCodecs"><span class="hs-identifier">identityCodecs</span></a></span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Byte Limits</span></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier">ByteLimits</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#byteLimits"><span class="hs-identifier">byteLimits</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#noByteLimits"><span class="hs-identifier">noByteLimits</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Tracers</span></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier">Tracers</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers%27"><span class="hs-identifier">Tracers'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#nullTracers"><span class="hs-identifier">nullTracers</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#showTracers"><span class="hs-identifier">showTracers</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Applications</span></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier">Apps</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ClientApp"><span class="hs-identifier">ClientApp</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ServerApp"><span class="hs-identifier">ServerApp</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#mkApps"><span class="hs-identifier">mkApps</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Projections</span></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#initiator"><span class="hs-identifier">initiator</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#initiatorAndResponder"><span class="hs-identifier">initiatorAndResponder</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-exports</span></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ChainSyncTimeout</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Decoding</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decoder</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Decoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Encoding</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Encoding</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Read</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DeserialiseFailure</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.Strict.TVar</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TVar.Unchecked</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime.SI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer.SI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadTimer</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BSL</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Int.html"><span class="hs-identifier">Data.Int</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Int.html#Int64"><span class="hs-identifier">Int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Void.html"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Network.TypedProtocol.Codec</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Block</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsMempool</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.BlockFetch.Server</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.ChainSync.Client</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CsClient</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.ChainSync.Server</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Node.ExitPolicy.html"><span class="hs-identifier">Ouroboros.Consensus.Node.ExitPolicy</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Node.NetworkProtocolVersion</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Node.Run</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Node.Serialisation</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Node.Tracers.html"><span class="hs-identifier">Ouroboros.Consensus.Node.Tracers</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Node</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.NodeKernel.html"><span class="hs-identifier">Ouroboros.Consensus.NodeKernel</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainDB</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Storage.Serialisation</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SerialisedHeader</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Util</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ShowProxy</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Util.Orphans</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Serialised</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">decodePoint</span></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>                     </span><span class="annot"><span class="hs-identifier">decodeTip</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">encodePoint</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">encodeTip</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.BlockFetch</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.BlockFetch.Client</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BlockFetchClient</span></span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>                     </span><span class="annot"><span class="hs-identifier">blockFetchClient</span></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Channel</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Context</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.DeltaQ</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Driver</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Driver.Limits</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.KeepAlive</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Mux</span></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.NodeToNode</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.NodeToNode.Version</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isPipeliningEnabled</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerMetric.Type</span></span><span>
</span><span id="line-88"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FetchedMetricsTracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ReportPeerMetrics</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerSharing</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PSTypes</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.PeerSharing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PeerSharingController</span></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>                     </span><span class="annot"><span class="hs-identifier">bracketPeerSharingClient</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">peerSharingClient</span></span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>                     </span><span class="annot"><span class="hs-identifier">peerSharingServer</span></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.BlockFetch.Codec</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.BlockFetch.Server</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BlockFetchServer</span></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>                     </span><span class="annot"><span class="hs-identifier">blockFetchServerPeer</span></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.BlockFetch.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BlockFetch</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.ClientPipelined</span></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Codec</span></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.PipelineDecision</span></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Server</span></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Type</span></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.KeepAlive.Client</span></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.KeepAlive.Codec</span></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.KeepAlive.Server</span></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.KeepAlive.Type</span></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.PeerSharing.Client</span></span><span>
</span><span id="line-107"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PeerSharingClient</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">peerSharingClientPeer</span></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.PeerSharing.Codec</span></span><span>
</span><span id="line-109"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">byteLimitsPeerSharing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">codecPeerSharing</span></span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>                     </span><span class="annot"><span class="hs-identifier">codecPeerSharingId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">timeLimitsPeerSharing</span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.PeerSharing.Server</span></span><span>
</span><span id="line-112"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PeerSharingServer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">peerSharingServerPeer</span></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.PeerSharing.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PeerSharing</span></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>                     </span><span class="annot"><span class="hs-identifier">PeerSharingAmount</span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission2.Client</span></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission2.Codec</span></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission2.Server</span></span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission2.Type</span></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.TxSubmission.Inbound</span></span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.TxSubmission.Mempool.Reader</span></span><span>
</span><span id="line-121"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapTxSubmissionMempoolReader</span></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.TxSubmission.Outbound</span></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Handlers
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="annot"><span class="hs-comment">-- | Protocol handlers for node-to-node (remote) communication</span></span><span>
</span><span id="line-129"></span><span class="hs-keyword">data</span><span> </span><span id="Handlers"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Handlers"><span class="hs-identifier hs-var">Handlers</span></a></span></span><span> </span><span id="local-6989586621679181651"><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679181652"><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span></span><span> </span><span id="local-6989586621679181653"><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Handlers"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Handlers"><span class="hs-identifier hs-var">Handlers</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-130"></span><span>      </span><span id="hChainSyncClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; ConnectionId addr
-&gt; IsBigLedgerPeer
-&gt; DynamicEnv m blk
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hChainSyncClient"><span class="hs-identifier hs-var hs-var">hChainSyncClient</span></a></span></span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IsBigLedgerPeer</span></span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CsClient.DynamicEnv</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainSyncClientPipelined</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-135"></span><span>             </span><span class="annot"><span class="hs-identifier hs-type">CsClient.ChainSyncClientResult</span></span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-comment">-- TODO: we should reconsider bundling these context parameters into a</span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-comment">-- record, perhaps instead extending the protocol handler</span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-comment">-- representation to support bracket-style initialisation so that we</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-comment">-- could have the closure include these and not need to be explicit</span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-comment">-- about them here.</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hChainSyncServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; ConnectionId addr
-&gt; NodeToNodeVersion
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hChainSyncServer"><span class="hs-identifier hs-var hs-var">hChainSyncServer</span></a></span></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainDB.Follower</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainDB.WithPoint</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SerialisedHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainSyncServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SerialisedHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">-- TODO block fetch client does not have GADT view of the handlers.</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hBlockFetchClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; BlockFetchClient (Header blk) blk m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hBlockFetchClient"><span class="hs-identifier hs-var hs-var">hBlockFetchClient</span></a></span></span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ControlMessageSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchedMetricsTracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockFetchClient</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hBlockFetchServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; ConnectionId addr
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hBlockFetchServer"><span class="hs-identifier hs-var hs-var">hBlockFetchServer</span></a></span></span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResourceRegistry</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockFetchServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Serialised</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hTxSubmissionClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addr
-&gt; TxSubmissionClient (GenTxId blk) (GenTx blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hTxSubmissionClient"><span class="hs-identifier hs-var hs-var">hTxSubmissionClient</span></a></span></span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ControlMessageSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSubmissionClient</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTxId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hTxSubmissionServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ConnectionId addr
-&gt; TxSubmissionServerPipelined (GenTxId blk) (GenTx blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hTxSubmissionServer"><span class="hs-identifier hs-var hs-var">hTxSubmissionServer</span></a></span></span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSubmissionServerPipelined</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTxId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679181653"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hKeepAliveClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addr
-&gt; StrictTVar m (Map (ConnectionId addr) PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hKeepAliveClient"><span class="hs-identifier hs-var hs-var">hKeepAliveClient</span></a></span></span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ControlMessageSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar.Unchecked.StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerGSV</span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">KeepAliveInterval</span></span><span>
</span><span id="line-178"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">KeepAliveClient</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hKeepAliveServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion -&gt; ConnectionId addr -&gt; KeepAliveServer m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hKeepAliveServer"><span class="hs-identifier hs-var hs-var">hKeepAliveServer</span></a></span></span><span>
</span><span id="line-181"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">KeepAliveServer</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hPeerSharingClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addr
-&gt; PeerSharingController addr m
-&gt; m (PeerSharingClient addr m ())
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hPeerSharingClient"><span class="hs-identifier hs-var hs-var">hPeerSharingClient</span></a></span></span><span>
</span><span id="line-186"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-187"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ControlMessageSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-188"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-189"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerSharingController</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PeerSharingClient</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="hPeerSharingServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ConnectionId addr
-&gt; PeerSharingServer addr m
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hPeerSharingServer"><span class="hs-identifier hs-var hs-var">hPeerSharingServer</span></a></span></span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-194"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-195"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerSharingServer</span></span><span> </span><span class="annot"><a href="#local-6989586621679181652"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#mkHandlers"><span class="hs-identifier hs-type">mkHandlers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-199"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679181717"><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679181721"><span class="annot"><a href="#local-6989586621679181721"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679181725"><span class="annot"><a href="#local-6989586621679181725"><span class="hs-identifier hs-type">addrNTN</span></a></span></span><span> </span><span id="local-6989586621679181726"><span class="annot"><a href="#local-6989586621679181726"><span class="hs-identifier hs-type">addrNTC</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-200"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOLike</span></span><span> </span><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-201"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTime</span></span><span> </span><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-202"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTimer</span></span><span> </span><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-203"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></span><span> </span><span class="annot"><a href="#local-6989586621679181721"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-204"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasTxId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679181721"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></span><span> </span><span class="annot"><a href="#local-6989586621679181721"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-206"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181725"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>
</span><span id="line-207"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.NodeKernel.html#NodeKernelArgs"><span class="hs-identifier hs-type">NodeKernelArgs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181725"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181726"><span class="hs-identifier hs-type">addrNTC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181721"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.NodeKernel.html#NodeKernel"><span class="hs-identifier hs-type">NodeKernel</span></a></span><span>     </span><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181725"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181726"><span class="hs-identifier hs-type">addrNTC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181721"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PeerSharingAmount</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679181725"><span class="hs-identifier hs-type">addrNTN</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Peer Sharing result computation callback</span></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Handlers"><span class="hs-identifier hs-type">Handlers</span></a></span><span>       </span><span class="annot"><a href="#local-6989586621679181717"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181725"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>           </span><span class="annot"><a href="#local-6989586621679181721"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-213"></span><span id="mkHandlers"><span class="annot"><span class="annottext">mkHandlers :: forall (m :: * -&gt; *) blk addrNTN addrNTC.
(IOLike m, MonadTime m, MonadTimer m, LedgerSupportsMempool blk,
 HasTxId (GenTx blk), LedgerSupportsProtocol blk, Ord addrNTN) =&gt;
NodeKernelArgs m addrNTN addrNTC blk
-&gt; NodeKernel m addrNTN addrNTC blk
-&gt; (PeerSharingAmount -&gt; m [addrNTN])
-&gt; Handlers m addrNTN blk
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#mkHandlers"><span class="hs-identifier hs-var hs-var">mkHandlers</span></a></span></span><span>
</span><span id="line-214"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.NodeKernel.html#NodeKernelArgs"><span class="hs-identifier hs-type">NodeKernelArgs</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679182757"><span class="annot"><span class="annottext">SomeHeaderInFutureCheck m blk
chainSyncFutureCheck :: SomeHeaderInFutureCheck m blk
$sel:chainSyncFutureCheck:NodeKernelArgs :: forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernelArgs m addrNTN addrNTC blk
-&gt; SomeHeaderInFutureCheck m blk
</span><a href="#local-6989586621679182757"><span class="hs-identifier hs-var hs-var">chainSyncFutureCheck</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679182759"><span class="annot"><span class="annottext">StdGen
keepAliveRng :: StdGen
$sel:keepAliveRng:NodeKernelArgs :: forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernelArgs m addrNTN addrNTC blk -&gt; StdGen
</span><a href="#local-6989586621679182759"><span class="hs-identifier hs-var hs-var">keepAliveRng</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679182761"><span class="annot"><span class="annottext">MiniProtocolParameters
miniProtocolParameters :: MiniProtocolParameters
$sel:miniProtocolParameters:NodeKernelArgs :: forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernelArgs m addrNTN addrNTC blk -&gt; MiniProtocolParameters
</span><a href="#local-6989586621679182761"><span class="hs-identifier hs-var hs-var">miniProtocolParameters</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-215"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.NodeKernel.html#NodeKernel"><span class="hs-identifier hs-type">NodeKernel</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679182764"><span class="annot"><span class="annottext">ChainDB m blk
getChainDB :: ChainDB m blk
$sel:getChainDB:NodeKernel :: forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk -&gt; ChainDB m blk
</span><a href="#local-6989586621679182764"><span class="hs-identifier hs-var hs-var">getChainDB</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679182766"><span class="annot"><span class="annottext">Mempool m blk
getMempool :: Mempool m blk
$sel:getMempool:NodeKernel :: forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk -&gt; Mempool m blk
</span><a href="#local-6989586621679182766"><span class="hs-identifier hs-var hs-var">getMempool</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679182768"><span class="annot"><span class="annottext">TopLevelConfig blk
getTopLevelConfig :: TopLevelConfig blk
$sel:getTopLevelConfig:NodeKernel :: forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk -&gt; TopLevelConfig blk
</span><a href="#local-6989586621679182768"><span class="hs-identifier hs-var hs-var">getTopLevelConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getTracers:NodeKernel :: forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk
-&gt; Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetTracers%3ANodeKernel"><span class="hs-identifier hs-var">getTracers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679182771"><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="#local-6989586621679182771"><span class="hs-identifier hs-var">tracers</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-216"></span><span>      </span><span id="local-6989586621679182772"><span class="annot"><span class="annottext">PeerSharingAmount -&gt; m [addrNTN]
</span><a href="#local-6989586621679182772"><span class="hs-identifier hs-var">computePeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Handlers"><span class="hs-identifier hs-type">Handlers</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">hChainSyncClient :: ConnectionId addrNTN
-&gt; IsBigLedgerPeer
-&gt; DynamicEnv m blk
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hChainSyncClient"><span class="hs-identifier hs-var">hChainSyncClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182773"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182773"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679182774"><span class="annot"><span class="annottext">IsBigLedgerPeer
</span><a href="#local-6989586621679182774"><span class="hs-identifier hs-var">_isBigLedgerpeer</span></a></span></span><span> </span><span id="local-6989586621679182775"><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679182775"><span class="hs-identifier hs-var">dynEnv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk -&gt; Consensus ChainSyncClientPipelined blk m
</span><span class="hs-identifier hs-var">CsClient.chainSyncClient</span></span><span>
</span><span id="line-220"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">CsClient.ConfigEnv</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-221"></span><span>                </span><span class="annot"><span class="annottext">$sel:cfg:ConfigEnv :: TopLevelConfig blk
</span><span class="hs-identifier hs-var">CsClient.cfg</span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679182768"><span class="hs-identifier hs-var">getTopLevelConfig</span></a></span><span>
</span><span id="line-222"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:someHeaderInFutureCheck:ConfigEnv :: SomeHeaderInFutureCheck m blk
</span><span class="hs-identifier hs-var">CsClient.someHeaderInFutureCheck</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeHeaderInFutureCheck m blk
</span><a href="#local-6989586621679182757"><span class="hs-identifier hs-var">chainSyncFutureCheck</span></a></span><span>
</span><span id="line-223"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:chainDbView:ConfigEnv :: ChainDbView m blk
</span><span class="hs-identifier hs-var">CsClient.chainDbView</span></span><span>             </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>                  </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; ChainDbView m blk
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ChainDB m blk -&gt; ChainDbView m blk
</span><span class="hs-identifier hs-var">CsClient.defaultChainDbView</span></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679182764"><span class="hs-identifier hs-var">getChainDB</span></a></span><span>
</span><span id="line-225"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:mkPipelineDecision0:ConfigEnv :: MkPipelineDecision
</span><span class="hs-identifier hs-var">CsClient.mkPipelineDecision0</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; MkPipelineDecision
</span><span class="hs-identifier hs-var">pipelineDecisionLowHighMark</span></span><span>
</span><span id="line-226"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolParameters -&gt; Word16
</span><span class="hs-identifier hs-var">chainSyncPipeliningLowMark</span></span><span>  </span><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679182761"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolParameters -&gt; Word16
</span><span class="hs-identifier hs-var">chainSyncPipeliningHighMark</span></span><span> </span><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679182761"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:tracer:ConfigEnv :: Tracer m (TraceChainSyncClientEvent blk)
</span><span class="hs-identifier hs-var">CsClient.tracer</span></span><span>                  </span><span class="hs-glyph">=</span><span>
</span><span id="line-229"></span><span>                  </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN) (TraceChainSyncClientEvent blk))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceChainSyncClientEvent blk))
-&gt; Tracer m (TraceChainSyncClientEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceChainSyncClientEvent blk
-&gt; TraceLabelPeer
     (ConnectionId addrNTN) (TraceChainSyncClientEvent blk)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182773"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceChainSyncClientEvent blk))
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceLabelPeer remotePeer (TraceChainSyncClientEvent blk))
</span><a href="Ouroboros.Consensus.Node.Tracers.html#chainSyncClientTracer"><span class="hs-identifier hs-var">Node.chainSyncClientTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="#local-6989586621679182771"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-231"></span><span>            </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679182775"><span class="hs-identifier hs-var">dynEnv</span></a></span><span>
</span><span id="line-232"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hChainSyncServer :: ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hChainSyncServer"><span class="hs-identifier hs-var">hChainSyncServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182790"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182790"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679182791"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182791"><span class="hs-identifier hs-var">_version</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncServerEvent blk)
-&gt; ChainDB m blk
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk)) =&gt;
Tracer m (TraceChainSyncServerEvent blk)
-&gt; ChainDB m blk
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
</span><span class="hs-identifier hs-var">chainSyncHeadersServer</span></span><span>
</span><span id="line-234"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceChainSyncServerEvent blk
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN) (TraceChainSyncServerEvent blk))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceChainSyncServerEvent blk))
-&gt; Tracer m (TraceChainSyncServerEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceChainSyncServerEvent blk
-&gt; TraceLabelPeer
     (ConnectionId addrNTN) (TraceChainSyncServerEvent blk)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182790"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceChainSyncServerEvent blk))
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceLabelPeer remotePeer (TraceChainSyncServerEvent blk))
</span><a href="Ouroboros.Consensus.Node.Tracers.html#chainSyncServerHeaderTracer"><span class="hs-identifier hs-var">Node.chainSyncServerHeaderTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="#local-6989586621679182771"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>            </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679182764"><span class="hs-identifier hs-var">getChainDB</span></a></span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hBlockFetchClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; BlockFetchClient (Header blk) blk m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hBlockFetchClient"><span class="hs-identifier hs-var">hBlockFetchClient</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-237"></span><span>          </span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; BlockFetchClient (Header blk) blk m ()
forall header block versionNumber (m :: * -&gt; *).
(MonadSTM m, MonadThrow m, MonadTime m, MonadMonotonicTime m,
 HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block) =&gt;
versionNumber
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; FetchClientContext header block m
-&gt; PeerPipelined
     (BlockFetch block (Point block)) 'AsClient 'BFIdle m ()
</span><span class="hs-identifier hs-var">blockFetchClient</span></span><span>
</span><span id="line-238"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hBlockFetchServer :: ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hBlockFetchServer"><span class="hs-identifier hs-var">hBlockFetchServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182794"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182794"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span id="local-6989586621679182795"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182795"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceBlockFetchServerEvent blk)
-&gt; ChainDB m blk
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
forall (m :: * -&gt; *) blk.
(IOLike m, StandardHash blk, Typeable blk) =&gt;
Tracer m (TraceBlockFetchServerEvent blk)
-&gt; ChainDB m blk
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
</span><span class="hs-identifier hs-var">blockFetchServer</span></span><span>
</span><span id="line-240"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceBlockFetchServerEvent blk
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN) (TraceBlockFetchServerEvent blk))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceBlockFetchServerEvent blk))
-&gt; Tracer m (TraceBlockFetchServerEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceBlockFetchServerEvent blk
-&gt; TraceLabelPeer
     (ConnectionId addrNTN) (TraceBlockFetchServerEvent blk)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182794"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceBlockFetchServerEvent blk))
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceLabelPeer remotePeer (TraceBlockFetchServerEvent blk))
</span><a href="Ouroboros.Consensus.Node.Tracers.html#blockFetchServerTracer"><span class="hs-identifier hs-var">Node.blockFetchServerTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="#local-6989586621679182771"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>            </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679182764"><span class="hs-identifier hs-var">getChainDB</span></a></span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182795"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hTxSubmissionClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionClient (GenTxId blk) (GenTx blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hTxSubmissionClient"><span class="hs-identifier hs-var">hTxSubmissionClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182798"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182798"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679182799"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679182799"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span> </span><span id="local-6989586621679182800"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182800"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk))
-&gt; Word16
-&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; TxSubmissionClient (GenTxId blk) (GenTx blk) m ()
forall txid tx idx (m :: * -&gt; *).
(Ord txid, Ord idx, MonadSTM m, MonadThrow m) =&gt;
Tracer m (TraceTxSubmissionOutbound txid tx)
-&gt; Word16
-&gt; TxSubmissionMempoolReader txid tx idx m
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; TxSubmissionClient txid tx m ()
</span><span class="hs-identifier hs-var">txSubmissionOutbound</span></span><span>
</span><span id="line-245"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk)
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk)))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk)))
-&gt; Tracer m (TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk)
-&gt; TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182800"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk)))
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceLabelPeer
        remotePeer (TraceTxSubmissionOutbound (GenTxId blk) (GenTx blk)))
</span><a href="Ouroboros.Consensus.Node.Tracers.html#txOutboundTracer"><span class="hs-identifier hs-var">Node.txOutboundTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="#local-6989586621679182771"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolParameters -&gt; Word16
</span><span class="hs-identifier hs-var">txSubmissionMaxUnacked</span></span><span> </span><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679182761"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Validated (GenTx blk) -&gt; GenTx blk)
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
-&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m
forall (m :: * -&gt; *) tx tx' txid idx.
MonadSTM m =&gt;
(tx -&gt; tx')
-&gt; TxSubmissionMempoolReader txid tx idx m
-&gt; TxSubmissionMempoolReader txid tx' idx m
</span><span class="hs-identifier hs-var">mapTxSubmissionMempoolReader</span></span><span> </span><span class="annot"><span class="annottext">Validated (GenTx blk) -&gt; GenTx blk
forall blk.
LedgerSupportsMempool blk =&gt;
Validated (GenTx blk) -&gt; GenTx blk
</span><span class="hs-identifier hs-var">txForgetValidated</span></span><span> </span><span class="annot"><span class="annottext">(TxSubmissionMempoolReader
   (GenTxId blk) (Validated (GenTx blk)) TicketNo m
 -&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m)
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
-&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
forall (m :: * -&gt; *) blk.
(LedgerSupportsMempool blk, IOLike m, HasTxId (GenTx blk)) =&gt;
Mempool m blk
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
</span><a href="Ouroboros.Consensus.NodeKernel.html#getMempoolReader"><span class="hs-identifier hs-var">getMempoolReader</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk
</span><a href="#local-6989586621679182766"><span class="hs-identifier hs-var">getMempool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>            </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182798"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-249"></span><span>            </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679182799"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hTxSubmissionServer :: NodeToNodeVersion
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionServerPipelined (GenTxId blk) (GenTx blk) m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hTxSubmissionServer"><span class="hs-identifier hs-var">hTxSubmissionServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182806"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182806"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679182807"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182807"><span class="hs-identifier hs-var">peer</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceTxSubmissionInbound (GenTxId blk) (GenTx blk))
-&gt; Word16
-&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m
-&gt; TxSubmissionMempoolWriter (GenTxId blk) (GenTx blk) TicketNo m
-&gt; NodeToNodeVersion
-&gt; TxSubmissionServerPipelined (GenTxId blk) (GenTx blk) m ()
forall txid tx idx (m :: * -&gt; *).
(Ord txid, NoThunks txid, NoThunks tx, MonadSTM m, MonadThrow m) =&gt;
Tracer m (TraceTxSubmissionInbound txid tx)
-&gt; Word16
-&gt; TxSubmissionMempoolReader txid tx idx m
-&gt; TxSubmissionMempoolWriter txid tx idx m
-&gt; NodeToNodeVersion
-&gt; TxSubmissionServerPipelined txid tx m ()
</span><span class="hs-identifier hs-var">txSubmissionInbound</span></span><span>
</span><span id="line-252"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceTxSubmissionInbound (GenTxId blk) (GenTx blk)
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceTxSubmissionInbound (GenTxId blk) (GenTx blk)))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceTxSubmissionInbound (GenTxId blk) (GenTx blk)))
-&gt; Tracer m (TraceTxSubmissionInbound (GenTxId blk) (GenTx blk))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceTxSubmissionInbound (GenTxId blk) (GenTx blk)
-&gt; TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceTxSubmissionInbound (GenTxId blk) (GenTx blk))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182807"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceTxSubmissionInbound (GenTxId blk) (GenTx blk)))
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceLabelPeer
        remotePeer (TraceTxSubmissionInbound (GenTxId blk) (GenTx blk)))
</span><a href="Ouroboros.Consensus.Node.Tracers.html#txInboundTracer"><span class="hs-identifier hs-var">Node.txInboundTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="#local-6989586621679182771"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolParameters -&gt; Word16
</span><span class="hs-identifier hs-var">txSubmissionMaxUnacked</span></span><span> </span><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679182761"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Validated (GenTx blk) -&gt; GenTx blk)
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
-&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m
forall (m :: * -&gt; *) tx tx' txid idx.
MonadSTM m =&gt;
(tx -&gt; tx')
-&gt; TxSubmissionMempoolReader txid tx idx m
-&gt; TxSubmissionMempoolReader txid tx' idx m
</span><span class="hs-identifier hs-var">mapTxSubmissionMempoolReader</span></span><span> </span><span class="annot"><span class="annottext">Validated (GenTx blk) -&gt; GenTx blk
forall blk.
LedgerSupportsMempool blk =&gt;
Validated (GenTx blk) -&gt; GenTx blk
</span><span class="hs-identifier hs-var">txForgetValidated</span></span><span> </span><span class="annot"><span class="annottext">(TxSubmissionMempoolReader
   (GenTxId blk) (Validated (GenTx blk)) TicketNo m
 -&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m)
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
-&gt; TxSubmissionMempoolReader (GenTxId blk) (GenTx blk) TicketNo m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
forall (m :: * -&gt; *) blk.
(LedgerSupportsMempool blk, IOLike m, HasTxId (GenTx blk)) =&gt;
Mempool m blk
-&gt; TxSubmissionMempoolReader
     (GenTxId blk) (Validated (GenTx blk)) TicketNo m
</span><a href="Ouroboros.Consensus.NodeKernel.html#getMempoolReader"><span class="hs-identifier hs-var">getMempoolReader</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk
</span><a href="#local-6989586621679182766"><span class="hs-identifier hs-var">getMempool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Mempool m blk
-&gt; TxSubmissionMempoolWriter (GenTxId blk) (GenTx blk) TicketNo m
forall blk (m :: * -&gt; *).
(LedgerSupportsMempool blk, IOLike m, HasTxId (GenTx blk)) =&gt;
Mempool m blk
-&gt; TxSubmissionMempoolWriter (GenTxId blk) (GenTx blk) TicketNo m
</span><a href="Ouroboros.Consensus.NodeKernel.html#getMempoolWriter"><span class="hs-identifier hs-var">getMempoolWriter</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk
</span><a href="#local-6989586621679182766"><span class="hs-identifier hs-var">getMempool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>            </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182806"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hKeepAliveClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hKeepAliveClient"><span class="hs-identifier hs-var">hKeepAliveClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182811"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182811"><span class="hs-identifier hs-var">_version</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceKeepAliveClient (ConnectionId addrNTN))
-&gt; StdGen
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
forall (m :: * -&gt; *) peer.
(MonadTimer m, Ord peer) =&gt;
Tracer m (TraceKeepAliveClient peer)
-&gt; StdGen
-&gt; ControlMessageSTM m
-&gt; peer
-&gt; StrictTVar m (Map peer PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
</span><span class="hs-identifier hs-var">keepAliveClient</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
-&gt; Tracer m (TraceKeepAliveClient (ConnectionId addrNTN))
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceKeepAliveClient remotePeer)
</span><a href="Ouroboros.Consensus.Node.Tracers.html#keepAliveClientTracer"><span class="hs-identifier hs-var">Node.keepAliveClientTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="#local-6989586621679182771"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679182759"><span class="hs-identifier hs-var">keepAliveRng</span></a></span><span>
</span><span id="line-258"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hKeepAliveServer :: NodeToNodeVersion -&gt; ConnectionId addrNTN -&gt; KeepAliveServer m ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hKeepAliveServer"><span class="hs-identifier hs-var">hKeepAliveServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182814"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182814"><span class="hs-identifier hs-var">_version</span></a></span></span><span> </span><span id="local-6989586621679182815"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182815"><span class="hs-identifier hs-var">_peer</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KeepAliveServer m ()
forall (m :: * -&gt; *). Applicative m =&gt; KeepAliveServer m ()
</span><span class="hs-identifier hs-var">keepAliveServer</span></span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hPeerSharingClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; PeerSharingController addrNTN m
-&gt; m (PeerSharingClient addrNTN m ())
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hPeerSharingClient"><span class="hs-identifier hs-var">hPeerSharingClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182817"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182817"><span class="hs-identifier hs-var">_version</span></a></span></span><span> </span><span id="local-6989586621679182818"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679182818"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span> </span><span id="local-6989586621679182819"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182819"><span class="hs-identifier hs-var">_peer</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
-&gt; PeerSharingController addrNTN m
-&gt; m (PeerSharingClient addrNTN m ())
forall (m :: * -&gt; *) peer.
(Alternative (STM m), MonadMVar m, MonadSTM m) =&gt;
ControlMessageSTM m
-&gt; PeerSharingController peer m -&gt; m (PeerSharingClient peer m ())
</span><span class="hs-identifier hs-var">peerSharingClient</span></span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679182818"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span>
</span><span id="line-260"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hPeerSharingServer :: NodeToNodeVersion
-&gt; ConnectionId addrNTN -&gt; PeerSharingServer addrNTN m
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hPeerSharingServer"><span class="hs-identifier hs-var">hPeerSharingServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679182820"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182820"><span class="hs-identifier hs-var">_version</span></a></span></span><span> </span><span id="local-6989586621679182821"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679182821"><span class="hs-identifier hs-var">_peer</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PeerSharingAmount -&gt; m [addrNTN]) -&gt; PeerSharingServer addrNTN m
forall (m :: * -&gt; *) peer.
Monad m =&gt;
(PeerSharingAmount -&gt; m [peer]) -&gt; PeerSharingServer peer m
</span><span class="hs-identifier hs-var">peerSharingServer</span></span><span> </span><span class="annot"><span class="annottext">PeerSharingAmount -&gt; m [addrNTN]
</span><a href="#local-6989586621679182772"><span class="hs-identifier hs-var">computePeers</span></a></span><span>
</span><span id="line-261"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Codecs
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="annot"><span class="hs-comment">-- | Node-to-node protocol codecs needed to run 'Handlers'.</span></span><span>
</span><span id="line-268"></span><span class="hs-keyword">data</span><span> </span><span id="Codecs"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier hs-var">Codecs</span></a></span></span><span> </span><span id="local-6989586621679181887"><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679181888"><span class="annot"><a href="#local-6989586621679181888"><span class="hs-identifier hs-type">addr</span></a></span></span><span> </span><span id="local-6989586621679181889"><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679181890"><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679181891"><span class="annot"><a href="#local-6989586621679181891"><span class="hs-identifier hs-type">bCS</span></a></span></span><span> </span><span id="local-6989586621679181892"><span class="annot"><a href="#local-6989586621679181892"><span class="hs-identifier hs-type">bSCS</span></a></span></span><span> </span><span id="local-6989586621679181893"><span class="annot"><a href="#local-6989586621679181893"><span class="hs-identifier hs-type">bBF</span></a></span></span><span> </span><span id="local-6989586621679181894"><span class="annot"><a href="#local-6989586621679181894"><span class="hs-identifier hs-type">bSBF</span></a></span></span><span> </span><span id="local-6989586621679181895"><span class="annot"><a href="#local-6989586621679181895"><span class="hs-identifier hs-type">bTX</span></a></span></span><span> </span><span id="local-6989586621679181896"><span class="annot"><a href="#local-6989586621679181896"><span class="hs-identifier hs-type">bKA</span></a></span></span><span> </span><span id="local-6989586621679181897"><span class="annot"><a href="#local-6989586621679181897"><span class="hs-identifier hs-type">bPS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Codecs"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier hs-var">Codecs</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-269"></span><span>      </span><span id="cChainSyncCodec"><span class="annot"><span class="annottext">forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (ChainSync (Header blk) (Point blk) (Tip blk)) e m bCS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodec"><span class="hs-identifier hs-var hs-var">cChainSyncCodec</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>           </span><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181891"><span class="hs-identifier hs-type">bCS</span></a></span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="cChainSyncCodecSerialised"><span class="annot"><span class="annottext">forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) e m bSCS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodecSerialised"><span class="hs-identifier hs-var hs-var">cChainSyncCodecSerialised</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SerialisedHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181892"><span class="hs-identifier hs-type">bSCS</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="cBlockFetchCodec"><span class="annot"><span class="annottext">forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (BlockFetch blk (Point blk)) e m bBF
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodec"><span class="hs-identifier hs-var hs-var">cBlockFetchCodec</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockFetch</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>                             </span><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181893"><span class="hs-identifier hs-type">bBF</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="cBlockFetchCodecSerialised"><span class="annot"><span class="annottext">forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (BlockFetch (Serialised blk) (Point blk)) e m bSBF
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodecSerialised"><span class="hs-identifier hs-var hs-var">cBlockFetchCodecSerialised</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockFetch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Serialised</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>                </span><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181894"><span class="hs-identifier hs-type">bSBF</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="cTxSubmission2Codec"><span class="annot"><span class="annottext">forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (TxSubmission2 (GenTxId blk) (GenTx blk)) e m bTX
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cTxSubmission2Codec"><span class="hs-identifier hs-var hs-var">cTxSubmission2Codec</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxSubmission2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTxId</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679181887"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>                </span><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181895"><span class="hs-identifier hs-type">bTX</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="cKeepAliveCodec"><span class="annot"><span class="annottext">forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec KeepAlive e m bKA
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cKeepAliveCodec"><span class="hs-identifier hs-var hs-var">cKeepAliveCodec</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codec</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">KeepAlive</span></span><span>                                                </span><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181896"><span class="hs-identifier hs-type">bKA</span></a></span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="cPeerSharingCodec"><span class="annot"><span class="annottext">forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (PeerSharing addr) e m bPS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cPeerSharingCodec"><span class="hs-identifier hs-var hs-var">cPeerSharingCodec</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Codec</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PeerSharing</span></span><span> </span><span class="annot"><a href="#local-6989586621679181888"><span class="hs-identifier hs-type">addr</span></a></span><span class="hs-special">)</span><span>                                       </span><span class="annot"><a href="#local-6989586621679181889"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181890"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181897"><span class="hs-identifier hs-type">bPS</span></a></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="annot"><span class="hs-comment">-- | Protocol codecs for the node-to-node protocols</span></span><span>
</span><span id="line-279"></span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#defaultCodecs"><span class="hs-identifier hs-type">defaultCodecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679181981"><span class="annot"><a href="#local-6989586621679181981"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679181982"><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679181986"><span class="annot"><a href="#local-6989586621679181986"><span class="hs-identifier hs-type">addr</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-280"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOLike</span></span><span> </span><span class="annot"><a href="#local-6989586621679181981"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-281"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SerialiseNodeToNodeConstraints</span></span><span> </span><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-282"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CodecConfig</span></span><span>       </span><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-284"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNodeToNodeVersion</span></span><span> </span><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-285"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679181986"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Encoding</span></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679181988"><span class="annot"><a href="#local-6989586621679181988"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679181988"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181986"><span class="hs-identifier hs-type">addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-288"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier hs-type">Codecs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181986"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DeserialiseFailure</span></span><span> </span><span class="annot"><a href="#local-6989586621679181981"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-289"></span><span>                   </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-290"></span><span id="defaultCodecs"><span class="annot"><span class="annottext">defaultCodecs :: forall (m :: * -&gt; *) blk addr.
(IOLike m, SerialiseNodeToNodeConstraints blk) =&gt;
CodecConfig blk
-&gt; BlockNodeToNodeVersion blk
-&gt; (NodeToNodeVersion -&gt; addr -&gt; Encoding)
-&gt; (NodeToNodeVersion -&gt; forall s. Decoder s addr)
-&gt; NodeToNodeVersion
-&gt; Codecs
     blk
     addr
     DeserialiseFailure
     m
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
     ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#defaultCodecs"><span class="hs-identifier hs-var hs-var">defaultCodecs</span></a></span></span><span> </span><span id="local-6989586621679182867"><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679182867"><span class="hs-identifier hs-var">ccfg</span></a></span></span><span> </span><span id="local-6989586621679182868"><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679182868"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679182869"><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; addr -&gt; Encoding
</span><a href="#local-6989586621679182869"><span class="hs-identifier hs-var">encAddr</span></a></span></span><span> </span><span id="local-6989586621679182870"><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; forall s. Decoder s addr
</span><a href="#local-6989586621679182870"><span class="hs-identifier hs-var">decAddr</span></a></span></span><span> </span><span id="local-6989586621679182871"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182871"><span class="hs-identifier hs-var">nodeToNodeVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier hs-type">Codecs</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><span class="annottext">cChainSyncCodec :: Codec
  (ChainSync (Header blk) (Point blk) (Tip blk))
  DeserialiseFailure
  m
  ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodec"><span class="hs-identifier hs-var">cChainSyncCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="annottext">(Header blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Header blk))
-&gt; (Point blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Point blk))
-&gt; (Tip blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Tip blk))
-&gt; Codec
     (ChainSync (Header blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
forall header point tip (m :: * -&gt; *).
MonadST m =&gt;
(header -&gt; Encoding)
-&gt; (forall s. Decoder s header)
-&gt; (point -&gt; Encoding)
-&gt; (forall s. Decoder s point)
-&gt; (tip -&gt; Encoding)
-&gt; (forall s. Decoder s tip)
-&gt; Codec
     (ChainSync header point tip) DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">codecChainSync</span></span><span>
</span><span id="line-293"></span><span>          </span><span class="annot"><span class="annottext">Header blk -&gt; Encoding
forall a. SerialiseNodeToNode blk a =&gt; a -&gt; Encoding
</span><a href="#local-6989586621679182873"><span class="hs-identifier hs-var">enc</span></a></span><span>
</span><span id="line-294"></span><span>          </span><span class="annot"><span class="annottext">Decoder s (Header blk)
forall s. Decoder s (Header blk)
forall a s. SerialiseNodeToNode blk a =&gt; Decoder s a
</span><a href="#local-6989586621679182874"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Encoding) -&gt; Point blk -&gt; Encoding
forall {k} (block :: k).
(HeaderHash block -&gt; Encoding) -&gt; Point block -&gt; Encoding
</span><span class="hs-identifier hs-var">encodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; HeaderHash blk -&gt; Encoding
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; HeaderHash blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Point blk)
forall {k} (block :: k).
(forall s. Decoder s (HeaderHash block))
-&gt; forall s. Decoder s (Point block)
</span><span class="hs-identifier hs-var">decodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
</span><span class="hs-identifier hs-var">decodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Encoding) -&gt; Tip blk -&gt; Encoding
forall {k} (blk :: k).
(HeaderHash blk -&gt; Encoding) -&gt; Tip blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeTip</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; HeaderHash blk -&gt; Encoding
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; HeaderHash blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Tip blk)
forall {k} (blk :: k).
(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Tip blk)
</span><span class="hs-identifier hs-var">decodeTip</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
</span><span class="hs-identifier hs-var">decodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cChainSyncCodecSerialised :: Codec
  (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
  DeserialiseFailure
  m
  ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodecSerialised"><span class="hs-identifier hs-var">cChainSyncCodecSerialised</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">(SerialisedHeader blk -&gt; Encoding)
-&gt; (forall s. Decoder s (SerialisedHeader blk))
-&gt; (Point blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Point blk))
-&gt; (Tip blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Tip blk))
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     DeserialiseFailure
     m
     ByteString
forall header point tip (m :: * -&gt; *).
MonadST m =&gt;
(header -&gt; Encoding)
-&gt; (forall s. Decoder s header)
-&gt; (point -&gt; Encoding)
-&gt; (forall s. Decoder s point)
-&gt; (tip -&gt; Encoding)
-&gt; (forall s. Decoder s tip)
-&gt; Codec
     (ChainSync header point tip) DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">codecChainSync</span></span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">SerialisedHeader blk -&gt; Encoding
forall a. SerialiseNodeToNode blk a =&gt; a -&gt; Encoding
</span><a href="#local-6989586621679182873"><span class="hs-identifier hs-var">enc</span></a></span><span>
</span><span id="line-303"></span><span>          </span><span class="annot"><span class="annottext">Decoder s (SerialisedHeader blk)
forall s. Decoder s (SerialisedHeader blk)
forall a s. SerialiseNodeToNode blk a =&gt; Decoder s a
</span><a href="#local-6989586621679182874"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-304"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Encoding) -&gt; Point blk -&gt; Encoding
forall {k} (block :: k).
(HeaderHash block -&gt; Encoding) -&gt; Point block -&gt; Encoding
</span><span class="hs-identifier hs-var">encodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; HeaderHash blk -&gt; Encoding
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; HeaderHash blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Point blk)
forall {k} (block :: k).
(forall s. Decoder s (HeaderHash block))
-&gt; forall s. Decoder s (Point block)
</span><span class="hs-identifier hs-var">decodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
</span><span class="hs-identifier hs-var">decodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Encoding) -&gt; Tip blk -&gt; Encoding
forall {k} (blk :: k).
(HeaderHash blk -&gt; Encoding) -&gt; Tip blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeTip</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; HeaderHash blk -&gt; Encoding
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; HeaderHash blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Tip blk)
forall {k} (blk :: k).
(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Tip blk)
</span><span class="hs-identifier hs-var">decodeTip</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
</span><span class="hs-identifier hs-var">decodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cBlockFetchCodec :: Codec (BlockFetch blk (Point blk)) DeserialiseFailure m ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodec"><span class="hs-identifier hs-var">cBlockFetchCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-310"></span><span>        </span><span class="annot"><span class="annottext">(blk -&gt; Encoding)
-&gt; (forall s. Decoder s blk)
-&gt; (Point blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Point blk))
-&gt; Codec
     (BlockFetch blk (Point blk)) DeserialiseFailure m ByteString
forall block point (m :: * -&gt; *).
MonadST m =&gt;
(block -&gt; Encoding)
-&gt; (forall s. Decoder s block)
-&gt; (point -&gt; Encoding)
-&gt; (forall s. Decoder s point)
-&gt; Codec (BlockFetch block point) DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">codecBlockFetch</span></span><span>
</span><span id="line-311"></span><span>          </span><span class="annot"><span class="annottext">blk -&gt; Encoding
forall a. SerialiseNodeToNode blk a =&gt; a -&gt; Encoding
</span><a href="#local-6989586621679182873"><span class="hs-identifier hs-var">enc</span></a></span><span>
</span><span id="line-312"></span><span>          </span><span class="annot"><span class="annottext">Decoder s blk
forall s. Decoder s blk
forall a s. SerialiseNodeToNode blk a =&gt; Decoder s a
</span><a href="#local-6989586621679182874"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-313"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Encoding) -&gt; Point blk -&gt; Encoding
forall {k} (block :: k).
(HeaderHash block -&gt; Encoding) -&gt; Point block -&gt; Encoding
</span><span class="hs-identifier hs-var">encodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; HeaderHash blk -&gt; Encoding
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; HeaderHash blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Point blk)
forall {k} (block :: k).
(forall s. Decoder s (HeaderHash block))
-&gt; forall s. Decoder s (Point block)
</span><span class="hs-identifier hs-var">decodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
</span><span class="hs-identifier hs-var">decodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cBlockFetchCodecSerialised :: Codec
  (BlockFetch (Serialised blk) (Point blk))
  DeserialiseFailure
  m
  ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodecSerialised"><span class="hs-identifier hs-var">cBlockFetchCodecSerialised</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="annottext">(Serialised blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Serialised blk))
-&gt; (Point blk -&gt; Encoding)
-&gt; (forall s. Decoder s (Point blk))
-&gt; Codec
     (BlockFetch (Serialised blk) (Point blk))
     DeserialiseFailure
     m
     ByteString
forall block point (m :: * -&gt; *).
MonadST m =&gt;
(block -&gt; Encoding)
-&gt; (forall s. Decoder s block)
-&gt; (point -&gt; Encoding)
-&gt; (forall s. Decoder s point)
-&gt; Codec (BlockFetch block point) DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">codecBlockFetch</span></span><span>
</span><span id="line-318"></span><span>          </span><span class="annot"><span class="annottext">Serialised blk -&gt; Encoding
forall a. SerialiseNodeToNode blk a =&gt; a -&gt; Encoding
</span><a href="#local-6989586621679182873"><span class="hs-identifier hs-var">enc</span></a></span><span>
</span><span id="line-319"></span><span>          </span><span class="annot"><span class="annottext">Decoder s (Serialised blk)
forall s. Decoder s (Serialised blk)
forall a s. SerialiseNodeToNode blk a =&gt; Decoder s a
</span><a href="#local-6989586621679182874"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-320"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Encoding) -&gt; Point blk -&gt; Encoding
forall {k} (block :: k).
(HeaderHash block -&gt; Encoding) -&gt; Point block -&gt; Encoding
</span><span class="hs-identifier hs-var">encodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; HeaderHash blk -&gt; Encoding
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; HeaderHash blk -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall s. Decoder s (HeaderHash blk))
-&gt; forall s. Decoder s (Point blk)
forall {k} (block :: k).
(forall s. Decoder s (HeaderHash block))
-&gt; forall s. Decoder s (Point block)
</span><span class="hs-identifier hs-var">decodePoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
ConvertRawHash blk =&gt;
proxy blk -&gt; forall s. Decoder s (HeaderHash blk)
</span><span class="hs-identifier hs-var">decodeRawHash</span></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cTxSubmission2Codec :: Codec
  (TxSubmission2 (GenTxId blk) (GenTx blk))
  DeserialiseFailure
  m
  ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cTxSubmission2Codec"><span class="hs-identifier hs-var">cTxSubmission2Codec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>        </span><span class="annot"><span class="annottext">(GenTxId blk -&gt; Encoding)
-&gt; (forall s. Decoder s (GenTxId blk))
-&gt; (GenTx blk -&gt; Encoding)
-&gt; (forall s. Decoder s (GenTx blk))
-&gt; Codec
     (TxSubmission2 (GenTxId blk) (GenTx blk))
     DeserialiseFailure
     m
     ByteString
forall txid tx (m :: * -&gt; *).
MonadST m =&gt;
(txid -&gt; Encoding)
-&gt; (forall s. Decoder s txid)
-&gt; (tx -&gt; Encoding)
-&gt; (forall s. Decoder s tx)
-&gt; Codec (TxSubmission2 txid tx) DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">codecTxSubmission2</span></span><span>
</span><span id="line-325"></span><span>          </span><span class="annot"><span class="annottext">GenTxId blk -&gt; Encoding
forall a. SerialiseNodeToNode blk a =&gt; a -&gt; Encoding
</span><a href="#local-6989586621679182873"><span class="hs-identifier hs-var">enc</span></a></span><span>
</span><span id="line-326"></span><span>          </span><span class="annot"><span class="annottext">Decoder s (GenTxId blk)
forall s. Decoder s (GenTxId blk)
forall a s. SerialiseNodeToNode blk a =&gt; Decoder s a
</span><a href="#local-6989586621679182874"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-327"></span><span>          </span><span class="annot"><span class="annottext">GenTx blk -&gt; Encoding
forall a. SerialiseNodeToNode blk a =&gt; a -&gt; Encoding
</span><a href="#local-6989586621679182873"><span class="hs-identifier hs-var">enc</span></a></span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><span class="annottext">Decoder s (GenTx blk)
forall s. Decoder s (GenTx blk)
forall a s. SerialiseNodeToNode blk a =&gt; Decoder s a
</span><a href="#local-6989586621679182874"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cKeepAliveCodec :: Codec KeepAlive DeserialiseFailure m ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cKeepAliveCodec"><span class="hs-identifier hs-var">cKeepAliveCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec KeepAlive DeserialiseFailure m ByteString
forall (m :: * -&gt; *).
MonadST m =&gt;
Codec KeepAlive DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">codecKeepAlive_v2</span></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cPeerSharingCodec :: Codec (PeerSharing addr) DeserialiseFailure m ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cPeerSharingCodec"><span class="hs-identifier hs-var">cPeerSharingCodec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(addr -&gt; Encoding)
-&gt; (forall s. Decoder s addr)
-&gt; Codec (PeerSharing addr) DeserialiseFailure m ByteString
forall (m :: * -&gt; *) peerAddress.
MonadST m =&gt;
(peerAddress -&gt; Encoding)
-&gt; (forall s. Decoder s peerAddress)
-&gt; Codec (PeerSharing peerAddress) DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">codecPeerSharing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; addr -&gt; Encoding
</span><a href="#local-6989586621679182869"><span class="hs-identifier hs-var">encAddr</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182871"><span class="hs-identifier hs-var">nodeToNodeVersion</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; forall s. Decoder s addr
</span><a href="#local-6989586621679182870"><span class="hs-identifier hs-var">decAddr</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679182871"><span class="hs-identifier hs-var">nodeToNodeVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-335"></span><span>    </span><span class="annot"><a href="#local-6989586621679182877"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621679182877"><span class="annot"><span class="annottext">p :: Proxy blk
</span><a href="#local-6989586621679182877"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621679182006"><span class="annot"><a href="#local-6989586621679182873"><span class="hs-identifier hs-type">enc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SerialiseNodeToNode</span></span><span> </span><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182006"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182006"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Encoding</span></span></span><span>
</span><span id="line-339"></span><span>    </span><span id="local-6989586621679182873"><span class="annot"><span class="annottext">enc :: forall a. SerialiseNodeToNode blk a =&gt; a -&gt; Encoding
</span><a href="#local-6989586621679182873"><span class="hs-identifier hs-var hs-var">enc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CodecConfig blk -&gt; BlockNodeToNodeVersion blk -&gt; a -&gt; Encoding
forall blk a.
SerialiseNodeToNode blk a =&gt;
CodecConfig blk -&gt; BlockNodeToNodeVersion blk -&gt; a -&gt; Encoding
</span><span class="hs-identifier hs-var">encodeNodeToNode</span></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679182867"><span class="hs-identifier hs-var">ccfg</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679182868"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>    </span><span id="local-6989586621679182008"><span class="annot"><a href="#local-6989586621679182874"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SerialiseNodeToNode</span></span><span> </span><span class="annot"><a href="#local-6989586621679181982"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182008"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679182009"><span class="annot"><a href="#local-6989586621679182009"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679182009"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182008"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-342"></span><span>    </span><span id="local-6989586621679182874"><span class="annot"><span class="annottext">dec :: forall a s. SerialiseNodeToNode blk a =&gt; Decoder s a
</span><a href="#local-6989586621679182874"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
-&gt; BlockNodeToNodeVersion blk -&gt; forall s. Decoder s a
forall blk a.
SerialiseNodeToNode blk a =&gt;
CodecConfig blk
-&gt; BlockNodeToNodeVersion blk -&gt; forall s. Decoder s a
</span><span class="hs-identifier hs-var">decodeNodeToNode</span></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679182867"><span class="hs-identifier hs-var">ccfg</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNodeToNodeVersion blk
</span><a href="#local-6989586621679182868"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="annot"><span class="hs-comment">-- | Identity codecs used in tests.</span></span><span>
</span><span id="line-345"></span><span id="local-6989586621679182068"><span id="local-6989586621679182069"><span id="local-6989586621679182070"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#identityCodecs"><span class="hs-identifier hs-type">identityCodecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182068"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-346"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier hs-type">Codecs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182070"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CodecFailure</span></span><span> </span><span class="annot"><a href="#local-6989586621679182068"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-347"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnyMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnyMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SerialisedHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnyMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockFetch</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnyMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockFetch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Serialised</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnyMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxSubmission2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTxId</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679182069"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnyMessage</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">KeepAlive</span></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnyMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PeerSharing</span></span><span> </span><span class="annot"><a href="#local-6989586621679182070"><span class="hs-identifier hs-type">addr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-354"></span><span id="identityCodecs"><span class="annot"><span class="annottext">identityCodecs :: forall (m :: * -&gt; *) blk addr.
Monad m =&gt;
Codecs
  blk
  addr
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
  (AnyMessage (BlockFetch blk (Point blk)))
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
  (AnyMessage KeepAlive)
  (AnyMessage (PeerSharing addr))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#identityCodecs"><span class="hs-identifier hs-var hs-var">identityCodecs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier hs-type">Codecs</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">cChainSyncCodec :: Codec
  (ChainSync (Header blk) (Point blk) (Tip blk))
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodec"><span class="hs-identifier hs-var">cChainSyncCodec</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (ChainSync (Header blk) (Point blk) (Tip blk))
  CodecFailure
  m
  (AnyMessage (ChainSync (Header blk) (Point blk) (Tip blk)))
forall {k} {k1} {k2} (header :: k) (point :: k1) (tip :: k2)
       (m :: * -&gt; *).
Monad m =&gt;
Codec
  (ChainSync header point tip)
  CodecFailure
  m
  (AnyMessage (ChainSync header point tip))
</span><span class="hs-identifier hs-var">codecChainSyncId</span></span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cChainSyncCodecSerialised :: Codec
  (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
  CodecFailure
  m
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodecSerialised"><span class="hs-identifier hs-var">cChainSyncCodecSerialised</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
  CodecFailure
  m
  (AnyMessage
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
forall {k} {k1} {k2} (header :: k) (point :: k1) (tip :: k2)
       (m :: * -&gt; *).
Monad m =&gt;
Codec
  (ChainSync header point tip)
  CodecFailure
  m
  (AnyMessage (ChainSync header point tip))
</span><span class="hs-identifier hs-var">codecChainSyncId</span></span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cBlockFetchCodec :: Codec
  (BlockFetch blk (Point blk))
  CodecFailure
  m
  (AnyMessage (BlockFetch blk (Point blk)))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodec"><span class="hs-identifier hs-var">cBlockFetchCodec</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (BlockFetch blk (Point blk))
  CodecFailure
  m
  (AnyMessage (BlockFetch blk (Point blk)))
forall {k} {k1} (block :: k) (point :: k1) (m :: * -&gt; *).
Monad m =&gt;
Codec
  (BlockFetch block point)
  CodecFailure
  m
  (AnyMessage (BlockFetch block point))
</span><span class="hs-identifier hs-var">codecBlockFetchId</span></span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cBlockFetchCodecSerialised :: Codec
  (BlockFetch (Serialised blk) (Point blk))
  CodecFailure
  m
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodecSerialised"><span class="hs-identifier hs-var">cBlockFetchCodecSerialised</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (BlockFetch (Serialised blk) (Point blk))
  CodecFailure
  m
  (AnyMessage (BlockFetch (Serialised blk) (Point blk)))
forall {k} {k1} (block :: k) (point :: k1) (m :: * -&gt; *).
Monad m =&gt;
Codec
  (BlockFetch block point)
  CodecFailure
  m
  (AnyMessage (BlockFetch block point))
</span><span class="hs-identifier hs-var">codecBlockFetchId</span></span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cTxSubmission2Codec :: Codec
  (TxSubmission2 (GenTxId blk) (GenTx blk))
  CodecFailure
  m
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cTxSubmission2Codec"><span class="hs-identifier hs-var">cTxSubmission2Codec</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (TxSubmission2 (GenTxId blk) (GenTx blk))
  CodecFailure
  m
  (AnyMessage (TxSubmission2 (GenTxId blk) (GenTx blk)))
forall {k} {k1} (txid :: k) (tx :: k1) (m :: * -&gt; *).
Monad m =&gt;
Codec
  (TxSubmission2 txid tx)
  CodecFailure
  m
  (AnyMessage (TxSubmission2 txid tx))
</span><span class="hs-identifier hs-var">codecTxSubmission2Id</span></span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cKeepAliveCodec :: Codec KeepAlive CodecFailure m (AnyMessage KeepAlive)
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cKeepAliveCodec"><span class="hs-identifier hs-var">cKeepAliveCodec</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec KeepAlive CodecFailure m (AnyMessage KeepAlive)
forall (m :: * -&gt; *).
Monad m =&gt;
Codec KeepAlive CodecFailure m (AnyMessage KeepAlive)
</span><span class="hs-identifier hs-var">codecKeepAliveId</span></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cPeerSharingCodec :: Codec
  (PeerSharing addr) CodecFailure m (AnyMessage (PeerSharing addr))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cPeerSharingCodec"><span class="hs-identifier hs-var">cPeerSharingCodec</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (PeerSharing addr) CodecFailure m (AnyMessage (PeerSharing addr))
forall {k} (peerAddress :: k) (m :: * -&gt; *).
Monad m =&gt;
Codec
  (PeerSharing peerAddress)
  CodecFailure
  m
  (AnyMessage (PeerSharing peerAddress))
</span><span class="hs-identifier hs-var">codecPeerSharingId</span></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Tracers
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="annot"><span class="hs-comment">-- | A record of 'Tracer's for the different protocols.</span></span><span>
</span><span id="line-369"></span><span class="hs-keyword">type</span><span> </span><span id="Tracers"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-var">Tracers</span></a></span></span><span> </span><span id="local-6989586621679182913"><span class="annot"><a href="#local-6989586621679182913"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679182914"><span class="annot"><a href="#local-6989586621679182914"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679182915"><span class="annot"><a href="#local-6989586621679182915"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679182916"><span class="annot"><a href="#local-6989586621679182916"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>     </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers%27"><span class="hs-identifier hs-type">Tracers'</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679182914"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182915"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182916"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182913"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span class="hs-keyword">data</span><span> </span><span id="Tracers%27"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers%27"><span class="hs-identifier hs-var">Tracers'</span></a></span></span><span> </span><span id="local-6989586621679182097"><span class="annot"><a href="#local-6989586621679182097"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679182098"><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679182099"><span class="annot"><a href="#local-6989586621679182099"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679182100"><span class="annot"><a href="#local-6989586621679182100"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Tracers"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-var">Tracers</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-373"></span><span>      </span><span id="tChainSyncTracer"><span class="annot"><span class="annottext">forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncTracer"><span class="hs-identifier hs-var hs-var">tChainSyncTracer</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679182100"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182097"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceSendRecv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tChainSyncSerialisedTracer"><span class="annot"><span class="annottext">forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv
           (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncSerialisedTracer"><span class="hs-identifier hs-var hs-var">tChainSyncSerialisedTracer</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679182100"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182097"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceSendRecv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SerialisedHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tBlockFetchTracer"><span class="annot"><span class="annottext">forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch blk (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchTracer"><span class="hs-identifier hs-var hs-var">tBlockFetchTracer</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679182100"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182097"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceSendRecv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockFetch</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tBlockFetchSerialisedTracer"><span class="annot"><span class="annottext">forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchSerialisedTracer"><span class="hs-identifier hs-var hs-var">tBlockFetchSerialisedTracer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679182100"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182097"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceSendRecv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockFetch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Serialised</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tTxSubmission2Tracer"><span class="annot"><span class="annottext">forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tTxSubmission2Tracer"><span class="hs-identifier hs-var hs-var">tTxSubmission2Tracer</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679182100"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182097"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceSendRecv</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxSubmission2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTxId</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679182098"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679182131"><span id="local-6989586621679182132"><span id="local-6989586621679182133"><span id="local-6989586621679182134"><span id="local-6989586621679182926"><span id="local-6989586621679182931"><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679182129"><span class="annot"><a href="#local-6989586621679182129"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Semigroup"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679182131"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182129"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Semigroup"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers%27"><span class="hs-identifier hs-type">Tracers'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182132"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182133"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182134"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182131"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-381"></span><span>  </span><span id="local-6989586621679182942"><span class="annot"><span class="annottext">Tracers' peer blk e f
</span><a href="#local-6989586621679182942"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679182943"><span class="annot"><span class="annottext">&lt;&gt; :: Tracers' peer blk e f
-&gt; Tracers' peer blk e f -&gt; Tracers' peer blk e f
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></a></span></span><span> </span><span id="local-6989586621679182944"><span class="annot"><span class="annottext">Tracers' peer blk e f
</span><a href="#local-6989586621679182944"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-382"></span><span>        </span><span class="annot"><span class="annottext">tChainSyncTracer :: f (TraceLabelPeer
     peer
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncTracer"><span class="hs-identifier hs-var">tChainSyncTracer</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tracers' peer blk e f
 -&gt; f (TraceLabelPeer
         peer
         (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk)))))
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
forall a. Semigroup a =&gt; (Tracers' peer blk e f -&gt; a) -&gt; a
</span><a href="#local-6989586621679182945"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncTracer"><span class="hs-identifier hs-var">tChainSyncTracer</span></a></span><span>
</span><span id="line-383"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tChainSyncSerialisedTracer :: f (TraceLabelPeer
     peer
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncSerialisedTracer"><span class="hs-identifier hs-var">tChainSyncSerialisedTracer</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tracers' peer blk e f
 -&gt; f (TraceLabelPeer
         peer
         (TraceSendRecv
            (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))))
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv
           (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
forall a. Semigroup a =&gt; (Tracers' peer blk e f -&gt; a) -&gt; a
</span><a href="#local-6989586621679182945"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv
           (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv
           (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncSerialisedTracer"><span class="hs-identifier hs-var">tChainSyncSerialisedTracer</span></a></span><span>
</span><span id="line-384"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tBlockFetchTracer :: f (TraceLabelPeer
     peer (TraceSendRecv (BlockFetch blk (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchTracer"><span class="hs-identifier hs-var">tBlockFetchTracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tracers' peer blk e f
 -&gt; f (TraceLabelPeer
         peer (TraceSendRecv (BlockFetch blk (Point blk)))))
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch blk (Point blk))))
forall a. Semigroup a =&gt; (Tracers' peer blk e f -&gt; a) -&gt; a
</span><a href="#local-6989586621679182945"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch blk (Point blk))))
forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch blk (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchTracer"><span class="hs-identifier hs-var">tBlockFetchTracer</span></a></span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tBlockFetchSerialisedTracer :: f (TraceLabelPeer
     peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchSerialisedTracer"><span class="hs-identifier hs-var">tBlockFetchSerialisedTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tracers' peer blk e f
 -&gt; f (TraceLabelPeer
         peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk)))))
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
forall a. Semigroup a =&gt; (Tracers' peer blk e f -&gt; a) -&gt; a
</span><a href="#local-6989586621679182945"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchSerialisedTracer"><span class="hs-identifier hs-var">tBlockFetchSerialisedTracer</span></a></span><span>
</span><span id="line-386"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tTxSubmission2Tracer :: f (TraceLabelPeer
     peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tTxSubmission2Tracer"><span class="hs-identifier hs-var">tTxSubmission2Tracer</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Tracers' peer blk e f
 -&gt; f (TraceLabelPeer
         peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk)))))
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
forall a. Semigroup a =&gt; (Tracers' peer blk e f -&gt; a) -&gt; a
</span><a href="#local-6989586621679182945"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tTxSubmission2Tracer"><span class="hs-identifier hs-var">tTxSubmission2Tracer</span></a></span><span>
</span><span id="line-387"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-389"></span><span>      </span><span class="annot"><a href="#local-6989586621679182945"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679182135"><span class="annot"><a href="#local-6989586621679182135"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Semigroup"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182135"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-390"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers%27"><span class="hs-identifier hs-type">Tracers'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182132"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182133"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182134"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182131"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182135"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182135"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-392"></span><span>      </span><span id="local-6989586621679182945"><span class="annot"><span class="annottext">f :: forall a. Semigroup a =&gt; (Tracers' peer blk e f -&gt; a) -&gt; a
</span><a href="#local-6989586621679182945"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679182948"><span class="annot"><span class="annottext">Tracers' peer blk e f -&gt; a
</span><a href="#local-6989586621679182948"><span class="hs-identifier hs-var">prj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f -&gt; a
</span><a href="#local-6989586621679182948"><span class="hs-identifier hs-var">prj</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f
</span><a href="#local-6989586621679182942"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f -&gt; a
</span><a href="#local-6989586621679182948"><span class="hs-identifier hs-var">prj</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers' peer blk e f
</span><a href="#local-6989586621679182944"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="annot"><span class="hs-comment">-- | Use a 'nullTracer' for each protocol.</span></span><span>
</span><span id="line-395"></span><span id="local-6989586621679182137"><span id="local-6989586621679182138"><span id="local-6989586621679182139"><span id="local-6989586621679182140"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#nullTracers"><span class="hs-identifier hs-type">nullTracers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182137"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182137"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182138"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182139"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182140"><span class="hs-identifier hs-type">e</span></a></span></span></span></span></span><span>
</span><span id="line-396"></span><span id="nullTracers"><span class="annot"><span class="annottext">nullTracers :: forall (m :: * -&gt; *) peer blk e. Monad m =&gt; Tracers m peer blk e
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#nullTracers"><span class="hs-identifier hs-var hs-var">nullTracers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><span class="annottext">tChainSyncTracer :: Tracer
  m
  (TraceLabelPeer
     peer
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncTracer"><span class="hs-identifier hs-var">tChainSyncTracer</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     peer
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tChainSyncSerialisedTracer :: Tracer
  m
  (TraceLabelPeer
     peer
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncSerialisedTracer"><span class="hs-identifier hs-var">tChainSyncSerialisedTracer</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     peer
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tBlockFetchTracer :: Tracer
  m
  (TraceLabelPeer peer (TraceSendRecv (BlockFetch blk (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchTracer"><span class="hs-identifier hs-var">tBlockFetchTracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer peer (TraceSendRecv (BlockFetch blk (Point blk))))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tBlockFetchSerialisedTracer :: Tracer
  m
  (TraceLabelPeer
     peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchSerialisedTracer"><span class="hs-identifier hs-var">tBlockFetchSerialisedTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tTxSubmission2Tracer :: Tracer
  m
  (TraceLabelPeer
     peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tTxSubmission2Tracer"><span class="hs-identifier hs-var">tTxSubmission2Tracer</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span id="local-6989586621679182148"><span id="local-6989586621679182149"><span id="local-6989586621679182151"><span id="local-6989586621679182152"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#showTracers"><span class="hs-identifier hs-type">showTracers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182148"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-405"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182149"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-406"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679182148"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679182148"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTxId</span></span><span> </span><span class="annot"><a href="#local-6989586621679182148"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679182148"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-410"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasNestedContent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679182148"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-411"></span><span>               </span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182151"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182151"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182149"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182148"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182152"><span class="hs-identifier hs-type">e</span></a></span></span></span></span></span><span>
</span><span id="line-413"></span><span id="showTracers"><span class="annot"><span class="annottext">showTracers :: forall blk peer (m :: * -&gt; *) e.
(Show blk, Show peer, Show (Header blk), Show (GenTx blk),
 Show (GenTxId blk), HasHeader blk, HasNestedContent Header blk) =&gt;
Tracer m String -&gt; Tracers m peer blk e
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#showTracers"><span class="hs-identifier hs-var hs-var">showTracers</span></a></span></span><span> </span><span id="local-6989586621679182998"><span class="annot"><span class="annottext">Tracer m String
</span><a href="#local-6989586621679182998"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-414"></span><span>      </span><span class="annot"><span class="annottext">tChainSyncTracer :: Tracer
  m
  (TraceLabelPeer
     peer
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncTracer"><span class="hs-identifier hs-var">tChainSyncTracer</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m String
-&gt; Tracer
     m
     (TraceLabelPeer
        peer
        (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
forall a (m :: * -&gt; *). Show a =&gt; Tracer m String -&gt; Tracer m a
</span><span class="hs-identifier hs-var">showTracing</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String
</span><a href="#local-6989586621679182998"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tChainSyncSerialisedTracer :: Tracer
  m
  (TraceLabelPeer
     peer
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncSerialisedTracer"><span class="hs-identifier hs-var">tChainSyncSerialisedTracer</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m String
-&gt; Tracer
     m
     (TraceLabelPeer
        peer
        (TraceSendRecv
           (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
forall a (m :: * -&gt; *). Show a =&gt; Tracer m String -&gt; Tracer m a
</span><span class="hs-identifier hs-var">showTracing</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String
</span><a href="#local-6989586621679182998"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tBlockFetchTracer :: Tracer
  m
  (TraceLabelPeer peer (TraceSendRecv (BlockFetch blk (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchTracer"><span class="hs-identifier hs-var">tBlockFetchTracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m String
-&gt; Tracer
     m
     (TraceLabelPeer peer (TraceSendRecv (BlockFetch blk (Point blk))))
forall a (m :: * -&gt; *). Show a =&gt; Tracer m String -&gt; Tracer m a
</span><span class="hs-identifier hs-var">showTracing</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String
</span><a href="#local-6989586621679182998"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tBlockFetchSerialisedTracer :: Tracer
  m
  (TraceLabelPeer
     peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tBlockFetchSerialisedTracer"><span class="hs-identifier hs-var">tBlockFetchSerialisedTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m String
-&gt; Tracer
     m
     (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
forall a (m :: * -&gt; *). Show a =&gt; Tracer m String -&gt; Tracer m a
</span><span class="hs-identifier hs-var">showTracing</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String
</span><a href="#local-6989586621679182998"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tTxSubmission2Tracer :: Tracer
  m
  (TraceLabelPeer
     peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tTxSubmission2Tracer"><span class="hs-identifier hs-var">tTxSubmission2Tracer</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m String
-&gt; Tracer
     m
     (TraceLabelPeer
        peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
forall a (m :: * -&gt; *). Show a =&gt; Tracer m String -&gt; Tracer m a
</span><span class="hs-identifier hs-var">showTracing</span></span><span> </span><span class="annot"><span class="annottext">Tracer m String
</span><a href="#local-6989586621679182998"><span class="hs-identifier hs-var">tr</span></a></span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Applications
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="annot"><span class="hs-comment">-- | A node-to-node application</span></span><span>
</span><span id="line-426"></span><span class="hs-keyword">type</span><span> </span><span id="ClientApp"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ClientApp"><span class="hs-identifier hs-var">ClientApp</span></a></span></span><span> </span><span id="local-6989586621679183000"><span class="annot"><a href="#local-6989586621679183000"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679183001"><span class="annot"><a href="#local-6989586621679183001"><span class="hs-identifier hs-type">addr</span></a></span></span><span> </span><span id="local-6989586621679183002"><span class="annot"><a href="#local-6989586621679183002"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679183003"><span class="annot"><a href="#local-6989586621679183003"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-427"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679183001"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679183000"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-429"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679183000"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679183002"><span class="hs-identifier hs-type">bytes</span></a></span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679183000"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679183003"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679183002"><span class="hs-identifier hs-type">bytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span class="hs-keyword">type</span><span> </span><span id="ServerApp"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ServerApp"><span class="hs-identifier hs-var">ServerApp</span></a></span></span><span> </span><span id="local-6989586621679183004"><span class="annot"><a href="#local-6989586621679183004"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679183005"><span class="annot"><a href="#local-6989586621679183005"><span class="hs-identifier hs-type">addr</span></a></span></span><span> </span><span id="local-6989586621679183006"><span class="annot"><a href="#local-6989586621679183006"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679183007"><span class="annot"><a href="#local-6989586621679183007"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-433"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679183005"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679183004"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679183006"><span class="hs-identifier hs-type">bytes</span></a></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679183004"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679183007"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679183006"><span class="hs-identifier hs-type">bytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-comment">-- | Applications for the node-to-node protocols</span><span>
</span><span id="line-439"></span><span class="hs-comment">--</span><span>
</span><span id="line-440"></span><span class="hs-comment">-- See 'Network.Mux.Types.MuxApplication'</span><span>
</span><span id="line-441"></span><span class="hs-keyword">data</span><span> </span><span id="Apps"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-var">Apps</span></a></span></span><span> </span><span id="local-6989586621679182171"><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679182172"><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span></span><span> </span><span id="local-6989586621679182173"><span class="annot"><a href="#local-6989586621679182173"><span class="hs-identifier hs-type">bCS</span></a></span></span><span> </span><span id="local-6989586621679182174"><span class="annot"><a href="#local-6989586621679182174"><span class="hs-identifier hs-type">bBF</span></a></span></span><span> </span><span id="local-6989586621679182175"><span class="annot"><a href="#local-6989586621679182175"><span class="hs-identifier hs-type">bTX</span></a></span></span><span> </span><span id="local-6989586621679182176"><span class="annot"><a href="#local-6989586621679182176"><span class="hs-identifier hs-type">bKA</span></a></span></span><span> </span><span id="local-6989586621679182177"><span class="annot"><a href="#local-6989586621679182177"><span class="hs-identifier hs-type">bPS</span></a></span></span><span> </span><span id="local-6989586621679182178"><span class="annot"><a href="#local-6989586621679182178"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679182179"><span class="annot"><a href="#local-6989586621679182179"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Apps"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-var">Apps</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-442"></span><span>      </span><span class="hs-comment">-- | Start a chain sync client that communicates with the given upstream</span><span>
</span><span id="line-443"></span><span>      </span><span class="hs-comment">-- node.</span><span>
</span><span id="line-444"></span><span>      </span><span id="aChainSyncClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bCS a
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aChainSyncClient"><span class="hs-identifier hs-var hs-var">aChainSyncClient</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ClientApp"><span class="hs-identifier hs-type">ClientApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182173"><span class="hs-identifier hs-type">bCS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182178"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Start a chain sync server.</span></span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aChainSyncServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bCS b
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aChainSyncServer"><span class="hs-identifier hs-var hs-var">aChainSyncServer</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ServerApp"><span class="hs-identifier hs-type">ServerApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182173"><span class="hs-identifier hs-type">bCS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182179"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>      </span><span class="hs-comment">-- | Start a block fetch client that communicates with the given</span><span>
</span><span id="line-450"></span><span>      </span><span class="hs-comment">-- upstream node.</span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aBlockFetchClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bBF a
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aBlockFetchClient"><span class="hs-identifier hs-var hs-var">aBlockFetchClient</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ClientApp"><span class="hs-identifier hs-type">ClientApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182174"><span class="hs-identifier hs-type">bBF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182178"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Start a block fetch server.</span></span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aBlockFetchServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bBF b
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aBlockFetchServer"><span class="hs-identifier hs-var hs-var">aBlockFetchServer</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ServerApp"><span class="hs-identifier hs-type">ServerApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182174"><span class="hs-identifier hs-type">bBF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182179"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-comment">-- | Start a transaction submission v2 client that communicates with the</span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-comment">-- given upstream node.</span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aTxSubmission2Client"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bTX a
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aTxSubmission2Client"><span class="hs-identifier hs-var hs-var">aTxSubmission2Client</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ClientApp"><span class="hs-identifier hs-type">ClientApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182175"><span class="hs-identifier hs-type">bTX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182178"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Start a transaction submission v2 server.</span></span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aTxSubmission2Server"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bTX b
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aTxSubmission2Server"><span class="hs-identifier hs-var hs-var">aTxSubmission2Server</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ServerApp"><span class="hs-identifier hs-type">ServerApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182175"><span class="hs-identifier hs-type">bTX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182179"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Start a keep-alive client.</span></span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aKeepAliveClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bKA a
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aKeepAliveClient"><span class="hs-identifier hs-var hs-var">aKeepAliveClient</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ClientApp"><span class="hs-identifier hs-type">ClientApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182176"><span class="hs-identifier hs-type">bKA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182178"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Start a keep-alive server.</span></span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aKeepAliveServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bKA b
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aKeepAliveServer"><span class="hs-identifier hs-var hs-var">aKeepAliveServer</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ServerApp"><span class="hs-identifier hs-type">ServerApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182176"><span class="hs-identifier hs-type">bKA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182179"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Start a peer-sharing client.</span></span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aPeerSharingClient"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bPS a
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aPeerSharingClient"><span class="hs-identifier hs-var hs-var">aPeerSharingClient</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ClientApp"><span class="hs-identifier hs-type">ClientApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182177"><span class="hs-identifier hs-type">bPS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182178"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Start a peer-sharing server.</span></span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="aPeerSharingServer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bPS b
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aPeerSharingServer"><span class="hs-identifier hs-var hs-var">aPeerSharingServer</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ServerApp"><span class="hs-identifier hs-type">ServerApp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182171"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182172"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182177"><span class="hs-identifier hs-type">bPS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182179"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="hs-comment">-- | Per mini-protocol byte limits;  For each mini-protocol they provide</span><span>
</span><span id="line-478"></span><span class="hs-comment">-- per-state byte size limits, i.e. how much data can arrive from the network.</span><span>
</span><span id="line-479"></span><span class="hs-comment">--</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- They don't depend on the instantiation of the protocol parameters (which</span><span>
</span><span id="line-481"></span><span class="hs-comment">-- block type is used, etc.), hence the use of 'RankNTypes'.</span><span>
</span><span id="line-482"></span><span class="hs-comment">--</span><span>
</span><span id="line-483"></span><span class="hs-keyword">data</span><span> </span><span id="ByteLimits"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-var">ByteLimits</span></a></span></span><span> </span><span id="local-6989586621679182273"><span class="annot"><a href="#local-6989586621679182273"><span class="hs-identifier hs-type">bCS</span></a></span></span><span> </span><span id="local-6989586621679182274"><span class="annot"><a href="#local-6989586621679182274"><span class="hs-identifier hs-type">bBF</span></a></span></span><span> </span><span id="local-6989586621679182275"><span class="annot"><a href="#local-6989586621679182275"><span class="hs-identifier hs-type">bTX</span></a></span></span><span> </span><span id="local-6989586621679182276"><span class="annot"><a href="#local-6989586621679182276"><span class="hs-identifier hs-type">bKA</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ByteLimits"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-var">ByteLimits</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-484"></span><span>      </span><span id="blChainSync"><span class="annot"><span class="annottext">forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA
-&gt; forall header point tip.
   ProtocolSizeLimits (ChainSync header point tip) bCS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blChainSync"><span class="hs-identifier hs-var hs-var">blChainSync</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679182278"><span class="annot"><a href="#local-6989586621679182278"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679182279"><span class="annot"><a href="#local-6989586621679182279"><span class="hs-identifier hs-type">point</span></a></span></span><span> </span><span id="local-6989586621679182280"><span class="annot"><a href="#local-6989586621679182280"><span class="hs-identifier hs-type">tip</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-485"></span><span>                         </span><span class="annot"><span class="hs-identifier hs-type">ProtocolSizeLimits</span></span><span>
</span><span id="line-486"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainSync</span></span><span>  </span><span class="annot"><a href="#local-6989586621679182278"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182279"><span class="hs-identifier hs-type">point</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182280"><span class="hs-identifier hs-type">tip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>                           </span><span class="annot"><a href="#local-6989586621679182273"><span class="hs-identifier hs-type">bCS</span></a></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="blBlockFetch"><span class="annot"><span class="annottext">forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA
-&gt; forall block point.
   ProtocolSizeLimits (BlockFetch block point) bBF
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blBlockFetch"><span class="hs-identifier hs-var hs-var">blBlockFetch</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679182289"><span class="annot"><a href="#local-6989586621679182289"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679182290"><span class="annot"><a href="#local-6989586621679182290"><span class="hs-identifier hs-type">point</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-490"></span><span>                         </span><span class="annot"><span class="hs-identifier hs-type">ProtocolSizeLimits</span></span><span>
</span><span id="line-491"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockFetch</span></span><span> </span><span class="annot"><a href="#local-6989586621679182289"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182290"><span class="hs-identifier hs-type">point</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>                           </span><span class="annot"><a href="#local-6989586621679182274"><span class="hs-identifier hs-type">bBF</span></a></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="blTxSubmission2"><span class="annot"><span class="annottext">forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA
-&gt; forall txid tx. ProtocolSizeLimits (TxSubmission2 txid tx) bTX
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blTxSubmission2"><span class="hs-identifier hs-var hs-var">blTxSubmission2</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679182297"><span class="annot"><a href="#local-6989586621679182297"><span class="hs-identifier hs-type">txid</span></a></span></span><span> </span><span id="local-6989586621679182298"><span class="annot"><a href="#local-6989586621679182298"><span class="hs-identifier hs-type">tx</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-495"></span><span>                         </span><span class="annot"><span class="hs-identifier hs-type">ProtocolSizeLimits</span></span><span>
</span><span id="line-496"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxSubmission2</span></span><span> </span><span class="annot"><a href="#local-6989586621679182297"><span class="hs-identifier hs-type">txid</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182298"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>                           </span><span class="annot"><a href="#local-6989586621679182275"><span class="hs-identifier hs-type">bTX</span></a></span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="blKeepAlive"><span class="annot"><span class="annottext">forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA -&gt; ProtocolSizeLimits KeepAlive bKA
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blKeepAlive"><span class="hs-identifier hs-var hs-var">blKeepAlive</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProtocolSizeLimits</span></span><span>
</span><span id="line-500"></span><span>                           </span><span class="annot"><span class="hs-identifier hs-type">KeepAlive</span></span><span>
</span><span id="line-501"></span><span>                           </span><span class="annot"><a href="#local-6989586621679182276"><span class="hs-identifier hs-type">bKA</span></a></span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span id="local-6989586621679182309"><span id="local-6989586621679182310"><span id="local-6989586621679182311"><span id="local-6989586621679182312"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#noByteLimits"><span class="hs-identifier hs-type">noByteLimits</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-type">ByteLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182309"><span class="hs-identifier hs-type">bCS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182310"><span class="hs-identifier hs-type">bBF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182311"><span class="hs-identifier hs-type">bTX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182312"><span class="hs-identifier hs-type">bKA</span></a></span></span></span></span></span><span>
</span><span id="line-506"></span><span id="noByteLimits"><span class="annot"><span class="annottext">noByteLimits :: forall bCS bBF bTX bKA. ByteLimits bCS bBF bTX bKA
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#noByteLimits"><span class="hs-identifier hs-var hs-var">noByteLimits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-type">ByteLimits</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-507"></span><span>    </span><span class="annot"><span class="annottext">blChainSync :: forall header point tip.
ProtocolSizeLimits (ChainSync header point tip) bCS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blChainSync"><span class="hs-identifier hs-var">blChainSync</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(bCS -&gt; Word)
-&gt; ProtocolSizeLimits (ChainSync header point tip) bCS
forall {k} {k1} {k2} bytes (header :: k) (point :: k1) (tip :: k2).
(bytes -&gt; Word)
-&gt; ProtocolSizeLimits (ChainSync header point tip) bytes
</span><span class="hs-identifier hs-var">byteLimitsChainSync</span></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; bCS -&gt; Word
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blBlockFetch :: forall block point. ProtocolSizeLimits (BlockFetch block point) bBF
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blBlockFetch"><span class="hs-identifier hs-var">blBlockFetch</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(bBF -&gt; Word) -&gt; ProtocolSizeLimits (BlockFetch block point) bBF
forall {k} {k1} bytes (block :: k) (point :: k1).
(bytes -&gt; Word)
-&gt; ProtocolSizeLimits (BlockFetch block point) bytes
</span><span class="hs-identifier hs-var">byteLimitsBlockFetch</span></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; bBF -&gt; Word
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blTxSubmission2 :: forall txid tx. ProtocolSizeLimits (TxSubmission2 txid tx) bTX
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blTxSubmission2"><span class="hs-identifier hs-var">blTxSubmission2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(bTX -&gt; Word) -&gt; ProtocolSizeLimits (TxSubmission2 txid tx) bTX
forall {k} {k1} bytes (txid :: k) (tx :: k1).
(bytes -&gt; Word) -&gt; ProtocolSizeLimits (TxSubmission2 txid tx) bytes
</span><span class="hs-identifier hs-var">byteLimitsTxSubmission2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; bTX -&gt; Word
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blKeepAlive :: ProtocolSizeLimits KeepAlive bKA
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blKeepAlive"><span class="hs-identifier hs-var">blKeepAlive</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(bKA -&gt; Word) -&gt; ProtocolSizeLimits KeepAlive bKA
forall bytes. (bytes -&gt; Word) -&gt; ProtocolSizeLimits KeepAlive bytes
</span><span class="hs-identifier hs-var">byteLimitsKeepAlive</span></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; bKA -&gt; Word
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#byteLimits"><span class="hs-identifier hs-type">byteLimits</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-type">ByteLimits</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-514"></span><span id="byteLimits"><span class="annot"><span class="annottext">byteLimits :: ByteLimits ByteString ByteString ByteString ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#byteLimits"><span class="hs-identifier hs-var hs-var">byteLimits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-type">ByteLimits</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-515"></span><span>      </span><span class="annot"><span class="annottext">blChainSync :: forall header point tip.
ProtocolSizeLimits (ChainSync header point tip) ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blChainSync"><span class="hs-identifier hs-var">blChainSync</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Word)
-&gt; ProtocolSizeLimits (ChainSync header point tip) ByteString
forall {k} {k1} {k2} bytes (header :: k) (point :: k1) (tip :: k2).
(bytes -&gt; Word)
-&gt; ProtocolSizeLimits (ChainSync header point tip) bytes
</span><span class="hs-identifier hs-var">byteLimitsChainSync</span></span><span>     </span><span class="annot"><span class="annottext">ByteString -&gt; Word
</span><a href="#local-6989586621679183033"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-516"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blBlockFetch :: forall block point.
ProtocolSizeLimits (BlockFetch block point) ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blBlockFetch"><span class="hs-identifier hs-var">blBlockFetch</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Word)
-&gt; ProtocolSizeLimits (BlockFetch block point) ByteString
forall {k} {k1} bytes (block :: k) (point :: k1).
(bytes -&gt; Word)
-&gt; ProtocolSizeLimits (BlockFetch block point) bytes
</span><span class="hs-identifier hs-var">byteLimitsBlockFetch</span></span><span>    </span><span class="annot"><span class="annottext">ByteString -&gt; Word
</span><a href="#local-6989586621679183033"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-517"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blTxSubmission2 :: forall txid tx.
ProtocolSizeLimits (TxSubmission2 txid tx) ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blTxSubmission2"><span class="hs-identifier hs-var">blTxSubmission2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Word)
-&gt; ProtocolSizeLimits (TxSubmission2 txid tx) ByteString
forall {k} {k1} bytes (txid :: k) (tx :: k1).
(bytes -&gt; Word) -&gt; ProtocolSizeLimits (TxSubmission2 txid tx) bytes
</span><span class="hs-identifier hs-var">byteLimitsTxSubmission2</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Word
</span><a href="#local-6989586621679183033"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blKeepAlive :: ProtocolSizeLimits KeepAlive ByteString
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blKeepAlive"><span class="hs-identifier hs-var">blKeepAlive</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Word) -&gt; ProtocolSizeLimits KeepAlive ByteString
forall bytes. (bytes -&gt; Word) -&gt; ProtocolSizeLimits KeepAlive bytes
</span><span class="hs-identifier hs-var">byteLimitsKeepAlive</span></span><span>     </span><span class="annot"><span class="annottext">ByteString -&gt; Word
</span><a href="#local-6989586621679183033"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-521"></span><span>    </span><span class="annot"><a href="#local-6989586621679183033"><span class="hs-identifier hs-type">size</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-522"></span><span>    </span><span id="local-6989586621679183033"><span class="annot"><span class="annottext">size :: ByteString -&gt; Word
</span><a href="#local-6989586621679183033"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Int.html#Int64"><span class="hs-identifier hs-type">Int64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>         </span><span class="annot"><span class="annottext">(Int64 -&gt; Word) -&gt; (ByteString -&gt; Int64) -&gt; ByteString -&gt; Word
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int64
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html#length"><span class="hs-identifier hs-var">BSL.length</span></a></span><span>
</span><span id="line-524"></span><span>
</span><span id="line-525"></span><span class="annot"><span class="hs-comment">-- | Construct the 'NetworkApplication' for the node-to-node protocols</span></span><span>
</span><span id="line-526"></span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#mkApps"><span class="hs-identifier hs-type">mkApps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-527"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679182356"><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679182357"><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span></span><span> </span><span id="local-6989586621679182362"><span class="annot"><a href="#local-6989586621679182362"><span class="hs-identifier hs-type">addrNTC</span></a></span></span><span> </span><span id="local-6989586621679182360"><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679182358"><span class="annot"><a href="#local-6989586621679182358"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679182363"><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span></span><span> </span><span id="local-6989586621679182364"><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span></span><span> </span><span id="local-6989586621679182365"><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span></span><span> </span><span id="local-6989586621679182366"><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span></span><span> </span><span id="local-6989586621679182367"><span class="annot"><a href="#local-6989586621679182367"><span class="hs-identifier hs-type">bPS</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-528"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOLike</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-529"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTimer</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-530"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>
</span><span id="line-531"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182358"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-532"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-533"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShowProxy</span></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-534"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShowProxy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Header</span></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShowProxy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TxId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShowProxy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenTx</span></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.NodeKernel.html#NodeKernel"><span class="hs-identifier hs-type">NodeKernel</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182362"><span class="hs-identifier hs-type">addrNTC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Needed for bracketing only</span></span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182358"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Codecs"><span class="hs-identifier hs-type">Codecs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182358"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182367"><span class="hs-identifier hs-type">bPS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-type">ByteLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainSyncTimeout</span></span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReportPeerMetrics</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Handlers"><span class="hs-identifier hs-type">Handlers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182360"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-type">Apps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182367"><span class="hs-identifier hs-type">bPS</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NodeToNodeInitiatorResult"><span class="hs-identifier hs-type">NodeToNodeInitiatorResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span id="mkApps"><span class="annot"><span class="annottext">mkApps :: forall (m :: * -&gt; *) addrNTN addrNTC blk e bCS bBF bTX bKA bPS.
(IOLike m, MonadTimer m, Ord addrNTN, Exception e,
 LedgerSupportsProtocol blk, ShowProxy blk, ShowProxy (Header blk),
 ShowProxy (TxId (GenTx blk)), ShowProxy (GenTx blk)) =&gt;
NodeKernel m addrNTN addrNTC blk
-&gt; Tracers m (ConnectionId addrNTN) blk e
-&gt; (NodeToNodeVersion
    -&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS)
-&gt; ByteLimits bCS bBF bTX bKA
-&gt; m ChainSyncTimeout
-&gt; ReportPeerMetrics m (ConnectionId addrNTN)
-&gt; Handlers m addrNTN blk
-&gt; Apps m addrNTN bCS bBF bTX bKA bPS NodeToNodeInitiatorResult ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#mkApps"><span class="hs-identifier hs-var hs-var">mkApps</span></a></span></span><span> </span><span id="local-6989586621679183264"><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679183265"><span id="local-6989586621679183266"><span id="local-6989586621679183267"><span id="local-6989586621679183268"><span id="local-6989586621679183269"><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (BlockFetch blk (Point blk))))
Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
tChainSyncTracer :: forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
tChainSyncSerialisedTracer :: forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer
        (TraceSendRecv
           (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
tBlockFetchTracer :: forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch blk (Point blk))))
tBlockFetchSerialisedTracer :: forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
tTxSubmission2Tracer :: forall peer blk e (f :: * -&gt; *).
Tracers' peer blk e f
-&gt; f (TraceLabelPeer
        peer (TraceSendRecv (TxSubmission2 (GenTxId blk) (GenTx blk))))
tChainSyncTracer :: Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
tChainSyncSerialisedTracer :: Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
tBlockFetchTracer :: Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (BlockFetch blk (Point blk))))
tBlockFetchSerialisedTracer :: Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
tTxSubmission2Tracer :: Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#tChainSyncTracer"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679183270"><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#ByteLimits"><span class="hs-identifier hs-type">ByteLimits</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679183271"><span id="local-6989586621679183272"><span id="local-6989586621679183273"><span id="local-6989586621679183274"><span class="annot"><span class="annottext">ProtocolSizeLimits KeepAlive bKA
forall block point. ProtocolSizeLimits (BlockFetch block point) bBF
forall txid tx. ProtocolSizeLimits (TxSubmission2 txid tx) bTX
forall header point tip.
ProtocolSizeLimits (ChainSync header point tip) bCS
blChainSync :: forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA
-&gt; forall header point tip.
   ProtocolSizeLimits (ChainSync header point tip) bCS
blBlockFetch :: forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA
-&gt; forall block point.
   ProtocolSizeLimits (BlockFetch block point) bBF
blTxSubmission2 :: forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA
-&gt; forall txid tx. ProtocolSizeLimits (TxSubmission2 txid tx) bTX
blKeepAlive :: forall bCS bBF bTX bKA.
ByteLimits bCS bBF bTX bKA -&gt; ProtocolSizeLimits KeepAlive bKA
blChainSync :: forall header point tip.
ProtocolSizeLimits (ChainSync header point tip) bCS
blBlockFetch :: forall block point. ProtocolSizeLimits (BlockFetch block point) bBF
blTxSubmission2 :: forall txid tx. ProtocolSizeLimits (TxSubmission2 txid tx) bTX
blKeepAlive :: ProtocolSizeLimits KeepAlive bKA
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#blChainSync"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679183275"><span class="annot"><span class="annottext">m ChainSyncTimeout
</span><a href="#local-6989586621679183275"><span class="hs-identifier hs-var">genChainSyncTimeout</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReportPeerMetrics</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679183277"><span id="local-6989586621679183278"><span class="annot"><span class="annottext">Tracer
  (STM m) (TraceLabelPeer (ConnectionId addrNTN) (SlotNo, Time))
Tracer
  (STM m)
  (TraceLabelPeer (ConnectionId addrNTN) (SizeInBytes, SlotNo, Time))
reportHeader :: Tracer
  (STM m) (TraceLabelPeer (ConnectionId addrNTN) (SlotNo, Time))
reportFetch :: Tracer
  (STM m)
  (TraceLabelPeer (ConnectionId addrNTN) (SizeInBytes, SlotNo, Time))
reportFetch :: forall (m :: * -&gt; *) peerAddr.
ReportPeerMetrics m peerAddr
-&gt; Tracer
     (STM m) (TraceLabelPeer peerAddr (SizeInBytes, SlotNo, Time))
reportHeader :: forall (m :: * -&gt; *) peerAddr.
ReportPeerMetrics m peerAddr
-&gt; Tracer (STM m) (TraceLabelPeer peerAddr (SlotNo, Time))
</span><a href="#local-6989586621679183277"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Handlers"><span class="hs-identifier hs-type">Handlers</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679183281"><span id="local-6989586621679183282"><span id="local-6989586621679183283"><span id="local-6989586621679183284"><span id="local-6989586621679183285"><span id="local-6989586621679183286"><span id="local-6989586621679183287"><span id="local-6989586621679183288"><span id="local-6989586621679183289"><span id="local-6989586621679183290"><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; BlockFetchClient (Header blk) blk m ()
NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionClient (TxId (GenTx blk)) (GenTx blk) m ()
NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; PeerSharingController addrNTN m
-&gt; m (PeerSharingClient addrNTN m ())
NodeToNodeVersion -&gt; ConnectionId addrNTN -&gt; KeepAliveServer m ()
NodeToNodeVersion
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionServerPipelined (TxId (GenTx blk)) (GenTx blk) m ()
NodeToNodeVersion
-&gt; ConnectionId addrNTN -&gt; PeerSharingServer addrNTN m
ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
ConnectionId addrNTN
-&gt; IsBigLedgerPeer
-&gt; DynamicEnv m blk
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
hChainSyncClient :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; ConnectionId addr
-&gt; IsBigLedgerPeer
-&gt; DynamicEnv m blk
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
hChainSyncServer :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; ConnectionId addr
-&gt; NodeToNodeVersion
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
hBlockFetchClient :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; BlockFetchClient (Header blk) blk m ()
hBlockFetchServer :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; ConnectionId addr
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
hTxSubmissionClient :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addr
-&gt; TxSubmissionClient (GenTxId blk) (GenTx blk) m ()
hTxSubmissionServer :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ConnectionId addr
-&gt; TxSubmissionServerPipelined (GenTxId blk) (GenTx blk) m ()
hKeepAliveClient :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addr
-&gt; StrictTVar m (Map (ConnectionId addr) PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
hKeepAliveServer :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion -&gt; ConnectionId addr -&gt; KeepAliveServer m ()
hPeerSharingClient :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addr
-&gt; PeerSharingController addr m
-&gt; m (PeerSharingClient addr m ())
hPeerSharingServer :: forall (m :: * -&gt; *) addr blk.
Handlers m addr blk
-&gt; NodeToNodeVersion
-&gt; ConnectionId addr
-&gt; PeerSharingServer addr m
hChainSyncClient :: ConnectionId addrNTN
-&gt; IsBigLedgerPeer
-&gt; DynamicEnv m blk
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
hChainSyncServer :: ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
hBlockFetchClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; BlockFetchClient (Header blk) blk m ()
hBlockFetchServer :: ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
hTxSubmissionClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionClient (TxId (GenTx blk)) (GenTx blk) m ()
hTxSubmissionServer :: NodeToNodeVersion
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionServerPipelined (TxId (GenTx blk)) (GenTx blk) m ()
hKeepAliveClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
hKeepAliveServer :: NodeToNodeVersion -&gt; ConnectionId addrNTN -&gt; KeepAliveServer m ()
hPeerSharingClient :: NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; PeerSharingController addrNTN m
-&gt; m (PeerSharingClient addrNTN m ())
hPeerSharingServer :: NodeToNodeVersion
-&gt; ConnectionId addrNTN -&gt; PeerSharingServer addrNTN m
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#hChainSyncClient"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-547"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-type">Apps</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ClientApp m addrNTN bCS NodeToNodeInitiatorResult
ClientApp m addrNTN bBF NodeToNodeInitiatorResult
ClientApp m addrNTN bTX NodeToNodeInitiatorResult
ClientApp m addrNTN bKA NodeToNodeInitiatorResult
ClientApp m addrNTN bPS NodeToNodeInitiatorResult
ServerApp m addrNTN bCS ()
ServerApp m addrNTN bBF ()
ServerApp m addrNTN bTX ()
ServerApp m addrNTN bKA ()
ServerApp m addrNTN bPS ()
aChainSyncClient :: ClientApp m addrNTN bCS NodeToNodeInitiatorResult
aChainSyncServer :: ServerApp m addrNTN bCS ()
aBlockFetchClient :: ClientApp m addrNTN bBF NodeToNodeInitiatorResult
aBlockFetchServer :: ServerApp m addrNTN bBF ()
aTxSubmission2Client :: ClientApp m addrNTN bTX NodeToNodeInitiatorResult
aTxSubmission2Server :: ServerApp m addrNTN bTX ()
aKeepAliveClient :: ClientApp m addrNTN bKA NodeToNodeInitiatorResult
aKeepAliveServer :: ServerApp m addrNTN bKA ()
aPeerSharingClient :: ClientApp m addrNTN bPS NodeToNodeInitiatorResult
aPeerSharingServer :: ServerApp m addrNTN bPS ()
aChainSyncClient :: ClientApp m addrNTN bCS NodeToNodeInitiatorResult
aChainSyncServer :: ServerApp m addrNTN bCS ()
aBlockFetchClient :: ClientApp m addrNTN bBF NodeToNodeInitiatorResult
aBlockFetchServer :: ServerApp m addrNTN bBF ()
aTxSubmission2Client :: ClientApp m addrNTN bTX NodeToNodeInitiatorResult
aTxSubmission2Server :: ServerApp m addrNTN bTX ()
aKeepAliveClient :: ClientApp m addrNTN bKA NodeToNodeInitiatorResult
aKeepAliveServer :: ServerApp m addrNTN bKA ()
aPeerSharingClient :: ClientApp m addrNTN bPS NodeToNodeInitiatorResult
aPeerSharingServer :: ServerApp m addrNTN bPS ()
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aChainSyncClient"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-549"></span><span>    </span><span class="annot"><a href="#local-6989586621679183291"><span class="hs-identifier hs-type">aChainSyncClient</span></a></span><span>
</span><span id="line-550"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-551"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-552"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span>
</span><span id="line-553"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NodeToNodeInitiatorResult"><span class="hs-identifier hs-type">NodeToNodeInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-554"></span><span>    </span><span id="local-6989586621679183291"><span class="annot"><span class="annottext">aChainSyncClient :: ClientApp m addrNTN bCS NodeToNodeInitiatorResult
</span><a href="#local-6989586621679183291"><span class="hs-identifier hs-var hs-var">aChainSyncClient</span></a></span></span><span> </span><span id="local-6989586621679183301"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183301"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-555"></span><span>                               </span><span class="annot"><span class="annottext">eicConnectionId :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">eicConnectionId</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183304"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183304"><span class="hs-identifier hs-var">them</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-556"></span><span>                               </span><span class="annot"><span class="annottext">eicControlMessage :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ControlMessageSTM m
</span><span class="hs-identifier hs-var">eicControlMessage</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183306"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183306"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-557"></span><span>                               </span><span class="annot"><span class="annottext">eicIsBigLedgerPeer :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; IsBigLedgerPeer
</span><span class="hs-identifier hs-var">eicIsBigLedgerPeer</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183308"><span class="annot"><span class="annottext">IsBigLedgerPeer
</span><a href="#local-6989586621679183308"><span class="hs-identifier hs-var">isBigLedgerPeer</span></a></span></span><span>
</span><span id="line-558"></span><span>                             </span><span class="hs-special">}</span><span>
</span><span id="line-559"></span><span>                             </span><span id="local-6989586621679183309"><span class="annot"><span class="annottext">Channel m bCS
</span><a href="#local-6989586621679183309"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-560"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainSyncClient&quot;</span></span><span>
</span><span id="line-561"></span><span>      </span><span class="hs-comment">-- Note that it is crucial that we sync with the fetch client &quot;outside&quot;</span><span>
</span><span id="line-562"></span><span>      </span><span class="hs-comment">-- of registering the state for the sync client. This is needed to</span><span>
</span><span id="line-563"></span><span>      </span><span class="hs-comment">-- maintain a state invariant required by the block fetch logic: that for</span><span>
</span><span id="line-564"></span><span>      </span><span class="hs-comment">-- each candidate chain there is a corresponding block fetch client that</span><span>
</span><span id="line-565"></span><span>      </span><span class="hs-comment">-- can be used to fetch blocks for that chain.</span><span>
</span><span id="line-566"></span><span>      </span><span class="annot"><span class="annottext">FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
-&gt; ConnectionId addrNTN
-&gt; m (NodeToNodeInitiatorResult, Maybe bCS)
-&gt; m (NodeToNodeInitiatorResult, Maybe bCS)
forall (m :: * -&gt; *) a peer header block.
(MonadSTM m, MonadFork m, MonadCatch m, Ord peer) =&gt;
FetchClientRegistry peer header block m -&gt; peer -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">bracketSyncWithFetchClient</span></span><span>
</span><span id="line-567"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
-&gt; FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk
-&gt; FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetFetchClientRegistry%3ANodeKernel"><span class="hs-identifier hs-var">getFetchClientRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183304"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">(m (NodeToNodeInitiatorResult, Maybe bCS)
 -&gt; m (NodeToNodeInitiatorResult, Maybe bCS))
-&gt; m (NodeToNodeInitiatorResult, Maybe bCS)
-&gt; m (NodeToNodeInitiatorResult, Maybe bCS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-568"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; ChainDbView m blk
-&gt; StrictTVar
     m
     (Map
        (ConnectionId addrNTN)
        (StrictTVar m (AnchoredFragment (Header blk))))
-&gt; ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; (StrictTVar m (AnchoredFragment (Header blk))
    -&gt; m (NodeToNodeInitiatorResult, Maybe bCS))
-&gt; m (NodeToNodeInitiatorResult, Maybe bCS)
forall (m :: * -&gt; *) peer blk a.
(IOLike m, Ord peer, LedgerSupportsProtocol blk) =&gt;
Tracer m (TraceChainSyncClientEvent blk)
-&gt; ChainDbView m blk
-&gt; StrictTVar
     m (Map peer (StrictTVar m (AnchoredFragment (Header blk))))
-&gt; peer
-&gt; NodeToNodeVersion
-&gt; (StrictTVar m (AnchoredFragment (Header blk)) -&gt; m a)
-&gt; m a
</span><span class="hs-identifier hs-var">CsClient.bracketChainSyncClient</span></span><span>
</span><span id="line-569"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN) (TraceChainSyncClientEvent blk))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceChainSyncClientEvent blk))
-&gt; Tracer m (TraceChainSyncClientEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceChainSyncClientEvent blk
-&gt; TraceLabelPeer
     (ConnectionId addrNTN) (TraceChainSyncClientEvent blk)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183304"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracers' (ConnectionId addrNTN) addrNTC blk (Tracer m)
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN) (TraceChainSyncClientEvent blk))
forall remotePeer localPeer blk (f :: * -&gt; *).
Tracers' remotePeer localPeer blk f
-&gt; f (TraceLabelPeer remotePeer (TraceChainSyncClientEvent blk))
</span><a href="Ouroboros.Consensus.Node.Tracers.html#chainSyncClientTracer"><span class="hs-identifier hs-var">Node.chainSyncClientTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
-&gt; Tracers' (ConnectionId addrNTN) addrNTC blk (Tracer m)
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk
-&gt; Tracers m (ConnectionId addrNTN) addrNTC blk
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetTracers%3ANodeKernel"><span class="hs-identifier hs-var">getTracers</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDB m blk -&gt; ChainDbView m blk
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ChainDB m blk -&gt; ChainDbView m blk
</span><span class="hs-identifier hs-var">CsClient.defaultChainDbView</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk -&gt; ChainDB m blk
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk -&gt; ChainDB m blk
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetChainDB%3ANodeKernel"><span class="hs-identifier hs-var">getChainDB</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
-&gt; StrictTVar
     m
     (Map
        (ConnectionId addrNTN)
        (StrictTVar m (AnchoredFragment (Header blk))))
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk
-&gt; StrictTVar
     m
     (Map
        (ConnectionId addrNTN)
        (StrictTVar m (AnchoredFragment (Header blk))))
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetNodeCandidates%3ANodeKernel"><span class="hs-identifier hs-var">getNodeCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-572"></span><span>            </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183304"><span class="hs-identifier hs-var">them</span></a></span><span>
</span><span id="line-573"></span><span>            </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183301"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">((StrictTVar m (AnchoredFragment (Header blk))
  -&gt; m (NodeToNodeInitiatorResult, Maybe bCS))
 -&gt; m (NodeToNodeInitiatorResult, Maybe bCS))
-&gt; (StrictTVar m (AnchoredFragment (Header blk))
    -&gt; m (NodeToNodeInitiatorResult, Maybe bCS))
-&gt; m (NodeToNodeInitiatorResult, Maybe bCS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679183315"><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679183315"><span class="hs-identifier hs-var">varCandidate</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-574"></span><span>              </span><span id="local-6989586621679183316"><span class="annot"><span class="annottext">ChainSyncTimeout
</span><a href="#local-6989586621679183316"><span class="hs-identifier hs-var">chainSyncTimeout</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ChainSyncTimeout
</span><a href="#local-6989586621679183275"><span class="hs-identifier hs-var">genChainSyncTimeout</span></a></span><span>
</span><span id="line-575"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621679183317"><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621679183317"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679183318"><span class="annot"><span class="annottext">Maybe bCS
</span><a href="#local-6989586621679183318"><span class="hs-identifier hs-var">trailing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-576"></span><span>                </span><span class="annot"><span class="annottext">Tracer
  m (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk)))
-&gt; Codec (ChainSync (Header blk) (Point blk) (Tip blk)) e m bCS
-&gt; ProtocolSizeLimits
     (ChainSync (Header blk) (Point blk) (Tip blk)) bCS
-&gt; ProtocolTimeLimits
     (ChainSync (Header blk) (Point blk) (Tip blk))
-&gt; Channel m bCS
-&gt; PeerPipelined
     (ChainSync (Header blk) (Point blk) (Tip blk))
     'AsClient
     'StIdle
     m
     ChainSyncClientResult
-&gt; m (ChainSyncClientResult, Maybe bCS)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; PeerPipelined ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPipelinedPeerWithLimits</span></span><span>
</span><span id="line-577"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
-&gt; Tracer
     m (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk)))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))
-&gt; TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk)))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183304"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (ChainSync (Header blk) (Point blk) (Tip blk))))
</span><a href="#local-6989586621679183265"><span class="hs-identifier hs-var">tChainSyncTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec (ChainSync (Header blk) (Point blk) (Tip blk)) e m bCS
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (ChainSync (Header blk) (Point blk) (Tip blk)) e m bCS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodec"><span class="hs-identifier hs-var">cChainSyncCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183301"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>                  </span><span class="annot"><span class="annottext">ProtocolSizeLimits
  (ChainSync (Header blk) (Point blk) (Tip blk)) bCS
forall header point tip.
ProtocolSizeLimits (ChainSync header point tip) bCS
</span><a href="#local-6989586621679183271"><span class="hs-identifier hs-var">blChainSync</span></a></span><span>
</span><span id="line-580"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncTimeout
-&gt; ProtocolTimeLimits
     (ChainSync (Header blk) (Point blk) (Tip blk))
forall {k} {k1} {k2} (header :: k) (point :: k1) (tip :: k2).
ChainSyncTimeout -&gt; ProtocolTimeLimits (ChainSync header point tip)
</span><span class="hs-identifier hs-var">timeLimitsChainSync</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncTimeout
</span><a href="#local-6989586621679183316"><span class="hs-identifier hs-var">chainSyncTimeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-581"></span><span>                  </span><span class="annot"><span class="annottext">Channel m bCS
</span><a href="#local-6989586621679183309"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-582"></span><span>                  </span><span class="annot"><span class="annottext">(PeerPipelined
   (ChainSync (Header blk) (Point blk) (Tip blk))
   'AsClient
   'StIdle
   m
   ChainSyncClientResult
 -&gt; m (ChainSyncClientResult, Maybe bCS))
-&gt; PeerPipelined
     (ChainSync (Header blk) (Point blk) (Tip blk))
     'AsClient
     'StIdle
     m
     ChainSyncClientResult
-&gt; m (ChainSyncClientResult, Maybe bCS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientPipelined
  (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; PeerPipelined
     (ChainSync (Header blk) (Point blk) (Tip blk))
     'AsClient
     'StIdle
     m
     ChainSyncClientResult
forall header point tip (m :: * -&gt; *) a.
Monad m =&gt;
ChainSyncClientPipelined header point tip m a
-&gt; PeerPipelined (ChainSync header point tip) 'AsClient 'StIdle m a
</span><span class="hs-identifier hs-var">chainSyncClientPeerPipelined</span></span><span>
</span><span id="line-583"></span><span>                  </span><span class="annot"><span class="annottext">(ChainSyncClientPipelined
   (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; PeerPipelined
      (ChainSync (Header blk) (Point blk) (Tip blk))
      'AsClient
      'StIdle
      m
      ChainSyncClientResult)
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; PeerPipelined
     (ChainSync (Header blk) (Point blk) (Tip blk))
     'AsClient
     'StIdle
     m
     ChainSyncClientResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; IsBigLedgerPeer
-&gt; DynamicEnv m blk
-&gt; ChainSyncClientPipelined
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
</span><a href="#local-6989586621679183281"><span class="hs-identifier hs-var">hChainSyncClient</span></a></span><span>
</span><span id="line-584"></span><span>                      </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183304"><span class="hs-identifier hs-var">them</span></a></span><span>
</span><span id="line-585"></span><span>                      </span><span class="annot"><span class="annottext">IsBigLedgerPeer
</span><a href="#local-6989586621679183308"><span class="hs-identifier hs-var">isBigLedgerPeer</span></a></span><span>
</span><span id="line-586"></span><span>                      </span><span class="annot"><span class="hs-identifier hs-type">CsClient.DynamicEnv</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-587"></span><span>                          </span><span class="annot"><span class="annottext">NodeToNodeVersion
version :: NodeToNodeVersion
$sel:version:DynamicEnv :: NodeToNodeVersion
</span><a href="#local-6989586621679183301"><span class="hs-identifier hs-var hs-var">CsClient.version</span></a></span><span>
</span><span id="line-588"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
controlMessageSTM :: ControlMessageSTM m
$sel:controlMessageSTM:DynamicEnv :: ControlMessageSTM m
</span><a href="#local-6989586621679183306"><span class="hs-identifier hs-var hs-var">CsClient.controlMessageSTM</span></a></span><span>
</span><span id="line-589"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:headerMetricsTracer:DynamicEnv :: HeaderMetricsTracer m
</span><span class="hs-identifier hs-var">CsClient.headerMetricsTracer</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; (SlotNo, Time)
-&gt; TraceLabelPeer (ConnectionId addrNTN) (SlotNo, Time)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183304"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">((SlotNo, Time)
 -&gt; TraceLabelPeer (ConnectionId addrNTN) (SlotNo, Time))
-&gt; Tracer
     (STM m) (TraceLabelPeer (ConnectionId addrNTN) (SlotNo, Time))
-&gt; HeaderMetricsTracer m
forall a' a. (a' -&gt; a) -&gt; Tracer (STM m) a -&gt; Tracer (STM m) a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer
  (STM m) (TraceLabelPeer (ConnectionId addrNTN) (SlotNo, Time))
</span><a href="#local-6989586621679183277"><span class="hs-identifier hs-var">reportHeader</span></a></span><span>
</span><span id="line-590"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
varCandidate :: StrictTVar m (AnchoredFragment (Header blk))
$sel:varCandidate:DynamicEnv :: StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679183315"><span class="hs-identifier hs-var hs-var">CsClient.varCandidate</span></a></span><span>
</span><span id="line-591"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-592"></span><span>              </span><span class="annot"><span class="annottext">(NodeToNodeInitiatorResult, Maybe bCS)
-&gt; m (NodeToNodeInitiatorResult, Maybe bCS)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncClientResult -&gt; NodeToNodeInitiatorResult
</span><a href="Ouroboros.Consensus.Node.ExitPolicy.html#ChainSyncInitiatorResult"><span class="hs-identifier hs-var">ChainSyncInitiatorResult</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621679183317"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe bCS
</span><a href="#local-6989586621679183318"><span class="hs-identifier hs-var">trailing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-593"></span><span>
</span><span id="line-594"></span><span>    </span><span class="annot"><a href="#local-6989586621679183292"><span class="hs-identifier hs-type">aChainSyncServer</span></a></span><span>
</span><span id="line-595"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-596"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>
</span><span id="line-597"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span>
</span><span id="line-598"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182363"><span class="hs-identifier hs-type">bCS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>    </span><span id="local-6989586621679183292"><span class="annot"><span class="annottext">aChainSyncServer :: ServerApp m addrNTN bCS ()
</span><a href="#local-6989586621679183292"><span class="hs-identifier hs-var hs-var">aChainSyncServer</span></a></span></span><span> </span><span id="local-6989586621679183328"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183328"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rcConnectionId :: forall addr. ResponderContext addr -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">rcConnectionId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183331"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183331"><span class="hs-identifier hs-var">them</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679183332"><span class="annot"><span class="annottext">Channel m bCS
</span><a href="#local-6989586621679183332"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-600"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainSyncServer&quot;</span></span><span>
</span><span id="line-601"></span><span>      </span><span id="local-6989586621679183333"><span class="annot"><span class="annottext">ChainSyncTimeout
</span><a href="#local-6989586621679183333"><span class="hs-identifier hs-var">chainSyncTimeout</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ChainSyncTimeout
</span><a href="#local-6989586621679183275"><span class="hs-identifier hs-var">genChainSyncTimeout</span></a></span><span>
</span><span id="line-602"></span><span>      </span><span class="annot"><span class="annottext">(ResourceRegistry m
 -&gt; m (Follower m blk (WithPoint blk (SerialisedHeader blk))))
-&gt; (Follower m blk (WithPoint blk (SerialisedHeader blk)) -&gt; m ())
-&gt; (Follower m blk (WithPoint blk (SerialisedHeader blk))
    -&gt; m ((), Maybe bCS))
-&gt; m ((), Maybe bCS)
forall (m :: * -&gt; *) a r.
(IOLike m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; (a -&gt; m ()) -&gt; (a -&gt; m r) -&gt; m r
</span><span class="hs-identifier hs-var">bracketWithPrivateRegistry</span></span><span>
</span><span id="line-603"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDB m blk
-&gt; ChainType
-&gt; ResourceRegistry m
-&gt; m (Follower m blk (WithPoint blk (SerialisedHeader blk)))
forall (m :: * -&gt; *) blk.
ChainDB m blk
-&gt; ChainType
-&gt; ResourceRegistry m
-&gt; m (Follower m blk (WithPoint blk (SerialisedHeader blk)))
</span><span class="hs-identifier hs-var">chainSyncHeaderServerFollower</span></span><span>
</span><span id="line-604"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk -&gt; ChainDB m blk
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk -&gt; ChainDB m blk
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetChainDB%3ANodeKernel"><span class="hs-identifier hs-var">getChainDB</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>           </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">isPipeliningEnabled</span></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183328"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-606"></span><span>              </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">ReceivingTentativeBlocks</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainType
</span><span class="hs-identifier hs-var">ChainDB.TentativeChain</span></span><span>
</span><span id="line-607"></span><span>              </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">NotReceivingTentativeBlocks</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainType
</span><span class="hs-identifier hs-var">ChainDB.SelectedChain</span></span><span>
</span><span id="line-608"></span><span>           </span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>        </span><span class="annot"><span class="annottext">Follower m blk (WithPoint blk (SerialisedHeader blk)) -&gt; m ()
forall (m :: * -&gt; *) blk a. Follower m blk a -&gt; m ()
</span><span class="hs-identifier hs-var">ChainDB.followerClose</span></span><span>
</span><span id="line-611"></span><span>        </span><span class="annot"><span class="annottext">((Follower m blk (WithPoint blk (SerialisedHeader blk))
  -&gt; m ((), Maybe bCS))
 -&gt; m ((), Maybe bCS))
-&gt; (Follower m blk (WithPoint blk (SerialisedHeader blk))
    -&gt; m ((), Maybe bCS))
-&gt; m ((), Maybe bCS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679183341"><span class="annot"><span class="annottext">Follower m blk (WithPoint blk (SerialisedHeader blk))
</span><a href="#local-6989586621679183341"><span class="hs-identifier hs-var">flr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-612"></span><span>          </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceSendRecv
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) e m bCS
-&gt; ProtocolSizeLimits
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) bCS
-&gt; ProtocolTimeLimits
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
-&gt; Channel m bCS
-&gt; Peer
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     'AsServer
     'StIdle
     m
     ()
-&gt; m ((), Maybe bCS)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; Peer ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPeerWithLimits</span></span><span>
</span><span id="line-613"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceSendRecv
   (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceSendRecv
         (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceSendRecv
           (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
-&gt; Tracer
     m
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceSendRecv
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
-&gt; TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183331"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv
        (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))))
</span><a href="#local-6989586621679183266"><span class="hs-identifier hs-var">tChainSyncSerialisedTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) e m bCS
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) e m bSCS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cChainSyncCodecSerialised"><span class="hs-identifier hs-var">cChainSyncCodecSerialised</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183328"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>            </span><span class="annot"><span class="annottext">ProtocolSizeLimits
  (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk)) bCS
forall header point tip.
ProtocolSizeLimits (ChainSync header point tip) bCS
</span><a href="#local-6989586621679183271"><span class="hs-identifier hs-var">blChainSync</span></a></span><span>
</span><span id="line-616"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncTimeout
-&gt; ProtocolTimeLimits
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
forall {k} {k1} {k2} (header :: k) (point :: k1) (tip :: k2).
ChainSyncTimeout -&gt; ProtocolTimeLimits (ChainSync header point tip)
</span><span class="hs-identifier hs-var">timeLimitsChainSync</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncTimeout
</span><a href="#local-6989586621679183333"><span class="hs-identifier hs-var">chainSyncTimeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>            </span><span class="annot"><span class="annottext">Channel m bCS
</span><a href="#local-6989586621679183332"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-618"></span><span>            </span><span class="annot"><span class="annottext">(Peer
   (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
   'AsServer
   'StIdle
   m
   ()
 -&gt; m ((), Maybe bCS))
-&gt; Peer
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     'AsServer
     'StIdle
     m
     ()
-&gt; m ((), Maybe bCS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer (SerialisedHeader blk) (Point blk) (Tip blk) m ()
-&gt; Peer
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     'AsServer
     'StIdle
     m
     ()
forall header point tip (m :: * -&gt; *) a.
Monad m =&gt;
ChainSyncServer header point tip m a
-&gt; Peer (ChainSync header point tip) 'AsServer 'StIdle m a
</span><span class="hs-identifier hs-var">chainSyncServerPeer</span></span><span>
</span><span id="line-619"></span><span>            </span><span class="annot"><span class="annottext">(ChainSyncServer (SerialisedHeader blk) (Point blk) (Tip blk) m ()
 -&gt; Peer
      (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
      'AsServer
      'StIdle
      m
      ())
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
-&gt; Peer
     (ChainSync (SerialisedHeader blk) (Point blk) (Tip blk))
     'AsServer
     'StIdle
     m
     ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; Follower m blk (WithPoint blk (SerialisedHeader blk))
-&gt; ChainSyncServer
     (SerialisedHeader blk) (Point blk) (Tip blk) m ()
</span><a href="#local-6989586621679183282"><span class="hs-identifier hs-var">hChainSyncServer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183331"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183328"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">Follower m blk (WithPoint blk (SerialisedHeader blk))
</span><a href="#local-6989586621679183341"><span class="hs-identifier hs-var">flr</span></a></span><span>
</span><span id="line-620"></span><span>
</span><span id="line-621"></span><span>    </span><span class="annot"><a href="#local-6989586621679183293"><span class="hs-identifier hs-type">aBlockFetchClient</span></a></span><span>
</span><span id="line-622"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-623"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-624"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span>
</span><span id="line-625"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NodeToNodeInitiatorResult"><span class="hs-identifier hs-type">NodeToNodeInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>    </span><span id="local-6989586621679183293"><span class="annot"><span class="annottext">aBlockFetchClient :: ClientApp m addrNTN bBF NodeToNodeInitiatorResult
</span><a href="#local-6989586621679183293"><span class="hs-identifier hs-var hs-var">aBlockFetchClient</span></a></span></span><span> </span><span id="local-6989586621679183344"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183344"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-627"></span><span>                                </span><span class="annot"><span class="annottext">eicConnectionId :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">eicConnectionId</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183345"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183345"><span class="hs-identifier hs-var">them</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-628"></span><span>                                </span><span class="annot"><span class="annottext">eicControlMessage :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ControlMessageSTM m
</span><span class="hs-identifier hs-var">eicControlMessage</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183346"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183346"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span>
</span><span id="line-629"></span><span>                              </span><span class="hs-special">}</span><span>
</span><span id="line-630"></span><span>                              </span><span id="local-6989586621679183347"><span class="annot"><span class="annottext">Channel m bBF
</span><a href="#local-6989586621679183347"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-631"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BlockFetchClient&quot;</span></span><span>
</span><span id="line-632"></span><span>      </span><span class="annot"><span class="annottext">FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
-&gt; NodeToNodeVersion
-&gt; (NodeToNodeVersion -&gt; WhetherReceivingTentativeBlocks)
-&gt; ConnectionId addrNTN
-&gt; (FetchClientContext (Header blk) blk m
    -&gt; m (NodeToNodeInitiatorResult, Maybe bBF))
-&gt; m (NodeToNodeInitiatorResult, Maybe bBF)
forall (m :: * -&gt; *) a peer header block version.
(MonadSTM m, MonadFork m, MonadMask m, Ord peer) =&gt;
FetchClientRegistry peer header block m
-&gt; version
-&gt; (version -&gt; WhetherReceivingTentativeBlocks)
-&gt; peer
-&gt; (FetchClientContext header block m -&gt; m a)
-&gt; m a
</span><span class="hs-identifier hs-var">bracketFetchClient</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
-&gt; FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk
-&gt; FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetFetchClientRegistry%3ANodeKernel"><span class="hs-identifier hs-var">getFetchClientRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183344"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-633"></span><span>                         </span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">isPipeliningEnabled</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183345"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchClientContext (Header blk) blk m
  -&gt; m (NodeToNodeInitiatorResult, Maybe bBF))
 -&gt; m (NodeToNodeInitiatorResult, Maybe bBF))
-&gt; (FetchClientContext (Header blk) blk m
    -&gt; m (NodeToNodeInitiatorResult, Maybe bBF))
-&gt; m (NodeToNodeInitiatorResult, Maybe bBF)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679183349"><span class="annot"><span class="annottext">FetchClientContext (Header blk) blk m
</span><a href="#local-6989586621679183349"><span class="hs-identifier hs-var">clientCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-634"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679183350"><span class="annot"><span class="annottext">Maybe bBF
</span><a href="#local-6989586621679183350"><span class="hs-identifier hs-var">trailing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv (BlockFetch blk (Point blk)))
-&gt; Codec (BlockFetch blk (Point blk)) e m bBF
-&gt; ProtocolSizeLimits (BlockFetch blk (Point blk)) bBF
-&gt; ProtocolTimeLimits (BlockFetch blk (Point blk))
-&gt; Channel m bBF
-&gt; PeerPipelined
     (BlockFetch blk (Point blk)) 'AsClient 'BFIdle m ()
-&gt; m ((), Maybe bBF)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; PeerPipelined ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPipelinedPeerWithLimits</span></span><span>
</span><span id="line-635"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceSendRecv (BlockFetch blk (Point blk))
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceSendRecv (BlockFetch blk (Point blk))))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceSendRecv (BlockFetch blk (Point blk))))
-&gt; Tracer m (TraceSendRecv (BlockFetch blk (Point blk)))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceSendRecv (BlockFetch blk (Point blk))
-&gt; TraceLabelPeer
     (ConnectionId addrNTN) (TraceSendRecv (BlockFetch blk (Point blk)))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183345"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (BlockFetch blk (Point blk))))
</span><a href="#local-6989586621679183267"><span class="hs-identifier hs-var">tBlockFetchTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec (BlockFetch blk (Point blk)) e m bBF
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (BlockFetch blk (Point blk)) e m bBF
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodec"><span class="hs-identifier hs-var">cBlockFetchCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183344"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>          </span><span class="annot"><span class="annottext">ProtocolSizeLimits (BlockFetch blk (Point blk)) bBF
forall block point. ProtocolSizeLimits (BlockFetch block point) bBF
</span><a href="#local-6989586621679183272"><span class="hs-identifier hs-var">blBlockFetch</span></a></span><span>
</span><span id="line-638"></span><span>          </span><span class="annot"><span class="annottext">ProtocolTimeLimits (BlockFetch blk (Point blk))
forall {k} {k1} (block :: k) (point :: k1).
ProtocolTimeLimits (BlockFetch block point)
</span><span class="hs-identifier hs-var">timeLimitsBlockFetch</span></span><span>
</span><span id="line-639"></span><span>          </span><span class="annot"><span class="annottext">Channel m bBF
</span><a href="#local-6989586621679183347"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-640"></span><span>          </span><span class="annot"><span class="annottext">(PeerPipelined (BlockFetch blk (Point blk)) 'AsClient 'BFIdle m ()
 -&gt; m ((), Maybe bBF))
-&gt; PeerPipelined
     (BlockFetch blk (Point blk)) 'AsClient 'BFIdle m ()
-&gt; m ((), Maybe bBF)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; FetchedMetricsTracer m
-&gt; BlockFetchClient (Header blk) blk m ()
</span><a href="#local-6989586621679183283"><span class="hs-identifier hs-var">hBlockFetchClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183344"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183346"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span>
</span><span id="line-641"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; (SizeInBytes, SlotNo, Time)
-&gt; TraceLabelPeer
     (ConnectionId addrNTN) (SizeInBytes, SlotNo, Time)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183345"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">((SizeInBytes, SlotNo, Time)
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN) (SizeInBytes, SlotNo, Time))
-&gt; Tracer
     (STM m)
     (TraceLabelPeer (ConnectionId addrNTN) (SizeInBytes, SlotNo, Time))
-&gt; FetchedMetricsTracer m
forall a' a. (a' -&gt; a) -&gt; Tracer (STM m) a -&gt; Tracer (STM m) a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer
  (STM m)
  (TraceLabelPeer (ConnectionId addrNTN) (SizeInBytes, SlotNo, Time))
</span><a href="#local-6989586621679183278"><span class="hs-identifier hs-var">reportFetch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FetchClientContext (Header blk) blk m
</span><a href="#local-6989586621679183349"><span class="hs-identifier hs-var">clientCtx</span></a></span><span>
</span><span id="line-642"></span><span>        </span><span class="annot"><span class="annottext">(NodeToNodeInitiatorResult, Maybe bBF)
-&gt; m (NodeToNodeInitiatorResult, Maybe bBF)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeInitiatorResult
</span><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NoInitiatorResult"><span class="hs-identifier hs-var">NoInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe bBF
</span><a href="#local-6989586621679183350"><span class="hs-identifier hs-var">trailing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span>    </span><span class="annot"><a href="#local-6989586621679183294"><span class="hs-identifier hs-type">aBlockFetchServer</span></a></span><span>
</span><span id="line-645"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-646"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>
</span><span id="line-647"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span>
</span><span id="line-648"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182364"><span class="hs-identifier hs-type">bBF</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-649"></span><span>    </span><span id="local-6989586621679183294"><span class="annot"><span class="annottext">aBlockFetchServer :: ServerApp m addrNTN bBF ()
</span><a href="#local-6989586621679183294"><span class="hs-identifier hs-var hs-var">aBlockFetchServer</span></a></span></span><span> </span><span id="local-6989586621679183353"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183353"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rcConnectionId :: forall addr. ResponderContext addr -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">rcConnectionId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183354"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183354"><span class="hs-identifier hs-var">them</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679183355"><span class="annot"><span class="annottext">Channel m bBF
</span><a href="#local-6989586621679183355"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-650"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;BlockFetchServer&quot;</span></span><span>
</span><span id="line-651"></span><span>      </span><span class="annot"><span class="annottext">(ResourceRegistry m -&gt; m ((), Maybe bBF)) -&gt; m ((), Maybe bBF)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
(ResourceRegistry m -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withRegistry</span></span><span> </span><span class="annot"><span class="annottext">((ResourceRegistry m -&gt; m ((), Maybe bBF)) -&gt; m ((), Maybe bBF))
-&gt; (ResourceRegistry m -&gt; m ((), Maybe bBF)) -&gt; m ((), Maybe bBF)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679183357"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679183357"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-652"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv (BlockFetch (Serialised blk) (Point blk)))
-&gt; Codec (BlockFetch (Serialised blk) (Point blk)) e m bBF
-&gt; ProtocolSizeLimits (BlockFetch (Serialised blk) (Point blk)) bBF
-&gt; ProtocolTimeLimits (BlockFetch (Serialised blk) (Point blk))
-&gt; Channel m bBF
-&gt; Peer
     (BlockFetch (Serialised blk) (Point blk)) 'AsServer 'BFIdle m ()
-&gt; m ((), Maybe bBF)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; Peer ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPeerWithLimits</span></span><span>
</span><span id="line-653"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceSendRecv (BlockFetch (Serialised blk) (Point blk))
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
-&gt; Tracer
     m (TraceSendRecv (BlockFetch (Serialised blk) (Point blk)))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceSendRecv (BlockFetch (Serialised blk) (Point blk))
-&gt; TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (BlockFetch (Serialised blk) (Point blk)))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183354"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (BlockFetch (Serialised blk) (Point blk))))
</span><a href="#local-6989586621679183268"><span class="hs-identifier hs-var">tBlockFetchSerialisedTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec (BlockFetch (Serialised blk) (Point blk)) e m bBF
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (BlockFetch (Serialised blk) (Point blk)) e m bSBF
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cBlockFetchCodecSerialised"><span class="hs-identifier hs-var">cBlockFetchCodecSerialised</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183353"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>          </span><span class="annot"><span class="annottext">ProtocolSizeLimits (BlockFetch (Serialised blk) (Point blk)) bBF
forall block point. ProtocolSizeLimits (BlockFetch block point) bBF
</span><a href="#local-6989586621679183272"><span class="hs-identifier hs-var">blBlockFetch</span></a></span><span>
</span><span id="line-656"></span><span>          </span><span class="annot"><span class="annottext">ProtocolTimeLimits (BlockFetch (Serialised blk) (Point blk))
forall {k} {k1} (block :: k) (point :: k1).
ProtocolTimeLimits (BlockFetch block point)
</span><span class="hs-identifier hs-var">timeLimitsBlockFetch</span></span><span>
</span><span id="line-657"></span><span>          </span><span class="annot"><span class="annottext">Channel m bBF
</span><a href="#local-6989586621679183355"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-658"></span><span>          </span><span class="annot"><span class="annottext">(Peer
   (BlockFetch (Serialised blk) (Point blk)) 'AsServer 'BFIdle m ()
 -&gt; m ((), Maybe bBF))
-&gt; Peer
     (BlockFetch (Serialised blk) (Point blk)) 'AsServer 'BFIdle m ()
-&gt; m ((), Maybe bBF)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockFetchServer (Serialised blk) (Point blk) m ()
-&gt; Peer
     (BlockFetch (Serialised blk) (Point blk)) 'AsServer 'BFIdle m ()
forall block point (m :: * -&gt; *) a.
Functor m =&gt;
BlockFetchServer block point m a
-&gt; Peer (BlockFetch block point) 'AsServer 'BFIdle m a
</span><span class="hs-identifier hs-var">blockFetchServerPeer</span></span><span>
</span><span id="line-659"></span><span>          </span><span class="annot"><span class="annottext">(BlockFetchServer (Serialised blk) (Point blk) m ()
 -&gt; Peer
      (BlockFetch (Serialised blk) (Point blk)) 'AsServer 'BFIdle m ())
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
-&gt; Peer
     (BlockFetch (Serialised blk) (Point blk)) 'AsServer 'BFIdle m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; NodeToNodeVersion
-&gt; ResourceRegistry m
-&gt; BlockFetchServer (Serialised blk) (Point blk) m ()
</span><a href="#local-6989586621679183284"><span class="hs-identifier hs-var">hBlockFetchServer</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183354"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183353"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679183357"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>    </span><span class="annot"><a href="#local-6989586621679183295"><span class="hs-identifier hs-type">aTxSubmission2Client</span></a></span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-663"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-664"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span><span>
</span><span id="line-665"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NodeToNodeInitiatorResult"><span class="hs-identifier hs-type">NodeToNodeInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>    </span><span id="local-6989586621679183295"><span class="annot"><span class="annottext">aTxSubmission2Client :: ClientApp m addrNTN bTX NodeToNodeInitiatorResult
</span><a href="#local-6989586621679183295"><span class="hs-identifier hs-var hs-var">aTxSubmission2Client</span></a></span></span><span> </span><span id="local-6989586621679183358"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183358"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-667"></span><span>                                   </span><span class="annot"><span class="annottext">eicConnectionId :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">eicConnectionId</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183359"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183359"><span class="hs-identifier hs-var">them</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-668"></span><span>                                   </span><span class="annot"><span class="annottext">eicControlMessage :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ControlMessageSTM m
</span><span class="hs-identifier hs-var">eicControlMessage</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183360"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183360"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span>
</span><span id="line-669"></span><span>                                 </span><span class="hs-special">}</span><span>
</span><span id="line-670"></span><span>                                 </span><span id="local-6989586621679183361"><span class="annot"><span class="annottext">Channel m bTX
</span><a href="#local-6989586621679183361"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-671"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TxSubmissionClient&quot;</span></span><span>
</span><span id="line-672"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679183362"><span class="annot"><span class="annottext">Maybe bTX
</span><a href="#local-6989586621679183362"><span class="hs-identifier hs-var">trailing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer
  m (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)))
-&gt; Codec (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) e m bTX
-&gt; ProtocolSizeLimits
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) bTX
-&gt; ProtocolTimeLimits
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
-&gt; Channel m bTX
-&gt; Peer
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
     'AsClient
     'StInit
     m
     ()
-&gt; m ((), Maybe bTX)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; Peer ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPeerWithLimits</span></span><span>
</span><span id="line-673"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
-&gt; Tracer
     m (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
-&gt; TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183359"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
</span><a href="#local-6989586621679183269"><span class="hs-identifier hs-var">tTxSubmission2Tracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) e m bTX
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (TxSubmission2 (GenTxId blk) (GenTx blk)) e m bTX
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cTxSubmission2Codec"><span class="hs-identifier hs-var">cTxSubmission2Codec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183358"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>        </span><span class="annot"><span class="annottext">ProtocolSizeLimits
  (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) bTX
forall txid tx. ProtocolSizeLimits (TxSubmission2 txid tx) bTX
</span><a href="#local-6989586621679183273"><span class="hs-identifier hs-var">blTxSubmission2</span></a></span><span>
</span><span id="line-676"></span><span>        </span><span class="annot"><span class="annottext">ProtocolTimeLimits (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
forall {k} {k1} (txid :: k) (tx :: k1).
ProtocolTimeLimits (TxSubmission2 txid tx)
</span><span class="hs-identifier hs-var">timeLimitsTxSubmission2</span></span><span>
</span><span id="line-677"></span><span>        </span><span class="annot"><span class="annottext">Channel m bTX
</span><a href="#local-6989586621679183361"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxSubmissionClient (TxId (GenTx blk)) (GenTx blk) m ()
-&gt; Peer
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
     'AsClient
     'StInit
     m
     ()
forall txid tx (m :: * -&gt; *) a.
Monad m =&gt;
TxSubmissionClient txid tx m a
-&gt; Peer (TxSubmission2 txid tx) 'AsClient 'StInit m a
</span><span class="hs-identifier hs-var">txSubmissionClientPeer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionClient (TxId (GenTx blk)) (GenTx blk) m ()
</span><a href="#local-6989586621679183285"><span class="hs-identifier hs-var">hTxSubmissionClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183358"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183360"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183359"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>      </span><span class="annot"><span class="annottext">(NodeToNodeInitiatorResult, Maybe bTX)
-&gt; m (NodeToNodeInitiatorResult, Maybe bTX)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeInitiatorResult
</span><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NoInitiatorResult"><span class="hs-identifier hs-var">NoInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe bTX
</span><a href="#local-6989586621679183362"><span class="hs-identifier hs-var">trailing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><a href="#local-6989586621679183296"><span class="hs-identifier hs-type">aTxSubmission2Server</span></a></span><span>
</span><span id="line-682"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-683"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>
</span><span id="line-684"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span><span>
</span><span id="line-685"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182365"><span class="hs-identifier hs-type">bTX</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>    </span><span id="local-6989586621679183296"><span class="annot"><span class="annottext">aTxSubmission2Server :: ServerApp m addrNTN bTX ()
</span><a href="#local-6989586621679183296"><span class="hs-identifier hs-var hs-var">aTxSubmission2Server</span></a></span></span><span> </span><span id="local-6989586621679183365"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183365"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rcConnectionId :: forall addr. ResponderContext addr -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">rcConnectionId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183366"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183366"><span class="hs-identifier hs-var">them</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679183367"><span class="annot"><span class="annottext">Channel m bTX
</span><a href="#local-6989586621679183367"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-687"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TxSubmissionServer&quot;</span></span><span>
</span><span id="line-688"></span><span>      </span><span class="annot"><span class="annottext">Tracer
  m (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)))
-&gt; Codec (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) e m bTX
-&gt; ProtocolSizeLimits
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) bTX
-&gt; ProtocolTimeLimits
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
-&gt; Channel m bTX
-&gt; PeerPipelined
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
     'AsServer
     'StInit
     m
     ()
-&gt; m ((), Maybe bTX)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; PeerPipelined ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPipelinedPeerWithLimits</span></span><span>
</span><span id="line-689"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
 -&gt; TraceLabelPeer
      (ConnectionId addrNTN)
      (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
-&gt; Tracer
     m
     (TraceLabelPeer
        (ConnectionId addrNTN)
        (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
-&gt; Tracer
     m (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN
-&gt; TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
-&gt; TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)))
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183366"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TraceLabelPeer
     (ConnectionId addrNTN)
     (TraceSendRecv (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))))
</span><a href="#local-6989586621679183269"><span class="hs-identifier hs-var">tTxSubmission2Tracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) e m bTX
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (TxSubmission2 (GenTxId blk) (GenTx blk)) e m bTX
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cTxSubmission2Codec"><span class="hs-identifier hs-var">cTxSubmission2Codec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183365"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>        </span><span class="annot"><span class="annottext">ProtocolSizeLimits
  (TxSubmission2 (TxId (GenTx blk)) (GenTx blk)) bTX
forall txid tx. ProtocolSizeLimits (TxSubmission2 txid tx) bTX
</span><a href="#local-6989586621679183273"><span class="hs-identifier hs-var">blTxSubmission2</span></a></span><span>
</span><span id="line-692"></span><span>        </span><span class="annot"><span class="annottext">ProtocolTimeLimits (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
forall {k} {k1} (txid :: k) (tx :: k1).
ProtocolTimeLimits (TxSubmission2 txid tx)
</span><span class="hs-identifier hs-var">timeLimitsTxSubmission2</span></span><span>
</span><span id="line-693"></span><span>        </span><span class="annot"><span class="annottext">Channel m bTX
</span><a href="#local-6989586621679183367"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-694"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxSubmissionServerPipelined (TxId (GenTx blk)) (GenTx blk) m ()
-&gt; PeerPipelined
     (TxSubmission2 (TxId (GenTx blk)) (GenTx blk))
     'AsServer
     'StInit
     m
     ()
forall txid tx (m :: * -&gt; *) a.
Functor m =&gt;
TxSubmissionServerPipelined txid tx m a
-&gt; PeerPipelined (TxSubmission2 txid tx) 'AsServer 'StInit m a
</span><span class="hs-identifier hs-var">txSubmissionServerPeerPipelined</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ConnectionId addrNTN
-&gt; TxSubmissionServerPipelined (TxId (GenTx blk)) (GenTx blk) m ()
</span><a href="#local-6989586621679183286"><span class="hs-identifier hs-var">hTxSubmissionServer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183365"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183366"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>    </span><span class="annot"><a href="#local-6989586621679183297"><span class="hs-identifier hs-type">aKeepAliveClient</span></a></span><span>
</span><span id="line-697"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-698"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-699"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span><span>
</span><span id="line-700"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NodeToNodeInitiatorResult"><span class="hs-identifier hs-type">NodeToNodeInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-701"></span><span>    </span><span id="local-6989586621679183297"><span class="annot"><span class="annottext">aKeepAliveClient :: ClientApp m addrNTN bKA NodeToNodeInitiatorResult
</span><a href="#local-6989586621679183297"><span class="hs-identifier hs-var hs-var">aKeepAliveClient</span></a></span></span><span> </span><span id="local-6989586621679183369"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183369"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-702"></span><span>                               </span><span class="annot"><span class="annottext">eicConnectionId :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">eicConnectionId</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183370"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183370"><span class="hs-identifier hs-var">them</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-703"></span><span>                               </span><span class="annot"><span class="annottext">eicControlMessage :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ControlMessageSTM m
</span><span class="hs-identifier hs-var">eicControlMessage</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183371"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183371"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span>
</span><span id="line-704"></span><span>                             </span><span class="hs-special">}</span><span>
</span><span id="line-705"></span><span>                             </span><span id="local-6989586621679183372"><span class="annot"><span class="annottext">Channel m bKA
</span><a href="#local-6989586621679183372"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;KeepAliveClient&quot;</span></span><span>
</span><span id="line-707"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679183438"><span class="annot"><span class="annottext">kacApp :: StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
-&gt; m ((), Maybe bKA)
</span><a href="#local-6989586621679183438"><span class="hs-identifier hs-var hs-var">kacApp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679183439"><span class="annot"><span class="annottext">StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
</span><a href="#local-6989586621679183439"><span class="hs-identifier hs-var">dqCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-708"></span><span>                       </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv KeepAlive)
-&gt; Codec KeepAlive e m bKA
-&gt; ProtocolSizeLimits KeepAlive bKA
-&gt; ProtocolTimeLimits KeepAlive
-&gt; Channel m bKA
-&gt; Peer KeepAlive 'AsClient 'StClient m ()
-&gt; m ((), Maybe bKA)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; Peer ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPeerWithLimits</span></span><span>
</span><span id="line-709"></span><span>                         </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv KeepAlive)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-710"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec KeepAlive e m bKA
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec KeepAlive e m bKA
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cKeepAliveCodec"><span class="hs-identifier hs-var">cKeepAliveCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183369"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>                         </span><span class="annot"><span class="annottext">ProtocolSizeLimits KeepAlive bKA
</span><a href="#local-6989586621679183274"><span class="hs-identifier hs-var">blKeepAlive</span></a></span><span>
</span><span id="line-712"></span><span>                         </span><span class="annot"><span class="annottext">ProtocolTimeLimits KeepAlive
</span><span class="hs-identifier hs-var">timeLimitsKeepAlive</span></span><span>
</span><span id="line-713"></span><span>                         </span><span class="annot"><span class="annottext">Channel m bKA
</span><a href="#local-6989586621679183372"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-714"></span><span>                         </span><span class="annot"><span class="annottext">(Peer KeepAlive 'AsClient 'StClient m () -&gt; m ((), Maybe bKA))
-&gt; Peer KeepAlive 'AsClient 'StClient m () -&gt; m ((), Maybe bKA)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KeepAliveClient m () -&gt; Peer KeepAlive 'AsClient 'StClient m ()
forall (m :: * -&gt; *) a.
MonadThrow m =&gt;
KeepAliveClient m a -&gt; Peer KeepAlive 'AsClient 'StClient m a
</span><span class="hs-identifier hs-var">keepAliveClientPeer</span></span><span>
</span><span id="line-715"></span><span>                         </span><span class="annot"><span class="annottext">(KeepAliveClient m () -&gt; Peer KeepAlive 'AsClient 'StClient m ())
-&gt; KeepAliveClient m () -&gt; Peer KeepAlive 'AsClient 'StClient m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
-&gt; KeepAliveInterval
-&gt; KeepAliveClient m ()
</span><a href="#local-6989586621679183287"><span class="hs-identifier hs-var">hKeepAliveClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183369"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183371"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183370"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
</span><a href="#local-6989586621679183439"><span class="hs-identifier hs-var">dqCtx</span></a></span><span>
</span><span id="line-716"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; KeepAliveInterval
</span><span class="hs-identifier hs-var">KeepAliveInterval</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">10</span></span><span class="hs-special">)</span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679183443"><span class="annot"><span class="annottext">Maybe bKA
</span><a href="#local-6989586621679183443"><span class="hs-identifier hs-var">trailing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
-&gt; ConnectionId addrNTN
-&gt; (StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
    -&gt; m ((), Maybe bKA))
-&gt; m ((), Maybe bKA)
forall (m :: * -&gt; *) a peer header block.
(MonadSTM m, MonadFork m, MonadMask m, Ord peer) =&gt;
FetchClientRegistry peer header block m
-&gt; peer -&gt; (StrictTVar m (Map peer PeerGSV) -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">bracketKeepAliveClient</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
-&gt; FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk
-&gt; FetchClientRegistry (ConnectionId addrNTN) (Header blk) blk m
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetFetchClientRegistry%3ANodeKernel"><span class="hs-identifier hs-var">getFetchClientRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183370"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map (ConnectionId addrNTN) PeerGSV)
-&gt; m ((), Maybe bKA)
</span><a href="#local-6989586621679183438"><span class="hs-identifier hs-var">kacApp</span></a></span><span>
</span><span id="line-719"></span><span>      </span><span class="annot"><span class="annottext">(NodeToNodeInitiatorResult, Maybe bKA)
-&gt; m (NodeToNodeInitiatorResult, Maybe bKA)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeInitiatorResult
</span><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NoInitiatorResult"><span class="hs-identifier hs-var">NoInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe bKA
</span><a href="#local-6989586621679183443"><span class="hs-identifier hs-var">trailing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span>    </span><span class="annot"><a href="#local-6989586621679183298"><span class="hs-identifier hs-type">aKeepAliveServer</span></a></span><span>
</span><span id="line-722"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-723"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>
</span><span id="line-724"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182366"><span class="hs-identifier hs-type">bKA</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>    </span><span id="local-6989586621679183298"><span class="annot"><span class="annottext">aKeepAliveServer :: ServerApp m addrNTN bKA ()
</span><a href="#local-6989586621679183298"><span class="hs-identifier hs-var hs-var">aKeepAliveServer</span></a></span></span><span> </span><span id="local-6989586621679183445"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183445"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679183446"><span class="annot"><span class="annottext">ResponderContext addrNTN
</span><a href="#local-6989586621679183446"><span class="hs-identifier hs-var">_responderCtx</span></a></span></span><span> </span><span id="local-6989586621679183447"><span class="annot"><span class="annottext">Channel m bKA
</span><a href="#local-6989586621679183447"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;KeepAliveServer&quot;</span></span><span>
</span><span id="line-728"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv KeepAlive)
-&gt; Codec KeepAlive e m bKA
-&gt; ProtocolSizeLimits KeepAlive bKA
-&gt; ProtocolTimeLimits KeepAlive
-&gt; Channel m bKA
-&gt; Peer KeepAlive 'AsServer 'StClient m ()
-&gt; m ((), Maybe bKA)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; Peer ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPeerWithLimits</span></span><span>
</span><span id="line-729"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv KeepAlive)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-730"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec KeepAlive e m bKA
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec KeepAlive e m bKA
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cKeepAliveCodec"><span class="hs-identifier hs-var">cKeepAliveCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183445"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(bKA -&gt; Word) -&gt; ProtocolSizeLimits KeepAlive bKA
forall bytes. (bytes -&gt; Word) -&gt; ProtocolSizeLimits KeepAlive bytes
</span><span class="hs-identifier hs-var">byteLimitsKeepAlive</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; bKA -&gt; Word
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- TODO: Real Bytelimits, see #1727</span><span>
</span><span id="line-732"></span><span>        </span><span class="annot"><span class="annottext">ProtocolTimeLimits KeepAlive
</span><span class="hs-identifier hs-var">timeLimitsKeepAlive</span></span><span>
</span><span id="line-733"></span><span>        </span><span class="annot"><span class="annottext">Channel m bKA
</span><a href="#local-6989586621679183447"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-734"></span><span>        </span><span class="annot"><span class="annottext">(Peer KeepAlive 'AsServer 'StClient m () -&gt; m ((), Maybe bKA))
-&gt; Peer KeepAlive 'AsServer 'StClient m () -&gt; m ((), Maybe bKA)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KeepAliveServer m () -&gt; Peer KeepAlive 'AsServer 'StClient m ()
forall (m :: * -&gt; *) a.
Functor m =&gt;
KeepAliveServer m a -&gt; Peer KeepAlive 'AsServer 'StClient m a
</span><span class="hs-identifier hs-var">keepAliveServerPeer</span></span><span>
</span><span id="line-735"></span><span>        </span><span class="annot"><span class="annottext">(KeepAliveServer m () -&gt; Peer KeepAlive 'AsServer 'StClient m ())
-&gt; KeepAliveServer m () -&gt; Peer KeepAlive 'AsServer 'StClient m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KeepAliveServer m ()
forall (m :: * -&gt; *). Applicative m =&gt; KeepAliveServer m ()
</span><span class="hs-identifier hs-var">keepAliveServer</span></span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><a href="#local-6989586621679183299"><span class="hs-identifier hs-type">aPeerSharingClient</span></a></span><span>
</span><span id="line-739"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-740"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-741"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182367"><span class="hs-identifier hs-type">bPS</span></a></span><span>
</span><span id="line-742"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NodeToNodeInitiatorResult"><span class="hs-identifier hs-type">NodeToNodeInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182367"><span class="hs-identifier hs-type">bPS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span>    </span><span id="local-6989586621679183299"><span class="annot"><span class="annottext">aPeerSharingClient :: ClientApp m addrNTN bPS NodeToNodeInitiatorResult
</span><a href="#local-6989586621679183299"><span class="hs-identifier hs-var hs-var">aPeerSharingClient</span></a></span></span><span> </span><span id="local-6989586621679183449"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183449"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-744"></span><span>                                 </span><span class="annot"><span class="annottext">eicConnectionId :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">eicConnectionId</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183450"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183450"><span class="hs-identifier hs-var">them</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-745"></span><span>                                 </span><span class="annot"><span class="annottext">eicControlMessage :: forall addr (m :: * -&gt; *).
ExpandedInitiatorContext addr m -&gt; ControlMessageSTM m
</span><span class="hs-identifier hs-var">eicControlMessage</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183451"><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183451"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span></span><span>
</span><span id="line-746"></span><span>                               </span><span class="hs-special">}</span><span>
</span><span id="line-747"></span><span>                               </span><span id="local-6989586621679183452"><span class="annot"><span class="annottext">Channel m bPS
</span><a href="#local-6989586621679183452"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-748"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PeerSharingClient&quot;</span></span><span>
</span><span id="line-749"></span><span>      </span><span class="annot"><span class="annottext">PeerSharingRegistry addrNTN m
-&gt; addrNTN
-&gt; (PeerSharingController addrNTN m
    -&gt; m (NodeToNodeInitiatorResult, Maybe bPS))
-&gt; m (NodeToNodeInitiatorResult, Maybe bPS)
forall peer (m :: * -&gt; *) a.
(Ord peer, MonadSTM m, MonadThrow m) =&gt;
PeerSharingRegistry peer m
-&gt; peer -&gt; (PeerSharingController peer m -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">bracketPeerSharingClient</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk -&gt; PeerSharingRegistry addrNTN m
forall (m :: * -&gt; *) addrNTN addrNTC blk.
NodeKernel m addrNTN addrNTC blk -&gt; PeerSharingRegistry addrNTN m
</span><a href="Ouroboros.Consensus.NodeKernel.html#%24sel%3AgetPeerSharingRegistry%3ANodeKernel"><span class="hs-identifier hs-var">getPeerSharingRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">NodeKernel m addrNTN addrNTC blk
</span><a href="#local-6989586621679183264"><span class="hs-identifier hs-var">kernel</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnectionId addrNTN -&gt; addrNTN
forall addr. ConnectionId addr -&gt; addr
</span><span class="hs-identifier hs-var">remoteAddress</span></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183450"><span class="hs-identifier hs-var">them</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span>        </span><span class="annot"><span class="annottext">((PeerSharingController addrNTN m
  -&gt; m (NodeToNodeInitiatorResult, Maybe bPS))
 -&gt; m (NodeToNodeInitiatorResult, Maybe bPS))
-&gt; (PeerSharingController addrNTN m
    -&gt; m (NodeToNodeInitiatorResult, Maybe bPS))
-&gt; m (NodeToNodeInitiatorResult, Maybe bPS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679183455"><span class="annot"><span class="annottext">PeerSharingController addrNTN m
</span><a href="#local-6989586621679183455"><span class="hs-identifier hs-var">controller</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-751"></span><span>          </span><span id="local-6989586621679183456"><span class="annot"><span class="annottext">PeerSharingClient addrNTN m ()
</span><a href="#local-6989586621679183456"><span class="hs-identifier hs-var">psClient</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ControlMessageSTM m
-&gt; ConnectionId addrNTN
-&gt; PeerSharingController addrNTN m
-&gt; m (PeerSharingClient addrNTN m ())
</span><a href="#local-6989586621679183289"><span class="hs-identifier hs-var">hPeerSharingClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183449"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679183451"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183450"><span class="hs-identifier hs-var">them</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSharingController addrNTN m
</span><a href="#local-6989586621679183455"><span class="hs-identifier hs-var">controller</span></a></span><span>
</span><span id="line-752"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679183457"><span class="annot"><span class="annottext">Maybe bPS
</span><a href="#local-6989586621679183457"><span class="hs-identifier hs-var">trailing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv (PeerSharing addrNTN))
-&gt; Codec (PeerSharing addrNTN) e m bPS
-&gt; ProtocolSizeLimits (PeerSharing addrNTN) bPS
-&gt; ProtocolTimeLimits (PeerSharing addrNTN)
-&gt; Channel m bPS
-&gt; Peer (PeerSharing addrNTN) 'AsClient 'StIdle m ()
-&gt; m ((), Maybe bPS)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; Peer ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPeerWithLimits</span></span><span>
</span><span id="line-753"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv (PeerSharing addrNTN))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-754"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec (PeerSharing addrNTN) e m bPS
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (PeerSharing addr) e m bPS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cPeerSharingCodec"><span class="hs-identifier hs-var">cPeerSharingCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183449"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(bPS -&gt; Word) -&gt; ProtocolSizeLimits (PeerSharing addrNTN) bPS
forall {k} bytes (peerAddress :: k).
(bytes -&gt; Word)
-&gt; ProtocolSizeLimits (PeerSharing peerAddress) bytes
</span><span class="hs-identifier hs-var">byteLimitsPeerSharing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; bPS -&gt; Word
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>            </span><span class="annot"><span class="annottext">ProtocolTimeLimits (PeerSharing addrNTN)
forall {k} (peerAddress :: k).
ProtocolTimeLimits (PeerSharing peerAddress)
</span><span class="hs-identifier hs-var">timeLimitsPeerSharing</span></span><span>
</span><span id="line-757"></span><span>            </span><span class="annot"><span class="annottext">Channel m bPS
</span><a href="#local-6989586621679183452"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-758"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerSharingClient addrNTN m ()
-&gt; Peer (PeerSharing addrNTN) 'AsClient 'StIdle m ()
forall (m :: * -&gt; *) peerAddress a.
Monad m =&gt;
PeerSharingClient peerAddress m a
-&gt; Peer (PeerSharing peerAddress) 'AsClient 'StIdle m a
</span><span class="hs-identifier hs-var">peerSharingClientPeer</span></span><span> </span><span class="annot"><span class="annottext">PeerSharingClient addrNTN m ()
</span><a href="#local-6989586621679183456"><span class="hs-identifier hs-var">psClient</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span>          </span><span class="annot"><span class="annottext">(NodeToNodeInitiatorResult, Maybe bPS)
-&gt; m (NodeToNodeInitiatorResult, Maybe bPS)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeInitiatorResult
</span><a href="Ouroboros.Consensus.Node.ExitPolicy.html#NoInitiatorResult"><span class="hs-identifier hs-var">NoInitiatorResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe bPS
</span><a href="#local-6989586621679183457"><span class="hs-identifier hs-var">trailing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span>    </span><span class="annot"><a href="#local-6989586621679183300"><span class="hs-identifier hs-type">aPeerSharingServer</span></a></span><span>
</span><span id="line-762"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-763"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679182357"><span class="hs-identifier hs-type">addrNTN</span></a></span><span>
</span><span id="line-764"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Channel</span></span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182367"><span class="hs-identifier hs-type">bPS</span></a></span><span>
</span><span id="line-765"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679182356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182367"><span class="hs-identifier hs-type">bPS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>    </span><span id="local-6989586621679183300"><span class="annot"><span class="annottext">aPeerSharingServer :: ServerApp m addrNTN bPS ()
</span><a href="#local-6989586621679183300"><span class="hs-identifier hs-var hs-var">aPeerSharingServer</span></a></span></span><span> </span><span id="local-6989586621679183458"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183458"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">rcConnectionId :: forall addr. ResponderContext addr -&gt; ConnectionId addr
</span><span class="hs-identifier hs-var">rcConnectionId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679183459"><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183459"><span class="hs-identifier hs-var">them</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679183460"><span class="annot"><span class="annottext">Channel m bPS
</span><a href="#local-6989586621679183460"><span class="hs-identifier hs-var">channel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-767"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadThread m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">labelThisThread</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;PeerSharingServer&quot;</span></span><span>
</span><span id="line-768"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv (PeerSharing addrNTN))
-&gt; Codec (PeerSharing addrNTN) e m bPS
-&gt; ProtocolSizeLimits (PeerSharing addrNTN) bPS
-&gt; ProtocolTimeLimits (PeerSharing addrNTN)
-&gt; Channel m bPS
-&gt; Peer (PeerSharing addrNTN) 'AsServer 'StIdle m ()
-&gt; m ((), Maybe bPS)
forall ps (st :: ps) (pr :: PeerRole) failure bytes (m :: * -&gt; *)
       a.
(MonadAsync m, MonadFork m, MonadMask m, MonadThrow (STM m),
 MonadTimer m, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps,
 Show failure) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; ProtocolSizeLimits ps bytes
-&gt; ProtocolTimeLimits ps
-&gt; Channel m bytes
-&gt; Peer ps pr st m a
-&gt; m (a, Maybe bytes)
</span><span class="hs-identifier hs-var">runPeerWithLimits</span></span><span>
</span><span id="line-769"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceSendRecv (PeerSharing addrNTN))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-770"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
-&gt; Codec (PeerSharing addrNTN) e m bPS
forall blk addr e (m :: * -&gt; *) bCS bSCS bBF bSBF bTX bKA bPS.
Codecs blk addr e m bCS bSCS bBF bSBF bTX bKA bPS
-&gt; Codec (PeerSharing addr) e m bPS
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#cPeerSharingCodec"><span class="hs-identifier hs-var">cPeerSharingCodec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; Codecs blk addrNTN e m bCS bCS bBF bBF bTX bKA bPS
</span><a href="#local-6989586621679183270"><span class="hs-identifier hs-var">mkCodecs</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183458"><span class="hs-identifier hs-var">version</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-771"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(bPS -&gt; Word) -&gt; ProtocolSizeLimits (PeerSharing addrNTN) bPS
forall {k} bytes (peerAddress :: k).
(bytes -&gt; Word)
-&gt; ProtocolSizeLimits (PeerSharing peerAddress) bytes
</span><span class="hs-identifier hs-var">byteLimitsPeerSharing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; bPS -&gt; Word
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-772"></span><span>        </span><span class="annot"><span class="annottext">ProtocolTimeLimits (PeerSharing addrNTN)
forall {k} (peerAddress :: k).
ProtocolTimeLimits (PeerSharing peerAddress)
</span><span class="hs-identifier hs-var">timeLimitsPeerSharing</span></span><span>
</span><span id="line-773"></span><span>        </span><span class="annot"><span class="annottext">Channel m bPS
</span><a href="#local-6989586621679183460"><span class="hs-identifier hs-var">channel</span></a></span><span>
</span><span id="line-774"></span><span>        </span><span class="annot"><span class="annottext">(Peer (PeerSharing addrNTN) 'AsServer 'StIdle m ()
 -&gt; m ((), Maybe bPS))
-&gt; Peer (PeerSharing addrNTN) 'AsServer 'StIdle m ()
-&gt; m ((), Maybe bPS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSharingServer addrNTN m
-&gt; Peer (PeerSharing addrNTN) 'AsServer 'StIdle m ()
forall (m :: * -&gt; *) peerAddress.
Monad m =&gt;
PeerSharingServer peerAddress m
-&gt; Peer (PeerSharing peerAddress) 'AsServer 'StIdle m ()
</span><span class="hs-identifier hs-var">peerSharingServerPeer</span></span><span>
</span><span id="line-775"></span><span>        </span><span class="annot"><span class="annottext">(PeerSharingServer addrNTN m
 -&gt; Peer (PeerSharing addrNTN) 'AsServer 'StIdle m ())
-&gt; PeerSharingServer addrNTN m
-&gt; Peer (PeerSharing addrNTN) 'AsServer 'StIdle m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
-&gt; ConnectionId addrNTN -&gt; PeerSharingServer addrNTN m
</span><a href="#local-6989586621679183290"><span class="hs-identifier hs-var">hPeerSharingServer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183458"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionId addrNTN
</span><a href="#local-6989586621679183459"><span class="hs-identifier hs-var">them</span></a></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Projections from 'Apps'
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span class="hs-comment">-- | A projection from 'NetworkApplication' to a client-side</span><span>
</span><span id="line-782"></span><span class="hs-comment">-- 'OuroborosApplication' for the node-to-node protocols.</span><span>
</span><span id="line-783"></span><span class="hs-comment">--</span><span>
</span><span id="line-784"></span><span class="hs-comment">-- Implementation note: network currently doesn't enable protocols conditional</span><span>
</span><span id="line-785"></span><span class="hs-comment">-- on the protocol version, but it eventually may; this is why @_version@ is</span><span>
</span><span id="line-786"></span><span class="hs-comment">-- currently unused.</span><span>
</span><span id="line-787"></span><span id="local-6989586621679182572"><span id="local-6989586621679182573"><span id="local-6989586621679182574"><span id="local-6989586621679182575"><span id="local-6989586621679182576"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#initiator"><span class="hs-identifier hs-type">initiator</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-788"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">MiniProtocolParameters</span></span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-790"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PSTypes.PeerSharing</span></span><span>
</span><span id="line-791"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-type">Apps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182572"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182573"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182575"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182576"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-792"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OuroborosBundleWithExpandedCtx</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">InitiatorMode</span></span><span> </span><span class="annot"><a href="#local-6989586621679182573"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182574"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182572"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182575"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span></span></span></span></span></span><span>
</span><span id="line-793"></span><span id="initiator"><span class="annot"><span class="annottext">initiator :: forall (m :: * -&gt; *) addr b a c.
MiniProtocolParameters
-&gt; NodeToNodeVersion
-&gt; PeerSharing
-&gt; Apps m addr b b b b b a c
-&gt; OuroborosBundleWithExpandedCtx 'InitiatorMode addr b m a Void
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#initiator"><span class="hs-identifier hs-var hs-var">initiator</span></a></span></span><span> </span><span id="local-6989586621679183463"><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679183463"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span></span><span> </span><span id="local-6989586621679183464"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183464"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679183465"><span class="annot"><span class="annottext">PeerSharing
</span><a href="#local-6989586621679183465"><span class="hs-identifier hs-var">ownPeerSharing</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-type">Apps</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679183466"><span id="local-6989586621679183467"><span id="local-6989586621679183468"><span id="local-6989586621679183469"><span id="local-6989586621679183470"><span id="local-6989586621679183471"><span id="local-6989586621679183472"><span id="local-6989586621679183473"><span id="local-6989586621679183474"><span id="local-6989586621679183475"><span class="annot"><span class="annottext">ClientApp m addr b a
ServerApp m addr b c
aChainSyncClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bCS a
aChainSyncServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bCS b
aBlockFetchClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bBF a
aBlockFetchServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bBF b
aTxSubmission2Client :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bTX a
aTxSubmission2Server :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bTX b
aKeepAliveClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bKA a
aKeepAliveServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bKA b
aPeerSharingClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bPS a
aPeerSharingServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bPS b
aChainSyncClient :: ClientApp m addr b a
aChainSyncServer :: ServerApp m addr b c
aBlockFetchClient :: ClientApp m addr b a
aBlockFetchServer :: ServerApp m addr b c
aTxSubmission2Client :: ClientApp m addr b a
aTxSubmission2Server :: ServerApp m addr b c
aKeepAliveClient :: ClientApp m addr b a
aKeepAliveServer :: ServerApp m addr b c
aPeerSharingClient :: ClientApp m addr b a
aPeerSharingServer :: ServerApp m addr b c
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aChainSyncClient"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-794"></span><span>    </span><span class="annot"><span class="annottext">MiniProtocolParameters
-&gt; NodeToNodeProtocols
     'InitiatorMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     Void
-&gt; NodeToNodeVersion
-&gt; PeerSharing
-&gt; OuroborosBundle
     'InitiatorMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     Void
forall (muxMode :: MuxMode) initiatorCtx responderCtx bytes
       (m :: * -&gt; *) a b.
MiniProtocolParameters
-&gt; NodeToNodeProtocols
     muxMode initiatorCtx responderCtx bytes m a b
-&gt; NodeToNodeVersion
-&gt; PeerSharing
-&gt; OuroborosBundle muxMode initiatorCtx responderCtx bytes m a b
</span><span class="hs-identifier hs-var">nodeToNodeProtocols</span></span><span>
</span><span id="line-795"></span><span>      </span><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679183463"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span><span>
</span><span id="line-796"></span><span>      </span><span class="hs-comment">-- TODO: currently consensus is using 'ConnectionId' for its 'peer' type.</span><span>
</span><span id="line-797"></span><span>      </span><span class="hs-comment">-- This is currently ok, as we might accept multiple connections from the</span><span>
</span><span id="line-798"></span><span>      </span><span class="hs-comment">-- same ip address, however this will change when we will switch to</span><span>
</span><span id="line-799"></span><span>      </span><span class="hs-comment">-- p2p-governor &amp; connection-manager.  Then consensus can use peer's ip</span><span>
</span><span id="line-800"></span><span>      </span><span class="hs-comment">-- address &amp; port number, rather than 'ConnectionId' (which is</span><span>
</span><span id="line-801"></span><span>      </span><span class="hs-comment">-- a quadruple uniquely determining a connection).</span><span>
</span><span id="line-802"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeProtocols</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-803"></span><span>          </span><span class="annot"><span class="annottext">chainSyncProtocol :: RunMiniProtocol
  'InitiatorMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  Void
</span><span class="hs-identifier hs-var">chainSyncProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-804"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; RunMiniProtocol
     'InitiatorMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     Void
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx.
MiniProtocolCb initiatorCtx bytes m a
-&gt; RunMiniProtocol
     'InitiatorMode initiatorCtx responderCtx bytes m a Void
</span><span class="hs-identifier hs-var">InitiatorProtocolOnly</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183481"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183481"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183466"><span class="hs-identifier hs-var">aChainSyncClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183464"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183481"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-805"></span><span>          </span><span class="annot"><span class="annottext">blockFetchProtocol :: RunMiniProtocol
  'InitiatorMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  Void
</span><span class="hs-identifier hs-var">blockFetchProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-806"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; RunMiniProtocol
     'InitiatorMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     Void
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx.
MiniProtocolCb initiatorCtx bytes m a
-&gt; RunMiniProtocol
     'InitiatorMode initiatorCtx responderCtx bytes m a Void
</span><span class="hs-identifier hs-var">InitiatorProtocolOnly</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183483"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183483"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183468"><span class="hs-identifier hs-var">aBlockFetchClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183464"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183483"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-807"></span><span>          </span><span class="annot"><span class="annottext">txSubmissionProtocol :: RunMiniProtocol
  'InitiatorMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  Void
</span><span class="hs-identifier hs-var">txSubmissionProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-808"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; RunMiniProtocol
     'InitiatorMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     Void
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx.
MiniProtocolCb initiatorCtx bytes m a
-&gt; RunMiniProtocol
     'InitiatorMode initiatorCtx responderCtx bytes m a Void
</span><span class="hs-identifier hs-var">InitiatorProtocolOnly</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183485"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183485"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183470"><span class="hs-identifier hs-var">aTxSubmission2Client</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183464"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183485"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-809"></span><span>          </span><span class="annot"><span class="annottext">keepAliveProtocol :: RunMiniProtocol
  'InitiatorMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  Void
</span><span class="hs-identifier hs-var">keepAliveProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-810"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; RunMiniProtocol
     'InitiatorMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     Void
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx.
MiniProtocolCb initiatorCtx bytes m a
-&gt; RunMiniProtocol
     'InitiatorMode initiatorCtx responderCtx bytes m a Void
</span><span class="hs-identifier hs-var">InitiatorProtocolOnly</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183487"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183487"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183472"><span class="hs-identifier hs-var">aKeepAliveClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183464"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183487"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-811"></span><span>          </span><span class="annot"><span class="annottext">peerSharingProtocol :: RunMiniProtocol
  'InitiatorMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  Void
</span><span class="hs-identifier hs-var">peerSharingProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-812"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; RunMiniProtocol
     'InitiatorMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     Void
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx.
MiniProtocolCb initiatorCtx bytes m a
-&gt; RunMiniProtocol
     'InitiatorMode initiatorCtx responderCtx bytes m a Void
</span><span class="hs-identifier hs-var">InitiatorProtocolOnly</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183489"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183489"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183474"><span class="hs-identifier hs-var">aPeerSharingClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183464"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183489"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-813"></span><span>        </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-814"></span><span>      </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183464"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-815"></span><span>      </span><span class="annot"><span class="annottext">PeerSharing
</span><a href="#local-6989586621679183465"><span class="hs-identifier hs-var">ownPeerSharing</span></a></span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span class="hs-comment">-- | A bi-directional network application.</span><span>
</span><span id="line-818"></span><span class="hs-comment">--</span><span>
</span><span id="line-819"></span><span class="hs-comment">-- Implementation note: network currently doesn't enable protocols conditional</span><span>
</span><span id="line-820"></span><span class="hs-comment">-- on the protocol version, but it eventually may; this is why @_version@ is</span><span>
</span><span id="line-821"></span><span class="hs-comment">-- currently unused.</span><span>
</span><span id="line-822"></span><span id="local-6989586621679182605"><span id="local-6989586621679182606"><span id="local-6989586621679182607"><span id="local-6989586621679182608"><span id="local-6989586621679182609"><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#initiatorAndResponder"><span class="hs-identifier hs-type">initiatorAndResponder</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-823"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">MiniProtocolParameters</span></span><span>
</span><span id="line-824"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-825"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PSTypes.PeerSharing</span></span><span>
</span><span id="line-826"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-type">Apps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182605"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182606"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182607"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182607"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182607"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182607"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182607"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182608"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182609"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OuroborosBundleWithExpandedCtx</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">InitiatorResponderMode</span></span><span> </span><span class="annot"><a href="#local-6989586621679182606"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182607"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182605"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182608"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679182609"><span class="hs-identifier hs-type">c</span></a></span></span></span></span></span></span><span>
</span><span id="line-828"></span><span id="initiatorAndResponder"><span class="annot"><span class="annottext">initiatorAndResponder :: forall (m :: * -&gt; *) addr b a c.
MiniProtocolParameters
-&gt; NodeToNodeVersion
-&gt; PeerSharing
-&gt; Apps m addr b b b b b a c
-&gt; OuroborosBundleWithExpandedCtx
     'InitiatorResponderMode addr b m a c
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#initiatorAndResponder"><span class="hs-identifier hs-var hs-var">initiatorAndResponder</span></a></span></span><span> </span><span id="local-6989586621679183490"><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679183490"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span></span><span> </span><span id="local-6989586621679183491"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679183492"><span class="annot"><span class="annottext">PeerSharing
</span><a href="#local-6989586621679183492"><span class="hs-identifier hs-var">ownPeerSharing</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Network.NodeToNode.html#Apps"><span class="hs-identifier hs-type">Apps</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679183493"><span id="local-6989586621679183494"><span id="local-6989586621679183495"><span id="local-6989586621679183496"><span id="local-6989586621679183497"><span id="local-6989586621679183498"><span id="local-6989586621679183499"><span id="local-6989586621679183500"><span id="local-6989586621679183501"><span id="local-6989586621679183502"><span class="annot"><span class="annottext">ClientApp m addr b a
ServerApp m addr b c
aChainSyncClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bCS a
aChainSyncServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bCS b
aBlockFetchClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bBF a
aBlockFetchServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bBF b
aTxSubmission2Client :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bTX a
aTxSubmission2Server :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bTX b
aKeepAliveClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bKA a
aKeepAliveServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bKA b
aPeerSharingClient :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ClientApp m addr bPS a
aPeerSharingServer :: forall (m :: * -&gt; *) addr bCS bBF bTX bKA bPS a b.
Apps m addr bCS bBF bTX bKA bPS a b -&gt; ServerApp m addr bPS b
aChainSyncClient :: ClientApp m addr b a
aChainSyncServer :: ServerApp m addr b c
aBlockFetchClient :: ClientApp m addr b a
aBlockFetchServer :: ServerApp m addr b c
aTxSubmission2Client :: ClientApp m addr b a
aTxSubmission2Server :: ServerApp m addr b c
aKeepAliveClient :: ClientApp m addr b a
aKeepAliveServer :: ServerApp m addr b c
aPeerSharingClient :: ClientApp m addr b a
aPeerSharingServer :: ServerApp m addr b c
</span><a href="Ouroboros.Consensus.Network.NodeToNode.html#aChainSyncClient"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-829"></span><span>    </span><span class="annot"><span class="annottext">MiniProtocolParameters
-&gt; NodeToNodeProtocols
     'InitiatorResponderMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     c
-&gt; NodeToNodeVersion
-&gt; PeerSharing
-&gt; OuroborosBundle
     'InitiatorResponderMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     c
forall (muxMode :: MuxMode) initiatorCtx responderCtx bytes
       (m :: * -&gt; *) a b.
MiniProtocolParameters
-&gt; NodeToNodeProtocols
     muxMode initiatorCtx responderCtx bytes m a b
-&gt; NodeToNodeVersion
-&gt; PeerSharing
-&gt; OuroborosBundle muxMode initiatorCtx responderCtx bytes m a b
</span><span class="hs-identifier hs-var">nodeToNodeProtocols</span></span><span>
</span><span id="line-830"></span><span>      </span><span class="annot"><span class="annottext">MiniProtocolParameters
</span><a href="#local-6989586621679183490"><span class="hs-identifier hs-var">miniProtocolParameters</span></a></span><span>
</span><span id="line-831"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeProtocols</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-832"></span><span>          </span><span class="annot"><span class="annottext">chainSyncProtocol :: RunMiniProtocol
  'InitiatorResponderMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  c
</span><span class="hs-identifier hs-var">chainSyncProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-833"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; MiniProtocolCb (ResponderContext addr) b m c
-&gt; RunMiniProtocol
     'InitiatorResponderMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     c
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx b.
MiniProtocolCb initiatorCtx bytes m a
-&gt; MiniProtocolCb responderCtx bytes m b
-&gt; RunMiniProtocol
     'InitiatorResponderMode initiatorCtx responderCtx bytes m a b
</span><span class="hs-identifier hs-var">InitiatorAndResponderProtocol</span></span><span>
</span><span id="line-834"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183504"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183504"><span class="hs-identifier hs-var">initiatorCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183493"><span class="hs-identifier hs-var">aChainSyncClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183504"><span class="hs-identifier hs-var">initiatorCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponderContext addr -&gt; Channel m b -&gt; m (c, Maybe b))
-&gt; MiniProtocolCb (ResponderContext addr) b m c
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183505"><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183505"><span class="hs-identifier hs-var">responderCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerApp m addr b c
</span><a href="#local-6989586621679183494"><span class="hs-identifier hs-var">aChainSyncServer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183505"><span class="hs-identifier hs-var">responderCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-836"></span><span>          </span><span class="annot"><span class="annottext">blockFetchProtocol :: RunMiniProtocol
  'InitiatorResponderMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  c
</span><span class="hs-identifier hs-var">blockFetchProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-837"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; MiniProtocolCb (ResponderContext addr) b m c
-&gt; RunMiniProtocol
     'InitiatorResponderMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     c
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx b.
MiniProtocolCb initiatorCtx bytes m a
-&gt; MiniProtocolCb responderCtx bytes m b
-&gt; RunMiniProtocol
     'InitiatorResponderMode initiatorCtx responderCtx bytes m a b
</span><span class="hs-identifier hs-var">InitiatorAndResponderProtocol</span></span><span>
</span><span id="line-838"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183506"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183506"><span class="hs-identifier hs-var">initiatorCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183495"><span class="hs-identifier hs-var">aBlockFetchClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183506"><span class="hs-identifier hs-var">initiatorCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-839"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponderContext addr -&gt; Channel m b -&gt; m (c, Maybe b))
-&gt; MiniProtocolCb (ResponderContext addr) b m c
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183507"><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183507"><span class="hs-identifier hs-var">responderCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerApp m addr b c
</span><a href="#local-6989586621679183496"><span class="hs-identifier hs-var">aBlockFetchServer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183507"><span class="hs-identifier hs-var">responderCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-840"></span><span>          </span><span class="annot"><span class="annottext">txSubmissionProtocol :: RunMiniProtocol
  'InitiatorResponderMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  c
</span><span class="hs-identifier hs-var">txSubmissionProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-841"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; MiniProtocolCb (ResponderContext addr) b m c
-&gt; RunMiniProtocol
     'InitiatorResponderMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     c
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx b.
MiniProtocolCb initiatorCtx bytes m a
-&gt; MiniProtocolCb responderCtx bytes m b
-&gt; RunMiniProtocol
     'InitiatorResponderMode initiatorCtx responderCtx bytes m a b
</span><span class="hs-identifier hs-var">InitiatorAndResponderProtocol</span></span><span>
</span><span id="line-842"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183508"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183508"><span class="hs-identifier hs-var">initiatorCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183497"><span class="hs-identifier hs-var">aTxSubmission2Client</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183508"><span class="hs-identifier hs-var">initiatorCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponderContext addr -&gt; Channel m b -&gt; m (c, Maybe b))
-&gt; MiniProtocolCb (ResponderContext addr) b m c
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183509"><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183509"><span class="hs-identifier hs-var">responderCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerApp m addr b c
</span><a href="#local-6989586621679183498"><span class="hs-identifier hs-var">aTxSubmission2Server</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183509"><span class="hs-identifier hs-var">responderCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-844"></span><span>          </span><span class="annot"><span class="annottext">keepAliveProtocol :: RunMiniProtocol
  'InitiatorResponderMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  c
</span><span class="hs-identifier hs-var">keepAliveProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-845"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; MiniProtocolCb (ResponderContext addr) b m c
-&gt; RunMiniProtocol
     'InitiatorResponderMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     c
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx b.
MiniProtocolCb initiatorCtx bytes m a
-&gt; MiniProtocolCb responderCtx bytes m b
-&gt; RunMiniProtocol
     'InitiatorResponderMode initiatorCtx responderCtx bytes m a b
</span><span class="hs-identifier hs-var">InitiatorAndResponderProtocol</span></span><span>
</span><span id="line-846"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183510"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183510"><span class="hs-identifier hs-var">initiatorCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183499"><span class="hs-identifier hs-var">aKeepAliveClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183510"><span class="hs-identifier hs-var">initiatorCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponderContext addr -&gt; Channel m b -&gt; m (c, Maybe b))
-&gt; MiniProtocolCb (ResponderContext addr) b m c
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183511"><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183511"><span class="hs-identifier hs-var">responderCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerApp m addr b c
</span><a href="#local-6989586621679183500"><span class="hs-identifier hs-var">aKeepAliveServer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183511"><span class="hs-identifier hs-var">responderCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-848"></span><span>
</span><span id="line-849"></span><span>          </span><span class="annot"><span class="annottext">peerSharingProtocol :: RunMiniProtocol
  'InitiatorResponderMode
  (ExpandedInitiatorContext addr m)
  (ResponderContext addr)
  b
  m
  a
  c
</span><span class="hs-identifier hs-var">peerSharingProtocol</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-850"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
-&gt; MiniProtocolCb (ResponderContext addr) b m c
-&gt; RunMiniProtocol
     'InitiatorResponderMode
     (ExpandedInitiatorContext addr m)
     (ResponderContext addr)
     b
     m
     a
     c
forall initiatorCtx bytes (m :: * -&gt; *) a responderCtx b.
MiniProtocolCb initiatorCtx bytes m a
-&gt; MiniProtocolCb responderCtx bytes m b
-&gt; RunMiniProtocol
     'InitiatorResponderMode initiatorCtx responderCtx bytes m a b
</span><span class="hs-identifier hs-var">InitiatorAndResponderProtocol</span></span><span>
</span><span id="line-851"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpandedInitiatorContext addr m -&gt; Channel m b -&gt; m (a, Maybe b))
-&gt; MiniProtocolCb (ExpandedInitiatorContext addr m) b m a
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183512"><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183512"><span class="hs-identifier hs-var">initiatorCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ClientApp m addr b a
</span><a href="#local-6989586621679183501"><span class="hs-identifier hs-var">aPeerSharingClient</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ExpandedInitiatorContext addr m
</span><a href="#local-6989586621679183512"><span class="hs-identifier hs-var">initiatorCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-852"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponderContext addr -&gt; Channel m b -&gt; m (c, Maybe b))
-&gt; MiniProtocolCb (ResponderContext addr) b m c
forall ctx (m :: * -&gt; *) bytes a.
(ctx -&gt; Channel m bytes -&gt; m (a, Maybe bytes))
-&gt; MiniProtocolCb ctx bytes m a
</span><span class="hs-identifier hs-var">MiniProtocolCb</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679183513"><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183513"><span class="hs-identifier hs-var">responderCtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerApp m addr b c
</span><a href="#local-6989586621679183502"><span class="hs-identifier hs-var">aPeerSharingServer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">ResponderContext addr
</span><a href="#local-6989586621679183513"><span class="hs-identifier hs-var">responderCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-853"></span><span>        </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-854"></span><span>      </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679183491"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-855"></span><span>      </span><span class="annot"><span class="annottext">PeerSharing
</span><a href="#local-6989586621679183492"><span class="hs-identifier hs-var">ownPeerSharing</span></a></span><span>
</span><span id="line-856"></span></pre></body></html>
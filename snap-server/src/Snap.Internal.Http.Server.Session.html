<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable  #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings   #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Snap.Internal.Http.Server.Session</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#httpAcceptLoop"><span class="hs-identifier">httpAcceptLoop</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#httpSession"><span class="hs-identifier">httpSession</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#snapToServerHandler"><span class="hs-identifier">snapToServerHandler</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#BadRequestException"><span class="hs-identifier">BadRequestException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#LengthRequiredException"><span class="hs-identifier">LengthRequiredException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#TerminateSessionException"><span class="hs-identifier">TerminateSessionException</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span class="hs-cpp">
#if !MIN_VERSION_base(4,8,0)
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>                      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">&lt;$&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Arrow.html"><span class="hs-identifier">Control.Arrow</span></a></span><span>                            </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Arrow.html#first"><span class="hs-identifier">first</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Arrow.html#second"><span class="hs-identifier">second</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Concurrent.html"><span class="hs-identifier">Control.Concurrent</span></a></span><span>                       </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#MVar"><span class="hs-identifier">MVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier">newEmptyMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#putMVar"><span class="hs-identifier">putMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#readMVar"><span class="hs-identifier">readMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span>                        </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#AsyncException"><span class="hs-identifier">AsyncException</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier">Exception</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html#Handler"><span class="hs-identifier">Handler</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier">SomeException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>                            </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#join"><span class="hs-identifier">join</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier">void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#%3E%3D%3E"><span class="hs-operator">(&gt;=&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html"><span class="hs-identifier">Data.ByteString.Char8</span></a></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html"><span class="hs-identifier">Data.ByteString.Char8</span></a></span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Unsafe.html"><span class="hs-identifier">Data.ByteString.Unsafe</span></a></span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.CaseInsensitive</span></span><span>                     </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CI</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Int.html"><span class="hs-identifier">Data.Int</span></a></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Int.html#Int64"><span class="hs-identifier">Int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>                               </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier">IORef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier">newIORef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier">readIORef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#writeIORef"><span class="hs-identifier">writeIORef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>                                </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#foldl%27"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span>                                 </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>                               </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromJust"><span class="hs-identifier">fromJust</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier">isNothing</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#if !MIN_VERSION_base(4,8,0)
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Monoid</span><span>                              </span><span class="hs-special">(</span><span class="hs-identifier">mconcat</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Monoid.html"><span class="hs-identifier">Data.Monoid</span></a></span><span>                              </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator">(&lt;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Format.html"><span class="hs-identifier">Data.Time.Format</span></a></span><span>                         </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Format.Format.Class.html#formatTime"><span class="hs-identifier">formatTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html"><span class="hs-identifier">Data.Typeable</span></a></span><span>                            </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Version.html"><span class="hs-identifier">Data.Version</span></a></span><span>                             </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Version.html#showVersion"><span class="hs-identifier">showVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span>                                </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier">Word8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Marshal.Utils.html"><span class="hs-identifier">Foreign.Marshal.Utils</span></a></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier">copyBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Ptr.html"><span class="hs-identifier">Foreign.Ptr</span></a></span><span>                              </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier">Ptr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#castPtr"><span class="hs-identifier">castPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier">plusPtr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Storable.html"><span class="hs-identifier">Foreign.Storable</span></a></span><span>                         </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier">pokeByteOff</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#if MIN_VERSION_time(1,5,0)
</span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Format.html"><span class="hs-identifier">Data.Time.Format</span></a></span><span>                         </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Format.Locale.html#defaultTimeLocale"><span class="hs-identifier">defaultTimeLocale</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.Locale</span><span>                            </span><span class="hs-special">(</span><span class="hs-identifier">defaultTimeLocale</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.html"><span class="hs-identifier">Data.ByteString.Builder</span></a></span><span>                  </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Builder"><span class="hs-identifier">Builder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier">byteString</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.html#char8"><span class="hs-identifier">char8</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.html#stringUtf8"><span class="hs-identifier">stringUtf8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Extra.html"><span class="hs-identifier">Data.ByteString.Builder.Extra</span></a></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#flush"><span class="hs-identifier">flush</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html"><span class="hs-identifier">Data.ByteString.Builder.Internal</span></a></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Buffer"><span class="hs-identifier">Buffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#defaultChunkSize"><span class="hs-identifier">defaultChunkSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#newBuffer"><span class="hs-identifier">newBuffer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.html"><span class="hs-identifier">Data.ByteString.Builder.Prim</span></a></span><span>             </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier">FixedPrim</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.html#primFixed"><span class="hs-identifier">primFixed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#%3E%24%3C"><span class="hs-operator">(&gt;$&lt;)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#%3E%2A%3C"><span class="hs-operator">(&gt;*&lt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html"><span class="hs-identifier">Data.ByteString.Builder.Prim.Internal</span></a></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#fixedPrim"><span class="hs-identifier">fixedPrim</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#size"><span class="hs-identifier">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.IO.Streams</span></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">InputStream</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">OutputStream</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Streams</span></span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Streams</span></span><span>
</span><span id="line-59"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Paths_snap_server.html"><span class="hs-identifier">Paths_snap_server</span></a></span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Snap.Core</span></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">EscapeSnap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Snap.Core</span></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Snap</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runSnap</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Snap.Internal.Core</span></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fixupResponse</span></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Snap.Internal.Http.Server.Clock.html"><span class="hs-identifier">Snap.Internal.Http.Server.Clock</span></a></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.Clock.html#getClockTime"><span class="hs-identifier">getClockTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Snap.Internal.Http.Server.Common.html"><span class="hs-identifier">Snap.Internal.Http.Server.Common</span></a></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.Common.html#eatException"><span class="hs-identifier">eatException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Snap.Internal.Http.Server.Date.html"><span class="hs-identifier">Snap.Internal.Http.Server.Date</span></a></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.Date.html#getDateString"><span class="hs-identifier">getDateString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html"><span class="hs-identifier">Snap.Internal.Http.Server.Parser</span></a></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#IRequest"><span class="hs-identifier">IRequest</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#getStdConnection"><span class="hs-identifier">getStdConnection</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#getStdContentLength"><span class="hs-identifier">getStdContentLength</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#getStdContentType"><span class="hs-identifier">getStdContentType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#getStdCookie"><span class="hs-identifier">getStdCookie</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#getStdHost"><span class="hs-identifier">getStdHost</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#getStdTransferEncoding"><span class="hs-identifier">getStdTransferEncoding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">parseCookie</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#parseRequest"><span class="hs-identifier">parseRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">parseUrlEncoded</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#readChunkedTransferEncoding"><span class="hs-identifier">readChunkedTransferEncoding</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#writeChunkedTransferEncoding"><span class="hs-identifier">writeChunkedTransferEncoding</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Snap.Internal.Http.Server.Thread.html"><span class="hs-identifier">Snap.Internal.Http.Server.Thread</span></a></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.Thread.html#SnapThread"><span class="hs-identifier">SnapThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Thread.html"><span class="hs-identifier">Snap.Internal.Http.Server.Thread</span></a></span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Thread</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Snap.Internal.Http.Server.TimeoutManager.html"><span class="hs-identifier">Snap.Internal.Http.Server.TimeoutManager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.TimeoutManager.html#TimeoutManager"><span class="hs-identifier">TimeoutManager</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.TimeoutManager.html"><span class="hs-identifier">Snap.Internal.Http.Server.TimeoutManager</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TM</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html"><span class="hs-identifier">Snap.Internal.Http.Server.Types</span></a></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#AcceptFunc"><span class="hs-identifier">AcceptFunc</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#PerSessionData"><span class="hs-identifier">PerSessionData</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#SendFileHandler"><span class="hs-identifier">SendFileHandler</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#ServerConfig"><span class="hs-identifier">ServerConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#ServerHandler"><span class="hs-identifier">ServerHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Snap.Internal.Http.Types</span></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Cookie</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">HttpVersion</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Method</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Request</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Response</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ResponseBody</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">StreamProc</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">getHeader</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">headers</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rspBodyToEnum</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">updateHeaders</span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Snap.Internal.Parsing</span></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeFromNat</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Snap.Types.Headers</span></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Headers</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Snap.Types.Headers</span></span><span>                       </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/System.IO.Unsafe.html"><span class="hs-identifier">System.IO.Unsafe</span></a></span><span>                         </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier">unsafePerformIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-81"></span><span class="hs-keyword">data</span><span> </span><span id="TerminateSessionException"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#TerminateSessionException"><span class="hs-identifier hs-var">TerminateSessionException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TerminateSessionException"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#TerminateSessionException"><span class="hs-identifier hs-var">TerminateSessionException</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099082"><span id="local-6989586621679099088"><span id="local-6989586621679099092"><span class="annot"><span class="annottext">Int -&gt; TerminateSessionException -&gt; ShowS
[TerminateSessionException] -&gt; ShowS
TerminateSessionException -&gt; String
(Int -&gt; TerminateSessionException -&gt; ShowS)
-&gt; (TerminateSessionException -&gt; String)
-&gt; ([TerminateSessionException] -&gt; ShowS)
-&gt; Show TerminateSessionException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; TerminateSessionException -&gt; ShowS
showsPrec :: Int -&gt; TerminateSessionException -&gt; ShowS
$cshow :: TerminateSessionException -&gt; String
show :: TerminateSessionException -&gt; String
$cshowList :: [TerminateSessionException] -&gt; ShowS
showList :: [TerminateSessionException] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679099100"><span id="local-6989586621679099104"><span id="local-6989586621679099107"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#TerminateSessionException"><span class="hs-identifier hs-type">TerminateSessionException</span></a></span></span></span></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-keyword">data</span><span> </span><span id="BadRequestException"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#BadRequestException"><span class="hs-identifier hs-var">BadRequestException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BadRequestException"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#BadRequestException"><span class="hs-identifier hs-var">BadRequestException</span></a></span></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099112"><span id="local-6989586621679099114"><span id="local-6989586621679099118"><span class="annot"><span class="annottext">Int -&gt; BadRequestException -&gt; ShowS
[BadRequestException] -&gt; ShowS
BadRequestException -&gt; String
(Int -&gt; BadRequestException -&gt; ShowS)
-&gt; (BadRequestException -&gt; String)
-&gt; ([BadRequestException] -&gt; ShowS)
-&gt; Show BadRequestException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; BadRequestException -&gt; ShowS
showsPrec :: Int -&gt; BadRequestException -&gt; ShowS
$cshow :: BadRequestException -&gt; String
show :: BadRequestException -&gt; String
$cshowList :: [BadRequestException] -&gt; ShowS
showList :: [BadRequestException] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679099125"><span id="local-6989586621679099129"><span id="local-6989586621679099132"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#BadRequestException"><span class="hs-identifier hs-type">BadRequestException</span></a></span></span></span></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-keyword">data</span><span> </span><span id="LengthRequiredException"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#LengthRequiredException"><span class="hs-identifier hs-var">LengthRequiredException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LengthRequiredException"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#LengthRequiredException"><span class="hs-identifier hs-var">LengthRequiredException</span></a></span></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099136"><span id="local-6989586621679099138"><span id="local-6989586621679099142"><span class="annot"><span class="annottext">Int -&gt; LengthRequiredException -&gt; ShowS
[LengthRequiredException] -&gt; ShowS
LengthRequiredException -&gt; String
(Int -&gt; LengthRequiredException -&gt; ShowS)
-&gt; (LengthRequiredException -&gt; String)
-&gt; ([LengthRequiredException] -&gt; ShowS)
-&gt; Show LengthRequiredException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; LengthRequiredException -&gt; ShowS
showsPrec :: Int -&gt; LengthRequiredException -&gt; ShowS
$cshow :: LengthRequiredException -&gt; String
show :: LengthRequiredException -&gt; String
$cshowList :: [LengthRequiredException] -&gt; ShowS
showList :: [LengthRequiredException] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679099149"><span id="local-6989586621679099153"><span id="local-6989586621679099156"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#LengthRequiredException"><span class="hs-identifier hs-type">LengthRequiredException</span></a></span></span></span></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-95"></span><span id="local-6989586621679098743"><span id="local-6989586621679098745"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#snapToServerHandler"><span class="hs-identifier hs-type">snapToServerHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Snap</span></span><span> </span><span class="annot"><a href="#local-6989586621679098743"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098745"><span class="hs-identifier hs-type">hookState</span></a></span></span></span><span>
</span><span id="line-96"></span><span id="snapToServerHandler"><span class="annot"><span class="annottext">snapToServerHandler :: forall a hookState. Snap a -&gt; ServerHandler hookState
</span><a href="Snap.Internal.Http.Server.Session.html#snapToServerHandler"><span class="hs-identifier hs-var hs-var">snapToServerHandler</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099158"><span class="annot"><span class="annottext">Snap a
</span><a href="#local-6989586621679099158"><span class="hs-identifier hs-var">snap</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099159"><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099159"><span class="hs-identifier hs-var">serverConfig</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099160"><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099160"><span class="hs-identifier hs-var">perSessionData</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099161"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099161"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="annottext">Snap a
-&gt; (ByteString -&gt; IO ())
-&gt; ((Int -&gt; Int) -&gt; IO ())
-&gt; Request
-&gt; IO (Request, Response)
forall a.
Snap a
-&gt; (ByteString -&gt; IO ())
-&gt; ((Int -&gt; Int) -&gt; IO ())
-&gt; Request
-&gt; IO (Request, Response)
</span><span class="hs-identifier hs-var">runSnap</span></span><span> </span><span class="annot"><span class="annottext">Snap a
</span><a href="#local-6989586621679099158"><span class="hs-identifier hs-var">snap</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ()
</span><a href="#local-6989586621679099162"><span class="hs-identifier hs-var">logErr</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099163"><span class="hs-identifier hs-var">tickle</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099161"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-99"></span><span>    </span><span id="local-6989586621679099162"><span class="annot"><span class="annottext">logErr :: ByteString -&gt; IO ()
</span><a href="#local-6989586621679099162"><span class="hs-identifier hs-var hs-var">logErr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Builder -&gt; IO ()
forall hookState. ServerConfig hookState -&gt; Builder -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Types.html#_logError"><span class="hs-identifier hs-var">_logError</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099159"><span class="hs-identifier hs-var">serverConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; IO ())
-&gt; (ByteString -&gt; Builder) -&gt; ByteString -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span id="local-6989586621679099163"><span class="annot"><span class="annottext">tickle :: (Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099163"><span class="hs-identifier hs-var hs-var">tickle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; (Int -&gt; Int) -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Types.html#_twiddleTimeout"><span class="hs-identifier hs-var">_twiddleTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099160"><span class="hs-identifier hs-var">perSessionData</span></a></span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-104"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#mAX_HEADERS_SIZE"><span class="hs-identifier hs-type">mAX_HEADERS_SIZE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Int.html#Int64"><span class="hs-identifier hs-type">Int64</span></a></span><span>
</span><span id="line-105"></span><span id="mAX_HEADERS_SIZE"><span class="annot"><span class="annottext">mAX_HEADERS_SIZE :: Int64
</span><a href="Snap.Internal.Http.Server.Session.html#mAX_HEADERS_SIZE"><span class="hs-identifier hs-var hs-var">mAX_HEADERS_SIZE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">256</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- | For each cpu, we store:</span><span>
</span><span id="line-110"></span><span class="hs-comment">--    * An accept thread</span><span>
</span><span id="line-111"></span><span class="hs-comment">--    * A TimeoutManager</span><span>
</span><span id="line-112"></span><span class="hs-comment">--    * An mvar to signal when the timeout thread is shutdown</span><span>
</span><span id="line-113"></span><span class="hs-keyword">data</span><span> </span><span id="EventLoopCpu"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#EventLoopCpu"><span class="hs-identifier hs-var">EventLoopCpu</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EventLoopCpu"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#EventLoopCpu"><span class="hs-identifier hs-var">EventLoopCpu</span></a></span></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="_acceptThread"><span class="annot"><span class="annottext">EventLoopCpu -&gt; SnapThread
</span><a href="Snap.Internal.Http.Server.Session.html#_acceptThread"><span class="hs-identifier hs-var hs-var">_acceptThread</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Thread.html#SnapThread"><span class="hs-identifier hs-type">SnapThread</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="_timeoutManager"><span class="annot"><span class="annottext">EventLoopCpu -&gt; TimeoutManager
</span><a href="Snap.Internal.Http.Server.Session.html#_timeoutManager"><span class="hs-identifier hs-var hs-var">_timeoutManager</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.TimeoutManager.html#TimeoutManager"><span class="hs-identifier hs-type">TimeoutManager</span></a></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | The main Snap webserver loop. Given a server handler, configuration, and a</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- function to accept new connections, runs an HTTP loop forever over N</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- threads, until a ThreadKilled exception is received.</span><span>
</span><span id="line-123"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#httpAcceptLoop"><span class="hs-identifier hs-type">httpAcceptLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679098761"><span class="annot"><a href="#local-6989586621679098761"><span class="hs-identifier hs-type">hookState</span></a></span></span><span> </span><span class="hs-operator">.</span><span>
</span><span id="line-124"></span><span>                  </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098761"><span class="hs-identifier hs-type">hookState</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ server handler</span></span><span>
</span><span id="line-125"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098761"><span class="hs-identifier hs-type">hookState</span></a></span><span>   </span><span class="annot"><span class="hs-comment">-- ^ server config</span></span><span>
</span><span id="line-126"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#AcceptFunc"><span class="hs-identifier hs-type">AcceptFunc</span></a></span><span>               </span><span class="annot"><span class="hs-comment">-- ^ accept function</span></span><span>
</span><span id="line-127"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span id="httpAcceptLoop"><span class="annot"><span class="annottext">httpAcceptLoop :: forall hookState.
ServerHandler hookState
-&gt; ServerConfig hookState -&gt; AcceptFunc -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Session.html#httpAcceptLoop"><span class="hs-identifier hs-var hs-var">httpAcceptLoop</span></a></span></span><span> </span><span id="local-6989586621679099174"><span class="annot"><span class="annottext">ServerHandler hookState
</span><a href="#local-6989586621679099174"><span class="hs-identifier hs-var">serverHandler</span></a></span></span><span> </span><span id="local-6989586621679099175"><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099175"><span class="hs-identifier hs-var">serverConfig</span></a></span></span><span> </span><span id="local-6989586621679099176"><span class="annot"><span class="annottext">AcceptFunc
</span><a href="#local-6989586621679099176"><span class="hs-identifier hs-var">acceptFunc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099177"><span class="hs-identifier hs-var">runLoops</span></a></span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621679099178"><span class="annot"><span class="annottext">logError :: Builder -&gt; IO ()
</span><a href="#local-6989586621679099178"><span class="hs-identifier hs-var hs-var">logError</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Builder -&gt; IO ()
forall hookState. ServerConfig hookState -&gt; Builder -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Types.html#_logError"><span class="hs-identifier hs-var">_logError</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099175"><span class="hs-identifier hs-var">serverConfig</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621679099179"><span class="annot"><span class="annottext">nLoops :: Int
</span><a href="#local-6989586621679099179"><span class="hs-identifier hs-var hs-var">nLoops</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Int
forall hookState. ServerConfig hookState -&gt; Int
</span><a href="Snap.Internal.Http.Server.Types.html#_numAcceptLoops"><span class="hs-identifier hs-var">_numAcceptLoops</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099175"><span class="hs-identifier hs-var">serverConfig</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span id="local-6989586621679099181"><span class="annot"><span class="annottext">defaultTimeout :: Int
</span><a href="#local-6989586621679099181"><span class="hs-identifier hs-var hs-var">defaultTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Int
forall hookState. ServerConfig hookState -&gt; Int
</span><a href="Snap.Internal.Http.Server.Types.html#_defaultTimeout"><span class="hs-identifier hs-var">_defaultTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099175"><span class="hs-identifier hs-var">serverConfig</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-136"></span><span>    </span><span id="local-6989586621679098765"><span class="annot"><a href="#local-6989586621679099183"><span class="hs-identifier hs-type">logException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098765"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679098765"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-137"></span><span>    </span><span id="local-6989586621679099183"><span class="annot"><span class="annottext">logException :: forall e. Exception e =&gt; e -&gt; IO ()
</span><a href="#local-6989586621679099183"><span class="hs-identifier hs-var hs-var">logException</span></a></span></span><span> </span><span id="local-6989586621679099190"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679099190"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="annottext">Builder -&gt; IO ()
</span><a href="#local-6989586621679099178"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; IO ()) -&gt; Builder -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">[Builder] -&gt; Builder
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;got exception in httpAcceptFunc: &quot;</span></span><span>
</span><span id="line-140"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">e -&gt; Builder
forall a. Show a =&gt; a -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-var">fromShow</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679099190"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-141"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621679099177"><span class="annot"><span class="annottext">runLoops :: IO ()
</span><a href="#local-6989586621679099177"><span class="hs-identifier hs-var hs-var">runLoops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO [EventLoopCpu]
-&gt; ([EventLoopCpu] -&gt; IO ()) -&gt; ([EventLoopCpu] -&gt; IO ()) -&gt; IO ()
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.Base.html#bracket"><span class="hs-identifier hs-var">E.bracket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; IO EventLoopCpu) -&gt; [Int] -&gt; IO [EventLoopCpu]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO EventLoopCpu
</span><a href="#local-6989586621679099206"><span class="hs-identifier hs-var">newLoop</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099179"><span class="hs-identifier hs-var">nLoops</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EventLoopCpu -&gt; IO ()) -&gt; [EventLoopCpu] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">EventLoopCpu -&gt; IO ()
</span><a href="#local-6989586621679099208"><span class="hs-identifier hs-var">killLoop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EventLoopCpu -&gt; IO ()) -&gt; [EventLoopCpu] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">EventLoopCpu -&gt; IO ()
</span><a href="#local-6989586621679099209"><span class="hs-identifier hs-var">waitLoop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><a href="#local-6989586621679099210"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.TimeoutManager.html#TimeoutManager"><span class="hs-identifier hs-type">TimeoutManager</span></a></span><span>
</span><span id="line-150"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679098783"><span class="annot"><a href="#local-6989586621679098783"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098783"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098783"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621679099210"><span class="annot"><span class="annottext">loop :: TimeoutManager -&gt; (forall a. IO a -&gt; IO a) -&gt; IO ()
</span><a href="#local-6989586621679099210"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679099211"><span class="annot"><span class="annottext">TimeoutManager
</span><a href="#local-6989586621679099211"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span id="local-6989586621679099212"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679099212"><span class="hs-identifier hs-var">loopRestore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO
  (SendFileHandler, ByteString, Int, ByteString, Int,
   InputStream ByteString, OutputStream ByteString, IO ())
-&gt; IO ()
forall a. IO a -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Common.html#eatException"><span class="hs-identifier hs-var">eatException</span></a></span><span> </span><span class="annot"><span class="annottext">IO
  (SendFileHandler, ByteString, Int, ByteString, Int,
   InputStream ByteString, OutputStream ByteString, IO ())
</span><a href="#local-6989586621679099213"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-155"></span><span>        </span><span id="local-6989586621679099225"><span class="annot"><span class="annottext">handlers :: [Handler
   (SendFileHandler, ByteString, Int, ByteString, Int,
    InputStream ByteString, OutputStream ByteString, IO ())]
</span><a href="#local-6989586621679099225"><span class="hs-identifier hs-var hs-var">handlers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">(AsyncException
 -&gt; IO
      (SendFileHandler, ByteString, Int, ByteString, Int,
       InputStream ByteString, OutputStream ByteString, IO ()))
-&gt; Handler
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a e. Exception e =&gt; (e -&gt; IO a) -&gt; Handler a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html#Handler"><span class="hs-identifier hs-var">Handler</span></a></span><span> </span><span class="annot"><span class="annottext">((AsyncException
  -&gt; IO
       (SendFileHandler, ByteString, Int, ByteString, Int,
        InputStream ByteString, OutputStream ByteString, IO ()))
 -&gt; Handler
      (SendFileHandler, ByteString, Int, ByteString, Int,
       InputStream ByteString, OutputStream ByteString, IO ()))
-&gt; (AsyncException
    -&gt; IO
         (SendFileHandler, ByteString, Int, ByteString, Int,
          InputStream ByteString, OutputStream ByteString, IO ()))
-&gt; Handler
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679099227"><span class="annot"><span class="annottext">AsyncException
</span><a href="#local-6989586621679099227"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#AsyncException"><span class="hs-identifier hs-type">AsyncException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO
  (SendFileHandler, ByteString, Int, ByteString, Int,
   InputStream ByteString, OutputStream ByteString, IO ())
-&gt; IO
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679099212"><span class="hs-identifier hs-var">loopRestore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AsyncException
-&gt; IO
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.html#throwIO"><span class="hs-identifier hs-var">E.throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">(AsyncException
 -&gt; IO
      (SendFileHandler, ByteString, Int, ByteString, Int,
       InputStream ByteString, OutputStream ByteString, IO ()))
-&gt; AsyncException
-&gt; IO
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncException
</span><a href="#local-6989586621679099227"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SomeException
 -&gt; IO
      (SendFileHandler, ByteString, Int, ByteString, Int,
       InputStream ByteString, OutputStream ByteString, IO ()))
-&gt; Handler
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a e. Exception e =&gt; (e -&gt; IO a) -&gt; Handler a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html#Handler"><span class="hs-identifier hs-var">Handler</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeException
  -&gt; IO
       (SendFileHandler, ByteString, Int, ByteString, Int,
        InputStream ByteString, OutputStream ByteString, IO ()))
 -&gt; Handler
      (SendFileHandler, ByteString, Int, ByteString, Int,
       InputStream ByteString, OutputStream ByteString, IO ()))
-&gt; (SomeException
    -&gt; IO
         (SendFileHandler, ByteString, Int, ByteString, Int,
          InputStream ByteString, OutputStream ByteString, IO ()))
-&gt; Handler
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679099230"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099230"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO ()
forall e. Exception e =&gt; e -&gt; IO ()
</span><a href="#local-6989586621679099183"><span class="hs-identifier hs-var">logException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099230"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
-&gt; IO
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
-&gt; IO
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO
  (SendFileHandler, ByteString, Int, ByteString, Int,
   InputStream ByteString, OutputStream ByteString, IO ())
</span><a href="#local-6989586621679099213"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-158"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>        </span><span id="local-6989586621679099213"><span class="annot"><span class="annottext">go :: IO
  (SendFileHandler, ByteString, Int, ByteString, Int,
   InputStream ByteString, OutputStream ByteString, IO ())
</span><a href="#local-6989586621679099213"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679099231"><span class="annot"><span class="annottext">SendFileHandler
</span><a href="#local-6989586621679099231"><span class="hs-identifier hs-var">sendFileHandler</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099232"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099232"><span class="hs-identifier hs-var">localAddress</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099233"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099233"><span class="hs-identifier hs-var">localPort</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099234"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099234"><span class="hs-identifier hs-var">remoteAddress</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>             </span><span id="local-6989586621679099235"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099235"><span class="hs-identifier hs-var">remotePort</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099236"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099236"><span class="hs-identifier hs-var">readEnd</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099237"><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099237"><span class="hs-identifier hs-var">writeEnd</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>             </span><span id="local-6989586621679099238"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099238"><span class="hs-identifier hs-var">cleanup</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AcceptFunc
-&gt; (forall a. IO a -&gt; IO a)
-&gt; IO
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
</span><a href="Snap.Internal.Http.Server.Types.html#runAcceptFunc"><span class="hs-identifier hs-var">runAcceptFunc</span></a></span><span> </span><span class="annot"><span class="annottext">AcceptFunc
</span><a href="#local-6989586621679099176"><span class="hs-identifier hs-var">acceptFunc</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679099212"><span class="hs-identifier hs-var">loopRestore</span></a></span><span>
</span><span id="line-164"></span><span>                                       </span><span class="annot"><span class="annottext">IO
  (SendFileHandler, ByteString, Int, ByteString, Int,
   InputStream ByteString, OutputStream ByteString, IO ())
-&gt; [Handler
      (SendFileHandler, ByteString, Int, ByteString, Int,
       InputStream ByteString, OutputStream ByteString, IO ())]
-&gt; IO
     (SendFileHandler, ByteString, Int, ByteString, Int,
      InputStream ByteString, OutputStream ByteString, IO ())
forall a. IO a -&gt; [Handler a] -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html#catches"><span class="hs-operator hs-var">`E.catches`</span></a></span><span> </span><span class="annot"><span class="annottext">[Handler
   (SendFileHandler, ByteString, Int, ByteString, Int,
    InputStream ByteString, OutputStream ByteString, IO ())]
</span><a href="#local-6989586621679099225"><span class="hs-identifier hs-var">handlers</span></a></span><span>
</span><span id="line-165"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099244"><span class="annot"><span class="annottext">threadLabel :: ByteString
</span><a href="#local-6989586621679099244"><span class="hs-identifier hs-var hs-var">threadLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#concat"><span class="hs-identifier hs-var">S.concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;snap-server: client &quot;</span></span><span>
</span><span id="line-166"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099234"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span>
</span><span id="line-167"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;:&quot;</span></span><span>
</span><span id="line-168"></span><span>                                       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#pack"><span class="hs-identifier hs-var">S.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString) -&gt; String -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099235"><span class="hs-identifier hs-var">remotePort</span></a></span><span>
</span><span id="line-169"></span><span>                                       </span><span class="hs-special">]</span><span>
</span><span id="line-170"></span><span>            </span><span id="local-6989586621679099248"><span class="annot"><span class="annottext">MVar TimeoutThread
</span><a href="#local-6989586621679099248"><span class="hs-identifier hs-var">thMVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar TimeoutThread)
forall a. IO (MVar a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a></span><span>
</span><span id="line-171"></span><span>            </span><span id="local-6989586621679099249"><span class="annot"><span class="annottext">TimeoutThread
</span><a href="#local-6989586621679099249"><span class="hs-identifier hs-var">th</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TimeoutManager
-&gt; ByteString
-&gt; ((forall a. IO a -&gt; IO a) -&gt; IO ())
-&gt; IO TimeoutThread
</span><a href="Snap.Internal.Http.Server.TimeoutManager.html#register"><span class="hs-identifier hs-var">TM.register</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutManager
</span><a href="#local-6989586621679099211"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099244"><span class="hs-identifier hs-var">threadLabel</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO TimeoutThread)
-&gt; ((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO TimeoutThread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679099251"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679099251"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-172"></span><span>                    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Common.html#eatException"><span class="hs-identifier hs-var">eatException</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-173"></span><span>                    </span><span class="annot"><span class="annottext">MVar TimeoutThread
-&gt; SendFileHandler
-&gt; ByteString
-&gt; Int
-&gt; ByteString
-&gt; Int
-&gt; InputStream ByteString
-&gt; OutputStream ByteString
-&gt; IO ()
-&gt; (forall a. IO a -&gt; IO a)
-&gt; IO ()
</span><a href="#local-6989586621679099252"><span class="hs-identifier hs-var">prep</span></a></span><span> </span><span class="annot"><span class="annottext">MVar TimeoutThread
</span><a href="#local-6989586621679099248"><span class="hs-identifier hs-var">thMVar</span></a></span><span> </span><span class="annot"><span class="annottext">SendFileHandler
</span><a href="#local-6989586621679099231"><span class="hs-identifier hs-var">sendFileHandler</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099232"><span class="hs-identifier hs-var">localAddress</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099233"><span class="hs-identifier hs-var">localPort</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099234"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span>
</span><span id="line-174"></span><span>                         </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099235"><span class="hs-identifier hs-var">remotePort</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099236"><span class="hs-identifier hs-var">readEnd</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099237"><span class="hs-identifier hs-var">writeEnd</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099238"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679099251"><span class="hs-identifier hs-var">restore</span></a></span><span>
</span><span id="line-175"></span><span>            </span><span class="annot"><span class="annottext">MVar TimeoutThread -&gt; TimeoutThread -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar TimeoutThread
</span><a href="#local-6989586621679099248"><span class="hs-identifier hs-var">thMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutThread
</span><a href="#local-6989586621679099249"><span class="hs-identifier hs-var">th</span></a></span><span>
</span><span id="line-176"></span><span>            </span><span class="annot"><span class="annottext">IO
  (SendFileHandler, ByteString, Int, ByteString, Int,
   InputStream ByteString, OutputStream ByteString, IO ())
</span><a href="#local-6989586621679099213"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><a href="#local-6989586621679099252"><span class="hs-identifier hs-type">prep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.TimeoutManager.html#TimeoutThread"><span class="hs-identifier hs-type">TM.TimeoutThread</span></a></span><span>
</span><span id="line-179"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#SendFileHandler"><span class="hs-identifier hs-type">SendFileHandler</span></a></span><span>
</span><span id="line-180"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-181"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-182"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-183"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-184"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">InputStream</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-185"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-186"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679099253"><span class="annot"><a href="#local-6989586621679099253"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679099253"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679099253"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>        </span><span id="local-6989586621679099252"><span class="annot"><span class="annottext">prep :: MVar TimeoutThread
-&gt; SendFileHandler
-&gt; ByteString
-&gt; Int
-&gt; ByteString
-&gt; Int
-&gt; InputStream ByteString
-&gt; OutputStream ByteString
-&gt; IO ()
-&gt; (forall a. IO a -&gt; IO a)
-&gt; IO ()
</span><a href="#local-6989586621679099252"><span class="hs-identifier hs-var hs-var">prep</span></a></span></span><span> </span><span id="local-6989586621679099254"><span class="annot"><span class="annottext">MVar TimeoutThread
</span><a href="#local-6989586621679099254"><span class="hs-identifier hs-var">thMVar</span></a></span></span><span> </span><span id="local-6989586621679099255"><span class="annot"><span class="annottext">SendFileHandler
</span><a href="#local-6989586621679099255"><span class="hs-identifier hs-var">sendFileHandler</span></a></span></span><span> </span><span id="local-6989586621679099256"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099256"><span class="hs-identifier hs-var">localAddress</span></a></span></span><span> </span><span id="local-6989586621679099257"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099257"><span class="hs-identifier hs-var">localPort</span></a></span></span><span> </span><span id="local-6989586621679099258"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099258"><span class="hs-identifier hs-var">remoteAddress</span></a></span></span><span>
</span><span id="line-190"></span><span>             </span><span id="local-6989586621679099259"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099259"><span class="hs-identifier hs-var">remotePort</span></a></span></span><span> </span><span id="local-6989586621679099260"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099260"><span class="hs-identifier hs-var">readEnd</span></a></span></span><span> </span><span id="local-6989586621679099261"><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099261"><span class="hs-identifier hs-var">writeEnd</span></a></span></span><span> </span><span id="local-6989586621679099262"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099262"><span class="hs-identifier hs-var">cleanup</span></a></span></span><span> </span><span id="local-6989586621679099263"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679099263"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>          </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>            </span><span id="local-6989586621679099264"><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099264"><span class="hs-identifier hs-var">connClose</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (IORef Bool)
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-193"></span><span>            </span><span id="local-6989586621679099265"><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099265"><span class="hs-identifier hs-var">newConn</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (IORef Bool)
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-194"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099268"><span class="annot"><span class="annottext">twiddleTimeout :: (Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099268"><span class="hs-identifier hs-var hs-var">twiddleTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ((Int -&gt; Int) -&gt; IO ()) -&gt; (Int -&gt; Int) -&gt; IO ()
forall a. IO a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier hs-var">unsafePerformIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ((Int -&gt; Int) -&gt; IO ()) -&gt; (Int -&gt; Int) -&gt; IO ())
-&gt; IO ((Int -&gt; Int) -&gt; IO ()) -&gt; (Int -&gt; Int) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>                                   </span><span id="local-6989586621679099269"><span class="annot"><span class="annottext">TimeoutThread
</span><a href="#local-6989586621679099269"><span class="hs-identifier hs-var">th</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar TimeoutThread -&gt; IO TimeoutThread
forall a. MVar a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar TimeoutThread
</span><a href="#local-6989586621679099254"><span class="hs-identifier hs-var">thMVar</span></a></span><span>
</span><span id="line-196"></span><span>                                   </span><span class="annot"><span class="annottext">((Int -&gt; Int) -&gt; IO ()) -&gt; IO ((Int -&gt; Int) -&gt; IO ())
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(((Int -&gt; Int) -&gt; IO ()) -&gt; IO ((Int -&gt; Int) -&gt; IO ()))
-&gt; ((Int -&gt; Int) -&gt; IO ()) -&gt; IO ((Int -&gt; Int) -&gt; IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutThread -&gt; (Int -&gt; Int) -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.TimeoutManager.html#modify"><span class="hs-identifier hs-var">TM.modify</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutThread
</span><a href="#local-6989586621679099269"><span class="hs-identifier hs-var">th</span></a></span><span>
</span><span id="line-197"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099272"><span class="annot"><span class="annottext">cleanupTimeout :: IO ()
</span><a href="#local-6989586621679099272"><span class="hs-identifier hs-var hs-var">cleanupTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar TimeoutThread -&gt; IO TimeoutThread
forall a. MVar a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#readMVar"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar TimeoutThread
</span><a href="#local-6989586621679099254"><span class="hs-identifier hs-var">thMVar</span></a></span><span> </span><span class="annot"><span class="annottext">IO TimeoutThread -&gt; (TimeoutThread -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutThread -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.TimeoutManager.html#cancel"><span class="hs-identifier hs-var">TM.cancel</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099274"><span class="annot"><span class="annottext">psd :: PerSessionData
</span><a href="#local-6989586621679099274"><span class="hs-identifier hs-var hs-var">psd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Bool
-&gt; ((Int -&gt; Int) -&gt; IO ())
-&gt; IORef Bool
-&gt; SendFileHandler
-&gt; ByteString
-&gt; Int
-&gt; ByteString
-&gt; Int
-&gt; InputStream ByteString
-&gt; OutputStream ByteString
-&gt; PerSessionData
</span><a href="Snap.Internal.Http.Server.Types.html#PerSessionData"><span class="hs-identifier hs-var">PerSessionData</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099264"><span class="hs-identifier hs-var">connClose</span></a></span><span>
</span><span id="line-200"></span><span>                                      </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099268"><span class="hs-identifier hs-var">twiddleTimeout</span></a></span><span>
</span><span id="line-201"></span><span>                                      </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099265"><span class="hs-identifier hs-var">newConn</span></a></span><span>
</span><span id="line-202"></span><span>                                      </span><span class="annot"><span class="annottext">SendFileHandler
</span><a href="#local-6989586621679099255"><span class="hs-identifier hs-var">sendFileHandler</span></a></span><span>
</span><span id="line-203"></span><span>                                      </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099256"><span class="hs-identifier hs-var">localAddress</span></a></span><span>
</span><span id="line-204"></span><span>                                      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099257"><span class="hs-identifier hs-var">localPort</span></a></span><span>
</span><span id="line-205"></span><span>                                      </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099258"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span>
</span><span id="line-206"></span><span>                                      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099259"><span class="hs-identifier hs-var">remotePort</span></a></span><span>
</span><span id="line-207"></span><span>                                      </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099260"><span class="hs-identifier hs-var">readEnd</span></a></span><span>
</span><span id="line-208"></span><span>                                      </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099261"><span class="hs-identifier hs-var">writeEnd</span></a></span><span>
</span><span id="line-209"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679099263"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PerSessionData -&gt; IO ()
</span><a href="#local-6989586621679099276"><span class="hs-identifier hs-var">session</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099274"><span class="hs-identifier hs-var">psd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.Base.html#finally"><span class="hs-operator hs-var">`E.finally`</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099262"><span class="hs-identifier hs-var">cleanup</span></a></span><span>
</span><span id="line-211"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.Base.html#finally"><span class="hs-operator hs-var">`E.finally`</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099272"><span class="hs-identifier hs-var">cleanupTimeout</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-214"></span><span>    </span><span id="local-6989586621679099276"><span class="annot"><span class="annottext">session :: PerSessionData -&gt; IO ()
</span><a href="#local-6989586621679099276"><span class="hs-identifier hs-var hs-var">session</span></a></span></span><span> </span><span id="local-6989586621679099279"><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099279"><span class="hs-identifier hs-var">psd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621679099280"><span class="annot"><span class="annottext">Buffer
</span><a href="#local-6989586621679099280"><span class="hs-identifier hs-var">buffer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO Buffer
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#newBuffer"><span class="hs-identifier hs-var">newBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#defaultChunkSize"><span class="hs-identifier hs-var">defaultChunkSize</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><span class="annottext">Buffer
-&gt; ServerHandler hookState
-&gt; ServerConfig hookState
-&gt; PerSessionData
-&gt; IO ()
forall hookState.
Buffer
-&gt; ServerHandler hookState
-&gt; ServerConfig hookState
-&gt; PerSessionData
-&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Session.html#httpSession"><span class="hs-identifier hs-var">httpSession</span></a></span><span> </span><span class="annot"><span class="annottext">Buffer
</span><a href="#local-6989586621679099280"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHandler hookState
</span><a href="#local-6989586621679099174"><span class="hs-identifier hs-var">serverHandler</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099175"><span class="hs-identifier hs-var">serverConfig</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099279"><span class="hs-identifier hs-var">psd</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621679099206"><span class="annot"><span class="annottext">newLoop :: Int -&gt; IO EventLoopCpu
</span><a href="#local-6989586621679099206"><span class="hs-identifier hs-var hs-var">newLoop</span></a></span></span><span> </span><span id="local-6989586621679099288"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099288"><span class="hs-identifier hs-var">cpu</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO EventLoopCpu -&gt; IO EventLoopCpu
forall a. IO a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.html#mask_"><span class="hs-identifier hs-var">E.mask_</span></a></span><span> </span><span class="annot"><span class="annottext">(IO EventLoopCpu -&gt; IO EventLoopCpu)
-&gt; IO EventLoopCpu -&gt; IO EventLoopCpu
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-comment">-- TODO(greg): move constant into config</span><span>
</span><span id="line-221"></span><span>        </span><span id="local-6989586621679099290"><span class="annot"><span class="annottext">TimeoutManager
</span><a href="#local-6989586621679099290"><span class="hs-identifier hs-var">tm</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; IO ClockTime -&gt; IO TimeoutManager
</span><a href="Snap.Internal.Http.Server.TimeoutManager.html#initialize"><span class="hs-identifier hs-var">TM.initialize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099181"><span class="hs-identifier hs-var">defaultTimeout</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">IO ClockTime
</span><a href="Snap.Internal.Http.Server.Clock.html#getClockTime"><span class="hs-identifier hs-var">getClockTime</span></a></span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099294"><span class="annot"><span class="annottext">threadLabel :: ByteString
</span><a href="#local-6989586621679099294"><span class="hs-identifier hs-var hs-var">threadLabel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#concat"><span class="hs-identifier hs-var">S.concat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;snap-server: accept loop #&quot;</span></span><span>
</span><span id="line-223"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#pack"><span class="hs-identifier hs-var">S.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString) -&gt; String -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099288"><span class="hs-identifier hs-var">cpu</span></a></span><span>
</span><span id="line-224"></span><span>                                   </span><span class="hs-special">]</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>        </span><span id="local-6989586621679099295"><span class="annot"><span class="annottext">SnapThread
</span><a href="#local-6989586621679099295"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; Int -&gt; ((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO SnapThread
</span><a href="Snap.Internal.Http.Server.Thread.html#forkOn"><span class="hs-identifier hs-var">Thread.forkOn</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099294"><span class="hs-identifier hs-var">threadLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099288"><span class="hs-identifier hs-var">cpu</span></a></span><span> </span><span class="annot"><span class="annottext">(((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO SnapThread)
-&gt; ((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO SnapThread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutManager -&gt; (forall a. IO a -&gt; IO a) -&gt; IO ()
</span><a href="#local-6989586621679099210"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutManager
</span><a href="#local-6989586621679099290"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><span class="annottext">EventLoopCpu -&gt; IO EventLoopCpu
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(EventLoopCpu -&gt; IO EventLoopCpu)
-&gt; EventLoopCpu -&gt; IO EventLoopCpu
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">SnapThread -&gt; TimeoutManager -&gt; EventLoopCpu
</span><a href="Snap.Internal.Http.Server.Session.html#EventLoopCpu"><span class="hs-identifier hs-var">EventLoopCpu</span></a></span><span> </span><span class="annot"><span class="annottext">SnapThread
</span><a href="#local-6989586621679099295"><span class="hs-identifier hs-var">tid</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutManager
</span><a href="#local-6989586621679099290"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621679099209"><span class="annot"><span class="annottext">waitLoop :: EventLoopCpu -&gt; IO ()
</span><a href="#local-6989586621679099209"><span class="hs-identifier hs-var hs-var">waitLoop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#EventLoopCpu"><span class="hs-identifier hs-type">EventLoopCpu</span></a></span><span> </span><span id="local-6989586621679099297"><span class="annot"><span class="annottext">SnapThread
</span><a href="#local-6989586621679099297"><span class="hs-identifier hs-var">tid</span></a></span></span><span> </span><span class="annot"><span class="annottext">TimeoutManager
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SnapThread -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Thread.html#wait"><span class="hs-identifier hs-var">Thread.wait</span></a></span><span> </span><span class="annot"><span class="annottext">SnapThread
</span><a href="#local-6989586621679099297"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621679099208"><span class="annot"><span class="annottext">killLoop :: EventLoopCpu -&gt; IO ()
</span><a href="#local-6989586621679099208"><span class="hs-identifier hs-var hs-var">killLoop</span></a></span></span><span> </span><span id="local-6989586621679099300"><span class="annot"><span class="annottext">EventLoopCpu
</span><a href="#local-6989586621679099300"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.html#uninterruptibleMask_"><span class="hs-identifier hs-var">E.uninterruptibleMask_</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">SnapThread -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Thread.html#cancelAndWait"><span class="hs-identifier hs-var">Thread.cancelAndWait</span></a></span><span> </span><span class="annot"><span class="annottext">SnapThread
</span><a href="#local-6989586621679099303"><span class="hs-identifier hs-var">tid</span></a></span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">TimeoutManager -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.TimeoutManager.html#stop"><span class="hs-identifier hs-var">TM.stop</span></a></span><span> </span><span class="annot"><span class="annottext">TimeoutManager
</span><a href="#local-6989586621679099305"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-237"></span><span>        </span><span id="local-6989586621679099303"><span class="annot"><span class="annottext">tid :: SnapThread
</span><a href="#local-6989586621679099303"><span class="hs-identifier hs-var hs-var">tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLoopCpu -&gt; SnapThread
</span><a href="Snap.Internal.Http.Server.Session.html#_acceptThread"><span class="hs-identifier hs-var">_acceptThread</span></a></span><span> </span><span class="annot"><span class="annottext">EventLoopCpu
</span><a href="#local-6989586621679099300"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span id="local-6989586621679099305"><span class="annot"><span class="annottext">tm :: TimeoutManager
</span><a href="#local-6989586621679099305"><span class="hs-identifier hs-var hs-var">tm</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventLoopCpu -&gt; TimeoutManager
</span><a href="Snap.Internal.Http.Server.Session.html#_timeoutManager"><span class="hs-identifier hs-var">_timeoutManager</span></a></span><span> </span><span class="annot"><span class="annottext">EventLoopCpu
</span><a href="#local-6989586621679099300"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-241"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#httpSession"><span class="hs-identifier hs-type">httpSession</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679098814"><span class="annot"><a href="#local-6989586621679098814"><span class="hs-identifier hs-type">hookState</span></a></span></span><span> </span><span class="hs-operator">.</span><span>
</span><span id="line-242"></span><span>               </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-243"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098814"><span class="hs-identifier hs-type">hookState</span></a></span><span>
</span><span id="line-244"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#ServerConfig"><span class="hs-identifier hs-type">ServerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098814"><span class="hs-identifier hs-type">hookState</span></a></span><span>
</span><span id="line-245"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Types.html#PerSessionData"><span class="hs-identifier hs-type">PerSessionData</span></a></span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span id="httpSession"><span class="annot"><span class="annottext">httpSession :: forall hookState.
Buffer
-&gt; ServerHandler hookState
-&gt; ServerConfig hookState
-&gt; PerSessionData
-&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Session.html#httpSession"><span class="hs-identifier hs-var hs-var">httpSession</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099375"><span class="annot"><span class="annottext">Buffer
</span><a href="#local-6989586621679099375"><span class="hs-identifier hs-var">buffer</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099376"><span class="annot"><span class="annottext">ServerHandler hookState
</span><a href="#local-6989586621679099376"><span class="hs-identifier hs-var">serverHandler</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099377"><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099378"><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099379"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-250"></span><span>    </span><span id="local-6989586621679099380"><span class="annot"><span class="annottext">defaultTimeout :: Int
</span><a href="#local-6989586621679099380"><span class="hs-identifier hs-var hs-var">defaultTimeout</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Int
forall hookState. ServerConfig hookState -&gt; Int
</span><a href="Snap.Internal.Http.Server.Types.html#_defaultTimeout"><span class="hs-identifier hs-var">_defaultTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span id="local-6989586621679099381"><span class="annot"><span class="annottext">isSecure :: Bool
</span><a href="#local-6989586621679099381"><span class="hs-identifier hs-var hs-var">isSecure</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Bool
forall hookState. ServerConfig hookState -&gt; Bool
</span><a href="Snap.Internal.Http.Server.Types.html#_isSecure"><span class="hs-identifier hs-var">_isSecure</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span id="local-6989586621679099383"><span class="annot"><span class="annottext">localHostname :: ByteString
</span><a href="#local-6989586621679099383"><span class="hs-identifier hs-var hs-var">localHostname</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; ByteString
forall hookState. ServerConfig hookState -&gt; ByteString
</span><a href="Snap.Internal.Http.Server.Types.html#_localHostname"><span class="hs-identifier hs-var">_localHostname</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621679099385"><span class="annot"><span class="annottext">logAccess :: Request -&gt; Response -&gt; Word64 -&gt; IO ()
</span><a href="#local-6989586621679099385"><span class="hs-identifier hs-var hs-var">logAccess</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Request -&gt; Response -&gt; Word64 -&gt; IO ()
forall hookState.
ServerConfig hookState -&gt; Request -&gt; Response -&gt; Word64 -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Types.html#_logAccess"><span class="hs-identifier hs-var">_logAccess</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621679099387"><span class="annot"><span class="annottext">logError :: Builder -&gt; IO ()
</span><a href="#local-6989586621679099387"><span class="hs-identifier hs-var hs-var">logError</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; Builder -&gt; IO ()
forall hookState. ServerConfig hookState -&gt; Builder -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Types.html#_logError"><span class="hs-identifier hs-var">_logError</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621679099388"><span class="annot"><span class="annottext">newRequestHook :: NewRequestHook hookState
</span><a href="#local-6989586621679099388"><span class="hs-identifier hs-var hs-var">newRequestHook</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; NewRequestHook hookState
forall hookState.
ServerConfig hookState -&gt; NewRequestHook hookState
</span><a href="Snap.Internal.Http.Server.Types.html#_onNewRequest"><span class="hs-identifier hs-var">_onNewRequest</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621679099390"><span class="annot"><span class="annottext">parseHook :: ParseHook hookState
</span><a href="#local-6989586621679099390"><span class="hs-identifier hs-var hs-var">parseHook</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; ParseHook hookState
forall hookState. ServerConfig hookState -&gt; ParseHook hookState
</span><a href="Snap.Internal.Http.Server.Types.html#_onParse"><span class="hs-identifier hs-var">_onParse</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621679099392"><span class="annot"><span class="annottext">userHandlerFinishedHook :: UserHandlerFinishedHook hookState
</span><a href="#local-6989586621679099392"><span class="hs-identifier hs-var hs-var">userHandlerFinishedHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; UserHandlerFinishedHook hookState
forall hookState.
ServerConfig hookState -&gt; UserHandlerFinishedHook hookState
</span><a href="Snap.Internal.Http.Server.Types.html#_onUserHandlerFinished"><span class="hs-identifier hs-var">_onUserHandlerFinished</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621679099394"><span class="annot"><span class="annottext">dataFinishedHook :: UserHandlerFinishedHook hookState
</span><a href="#local-6989586621679099394"><span class="hs-identifier hs-var hs-var">dataFinishedHook</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; UserHandlerFinishedHook hookState
forall hookState.
ServerConfig hookState -&gt; UserHandlerFinishedHook hookState
</span><a href="Snap.Internal.Http.Server.Types.html#_onDataFinished"><span class="hs-identifier hs-var">_onDataFinished</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621679099396"><span class="annot"><span class="annottext">exceptionHook :: ExceptionHook hookState
</span><a href="#local-6989586621679099396"><span class="hs-identifier hs-var hs-var">exceptionHook</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; ExceptionHook hookState
forall hookState. ServerConfig hookState -&gt; ExceptionHook hookState
</span><a href="Snap.Internal.Http.Server.Types.html#_onException"><span class="hs-identifier hs-var">_onException</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span id="local-6989586621679099398"><span class="annot"><span class="annottext">escapeHook :: EscapeSnapHook hookState
</span><a href="#local-6989586621679099398"><span class="hs-identifier hs-var hs-var">escapeHook</span></a></span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState -&gt; EscapeSnapHook hookState
forall hookState.
ServerConfig hookState -&gt; EscapeSnapHook hookState
</span><a href="Snap.Internal.Http.Server.Types.html#_onEscape"><span class="hs-identifier hs-var">_onEscape</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621679099400"><span class="annot"><span class="annottext">forceConnectionClose :: IORef Bool
</span><a href="#local-6989586621679099400"><span class="hs-identifier hs-var hs-var">forceConnectionClose</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; IORef Bool
</span><a href="Snap.Internal.Http.Server.Types.html#_forceConnectionClose"><span class="hs-identifier hs-var">_forceConnectionClose</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span id="local-6989586621679099402"><span class="annot"><span class="annottext">isNewConnection :: IORef Bool
</span><a href="#local-6989586621679099402"><span class="hs-identifier hs-var hs-var">isNewConnection</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; IORef Bool
</span><a href="Snap.Internal.Http.Server.Types.html#_isNewConnection"><span class="hs-identifier hs-var">_isNewConnection</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-265"></span><span>    </span><span id="local-6989586621679099404"><span class="annot"><span class="annottext">localAddress :: ByteString
</span><a href="#local-6989586621679099404"><span class="hs-identifier hs-var hs-var">localAddress</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; ByteString
</span><a href="Snap.Internal.Http.Server.Types.html#_localAddress"><span class="hs-identifier hs-var">_localAddress</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span id="local-6989586621679099406"><span class="annot"><span class="annottext">localPort :: Int
</span><a href="#local-6989586621679099406"><span class="hs-identifier hs-var hs-var">localPort</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; Int
</span><a href="Snap.Internal.Http.Server.Types.html#_localPort"><span class="hs-identifier hs-var">_localPort</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span id="local-6989586621679099408"><span class="annot"><span class="annottext">remoteAddress :: ByteString
</span><a href="#local-6989586621679099408"><span class="hs-identifier hs-var hs-var">remoteAddress</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; ByteString
</span><a href="Snap.Internal.Http.Server.Types.html#_remoteAddress"><span class="hs-identifier hs-var">_remoteAddress</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621679099410"><span class="annot"><span class="annottext">remotePort :: Int
</span><a href="#local-6989586621679099410"><span class="hs-identifier hs-var hs-var">remotePort</span></a></span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; Int
</span><a href="Snap.Internal.Http.Server.Types.html#_remotePort"><span class="hs-identifier hs-var">_remotePort</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span id="local-6989586621679099412"><span class="annot"><span class="annottext">readEnd :: InputStream ByteString
</span><a href="#local-6989586621679099412"><span class="hs-identifier hs-var hs-var">readEnd</span></a></span></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; InputStream ByteString
</span><a href="Snap.Internal.Http.Server.Types.html#_readEnd"><span class="hs-identifier hs-var">_readEnd</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-270"></span><span>    </span><span id="local-6989586621679099414"><span class="annot"><span class="annottext">tickle :: (Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099414"><span class="hs-identifier hs-var hs-var">tickle</span></a></span></span><span> </span><span id="local-6989586621679099415"><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679099415"><span class="hs-identifier hs-var">f</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; (Int -&gt; Int) -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Types.html#_twiddleTimeout"><span class="hs-identifier hs-var">_twiddleTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679099415"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span id="local-6989586621679099416"><span class="annot"><span class="annottext">writeEnd :: OutputStream ByteString
</span><a href="#local-6989586621679099416"><span class="hs-identifier hs-var hs-var">writeEnd</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; OutputStream ByteString
</span><a href="Snap.Internal.Http.Server.Types.html#_writeEnd"><span class="hs-identifier hs-var">_writeEnd</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679099418"><span class="annot"><span class="annottext">sendfileHandler :: SendFileHandler
</span><a href="#local-6989586621679099418"><span class="hs-identifier hs-var hs-var">sendfileHandler</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PerSessionData -&gt; SendFileHandler
</span><a href="Snap.Internal.Http.Server.Types.html#_sendfileHandler"><span class="hs-identifier hs-var">_sendfileHandler</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><a href="#local-6989586621679099420"><span class="hs-identifier hs-type">mkBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>    </span><span id="local-6989586621679099420"><span class="annot"><span class="annottext">mkBuffer :: IO (OutputStream Builder)
</span><a href="#local-6989586621679099420"><span class="hs-identifier hs-var hs-var">mkBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Buffer -&gt; OutputStream ByteString -&gt; IO (OutputStream Builder)
</span><span class="hs-identifier hs-var">Streams.unsafeBuilderStream</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Buffer -&gt; IO Buffer
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Buffer
</span><a href="#local-6989586621679099375"><span class="hs-identifier hs-var">buffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099416"><span class="hs-identifier hs-var">writeEnd</span></a></span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- Begin HTTP session processing.</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><a href="#local-6989586621679099379"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621679099379"><span class="annot"><span class="annottext">loop :: IO ()
</span><a href="#local-6989586621679099379"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>        </span><span class="hs-comment">-- peek first to ensure startHook gets generated at the right time.</span><span>
</span><span id="line-283"></span><span>        </span><span class="annot"><span class="annottext">IO Bool
</span><a href="#local-6989586621679099422"><span class="hs-identifier hs-var">readEndAtEof</span></a></span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; (Bool -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; IO () -&gt; IO ()) -&gt; IO () -&gt; Bool -&gt; IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Bool -&gt; IO ()) -&gt; IO () -&gt; Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>            </span><span id="local-6989586621679099424"><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099424"><span class="hs-identifier hs-var">hookState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NewRequestHook hookState
</span><a href="#local-6989586621679099388"><span class="hs-identifier hs-var">newRequestHook</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span> </span><span class="annot"><span class="annottext">IO hookState
-&gt; (hookState -&gt; IO (IORef hookState)) -&gt; IO (IORef hookState)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">hookState -&gt; IO (IORef hookState)
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span>
</span><span id="line-285"></span><span>            </span><span class="hs-comment">-- parse HTTP request</span><span>
</span><span id="line-286"></span><span>            </span><span id="local-6989586621679099425"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099425"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Request
</span><a href="#local-6989586621679099426"><span class="hs-identifier hs-var">receiveRequest</span></a></span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><span class="annottext">ParseHook hookState
</span><a href="#local-6989586621679099390"><span class="hs-identifier hs-var">parseHook</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099424"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099425"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-288"></span><span>            </span><span class="annot"><span class="annottext">ParseHook hookState
</span><a href="#local-6989586621679099427"><span class="hs-identifier hs-var">processRequest</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099424"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099425"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621679099422"><span class="annot"><span class="annottext">readEndAtEof :: IO Bool
</span><a href="#local-6989586621679099422"><span class="hs-identifier hs-var hs-var">readEndAtEof</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InputStream ByteString -&gt; IO (Maybe ByteString)
forall a. InputStream a -&gt; IO (Maybe a)
</span><span class="hs-identifier hs-var">Streams.read</span></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099412"><span class="hs-identifier hs-var">readEnd</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe ByteString) -&gt; (Maybe ByteString -&gt; IO Bool) -&gt; IO Bool
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span>
</span><span id="line-292"></span><span>                   </span><span class="annot"><span class="annottext">IO Bool -&gt; (ByteString -&gt; IO Bool) -&gt; Maybe ByteString -&gt; IO Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>                         </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679099434"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099434"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#null"><span class="hs-identifier hs-var">S.null</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099434"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-294"></span><span>                                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="#local-6989586621679099422"><span class="hs-identifier hs-var">readEndAtEof</span></a></span><span>
</span><span id="line-295"></span><span>                                  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; InputStream ByteString -&gt; IO ()
forall a. a -&gt; InputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.unRead</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099434"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099412"><span class="hs-identifier hs-var">readEnd</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Bool -&gt; IO Bool
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099422"><span class="hs-pragma hs-type">readEndAtEof</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- Read the HTTP request from the socket, parse it, and pre-process it.</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="#local-6989586621679099426"><span class="hs-identifier hs-type">receiveRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621679099426"><span class="annot"><span class="annottext">receiveRequest :: IO Request
</span><a href="#local-6989586621679099426"><span class="hs-identifier hs-var hs-var">receiveRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;httpSession/receiveRequest&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>        </span><span id="local-6989586621679099437"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099437"><span class="hs-identifier hs-var">readEnd'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; InputStream ByteString -&gt; IO (InputStream ByteString)
</span><span class="hs-identifier hs-var">Streams.throwIfProducesMoreThan</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="Snap.Internal.Http.Server.Session.html#mAX_HEADERS_SIZE"><span class="hs-identifier hs-var">mAX_HEADERS_SIZE</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099412"><span class="hs-identifier hs-var">readEnd</span></a></span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><span class="annottext">InputStream ByteString -&gt; IO IRequest
</span><a href="Snap.Internal.Http.Server.Parser.html#parseRequest"><span class="hs-identifier hs-var">parseRequest</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099437"><span class="hs-identifier hs-var">readEnd'</span></a></span><span> </span><span class="annot"><span class="annottext">IO IRequest -&gt; (IRequest -&gt; IO Request) -&gt; IO Request
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">IRequest -&gt; IO Request
</span><a href="#local-6989586621679099439"><span class="hs-identifier hs-var">toRequest</span></a></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099426"><span class="hs-pragma hs-type">receiveRequest</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><a href="#local-6989586621679099439"><span class="hs-identifier hs-type">toRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Parser.html#IRequest"><span class="hs-identifier hs-type">IRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-308"></span><span>    </span><span id="local-6989586621679099439"><span class="annot"><span class="annottext">toRequest :: IRequest -&gt; IO Request
</span><a href="#local-6989586621679099439"><span class="hs-identifier hs-var hs-var">toRequest</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099440"><span class="annot"><span class="annottext">IRequest
</span><a href="#local-6989586621679099440"><span class="hs-identifier hs-var">ireq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;httpSession/toRequest&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-comment">-- HTTP spec section 14.23: &quot;All Internet-based HTTP/1.1 servers MUST</span><span>
</span><span id="line-310"></span><span>        </span><span class="hs-comment">-- respond with a 400 (Bad Request) status code to any HTTP/1.1 request</span><span>
</span><span id="line-311"></span><span>        </span><span class="hs-comment">-- message which lacks a Host header field.&quot;</span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-comment">-- Here we interpret this slightly more liberally: if an absolute URI</span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-comment">-- including a hostname is given in the request line, we'll take that</span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-comment">-- if there's no Host header.</span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-comment">-- For HTTP/1.0 requests, we pick the configured local hostname by</span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-comment">-- default.</span><span>
</span><span id="line-319"></span><span>        </span><span id="local-6989586621679099441"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099441"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ByteString
-&gt; (ByteString -&gt; IO ByteString)
-&gt; Maybe ByteString
-&gt; IO ByteString
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099442"><span class="hs-identifier hs-var">isHttp11</span></a></span><span>
</span><span id="line-320"></span><span>                         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IO ByteString
forall a. IO a
</span><a href="#local-6989586621679099443"><span class="hs-identifier hs-var">badRequestWithNoHost</span></a></span><span>
</span><span id="line-321"></span><span>                         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099383"><span class="hs-identifier hs-var">localHostname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>                      </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679099444"><span class="hs-identifier hs-var">mbHost</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>        </span><span class="hs-comment">-- Call setupReadEnd, which handles transfer-encoding: chunked or</span><span>
</span><span id="line-325"></span><span>        </span><span class="hs-comment">-- content-length restrictions, etc</span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099445"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099445"><span class="hs-identifier hs-var">readEnd'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (InputStream ByteString)
</span><a href="#local-6989586621679099446"><span class="hs-identifier hs-var">setupReadEnd</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>        </span><span class="hs-comment">-- Parse an application/x-www-form-urlencoded form, if it was sent</span><span>
</span><span id="line-329"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679099447"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099447"><span class="hs-identifier hs-var">readEnd''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099448"><span class="annot"><span class="annottext">Map ByteString [ByteString]
</span><a href="#local-6989586621679099448"><span class="hs-identifier hs-var">postParams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
-&gt; IO (InputStream ByteString, Map ByteString [ByteString])
</span><a href="#local-6989586621679099449"><span class="hs-identifier hs-var">parseForm</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099445"><span class="hs-identifier hs-var">readEnd'</span></a></span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099452"><span class="annot"><span class="annottext">allParams :: Map ByteString [ByteString]
</span><a href="#local-6989586621679099452"><span class="hs-identifier hs-var hs-var">allParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; [ByteString] -&gt; [ByteString])
-&gt; Map ByteString [ByteString]
-&gt; Map ByteString [ByteString]
-&gt; Map ByteString [ByteString]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#unionWith"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">(++)</span></a></span><span> </span><span class="annot"><span class="annottext">Map ByteString [ByteString]
</span><a href="#local-6989586621679099454"><span class="hs-identifier hs-var">queryParams</span></a></span><span> </span><span class="annot"><span class="annottext">Map ByteString [ByteString]
</span><a href="#local-6989586621679099448"><span class="hs-identifier hs-var">postParams</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-comment">-- Decide whether the connection should be closed after the response is</span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-comment">-- sent (stored in the forceConnectionClose IORef).</span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><span class="annottext">HttpVersion -&gt; Maybe ByteString -&gt; IO ()
forall {a} {b} {a}.
(Num a, Num b, Eq a, Eq b, Eq a, IsString a, FoldCase a) =&gt;
(a, b) -&gt; Maybe a -&gt; IO ()
</span><a href="#local-6989586621679099455"><span class="hs-identifier hs-var">checkConnectionClose</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099456"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ByteString -&gt; IO ()) -&gt; Maybe ByteString -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders -&gt; Maybe ByteString
</span><a href="Snap.Internal.Http.Server.Parser.html#getStdConnection"><span class="hs-identifier hs-var">getStdConnection</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders
</span><a href="#local-6989586621679099457"><span class="hs-identifier hs-var">stdHdrs</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-comment">-- The request is now ready for processing.</span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><span class="annottext">Request -&gt; IO Request
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Request -&gt; IO Request) -&gt; Request -&gt; IO Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; ByteString
-&gt; Int
-&gt; ByteString
-&gt; Int
-&gt; ByteString
-&gt; Bool
-&gt; Headers
-&gt; InputStream ByteString
-&gt; Maybe Word64
-&gt; Method
-&gt; HttpVersion
-&gt; [Cookie]
-&gt; ByteString
-&gt; ByteString
-&gt; ByteString
-&gt; ByteString
-&gt; Map ByteString [ByteString]
-&gt; Map ByteString [ByteString]
-&gt; Map ByteString [ByteString]
-&gt; Request
</span><span class="hs-identifier hs-var">Request</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099441"><span class="hs-identifier hs-var">host</span></a></span><span>
</span><span id="line-339"></span><span>                          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099408"><span class="hs-identifier hs-var">remoteAddress</span></a></span><span>
</span><span id="line-340"></span><span>                          </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099410"><span class="hs-identifier hs-var">remotePort</span></a></span><span>
</span><span id="line-341"></span><span>                          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099404"><span class="hs-identifier hs-var">localAddress</span></a></span><span>
</span><span id="line-342"></span><span>                          </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099406"><span class="hs-identifier hs-var">localPort</span></a></span><span>
</span><span id="line-343"></span><span>                          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099459"><span class="hs-identifier hs-var">localHost</span></a></span><span>
</span><span id="line-344"></span><span>                          </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099381"><span class="hs-identifier hs-var">isSecure</span></a></span><span>
</span><span id="line-345"></span><span>                          </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099460"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-346"></span><span>                          </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099447"><span class="hs-identifier hs-var">readEnd''</span></a></span><span>
</span><span id="line-347"></span><span>                          </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621679099461"><span class="hs-identifier hs-var">mbCL</span></a></span><span>
</span><span id="line-348"></span><span>                          </span><span class="annot"><span class="annottext">Method
</span><a href="#local-6989586621679099462"><span class="hs-identifier hs-var">method</span></a></span><span>
</span><span id="line-349"></span><span>                          </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099456"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-350"></span><span>                          </span><span class="annot"><span class="annottext">[Cookie]
</span><a href="#local-6989586621679099463"><span class="hs-identifier hs-var">cookies</span></a></span><span>
</span><span id="line-351"></span><span>                          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099464"><span class="hs-identifier hs-var">pathInfo</span></a></span><span>
</span><span id="line-352"></span><span>                          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099465"><span class="hs-identifier hs-var">contextPath</span></a></span><span>
</span><span id="line-353"></span><span>                          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099466"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-354"></span><span>                          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099467"><span class="hs-identifier hs-var">queryString</span></a></span><span>
</span><span id="line-355"></span><span>                          </span><span class="annot"><span class="annottext">Map ByteString [ByteString]
</span><a href="#local-6989586621679099452"><span class="hs-identifier hs-var">allParams</span></a></span><span>
</span><span id="line-356"></span><span>                          </span><span class="annot"><span class="annottext">Map ByteString [ByteString]
</span><a href="#local-6989586621679099454"><span class="hs-identifier hs-var">queryParams</span></a></span><span>
</span><span id="line-357"></span><span>                          </span><span class="annot"><span class="annottext">Map ByteString [ByteString]
</span><a href="#local-6989586621679099448"><span class="hs-identifier hs-var">postParams</span></a></span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-361"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099462"><span class="annot"><span class="annottext">method :: Method
</span><a href="#local-6989586621679099462"><span class="hs-identifier hs-var hs-var">method</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IRequest -&gt; Method
</span><a href="Snap.Internal.Http.Server.Parser.html#iMethod"><span class="hs-identifier hs-var">iMethod</span></a></span><span> </span><span class="annot"><span class="annottext">IRequest
</span><a href="#local-6989586621679099440"><span class="hs-identifier hs-var">ireq</span></a></span><span>
</span><span id="line-362"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099456"><span class="annot"><span class="annottext">version :: HttpVersion
</span><a href="#local-6989586621679099456"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IRequest -&gt; HttpVersion
</span><a href="Snap.Internal.Http.Server.Parser.html#iHttpVersion"><span class="hs-identifier hs-var">iHttpVersion</span></a></span><span> </span><span class="annot"><span class="annottext">IRequest
</span><a href="#local-6989586621679099440"><span class="hs-identifier hs-var">ireq</span></a></span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099457"><span class="annot"><span class="annottext">stdHdrs :: StandardHeaders
</span><a href="#local-6989586621679099457"><span class="hs-identifier hs-var hs-var">stdHdrs</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IRequest -&gt; StandardHeaders
</span><a href="Snap.Internal.Http.Server.Parser.html#iStdHeaders"><span class="hs-identifier hs-var">iStdHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">IRequest
</span><a href="#local-6989586621679099440"><span class="hs-identifier hs-var">ireq</span></a></span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099460"><span class="annot"><span class="annottext">hdrs :: Headers
</span><a href="#local-6989586621679099460"><span class="hs-identifier hs-var hs-var">hdrs</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IRequest -&gt; Headers
</span><a href="Snap.Internal.Http.Server.Parser.html#iRequestHeaders"><span class="hs-identifier hs-var">iRequestHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">IRequest
</span><a href="#local-6989586621679099440"><span class="hs-identifier hs-var">ireq</span></a></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099442"><span class="annot"><span class="annottext">isHttp11 :: Bool
</span><a href="#local-6989586621679099442"><span class="hs-identifier hs-var hs-var">isHttp11</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099456"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; HttpVersion -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099444"><span class="annot"><span class="annottext">mbHost :: Maybe ByteString
</span><a href="#local-6989586621679099444"><span class="hs-identifier hs-var hs-var">mbHost</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StandardHeaders -&gt; Maybe ByteString
</span><a href="Snap.Internal.Http.Server.Parser.html#getStdHost"><span class="hs-identifier hs-var">getStdHost</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders
</span><a href="#local-6989586621679099457"><span class="hs-identifier hs-var">stdHdrs</span></a></span><span>
</span><span id="line-369"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099459"><span class="annot"><span class="annottext">localHost :: ByteString
</span><a href="#local-6989586621679099459"><span class="hs-identifier hs-var hs-var">localHost</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString -&gt; ByteString
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099383"><span class="hs-identifier hs-var">localHostname</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679099444"><span class="hs-identifier hs-var">mbHost</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span id="local-6989586621679099461"><span class="annot"><span class="annottext">mbCL :: Maybe Word64
</span><a href="#local-6989586621679099461"><span class="hs-identifier hs-var hs-var">mbCL</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Word64
forall a. (Enum a, Num a, Bits a) =&gt; ByteString -&gt; a
</span><span class="hs-identifier hs-var">unsafeFromNat</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Word64) -&gt; Maybe ByteString -&gt; Maybe Word64
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-371"></span><span>                        </span><span class="annot"><span class="annottext">StandardHeaders -&gt; Maybe ByteString
</span><a href="Snap.Internal.Http.Server.Parser.html#getStdContentLength"><span class="hs-identifier hs-var">getStdContentLength</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders
</span><a href="#local-6989586621679099457"><span class="hs-identifier hs-var">stdHdrs</span></a></span><span>
</span><span id="line-372"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099495"><span class="annot"><span class="annottext">isChunked :: Bool
</span><a href="#local-6989586621679099495"><span class="hs-identifier hs-var hs-var">isChunked</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; CI ByteString
forall s. FoldCase s =&gt; s -&gt; CI s
</span><span class="hs-identifier hs-var">CI.mk</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; CI ByteString)
-&gt; Maybe ByteString -&gt; Maybe (CI ByteString)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders -&gt; Maybe ByteString
</span><a href="Snap.Internal.Http.Server.Parser.html#getStdTransferEncoding"><span class="hs-identifier hs-var">getStdTransferEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders
</span><a href="#local-6989586621679099457"><span class="hs-identifier hs-var">stdHdrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>                            </span><span class="annot"><span class="annottext">Maybe (CI ByteString) -&gt; Maybe (CI ByteString) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CI ByteString -&gt; Maybe (CI ByteString)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CI ByteString
</span><span class="hs-string">&quot;chunked&quot;</span></span><span>
</span><span id="line-374"></span><span>        </span><span id="local-6989586621679099463"><span class="annot"><span class="annottext">cookies :: [Cookie]
</span><a href="#local-6989586621679099463"><span class="hs-identifier hs-var hs-var">cookies</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Cookie] -&gt; Maybe [Cookie] -&gt; [Cookie]
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StandardHeaders -&gt; Maybe ByteString
</span><a href="Snap.Internal.Http.Server.Parser.html#getStdCookie"><span class="hs-identifier hs-var">getStdCookie</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders
</span><a href="#local-6989586621679099457"><span class="hs-identifier hs-var">stdHdrs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; (ByteString -&gt; Maybe [Cookie]) -&gt; Maybe [Cookie]
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe [Cookie]
</span><span class="hs-identifier hs-var">parseCookie</span></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>        </span><span id="local-6989586621679099465"><span class="annot"><span class="annottext">contextPath :: ByteString
</span><a href="#local-6989586621679099465"><span class="hs-identifier hs-var hs-var">contextPath</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;/&quot;</span></span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099466"><span class="annot"><span class="annottext">uri :: ByteString
</span><a href="#local-6989586621679099466"><span class="hs-identifier hs-var hs-var">uri</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IRequest -&gt; ByteString
</span><a href="Snap.Internal.Http.Server.Parser.html#iRequestUri"><span class="hs-identifier hs-var">iRequestUri</span></a></span><span> </span><span class="annot"><span class="annottext">IRequest
</span><a href="#local-6989586621679099440"><span class="hs-identifier hs-var">ireq</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span id="local-6989586621679099454"><span class="annot"><span class="annottext">queryParams :: Map ByteString [ByteString]
</span><a href="#local-6989586621679099454"><span class="hs-identifier hs-var hs-var">queryParams</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Map ByteString [ByteString]
</span><span class="hs-identifier hs-var">parseUrlEncoded</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099467"><span class="hs-identifier hs-var">queryString</span></a></span><span>
</span><span id="line-378"></span><span>        </span><span id="local-6989586621679099501"><span class="annot"><span class="annottext">emptyParams :: Map k a
</span><a href="#local-6989586621679099501"><span class="hs-identifier hs-var hs-var">emptyParams</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map k a
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-381"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679099464"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099464"><span class="hs-identifier hs-var">pathInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099467"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099467"><span class="hs-identifier hs-var">queryString</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (ByteString, ByteString) -&gt; (ByteString, ByteString)
forall b c d. (b -&gt; c) -&gt; (b, d) -&gt; (c, d)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (b, d) (c, d)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Arrow.html#first"><span class="hs-identifier hs-var">first</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><a href="#local-6989586621679099508"><span class="hs-identifier hs-var">dropLeadingSlash</span></a></span><span> </span><span class="annot"><span class="annottext">((ByteString, ByteString) -&gt; (ByteString, ByteString))
-&gt; ((ByteString, ByteString) -&gt; (ByteString, ByteString))
-&gt; (ByteString, ByteString)
-&gt; (ByteString, ByteString)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (ByteString, ByteString) -&gt; (ByteString, ByteString)
forall b c d. (b -&gt; c) -&gt; (d, b) -&gt; (d, c)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Arrow.html#second"><span class="hs-identifier hs-var">second</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#drop"><span class="hs-identifier hs-var">S.drop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>                                    </span><span class="annot"><span class="annottext">((ByteString, ByteString) -&gt; (ByteString, ByteString))
-&gt; (ByteString, ByteString) -&gt; (ByteString, ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; ByteString -&gt; (ByteString, ByteString)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#break"><span class="hs-identifier hs-var">S.break</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'?'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099466"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-385"></span><span>        </span><span id="local-6989586621679099508"><span class="annot"><span class="annottext">dropLeadingSlash :: ByteString -&gt; ByteString
</span><a href="#local-6989586621679099508"><span class="hs-identifier hs-var hs-var">dropLeadingSlash</span></a></span></span><span> </span><span id="local-6989586621679099514"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099514"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#null"><span class="hs-identifier hs-var">S.null</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099514"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-386"></span><span>                               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099514"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-387"></span><span>                               </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099515"><span class="annot"><span class="annottext">a :: Word8
</span><a href="#local-6989586621679099515"><span class="hs-identifier hs-var hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Unsafe.html#unsafeIndex"><span class="hs-identifier hs-var">S.unsafeIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099514"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-388"></span><span>                                    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679099515"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">47</span></span><span>   </span><span class="hs-comment">-- 47 == '/'</span><span>
</span><span id="line-389"></span><span>                                         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Unsafe.html#unsafeDrop"><span class="hs-identifier hs-var">S.unsafeDrop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099514"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-390"></span><span>                                         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099514"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099508"><span class="hs-pragma hs-type">dropLeadingSlash</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-394"></span><span>        </span><span class="hs-comment">-- | We have to transform the read end of the socket, to limit the</span><span>
</span><span id="line-395"></span><span>        </span><span class="hs-comment">-- number of bytes read to the content-length, to decode chunked</span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-comment">-- transfer encoding, or to immediately yield EOF if the request body</span><span>
</span><span id="line-397"></span><span>        </span><span class="hs-comment">-- is empty.</span><span>
</span><span id="line-398"></span><span>        </span><span class="annot"><a href="#local-6989586621679099446"><span class="hs-identifier hs-type">setupReadEnd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">InputStream</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>        </span><span id="local-6989586621679099446"><span class="annot"><span class="annottext">setupReadEnd :: IO (InputStream ByteString)
</span><a href="#local-6989586621679099446"><span class="hs-identifier hs-var hs-var">setupReadEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-400"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099495"><span class="hs-identifier hs-var">isChunked</span></a></span><span>
</span><span id="line-401"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">InputStream ByteString -&gt; IO (InputStream ByteString)
</span><a href="Snap.Internal.Http.Server.Parser.html#readChunkedTransferEncoding"><span class="hs-identifier hs-var">readChunkedTransferEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099412"><span class="hs-identifier hs-var">readEnd</span></a></span><span>
</span><span id="line-402"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(InputStream ByteString -&gt; IO (InputStream ByteString))
-&gt; (Word64
    -&gt; InputStream ByteString -&gt; IO (InputStream ByteString))
-&gt; Maybe Word64
-&gt; InputStream ByteString
-&gt; IO (InputStream ByteString)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (InputStream ByteString)
-&gt; InputStream ByteString -&gt; IO (InputStream ByteString)
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">IO (InputStream ByteString)
</span><a href="#local-6989586621679099519"><span class="hs-identifier hs-var">noContentLength</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; InputStream ByteString -&gt; IO (InputStream ByteString)
</span><span class="hs-identifier hs-var">Streams.takeBytes</span></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; InputStream ByteString -&gt; IO (InputStream ByteString))
-&gt; (Word64 -&gt; Int64)
-&gt; Word64
-&gt; InputStream ByteString
-&gt; IO (InputStream ByteString)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Word64
</span><a href="#local-6989586621679099461"><span class="hs-identifier hs-var">mbCL</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099412"><span class="hs-identifier hs-var">readEnd</span></a></span><span>
</span><span id="line-404"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099446"><span class="hs-pragma hs-type">setupReadEnd</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-407"></span><span>        </span><span class="hs-comment">-- | If a request is not in chunked transfer encoding and lacks a</span><span>
</span><span id="line-408"></span><span>        </span><span class="hs-comment">-- content-length, the request body is null string.</span><span>
</span><span id="line-409"></span><span>        </span><span class="annot"><a href="#local-6989586621679099519"><span class="hs-identifier hs-type">noContentLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">InputStream</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>        </span><span id="local-6989586621679099519"><span class="annot"><span class="annottext">noContentLength :: IO (InputStream ByteString)
</span><a href="#local-6989586621679099519"><span class="hs-identifier hs-var hs-var">noContentLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-411"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Method
</span><a href="#local-6989586621679099462"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Method -&gt; Method -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Method
</span><span class="hs-identifier hs-var">POST</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Method
</span><a href="#local-6989586621679099462"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Method -&gt; Method -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Method
</span><span class="hs-identifier hs-var">PUT</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ()
forall a. IO a
</span><a href="#local-6989586621679099524"><span class="hs-identifier hs-var">return411</span></a></span><span>
</span><span id="line-412"></span><span>            </span><span class="annot"><span class="annottext">[ByteString] -&gt; IO (InputStream ByteString)
forall c. [c] -&gt; IO (InputStream c)
</span><span class="hs-identifier hs-var">Streams.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-415"></span><span>        </span><span id="local-6989586621679099524"><span class="annot"><span class="annottext">return411 :: IO b
</span><a href="#local-6989586621679099524"><span class="hs-identifier hs-var hs-var">return411</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679099530"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099530"><span class="hs-identifier hs-var">major</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099531"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099531"><span class="hs-identifier hs-var">minor</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099456"><span class="hs-identifier hs-var">version</span></a></span><span>
</span><span id="line-417"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099538"><span class="annot"><span class="annottext">resp :: Builder
</span><a href="#local-6989586621679099538"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Builder] -&gt; Builder
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/&quot;</span></span><span>
</span><span id="line-418"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Builder
forall a. Show a =&gt; a -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-var">fromShow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099530"><span class="hs-identifier hs-var">major</span></a></span><span>
</span><span id="line-419"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.html#char8"><span class="hs-identifier hs-var">char8</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span>
</span><span id="line-420"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Builder
forall a. Show a =&gt; a -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-var">fromShow</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099531"><span class="hs-identifier hs-var">minor</span></a></span><span>
</span><span id="line-421"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot; 411 Length Required\r\n\r\n&quot;</span></span><span>
</span><span id="line-422"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;411 Length Required\r\n&quot;</span></span><span>
</span><span id="line-423"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#flush"><span class="hs-identifier hs-var">flush</span></a></span><span>
</span><span id="line-424"></span><span>                               </span><span class="hs-special">]</span><span>
</span><span id="line-425"></span><span>            </span><span id="local-6989586621679099539"><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099539"><span class="hs-identifier hs-var">writeEndB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (OutputStream Builder)
</span><a href="#local-6989586621679099420"><span class="hs-identifier hs-var">mkBuffer</span></a></span><span>
</span><span id="line-426"></span><span>            </span><span class="annot"><span class="annottext">Maybe Builder -&gt; OutputStream Builder -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099538"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099539"><span class="hs-identifier hs-var">writeEndB</span></a></span><span>
</span><span id="line-427"></span><span>            </span><span class="annot"><span class="annottext">Maybe Builder -&gt; OutputStream Builder -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe Builder
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099539"><span class="hs-identifier hs-var">writeEndB</span></a></span><span>
</span><span id="line-428"></span><span>            </span><span class="annot"><span class="annottext">LengthRequiredException -&gt; IO b
forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="Snap.Internal.Http.Server.Session.html#terminateSession"><span class="hs-identifier hs-var">terminateSession</span></a></span><span> </span><span class="annot"><span class="annottext">LengthRequiredException
</span><a href="Snap.Internal.Http.Server.Session.html#LengthRequiredException"><span class="hs-identifier hs-var">LengthRequiredException</span></a></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-431"></span><span>        </span><span id="local-6989586621679099449"><span class="annot"><span class="annottext">parseForm :: InputStream ByteString
-&gt; IO (InputStream ByteString, Map ByteString [ByteString])
</span><a href="#local-6989586621679099449"><span class="hs-identifier hs-var hs-var">parseForm</span></a></span></span><span> </span><span id="local-6989586621679099543"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099543"><span class="hs-identifier hs-var">readEnd'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099544"><span class="hs-identifier hs-var">hasForm</span></a></span><span>
</span><span id="line-432"></span><span>                               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IO (InputStream ByteString, Map ByteString [ByteString])
</span><a href="#local-6989586621679099545"><span class="hs-identifier hs-var">getForm</span></a></span><span>
</span><span id="line-433"></span><span>                               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(InputStream ByteString, Map ByteString [ByteString])
-&gt; IO (InputStream ByteString, Map ByteString [ByteString])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099543"><span class="hs-identifier hs-var">readEnd'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map ByteString [ByteString]
forall k a. Map k a
</span><a href="#local-6989586621679099501"><span class="hs-identifier hs-var">emptyParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-435"></span><span>            </span><span id="local-6989586621679099549"><span class="annot"><span class="annottext">trimIt :: ByteString -&gt; ByteString
</span><a href="#local-6989586621679099549"><span class="hs-identifier hs-var hs-var">trimIt</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ByteString, ByteString) -&gt; ByteString
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((ByteString, ByteString) -&gt; ByteString)
-&gt; (ByteString -&gt; (ByteString, ByteString))
-&gt; ByteString
-&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; ByteString -&gt; (ByteString, ByteString)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#spanEnd"><span class="hs-identifier hs-var">S.spanEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; (ByteString, ByteString))
-&gt; (ByteString -&gt; ByteString)
-&gt; ByteString
-&gt; (ByteString, ByteString)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#takeWhile"><span class="hs-identifier hs-var">S.takeWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">';'</span></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>                          </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#dropWhile"><span class="hs-identifier hs-var">S.dropWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>            </span><span id="local-6989586621679099556"><span class="annot"><span class="annottext">mbCT :: Maybe ByteString
</span><a href="#local-6989586621679099556"><span class="hs-identifier hs-var hs-var">mbCT</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><a href="#local-6989586621679099549"><span class="hs-identifier hs-var">trimIt</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; Maybe ByteString -&gt; Maybe ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders -&gt; Maybe ByteString
</span><a href="Snap.Internal.Http.Server.Parser.html#getStdContentType"><span class="hs-identifier hs-var">getStdContentType</span></a></span><span> </span><span class="annot"><span class="annottext">StandardHeaders
</span><a href="#local-6989586621679099457"><span class="hs-identifier hs-var">stdHdrs</span></a></span><span>
</span><span id="line-438"></span><span>            </span><span id="local-6989586621679099544"><span class="annot"><span class="annottext">hasForm :: Bool
</span><a href="#local-6989586621679099544"><span class="hs-identifier hs-var hs-var">hasForm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679099556"><span class="hs-identifier hs-var">mbCT</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Maybe ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;application/x-www-form-urlencoded&quot;</span></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span>            </span><span id="local-6989586621679099563"><span class="annot"><span class="annottext">mAX_POST_BODY_SIZE :: Int64
</span><a href="#local-6989586621679099563"><span class="hs-identifier hs-var hs-var">mAX_POST_BODY_SIZE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">1024</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>            </span><span id="local-6989586621679099545"><span class="annot"><span class="annottext">getForm :: IO (InputStream ByteString, Map ByteString [ByteString])
</span><a href="#local-6989586621679099545"><span class="hs-identifier hs-var hs-var">getForm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-443"></span><span>                </span><span id="local-6989586621679099569"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099569"><span class="hs-identifier hs-var">readEnd''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; InputStream ByteString -&gt; IO (InputStream ByteString)
</span><span class="hs-identifier hs-var">Streams.throwIfProducesMoreThan</span></span><span>
</span><span id="line-444"></span><span>                               </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679099563"><span class="hs-identifier hs-var">mAX_POST_BODY_SIZE</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099543"><span class="hs-identifier hs-var">readEnd'</span></a></span><span>
</span><span id="line-445"></span><span>                </span><span id="local-6989586621679099570"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099570"><span class="hs-identifier hs-var">contents</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#concat"><span class="hs-identifier hs-var">S.concat</span></a></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; IO [ByteString] -&gt; IO ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString -&gt; IO [ByteString]
forall a. InputStream a -&gt; IO [a]
</span><span class="hs-identifier hs-var">Streams.toList</span></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099569"><span class="hs-identifier hs-var">readEnd''</span></a></span><span>
</span><span id="line-446"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099572"><span class="annot"><span class="annottext">postParams :: Map ByteString [ByteString]
</span><a href="#local-6989586621679099572"><span class="hs-identifier hs-var hs-var">postParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Map ByteString [ByteString]
</span><span class="hs-identifier hs-var">parseUrlEncoded</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099570"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-447"></span><span>                </span><span id="local-6989586621679099573"><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099573"><span class="hs-identifier hs-var">finalReadEnd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; IO (InputStream ByteString)
forall c. [c] -&gt; IO (InputStream c)
</span><span class="hs-identifier hs-var">Streams.fromList</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099570"><span class="hs-identifier hs-var">contents</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-448"></span><span>                </span><span class="annot"><span class="annottext">(InputStream ByteString, Map ByteString [ByteString])
-&gt; IO (InputStream ByteString, Map ByteString [ByteString])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099573"><span class="hs-identifier hs-var">finalReadEnd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map ByteString [ByteString]
</span><a href="#local-6989586621679099572"><span class="hs-identifier hs-var">postParams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>    </span><span class="hs-comment">----------------------------------------------------------------------</span><span>
</span><span id="line-451"></span><span>    </span><span id="local-6989586621679099455"><span class="annot"><span class="annottext">checkConnectionClose :: (a, b) -&gt; Maybe a -&gt; IO ()
</span><a href="#local-6989586621679099455"><span class="hs-identifier hs-var hs-var">checkConnectionClose</span></a></span></span><span> </span><span id="local-6989586621679099598"><span class="annot"><span class="annottext">(a, b)
</span><a href="#local-6989586621679099598"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679099599"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679099599"><span class="hs-identifier hs-var">connection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>        </span><span class="hs-comment">-- For HTTP/1.1: if there is an explicit Connection: close, we'll close</span><span>
</span><span id="line-453"></span><span>        </span><span class="hs-comment">-- the socket later.</span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-455"></span><span>        </span><span class="hs-comment">-- For HTTP/1.0: if there is no explicit Connection: Keep-Alive,</span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-comment">-- close the socket later.</span><span>
</span><span id="line-457"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099602"><span class="annot"><span class="annottext">v :: Maybe (CI a)
</span><a href="#local-6989586621679099602"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; CI a
forall s. FoldCase s =&gt; s -&gt; CI s
</span><span class="hs-identifier hs-var">CI.mk</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; CI a) -&gt; Maybe a -&gt; Maybe (CI a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679099599"><span class="hs-identifier hs-var">connection</span></a></span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, b)
</span><a href="#local-6989586621679099598"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">(a, b) -&gt; (a, b) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CI a)
</span><a href="#local-6989586621679099602"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CI a) -&gt; Maybe (CI a) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CI a -&gt; Maybe (CI a)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CI a
</span><span class="hs-string">&quot;close&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span>
</span><span id="line-459"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, b)
</span><a href="#local-6989586621679099598"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">(a, b) -&gt; (a, b) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CI a)
</span><a href="#local-6989586621679099602"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CI a) -&gt; Maybe (CI a) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">CI a -&gt; Maybe (CI a)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CI a
</span><span class="hs-string">&quot;keep-alive&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-460"></span><span>              </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099400"><span class="hs-identifier hs-var">forceConnectionClose</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099443"><span class="hs-pragma hs-type">badRequestWithNoHost</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-464"></span><span>    </span><span id="local-6989586621679098845"><span class="annot"><a href="#local-6989586621679099443"><span class="hs-identifier hs-type">badRequestWithNoHost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098845"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-465"></span><span>    </span><span id="local-6989586621679099443"><span class="annot"><span class="annottext">badRequestWithNoHost :: forall a. IO a
</span><a href="#local-6989586621679099443"><span class="hs-identifier hs-var hs-var">badRequestWithNoHost</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-466"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099612"><span class="annot"><span class="annottext">msg :: Builder
</span><a href="#local-6989586621679099612"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Builder] -&gt; Builder
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="hs-special">[</span><span>
</span><span id="line-467"></span><span>                    </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/1.1 400 Bad Request\r\n\r\n&quot;</span></span><span>
</span><span id="line-468"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;400 Bad Request: HTTP/1.1 request with no &quot;</span></span><span>
</span><span id="line-469"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Host header\r\n&quot;</span></span><span>
</span><span id="line-470"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#flush"><span class="hs-identifier hs-var">flush</span></a></span><span>
</span><span id="line-471"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-472"></span><span>        </span><span id="local-6989586621679099613"><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099613"><span class="hs-identifier hs-var">writeEndB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (OutputStream Builder)
</span><a href="#local-6989586621679099420"><span class="hs-identifier hs-var">mkBuffer</span></a></span><span>
</span><span id="line-473"></span><span>        </span><span class="annot"><span class="annottext">Maybe Builder -&gt; OutputStream Builder -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099612"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099613"><span class="hs-identifier hs-var">writeEndB</span></a></span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="annottext">Maybe Builder -&gt; OutputStream Builder -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe Builder
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099613"><span class="hs-identifier hs-var">writeEndB</span></a></span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><span class="annottext">BadRequestException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="Snap.Internal.Http.Server.Session.html#terminateSession"><span class="hs-identifier hs-var">terminateSession</span></a></span><span> </span><span class="annot"><span class="annottext">BadRequestException
</span><a href="Snap.Internal.Http.Server.Session.html#BadRequestException"><span class="hs-identifier hs-var">BadRequestException</span></a></span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099614"><span class="hs-pragma hs-type">checkExpect100Continue</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-479"></span><span>    </span><span id="local-6989586621679099614"><span class="annot"><span class="annottext">checkExpect100Continue :: Request -&gt; IO ()
</span><a href="#local-6989586621679099614"><span class="hs-identifier hs-var hs-var">checkExpect100Continue</span></a></span></span><span> </span><span id="local-6989586621679099625"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099625"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CI ByteString -&gt; Request -&gt; Maybe ByteString
forall a. HasHeaders a =&gt; CI ByteString -&gt; a -&gt; Maybe ByteString
</span><span class="hs-identifier hs-var">getHeader</span></span><span> </span><span class="annot"><span class="annottext">CI ByteString
</span><span class="hs-string">&quot;expect&quot;</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099625"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Maybe ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;100-continue&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-481"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099631"><span class="annot"><span class="annottext">v :: ByteString
</span><a href="#local-6989586621679099631"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Request -&gt; HttpVersion
</span><span class="hs-identifier hs-var">rqVersion</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099625"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; HttpVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/1.1&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/1.0&quot;</span></span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099637"><span class="annot"><span class="annottext">hl :: Builder
</span><a href="#local-6989586621679099637"><span class="hs-identifier hs-var hs-var">hl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099631"><span class="hs-identifier hs-var">v</span></a></span><span>                       </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-484"></span><span>                     </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot; 100 Continue\r\n\r\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; Builder -&gt; Builder
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>
</span><span id="line-485"></span><span>                     </span><span class="annot"><span class="annottext">Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#flush"><span class="hs-identifier hs-var">flush</span></a></span><span>
</span><span id="line-486"></span><span>            </span><span id="local-6989586621679099638"><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099638"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (OutputStream Builder)
</span><a href="#local-6989586621679099420"><span class="hs-identifier hs-var">mkBuffer</span></a></span><span>
</span><span id="line-487"></span><span>            </span><span class="annot"><span class="annottext">Maybe Builder -&gt; OutputStream Builder -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099637"><span class="hs-identifier hs-var">hl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099638"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099427"><span class="hs-pragma hs-type">processRequest</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-491"></span><span>    </span><span id="local-6989586621679099427"><span class="annot"><span class="annottext">processRequest :: ParseHook hookState
</span><a href="#local-6989586621679099427"><span class="hs-identifier hs-var hs-var">processRequest</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099649"><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099649"><span class="hs-identifier hs-var">hookState</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099650"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099650"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;httpSession/processRequest&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-492"></span><span>        </span><span class="hs-comment">-- successfully parsed a request, so restart the timer</span><span>
</span><span id="line-493"></span><span>        </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099414"><span class="hs-identifier hs-var">tickle</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Int) -&gt; IO ()) -&gt; (Int -&gt; Int) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#max"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099380"><span class="hs-identifier hs-var">defaultTimeout</span></a></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span>        </span><span class="hs-comment">-- check for Expect: 100-continue</span><span>
</span><span id="line-496"></span><span>        </span><span class="annot"><span class="annottext">Request -&gt; IO ()
</span><a href="#local-6989586621679099614"><span class="hs-identifier hs-var">checkExpect100Continue</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099650"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-497"></span><span>        </span><span id="local-6989586621679099652"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099652"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef hookState -&gt; Request -&gt; IO Bool
</span><a href="#local-6989586621679099653"><span class="hs-identifier hs-var">runServerHandler</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099649"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099650"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-498"></span><span>               </span><span class="annot"><span class="annottext">IO Bool -&gt; [Handler Bool] -&gt; IO Bool
forall a. IO a -&gt; [Handler a] -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html#catches"><span class="hs-operator hs-var">`E.catches`</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">(EscapeSnap -&gt; IO Bool) -&gt; Handler Bool
forall a e. Exception e =&gt; (e -&gt; IO a) -&gt; Handler a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html#Handler"><span class="hs-identifier hs-var">Handler</span></a></span><span> </span><span class="annot"><span class="annottext">((EscapeSnap -&gt; IO Bool) -&gt; Handler Bool)
-&gt; (EscapeSnap -&gt; IO Bool) -&gt; Handler Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState -&gt; EscapeSnap -&gt; IO Bool
</span><a href="#local-6989586621679099654"><span class="hs-identifier hs-var">escapeSnapHandler</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099649"><span class="hs-identifier hs-var">hookState</span></a></span><span>
</span><span id="line-499"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO Bool) -&gt; Handler Bool
forall a e. Exception e =&gt; (e -&gt; IO a) -&gt; Handler a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html#Handler"><span class="hs-identifier hs-var">Handler</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeException -&gt; IO Bool) -&gt; Handler Bool)
-&gt; (SomeException -&gt; IO Bool) -&gt; Handler Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-500"></span><span>                             </span><span class="annot"><span class="annottext">IORef hookState
-&gt; ByteString -&gt; Request -&gt; SomeException -&gt; IO Bool
forall a.
IORef hookState -&gt; ByteString -&gt; Request -&gt; SomeException -&gt; IO a
</span><a href="#local-6989586621679099655"><span class="hs-identifier hs-var">catchUserException</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099649"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;user handler&quot;</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099650"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-501"></span><span>                           </span><span class="hs-special">]</span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099652"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-503"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099402"><span class="hs-identifier hs-var">isNewConnection</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-504"></span><span>                  </span><span class="hs-comment">-- the timer resets to its default value here.</span><span>
</span><span id="line-505"></span><span>                  </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099379"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-506"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; IO ()) -&gt; () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099653"><span class="hs-pragma hs-type">runServerHandler</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-510"></span><span>    </span><span id="local-6989586621679099653"><span class="annot"><span class="annottext">runServerHandler :: IORef hookState -&gt; Request -&gt; IO Bool
</span><a href="#local-6989586621679099653"><span class="hs-identifier hs-var hs-var">runServerHandler</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099671"><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099671"><span class="hs-identifier hs-var">hookState</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099672"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;httpSession/runServerHandler&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-511"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679099673"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099673"><span class="hs-identifier hs-var">req0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099674"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099674"><span class="hs-identifier hs-var">rsp0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ServerHandler hookState
</span><a href="#local-6989586621679099376"><span class="hs-identifier hs-var">serverHandler</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfig hookState
</span><a href="#local-6989586621679099377"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">PerSessionData
</span><a href="#local-6989586621679099378"><span class="hs-identifier hs-var">sessionData</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-512"></span><span>        </span><span class="annot"><span class="annottext">UserHandlerFinishedHook hookState
</span><a href="#local-6989586621679099392"><span class="hs-identifier hs-var">userHandlerFinishedHook</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099671"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099674"><span class="hs-identifier hs-var">rsp0</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>        </span><span class="hs-comment">-- check whether we should close the connection after sending the</span><span>
</span><span id="line-515"></span><span>        </span><span class="hs-comment">-- response</span><span>
</span><span id="line-516"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099675"><span class="annot"><span class="annottext">v :: HttpVersion
</span><a href="#local-6989586621679099675"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; HttpVersion
</span><span class="hs-identifier hs-var">rqVersion</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-517"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099679"><span class="annot"><span class="annottext">is_1_0 :: Bool
</span><a href="#local-6989586621679099679"><span class="hs-identifier hs-var hs-var">is_1_0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099675"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; HttpVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>        </span><span id="local-6989586621679099680"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099680"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099679"><span class="hs-identifier hs-var">is_1_0</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Word64 -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Word64 -&gt; Bool) -&gt; Maybe Word64 -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Response -&gt; Maybe Word64
</span><span class="hs-identifier hs-var">rspContentLength</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099674"><span class="hs-identifier hs-var">rsp0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; IO Bool) -&gt; Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-520"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; IO Bool
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099400"><span class="hs-identifier hs-var">forceConnectionClose</span></a></span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>        </span><span class="hs-comment">-- skip unread portion of request body if rspTransformingRqBody is not</span><span>
</span><span id="line-523"></span><span>        </span><span class="hs-comment">-- true</span><span>
</span><span id="line-524"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response -&gt; Bool
</span><span class="hs-identifier hs-var">rspTransformingRqBody</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099674"><span class="hs-identifier hs-var">rsp0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString -&gt; IO ()
forall a. InputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.skipToEof</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; InputStream ByteString
</span><span class="hs-identifier hs-var">rqBody</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>
</span><span id="line-526"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099685"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099685"><span class="hs-identifier hs-var">date</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ByteString
</span><a href="Snap.Internal.Http.Server.Date.html#getDateString"><span class="hs-identifier hs-var">getDateString</span></a></span><span>
</span><span id="line-527"></span><span>        </span><span id="local-6989586621679099686"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099686"><span class="hs-identifier hs-var">rsp1</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Request -&gt; Response -&gt; IO Response
</span><span class="hs-identifier hs-var">fixupResponse</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099674"><span class="hs-identifier hs-var">rsp0</span></a></span><span>
</span><span id="line-528"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679099689"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099689"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099690"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099690"><span class="hs-identifier hs-var">cc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ByteString -&gt; Bool -&gt; Headers -&gt; (Headers, Bool)
</span><a href="#local-6989586621679099691"><span class="hs-identifier hs-var">addDateAndServerHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099679"><span class="hs-identifier hs-var">is_1_0</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099685"><span class="hs-identifier hs-var">date</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099680"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="annot"><span class="annottext">(Headers -&gt; (Headers, Bool)) -&gt; Headers -&gt; (Headers, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-529"></span><span>                            </span><span class="annot"><span class="annottext">Response -&gt; Headers
forall a. HasHeaders a =&gt; a -&gt; Headers
</span><span class="hs-identifier hs-var">headers</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099686"><span class="hs-identifier hs-var">rsp1</span></a></span><span>
</span><span id="line-530"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099693"><span class="annot"><span class="annottext">rsp :: Response
</span><a href="#local-6989586621679099693"><span class="hs-identifier hs-var hs-var">rsp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Headers -&gt; Headers) -&gt; Response -&gt; Response
forall a. HasHeaders a =&gt; (Headers -&gt; Headers) -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">updateHeaders</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Headers -&gt; Headers -&gt; Headers
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099689"><span class="hs-identifier hs-var">hdrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099686"><span class="hs-identifier hs-var">rsp1</span></a></span><span>
</span><span id="line-531"></span><span>        </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099400"><span class="hs-identifier hs-var">forceConnectionClose</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099690"><span class="hs-identifier hs-var">cc'</span></a></span><span>
</span><span id="line-532"></span><span>        </span><span id="local-6989586621679099694"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099694"><span class="hs-identifier hs-var">bytesSent</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Request -&gt; Response -&gt; IO Word64
</span><a href="#local-6989586621679099695"><span class="hs-identifier hs-var">sendResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099693"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="annot"><span class="annottext">IO Word64 -&gt; (SomeException -&gt; IO Word64) -&gt; IO Word64
forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.html#catch"><span class="hs-operator hs-var">`E.catch`</span></a></span><span>
</span><span id="line-533"></span><span>                     </span><span class="annot"><span class="annottext">IORef hookState
-&gt; ByteString -&gt; Request -&gt; SomeException -&gt; IO Word64
forall a.
IORef hookState -&gt; ByteString -&gt; Request -&gt; SomeException -&gt; IO a
</span><a href="#local-6989586621679099655"><span class="hs-identifier hs-var">catchUserException</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099671"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;sending-response&quot;</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-534"></span><span>        </span><span class="annot"><span class="annottext">UserHandlerFinishedHook hookState
</span><a href="#local-6989586621679099394"><span class="hs-identifier hs-var">dataFinishedHook</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099671"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099672"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099693"><span class="hs-identifier hs-var">rsp</span></a></span><span>
</span><span id="line-535"></span><span>        </span><span class="annot"><span class="annottext">Request -&gt; Response -&gt; Word64 -&gt; IO ()
</span><a href="#local-6989586621679099385"><span class="hs-identifier hs-var">logAccess</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099673"><span class="hs-identifier hs-var">req0</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099693"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099694"><span class="hs-identifier hs-var">bytesSent</span></a></span><span>
</span><span id="line-536"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; IO Bool) -&gt; Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099690"><span class="hs-identifier hs-var">cc'</span></a></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-539"></span><span>    </span><span id="local-6989586621679099691"><span class="annot"><span class="annottext">addDateAndServerHeaders :: Bool -&gt; ByteString -&gt; Bool -&gt; Headers -&gt; (Headers, Bool)
</span><a href="#local-6989586621679099691"><span class="hs-identifier hs-var hs-var">addDateAndServerHeaders</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099698"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099698"><span class="hs-identifier hs-var">is1_0</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099699"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099699"><span class="hs-identifier hs-var">date</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099700"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099700"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099701"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099701"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-540"></span><span>        </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;addDateAndServerHeaders&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-541"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679099705"><span class="annot"><span class="annottext">[(ByteString, ByteString)]
</span><a href="#local-6989586621679099705"><span class="hs-identifier hs-var">hdrs'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099706"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099706"><span class="hs-identifier hs-var">newcc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ByteString, ByteString)]
-&gt; Bool
-&gt; Bool
-&gt; [(ByteString, ByteString)]
-&gt; ([(ByteString, ByteString)], Bool)
forall {a}.
(Eq a, IsString a) =&gt;
[(a, ByteString)]
-&gt; Bool -&gt; Bool -&gt; [(a, ByteString)] -&gt; ([(a, ByteString)], Bool)
</span><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;date&quot;</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099699"><span class="hs-identifier hs-var">date</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099700"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-542"></span><span>                                 </span><span class="annot"><span class="annottext">([(ByteString, ByteString)] -&gt; ([(ByteString, ByteString)], Bool))
-&gt; [(ByteString, ByteString)] -&gt; ([(ByteString, ByteString)], Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Headers -&gt; [(ByteString, ByteString)]
</span><span class="hs-identifier hs-var">H.unsafeToCaseFoldedList</span></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099701"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-543"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(ByteString, ByteString)] -&gt; Headers
</span><span class="hs-identifier hs-var">H.unsafeFromCaseFoldedList</span></span><span> </span><span class="annot"><span class="annottext">[(ByteString, ByteString)]
</span><a href="#local-6989586621679099705"><span class="hs-identifier hs-var">hdrs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099706"><span class="hs-identifier hs-var">newcc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-545"></span><span>        </span><span class="hs-comment">-- N.B.: here we know the date header has already been removed by</span><span>
</span><span id="line-546"></span><span>        </span><span class="hs-comment">-- &quot;fixupResponse&quot;.</span><span>
</span><span id="line-547"></span><span>        </span><span id="local-6989586621679099707"><span class="annot"><span class="annottext">go :: [(a, ByteString)]
-&gt; Bool -&gt; Bool -&gt; [(a, ByteString)] -&gt; ([(a, ByteString)], Bool)
</span><a href="#local-6989586621679099707"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099720"><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099720"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099721"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099721"><span class="hs-identifier hs-var">seenServer</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099722"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099722"><span class="hs-identifier hs-var">connClose</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-548"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099724"><span class="annot"><span class="annottext">l1 :: [(a, ByteString)]
</span><a href="#local-6989586621679099724"><span class="hs-identifier hs-var hs-var">l1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099721"><span class="hs-identifier hs-var">seenServer</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099720"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-string">&quot;server&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="Snap.Internal.Http.Server.Session.html#sERVER_HEADER"><span class="hs-identifier hs-var">sERVER_HEADER</span></a></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(a, ByteString) -&gt; [(a, ByteString)] -&gt; [(a, ByteString)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099720"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-549"></span><span>                </span><span class="hs-glyph">!</span><span id="local-6989586621679099728"><span class="annot"><span class="annottext">l2 :: [(a, ByteString)]
</span><a href="#local-6989586621679099728"><span class="hs-identifier hs-var hs-var">l2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099722"><span class="hs-identifier hs-var">connClose</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-string">&quot;connection&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;close&quot;</span></span><span class="hs-special">)</span><span class="annot"><span class="annottext">(a, ByteString) -&gt; [(a, ByteString)] -&gt; [(a, ByteString)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099724"><span class="hs-identifier hs-var">l1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099724"><span class="hs-identifier hs-var">l1</span></a></span><span>
</span><span id="line-550"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099728"><span class="hs-identifier hs-var">l2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099722"><span class="hs-identifier hs-var">connClose</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>        </span><span class="annot"><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679099729"><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099729"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679099730"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099730"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679099731"><span class="annot"><span class="annottext">x :: (a, ByteString)
</span><a href="#local-6989586621679099731"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-string">&quot;server&quot;</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679099732"><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099732"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
-&gt; Bool -&gt; Bool -&gt; [(a, ByteString)] -&gt; ([(a, ByteString)], Bool)
</span><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, ByteString)
</span><a href="#local-6989586621679099731"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">(a, ByteString) -&gt; [(a, ByteString)] -&gt; [(a, ByteString)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099729"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099730"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099732"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-552"></span><span>        </span><span class="annot"><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679099733"><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099733"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679099734"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099734"><span class="hs-identifier hs-var">seenServer</span></a></span></span><span> </span><span id="local-6989586621679099735"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099735"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679099736"><span class="annot"><span class="annottext">x :: (a, ByteString)
</span><a href="#local-6989586621679099736"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-string">&quot;connection&quot;</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099737"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099737"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679099738"><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099738"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099735"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
-&gt; Bool -&gt; Bool -&gt; [(a, ByteString)] -&gt; ([(a, ByteString)], Bool)
</span><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099733"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099734"><span class="hs-identifier hs-var">seenServer</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099735"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099738"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-554"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099737"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;close&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099698"><span class="hs-identifier hs-var">is1_0</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099737"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;keep-alive&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-555"></span><span>                     </span><span class="annot"><span class="annottext">[(a, ByteString)]
-&gt; Bool -&gt; Bool -&gt; [(a, ByteString)] -&gt; ([(a, ByteString)], Bool)
</span><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099733"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099734"><span class="hs-identifier hs-var">seenServer</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099738"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-556"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
-&gt; Bool -&gt; Bool -&gt; [(a, ByteString)] -&gt; ([(a, ByteString)], Bool)
</span><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, ByteString)
</span><a href="#local-6989586621679099736"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">(a, ByteString) -&gt; [(a, ByteString)] -&gt; [(a, ByteString)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099733"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099734"><span class="hs-identifier hs-var">seenServer</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099735"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099738"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-557"></span><span>        </span><span class="annot"><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span id="local-6989586621679099739"><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099739"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679099740"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099740"><span class="hs-identifier hs-var">seenServer</span></a></span></span><span> </span><span id="local-6989586621679099741"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099741"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679099742"><span class="annot"><span class="annottext">(a, ByteString)
</span><a href="#local-6989586621679099742"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679099743"><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099743"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
-&gt; Bool -&gt; Bool -&gt; [(a, ByteString)] -&gt; ([(a, ByteString)], Bool)
</span><a href="#local-6989586621679099707"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, ByteString)
</span><a href="#local-6989586621679099742"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">(a, ByteString) -&gt; [(a, ByteString)] -&gt; [(a, ByteString)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099739"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099740"><span class="hs-identifier hs-var">seenServer</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099741"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, ByteString)]
</span><a href="#local-6989586621679099743"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-560"></span><span>    </span><span id="local-6989586621679099654"><span class="annot"><span class="annottext">escapeSnapHandler :: IORef hookState -&gt; EscapeSnap -&gt; IO Bool
</span><a href="#local-6989586621679099654"><span class="hs-identifier hs-var hs-var">escapeSnapHandler</span></a></span></span><span> </span><span id="local-6989586621679099749"><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099749"><span class="hs-identifier hs-var">hookState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">EscapeHttp</span></span><span> </span><span id="local-6989586621679099751"><span class="annot"><span class="annottext">EscapeHttpHandler
</span><a href="#local-6989586621679099751"><span class="hs-identifier hs-var">escapeHandler</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>        </span><span class="annot"><span class="annottext">EscapeSnapHook hookState
</span><a href="#local-6989586621679099398"><span class="hs-identifier hs-var">escapeHook</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099749"><span class="hs-identifier hs-var">hookState</span></a></span><span>
</span><span id="line-562"></span><span>        </span><span class="annot"><span class="annottext">IO (OutputStream Builder)
</span><a href="#local-6989586621679099420"><span class="hs-identifier hs-var">mkBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">IO (OutputStream Builder)
-&gt; (OutputStream Builder -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">EscapeHttpHandler
</span><a href="#local-6989586621679099751"><span class="hs-identifier hs-var">escapeHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099414"><span class="hs-identifier hs-var">tickle</span></a></span><span> </span><span class="annot"><span class="annottext">InputStream ByteString
</span><a href="#local-6989586621679099412"><span class="hs-identifier hs-var">readEnd</span></a></span><span>
</span><span id="line-563"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><a href="#local-6989586621679099654"><span class="hs-identifier hs-var">escapeSnapHandler</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TerminateConnection</span></span><span> </span><span id="local-6989586621679099753"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099753"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO Bool
forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="Snap.Internal.Http.Server.Session.html#terminateSession"><span class="hs-identifier hs-var">terminateSession</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099753"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-567"></span><span>    </span><span id="local-6989586621679098896"><span class="annot"><a href="#local-6989586621679099655"><span class="hs-identifier hs-type">catchUserException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098814"><span class="hs-identifier hs-type">hookState</span></a></span><span>
</span><span id="line-568"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-569"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-570"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span>
</span><span id="line-571"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098896"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-572"></span><span>    </span><span id="local-6989586621679099655"><span class="annot"><span class="annottext">catchUserException :: forall a.
IORef hookState -&gt; ByteString -&gt; Request -&gt; SomeException -&gt; IO a
</span><a href="#local-6989586621679099655"><span class="hs-identifier hs-var hs-var">catchUserException</span></a></span></span><span> </span><span id="local-6989586621679099760"><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099760"><span class="hs-identifier hs-var">hookState</span></a></span></span><span> </span><span id="local-6989586621679099761"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099761"><span class="hs-identifier hs-var">phase</span></a></span></span><span> </span><span id="local-6989586621679099762"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099762"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679099763"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099763"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-573"></span><span>        </span><span class="annot"><span class="annottext">Builder -&gt; IO ()
</span><a href="#local-6989586621679099387"><span class="hs-identifier hs-var">logError</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder -&gt; IO ()) -&gt; Builder -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Builder] -&gt; Builder
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="hs-special">[</span><span>
</span><span id="line-574"></span><span>            </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Exception leaked to httpSession during phase '&quot;</span></span><span>
</span><span id="line-575"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099761"><span class="hs-identifier hs-var">phase</span></a></span><span>
</span><span id="line-576"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;': \n&quot;</span></span><span>
</span><span id="line-577"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Request -&gt; SomeException -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#requestErrorMessage"><span class="hs-identifier hs-var">requestErrorMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099762"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099763"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-578"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-579"></span><span>        </span><span class="hs-comment">-- Note: the handler passed to httpSession needs to catch its own</span><span>
</span><span id="line-580"></span><span>        </span><span class="hs-comment">-- exceptions if it wants to avoid an ungracious exit here.</span><span>
</span><span id="line-581"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO ()
</span><a href="Snap.Internal.Http.Server.Common.html#eatException"><span class="hs-identifier hs-var">eatException</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ExceptionHook hookState
</span><a href="#local-6989586621679099396"><span class="hs-identifier hs-var">exceptionHook</span></a></span><span> </span><span class="annot"><span class="annottext">IORef hookState
</span><a href="#local-6989586621679099760"><span class="hs-identifier hs-var">hookState</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099763"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="annottext">SomeException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="Snap.Internal.Http.Server.Session.html#terminateSession"><span class="hs-identifier hs-var">terminateSession</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099763"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-583"></span><span>
</span><span id="line-584"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-585"></span><span>    </span><span class="annot"><a href="#local-6989586621679099695"><span class="hs-identifier hs-type">sendResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-586"></span><span>    </span><span id="local-6989586621679099695"><span class="annot"><span class="annottext">sendResponse :: Request -&gt; Response -&gt; IO Word64
</span><a href="#local-6989586621679099695"><span class="hs-identifier hs-var hs-var">sendResponse</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099765"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099765"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099766"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-pragma">{-# SCC</span><span> </span><span class="hs-pragma">&quot;httpSession/sendResponse&quot;</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-587"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099767"><span class="annot"><span class="annottext">v :: HttpVersion
</span><a href="#local-6989586621679099767"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; HttpVersion
</span><span class="hs-identifier hs-var">rqVersion</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099765"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-588"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099769"><span class="annot"><span class="annottext">hdrs' :: Headers
</span><a href="#local-6989586621679099769"><span class="hs-identifier hs-var hs-var">hdrs'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response -&gt; Headers -&gt; Headers
</span><a href="Snap.Internal.Http.Server.Session.html#renderCookies"><span class="hs-identifier hs-var">renderCookies</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response -&gt; Headers
forall a. HasHeaders a =&gt; a -&gt; Headers
</span><span class="hs-identifier hs-var">headers</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099771"><span class="annot"><span class="annottext">code :: Int
</span><a href="#local-6989586621679099771"><span class="hs-identifier hs-var hs-var">code</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response -&gt; Int
</span><span class="hs-identifier hs-var">rspStatus</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span>
</span><span id="line-590"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099773"><span class="annot"><span class="annottext">body :: ResponseBody
</span><a href="#local-6989586621679099773"><span class="hs-identifier hs-var hs-var">body</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response -&gt; ResponseBody
</span><span class="hs-identifier hs-var">rspBody</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span>
</span><span id="line-591"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099780"><span class="annot"><span class="annottext">needChunked :: Bool
</span><a href="#local-6989586621679099780"><span class="hs-identifier hs-var hs-var">needChunked</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; Method
</span><span class="hs-identifier hs-var">rqMethod</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099765"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Method -&gt; Method -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Method
</span><span class="hs-identifier hs-var">HEAD</span></span><span>
</span><span id="line-592"></span><span>                            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word64 -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Response -&gt; Maybe Word64
</span><span class="hs-identifier hs-var">rspContentLength</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-593"></span><span>                            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099771"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">204</span></span><span>
</span><span id="line-594"></span><span>                            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099771"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">304</span></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679099783"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099783"><span class="hs-identifier hs-var">hdrs''</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099784"><span class="annot"><span class="annottext">ResponseBody
</span><a href="#local-6989586621679099784"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099785"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099785"><span class="hs-identifier hs-var">shouldClose</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099780"><span class="hs-identifier hs-var">needChunked</span></a></span><span>
</span><span id="line-597"></span><span>                                             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Request -&gt; Headers -&gt; ResponseBody -&gt; (Headers, ResponseBody, Bool)
</span><a href="#local-6989586621679099786"><span class="hs-identifier hs-var">noCL</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099765"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099769"><span class="hs-identifier hs-var">hdrs'</span></a></span><span> </span><span class="annot"><span class="annottext">ResponseBody
</span><a href="#local-6989586621679099773"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-598"></span><span>                                             </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099769"><span class="hs-identifier hs-var">hdrs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResponseBody
</span><a href="#local-6989586621679099773"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>
</span><span id="line-600"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099785"><span class="hs-identifier hs-var">shouldClose</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#writeIORef"><span class="hs-identifier hs-var">writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679099400"><span class="hs-identifier hs-var">forceConnectionClose</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; IO ()) -&gt; Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-601"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099787"><span class="annot"><span class="annottext">hdrPrim :: FixedPrim ()
</span><a href="#local-6989586621679099787"><span class="hs-identifier hs-var hs-var">hdrPrim</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; Response -&gt; Headers -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#mkHeaderPrim"><span class="hs-identifier hs-var">mkHeaderPrim</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099767"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099783"><span class="hs-identifier hs-var">hdrs''</span></a></span><span>
</span><span id="line-602"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099789"><span class="annot"><span class="annottext">hlen :: Int
</span><a href="#local-6989586621679099789"><span class="hs-identifier hs-var hs-var">hlen</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixedPrim () -&gt; Int
forall a. FixedPrim a -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#size"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim ()
</span><a href="#local-6989586621679099787"><span class="hs-identifier hs-var">hdrPrim</span></a></span><span>
</span><span id="line-603"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099790"><span class="annot"><span class="annottext">headerBuilder :: Builder
</span><a href="#local-6989586621679099790"><span class="hs-identifier hs-var hs-var">headerBuilder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FixedPrim () -&gt; () -&gt; Builder
forall a. FixedPrim a -&gt; a -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.html#primFixed"><span class="hs-identifier hs-var">primFixed</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim ()
</span><a href="#local-6989586621679099787"><span class="hs-identifier hs-var">hdrPrim</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; Builder) -&gt; () -&gt; Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span>
</span><span id="line-605"></span><span>        </span><span id="local-6989586621679099791"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099791"><span class="hs-identifier hs-var">nBodyBytes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ResponseBody
</span><a href="#local-6989586621679099784"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-606"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Stream</span></span><span> </span><span id="local-6989586621679099793"><span class="annot"><span class="annottext">StreamProc
</span><a href="#local-6989586621679099793"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-607"></span><span>                            </span><span class="annot"><span class="annottext">Builder -&gt; Int -&gt; Response -&gt; StreamProc -&gt; IO Word64
</span><a href="#local-6989586621679099794"><span class="hs-identifier hs-var">whenStream</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099790"><span class="hs-identifier hs-var">headerBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099789"><span class="hs-identifier hs-var">hlen</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="annot"><span class="annottext">StreamProc
</span><a href="#local-6989586621679099793"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-608"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">SendFile</span></span><span> </span><span id="local-6989586621679099796"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679099796"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (Word64, Word64)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-609"></span><span>                            </span><span class="annot"><span class="annottext">Builder -&gt; Response -&gt; String -&gt; Word64 -&gt; IO Word64
</span><a href="#local-6989586621679099797"><span class="hs-identifier hs-var">whenSendFile</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099790"><span class="hs-identifier hs-var">headerBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679099796"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-610"></span><span>                        </span><span class="hs-comment">-- ignore end length here because we know we had a</span><span>
</span><span id="line-611"></span><span>                        </span><span class="hs-comment">-- content-length, use that instead.</span><span>
</span><span id="line-612"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">SendFile</span></span><span> </span><span id="local-6989586621679099798"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679099798"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679099799"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099799"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-613"></span><span>                            </span><span class="annot"><span class="annottext">Builder -&gt; Response -&gt; String -&gt; Word64 -&gt; IO Word64
</span><a href="#local-6989586621679099797"><span class="hs-identifier hs-var">whenSendFile</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099790"><span class="hs-identifier hs-var">headerBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099766"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679099798"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099799"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-614"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; IO Word64
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; IO Word64) -&gt; Word64 -&gt; IO Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099791"><span class="hs-identifier hs-var">nBodyBytes</span></a></span><span>
</span><span id="line-615"></span><span>
</span><span id="line-616"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-617"></span><span>    </span><span class="annot"><a href="#local-6989586621679099786"><span class="hs-identifier hs-type">noCL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-618"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Headers</span></span><span>
</span><span id="line-619"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseBody</span></span><span>
</span><span id="line-620"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Headers</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseBody</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>    </span><span id="local-6989586621679099786"><span class="annot"><span class="annottext">noCL :: Request -&gt; Headers -&gt; ResponseBody -&gt; (Headers, ResponseBody, Bool)
</span><a href="#local-6989586621679099786"><span class="hs-identifier hs-var hs-var">noCL</span></a></span></span><span> </span><span id="local-6989586621679099800"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099800"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679099801"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099801"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span id="local-6989586621679099802"><span class="annot"><span class="annottext">ResponseBody
</span><a href="#local-6989586621679099802"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-622"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099803"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; HttpVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099804"><span class="annot"><span class="annottext">origBody :: StreamProc
</span><a href="#local-6989586621679099804"><span class="hs-identifier hs-var hs-var">origBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResponseBody -&gt; StreamProc
</span><span class="hs-identifier hs-var">rspBodyToEnum</span></span><span> </span><span class="annot"><span class="annottext">ResponseBody
</span><a href="#local-6989586621679099802"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-624"></span><span>                   </span><span id="local-6989586621679099806"><span class="annot"><span class="annottext">body' :: StreamProc
</span><a href="#local-6989586621679099806"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679099807"><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099807"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-625"></span><span>                                 </span><span id="local-6989586621679099808"><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099808"><span class="hs-identifier hs-var">os'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamProc
</span><a href="Snap.Internal.Http.Server.Parser.html#writeChunkedTransferEncoding"><span class="hs-identifier hs-var">writeChunkedTransferEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099807"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-626"></span><span>                                 </span><span class="annot"><span class="annottext">StreamProc
</span><a href="#local-6989586621679099804"><span class="hs-identifier hs-var">origBody</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099808"><span class="hs-identifier hs-var">os'</span></a></span><span>
</span><span id="line-627"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CI ByteString -&gt; ByteString -&gt; Headers -&gt; Headers
</span><span class="hs-identifier hs-var">H.set</span></span><span> </span><span class="annot"><span class="annottext">CI ByteString
</span><span class="hs-string">&quot;transfer-encoding&quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;chunked&quot;</span></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099801"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-628"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StreamProc -&gt; ResponseBody
</span><span class="hs-identifier hs-var">Stream</span></span><span> </span><span class="annot"><span class="annottext">StreamProc
</span><a href="#local-6989586621679099806"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-629"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-631"></span><span>            </span><span class="hs-comment">-- We've already noted that we have to close the socket earlier in</span><span>
</span><span id="line-632"></span><span>            </span><span class="hs-comment">-- runServerHandler.</span><span>
</span><span id="line-633"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099801"><span class="hs-identifier hs-var">hdrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ResponseBody
</span><a href="#local-6989586621679099802"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-634"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-635"></span><span>        </span><span id="local-6989586621679099803"><span class="annot"><span class="annottext">v :: HttpVersion
</span><a href="#local-6989586621679099803"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; HttpVersion
</span><span class="hs-identifier hs-var">rqVersion</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099800"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-636"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099786"><span class="hs-pragma hs-type">noCL</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-637"></span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-comment">-- | If the response contains a content-length, make sure the response body</span><span>
</span><span id="line-640"></span><span>    </span><span class="hs-comment">-- StreamProc doesn't yield more (or fewer) than the given number of bytes.</span><span>
</span><span id="line-641"></span><span>    </span><span class="annot"><a href="#local-6989586621679099810"><span class="hs-identifier hs-type">limitRspBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>                      </span><span class="hs-comment">-- ^ header length</span><span>
</span><span id="line-642"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span>                 </span><span class="hs-comment">-- ^ response</span><span>
</span><span id="line-643"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>  </span><span class="hs-comment">-- ^ write end of socket</span><span>
</span><span id="line-644"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OutputStream</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>    </span><span id="local-6989586621679099810"><span class="annot"><span class="annottext">limitRspBody :: Int
-&gt; Response
-&gt; OutputStream ByteString
-&gt; IO (OutputStream ByteString)
</span><a href="#local-6989586621679099810"><span class="hs-identifier hs-var hs-var">limitRspBody</span></a></span></span><span> </span><span id="local-6989586621679099811"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099811"><span class="hs-identifier hs-var">hlen</span></a></span></span><span> </span><span id="local-6989586621679099812"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099812"><span class="hs-identifier hs-var">rsp</span></a></span></span><span> </span><span id="local-6989586621679099813"><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099813"><span class="hs-identifier hs-var">os</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (OutputStream ByteString)
-&gt; (Word64 -&gt; IO (OutputStream ByteString))
-&gt; Maybe Word64
-&gt; IO (OutputStream ByteString)
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputStream ByteString -&gt; IO (OutputStream ByteString)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099813"><span class="hs-identifier hs-var">os</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; IO (OutputStream ByteString)
forall {a}. Integral a =&gt; a -&gt; IO (OutputStream ByteString)
</span><a href="#local-6989586621679099814"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Word64 -&gt; IO (OutputStream ByteString))
-&gt; Maybe Word64 -&gt; IO (OutputStream ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Response -&gt; Maybe Word64
</span><span class="hs-identifier hs-var">rspContentLength</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099812"><span class="hs-identifier hs-var">rsp</span></a></span><span>
</span><span id="line-646"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-647"></span><span>        </span><span id="local-6989586621679099814"><span class="annot"><span class="annottext">f :: a -&gt; IO (OutputStream ByteString)
</span><a href="#local-6989586621679099814"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679099836"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679099836"><span class="hs-identifier hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; OutputStream ByteString -&gt; IO (OutputStream ByteString)
</span><span class="hs-identifier hs-var">Streams.giveExactly</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099811"><span class="hs-identifier hs-var">hlen</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679099836"><span class="hs-identifier hs-var">cl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099813"><span class="hs-identifier hs-var">os</span></a></span><span>
</span><span id="line-648"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099810"><span class="hs-pragma hs-type">limitRspBody</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-651"></span><span>    </span><span class="annot"><a href="#local-6989586621679099794"><span class="hs-identifier hs-type">whenStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span><span>       </span><span class="hs-comment">-- ^ headers</span><span>
</span><span id="line-652"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>           </span><span class="hs-comment">-- ^ header length</span><span>
</span><span id="line-653"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span>      </span><span class="hs-comment">-- ^ response</span><span>
</span><span id="line-654"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StreamProc</span></span><span>    </span><span class="hs-comment">-- ^ output body</span><span>
</span><span id="line-655"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>      </span><span class="hs-comment">-- ^ returns number of bytes written</span><span>
</span><span id="line-656"></span><span>    </span><span id="local-6989586621679099794"><span class="annot"><span class="annottext">whenStream :: Builder -&gt; Int -&gt; Response -&gt; StreamProc -&gt; IO Word64
</span><a href="#local-6989586621679099794"><span class="hs-identifier hs-var hs-var">whenStream</span></a></span></span><span> </span><span id="local-6989586621679099839"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099839"><span class="hs-identifier hs-var">headerString</span></a></span></span><span> </span><span id="local-6989586621679099840"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099840"><span class="hs-identifier hs-var">hlen</span></a></span></span><span> </span><span id="local-6989586621679099841"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099841"><span class="hs-identifier hs-var">rsp</span></a></span></span><span> </span><span id="local-6989586621679099842"><span class="annot"><span class="annottext">StreamProc
</span><a href="#local-6989586621679099842"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-657"></span><span>        </span><span class="hs-comment">-- note:</span><span>
</span><span id="line-658"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-659"></span><span>        </span><span class="hs-comment">--  * precondition here is that we have a content-length and that we're</span><span>
</span><span id="line-660"></span><span>        </span><span class="hs-comment">--    not using chunked transfer encoding.</span><span>
</span><span id="line-661"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-662"></span><span>        </span><span class="hs-comment">--  * &quot;headerString&quot; includes http status line.</span><span>
</span><span id="line-663"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-664"></span><span>        </span><span class="hs-comment">-- If you're transforming the request body, you have to manage your own</span><span>
</span><span id="line-665"></span><span>        </span><span class="hs-comment">-- timeouts.</span><span>
</span><span id="line-666"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679099845"><span class="annot"><span class="annottext">t :: IO ()
</span><a href="#local-6989586621679099845"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Response -&gt; Bool
</span><span class="hs-identifier hs-var">rspTransformingRqBody</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099841"><span class="hs-identifier hs-var">rsp</span></a></span><span>
</span><span id="line-667"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; IO ()) -&gt; () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; IO ()
</span><a href="#local-6989586621679099414"><span class="hs-identifier hs-var">tickle</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Int) -&gt; IO ()) -&gt; (Int -&gt; Int) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#max"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099380"><span class="hs-identifier hs-var">defaultTimeout</span></a></span><span>
</span><span id="line-669"></span><span>        </span><span id="local-6989586621679099846"><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099846"><span class="hs-identifier hs-var">writeEnd0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString -&gt; IO (OutputStream ByteString)
forall a. OutputStream a -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">Streams.ignoreEof</span></span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099416"><span class="hs-identifier hs-var">writeEnd</span></a></span><span>
</span><span id="line-670"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679099848"><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099848"><span class="hs-identifier hs-var">writeEnd1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099849"><span class="annot"><span class="annottext">IO Int64
</span><a href="#local-6989586621679099849"><span class="hs-identifier hs-var">getCount</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString -&gt; IO (OutputStream ByteString, IO Int64)
</span><span class="hs-identifier hs-var">Streams.countOutput</span></span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099846"><span class="hs-identifier hs-var">writeEnd0</span></a></span><span>
</span><span id="line-671"></span><span>        </span><span id="local-6989586621679099851"><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099851"><span class="hs-identifier hs-var">writeEnd2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Response
-&gt; OutputStream ByteString
-&gt; IO (OutputStream ByteString)
</span><a href="#local-6989586621679099810"><span class="hs-identifier hs-var">limitRspBody</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099840"><span class="hs-identifier hs-var">hlen</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099841"><span class="hs-identifier hs-var">rsp</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099848"><span class="hs-identifier hs-var">writeEnd1</span></a></span><span>
</span><span id="line-672"></span><span>        </span><span id="local-6989586621679099852"><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099852"><span class="hs-identifier hs-var">writeEndB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Buffer -&gt; OutputStream ByteString -&gt; IO (OutputStream Builder)
</span><span class="hs-identifier hs-var">Streams.unsafeBuilderStream</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Buffer -&gt; IO Buffer
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Buffer
</span><a href="#local-6989586621679099375"><span class="hs-identifier hs-var">buffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099851"><span class="hs-identifier hs-var">writeEnd2</span></a></span><span> </span><span class="annot"><span class="annottext">IO (OutputStream Builder)
-&gt; StreamProc -&gt; IO (OutputStream Builder)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span>
</span><span id="line-673"></span><span>                     </span><span class="annot"><span class="annottext">(Builder -&gt; IO Builder) -&gt; StreamProc
forall a b. (a -&gt; IO b) -&gt; OutputStream b -&gt; IO (OutputStream a)
</span><span class="hs-identifier hs-var">Streams.contramapM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679099854"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099854"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679099845"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO Builder -&gt; IO Builder
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Builder -&gt; IO Builder
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099854"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span>        </span><span class="annot"><span class="annottext">Maybe Builder -&gt; OutputStream Builder -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Builder -&gt; Maybe Builder
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099839"><span class="hs-identifier hs-var">headerString</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099852"><span class="hs-identifier hs-var">writeEndB</span></a></span><span>
</span><span id="line-676"></span><span>        </span><span id="local-6989586621679099855"><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099855"><span class="hs-identifier hs-var">writeEnd'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamProc
</span><a href="#local-6989586621679099842"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099852"><span class="hs-identifier hs-var">writeEndB</span></a></span><span>
</span><span id="line-677"></span><span>        </span><span class="annot"><span class="annottext">Maybe Builder -&gt; OutputStream Builder -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe Builder
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream Builder
</span><a href="#local-6989586621679099855"><span class="hs-identifier hs-var">writeEnd'</span></a></span><span>
</span><span id="line-678"></span><span>        </span><span class="hs-comment">-- Just in case the user handler didn't.</span><span>
</span><span id="line-679"></span><span>        </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; OutputStream ByteString -&gt; IO ()
forall a. Maybe a -&gt; OutputStream a -&gt; IO ()
</span><span class="hs-identifier hs-var">Streams.write</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">OutputStream ByteString
</span><a href="#local-6989586621679099848"><span class="hs-identifier hs-var">writeEnd1</span></a></span><span>
</span><span id="line-680"></span><span>        </span><span id="local-6989586621679099856"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679099856"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int64
</span><a href="#local-6989586621679099849"><span class="hs-identifier hs-var">getCount</span></a></span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; IO Word64
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; IO Word64) -&gt; Word64 -&gt; IO Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679099856"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099840"><span class="hs-identifier hs-var">hlen</span></a></span><span>
</span><span id="line-682"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099794"><span class="hs-pragma hs-type">whenStream</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span>    </span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-685"></span><span>    </span><span class="annot"><a href="#local-6989586621679099797"><span class="hs-identifier hs-type">whenSendFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span><span>     </span><span class="hs-comment">-- ^ headers</span><span>
</span><span id="line-686"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span>    </span><span class="hs-comment">-- ^ response</span><span>
</span><span id="line-687"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span>    </span><span class="hs-comment">-- ^ file to serve</span><span>
</span><span id="line-688"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>      </span><span class="hs-comment">-- ^ file start offset</span><span>
</span><span id="line-689"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>   </span><span class="hs-comment">-- ^ returns number of bytes written</span><span>
</span><span id="line-690"></span><span>    </span><span id="local-6989586621679099797"><span class="annot"><span class="annottext">whenSendFile :: Builder -&gt; Response -&gt; String -&gt; Word64 -&gt; IO Word64
</span><a href="#local-6989586621679099797"><span class="hs-identifier hs-var hs-var">whenSendFile</span></a></span></span><span> </span><span id="local-6989586621679099858"><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099858"><span class="hs-identifier hs-var">headerString</span></a></span></span><span> </span><span id="local-6989586621679099859"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099859"><span class="hs-identifier hs-var">rsp</span></a></span></span><span> </span><span id="local-6989586621679099860"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679099860"><span class="hs-identifier hs-var">filePath</span></a></span></span><span> </span><span id="local-6989586621679099861"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099861"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-691"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099864"><span class="annot"><span class="annottext">cl :: Word64
</span><a href="#local-6989586621679099864"><span class="hs-identifier hs-var hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Word64 -&gt; Word64
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromJust"><span class="hs-identifier hs-var">fromJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Word64 -&gt; Word64) -&gt; Maybe Word64 -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Response -&gt; Maybe Word64
</span><span class="hs-identifier hs-var">rspContentLength</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099859"><span class="hs-identifier hs-var">rsp</span></a></span><span>
</span><span id="line-692"></span><span>        </span><span class="annot"><span class="annottext">SendFileHandler
</span><a href="#local-6989586621679099418"><span class="hs-identifier hs-var">sendfileHandler</span></a></span><span> </span><span class="annot"><span class="annottext">Buffer
</span><a href="#local-6989586621679099375"><span class="hs-identifier hs-var">buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099858"><span class="hs-identifier hs-var">headerString</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679099860"><span class="hs-identifier hs-var">filePath</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099861"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099864"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-693"></span><span>        </span><span class="annot"><span class="annottext">Word64 -&gt; IO Word64
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679099864"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-694"></span><span>    </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679099797"><span class="hs-pragma hs-type">whenSendFile</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>
</span><span id="line-697"></span><span class="hs-comment">--------------------------------------------------------------------------</span><span>
</span><span id="line-698"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#mkHeaderLine"><span class="hs-identifier hs-type">mkHeaderLine</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HttpVersion</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier hs-type">FixedPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-699"></span><span id="mkHeaderLine"><span class="annot"><span class="annottext">mkHeaderLine :: HttpVersion -&gt; Response -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#mkHeaderLine"><span class="hs-identifier hs-var hs-var">mkHeaderLine</span></a></span></span><span> </span><span id="local-6989586621679099866"><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099866"><span class="hs-identifier hs-var">outVer</span></a></span></span><span> </span><span id="local-6989586621679099867"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099867"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099868"><span class="hs-identifier hs-var">outCode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-701"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099866"><span class="hs-identifier hs-var">outVer</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; HttpVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-702"></span><span>                  </span><span class="hs-comment">-- typo in bytestring here</span><span>
</span><span id="line-703"></span><span>                  </span><span class="annot"><span class="annottext">Int -&gt; (() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ()
forall a. Int -&gt; (a -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#fixedPrim"><span class="hs-identifier hs-var">fixedPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">17</span></span><span> </span><span class="annot"><span class="annottext">((() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ())
-&gt; (() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO ()) -&gt; () -&gt; Ptr Word8 -&gt; IO ()
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Ptr Word8) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Ptr Word8) -&gt; IO ())
-&gt; (Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var">cpBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/1.1 200 OK\r\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">200</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-705"></span><span>                  </span><span class="annot"><span class="annottext">Int -&gt; (() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ()
forall a. Int -&gt; (a -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#fixedPrim"><span class="hs-identifier hs-var">fixedPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">17</span></span><span> </span><span class="annot"><span class="annottext">((() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ())
-&gt; (() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO ()) -&gt; () -&gt; Ptr Word8 -&gt; IO ()
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Ptr Word8) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Ptr Word8) -&gt; IO ())
-&gt; (Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var">cpBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/1.0 200 OK\r\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>        </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; (() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ()
forall a. Int -&gt; (a -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#fixedPrim"><span class="hs-identifier hs-var">fixedPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099870"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">((() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ())
-&gt; (() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO ()) -&gt; () -&gt; Ptr Word8 -&gt; IO ()
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Ptr Word8) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Ptr Word8) -&gt; IO ())
-&gt; (Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="#local-6989586621679099871"><span class="hs-identifier hs-var">line</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-707"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-708"></span><span>    </span><span id="local-6989586621679099868"><span class="annot"><span class="annottext">outCode :: Int
</span><a href="#local-6989586621679099868"><span class="hs-identifier hs-var hs-var">outCode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response -&gt; Int
</span><span class="hs-identifier hs-var">rspStatus</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099867"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span>    </span><span id="local-6989586621679099877"><span class="annot"><span class="annottext">v :: ByteString
</span><a href="#local-6989586621679099877"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099866"><span class="hs-identifier hs-var">outVer</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; HttpVersion -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/1.1 &quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;HTTP/1.0 &quot;</span></span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>    </span><span id="local-6989586621679099879"><span class="annot"><span class="annottext">outCodeStr :: ByteString
</span><a href="#local-6989586621679099879"><span class="hs-identifier hs-var hs-var">outCodeStr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#pack"><span class="hs-identifier hs-var">S.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString) -&gt; String -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099868"><span class="hs-identifier hs-var">outCode</span></a></span><span>
</span><span id="line-713"></span><span>    </span><span id="local-6989586621679099884"><span class="annot"><span class="annottext">space :: Ptr a -&gt; IO (Ptr b)
</span><a href="#local-6989586621679099884"><span class="hs-identifier hs-var hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099885"><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679099885"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-714"></span><span>        </span><span class="annot"><span class="annottext">Ptr a -&gt; Int -&gt; Word8 -&gt; IO ()
forall b. Ptr b -&gt; Int -&gt; Word8 -&gt; IO ()
forall a b. Storable a =&gt; Ptr b -&gt; Int -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679099885"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">32</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-715"></span><span>        </span><span class="annot"><span class="annottext">Ptr b -&gt; IO (Ptr b)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr b -&gt; IO (Ptr b)) -&gt; Ptr b -&gt; IO (Ptr b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a -&gt; Int -&gt; Ptr b
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr a
</span><a href="#local-6989586621679099885"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span>    </span><span id="local-6989586621679099871"><span class="annot"><span class="annottext">line :: Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="#local-6989586621679099871"><span class="hs-identifier hs-var hs-var">line</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var">cpBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099877"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO (Ptr Word8))
-&gt; (Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#%3E%3D%3E"><span class="hs-operator hs-var">&gt;=&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var">cpBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099879"><span class="hs-identifier hs-var">outCodeStr</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO (Ptr Word8))
-&gt; (Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#%3E%3D%3E"><span class="hs-operator hs-var">&gt;=&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO (Ptr Word8)
forall {a} {b}. Ptr a -&gt; IO (Ptr b)
</span><a href="#local-6989586621679099884"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO (Ptr Word8))
-&gt; (Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#%3E%3D%3E"><span class="hs-operator hs-var">&gt;=&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var">cpBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099890"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-718"></span><span>                  </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO (Ptr Word8))
-&gt; (Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#%3E%3D%3E"><span class="hs-operator hs-var">&gt;=&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#crlfPoke"><span class="hs-identifier hs-var">crlfPoke</span></a></span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span>    </span><span id="local-6989586621679099890"><span class="annot"><span class="annottext">reason :: ByteString
</span><a href="#local-6989586621679099890"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response -&gt; ByteString
</span><span class="hs-identifier hs-var">rspStatusReason</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099867"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-721"></span><span>    </span><span id="local-6989586621679099870"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679099870"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">12</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#length"><span class="hs-identifier hs-var">S.length</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099879"><span class="hs-identifier hs-var">outCodeStr</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#length"><span class="hs-identifier hs-var">S.length</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099890"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-725"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#mkHeaderPrim"><span class="hs-identifier hs-type">mkHeaderPrim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HttpVersion</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Headers</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier hs-type">FixedPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span id="mkHeaderPrim"><span class="annot"><span class="annottext">mkHeaderPrim :: HttpVersion -&gt; Response -&gt; Headers -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#mkHeaderPrim"><span class="hs-identifier hs-var hs-var">mkHeaderPrim</span></a></span></span><span> </span><span id="local-6989586621679099897"><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099897"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679099898"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099898"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679099899"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099899"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpVersion -&gt; Response -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#mkHeaderLine"><span class="hs-identifier hs-var">mkHeaderLine</span></a></span><span> </span><span class="annot"><span class="annottext">HttpVersion
</span><a href="#local-6989586621679099897"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099898"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim () -&gt; FixedPrim () -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Headers -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#headersToPrim"><span class="hs-identifier hs-var">headersToPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099899"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span>
</span><span id="line-729"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-730"></span><span class="hs-keyword">infixl</span><span> </span><span class="hs-number">4</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#%3C%2B%3E"><span class="hs-operator hs-type">&lt;+&gt;</span></a></span><span>
</span><span id="line-731"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#%3C%2B%3E"><span class="hs-operator hs-type">(&lt;+&gt;)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier hs-type">FixedPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier hs-type">FixedPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier hs-type">FixedPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-732"></span><span id="local-6989586621679099902"><span class="annot"><span class="annottext">FixedPrim ()
</span><a href="#local-6989586621679099902"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span id="%3C%2B%3E"><span class="annot"><span class="annottext">&lt;+&gt; :: FixedPrim () -&gt; FixedPrim () -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#%3C%2B%3E"><span class="hs-operator hs-var hs-var">&lt;+&gt;</span></a></span></span><span> </span><span id="local-6989586621679099903"><span class="annot"><span class="annottext">FixedPrim ()
</span><a href="#local-6989586621679099903"><span class="hs-identifier hs-var">p2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ((), ())
</span><a href="#local-6989586621679099904"><span class="hs-identifier hs-var">ignore</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; ((), ())) -&gt; FixedPrim ((), ()) -&gt; FixedPrim ()
forall (f :: * -&gt; *) b a. Contravariant f =&gt; (b -&gt; a) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim ()
</span><a href="#local-6989586621679099902"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim () -&gt; FixedPrim () -&gt; FixedPrim ((), ())
forall (f :: * -&gt; *) a b. Monoidal f =&gt; f a -&gt; f b -&gt; f (a, b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#%3E%2A%3C"><span class="hs-operator hs-var">&gt;*&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">FixedPrim ()
</span><a href="#local-6989586621679099903"><span class="hs-identifier hs-var">p2</span></a></span><span>
</span><span id="line-733"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-734"></span><span>    </span><span id="local-6989586621679099904"><span class="annot"><span class="annottext">ignore :: () -&gt; ((), ())
</span><a href="#local-6989586621679099904"><span class="hs-identifier hs-var hs-var">ignore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() -&gt; () -&gt; ((), ())) -&gt; () -&gt; ((), ())
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#join"><span class="hs-identifier hs-var">join</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span>
</span><span id="line-737"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-738"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#headersToPrim"><span class="hs-pragma hs-type">headersToPrim</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-739"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#headersToPrim"><span class="hs-identifier hs-type">headersToPrim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Headers</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#FixedPrim"><span class="hs-identifier hs-type">FixedPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span id="headersToPrim"><span class="annot"><span class="annottext">headersToPrim :: Headers -&gt; FixedPrim ()
</span><a href="Snap.Internal.Http.Server.Session.html#headersToPrim"><span class="hs-identifier hs-var hs-var">headersToPrim</span></a></span></span><span> </span><span id="local-6989586621679099911"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099911"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; (() -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim ()
forall a. Int -&gt; (a -&gt; Ptr Word8 -&gt; IO ()) -&gt; FixedPrim a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Prim.Internal.html#fixedPrim"><span class="hs-identifier hs-var">fixedPrim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099912"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO ()) -&gt; () -&gt; Ptr Word8 -&gt; IO ()
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO ()
</span><a href="#local-6989586621679099913"><span class="hs-identifier hs-var">copy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-742"></span><span>    </span><span id="local-6989586621679099912"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679099912"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; ByteString -&gt; ByteString -&gt; Int) -&gt; Int -&gt; Headers -&gt; Int
forall a. (a -&gt; ByteString -&gt; ByteString -&gt; a) -&gt; a -&gt; Headers -&gt; a
</span><span class="hs-identifier hs-var">H.foldedFoldl'</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString -&gt; Int
</span><a href="#local-6989586621679099918"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099911"><span class="hs-identifier hs-var">hdrs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-743"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-744"></span><span>        </span><span id="local-6989586621679099918"><span class="annot"><span class="annottext">f :: Int -&gt; ByteString -&gt; ByteString -&gt; Int
</span><a href="#local-6989586621679099918"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679099923"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099923"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679099924"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099924"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679099925"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099925"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099923"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#length"><span class="hs-identifier hs-var">S.length</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099924"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#length"><span class="hs-identifier hs-var">S.length</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099925"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>    </span><span id="local-6989586621679099913"><span class="annot"><span class="annottext">copy :: Ptr Word8 -&gt; IO ()
</span><a href="#local-6989586621679099913"><span class="hs-identifier hs-var hs-var">copy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(ByteString, ByteString)] -&gt; Ptr Word8 -&gt; IO ()
</span><a href="#local-6989586621679099926"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">([(ByteString, ByteString)] -&gt; Ptr Word8 -&gt; IO ())
-&gt; [(ByteString, ByteString)] -&gt; Ptr Word8 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Headers -&gt; [(ByteString, ByteString)]
</span><span class="hs-identifier hs-var">H.unsafeToCaseFoldedList</span></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679099911"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span>    </span><span id="local-6989586621679099926"><span class="annot"><span class="annottext">go :: [(ByteString, ByteString)] -&gt; Ptr Word8 -&gt; IO ()
</span><a href="#local-6989586621679099926"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>         </span><span class="hs-glyph">!</span><span id="local-6989586621679099937"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099937"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Ptr Word8) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Ptr Word8) -&gt; IO ()) -&gt; IO (Ptr Word8) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#crlfPoke"><span class="hs-identifier hs-var">crlfPoke</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099937"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-749"></span><span>    </span><span class="annot"><a href="#local-6989586621679099926"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679099938"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099938"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679099939"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099939"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679099940"><span class="annot"><span class="annottext">[(ByteString, ByteString)]
</span><a href="#local-6989586621679099940"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099941"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099941"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-750"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099942"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099942"><span class="hs-identifier hs-var">op'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var">cpBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099938"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099941"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-751"></span><span>        </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall b. Ptr b -&gt; Int -&gt; Word8 -&gt; IO ()
forall a b. Storable a =&gt; Ptr b -&gt; Int -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099942"><span class="hs-identifier hs-var">op'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">58</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- colon</span><span>
</span><span id="line-752"></span><span>        </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall b. Ptr b -&gt; Int -&gt; Word8 -&gt; IO ()
forall a b. Storable a =&gt; Ptr b -&gt; Int -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099942"><span class="hs-identifier hs-var">op'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">32</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- space</span><span>
</span><span id="line-753"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679099943"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099943"><span class="hs-identifier hs-var">op''</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var">cpBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099939"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099942"><span class="hs-identifier hs-var">op'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-754"></span><span>        </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#crlfPoke"><span class="hs-identifier hs-var">crlfPoke</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099943"><span class="hs-identifier hs-var">op''</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Ptr Word8) -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, ByteString)] -&gt; Ptr Word8 -&gt; IO ()
</span><a href="#local-6989586621679099926"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[(ByteString, ByteString)]
</span><a href="#local-6989586621679099940"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-755"></span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-pragma hs-type">cpBS</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-758"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-type">cpBS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span id="cpBS"><span class="annot"><span class="annottext">cpBS :: ByteString -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#cpBS"><span class="hs-identifier hs-var hs-var">cpBS</span></a></span></span><span> </span><span id="local-6989586621679099944"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099944"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099945"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099945"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (CStringLen -&gt; IO (Ptr Word8)) -&gt; IO (Ptr Word8)
forall a. ByteString -&gt; (CStringLen -&gt; IO a) -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Unsafe.html#unsafeUseAsCStringLen"><span class="hs-identifier hs-var">S.unsafeUseAsCStringLen</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099944"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">((CStringLen -&gt; IO (Ptr Word8)) -&gt; IO (Ptr Word8))
-&gt; (CStringLen -&gt; IO (Ptr Word8)) -&gt; IO (Ptr Word8)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679099947"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621679099947"><span class="hs-identifier hs-var">cstr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679099948"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099948"><span class="hs-identifier hs-var">clen</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-760"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099951"><span class="annot"><span class="annottext">cl :: Int
</span><a href="#local-6989586621679099951"><span class="hs-identifier hs-var hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099948"><span class="hs-identifier hs-var">clen</span></a></span><span>
</span><span id="line-761"></span><span>                </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
forall a. Ptr a -&gt; Ptr a -&gt; Int -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099945"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word8
forall a b. Ptr a -&gt; Ptr b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621679099947"><span class="hs-identifier hs-var">cstr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099951"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-762"></span><span>                </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO (Ptr Word8)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099945"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679099951"><span class="hs-identifier hs-var">cl</span></a></span><span>
</span><span id="line-763"></span><span>
</span><span id="line-764"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#crlfPoke"><span class="hs-pragma hs-type">crlfPoke</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-765"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#crlfPoke"><span class="hs-identifier hs-type">crlfPoke</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span id="crlfPoke"><span class="annot"><span class="annottext">crlfPoke :: Ptr Word8 -&gt; IO (Ptr Word8)
</span><a href="Snap.Internal.Http.Server.Session.html#crlfPoke"><span class="hs-identifier hs-var hs-var">crlfPoke</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679099952"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099952"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-767"></span><span>    </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall b. Ptr b -&gt; Int -&gt; Word8 -&gt; IO ()
forall a b. Storable a =&gt; Ptr b -&gt; Int -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099952"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">13</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- cr</span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall b. Ptr b -&gt; Int -&gt; Word8 -&gt; IO ()
forall a b. Storable a =&gt; Ptr b -&gt; Int -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099952"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">10</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- lf</span><span>
</span><span id="line-769"></span><span>    </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; IO (Ptr Word8)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Ptr Word8 -&gt; IO (Ptr Word8)) -&gt; Ptr Word8 -&gt; IO (Ptr Word8)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621679099952"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-770"></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-773"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#sERVER_HEADER"><span class="hs-identifier hs-type">sERVER_HEADER</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-774"></span><span id="sERVER_HEADER"><span class="annot"><span class="annottext">sERVER_HEADER :: ByteString
</span><a href="Snap.Internal.Http.Server.Session.html#sERVER_HEADER"><span class="hs-identifier hs-var hs-var">sERVER_HEADER</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#concat"><span class="hs-identifier hs-var">S.concat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;Snap/&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="Snap.Internal.Http.Server.Session.html#snapServerVersion"><span class="hs-identifier hs-var">snapServerVersion</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-775"></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-778"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#snapServerVersion"><span class="hs-identifier hs-type">snapServerVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-779"></span><span id="snapServerVersion"><span class="annot"><span class="annottext">snapServerVersion :: ByteString
</span><a href="Snap.Internal.Http.Server.Session.html#snapServerVersion"><span class="hs-identifier hs-var hs-var">snapServerVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#pack"><span class="hs-identifier hs-var">S.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString) -&gt; String -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Version.html#showVersion"><span class="hs-identifier hs-var">showVersion</span></a></span><span> </span><span class="annot"><span class="annottext">(Version -&gt; String) -&gt; Version -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Paths_snap_server.html#version"><span class="hs-identifier hs-var">V.version</span></a></span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span>
</span><span id="line-782"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-783"></span><span id="local-6989586621679099955"><span id="local-6989586621679099956"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#terminateSession"><span class="hs-identifier hs-type">terminateSession</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679099955"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679099955"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679099956"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-784"></span><span id="terminateSession"><span class="annot"><span class="annottext">terminateSession :: forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="Snap.Internal.Http.Server.Session.html#terminateSession"><span class="hs-identifier hs-var hs-var">terminateSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TerminateSessionException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.html#throwIO"><span class="hs-identifier hs-var">E.throwIO</span></a></span><span> </span><span class="annot"><span class="annottext">(TerminateSessionException -&gt; IO a)
-&gt; (e -&gt; TerminateSessionException) -&gt; e -&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; TerminateSessionException
</span><a href="Snap.Internal.Http.Server.Session.html#TerminateSessionException"><span class="hs-identifier hs-var">TerminateSessionException</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; TerminateSessionException)
-&gt; (e -&gt; SomeException) -&gt; e -&gt; TerminateSessionException
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">e -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-var">SomeException</span></a></span><span>
</span><span id="line-785"></span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-788"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#requestErrorMessage"><span class="hs-identifier hs-type">requestErrorMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span><span>
</span><span id="line-789"></span><span id="requestErrorMessage"><span class="annot"><span class="annottext">requestErrorMessage :: Request -&gt; SomeException -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#requestErrorMessage"><span class="hs-identifier hs-var hs-var">requestErrorMessage</span></a></span></span><span> </span><span id="local-6989586621679099961"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099961"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679099962"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099962"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-790"></span><span>    </span><span class="annot"><span class="annottext">[Builder] -&gt; Builder
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;During processing of request from &quot;</span></span><span>
</span><span id="line-791"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Builder) -&gt; ByteString -&gt; Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; ByteString
</span><span class="hs-identifier hs-var">rqClientAddr</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099961"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-792"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;:&quot;</span></span><span>
</span><span id="line-793"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Builder
forall a. Show a =&gt; a -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-var">fromShow</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Builder) -&gt; Int -&gt; Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Int
</span><span class="hs-identifier hs-var">rqClientPort</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099961"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-794"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;\nrequest:\n&quot;</span></span><span>
</span><span id="line-795"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String -&gt; Builder
forall a. Show a =&gt; a -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-var">fromShow</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Builder) -&gt; String -&gt; Builder
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Request -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679099961"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-796"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-797"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Builder
</span><a href="#local-6989586621679099965"><span class="hs-identifier hs-var">msgB</span></a></span><span>
</span><span id="line-798"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-799"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-800"></span><span>    </span><span id="local-6989586621679099965"><span class="annot"><span class="annottext">msgB :: Builder
</span><a href="#local-6989586621679099965"><span class="hs-identifier hs-var hs-var">msgB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Builder] -&gt; Builder
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span> </span><span class="hs-special">[</span><span>
</span><span id="line-801"></span><span>             </span><span class="annot"><span class="annottext">ByteString -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#byteString"><span class="hs-identifier hs-var">byteString</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;A web handler threw an exception. Details:\n&quot;</span></span><span>
</span><span id="line-802"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Builder
forall a. Show a =&gt; a -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-var">fromShow</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679099962"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-803"></span><span>           </span><span class="hs-special">]</span><span>
</span><span id="line-804"></span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-807"></span><span class="annot"><span class="hs-comment">-- | Convert 'Cookie' into 'ByteString' for output.</span></span><span>
</span><span id="line-808"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#cookieToBS"><span class="hs-identifier hs-type">cookieToBS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Cookie</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Internal.Type.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-809"></span><span id="cookieToBS"><span class="annot"><span class="annottext">cookieToBS :: Cookie -&gt; ByteString
</span><a href="Snap.Internal.Http.Server.Session.html#cookieToBS"><span class="hs-identifier hs-var hs-var">cookieToBS</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Cookie</span></span><span> </span><span id="local-6989586621679099971"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099971"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679099972"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099972"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679099973"><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621679099973"><span class="hs-identifier hs-var">mbExpTime</span></a></span></span><span> </span><span id="local-6989586621679099974"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679099974"><span class="hs-identifier hs-var">mbDomain</span></a></span></span><span> </span><span id="local-6989586621679099975"><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679099975"><span class="hs-identifier hs-var">mbPath</span></a></span></span><span> </span><span id="local-6989586621679099976"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099976"><span class="hs-identifier hs-var">isSec</span></a></span></span><span> </span><span id="local-6989586621679099977"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099977"><span class="hs-identifier hs-var">isHOnly</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099978"><span class="hs-identifier hs-var">cookie</span></a></span><span>
</span><span id="line-810"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-811"></span><span>    </span><span id="local-6989586621679099978"><span class="annot"><span class="annottext">cookie :: ByteString
</span><a href="#local-6989586621679099978"><span class="hs-identifier hs-var hs-var">cookie</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#concat"><span class="hs-identifier hs-var">S.concat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099971"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;=&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099972"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099980"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099981"><span class="hs-identifier hs-var">exptime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099982"><span class="hs-identifier hs-var">domain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099983"><span class="hs-identifier hs-var">secure</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679099984"><span class="hs-identifier hs-var">hOnly</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-812"></span><span>    </span><span id="local-6989586621679099980"><span class="annot"><span class="annottext">path :: ByteString
</span><a href="#local-6989586621679099980"><span class="hs-identifier hs-var hs-var">path</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; (ByteString -&gt; ByteString) -&gt; Maybe ByteString -&gt; ByteString
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#append"><span class="hs-identifier hs-var">S.append</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;; path=&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679099975"><span class="hs-identifier hs-var">mbPath</span></a></span><span>
</span><span id="line-813"></span><span>    </span><span id="local-6989586621679099982"><span class="annot"><span class="annottext">domain :: ByteString
</span><a href="#local-6989586621679099982"><span class="hs-identifier hs-var hs-var">domain</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; (ByteString -&gt; ByteString) -&gt; Maybe ByteString -&gt; ByteString
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#append"><span class="hs-identifier hs-var">S.append</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;; domain=&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679099974"><span class="hs-identifier hs-var">mbDomain</span></a></span><span>
</span><span id="line-814"></span><span>    </span><span id="local-6989586621679099981"><span class="annot"><span class="annottext">exptime :: ByteString
</span><a href="#local-6989586621679099981"><span class="hs-identifier hs-var hs-var">exptime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; (UTCTime -&gt; ByteString) -&gt; Maybe UTCTime -&gt; ByteString
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.html#append"><span class="hs-identifier hs-var">S.append</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;; expires=&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString)
-&gt; (UTCTime -&gt; ByteString) -&gt; UTCTime -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; ByteString
</span><a href="#local-6989586621679099992"><span class="hs-identifier hs-var">fmt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe UTCTime
</span><a href="#local-6989586621679099973"><span class="hs-identifier hs-var">mbExpTime</span></a></span><span>
</span><span id="line-815"></span><span>    </span><span id="local-6989586621679099983"><span class="annot"><span class="annottext">secure :: ByteString
</span><a href="#local-6989586621679099983"><span class="hs-identifier hs-var hs-var">secure</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099976"><span class="hs-identifier hs-var">isSec</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;; Secure&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-816"></span><span>    </span><span id="local-6989586621679099984"><span class="annot"><span class="annottext">hOnly :: ByteString
</span><a href="#local-6989586621679099984"><span class="hs-identifier hs-var hs-var">hOnly</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679099977"><span class="hs-identifier hs-var">isHOnly</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;; HttpOnly&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-817"></span><span>    </span><span id="local-6989586621679099992"><span class="annot"><span class="annottext">fmt :: UTCTime -&gt; ByteString
</span><a href="#local-6989586621679099992"><span class="hs-identifier hs-var hs-var">fmt</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Char8.html#pack"><span class="hs-identifier hs-var">S.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ByteString)
-&gt; (UTCTime -&gt; String) -&gt; UTCTime -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TimeLocale -&gt; String -&gt; UTCTime -&gt; String
forall t. FormatTime t =&gt; TimeLocale -&gt; String -&gt; t -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Format.Format.Class.html#formatTime"><span class="hs-identifier hs-var">formatTime</span></a></span><span> </span><span class="annot"><span class="annottext">TimeLocale
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Format.Locale.html#defaultTimeLocale"><span class="hs-identifier hs-var">defaultTimeLocale</span></a></span><span>
</span><span id="line-818"></span><span>                                  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;%a, %d-%b-%Y %H:%M:%S GMT&quot;</span></span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span>
</span><span id="line-821"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-822"></span><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#renderCookies"><span class="hs-identifier hs-type">renderCookies</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Response</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Headers</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Headers</span></span><span>
</span><span id="line-823"></span><span id="renderCookies"><span class="annot"><span class="annottext">renderCookies :: Response -&gt; Headers -&gt; Headers
</span><a href="Snap.Internal.Http.Server.Session.html#renderCookies"><span class="hs-identifier hs-var hs-var">renderCookies</span></a></span></span><span> </span><span id="local-6989586621679099999"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099999"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679100000"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679100000"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span>
</span><span id="line-824"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679100002"><span class="hs-identifier hs-var">cookies</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679100000"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-825"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Headers -&gt; ByteString -&gt; Headers)
-&gt; Headers -&gt; [ByteString] -&gt; Headers
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679100003"><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679100003"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679100004"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679100004"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Headers -&gt; Headers
</span><span class="hs-identifier hs-var">H.unsafeInsert</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;set-cookie&quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679100004"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679100003"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Headers
</span><a href="#local-6989586621679100000"><span class="hs-identifier hs-var">hdrs</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679100002"><span class="hs-identifier hs-var">cookies</span></a></span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-828"></span><span>    </span><span id="local-6989586621679100002"><span class="annot"><span class="annottext">cookies :: [ByteString]
</span><a href="#local-6989586621679100002"><span class="hs-identifier hs-var hs-var">cookies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Cookie -&gt; ByteString) -&gt; [Cookie] -&gt; [ByteString]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Cookie -&gt; ByteString
</span><a href="Snap.Internal.Http.Server.Session.html#cookieToBS"><span class="hs-identifier hs-var">cookieToBS</span></a></span><span> </span><span class="annot"><span class="annottext">([Cookie] -&gt; [ByteString])
-&gt; (Map ByteString Cookie -&gt; [Cookie])
-&gt; Map ByteString Cookie
-&gt; [ByteString]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map ByteString Cookie -&gt; [Cookie]
forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">(Map ByteString Cookie -&gt; [ByteString])
-&gt; Map ByteString Cookie -&gt; [ByteString]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Response -&gt; Map ByteString Cookie
</span><span class="hs-identifier hs-var">rspCookies</span></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679099999"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-829"></span><span>
</span><span id="line-830"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-831"></span><span id="local-6989586621679098771"><span class="annot"><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-type">fromShow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679098771"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679098771"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.Internal.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span></span><span>
</span><span id="line-832"></span><span id="fromShow"><span class="annot"><span class="annottext">fromShow :: forall a. Show a =&gt; a -&gt; Builder
</span><a href="Snap.Internal.Http.Server.Session.html#fromShow"><span class="hs-identifier hs-var hs-var">fromShow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Builder
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Builder.html#stringUtf8"><span class="hs-identifier hs-var">stringUtf8</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Builder) -&gt; (a -&gt; String) -&gt; a -&gt; Builder
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span>
</span><span id="line-833"></span></pre></body></html>
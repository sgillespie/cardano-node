<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns          #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators         #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | 'io-sim' implementation of 'TQueue', 'TBQueue' and 'MVar'.</span><span>
</span><span id="line-7"></span><span class="hs-comment">--</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Unlike the default implementation available in 'io-classes' the 'TQueue' and</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- 'TBQueue' are using a single 'TVar', which simplifies the implementation of</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- 'traceTQueue' and 'traceTBQueue' methods.</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Control.Monad.IOSim.STM</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#SomeAsyncException"><span class="hs-identifier">SomeAsyncException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.TVar</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadInspectSTM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>                     </span><span class="annot"><span class="hs-identifier">MonadLabelledSTM</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadSTM</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadTraceSTM</span></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>                     </span><span class="annot"><span class="hs-identifier">TraceValue</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Numeric.Natural.html"><span class="hs-identifier">Numeric.Natural</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier">Natural</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Data.Deque.Strict.html"><span class="hs-identifier">Data.Deque.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Deque.Strict.html#Deque"><span class="hs-identifier">Deque</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Data.Deque.Strict.html"><span class="hs-identifier">Data.Deque.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Deque</span></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-comment">--</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- Default TQueue implementation in terms of a 'TVar' (used by sim)</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">newtype</span><span> </span><span id="TQueueDefault"><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-var">TQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679131932"><span class="annot"><a href="#local-6989586621679131932"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679131933"><span class="annot"><a href="#local-6989586621679131933"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TQueue"><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-var">TQueue</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679131932"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679131933"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679131933"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span id="local-6989586621679131896"><span id="local-6989586621679131898"><span class="annot"><a href="Control.Monad.IOSim.STM.html#labelTQueueDefault"><span class="hs-identifier hs-type">labelTQueueDefault</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLabelledSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131896"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131896"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131898"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131896"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-36"></span><span id="labelTQueueDefault"><span class="annot"><span class="annottext">labelTQueueDefault :: forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
TQueueDefault m a -&gt; String -&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#labelTQueueDefault"><span class="hs-identifier hs-var hs-var">labelTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132135"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132135"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132136"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679132136"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; String -&gt; STM m ()
forall a. TVar m a -&gt; String -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
TVar m a -&gt; String -&gt; STM m ()
</span><span class="hs-identifier hs-var">labelTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132135"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679132136"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span id="local-6989586621679131906"><span id="local-6989586621679131908"><span id="local-6989586621679131909"><span class="annot"><a href="Control.Monad.IOSim.STM.html#traceTQueueDefault"><span class="hs-identifier hs-type">traceTQueueDefault</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTraceSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131906"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679131908"><span class="hs-identifier hs-type">proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131906"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131909"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679131909"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679131909"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">InspectMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621679131906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TraceValue</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131906"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-44"></span><span id="traceTQueueDefault"><span class="annot"><span class="annottext">traceTQueueDefault :: forall (m :: * -&gt; *) (proxy :: (* -&gt; *) -&gt; *) a.
MonadTraceSTM m =&gt;
proxy m
-&gt; TQueueDefault m a
-&gt; (Maybe [a] -&gt; [a] -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#traceTQueueDefault"><span class="hs-identifier hs-var hs-var">traceTQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679132143"><span class="annot"><span class="annottext">proxy m
</span><a href="#local-6989586621679132143"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132144"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132144"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132145"><span class="annot"><span class="annottext">Maybe [a] -&gt; [a] -&gt; InspectMonad m TraceValue
</span><a href="#local-6989586621679132145"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="annottext">proxy m
-&gt; TVar m ([a], [a])
-&gt; (Maybe ([a], [a]) -&gt; ([a], [a]) -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
forall (m :: * -&gt; *) (proxy :: (* -&gt; *) -&gt; *) a.
MonadTraceSTM m =&gt;
proxy m
-&gt; TVar m a
-&gt; (Maybe a -&gt; a -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
forall (proxy :: (* -&gt; *) -&gt; *) a.
proxy m
-&gt; TVar m a
-&gt; (Maybe a -&gt; a -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
</span><span class="hs-identifier hs-var">traceTVar</span></span><span> </span><span class="annot"><span class="annottext">proxy m
</span><a href="#local-6989586621679132143"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132144"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-46"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679132147"><span class="annot"><span class="annottext">Maybe ([a], [a])
</span><a href="#local-6989586621679132147"><span class="hs-identifier hs-var">mas</span></a></span></span><span> </span><span id="local-6989586621679132148"><span class="annot"><span class="annottext">([a], [a])
</span><a href="#local-6989586621679132148"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe [a] -&gt; [a] -&gt; InspectMonad m TraceValue
</span><a href="#local-6989586621679132145"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([a], [a]) -&gt; [a]
forall {a}. ([a], [a]) -&gt; [a]
</span><a href="#local-6989586621679132149"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; [a]) -&gt; Maybe ([a], [a]) -&gt; Maybe [a]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([a], [a])
</span><a href="#local-6989586621679132147"><span class="hs-identifier hs-var">mas</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([a], [a]) -&gt; [a]
forall {a}. ([a], [a]) -&gt; [a]
</span><a href="#local-6989586621679132149"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">([a], [a])
</span><a href="#local-6989586621679132148"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-48"></span><span>    </span><span id="local-6989586621679132149"><span class="annot"><span class="annottext">g :: ([a], [a]) -&gt; [a]
</span><a href="#local-6989586621679132149"><span class="hs-identifier hs-var hs-var">g</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679132151"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132151"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132152"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132152"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132151"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132152"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span id="local-6989586621679131924"><span id="local-6989586621679131926"><span class="annot"><a href="Control.Monad.IOSim.STM.html#newTQueueDefault"><span class="hs-identifier hs-type">newTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131924"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131924"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131924"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131926"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-51"></span><span id="newTQueueDefault"><span class="annot"><span class="annottext">newTQueueDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m (TQueueDefault m a)
</span><a href="Control.Monad.IOSim.STM.html#newTQueueDefault"><span class="hs-identifier hs-var hs-var">newTQueueDefault</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; TQueueDefault m a
forall (m :: * -&gt; *) a. TVar m ([a], [a]) -&gt; TQueueDefault m a
</span><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-var">TQueue</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar m ([a], [a]) -&gt; TQueueDefault m a)
-&gt; STM m (TVar m ([a], [a])) -&gt; STM m (TQueueDefault m a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">([a], [a]) -&gt; STM m (TVar m ([a], [a]))
forall a. a -&gt; STM m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (TVar m a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span id="local-6989586621679131936"><span id="local-6989586621679131937"><span class="annot"><a href="Control.Monad.IOSim.STM.html#writeTQueueDefault"><span class="hs-identifier hs-type">writeTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131936"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131936"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131937"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679131937"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131936"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-54"></span><span id="writeTQueueDefault"><span class="annot"><span class="annottext">writeTQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueueDefault m a -&gt; a -&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#writeTQueueDefault"><span class="hs-identifier hs-var hs-var">writeTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132171"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132171"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132172"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132172"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679132173"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132173"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132174"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132174"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; STM m ([a], [a])
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132171"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; ([a], [a]) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132171"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; STM m ()) -&gt; ([a], [a]) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132173"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132172"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132174"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span id="local-6989586621679131945"><span id="local-6989586621679131946"><span class="annot"><a href="Control.Monad.IOSim.STM.html#readTQueueDefault"><span class="hs-identifier hs-type">readTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131946"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131946"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-59"></span><span id="readTQueueDefault"><span class="annot"><span class="annottext">readTQueueDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; TQueueDefault m a -&gt; STM m a
</span><a href="Control.Monad.IOSim.STM.html#readTQueueDefault"><span class="hs-identifier hs-var hs-var">readTQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679132185"><span class="annot"><span class="annottext">TQueueDefault m a
</span><a href="#local-6989586621679132185"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; (a -&gt; STM m a) -&gt; Maybe a -&gt; STM m a
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">STM m a
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m a
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; STM m a) -&gt; STM m (Maybe a) -&gt; STM m a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">TQueueDefault m a -&gt; STM m (Maybe a)
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueueDefault m a -&gt; STM m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryReadTQueueDefault"><span class="hs-identifier hs-var">tryReadTQueueDefault</span></a></span><span> </span><span class="annot"><span class="annottext">TQueueDefault m a
</span><a href="#local-6989586621679132185"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span id="local-6989586621679131956"><span id="local-6989586621679131957"><span class="annot"><a href="Control.Monad.IOSim.STM.html#tryReadTQueueDefault"><span class="hs-identifier hs-type">tryReadTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131956"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131956"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131957"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131956"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131957"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-62"></span><span id="tryReadTQueueDefault"><span class="annot"><span class="annottext">tryReadTQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueueDefault m a -&gt; STM m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryReadTQueueDefault"><span class="hs-identifier hs-var hs-var">tryReadTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132201"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132201"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679132202"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132202"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132203"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132203"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; STM m ([a], [a])
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132201"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132202"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679132204"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132204"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679132205"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132205"><span class="hs-identifier hs-var">xs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-66"></span><span>      </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; ([a], [a]) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132201"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; STM m ()) -&gt; ([a], [a]) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132205"><span class="hs-identifier hs-var">xs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132203"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>      </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132204"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132203"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-70"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-71"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679132206"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132206"><span class="hs-identifier hs-var">z</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679132207"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132207"><span class="hs-identifier hs-var">zs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-72"></span><span>          </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; ([a], [a]) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132201"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; STM m ()) -&gt; ([a], [a]) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132207"><span class="hs-identifier hs-var">zs</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>          </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132206"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span id="local-6989586621679131960"><span id="local-6989586621679131961"><span class="annot"><a href="Control.Monad.IOSim.STM.html#isEmptyTQueueDefault"><span class="hs-identifier hs-type">isEmptyTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131960"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131960"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131961"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131960"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span></span><span>
</span><span id="line-76"></span><span id="isEmptyTQueueDefault"><span class="annot"><span class="annottext">isEmptyTQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueueDefault m a -&gt; STM m Bool
</span><a href="Control.Monad.IOSim.STM.html#isEmptyTQueueDefault"><span class="hs-identifier hs-var hs-var">isEmptyTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132214"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132214"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679132215"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132215"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132216"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132216"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; STM m ([a], [a])
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132214"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m Bool) -&gt; Bool -&gt; STM m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132215"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132216"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-81"></span><span>             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-82"></span><span>             </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span id="local-6989586621679132217"><span id="local-6989586621679132218"><span class="annot"><a href="Control.Monad.IOSim.STM.html#peekTQueueDefault"><span class="hs-identifier hs-type">peekTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132218"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132217"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132218"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-85"></span><span id="peekTQueueDefault"><span class="annot"><span class="annottext">peekTQueueDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; TQueueDefault m a -&gt; STM m a
</span><a href="Control.Monad.IOSim.STM.html#peekTQueueDefault"><span class="hs-identifier hs-var hs-var">peekTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132226"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132226"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679132227"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132227"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; STM m ([a], [a])
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132226"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132227"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-88"></span><span>      </span><span id="local-6989586621679132228"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132228"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m a
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132228"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m a
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span id="local-6989586621679132229"><span id="local-6989586621679132230"><span class="annot"><a href="Control.Monad.IOSim.STM.html#tryPeekTQueueDefault"><span class="hs-identifier hs-type">tryPeekTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132229"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132229"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132230"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132229"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132230"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-92"></span><span id="tryPeekTQueueDefault"><span class="annot"><span class="annottext">tryPeekTQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueueDefault m a -&gt; STM m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryPeekTQueueDefault"><span class="hs-identifier hs-var hs-var">tryPeekTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132237"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132237"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679132238"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132238"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; STM m ([a], [a])
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132237"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; STM m (Maybe a)) -&gt; Maybe a -&gt; STM m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132238"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-95"></span><span>      </span><span id="local-6989586621679132239"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132239"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132239"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span id="local-6989586621679131968"><span id="local-6989586621679131969"><span class="annot"><a href="Control.Monad.IOSim.STM.html#flushTQueueDefault"><span class="hs-identifier hs-type">flushTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131968"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131968"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131969"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131968"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679131969"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-99"></span><span id="flushTQueueDefault"><span class="annot"><span class="annottext">flushTQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueueDefault m a -&gt; STM m [a]
</span><a href="Control.Monad.IOSim.STM.html#flushTQueueDefault"><span class="hs-identifier hs-var hs-var">flushTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132247"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132247"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a] -&gt; [a] -&gt; [a]) -&gt; ([a], [a]) -&gt; [a]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">(++)</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; [a]) -&gt; STM m ([a], [a]) -&gt; STM m [a]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; STM m ([a], [a])
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132247"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span id="local-6989586621679132249"><span id="local-6989586621679132250"><span class="annot"><a href="Control.Monad.IOSim.STM.html#unGetTQueueDefault"><span class="hs-identifier hs-type">unGetTQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132249"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueueDefault"><span class="hs-identifier hs-type">TQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132249"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132250"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132250"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132249"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-102"></span><span id="unGetTQueueDefault"><span class="annot"><span class="annottext">unGetTQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TQueueDefault m a -&gt; a -&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#unGetTQueueDefault"><span class="hs-identifier hs-var hs-var">unGetTQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TQueue"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span id="local-6989586621679132257"><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132257"><span class="hs-identifier hs-var">queue</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132258"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132258"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679132259"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132259"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132260"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132260"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; STM m ([a], [a])
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132257"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">TVar m ([a], [a]) -&gt; ([a], [a]) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], [a])
</span><a href="#local-6989586621679132257"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132258"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132259"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132260"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="hs-comment">--</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- Default TBQueue implementation in terms of 'Seq' (used by sim)</span><span>
</span><span id="line-108"></span><span class="hs-comment">--</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-keyword">data</span><span> </span><span id="TBQueueDefault"><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-var">TBQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679132005"><span class="annot"><a href="#local-6989586621679132005"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679132006"><span class="annot"><a href="#local-6989586621679132006"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TBQueue"><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-var">TBQueue</span></a></span></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132005"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679132006"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679132006"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span id="local-6989586621679131977"><span id="local-6989586621679131978"><span class="annot"><a href="Control.Monad.IOSim.STM.html#labelTBQueueDefault"><span class="hs-identifier hs-type">labelTBQueueDefault</span></a></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLabelledSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131977"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131977"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131978"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131977"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-117"></span><span id="labelTBQueueDefault"><span class="annot"><span class="annottext">labelTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
TBQueueDefault m a -&gt; String -&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#labelTBQueueDefault"><span class="hs-identifier hs-var hs-var">labelTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132264"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132264"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132265"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132265"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132266"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679132266"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural) -&gt; String -&gt; STM m ()
forall a. TVar m a -&gt; String -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadLabelledSTM m =&gt;
TVar m a -&gt; String -&gt; STM m ()
</span><span class="hs-identifier hs-var">labelTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132264"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679132266"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span id="local-6989586621679131982"><span id="local-6989586621679131983"><span id="local-6989586621679131984"><span class="annot"><a href="Control.Monad.IOSim.STM.html#traceTBQueueDefault"><span class="hs-identifier hs-type">traceTBQueueDefault</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTraceSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131982"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679131983"><span class="hs-identifier hs-type">proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131982"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131984"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679131984"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679131984"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">InspectMonad</span></span><span> </span><span class="annot"><a href="#local-6989586621679131982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TraceValue</span></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-125"></span><span id="traceTBQueueDefault"><span class="annot"><span class="annottext">traceTBQueueDefault :: forall (m :: * -&gt; *) (proxy :: (* -&gt; *) -&gt; *) a.
MonadTraceSTM m =&gt;
proxy m
-&gt; TBQueueDefault m a
-&gt; (Maybe [a] -&gt; [a] -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#traceTBQueueDefault"><span class="hs-identifier hs-var hs-var">traceTBQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679132271"><span class="annot"><span class="annottext">proxy m
</span><a href="#local-6989586621679132271"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132272"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132272"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132273"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132273"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132274"><span class="annot"><span class="annottext">Maybe [a] -&gt; [a] -&gt; InspectMonad m TraceValue
</span><a href="#local-6989586621679132274"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="annottext">proxy m
-&gt; TVar m ([a], Natural, [a], Natural)
-&gt; (Maybe ([a], Natural, [a], Natural)
    -&gt; ([a], Natural, [a], Natural) -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
forall (m :: * -&gt; *) (proxy :: (* -&gt; *) -&gt; *) a.
MonadTraceSTM m =&gt;
proxy m
-&gt; TVar m a
-&gt; (Maybe a -&gt; a -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
forall (proxy :: (* -&gt; *) -&gt; *) a.
proxy m
-&gt; TVar m a
-&gt; (Maybe a -&gt; a -&gt; InspectMonad m TraceValue)
-&gt; STM m ()
</span><span class="hs-identifier hs-var">traceTVar</span></span><span> </span><span class="annot"><span class="annottext">proxy m
</span><a href="#local-6989586621679132271"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132272"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679132275"><span class="annot"><span class="annottext">Maybe ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132275"><span class="hs-identifier hs-var">mas</span></a></span></span><span> </span><span id="local-6989586621679132276"><span class="annot"><span class="annottext">([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132276"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe [a] -&gt; [a] -&gt; InspectMonad m TraceValue
</span><a href="#local-6989586621679132274"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([a], Natural, [a], Natural) -&gt; [a]
forall {a} {b} {d}. ([a], b, [a], d) -&gt; [a]
</span><a href="#local-6989586621679132277"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], Natural, [a], Natural) -&gt; [a])
-&gt; Maybe ([a], Natural, [a], Natural) -&gt; Maybe [a]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132275"><span class="hs-identifier hs-var">mas</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([a], Natural, [a], Natural) -&gt; [a]
forall {a} {b} {d}. ([a], b, [a], d) -&gt; [a]
</span><a href="#local-6989586621679132277"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132276"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621679132277"><span class="annot"><span class="annottext">g :: ([a], b, [a], d) -&gt; [a]
</span><a href="#local-6989586621679132277"><span class="hs-identifier hs-var hs-var">g</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679132278"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132278"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132279"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132279"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132278"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132279"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span id="local-6989586621679131991"><span id="local-6989586621679131992"><span class="annot"><a href="Control.Monad.IOSim.STM.html#newTBQueueDefault"><span class="hs-identifier hs-type">newTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131991"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679131991"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131991"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679131992"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-132"></span><span id="newTBQueueDefault"><span class="annot"><span class="annottext">newTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
Natural -&gt; STM m (TBQueueDefault m a)
</span><a href="Control.Monad.IOSim.STM.html#newTBQueueDefault"><span class="hs-identifier hs-var hs-var">newTBQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679132298"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132298"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132298"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Natural
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
forall a. Bounded a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; STM m (TBQueueDefault m a)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;newTBQueueDefault: size larger than Int&quot;</span></span><span>
</span><span id="line-134"></span><span class="annot"><a href="Control.Monad.IOSim.STM.html#newTBQueueDefault"><span class="hs-identifier hs-var">newTBQueueDefault</span></a></span><span> </span><span id="local-6989586621679132301"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132301"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="annottext">(TVar m ([a], Natural, [a], Natural)
 -&gt; Natural -&gt; TBQueueDefault m a)
-&gt; Natural
-&gt; TVar m ([a], Natural, [a], Natural)
-&gt; TBQueueDefault m a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; Natural -&gt; TBQueueDefault m a
forall (m :: * -&gt; *) a.
TVar m ([a], Natural, [a], Natural)
-&gt; Natural -&gt; TBQueueDefault m a
</span><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-var">TBQueue</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132301"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar m ([a], Natural, [a], Natural) -&gt; TBQueueDefault m a)
-&gt; STM m (TVar m ([a], Natural, [a], Natural))
-&gt; STM m (TBQueueDefault m a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([a], Natural, [a], Natural)
-&gt; STM m (TVar m ([a], Natural, [a], Natural))
forall a. a -&gt; STM m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (TVar m a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="annot"><span class="annottext">(([a], Natural, [a], Natural)
 -&gt; STM m (TVar m ([a], Natural, [a], Natural)))
-&gt; ([a], Natural, [a], Natural)
-&gt; STM m (TVar m ([a], Natural, [a], Natural))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132301"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="local-6989586621679132007"><span id="local-6989586621679132008"><span class="annot"><a href="Control.Monad.IOSim.STM.html#readTBQueueDefault"><span class="hs-identifier hs-type">readTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132007"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132007"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132008"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132007"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132008"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-138"></span><span id="readTBQueueDefault"><span class="annot"><span class="annottext">readTBQueueDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; TBQueueDefault m a -&gt; STM m a
</span><a href="Control.Monad.IOSim.STM.html#readTBQueueDefault"><span class="hs-identifier hs-var hs-var">readTBQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679132310"><span class="annot"><span class="annottext">TBQueueDefault m a
</span><a href="#local-6989586621679132310"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; (a -&gt; STM m a) -&gt; Maybe a -&gt; STM m a
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">STM m a
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m a
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; STM m a) -&gt; STM m (Maybe a) -&gt; STM m a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueueDefault m a -&gt; STM m (Maybe a)
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryReadTBQueueDefault"><span class="hs-identifier hs-var">tryReadTBQueueDefault</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueueDefault m a
</span><a href="#local-6989586621679132310"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span id="local-6989586621679132011"><span id="local-6989586621679132012"><span class="annot"><a href="Control.Monad.IOSim.STM.html#tryReadTBQueueDefault"><span class="hs-identifier hs-type">tryReadTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132012"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132012"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-141"></span><span id="tryReadTBQueueDefault"><span class="annot"><span class="annottext">tryReadTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryReadTBQueueDefault"><span class="hs-identifier hs-var hs-var">tryReadTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132327"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132327"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132328"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132328"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679132329"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132329"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132330"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132330"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132331"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132331"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132332"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132332"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132327"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679132333"><span class="annot"><span class="annottext">r' :: Natural
</span><a href="#local-6989586621679132333"><span class="hs-identifier hs-var hs-var">r'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132330"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132329"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679132335"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132335"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679132336"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132336"><span class="hs-identifier hs-var">xs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132327"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], Natural, [a], Natural) -&gt; STM m ())
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132336"><span class="hs-identifier hs-var">xs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132333"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132331"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132332"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132335"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132331"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-151"></span><span>          </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132327"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], Natural, [a], Natural) -&gt; STM m ())
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132329"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132333"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132331"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132332"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>          </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-comment">-- NB. lazy: we want the transaction to be</span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-comment">-- short, otherwise it will conflict</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679132337"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132337"><span class="hs-identifier hs-var">z</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679132338"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132338"><span class="hs-identifier hs-var">zs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>           </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132327"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], Natural, [a], Natural) -&gt; STM m ())
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132338"><span class="hs-identifier hs-var">zs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132333"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132332"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>           </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132337"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span id="local-6989586621679132339"><span id="local-6989586621679132340"><span class="annot"><a href="Control.Monad.IOSim.STM.html#peekTBQueueDefault"><span class="hs-identifier hs-type">peekTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132340"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132340"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-161"></span><span id="peekTBQueueDefault"><span class="annot"><span class="annottext">peekTBQueueDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; TBQueueDefault m a -&gt; STM m a
</span><a href="Control.Monad.IOSim.STM.html#peekTBQueueDefault"><span class="hs-identifier hs-var hs-var">peekTBQueueDefault</span></a></span></span><span> </span><span id="local-6989586621679132348"><span class="annot"><span class="annottext">TBQueueDefault m a
</span><a href="#local-6989586621679132348"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; (a -&gt; STM m a) -&gt; Maybe a -&gt; STM m a
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">STM m a
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m a
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; STM m a) -&gt; STM m (Maybe a) -&gt; STM m a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueueDefault m a -&gt; STM m (Maybe a)
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryPeekTBQueueDefault"><span class="hs-identifier hs-var">tryPeekTBQueueDefault</span></a></span><span> </span><span class="annot"><span class="annottext">TBQueueDefault m a
</span><a href="#local-6989586621679132348"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span id="local-6989586621679132350"><span id="local-6989586621679132351"><span class="annot"><a href="Control.Monad.IOSim.STM.html#tryPeekTBQueueDefault"><span class="hs-identifier hs-type">tryPeekTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132350"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132350"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132351"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132350"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132351"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-164"></span><span id="tryPeekTBQueueDefault"><span class="annot"><span class="annottext">tryPeekTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryPeekTBQueueDefault"><span class="hs-identifier hs-var hs-var">tryPeekTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132357"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132357"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132358"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132358"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679132359"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132359"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132357"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe a -&gt; STM m (Maybe a)) -&gt; Maybe a -&gt; STM m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132359"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679132360"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132360"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132360"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-168"></span><span>      </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span id="local-6989586621679132020"><span id="local-6989586621679132021"><span class="annot"><a href="Control.Monad.IOSim.STM.html#writeTBQueueDefault"><span class="hs-identifier hs-type">writeTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132021"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132021"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-171"></span><span id="writeTBQueueDefault"><span class="annot"><span class="annottext">writeTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; a -&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#writeTBQueueDefault"><span class="hs-identifier hs-var hs-var">writeTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132378"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132378"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132379"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132379"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132380"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132380"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679132381"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132381"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132382"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132382"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132383"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132383"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132384"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132384"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132378"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132384"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679132386"><span class="annot"><span class="annottext">w' :: Natural
</span><a href="#local-6989586621679132386"><span class="hs-identifier hs-var hs-var">w'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132384"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span>
</span><span id="line-175"></span><span>            </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132378"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], Natural, [a], Natural) -&gt; STM m ())
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132381"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132382"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132380"><span class="hs-identifier hs-var">a</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132383"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132386"><span class="hs-identifier hs-var">w'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132382"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679132387"><span class="annot"><span class="annottext">w' :: Natural
</span><a href="#local-6989586621679132387"><span class="hs-identifier hs-var hs-var">w'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132382"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-179"></span><span>                 </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132378"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132381"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132380"><span class="hs-identifier hs-var">a</span></a></span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132383"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132387"><span class="hs-identifier hs-var">w'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">STM m ()
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span id="local-6989586621679132024"><span id="local-6989586621679132025"><span class="annot"><a href="Control.Monad.IOSim.STM.html#isEmptyTBQueueDefault"><span class="hs-identifier hs-type">isEmptyTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132024"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132024"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132025"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132024"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span></span><span>
</span><span id="line-183"></span><span id="isEmptyTBQueueDefault"><span class="annot"><span class="annottext">isEmptyTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m Bool
</span><a href="Control.Monad.IOSim.STM.html#isEmptyTBQueueDefault"><span class="hs-identifier hs-var hs-var">isEmptyTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132396"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132396"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132397"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132397"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679132398"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132398"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132399"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132399"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132396"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132398"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132399"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-188"></span><span>             </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-189"></span><span>             </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span id="local-6989586621679132400"><span id="local-6989586621679132401"><span class="annot"><a href="Control.Monad.IOSim.STM.html#isFullTBQueueDefault"><span class="hs-identifier hs-type">isFullTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132400"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132400"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132401"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132400"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span></span><span>
</span><span id="line-192"></span><span id="isFullTBQueueDefault"><span class="annot"><span class="annottext">isFullTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m Bool
</span><a href="Control.Monad.IOSim.STM.html#isFullTBQueueDefault"><span class="hs-identifier hs-var hs-var">isFullTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132412"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132412"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132413"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132413"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132414"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132414"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132415"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132415"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132412"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; STM m Bool) -&gt; Bool -&gt; STM m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132415"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132414"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-199"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span id="local-6989586621679132030"><span id="local-6989586621679132031"><span class="annot"><a href="Control.Monad.IOSim.STM.html#lengthTBQueueDefault"><span class="hs-identifier hs-type">lengthTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132031"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132030"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-bignum-1.3/src/GHC.Num.Natural.html#Natural"><span class="hs-identifier hs-type">Natural</span></a></span></span></span><span>
</span><span id="line-202"></span><span id="lengthTBQueueDefault"><span class="annot"><span class="annottext">lengthTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m Natural
</span><a href="Control.Monad.IOSim.STM.html#lengthTBQueueDefault"><span class="hs-identifier hs-var hs-var">lengthTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132424"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132424"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132425"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132425"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132426"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132426"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132427"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132427"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132424"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><span class="annottext">Natural -&gt; STM m Natural
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; STM m Natural) -&gt; Natural -&gt; STM m Natural
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132425"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132426"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132427"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span id="local-6989586621679132034"><span id="local-6989586621679132035"><span class="annot"><a href="Control.Monad.IOSim.STM.html#flushTBQueueDefault"><span class="hs-identifier hs-type">flushTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132035"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679132035"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-207"></span><span id="flushTBQueueDefault"><span class="annot"><span class="annottext">flushTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; STM m [a]
</span><a href="Control.Monad.IOSim.STM.html#flushTBQueueDefault"><span class="hs-identifier hs-var hs-var">flushTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132441"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132441"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132442"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132442"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679132443"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132443"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132444"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132444"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132441"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132443"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132444"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; STM m [a]
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>      </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132441"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], Natural, [a], Natural) -&gt; STM m ())
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24%21"><span class="hs-operator hs-var">$!</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132442"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>      </span><span class="annot"><span class="annottext">[a] -&gt; STM m [a]
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132443"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a]
forall a. [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132444"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span id="local-6989586621679132447"><span id="local-6989586621679132448"><span class="annot"><a href="Control.Monad.IOSim.STM.html#unGetTBQueueDefault"><span class="hs-identifier hs-type">unGetTBQueueDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132447"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueueDefault"><span class="hs-identifier hs-type">TBQueueDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132447"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132448"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132448"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132447"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-216"></span><span id="unGetTBQueueDefault"><span class="annot"><span class="annottext">unGetTBQueueDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TBQueueDefault m a -&gt; a -&gt; STM m ()
</span><a href="Control.Monad.IOSim.STM.html#unGetTBQueueDefault"><span class="hs-identifier hs-var hs-var">unGetTBQueueDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#TBQueue"><span class="hs-identifier hs-type">TBQueue</span></a></span><span> </span><span id="local-6989586621679132465"><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132465"><span class="hs-identifier hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679132466"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132466"><span class="hs-identifier hs-var">_size</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132467"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132467"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679132468"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132468"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132469"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132469"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132470"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132470"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132471"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132471"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; STM m ([a], Natural, [a], Natural)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132465"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132469"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>     </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132465"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132467"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132468"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132469"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132470"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132471"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>     </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132471"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>             </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
-&gt; ([a], Natural, [a], Natural) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m ([a], Natural, [a], Natural)
</span><a href="#local-6989586621679132465"><span class="hs-identifier hs-var">queue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132467"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; [a]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132468"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132469"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679132470"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679132471"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>             </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">STM m ()
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">--</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- Default MVar implementation in terms of STM (used by sim)</span><span>
</span><span id="line-228"></span><span class="hs-comment">--</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- | A default 'MonadMVar' implementation is based on `TVar`'s.  An @MVar@</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- guarantees fairness.</span><span>
</span><span id="line-232"></span><span class="hs-comment">--</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- /Implementation details:/</span><span>
</span><span id="line-234"></span><span class="hs-comment">--</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- 'STM' does not guarantee fairness, instead it provide compositionally.</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- Fairness of 'putMVarDefault' and 'takeMVarDefault' is provided by tracking</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- queue of blocked operation in the 'MVarState', e.g.  when a 'putMVarDefault'</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- is scheduled on a full 'MVar', the request is put on to the back of the queue</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- together with a wakeup var.  When 'takeMVarDefault' executes, it returns the</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- value and is using the first element of the queue to set the new value of</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- the 'MVar' and signals next `putMVarDefault` operation to unblock.  This has</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- an effect as if all the racing `putMVarDefault` calls where executed in</span><span>
</span><span id="line-243"></span><span class="hs-comment">-- turns.</span><span>
</span><span id="line-244"></span><span class="hs-comment">--</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- Note that 'readMVar' has interesting semantics: it is guaranteed to read</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- the next value put using 'putMVar', and all readers will wake up, not just</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- the first. To support this, the implementation uses two queues in the empty</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- MVar case: one for threads blocked on 'takeMVar', and one for threads</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- blocked on 'readMVar'. The 'putMVar' has to wake up all readers and the</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- first \&quot;taker\&quot; (if any).</span><span>
</span><span id="line-251"></span><span class="hs-comment">--</span><span>
</span><span id="line-252"></span><span class="hs-keyword">newtype</span><span> </span><span id="MVarDefault"><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-var">MVarDefault</span></a></span></span><span> </span><span id="local-6989586621679132050"><span class="annot"><a href="#local-6989586621679132050"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679132051"><span class="annot"><a href="#local-6989586621679132051"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MVar"><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-var">MVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132050"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarState"><span class="hs-identifier hs-type">MVarState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132050"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132051"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-keyword">data</span><span> </span><span id="MVarState"><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarState"><span class="hs-identifier hs-var">MVarState</span></a></span></span><span> </span><span id="local-6989586621679132053"><span class="annot"><a href="#local-6989586621679132053"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679132054"><span class="annot"><a href="#local-6989586621679132054"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MVarEmpty"><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span></span><span>   </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Data.Deque.Strict.html#Deque"><span class="hs-identifier hs-type">Deque</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132053"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132054"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- blocked on take</span><span>
</span><span id="line-255"></span><span>                                 </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Data.Deque.Strict.html#Deque"><span class="hs-identifier hs-type">Deque</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132053"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132054"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- blocked on read</span><span>
</span><span id="line-256"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span id="MVarFull"><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span></span><span>  </span><span class="annot"><a href="#local-6989586621679132054"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Data.Deque.Strict.html#Deque"><span class="hs-identifier hs-type">Deque</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679132054"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132053"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- blocked on put</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span id="local-6989586621679132042"><span id="local-6989586621679132043"><span class="annot"><a href="Control.Monad.IOSim.STM.html#newEmptyMVarDefault"><span class="hs-identifier hs-type">newEmptyMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132042"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132043"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-260"></span><span id="newEmptyMVarDefault"><span class="annot"><span class="annottext">newEmptyMVarDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; m (MVarDefault m a)
</span><a href="Control.Monad.IOSim.STM.html#newEmptyMVarDefault"><span class="hs-identifier hs-var hs-var">newEmptyMVarDefault</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarDefault m a
forall (m :: * -&gt; *) a. TVar m (MVarState m a) -&gt; MVarDefault m a
</span><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-var">MVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar m (MVarState m a) -&gt; MVarDefault m a)
-&gt; m (TVar m (MVarState m a)) -&gt; m (MVarDefault m a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MVarState m a -&gt; m (TVar m (MVarState m a))
forall a. a -&gt; m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span id="local-6989586621679132056"><span id="local-6989586621679132057"><span class="annot"><a href="Control.Monad.IOSim.STM.html#newMVarDefault"><span class="hs-identifier hs-type">newMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132057"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132056"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132057"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-264"></span><span id="newMVarDefault"><span class="annot"><span class="annottext">newMVarDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (MVarDefault m a)
</span><a href="Control.Monad.IOSim.STM.html#newMVarDefault"><span class="hs-identifier hs-var hs-var">newMVarDefault</span></a></span></span><span> </span><span id="local-6989586621679132496"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132496"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarDefault m a
forall (m :: * -&gt; *) a. TVar m (MVarState m a) -&gt; MVarDefault m a
</span><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-var">MVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar m (MVarState m a) -&gt; MVarDefault m a)
-&gt; m (TVar m (MVarState m a)) -&gt; m (MVarDefault m a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MVarState m a -&gt; m (TVar m (MVarState m a))
forall a. a -&gt; m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132496"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span id="local-6989586621679132060"><span id="local-6989586621679132064"><span class="annot"><a href="Control.Monad.IOSim.STM.html#putMVarDefault"><span class="hs-identifier hs-type">putMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span>  </span><span class="annot"><a href="#local-6989586621679132060"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-268"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span>   </span><span class="annot"><a href="#local-6989586621679132060"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-269"></span><span>                  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679132063"><span class="annot"><a href="#local-6989586621679132063"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679132062"><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">tvar</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">tvar</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132060"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132063"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132062"><span class="hs-identifier hs-type">tvar</span></a></span><span>
</span><span id="line-270"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132060"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132064"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132064"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132060"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-272"></span><span id="putMVarDefault"><span class="annot"><span class="annottext">putMVarDefault :: forall (m :: * -&gt; *) a.
(MonadMask m, MonadSTM m,
 forall x tvar. (tvar ~ TVar m x) =&gt; Eq tvar) =&gt;
MVarDefault m a -&gt; a -&gt; m ()
</span><a href="Control.Monad.IOSim.STM.html#putMVarDefault"><span class="hs-identifier hs-var hs-var">putMVarDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span id="local-6989586621679132541"><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132541"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132542"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132542"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>    </span><span id="local-6989586621679132544"><span class="annot"><span class="annottext">Maybe (TVar m Bool)
</span><a href="#local-6989586621679132544"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Maybe (TVar m Bool)) -&gt; m (Maybe (TVar m Bool))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Maybe (TVar m Bool)) -&gt; m (Maybe (TVar m Bool)))
-&gt; STM m (Maybe (TVar m Bool)) -&gt; m (Maybe (TVar m Bool))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>      </span><span id="local-6989586621679132546"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132546"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132541"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132546"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-comment">-- It's full, add ourselves to the end of the 'put' blocked queue.</span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span id="local-6989586621679132547"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132547"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span id="local-6989586621679132548"><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132548"><span class="hs-identifier hs-var">putq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-278"></span><span>          </span><span id="local-6989586621679132549"><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132549"><span class="hs-identifier hs-var">putvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m (TVar m Bool)
forall a. a -&gt; STM m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (TVar m a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-279"></span><span>          </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132541"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132547"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a, TVar m Bool)
-&gt; Deque (a, TVar m Bool) -&gt; Deque (a, TVar m Bool)
forall a. a -&gt; Deque a -&gt; Deque a
</span><a href="Data.Deque.Strict.html#snoc"><span class="hs-identifier hs-var">Deque.snoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132542"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132549"><span class="hs-identifier hs-var">putvar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132548"><span class="hs-identifier hs-var">putq</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>          </span><span class="annot"><span class="annottext">Maybe (TVar m Bool) -&gt; STM m (Maybe (TVar m Bool))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m Bool -&gt; Maybe (TVar m Bool)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132549"><span class="hs-identifier hs-var">putvar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>        </span><span class="hs-comment">-- The MVar is empty. Wake up any threads blocked in readMVar.</span><span>
</span><span id="line-283"></span><span>        </span><span class="hs-comment">-- If there's at least one thread blocked in takeMVar, we wake up the</span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-comment">-- first, leaving the MVar empty. Otherwise the MVar becomes full.</span><span>
</span><span id="line-285"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span id="local-6989586621679132551"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132551"><span class="hs-identifier hs-var">takeq</span></a></span></span><span> </span><span id="local-6989586621679132552"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132552"><span class="hs-identifier hs-var">readq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>          </span><span class="annot"><span class="annottext">(TVar m (Maybe a) -&gt; STM m ())
-&gt; Deque (TVar m (Maybe a)) -&gt; STM m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679132554"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132554"><span class="hs-identifier hs-var">readvar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; Maybe a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132554"><span class="hs-identifier hs-var">readvar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132542"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132552"><span class="hs-identifier hs-var">readq</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Maybe (TVar m (Maybe a), Deque (TVar m (Maybe a)))
forall a. Deque a -&gt; Maybe (a, Deque a)
</span><a href="Data.Deque.Strict.html#uncons"><span class="hs-identifier hs-var">Deque.uncons</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132551"><span class="hs-identifier hs-var">takeq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>            </span><span class="annot"><span class="annottext">Maybe (TVar m (Maybe a), Deque (TVar m (Maybe a)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-290"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132541"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132542"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679132556"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132556"><span class="hs-identifier hs-var">takevar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132557"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132557"><span class="hs-identifier hs-var">takeq'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>              </span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; Maybe a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132556"><span class="hs-identifier hs-var">takevar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132542"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132541"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132557"><span class="hs-identifier hs-var">takeq'</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>          </span><span class="annot"><span class="annottext">Maybe (TVar m Bool) -&gt; STM m (Maybe (TVar m Bool))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TVar m Bool)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TVar m Bool)
</span><a href="#local-6989586621679132544"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-299"></span><span>      </span><span class="hs-comment">-- we have to block on our own putvar until we can complete the put</span><span>
</span><span id="line-300"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679132558"><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132558"><span class="hs-identifier hs-var">putvar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m Bool -&gt; STM m Bool
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132558"><span class="hs-identifier hs-var">putvar</span></a></span><span> </span><span class="annot"><span class="annottext">STM m Bool -&gt; (Bool -&gt; STM m ()) -&gt; STM m ()
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (m :: * -&gt; *). MonadSTM m =&gt; Bool -&gt; STM m ()
</span><span class="hs-identifier hs-var">check</span></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">m () -&gt; (SomeAsyncException -&gt; m ()) -&gt; m ()
forall e a. Exception e =&gt; m a -&gt; (e -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679132561"><span class="annot"><span class="annottext">e :: SomeAsyncException
</span><a href="#local-6989586621679132561"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#SomeAsyncException"><span class="hs-identifier hs-type">SomeAsyncException</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-304"></span><span>            </span><span id="local-6989586621679132576"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132576"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132541"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-305"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132576"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-306"></span><span>              </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span id="local-6989586621679132577"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132577"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span id="local-6989586621679132578"><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132578"><span class="hs-identifier hs-var">putq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-307"></span><span>                </span><span class="hs-comment">-- async exception was thrown while we were blocked on putvar;</span><span>
</span><span id="line-308"></span><span>                </span><span class="hs-comment">-- we need to remove it from the queue, otherwise we will have</span><span>
</span><span id="line-309"></span><span>                </span><span class="hs-comment">-- a space leak.</span><span>
</span><span id="line-310"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679132579"><span class="annot"><span class="annottext">putq' :: Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132579"><span class="hs-identifier hs-var hs-var">putq'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((a, TVar m Bool) -&gt; Bool)
-&gt; Deque (a, TVar m Bool) -&gt; Deque (a, TVar m Bool)
forall a. (a -&gt; Bool) -&gt; Deque a -&gt; Deque a
</span><a href="Data.Deque.Strict.html#filter"><span class="hs-identifier hs-var">Deque.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m Bool -&gt; TVar m Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132558"><span class="hs-identifier hs-var">putvar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TVar m Bool -&gt; Bool)
-&gt; ((a, TVar m Bool) -&gt; TVar m Bool) -&gt; (a, TVar m Bool) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(a, TVar m Bool) -&gt; TVar m Bool
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132578"><span class="hs-identifier hs-var">putq</span></a></span><span>
</span><span id="line-311"></span><span>                </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132541"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132577"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132579"><span class="hs-identifier hs-var">putq'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>              </span><span class="hs-comment">-- This case is unlikely but possible if another thread ran</span><span>
</span><span id="line-314"></span><span>              </span><span class="hs-comment">-- first and modified the mvar. This situation is fine as far as</span><span>
</span><span id="line-315"></span><span>              </span><span class="hs-comment">-- space leaks are concerned because it means our wait var is no</span><span>
</span><span id="line-316"></span><span>              </span><span class="hs-comment">-- longer in the wait queue.</span><span>
</span><span id="line-317"></span><span>              </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM m ()
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>          </span><span class="annot"><span class="annottext">SomeAsyncException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeAsyncException
</span><a href="#local-6989586621679132561"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-comment">-- we managed to do the put synchronously</span><span>
</span><span id="line-321"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TVar m Bool)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span id="local-6989586621679132098"><span id="local-6989586621679132099"><span class="annot"><a href="Control.Monad.IOSim.STM.html#tryPutMVarDefault"><span class="hs-identifier hs-type">tryPutMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132098"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-325"></span><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132098"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132099"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132099"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132098"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span></span><span>
</span><span id="line-326"></span><span id="tryPutMVarDefault"><span class="annot"><span class="annottext">tryPutMVarDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
MVarDefault m a -&gt; a -&gt; m Bool
</span><a href="Control.Monad.IOSim.STM.html#tryPutMVarDefault"><span class="hs-identifier hs-var hs-var">tryPutMVarDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span id="local-6989586621679132606"><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132606"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679132607"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132607"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">STM m Bool -&gt; m Bool
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m Bool -&gt; m Bool) -&gt; STM m Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>      </span><span id="local-6989586621679132608"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132608"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132606"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132608"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-comment">-- The MVar is empty. Wake up any threads blocked in readMVar.</span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-comment">-- If there's at least one thread blocked in takeMVar, we wake up the</span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-comment">-- first, leaving the MVar empty. Otherwise the MVar becomes full.</span><span>
</span><span id="line-335"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span id="local-6989586621679132609"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132609"><span class="hs-identifier hs-var">takeq</span></a></span></span><span> </span><span id="local-6989586621679132610"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132610"><span class="hs-identifier hs-var">readq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>          </span><span class="annot"><span class="annottext">(TVar m (Maybe a) -&gt; STM m ())
-&gt; Deque (TVar m (Maybe a)) -&gt; STM m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679132611"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132611"><span class="hs-identifier hs-var">readvar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; Maybe a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132611"><span class="hs-identifier hs-var">readvar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132607"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132610"><span class="hs-identifier hs-var">readq</span></a></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Maybe (TVar m (Maybe a), Deque (TVar m (Maybe a)))
forall a. Deque a -&gt; Maybe (a, Deque a)
</span><a href="Data.Deque.Strict.html#uncons"><span class="hs-identifier hs-var">Deque.uncons</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132609"><span class="hs-identifier hs-var">takeq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-340"></span><span>            </span><span class="annot"><span class="annottext">Maybe (TVar m (Maybe a), Deque (TVar m (Maybe a)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-341"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132606"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132607"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679132612"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132612"><span class="hs-identifier hs-var">takevar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132613"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132613"><span class="hs-identifier hs-var">takeq'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>              </span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; Maybe a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132612"><span class="hs-identifier hs-var">takevar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132607"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132606"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132613"><span class="hs-identifier hs-var">takeq'</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span id="local-6989586621679132102"><span id="local-6989586621679132105"><span class="annot"><a href="Control.Monad.IOSim.STM.html#takeMVarDefault"><span class="hs-identifier hs-type">takeMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679132102"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-351"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span>  </span><span class="annot"><a href="#local-6989586621679132102"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-352"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679132104"><span class="annot"><a href="#local-6989586621679132104"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679132103"><span class="annot"><a href="#local-6989586621679132103"><span class="hs-identifier hs-type">tvar</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679132103"><span class="hs-identifier hs-type">tvar</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132104"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132103"><span class="hs-identifier hs-type">tvar</span></a></span><span>
</span><span id="line-353"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132105"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-355"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132105"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-356"></span><span id="takeMVarDefault"><span class="annot"><span class="annottext">takeMVarDefault :: forall (m :: * -&gt; *) a.
(MonadMask m, MonadSTM m,
 forall x tvar. (tvar ~ TVar m x) =&gt; Eq tvar) =&gt;
MVarDefault m a -&gt; m a
</span><a href="Control.Monad.IOSim.STM.html#takeMVarDefault"><span class="hs-identifier hs-var hs-var">takeMVarDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span id="local-6989586621679132653"><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132653"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a -&gt; m a
forall a. m a -&gt; m a
forall (m :: * -&gt; *) a. MonadMask m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(m a -&gt; m a) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>    </span><span id="local-6989586621679132654"><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a
</span><a href="#local-6989586621679132654"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Either (TVar m (Maybe a)) a)
-&gt; m (Either (TVar m (Maybe a)) a)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Either (TVar m (Maybe a)) a)
 -&gt; m (Either (TVar m (Maybe a)) a))
-&gt; STM m (Either (TVar m (Maybe a)) a)
-&gt; m (Either (TVar m (Maybe a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>      </span><span id="local-6989586621679132655"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132655"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132653"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-359"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132655"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-comment">-- It's empty, add ourselves to the end of the 'take' blocked queue.</span><span>
</span><span id="line-361"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span id="local-6989586621679132656"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132656"><span class="hs-identifier hs-var">takeq</span></a></span></span><span> </span><span id="local-6989586621679132657"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132657"><span class="hs-identifier hs-var">readq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>          </span><span id="local-6989586621679132658"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132658"><span class="hs-identifier hs-var">takevar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (TVar m (Maybe a))
forall a. a -&gt; STM m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (TVar m a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-363"></span><span>          </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132653"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a)
-&gt; Deque (TVar m (Maybe a)) -&gt; Deque (TVar m (Maybe a))
forall a. a -&gt; Deque a -&gt; Deque a
</span><a href="Data.Deque.Strict.html#snoc"><span class="hs-identifier hs-var">Deque.snoc</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132658"><span class="hs-identifier hs-var">takevar</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132656"><span class="hs-identifier hs-var">takeq</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132657"><span class="hs-identifier hs-var">readq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>          </span><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a -&gt; STM m (Either (TVar m (Maybe a)) a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; Either (TVar m (Maybe a)) a
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132658"><span class="hs-identifier hs-var">takevar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span>        </span><span class="hs-comment">-- It's full. If there's at least one thread blocked in putMVar, wake</span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-comment">-- up the first one leaving the MVar full with the new put value.</span><span>
</span><span id="line-368"></span><span>        </span><span class="hs-comment">-- Otherwise the MVar becomes empty.</span><span>
</span><span id="line-369"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span id="local-6989586621679132659"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132659"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679132660"><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132660"><span class="hs-identifier hs-var">putq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-370"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
-&gt; Maybe ((a, TVar m Bool), Deque (a, TVar m Bool))
forall a. Deque a -&gt; Maybe (a, Deque a)
</span><a href="Data.Deque.Strict.html#uncons"><span class="hs-identifier hs-var">Deque.uncons</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132660"><span class="hs-identifier hs-var">putq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-371"></span><span>            </span><span class="annot"><span class="annottext">Maybe ((a, TVar m Bool), Deque (a, TVar m Bool))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132653"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>              </span><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a -&gt; STM m (Either (TVar m (Maybe a)) a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Either (TVar m (Maybe a)) a
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132659"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679132661"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132661"><span class="hs-identifier hs-var">x'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132662"><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132662"><span class="hs-identifier hs-var">putvar</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132663"><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132663"><span class="hs-identifier hs-var">putq'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-376"></span><span>              </span><span class="annot"><span class="annottext">TVar m Bool -&gt; Bool -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132662"><span class="hs-identifier hs-var">putvar</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-377"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132653"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132661"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132663"><span class="hs-identifier hs-var">putq'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>              </span><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a -&gt; STM m (Either (TVar m (Maybe a)) a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Either (TVar m (Maybe a)) a
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132659"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a
</span><a href="#local-6989586621679132654"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-381"></span><span>      </span><span class="hs-comment">-- we have to block on our own takevar until we can complete the read</span><span>
</span><span id="line-382"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679132664"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132664"><span class="hs-identifier hs-var">takevar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-383"></span><span>        </span><span class="annot"><span class="annottext">STM m a -&gt; m a
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; STM m (Maybe a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132664"><span class="hs-identifier hs-var">takevar</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Maybe a) -&gt; (Maybe a -&gt; STM m a) -&gt; STM m a
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; (a -&gt; STM m a) -&gt; Maybe a -&gt; STM m a
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">STM m a
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m a
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>        </span><span class="annot"><span class="annottext">m a -&gt; (SomeAsyncException -&gt; m a) -&gt; m a
forall e a. Exception e =&gt; m a -&gt; (e -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679132665"><span class="annot"><span class="annottext">e :: SomeAsyncException
</span><a href="#local-6989586621679132665"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#SomeAsyncException"><span class="hs-identifier hs-type">SomeAsyncException</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-386"></span><span>            </span><span id="local-6989586621679132679"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132679"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132653"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-387"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132679"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-388"></span><span>              </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span id="local-6989586621679132680"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132680"><span class="hs-identifier hs-var">takeq</span></a></span></span><span> </span><span id="local-6989586621679132681"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132681"><span class="hs-identifier hs-var">readq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-389"></span><span>                </span><span class="hs-comment">-- async exception was thrown while were were blocked on</span><span>
</span><span id="line-390"></span><span>                </span><span class="hs-comment">-- takevar; we need to remove it from 'takeq', otherwise we</span><span>
</span><span id="line-391"></span><span>                </span><span class="hs-comment">-- will have a space leak.</span><span>
</span><span id="line-392"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679132682"><span class="annot"><span class="annottext">takeq' :: Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132682"><span class="hs-identifier hs-var hs-var">takeq'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TVar m (Maybe a) -&gt; Bool)
-&gt; Deque (TVar m (Maybe a)) -&gt; Deque (TVar m (Maybe a))
forall a. (a -&gt; Bool) -&gt; Deque a -&gt; Deque a
</span><a href="Data.Deque.Strict.html#filter"><span class="hs-identifier hs-var">Deque.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; TVar m (Maybe a) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132664"><span class="hs-identifier hs-var">takevar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132680"><span class="hs-identifier hs-var">takeq</span></a></span><span>
</span><span id="line-393"></span><span>                </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132653"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132682"><span class="hs-identifier hs-var">takeq'</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132681"><span class="hs-identifier hs-var">readq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>              </span><span class="hs-comment">-- This case is unlikely but possible if another thread ran</span><span>
</span><span id="line-396"></span><span>              </span><span class="hs-comment">-- first and modified the mvar. This situation is fine as far as</span><span>
</span><span id="line-397"></span><span>              </span><span class="hs-comment">-- space leaks are concerned because it means our wait var is no</span><span>
</span><span id="line-398"></span><span>              </span><span class="hs-comment">-- longer in the wait queue.</span><span>
</span><span id="line-399"></span><span>              </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM m ()
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>          </span><span class="annot"><span class="annottext">SomeAsyncException -&gt; m a
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeAsyncException
</span><a href="#local-6989586621679132665"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-comment">-- we managed to do the take synchronously</span><span>
</span><span id="line-403"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679132683"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132683"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132683"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span id="local-6989586621679132111"><span id="local-6989586621679132112"><span class="annot"><a href="Control.Monad.IOSim.STM.html#tryTakeMVarDefault"><span class="hs-identifier hs-type">tryTakeMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132111"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-407"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132112"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-408"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132112"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-409"></span><span id="tryTakeMVarDefault"><span class="annot"><span class="annottext">tryTakeMVarDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
MVarDefault m a -&gt; m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryTakeMVarDefault"><span class="hs-identifier hs-var hs-var">tryTakeMVarDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span id="local-6989586621679132703"><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132703"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>    </span><span class="annot"><span class="annottext">STM m (Maybe a) -&gt; m (Maybe a)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Maybe a) -&gt; m (Maybe a)) -&gt; STM m (Maybe a) -&gt; m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-411"></span><span>      </span><span id="local-6989586621679132704"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132704"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132703"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-412"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132704"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-413"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span>        </span><span class="hs-comment">-- It's full. If there's at least one thread blocked in putMVar, wake</span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-comment">-- up the first one leaving the MVar full with the new put value.</span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-comment">-- Otherwise the MVar becomes empty.</span><span>
</span><span id="line-418"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span id="local-6989586621679132705"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132705"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679132706"><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132706"><span class="hs-identifier hs-var">putq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-419"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
-&gt; Maybe ((a, TVar m Bool), Deque (a, TVar m Bool))
forall a. Deque a -&gt; Maybe (a, Deque a)
</span><a href="Data.Deque.Strict.html#uncons"><span class="hs-identifier hs-var">Deque.uncons</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132706"><span class="hs-identifier hs-var">putq</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-420"></span><span>            </span><span class="annot"><span class="annottext">Maybe ((a, TVar m Bool), Deque (a, TVar m Bool))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-421"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132703"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>              </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132705"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679132707"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132707"><span class="hs-identifier hs-var">x'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132708"><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132708"><span class="hs-identifier hs-var">putvar</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679132709"><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132709"><span class="hs-identifier hs-var">putq'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>              </span><span class="annot"><span class="annottext">TVar m Bool -&gt; Bool -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679132708"><span class="hs-identifier hs-var">putvar</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-426"></span><span>              </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132703"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
a -&gt; Deque (a, TVar m Bool) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-var">MVarFull</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132707"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><a href="#local-6989586621679132709"><span class="hs-identifier hs-var">putq'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>              </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132705"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span class="hs-comment">-- | 'readMVarDefault' when the 'MVar' is empty, guarantees to receive next</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- 'putMVar' value.  It will also not block if the 'MVar' is full, even if there</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- are other threads attempting to 'putMVar'.</span><span>
</span><span id="line-433"></span><span class="hs-comment">--</span><span>
</span><span id="line-434"></span><span id="local-6989586621679132115"><span id="local-6989586621679132118"><span class="annot"><a href="Control.Monad.IOSim.STM.html#readMVarDefault"><span class="hs-identifier hs-type">readMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132115"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-435"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679132115"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-436"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679132117"><span class="annot"><a href="#local-6989586621679132117"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679132116"><span class="annot"><a href="#local-6989586621679132116"><span class="hs-identifier hs-type">tvar</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679132116"><span class="hs-identifier hs-type">tvar</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679132115"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132117"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132116"><span class="hs-identifier hs-type">tvar</span></a></span><span>
</span><span id="line-437"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132115"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132118"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-439"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132115"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132118"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-440"></span><span id="readMVarDefault"><span class="annot"><span class="annottext">readMVarDefault :: forall (m :: * -&gt; *) a.
(MonadSTM m, MonadMask m,
 forall x tvar. (tvar ~ TVar m x) =&gt; Eq tvar) =&gt;
MVarDefault m a -&gt; m a
</span><a href="Control.Monad.IOSim.STM.html#readMVarDefault"><span class="hs-identifier hs-var hs-var">readMVarDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span id="local-6989586621679132740"><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132740"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621679132741"><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a
</span><a href="#local-6989586621679132741"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Either (TVar m (Maybe a)) a)
-&gt; m (Either (TVar m (Maybe a)) a)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Either (TVar m (Maybe a)) a)
 -&gt; m (Either (TVar m (Maybe a)) a))
-&gt; STM m (Either (TVar m (Maybe a)) a)
-&gt; m (Either (TVar m (Maybe a)) a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>      </span><span id="local-6989586621679132742"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132742"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132740"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-443"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132742"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-comment">-- It's empty, add ourselves to the 'read' blocked queue.</span><span>
</span><span id="line-445"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span id="local-6989586621679132743"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132743"><span class="hs-identifier hs-var">takeq</span></a></span></span><span> </span><span id="local-6989586621679132744"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132744"><span class="hs-identifier hs-var">readq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-446"></span><span>          </span><span id="local-6989586621679132745"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132745"><span class="hs-identifier hs-var">readvar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (TVar m (Maybe a))
forall a. a -&gt; STM m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; STM m (TVar m a)
</span><span class="hs-identifier hs-var">newTVar</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-447"></span><span>          </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132740"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132743"><span class="hs-identifier hs-var">takeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a)
-&gt; Deque (TVar m (Maybe a)) -&gt; Deque (TVar m (Maybe a))
forall a. a -&gt; Deque a -&gt; Deque a
</span><a href="Data.Deque.Strict.html#snoc"><span class="hs-identifier hs-var">Deque.snoc</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132745"><span class="hs-identifier hs-var">readvar</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132744"><span class="hs-identifier hs-var">readq</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>          </span><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a -&gt; STM m (Either (TVar m (Maybe a)) a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; Either (TVar m (Maybe a)) a
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132745"><span class="hs-identifier hs-var">readvar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span>        </span><span class="hs-comment">-- if it's full return the value</span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span id="local-6989586621679132746"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132746"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a -&gt; STM m (Either (TVar m (Maybe a)) a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Either (TVar m (Maybe a)) a
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132746"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (TVar m (Maybe a)) a
</span><a href="#local-6989586621679132741"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-454"></span><span>      </span><span class="hs-comment">-- we have to block on our own readvar until we can complete the read</span><span>
</span><span id="line-455"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679132747"><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132747"><span class="hs-identifier hs-var">readvar</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-456"></span><span>        </span><span class="annot"><span class="annottext">STM m a -&gt; m a
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; STM m (Maybe a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132747"><span class="hs-identifier hs-var">readvar</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Maybe a) -&gt; (Maybe a -&gt; STM m a) -&gt; STM m a
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">STM m a -&gt; (a -&gt; STM m a) -&gt; Maybe a -&gt; STM m a
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">STM m a
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m a
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><span class="annottext">m a -&gt; (SomeAsyncException -&gt; m a) -&gt; m a
forall e a. Exception e =&gt; m a -&gt; (e -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679132748"><span class="annot"><span class="annottext">e :: SomeAsyncException
</span><a href="#local-6989586621679132748"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#SomeAsyncException"><span class="hs-identifier hs-type">SomeAsyncException</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-458"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-459"></span><span>            </span><span id="local-6989586621679132762"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132762"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132740"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-460"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132762"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-461"></span><span>              </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span id="local-6989586621679132763"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132763"><span class="hs-identifier hs-var">takeq</span></a></span></span><span> </span><span id="local-6989586621679132764"><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132764"><span class="hs-identifier hs-var">readq</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>                </span><span class="hs-comment">-- async exception was thrown while were were blocked on</span><span>
</span><span id="line-463"></span><span>                </span><span class="hs-comment">-- readvar; we need to remove it from 'readq', otherwise we</span><span>
</span><span id="line-464"></span><span>                </span><span class="hs-comment">-- will have a space leak.</span><span>
</span><span id="line-465"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679132765"><span class="annot"><span class="annottext">readq' :: Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132765"><span class="hs-identifier hs-var hs-var">readq'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TVar m (Maybe a) -&gt; Bool)
-&gt; Deque (TVar m (Maybe a)) -&gt; Deque (TVar m (Maybe a))
forall a. (a -&gt; Bool) -&gt; Deque a -&gt; Deque a
</span><a href="Data.Deque.Strict.html#filter"><span class="hs-identifier hs-var">Deque.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Maybe a) -&gt; TVar m (Maybe a) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe a)
</span><a href="#local-6989586621679132747"><span class="hs-identifier hs-var">readvar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132764"><span class="hs-identifier hs-var">readq</span></a></span><span>
</span><span id="line-466"></span><span>                </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; MVarState m a -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132740"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
forall (m :: * -&gt; *) a.
Deque (TVar m (Maybe a))
-&gt; Deque (TVar m (Maybe a)) -&gt; MVarState m a
</span><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-var">MVarEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132763"><span class="hs-identifier hs-var">takeq</span></a></span><span> </span><span class="annot"><span class="annottext">Deque (TVar m (Maybe a))
</span><a href="#local-6989586621679132765"><span class="hs-identifier hs-var">readq'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>              </span><span class="hs-comment">-- This case is unlikely but possible if another thread ran</span><span>
</span><span id="line-469"></span><span>              </span><span class="hs-comment">-- first and modified the mvar. This situation is fine as far as</span><span>
</span><span id="line-470"></span><span>              </span><span class="hs-comment">-- space leaks are concerned because it means our wait var is no</span><span>
</span><span id="line-471"></span><span>              </span><span class="hs-comment">-- longer in the wait queue.</span><span>
</span><span id="line-472"></span><span>              </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM m ()
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>          </span><span class="annot"><span class="annottext">SomeAsyncException -&gt; m a
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeAsyncException
</span><a href="#local-6989586621679132748"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>      </span><span class="hs-comment">-- we managed to do the take synchronously</span><span>
</span><span id="line-476"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679132766"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132766"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132766"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span id="local-6989586621679132767"><span id="local-6989586621679132768"><span class="annot"><a href="Control.Monad.IOSim.STM.html#tryReadMVarDefault"><span class="hs-identifier hs-type">tryReadMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679132767"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-480"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132767"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132768"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132767"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132768"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-481"></span><span id="tryReadMVarDefault"><span class="annot"><span class="annottext">tryReadMVarDefault :: forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
MVarDefault m a -&gt; m (Maybe a)
</span><a href="Control.Monad.IOSim.STM.html#tryReadMVarDefault"><span class="hs-identifier hs-var hs-var">tryReadMVarDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span id="local-6989586621679132779"><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132779"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><span class="annottext">STM m (Maybe a) -&gt; m (Maybe a)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Maybe a) -&gt; m (Maybe a)) -&gt; STM m (Maybe a) -&gt; m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-483"></span><span>      </span><span id="local-6989586621679132780"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132780"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132779"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132780"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-485"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span>  </span><span id="local-6989586621679132781"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132781"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">Deque (a, TVar m Bool)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679132781"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; STM m (Maybe a)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span id="local-6989586621679132124"><span id="local-6989586621679132125"><span class="annot"><a href="Control.Monad.IOSim.STM.html#isEmptyMVarDefault"><span class="hs-identifier hs-type">isEmptyMVarDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span>  </span><span class="annot"><a href="#local-6989586621679132124"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-490"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarDefault"><span class="hs-identifier hs-type">MVarDefault</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132124"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679132125"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679132124"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span></span><span>
</span><span id="line-491"></span><span id="isEmptyMVarDefault"><span class="annot"><span class="annottext">isEmptyMVarDefault :: forall (m :: * -&gt; *) a. MonadSTM m =&gt; MVarDefault m a -&gt; m Bool
</span><a href="Control.Monad.IOSim.STM.html#isEmptyMVarDefault"><span class="hs-identifier hs-var hs-var">isEmptyMVarDefault</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVar"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span id="local-6989586621679132792"><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132792"><span class="hs-identifier hs-var">tv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-492"></span><span>    </span><span class="annot"><span class="annottext">STM m Bool -&gt; m Bool
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m Bool -&gt; m Bool) -&gt; STM m Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-493"></span><span>      </span><span id="local-6989586621679132793"><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132793"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a) -&gt; STM m (MVarState m a)
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (MVarState m a)
</span><a href="#local-6989586621679132792"><span class="hs-identifier hs-var">tv</span></a></span><span>
</span><span id="line-494"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MVarState m a
</span><a href="#local-6989586621679132793"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarFull"><span class="hs-identifier hs-type">MVarFull</span></a></span><span>  </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-496"></span><span>        </span><span class="annot"><a href="Control.Monad.IOSim.STM.html#MVarEmpty"><span class="hs-identifier hs-type">MVarEmpty</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM m Bool
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-497"></span></pre></body></html>
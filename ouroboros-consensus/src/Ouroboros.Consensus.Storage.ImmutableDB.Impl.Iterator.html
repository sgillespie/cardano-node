<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass      #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric       #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving  #-}</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier">CurrentChunkInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#extractBlockComponent"><span class="hs-identifier">extractBlockComponent</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#getSlotInfo"><span class="hs-identifier">getSlotInfo</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#streamImpl"><span class="hs-identifier">streamImpl</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Cardano.Prelude</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">forceElemsToWHNF</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Read</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier">void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier">ExceptT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier">runExceptT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier">throwError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lazy</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Short.html"><span class="hs-identifier">Data.ByteString.Short</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Short</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#find"><span class="hs-identifier">find</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%26%3E"><span class="hs-operator">(&lt;&amp;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier">NonEmpty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier">headerHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Common</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.API</span></a></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-33"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getBlockComponent"><span class="hs-identifier">getBlockComponent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier">Index</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Index</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary</span></a></span><span>
</span><span id="line-38"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier">SecondaryOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a></span><span>
</span><span id="line-40"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockOffset"><span class="hs-identifier">BlockOffset</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier">BlockSize</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Secondary</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.State</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Serialisation</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceKey"><span class="hs-identifier">ResourceKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier">ResourceRegistry</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocate"><span class="hs-identifier">allocate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#release"><span class="hs-identifier">release</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#unsafeRelease"><span class="hs-identifier">unsafeRelease</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.SizeInBytes</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API.Lazy</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.CRC</span></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-comment">{------------------------------------------------------------------------------
  ImmutableDB Iterator Implementation
------------------------------------------------------------------------------}</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-comment">-- | Internal handle to an iterator.</span><span>
</span><span id="line-58"></span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- Note: in contrast to 'IteratorState', these fields remain static for the</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- lifetime of the iterator.</span><span>
</span><span id="line-61"></span><span class="hs-keyword">data</span><span> </span><span id="IteratorHandle"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-var">IteratorHandle</span></a></span></span><span> </span><span id="local-6989586621679867245"><span class="annot"><a href="#local-6989586621679867245"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867246"><span class="annot"><a href="#local-6989586621679867246"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679867247"><span class="annot"><a href="#local-6989586621679867247"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="IteratorHandle"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-var">IteratorHandle</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-62"></span><span>      </span><span id="ithHasFS"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. IteratorHandle m blk h -&gt; HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithHasFS"><span class="hs-identifier hs-var hs-var">ithHasFS</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679867245"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867247"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Bundled HasFS instance because of the existential @h@.</span></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ithIndex"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. IteratorHandle m blk h -&gt; Index m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithIndex"><span class="hs-identifier hs-var hs-var">ithIndex</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867245"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867246"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867247"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ Bundled Index instance because of the existential @h@.</span></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ithVarState"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
IteratorHandle m blk h
-&gt; StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithVarState"><span class="hs-identifier hs-var hs-var">ithVarState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679867245"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOrExhausted"><span class="hs-identifier hs-type">IteratorStateOrExhausted</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867245"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867246"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867247"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The state of the iterator</span></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ithEndChunk"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. IteratorHandle m blk h -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithEndChunk"><span class="hs-identifier hs-var hs-var">ithEndChunk</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-69"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The chunk in which the last block to stream is located.</span></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="ithEndHash"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
IteratorHandle m blk h -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithEndHash"><span class="hs-identifier hs-var hs-var">ithEndHash</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679867246"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The has of the last block the iterator should return.</span></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">data</span><span> </span><span id="IteratorStateOrExhausted"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOrExhausted"><span class="hs-identifier hs-var">IteratorStateOrExhausted</span></a></span></span><span> </span><span id="local-6989586621679867469"><span class="annot"><a href="#local-6989586621679867469"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867470"><span class="annot"><a href="#local-6989586621679867470"><span class="hs-identifier hs-type">hash</span></a></span></span><span> </span><span id="local-6989586621679867471"><span class="annot"><a href="#local-6989586621679867471"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-75"></span><span>    </span><span id="IteratorStateOpen"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-var">IteratorStateOpen</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867469"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867470"><span class="hs-identifier hs-type">hash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867471"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="IteratorStateExhausted"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateExhausted"><span class="hs-identifier hs-var">IteratorStateExhausted</span></a></span></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679867721"><span id="local-6989586621679867723"><span class="annot"><span class="annottext">(forall x.
 IteratorStateOrExhausted m hash h
 -&gt; Rep (IteratorStateOrExhausted m hash h) x)
-&gt; (forall x.
    Rep (IteratorStateOrExhausted m hash h) x
    -&gt; IteratorStateOrExhausted m hash h)
-&gt; Generic (IteratorStateOrExhausted m hash h)
forall x.
Rep (IteratorStateOrExhausted m hash h) x
-&gt; IteratorStateOrExhausted m hash h
forall x.
IteratorStateOrExhausted m hash h
-&gt; Rep (IteratorStateOrExhausted m hash h) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (m :: * -&gt; *) hash h x.
Rep (IteratorStateOrExhausted m hash h) x
-&gt; IteratorStateOrExhausted m hash h
forall (m :: * -&gt; *) hash h x.
IteratorStateOrExhausted m hash h
-&gt; Rep (IteratorStateOrExhausted m hash h) x
$cfrom :: forall (m :: * -&gt; *) hash h x.
IteratorStateOrExhausted m hash h
-&gt; Rep (IteratorStateOrExhausted m hash h) x
from :: forall x.
IteratorStateOrExhausted m hash h
-&gt; Rep (IteratorStateOrExhausted m hash h) x
$cto :: forall (m :: * -&gt; *) hash h x.
Rep (IteratorStateOrExhausted m hash h) x
-&gt; IteratorStateOrExhausted m hash h
to :: forall x.
Rep (IteratorStateOrExhausted m hash h) x
-&gt; IteratorStateOrExhausted m hash h
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867729"><span id="local-6989586621679867733"><span id="local-6989586621679867739"><span class="annot"><span class="annottext">Context
-&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo)
Proxy (IteratorStateOrExhausted m hash h) -&gt; String
(Context
 -&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo))
-&gt; (Context
    -&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (IteratorStateOrExhausted m hash h) -&gt; String)
-&gt; NoThunks (IteratorStateOrExhausted m hash h)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *) hash h.
(StandardHash hash, IOLike m) =&gt;
Context
-&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *) hash h.
(StandardHash hash, IOLike m) =&gt;
Proxy (IteratorStateOrExhausted m hash h) -&gt; String
$cnoThunks :: forall (m :: * -&gt; *) hash h.
(StandardHash hash, IOLike m) =&gt;
Context
-&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo)
noThunks :: Context
-&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *) hash h.
(StandardHash hash, IOLike m) =&gt;
Context
-&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context
-&gt; IteratorStateOrExhausted m hash h -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall (m :: * -&gt; *) hash h.
(StandardHash hash, IOLike m) =&gt;
Proxy (IteratorStateOrExhausted m hash h) -&gt; String
showTypeOf :: Proxy (IteratorStateOrExhausted m hash h) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-keyword">data</span><span> </span><span id="IteratorState"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-var">IteratorState</span></a></span></span><span> </span><span id="local-6989586621679867327"><span class="annot"><a href="#local-6989586621679867327"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867328"><span class="annot"><a href="#local-6989586621679867328"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679867329"><span class="annot"><a href="#local-6989586621679867329"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="IteratorState"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-var">IteratorState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-80"></span><span>      </span><span id="itsChunk"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunk"><span class="hs-identifier hs-var hs-var">itsChunk</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-81"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The current chunk the iterator is streaming from.</span></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="itsChunkHandle"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; Handle h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkHandle"><span class="hs-identifier hs-var hs-var">itsChunkHandle</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="annot"><a href="#local-6989586621679867329"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ A handle to the chunk file corresponding with 'itsChunk'.</span></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="itsChunkKey"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; ResourceKey m
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkKey"><span class="hs-identifier hs-var hs-var">itsChunkKey</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceKey"><span class="hs-identifier hs-type">ResourceKey</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867327"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-comment">-- ^ The 'ResourceKey' corresponding to the 'itsChunkHandle'. We use it to</span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-comment">-- release the handle from the 'ResourceRegistry'.</span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-comment">-- NOTE: if we only close the handle but don't release the resource, the</span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-comment">-- registry will still hold on to the (closed) handle/resource.</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="itsChunkEntries"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
IteratorState m blk h -&gt; NonEmpty (WithBlockSize (Entry blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkEntries"><span class="hs-identifier hs-var hs-var">itsChunkEntries</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-type">WithBlockSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867328"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-comment">-- ^ The entries from the secondary index corresponding to the current</span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-comment">-- chunk. The first entry in the list is the next one to stream.</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-comment">-- Invariant: all the entries in this list must be included in the stream.</span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-comment">-- In other words, entries corresponding to blocks after the end bound are</span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-comment">-- not included in this list.</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679867772"><span id="local-6989586621679867774"><span class="annot"><span class="annottext">(forall x. IteratorState m blk h -&gt; Rep (IteratorState m blk h) x)
-&gt; (forall x.
    Rep (IteratorState m blk h) x -&gt; IteratorState m blk h)
-&gt; Generic (IteratorState m blk h)
forall x. Rep (IteratorState m blk h) x -&gt; IteratorState m blk h
forall x. IteratorState m blk h -&gt; Rep (IteratorState m blk h) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall (m :: * -&gt; *) blk h x.
Rep (IteratorState m blk h) x -&gt; IteratorState m blk h
forall (m :: * -&gt; *) blk h x.
IteratorState m blk h -&gt; Rep (IteratorState m blk h) x
$cfrom :: forall (m :: * -&gt; *) blk h x.
IteratorState m blk h -&gt; Rep (IteratorState m blk h) x
from :: forall x. IteratorState m blk h -&gt; Rep (IteratorState m blk h) x
$cto :: forall (m :: * -&gt; *) blk h x.
Rep (IteratorState m blk h) x -&gt; IteratorState m blk h
to :: forall x. Rep (IteratorState m blk h) x -&gt; IteratorState m blk h
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span id="local-6989586621679867324"><span id="local-6989586621679867325"><span id="local-6989586621679867326"><span id="local-6989586621679867779"><span id="local-6989586621679867782"><span id="local-6989586621679867788"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StandardHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679867324"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867325"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867324"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867326"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="hs-comment">-- | Auxiliary data type that combines the 'currentChunk' and</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- 'currentChunkOffset' fields from 'OpenState'. This is used to avoid passing</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- the whole state around, and moreover, it avoids issues with existential @h@</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- type parameter.</span><span>
</span><span id="line-106"></span><span class="hs-keyword">data</span><span> </span><span id="CurrentChunkInfo"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier hs-var">CurrentChunkInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CurrentChunkInfo"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier hs-var">CurrentChunkInfo</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockOffset"><span class="hs-identifier hs-type">BlockOffset</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#streamImpl"><span class="hs-identifier hs-type">streamImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-109"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679867372"><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867373"><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679867384"><span class="annot"><a href="#local-6989586621679867384"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-110"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-111"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-112"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-114"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#ReconstructNestedCtxt"><span class="hs-identifier hs-type">ReconstructNestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-115"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-116"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867384"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamFrom"><span class="hs-identifier hs-type">StreamFrom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamTo"><span class="hs-identifier hs-type">StreamTo</span></a></span><span>   </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#MissingBlock"><span class="hs-identifier hs-type">MissingBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Iterator"><span class="hs-identifier hs-type">Iterator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867384"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span id="streamImpl"><span class="annot"><span class="annottext">streamImpl :: forall (m :: * -&gt; *) blk b.
(IOLike m, HasHeader blk, DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk,
 ReconstructNestedCtxt Header blk, HasCallStack) =&gt;
ImmutableDBEnv m blk
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; StreamFrom blk
-&gt; StreamTo blk
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#streamImpl"><span class="hs-identifier hs-var hs-var">streamImpl</span></a></span></span><span> </span><span id="local-6989586621679867870"><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679867870"><span class="hs-identifier hs-var">dbEnv</span></a></span></span><span> </span><span id="local-6989586621679867871"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679867871"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679867872"><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679867872"><span class="hs-identifier hs-var">blockComponent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679867873"><span class="annot"><span class="annottext">StreamFrom blk
</span><a href="#local-6989586621679867873"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679867874"><span class="annot"><span class="annottext">StreamTo blk
</span><a href="#local-6989586621679867874"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; (forall {h}.
    HasFS m h
    -&gt; OpenState m blk h
    -&gt; m (Either (MissingBlock blk) (Iterator m blk b)))
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
forall (m :: * -&gt; *) blk r.
(HasCallStack, IOLike m, StandardHash blk, Typeable blk) =&gt;
ImmutableDBEnv m blk
-&gt; (forall h. HasFS m h -&gt; OpenState m blk h -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#withOpenState"><span class="hs-identifier hs-var">withOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679867870"><span class="hs-identifier hs-var">dbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}.
  HasFS m h
  -&gt; OpenState m blk h
  -&gt; m (Either (MissingBlock blk) (Iterator m blk b)))
 -&gt; m (Either (MissingBlock blk) (Iterator m blk b)))
-&gt; (forall {h}.
    HasFS m h
    -&gt; OpenState m blk h
    -&gt; m (Either (MissingBlock blk) (Iterator m blk b)))
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679867923"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867923"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span class="hs-special">{</span><span id="local-6989586621679867924"><span id="local-6989586621679867925"><span id="local-6989586621679867926"><span id="local-6989586621679867927"><span id="local-6989586621679867928"><span id="local-6989586621679867929"><span id="local-6989586621679867930"><span id="local-6989586621679867931"><span class="annot"><span class="annottext">SecondaryOffset
WithOrigin (Tip blk)
Handle h
ChunkNo
BlockOffset
Index m blk h
currentChunk :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; ChunkNo
currentChunkOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; BlockOffset
currentChunk :: ChunkNo
currentChunkOffset :: BlockOffset
currentSecondaryOffset :: SecondaryOffset
currentChunkHandle :: Handle h
currentPrimaryHandle :: Handle h
currentSecondaryHandle :: Handle h
currentTip :: WithOrigin (Tip blk)
currentIndex :: Index m blk h
currentSecondaryOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; SecondaryOffset
currentChunkHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentPrimaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentSecondaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentTip :: forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; WithOrigin (Tip blk)
currentIndex :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Index m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunk"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT (MissingBlock blk) m (Iterator m blk b)
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT (MissingBlock blk) m (Iterator m blk b)
 -&gt; m (Either (MissingBlock blk) (Iterator m blk b)))
-&gt; ExceptT (MissingBlock blk) m (Iterator m blk b)
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT (MissingBlock blk) m ()
-&gt; ExceptT (MissingBlock blk) m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamFrom blk -&gt; StreamTo blk -&gt; Bool
forall blk.
StandardHash blk =&gt;
StreamFrom blk -&gt; StreamTo blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.Common.html#validBounds"><span class="hs-identifier hs-var">validBounds</span></a></span><span> </span><span class="annot"><span class="annottext">StreamFrom blk
</span><a href="#local-6989586621679867873"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">StreamTo blk
</span><a href="#local-6989586621679867874"><span class="hs-identifier hs-var">to</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT (MissingBlock blk) m ()
 -&gt; ExceptT (MissingBlock blk) m ())
-&gt; ExceptT (MissingBlock blk) m ()
-&gt; ExceptT (MissingBlock blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span class="annot"><span class="annottext">m () -&gt; ExceptT (MissingBlock blk) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (MissingBlock blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ExceptT (MissingBlock blk) m ())
-&gt; m () -&gt; ExceptT (MissingBlock blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ApiMisuse blk -&gt; m ()
forall (m :: * -&gt; *) blk a.
(MonadThrow m, HasCallStack, StandardHash blk, Typeable blk) =&gt;
ApiMisuse blk -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#throwApiMisuse"><span class="hs-identifier hs-var">throwApiMisuse</span></a></span><span> </span><span class="annot"><span class="annottext">(ApiMisuse blk -&gt; m ()) -&gt; ApiMisuse blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StreamFrom blk -&gt; StreamTo blk -&gt; ApiMisuse blk
forall blk. StreamFrom blk -&gt; StreamTo blk -&gt; ApiMisuse blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#InvalidIteratorRangeError"><span class="hs-identifier hs-var">InvalidIteratorRangeError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamFrom blk
</span><a href="#local-6989586621679867873"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">StreamTo blk
</span><a href="#local-6989586621679867874"><span class="hs-identifier hs-var">to</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>      </span><span id="local-6989586621679867941"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867941"><span class="hs-identifier hs-var">endChunkSlot</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; StreamTo blk
-&gt; ExceptT (MissingBlock blk) m ChunkSlot
forall h.
HasCallStack =&gt;
Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; StreamTo blk
-&gt; ExceptT (MissingBlock blk) m ChunkSlot
</span><a href="#local-6989586621679867942"><span class="hs-identifier hs-var">checkUpperBound</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679867931"><span class="hs-identifier hs-var">currentIndex</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679867930"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">StreamTo blk
</span><a href="#local-6989586621679867874"><span class="hs-identifier hs-var">to</span></a></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span>      </span><span class="hs-comment">--  When the lower bound is exclusive, we do the same as when it is</span><span>
</span><span id="line-131"></span><span>      </span><span class="hs-comment">--  inclusive. We set up the iterator to point at the lower bound. Only at</span><span>
</span><span id="line-132"></span><span>      </span><span class="hs-comment">--  the very end of this function do we advance it to the block after it,</span><span>
</span><span id="line-133"></span><span>      </span><span class="hs-comment">--  in the case of an exclusive lower bound.</span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679867943"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867943"><span class="hs-identifier hs-var">secondaryOffset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867944"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867944"><span class="hs-identifier hs-var">startChunkSlot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-135"></span><span>        </span><span class="annot"><span class="annottext">Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; StreamFrom blk
-&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot)
forall h.
HasCallStack =&gt;
Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; StreamFrom blk
-&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot)
</span><a href="#local-6989586621679867945"><span class="hs-identifier hs-var">checkLowerBound</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679867931"><span class="hs-identifier hs-var">currentIndex</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679867930"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">StreamFrom blk
</span><a href="#local-6989586621679867873"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span>      </span><span class="annot"><span class="annottext">m (Iterator m blk b)
-&gt; ExceptT (MissingBlock blk) m (Iterator m blk b)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (MissingBlock blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Iterator m blk b)
 -&gt; ExceptT (MissingBlock blk) m (Iterator m blk b))
-&gt; m (Iterator m blk b)
-&gt; ExceptT (MissingBlock blk) m (Iterator m blk b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-comment">-- 'validBounds' will catch nearly all invalid ranges, except for one:</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-comment">-- streaming from the regular block to the EBB in the same slot. The</span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-comment">-- EBB comes before the regular block, so these bounds are invalid.</span><span>
</span><span id="line-141"></span><span>        </span><span class="hs-comment">-- However, to distinguish the EBB from the regular block, as both</span><span>
</span><span id="line-142"></span><span>        </span><span class="hs-comment">-- have the same slot number, we need to look at the hashes.</span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-comment">-- 'validateBounds' doesn't have enough information to do that.</span><span>
</span><span id="line-144"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867944"><span class="hs-identifier hs-var">startChunkSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot -&gt; ChunkSlot -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867941"><span class="hs-identifier hs-var">endChunkSlot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-145"></span><span>          </span><span class="annot"><span class="annottext">ApiMisuse blk -&gt; m ()
forall (m :: * -&gt; *) blk a.
(MonadThrow m, HasCallStack, StandardHash blk, Typeable blk) =&gt;
ApiMisuse blk -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#throwApiMisuse"><span class="hs-identifier hs-var">throwApiMisuse</span></a></span><span> </span><span class="annot"><span class="annottext">(ApiMisuse blk -&gt; m ()) -&gt; ApiMisuse blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StreamFrom blk -&gt; StreamTo blk -&gt; ApiMisuse blk
forall blk. StreamFrom blk -&gt; StreamTo blk -&gt; ApiMisuse blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#InvalidIteratorRangeError"><span class="hs-identifier hs-var">InvalidIteratorRangeError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamFrom blk
</span><a href="#local-6989586621679867873"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">StreamTo blk
</span><a href="#local-6989586621679867874"><span class="hs-identifier hs-var">to</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span> </span><span id="local-6989586621679867948"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867948"><span class="hs-identifier hs-var">startChunk</span></a></span></span><span> </span><span id="local-6989586621679867949"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867949"><span class="hs-identifier hs-var">startRelSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867944"><span class="hs-identifier hs-var">startChunkSlot</span></a></span><span>
</span><span id="line-148"></span><span>            </span><span id="local-6989586621679867950"><span class="annot"><span class="annottext">startIsEBB :: IsEBB
</span><a href="#local-6989586621679867950"><span class="hs-identifier hs-var hs-var">startIsEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RelativeSlot -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#relativeSlotIsEBB"><span class="hs-identifier hs-var">relativeSlotIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867949"><span class="hs-identifier hs-var">startRelSlot</span></a></span><span>
</span><span id="line-149"></span><span>            </span><span id="local-6989586621679867952"><span class="annot"><span class="annottext">currentChunkInfo :: CurrentChunkInfo
</span><a href="#local-6989586621679867952"><span class="hs-identifier hs-var hs-var">currentChunkInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; BlockOffset -&gt; CurrentChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier hs-var">CurrentChunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867924"><span class="hs-identifier hs-var">currentChunk</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679867925"><span class="hs-identifier hs-var">currentChunkOffset</span></a></span><span>
</span><span id="line-150"></span><span>            </span><span id="local-6989586621679867953"><span class="annot"><span class="annottext">endHash :: HeaderHash blk
</span><a href="#local-6989586621679867953"><span class="hs-identifier hs-var hs-var">endHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamTo blk
</span><a href="#local-6989586621679867874"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-151"></span><span>              </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamToInclusive"><span class="hs-identifier hs-type">StreamToInclusive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span id="local-6989586621679867956"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679867956"><span class="hs-identifier hs-var">_slot</span></a></span></span><span> </span><span id="local-6989586621679867957"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679867957"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679867957"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>        </span><span id="local-6989586621679867958"><span class="annot"><span class="annottext">IteratorState m blk h
</span><a href="#local-6989586621679867958"><span class="hs-identifier hs-var">iteratorState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-154"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
-&gt; Index m blk h
-&gt; ResourceRegistry m
-&gt; CurrentChunkInfo
-&gt; HeaderHash blk
-&gt; ChunkNo
-&gt; SecondaryOffset
-&gt; IsEBB
-&gt; m (IteratorState m blk h)
forall blk (m :: * -&gt; *) h.
(HasCallStack, HasHeader blk, IOLike m) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ResourceRegistry m
-&gt; CurrentChunkInfo
-&gt; HeaderHash blk
-&gt; ChunkNo
-&gt; SecondaryOffset
-&gt; IsEBB
-&gt; m (IteratorState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorStateForChunk"><span class="hs-identifier hs-var">iteratorStateForChunk</span></a></span><span>
</span><span id="line-155"></span><span>            </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867923"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-156"></span><span>            </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679867931"><span class="hs-identifier hs-var">currentIndex</span></a></span><span>
</span><span id="line-157"></span><span>            </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679867871"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><span class="annottext">CurrentChunkInfo
</span><a href="#local-6989586621679867952"><span class="hs-identifier hs-var">currentChunkInfo</span></a></span><span>
</span><span id="line-159"></span><span>            </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679867953"><span class="hs-identifier hs-var">endHash</span></a></span><span>
</span><span id="line-160"></span><span>            </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867948"><span class="hs-identifier hs-var">startChunk</span></a></span><span>
</span><span id="line-161"></span><span>            </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867943"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span>
</span><span id="line-162"></span><span>            </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679867950"><span class="hs-identifier hs-var">startIsEBB</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621679867960"><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679867960"><span class="hs-identifier hs-var">varIteratorState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IteratorStateOrExhausted m blk h
-&gt; m (StrictTVar m (IteratorStateOrExhausted m blk h))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IteratorStateOrExhausted m blk h
 -&gt; m (StrictTVar m (IteratorStateOrExhausted m blk h)))
-&gt; IteratorStateOrExhausted m blk h
-&gt; m (StrictTVar m (IteratorStateOrExhausted m blk h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorState m blk h -&gt; IteratorStateOrExhausted m blk h
forall (m :: * -&gt; *) hash h.
IteratorState m hash h -&gt; IteratorStateOrExhausted m hash h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-var">IteratorStateOpen</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorState m blk h
</span><a href="#local-6989586621679867958"><span class="hs-identifier hs-var">iteratorState</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679867962"><span class="annot"><span class="annottext">ith :: IteratorHandle m blk h
</span><a href="#local-6989586621679867962"><span class="hs-identifier hs-var hs-var">ith</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-167"></span><span>                </span><span class="annot"><span class="annottext">ithHasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithHasFS"><span class="hs-identifier hs-var">ithHasFS</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867923"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-168"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ithIndex :: Index m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithIndex"><span class="hs-identifier hs-var">ithIndex</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679867931"><span class="hs-identifier hs-var">currentIndex</span></a></span><span>
</span><span id="line-169"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ithVarState :: StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithVarState"><span class="hs-identifier hs-var">ithVarState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679867960"><span class="hs-identifier hs-var">varIteratorState</span></a></span><span>
</span><span id="line-170"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ithEndChunk :: ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithEndChunk"><span class="hs-identifier hs-var">ithEndChunk</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkIndex"><span class="hs-identifier hs-var">chunkIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867941"><span class="hs-identifier hs-var">endChunkSlot</span></a></span><span>
</span><span id="line-171"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ithEndHash :: HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithEndHash"><span class="hs-identifier hs-var">ithEndHash</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679867953"><span class="hs-identifier hs-var">endHash</span></a></span><span>
</span><span id="line-172"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-comment">-- When streaming from an exclusive lower bound that is not genesis, we</span><span>
</span><span id="line-175"></span><span>        </span><span class="hs-comment">-- have opened the iterator at the bound itself, so we have to skip it</span><span>
</span><span id="line-176"></span><span>        </span><span class="hs-comment">-- first.</span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamFrom blk
</span><a href="#local-6989586621679867873"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-178"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamFromExclusive"><span class="hs-identifier hs-type">StreamFromExclusive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BlockPoint</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>            </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; CurrentChunkInfo -&gt; IteratorHandle m blk h -&gt; m ()
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ResourceRegistry m
-&gt; CurrentChunkInfo -&gt; IteratorHandle m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#stepIterator"><span class="hs-identifier hs-var">stepIterator</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679867871"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">CurrentChunkInfo
</span><a href="#local-6989586621679867952"><span class="hs-identifier hs-var">currentChunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679867962"><span class="hs-identifier hs-var">ith</span></a></span><span>
</span><span id="line-180"></span><span>          </span><span id="local-6989586621679867967"><span class="annot"><span class="annottext">StreamFrom blk
</span><a href="#local-6989586621679867967"><span class="hs-identifier hs-var">_otherwise</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">Iterator m blk b -&gt; m (Iterator m blk b)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Iterator m blk b -&gt; m (Iterator m blk b))
-&gt; Iterator m blk b -&gt; m (Iterator m blk b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h -&gt; Iterator m blk b
forall h. IteratorHandle m blk h -&gt; Iterator m blk b
</span><a href="#local-6989586621679867968"><span class="hs-identifier hs-var">mkIterator</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679867962"><span class="hs-identifier hs-var">ith</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679867971"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; ChunkInfo
</span><a href="#local-6989586621679867971"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679867870"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- | Check the upper bound: check whether it exists in the database (return</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- a 'MissingBlock' otherwise), and return the corresponding 'ChunkSlot'.</span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621679867456"><span class="annot"><a href="#local-6989586621679867942"><span class="hs-identifier hs-type">checkUpperBound</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-189"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867456"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-191"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Current tip</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamTo"><span class="hs-identifier hs-type">StreamTo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#MissingBlock"><span class="hs-identifier hs-type">MissingBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span></span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-comment">-- ^ We can't return 'TipInfo' here because the secondary index does</span><span>
</span><span id="line-195"></span><span>      </span><span class="hs-comment">-- not give us block numbers</span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621679867942"><span class="annot"><span class="annottext">checkUpperBound :: forall h.
HasCallStack =&gt;
Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; StreamTo blk
-&gt; ExceptT (MissingBlock blk) m ChunkSlot
</span><a href="#local-6989586621679867942"><span class="hs-identifier hs-var hs-var">checkUpperBound</span></a></span></span><span> </span><span id="local-6989586621679867980"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679867980"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679867981"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679867981"><span class="hs-identifier hs-var">currentTip</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamToInclusive"><span class="hs-identifier hs-type">StreamToInclusive</span></a></span><span> </span><span id="local-6989586621679867982"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679867982"><span class="hs-identifier hs-var">endPt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679867983"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867983"><span class="hs-identifier hs-var">chunkSlot</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Entry blk, BlockSize)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#getSlotInfo"><span class="hs-identifier hs-var">getSlotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867971"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679867980"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679867981"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679867982"><span class="hs-identifier hs-var">endPt</span></a></span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="annottext">ChunkSlot -&gt; ExceptT (MissingBlock blk) m ChunkSlot
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679867983"><span class="hs-identifier hs-var">chunkSlot</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-comment">-- | Check the lower bound: check whether it exists in the database (return</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-comment">-- a 'MissingBlock' otherwise), and return the corresponding 'ChunkSlot' and</span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-comment">-- 'SecondaryOffset'.</span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-comment">-- PRECONDITION: the end bound has been checked already</span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-comment">-- PRECONDITION: the bounds passed the 'validBounds' check</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- Both preconditions combined guarantee us that the tip is not origin and</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- that the lower bound is &lt;= the tip.</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679867457"><span class="annot"><a href="#local-6989586621679867945"><span class="hs-identifier hs-type">checkLowerBound</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-211"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-212"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867457"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-213"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Current tip</span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamFrom"><span class="hs-identifier hs-type">StreamFrom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#MissingBlock"><span class="hs-identifier hs-type">MissingBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-216"></span><span>    </span><span id="local-6989586621679867945"><span class="annot"><span class="annottext">checkLowerBound :: forall h.
HasCallStack =&gt;
Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; StreamFrom blk
-&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot)
</span><a href="#local-6989586621679867945"><span class="hs-identifier hs-var hs-var">checkLowerBound</span></a></span></span><span> </span><span id="local-6989586621679868001"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868001"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679868002"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679868002"><span class="hs-identifier hs-var">currentTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamFromInclusive"><span class="hs-identifier hs-type">StreamFromInclusive</span></a></span><span> </span><span id="local-6989586621679868004"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868004"><span class="hs-identifier hs-var">startPt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679868005"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868005"><span class="hs-identifier hs-var">chunkSlot</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Entry blk, BlockSize)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868006"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868006"><span class="hs-identifier hs-var">secondaryOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-219"></span><span>            </span><span class="annot"><span class="annottext">ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#getSlotInfo"><span class="hs-identifier hs-var">getSlotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867971"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868001"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679868002"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868004"><span class="hs-identifier hs-var">startPt</span></a></span><span>
</span><span id="line-220"></span><span>          </span><span class="annot"><span class="annottext">(SecondaryOffset, ChunkSlot)
-&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot)
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868006"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868005"><span class="hs-identifier hs-var">chunkSlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#StreamFromExclusive"><span class="hs-identifier hs-type">StreamFromExclusive</span></a></span><span> </span><span id="local-6989586621679868007"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679868007"><span class="hs-identifier hs-var">startPt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; WithOrigin (RealPoint blk)
forall blk. Point blk -&gt; WithOrigin (RealPoint blk)
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#pointToWithOriginRealPoint"><span class="hs-identifier hs-var">pointToWithOriginRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679868007"><span class="hs-identifier hs-var">startPt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-222"></span><span>          </span><span class="annot"><span class="annottext">WithOrigin (RealPoint blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (SecondaryOffset, ChunkSlot)
-&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (MissingBlock blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (SecondaryOffset, ChunkSlot)
 -&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot))
-&gt; m (SecondaryOffset, ChunkSlot)
-&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h -&gt; m (SecondaryOffset, ChunkSlot)
forall h.
HasCallStack =&gt;
Index m blk h -&gt; m (SecondaryOffset, ChunkSlot)
</span><a href="#local-6989586621679868010"><span class="hs-identifier hs-var">findFirstBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868001"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-223"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621679868012"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868012"><span class="hs-identifier hs-var">startPt'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679868013"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868013"><span class="hs-identifier hs-var">chunkSlot</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Entry blk, BlockSize)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868014"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868014"><span class="hs-identifier hs-var">secondaryOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-225"></span><span>              </span><span class="annot"><span class="annottext">ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#getSlotInfo"><span class="hs-identifier hs-var">getSlotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867971"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868001"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679868002"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868012"><span class="hs-identifier hs-var">startPt'</span></a></span><span>
</span><span id="line-226"></span><span>            </span><span class="annot"><span class="annottext">(SecondaryOffset, ChunkSlot)
-&gt; ExceptT (MissingBlock blk) m (SecondaryOffset, ChunkSlot)
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868014"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868013"><span class="hs-identifier hs-var">chunkSlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621679867477"><span class="annot"><a href="#local-6989586621679867968"><span class="hs-identifier hs-type">mkIterator</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867477"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Iterator"><span class="hs-identifier hs-type">Iterator</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867384"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621679867968"><span class="annot"><span class="annottext">mkIterator :: forall h. IteratorHandle m blk h -&gt; Iterator m blk b
</span><a href="#local-6989586621679867968"><span class="hs-identifier hs-var hs-var">mkIterator</span></a></span></span><span> </span><span id="local-6989586621679868015"><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679868015"><span class="hs-identifier hs-var">ith</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Iterator"><span class="hs-identifier hs-type">Iterator</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-230"></span><span>          </span><span class="annot"><span class="annottext">iteratorNext :: HasCallStack =&gt; m (IteratorResult b)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#iteratorNext"><span class="hs-identifier hs-var">iteratorNext</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; IteratorHandle m blk h
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; m (IteratorResult b)
forall (m :: * -&gt; *) blk b h.
(IOLike m, HasHeader blk, DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk,
 ReconstructNestedCtxt Header blk) =&gt;
ImmutableDBEnv m blk
-&gt; IteratorHandle m blk h
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; m (IteratorResult b)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorNextImpl"><span class="hs-identifier hs-var">iteratorNextImpl</span></a></span><span>    </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679867870"><span class="hs-identifier hs-var">dbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679868015"><span class="hs-identifier hs-var">ith</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679867871"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679867872"><span class="hs-identifier hs-var">blockComponent</span></a></span><span>
</span><span id="line-231"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">iteratorHasNext :: HasCallStack =&gt; STM m (Maybe (RealPoint blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#iteratorHasNext"><span class="hs-identifier hs-var">iteratorHasNext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; IteratorHandle m blk h -&gt; STM m (Maybe (RealPoint blk))
forall (m :: * -&gt; *) blk h.
IOLike m =&gt;
ImmutableDBEnv m blk
-&gt; IteratorHandle m blk h -&gt; STM m (Maybe (RealPoint blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorHasNextImpl"><span class="hs-identifier hs-var">iteratorHasNextImpl</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679867870"><span class="hs-identifier hs-var">dbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679868015"><span class="hs-identifier hs-var">ith</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">iteratorClose :: HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#iteratorClose"><span class="hs-identifier hs-var">iteratorClose</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h -&gt; m ()
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m) =&gt;
IteratorHandle m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorCloseImpl"><span class="hs-identifier hs-var">iteratorCloseImpl</span></a></span><span>         </span><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679868015"><span class="hs-identifier hs-var">ith</span></a></span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-comment">-- | Find the 'SecondaryOffset' and 'ChunkSlot' corresponding to the first</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-comment">-- block in the ImmutableDB.</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-comment">-- PRECONDITION: the ImmutableDB is not empty.</span><span>
</span><span id="line-239"></span><span>    </span><span id="local-6989586621679867489"><span class="annot"><a href="#local-6989586621679868010"><span class="hs-identifier hs-type">findFirstBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-240"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-241"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867373"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867489"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-243"></span><span>    </span><span id="local-6989586621679868010"><span class="annot"><span class="annottext">findFirstBlock :: forall h.
HasCallStack =&gt;
Index m blk h -&gt; m (SecondaryOffset, ChunkSlot)
</span><a href="#local-6989586621679868010"><span class="hs-identifier hs-var hs-var">findFirstBlock</span></a></span></span><span> </span><span id="local-6989586621679868042"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868042"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; m (SecondaryOffset, ChunkSlot)
</span><a href="#local-6989586621679868043"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><a href="#local-6989586621679868043"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867372"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>        </span><span id="local-6989586621679868043"><span class="annot"><span class="annottext">go :: ChunkNo -&gt; m (SecondaryOffset, ChunkSlot)
</span><a href="#local-6989586621679868043"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679868045"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868045"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
forall (m :: * -&gt; *) blk h.
Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readFirstFilledSlot"><span class="hs-identifier hs-var">Index.readFirstFilledSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868042"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868045"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe RelativeSlot)
-&gt; (Maybe RelativeSlot -&gt; m (SecondaryOffset, ChunkSlot))
-&gt; m (SecondaryOffset, ChunkSlot)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-247"></span><span>          </span><span class="annot"><span class="annottext">Maybe RelativeSlot
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; m (SecondaryOffset, ChunkSlot)
</span><a href="#local-6989586621679868043"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868045"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868048"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679868048"><span class="hs-identifier hs-var">relSlot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SecondaryOffset, ChunkSlot) -&gt; m (SecondaryOffset, ChunkSlot)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; RelativeSlot -&gt; ChunkSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkSlotForRelativeSlot"><span class="hs-identifier hs-var">chunkSlotForRelativeSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868045"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679868048"><span class="hs-identifier hs-var">relSlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">-- | Get information about the block or EBB at the given slot with the given</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- hash. If no such block exists, because the slot is empty, it contains a block</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- and/or EBB with a different hash, or it is newer than the current tip, return</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- a 'MissingBlock'.</span><span>
</span><span id="line-254"></span><span class="hs-comment">--</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- Return the 'ChunkSlot' corresponding to the block or EBB, the corresponding</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- entry (and 'BlockSize') from the secondary index file, and the</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- 'SecondaryOffset' of that entry.</span><span>
</span><span id="line-258"></span><span class="hs-comment">--</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- The primary index is read to find out whether the slot is filled and what</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- the 'SecondaryOffset' is for the slot. The secondary index is read to check</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- the hash and to return the 'Secondary.Entry'.</span><span>
</span><span id="line-262"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#getSlotInfo"><span class="hs-identifier hs-type">getSlotInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-263"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679867484"><span class="annot"><a href="#local-6989586621679867484"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867485"><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679867486"><span class="annot"><a href="#local-6989586621679867486"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867484"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867486"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Current tip</span></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#MissingBlock"><span class="hs-identifier hs-type">MissingBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867484"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-269"></span><span>             </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span>
</span><span id="line-270"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier hs-type">BlockSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span>
</span><span id="line-272"></span><span>             </span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span id="getSlotInfo"><span class="annot"><span class="annottext">getSlotInfo :: forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#getSlotInfo"><span class="hs-identifier hs-var hs-var">getSlotInfo</span></a></span></span><span> </span><span id="local-6989586621679868107"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679868107"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span id="local-6989586621679868108"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868108"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679868109"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679868109"><span class="hs-identifier hs-var">currentTip</span></a></span></span><span> </span><span id="local-6989586621679868110"><span class="annot"><span class="annottext">pt :: RealPoint blk
</span><a href="#local-6989586621679868110"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span id="local-6989586621679868111"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679868111"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621679868112"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679868112"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679868113"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868113"><span class="hs-identifier hs-var">chunk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868114"><span class="annot"><span class="annottext">Maybe ChunkSlot
</span><a href="#local-6989586621679868114"><span class="hs-identifier hs-var">mIfBoundary</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868115"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868115"><span class="hs-identifier hs-var">ifRegular</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>          </span><span class="annot"><span class="annottext">HasCallStack =&gt;
ChunkInfo -&gt; SlotNo -&gt; (ChunkNo, Maybe ChunkSlot, ChunkSlot)
ChunkInfo -&gt; SlotNo -&gt; (ChunkNo, Maybe ChunkSlot, ChunkSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkSlotForUnknownBlock"><span class="hs-identifier hs-var">chunkSlotForUnknownBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679868107"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679868111"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679868109"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868118"><span class="annot"><span class="annottext">SlotNo
tipSlotNo :: SlotNo
tipSlotNo :: forall blk. Tip blk -&gt; SlotNo
</span><a href="#local-6989586621679868118"><span class="hs-identifier hs-var hs-var">tipSlotNo</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679868111"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679868118"><span class="hs-identifier hs-var">tipSlotNo</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT (MissingBlock blk) m ()
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>      </span><span id="local-6989586621679868121"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679868121"><span class="hs-identifier hs-var">_otherwise</span></a></span></span><span>
</span><span id="line-282"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MissingBlock blk -&gt; ExceptT (MissingBlock blk) m ()
forall a. MissingBlock blk -&gt; ExceptT (MissingBlock blk) m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(MissingBlock blk -&gt; ExceptT (MissingBlock blk) m ())
-&gt; MissingBlock blk -&gt; ExceptT (MissingBlock blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; Point blk -&gt; MissingBlock blk
forall blk. RealPoint blk -&gt; Point blk -&gt; MissingBlock blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#NewerThanTip"><span class="hs-identifier hs-var">NewerThanTip</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868110"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithOrigin (Tip blk) -&gt; Point blk
forall blk. WithOrigin (Tip blk) -&gt; Point blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipToPoint"><span class="hs-identifier hs-var">tipToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679868109"><span class="hs-identifier hs-var">currentTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-comment">-- Obtain the offsets in the secondary index file from the primary index</span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-comment">-- file. The block /could/ still correspond to an EBB, a regular block or</span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-comment">-- both. We will know which one it is when we can check the hashes from</span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-comment">-- the secondary index file with the hash we have.</span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621679868124"><span class="annot"><span class="annottext">NonEmpty (IsEBB, SecondaryOffset)
</span><a href="#local-6989586621679868124"><span class="hs-identifier hs-var">toRead</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ChunkSlot
</span><a href="#local-6989586621679868114"><span class="hs-identifier hs-var">mIfBoundary</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-289"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868125"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868125"><span class="hs-identifier hs-var">ifBoundary</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>        </span><span id="local-6989586621679868126"><span class="annot"><span class="annottext">Two (Maybe SecondaryOffset)
</span><a href="#local-6989586621679868126"><span class="hs-identifier hs-var">offsets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Two (Maybe SecondaryOffset))
-&gt; ExceptT (MissingBlock blk) m (Two (Maybe SecondaryOffset))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (MissingBlock blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Two (Maybe SecondaryOffset))
 -&gt; ExceptT (MissingBlock blk) m (Two (Maybe SecondaryOffset)))
-&gt; m (Two (Maybe SecondaryOffset))
-&gt; ExceptT (MissingBlock blk) m (Two (Maybe SecondaryOffset))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffsets"><span class="hs-identifier hs-var">Index.readOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868108"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868113"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-291"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkSlot -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkRelative"><span class="hs-identifier hs-var">chunkRelative</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkSlot -&gt; RelativeSlot) -&gt; Two ChunkSlot -&gt; Two RelativeSlot
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot -&gt; ChunkSlot -&gt; Two ChunkSlot
forall a. a -&gt; a -&gt; Two a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#Two"><span class="hs-identifier hs-var">Two</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868125"><span class="hs-identifier hs-var">ifBoundary</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868115"><span class="hs-identifier hs-var">ifRegular</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Two (Maybe SecondaryOffset)
</span><a href="#local-6989586621679868126"><span class="hs-identifier hs-var">offsets</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-293"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#Two"><span class="hs-identifier hs-type">Two</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SecondaryOffset
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SecondaryOffset
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                   </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>            </span><span class="annot"><span class="annottext">MissingBlock blk
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a. MissingBlock blk -&gt; ExceptT (MissingBlock blk) m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(MissingBlock blk
 -&gt; ExceptT
      (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset)))
-&gt; MissingBlock blk
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; MissingBlock blk
forall blk. RealPoint blk -&gt; MissingBlock blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#EmptySlot"><span class="hs-identifier hs-var">EmptySlot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868110"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-295"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#Two"><span class="hs-identifier hs-type">Two</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868132"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868132"><span class="hs-identifier hs-var">ebbOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868133"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868133"><span class="hs-identifier hs-var">blkOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-296"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty (IsEBB, SecondaryOffset)
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-var">IsEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868132"><span class="hs-identifier hs-var">ebbOffset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IsEBB, SecondaryOffset)
-&gt; [(IsEBB, SecondaryOffset)] -&gt; NonEmpty (IsEBB, SecondaryOffset)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">NE.:|</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsNotEBB"><span class="hs-identifier hs-var">IsNotEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868133"><span class="hs-identifier hs-var">blkOffset</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#Two"><span class="hs-identifier hs-type">Two</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868137"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868137"><span class="hs-identifier hs-var">ebbOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe SecondaryOffset
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-298"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty (IsEBB, SecondaryOffset)
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-var">IsEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868137"><span class="hs-identifier hs-var">ebbOffset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IsEBB, SecondaryOffset)
-&gt; [(IsEBB, SecondaryOffset)] -&gt; NonEmpty (IsEBB, SecondaryOffset)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">NE.:|</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#Two"><span class="hs-identifier hs-type">Two</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SecondaryOffset
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868138"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868138"><span class="hs-identifier hs-var">blkOffset</span></a></span></span><span class="hs-special">)</span><span>          </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-300"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty (IsEBB, SecondaryOffset)
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsNotEBB"><span class="hs-identifier hs-var">IsNotEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868138"><span class="hs-identifier hs-var">blkOffset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IsEBB, SecondaryOffset)
-&gt; [(IsEBB, SecondaryOffset)] -&gt; NonEmpty (IsEBB, SecondaryOffset)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">NE.:|</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><span class="annottext">Maybe ChunkSlot
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>        </span><span id="local-6989586621679868139"><span class="annot"><span class="annottext">Maybe SecondaryOffset
</span><a href="#local-6989586621679868139"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Maybe SecondaryOffset)
-&gt; ExceptT (MissingBlock blk) m (Maybe SecondaryOffset)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (MissingBlock blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe SecondaryOffset)
 -&gt; ExceptT (MissingBlock blk) m (Maybe SecondaryOffset))
-&gt; m (Maybe SecondaryOffset)
-&gt; ExceptT (MissingBlock blk) m (Maybe SecondaryOffset)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
-&gt; ChunkNo -&gt; RelativeSlot -&gt; m (Maybe SecondaryOffset)
forall (m :: * -&gt; *) blk h.
Functor m =&gt;
Index m blk h
-&gt; ChunkNo -&gt; RelativeSlot -&gt; m (Maybe SecondaryOffset)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffset"><span class="hs-identifier hs-var">Index.readOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868108"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868113"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkSlot -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkRelative"><span class="hs-identifier hs-var">chunkRelative</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868115"><span class="hs-identifier hs-var">ifRegular</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SecondaryOffset
</span><a href="#local-6989586621679868139"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-304"></span><span>          </span><span class="annot"><span class="annottext">Maybe SecondaryOffset
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-305"></span><span>            </span><span class="annot"><span class="annottext">MissingBlock blk
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a. MissingBlock blk -&gt; ExceptT (MissingBlock blk) m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(MissingBlock blk
 -&gt; ExceptT
      (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset)))
-&gt; MissingBlock blk
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; MissingBlock blk
forall blk. RealPoint blk -&gt; MissingBlock blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#EmptySlot"><span class="hs-identifier hs-var">EmptySlot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868110"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-306"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868141"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868141"><span class="hs-identifier hs-var">blkOffset</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty (IsEBB, SecondaryOffset)
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (IsEBB, SecondaryOffset))
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsNotEBB"><span class="hs-identifier hs-var">IsNotEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868141"><span class="hs-identifier hs-var">blkOffset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IsEBB, SecondaryOffset)
-&gt; [(IsEBB, SecondaryOffset)] -&gt; NonEmpty (IsEBB, SecondaryOffset)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">NE.:|</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span>    </span><span id="local-6989586621679868142"><span class="annot"><span class="annottext">NonEmpty (Entry blk, BlockSize)
</span><a href="#local-6989586621679868142"><span class="hs-identifier hs-var">entriesWithBlockSizes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867485"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier hs-type">BlockSize</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-310"></span><span>      </span><span class="annot"><span class="annottext">m (NonEmpty (Entry blk, BlockSize))
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (Entry blk, BlockSize))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (MissingBlock blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (NonEmpty (Entry blk, BlockSize))
 -&gt; ExceptT (MissingBlock blk) m (NonEmpty (Entry blk, BlockSize)))
-&gt; m (NonEmpty (Entry blk, BlockSize))
-&gt; ExceptT (MissingBlock blk) m (NonEmpty (Entry blk, BlockSize))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo
   -&gt; t (IsEBB, SecondaryOffset) -&gt; m (t (Entry blk, BlockSize))
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo
   -&gt; t (IsEBB, SecondaryOffset) -&gt; m (t (Entry blk, BlockSize))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntries"><span class="hs-identifier hs-var">Index.readEntries</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868108"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868113"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (IsEBB, SecondaryOffset)
</span><a href="#local-6989586621679868124"><span class="hs-identifier hs-var">toRead</span></a></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">-- Return the entry from the secondary index file that matches the</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- expected hash.</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679868144"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868144"><span class="hs-identifier hs-var">secondaryOffset</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679868145"><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868145"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868146"><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679868146"><span class="hs-identifier hs-var">blockSize</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">((SecondaryOffset, (Entry blk, BlockSize)) -&gt; Bool)
-&gt; NonEmpty (SecondaryOffset, (Entry blk, BlockSize))
-&gt; Maybe (SecondaryOffset, (Entry blk, BlockSize))
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#find"><span class="hs-identifier hs-var">find</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk -&gt; HeaderHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679868112"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Bool)
-&gt; ((SecondaryOffset, (Entry blk, BlockSize)) -&gt; HeaderHash blk)
-&gt; (SecondaryOffset, (Entry blk, BlockSize))
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; HeaderHash blk
forall blk. Entry blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerHash"><span class="hs-identifier hs-var">Secondary.headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Entry blk -&gt; HeaderHash blk)
-&gt; ((SecondaryOffset, (Entry blk, BlockSize)) -&gt; Entry blk)
-&gt; (SecondaryOffset, (Entry blk, BlockSize))
-&gt; HeaderHash blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Entry blk, BlockSize) -&gt; Entry blk
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((Entry blk, BlockSize) -&gt; Entry blk)
-&gt; ((SecondaryOffset, (Entry blk, BlockSize))
    -&gt; (Entry blk, BlockSize))
-&gt; (SecondaryOffset, (Entry blk, BlockSize))
-&gt; Entry blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(SecondaryOffset, (Entry blk, BlockSize)) -&gt; (Entry blk, BlockSize)
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty SecondaryOffset
-&gt; NonEmpty (Entry blk, BlockSize)
-&gt; NonEmpty (SecondaryOffset, (Entry blk, BlockSize))
forall a b. NonEmpty a -&gt; NonEmpty b -&gt; NonEmpty (a, b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#zip"><span class="hs-identifier hs-var">NE.zip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((IsEBB, SecondaryOffset) -&gt; SecondaryOffset)
-&gt; NonEmpty (IsEBB, SecondaryOffset) -&gt; NonEmpty SecondaryOffset
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">(IsEBB, SecondaryOffset) -&gt; SecondaryOffset
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (IsEBB, SecondaryOffset)
</span><a href="#local-6989586621679868124"><span class="hs-identifier hs-var">toRead</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (Entry blk, BlockSize)
</span><a href="#local-6989586621679868142"><span class="hs-identifier hs-var">entriesWithBlockSizes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868152"><span class="annot"><span class="annottext">(SecondaryOffset, (Entry blk, BlockSize))
</span><a href="#local-6989586621679868152"><span class="hs-identifier hs-var">found</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SecondaryOffset, (Entry blk, BlockSize))
-&gt; ExceptT
     (MissingBlock blk) m (SecondaryOffset, (Entry blk, BlockSize))
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(SecondaryOffset, (Entry blk, BlockSize))
</span><a href="#local-6989586621679868152"><span class="hs-identifier hs-var">found</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="annottext">Maybe (SecondaryOffset, (Entry blk, BlockSize))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MissingBlock blk
-&gt; ExceptT
     (MissingBlock blk) m (SecondaryOffset, (Entry blk, BlockSize))
forall a. MissingBlock blk -&gt; ExceptT (MissingBlock blk) m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(MissingBlock blk
 -&gt; ExceptT
      (MissingBlock blk) m (SecondaryOffset, (Entry blk, BlockSize)))
-&gt; MissingBlock blk
-&gt; ExceptT
     (MissingBlock blk) m (SecondaryOffset, (Entry blk, BlockSize))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; NonEmpty (HeaderHash blk) -&gt; MissingBlock blk
forall blk.
RealPoint blk -&gt; NonEmpty (HeaderHash blk) -&gt; MissingBlock blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#WrongHash"><span class="hs-identifier hs-var">WrongHash</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868110"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621679868154"><span class="hs-identifier hs-var">hashes</span></a></span><span>
</span><span id="line-319"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-320"></span><span>            </span><span id="local-6989586621679868154"><span class="annot"><span class="annottext">hashes :: NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621679868154"><span class="hs-identifier hs-var hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; HeaderHash blk
forall blk. Entry blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerHash"><span class="hs-identifier hs-var">Secondary.headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Entry blk -&gt; HeaderHash blk)
-&gt; ((Entry blk, BlockSize) -&gt; Entry blk)
-&gt; (Entry blk, BlockSize)
-&gt; HeaderHash blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Entry blk, BlockSize) -&gt; Entry blk
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((Entry blk, BlockSize) -&gt; HeaderHash blk)
-&gt; NonEmpty (Entry blk, BlockSize) -&gt; NonEmpty (HeaderHash blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (Entry blk, BlockSize)
</span><a href="#local-6989586621679868142"><span class="hs-identifier hs-var">entriesWithBlockSizes</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">-- Use the secondary index entry to determine whether the slot + hash</span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- correspond to an EBB or a regular block.</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679868155"><span class="annot"><span class="annottext">chunkSlot :: ChunkSlot
</span><a href="#local-6989586621679868155"><span class="hs-identifier hs-var hs-var">chunkSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ChunkSlot
</span><a href="#local-6989586621679868114"><span class="hs-identifier hs-var">mIfBoundary</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; BlockOrEBB
forall blk. Entry blk -&gt; BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var">Secondary.blockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868145"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-325"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868157"><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868157"><span class="hs-identifier hs-var">ifBoundary</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#EBB"><span class="hs-identifier hs-type">EBB</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868157"><span class="hs-identifier hs-var">ifBoundary</span></a></span><span>
</span><span id="line-326"></span><span>                      </span><span id="local-6989586621679868159"><span class="annot"><span class="annottext">(Maybe ChunkSlot, BlockOrEBB)
</span><a href="#local-6989586621679868159"><span class="hs-identifier hs-var">_otherwise</span></a></span></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868115"><span class="hs-identifier hs-var">ifRegular</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">(ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
-&gt; ExceptT
     (MissingBlock blk)
     m
     (ChunkSlot, (Entry blk, BlockSize), SecondaryOffset)
forall a. a -&gt; ExceptT (MissingBlock blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkSlot
</span><a href="#local-6989586621679868155"><span class="hs-identifier hs-var">chunkSlot</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868145"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679868146"><span class="hs-identifier hs-var">blockSize</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868144"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- | Move the iterator to the next position that can be read from,</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- advancing chunks if necessary. If no next position can be found, the</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- iterator is closed.</span><span>
</span><span id="line-333"></span><span class="hs-comment">--</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- PRECONDITION: the given 'IteratorState' matches the one stored in the</span><span>
</span><span id="line-335"></span><span class="hs-comment">-- given 'StrictTVar'.</span><span>
</span><span id="line-336"></span><span class="hs-comment">--</span><span>
</span><span id="line-337"></span><span class="hs-comment">-- PRECONDITION: the iterator is not exhausted.</span><span>
</span><span id="line-338"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#stepIterator"><span class="hs-identifier hs-type">stepIterator</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-339"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679867473"><span class="annot"><a href="#local-6989586621679867473"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867474"><span class="annot"><a href="#local-6989586621679867474"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679867475"><span class="annot"><a href="#local-6989586621679867475"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867473"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679867474"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867473"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier hs-type">CurrentChunkInfo</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867474"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867475"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span id="stepIterator"><span class="annot"><span class="annottext">stepIterator :: forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ResourceRegistry m
-&gt; CurrentChunkInfo -&gt; IteratorHandle m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#stepIterator"><span class="hs-identifier hs-var hs-var">stepIterator</span></a></span></span><span> </span><span id="local-6989586621679868206"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679868206"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679868207"><span class="annot"><span class="annottext">CurrentChunkInfo
</span><a href="#local-6989586621679868207"><span class="hs-identifier hs-var">currentChunkInfo</span></a></span></span><span>
</span><span id="line-345"></span><span>             </span><span id="local-6989586621679868208"><span class="annot"><span class="annottext">ith :: IteratorHandle m blk h
</span><a href="#local-6989586621679868208"><span class="hs-identifier hs-var">ith</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868209"><span class="annot"><span class="annottext">HasFS m h
ithHasFS :: forall (m :: * -&gt; *) blk h. IteratorHandle m blk h -&gt; HasFS m h
ithHasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithHasFS"><span class="hs-identifier hs-var hs-var">ithHasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868210"><span class="annot"><span class="annottext">Index m blk h
ithIndex :: forall (m :: * -&gt; *) blk h. IteratorHandle m blk h -&gt; Index m blk h
ithIndex :: Index m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithIndex"><span class="hs-identifier hs-var hs-var">ithIndex</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868211"><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: forall (m :: * -&gt; *) blk h.
IteratorHandle m blk h
-&gt; StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithVarState"><span class="hs-identifier hs-var hs-var">ithVarState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868212"><span class="annot"><span class="annottext">ChunkNo
ithEndChunk :: forall (m :: * -&gt; *) blk h. IteratorHandle m blk h -&gt; ChunkNo
ithEndChunk :: ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithEndChunk"><span class="hs-identifier hs-var hs-var">ithEndChunk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868213"><span class="annot"><span class="annottext">HeaderHash blk
ithEndHash :: forall (m :: * -&gt; *) blk h.
IteratorHandle m blk h -&gt; HeaderHash blk
ithEndHash :: HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithEndHash"><span class="hs-identifier hs-var hs-var">ithEndHash</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><span class="annottext">STM m (IteratorStateOrExhausted m blk h)
-&gt; m (IteratorStateOrExhausted m blk h)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
-&gt; STM m (IteratorStateOrExhausted m blk h)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679868211"><span class="hs-identifier hs-var">ithVarState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (IteratorStateOrExhausted m blk h)
-&gt; (IteratorStateOrExhausted m blk h -&gt; m ()) -&gt; m ()
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-347"></span><span>      </span><span class="annot"><span class="annottext">IteratorStateOrExhausted m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateExhausted"><span class="hs-identifier hs-var">IteratorStateExhausted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; m ()
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;precondition violated: iterator must not be exhausted&quot;</span></span><span>
</span><span id="line-349"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-type">IteratorStateOpen</span></a></span><span> </span><span id="local-6989586621679868217"><span class="annot"><span class="annottext">its :: IteratorState m blk h
</span><a href="#local-6989586621679868217"><span class="hs-identifier hs-var">its</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868218"><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
itsChunkEntries :: forall (m :: * -&gt; *) blk h.
IteratorState m blk h -&gt; NonEmpty (WithBlockSize (Entry blk))
itsChunkEntries :: NonEmpty (WithBlockSize (Entry blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkEntries"><span class="hs-identifier hs-var hs-var">itsChunkEntries</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868219"><span class="annot"><span class="annottext">ResourceKey m
itsChunkKey :: forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; ResourceKey m
itsChunkKey :: ResourceKey m
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkKey"><span class="hs-identifier hs-var hs-var">itsChunkKey</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868220"><span class="annot"><span class="annottext">ChunkNo
itsChunk :: forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; ChunkNo
itsChunk :: ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunk"><span class="hs-identifier hs-var hs-var">itsChunk</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-350"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[WithBlockSize (Entry blk)]
-&gt; Maybe (NonEmpty (WithBlockSize (Entry blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk)) -&gt; [WithBlockSize (Entry blk)]
forall a. NonEmpty a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#tail"><span class="hs-identifier hs-var">NE.tail</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
</span><a href="#local-6989586621679868218"><span class="hs-identifier hs-var">itsChunkEntries</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-351"></span><span>          </span><span class="hs-comment">-- There are entries left in this chunk, so continue. See the</span><span>
</span><span id="line-352"></span><span>          </span><span class="hs-comment">-- invariant on 'itsChunkEntries'</span><span>
</span><span id="line-353"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868223"><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
</span><a href="#local-6989586621679868223"><span class="hs-identifier hs-var">itsChunkEntries'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>            </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
-&gt; IteratorStateOrExhausted m blk h -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679868211"><span class="hs-identifier hs-var">ithVarState</span></a></span><span> </span><span class="annot"><span class="annottext">(IteratorStateOrExhausted m blk h -&gt; STM m ())
-&gt; IteratorStateOrExhausted m blk h -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-355"></span><span>              </span><span class="annot"><span class="annottext">IteratorState m blk h -&gt; IteratorStateOrExhausted m blk h
forall (m :: * -&gt; *) hash h.
IteratorState m hash h -&gt; IteratorStateOrExhausted m hash h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-var">IteratorStateOpen</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorState m blk h
</span><a href="#local-6989586621679868217"><span class="hs-identifier hs-var">its</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkEntries"><span class="hs-identifier hs-var">itsChunkEntries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679868223"><span class="hs-identifier hs-type">itsChunkEntries'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>          </span><span class="hs-comment">-- No more entries in this chunk, so open the next.</span><span>
</span><span id="line-358"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (WithBlockSize (Entry blk)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-359"></span><span>            </span><span class="hs-comment">-- Release the resource, i.e., close the handle.</span><span>
</span><span id="line-360"></span><span>            </span><span class="annot"><span class="annottext">m (Maybe (Context m)) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (Context m)) -&gt; m ()) -&gt; m (Maybe (Context m)) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
forall (m :: * -&gt; *).
(IOLike m, HasCallStack) =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#release"><span class="hs-identifier hs-var">release</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679868219"><span class="hs-identifier hs-var">itsChunkKey</span></a></span><span>
</span><span id="line-361"></span><span>            </span><span class="hs-comment">-- If this was the final chunk, close the iterator</span><span>
</span><span id="line-362"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868220"><span class="hs-identifier hs-var">itsChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868212"><span class="hs-identifier hs-var">ithEndChunk</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-363"></span><span>              </span><span class="annot"><span class="annottext">IteratorHandle m blk h -&gt; m ()
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m) =&gt;
IteratorHandle m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorCloseImpl"><span class="hs-identifier hs-var">iteratorCloseImpl</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679868208"><span class="hs-identifier hs-var">ith</span></a></span><span>
</span><span id="line-364"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-365"></span><span>              </span><span class="annot"><span class="annottext">ChunkNo -&gt; m (IteratorState m blk h)
</span><a href="#local-6989586621679868225"><span class="hs-identifier hs-var">openNextChunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868220"><span class="hs-identifier hs-var">itsChunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (IteratorState m blk h)
-&gt; (IteratorState m blk h -&gt; m ()) -&gt; m ()
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679868226"><span class="annot"><span class="annottext">IteratorState m blk h
</span><a href="#local-6989586621679868226"><span class="hs-identifier hs-var">its'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
-&gt; IteratorStateOrExhausted m blk h -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679868211"><span class="hs-identifier hs-var">ithVarState</span></a></span><span> </span><span class="annot"><span class="annottext">(IteratorStateOrExhausted m blk h -&gt; STM m ())
-&gt; IteratorStateOrExhausted m blk h -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorState m blk h -&gt; IteratorStateOrExhausted m blk h
forall (m :: * -&gt; *) hash h.
IteratorState m hash h -&gt; IteratorStateOrExhausted m hash h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-var">IteratorStateOpen</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorState m blk h
</span><a href="#local-6989586621679868226"><span class="hs-identifier hs-var">its'</span></a></span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-368"></span><span>    </span><span class="annot"><a href="#local-6989586621679868225"><span class="hs-identifier hs-type">openNextChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-369"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>    </span><span class="hs-comment">-- ^ The chunk to open</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867474"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867475"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>    </span><span id="local-6989586621679868225"><span class="annot"><span class="annottext">openNextChunk :: ChunkNo -&gt; m (IteratorState m blk h)
</span><a href="#local-6989586621679868225"><span class="hs-identifier hs-var hs-var">openNextChunk</span></a></span></span><span> </span><span id="local-6989586621679868227"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868227"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><span class="annottext">Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
forall (m :: * -&gt; *) blk h.
Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readFirstFilledSlot"><span class="hs-identifier hs-var">Index.readFirstFilledSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868210"><span class="hs-identifier hs-var">ithIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868227"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe RelativeSlot)
-&gt; (Maybe RelativeSlot -&gt; m (IteratorState m blk h))
-&gt; m (IteratorState m blk h)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-373"></span><span>        </span><span class="hs-comment">-- This chunk is empty, look in the next one.</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-375"></span><span>        </span><span class="hs-comment">-- We still haven't encountered the end bound, so this loop must end</span><span>
</span><span id="line-376"></span><span>        </span><span class="hs-comment">-- when we reach the non-empty chunk containing the end bound. This</span><span>
</span><span id="line-377"></span><span>        </span><span class="hs-comment">-- cannot loop forever as an error would be thrown when opening the</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-comment">-- index file(s) of a non-existing chunk.</span><span>
</span><span id="line-379"></span><span>        </span><span class="annot"><span class="annottext">Maybe RelativeSlot
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; m (IteratorState m blk h)
</span><a href="#local-6989586621679868225"><span class="hs-identifier hs-var">openNextChunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868227"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868228"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679868228"><span class="hs-identifier hs-var">relSlot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-381"></span><span>          </span><span class="hs-comment">-- Note that the only reason we actually open the primary index file</span><span>
</span><span id="line-382"></span><span>          </span><span class="hs-comment">-- is to see whether the first block in the chunk is an EBB or not.</span><span>
</span><span id="line-383"></span><span>          </span><span class="hs-comment">-- To see whether the chunk is empty, we could open the secondary</span><span>
</span><span id="line-384"></span><span>          </span><span class="hs-comment">-- index file directly and see whether it contains any blocks. The</span><span>
</span><span id="line-385"></span><span>          </span><span class="hs-comment">-- 'secondaryOffset' will be 0, as the first entry in the secondary</span><span>
</span><span id="line-386"></span><span>          </span><span class="hs-comment">-- index file always starts at offset 0. The same is true for</span><span>
</span><span id="line-387"></span><span>          </span><span class="hs-comment">-- 'findFirstFilledSlot'.</span><span>
</span><span id="line-388"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679868229"><span class="annot"><span class="annottext">firstIsEBB :: IsEBB
</span><a href="#local-6989586621679868229"><span class="hs-identifier hs-var hs-var">firstIsEBB</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RelativeSlot -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#relativeSlotIsEBB"><span class="hs-identifier hs-var">relativeSlotIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679868228"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-389"></span><span>              </span><span id="local-6989586621679868231"><span class="annot"><span class="annottext">secondaryOffset :: SecondaryOffset
</span><a href="#local-6989586621679868231"><span class="hs-identifier hs-var hs-var">secondaryOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-number">0</span></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
-&gt; Index m blk h
-&gt; ResourceRegistry m
-&gt; CurrentChunkInfo
-&gt; HeaderHash blk
-&gt; ChunkNo
-&gt; SecondaryOffset
-&gt; IsEBB
-&gt; m (IteratorState m blk h)
forall blk (m :: * -&gt; *) h.
(HasCallStack, HasHeader blk, IOLike m) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ResourceRegistry m
-&gt; CurrentChunkInfo
-&gt; HeaderHash blk
-&gt; ChunkNo
-&gt; SecondaryOffset
-&gt; IsEBB
-&gt; m (IteratorState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorStateForChunk"><span class="hs-identifier hs-var">iteratorStateForChunk</span></a></span><span>
</span><span id="line-392"></span><span>            </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868209"><span class="hs-identifier hs-var">ithHasFS</span></a></span><span>
</span><span id="line-393"></span><span>            </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868210"><span class="hs-identifier hs-var">ithIndex</span></a></span><span>
</span><span id="line-394"></span><span>            </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679868206"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-395"></span><span>            </span><span class="annot"><span class="annottext">CurrentChunkInfo
</span><a href="#local-6989586621679868207"><span class="hs-identifier hs-var">currentChunkInfo</span></a></span><span>
</span><span id="line-396"></span><span>            </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679868213"><span class="hs-identifier hs-var">ithEndHash</span></a></span><span>
</span><span id="line-397"></span><span>            </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868227"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-398"></span><span>            </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868231"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span>
</span><span id="line-399"></span><span>            </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679868229"><span class="hs-identifier hs-var">firstIsEBB</span></a></span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorNextImpl"><span class="hs-identifier hs-type">iteratorNextImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-403"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679867493"><span class="annot"><a href="#local-6989586621679867493"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867494"><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679867496"><span class="annot"><a href="#local-6989586621679867496"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621679867495"><span class="annot"><a href="#local-6989586621679867495"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-404"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867493"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-405"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-406"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-408"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#ReconstructNestedCtxt"><span class="hs-identifier hs-type">ReconstructNestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-409"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867495"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867493"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867494"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867496"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867493"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#IteratorResult"><span class="hs-identifier hs-type">IteratorResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867496"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span id="iteratorNextImpl"><span class="annot"><span class="annottext">iteratorNextImpl :: forall (m :: * -&gt; *) blk b h.
(IOLike m, HasHeader blk, DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk,
 ReconstructNestedCtxt Header blk) =&gt;
ImmutableDBEnv m blk
-&gt; IteratorHandle m blk h
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; m (IteratorResult b)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorNextImpl"><span class="hs-identifier hs-var hs-var">iteratorNextImpl</span></a></span></span><span> </span><span id="local-6989586621679868254"><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679868254"><span class="hs-identifier hs-var">dbEnv</span></a></span></span><span> </span><span id="local-6989586621679868255"><span class="annot"><span class="annottext">ith :: IteratorHandle m blk h
</span><a href="#local-6989586621679868255"><span class="hs-identifier hs-var">ith</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868256"><span class="annot"><span class="annottext">HasFS m h
ithHasFS :: forall (m :: * -&gt; *) blk h. IteratorHandle m blk h -&gt; HasFS m h
ithHasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithHasFS"><span class="hs-identifier hs-var hs-var">ithHasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868257"><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: forall (m :: * -&gt; *) blk h.
IteratorHandle m blk h
-&gt; StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithVarState"><span class="hs-identifier hs-var hs-var">ithVarState</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679868258"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679868258"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679868259"><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679868259"><span class="hs-identifier hs-var">blockComponent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-comment">-- The idea is that if the state is not 'IteratorStateExhausted', then the</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-comment">-- head of 'itsChunkEntries' is always ready to be read. After extracting</span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-comment">-- the block component, 'stepIterator' will advance the iterator to the next</span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-comment">-- block.</span><span>
</span><span id="line-420"></span><span>    </span><span class="annot"><span class="annottext">STM m (IteratorStateOrExhausted m blk h)
-&gt; m (IteratorStateOrExhausted m blk h)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
-&gt; STM m (IteratorStateOrExhausted m blk h)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679868257"><span class="hs-identifier hs-var">ithVarState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (IteratorStateOrExhausted m blk h)
-&gt; (IteratorStateOrExhausted m blk h -&gt; m (IteratorResult b))
-&gt; m (IteratorResult b)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-comment">-- Iterator already closed</span><span>
</span><span id="line-422"></span><span>      </span><span class="annot"><span class="annottext">IteratorStateOrExhausted m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateExhausted"><span class="hs-identifier hs-var">IteratorStateExhausted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IteratorResult b -&gt; m (IteratorResult b)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorResult b
forall b. IteratorResult b
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#IteratorExhausted"><span class="hs-identifier hs-var">IteratorExhausted</span></a></span><span>
</span><span id="line-423"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-type">IteratorStateOpen</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868261"><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
itsChunkEntries :: forall (m :: * -&gt; *) blk h.
IteratorState m blk h -&gt; NonEmpty (WithBlockSize (Entry blk))
itsChunkEntries :: NonEmpty (WithBlockSize (Entry blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkEntries"><span class="hs-identifier hs-var hs-var">itsChunkEntries</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868262"><span class="annot"><span class="annottext">ChunkNo
itsChunk :: forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; ChunkNo
itsChunk :: ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunk"><span class="hs-identifier hs-var hs-var">itsChunk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868263"><span class="annot"><span class="annottext">Handle h
itsChunkHandle :: forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; Handle h
itsChunkHandle :: Handle h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkHandle"><span class="hs-identifier hs-var hs-var">itsChunkHandle</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-424"></span><span>        </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; (forall {h}.
    HasFS m h -&gt; OpenState m blk h -&gt; m (IteratorResult b))
-&gt; m (IteratorResult b)
forall (m :: * -&gt; *) blk r.
(HasCallStack, IOLike m, StandardHash blk, Typeable blk) =&gt;
ImmutableDBEnv m blk
-&gt; (forall h. HasFS m h -&gt; OpenState m blk h -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#withOpenState"><span class="hs-identifier hs-var">withOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679868254"><span class="hs-identifier hs-var">dbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}.
  HasFS m h -&gt; OpenState m blk h -&gt; m (IteratorResult b))
 -&gt; m (IteratorResult b))
-&gt; (forall {h}.
    HasFS m h -&gt; OpenState m blk h -&gt; m (IteratorResult b))
-&gt; m (IteratorResult b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">HasFS m h
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679868276"><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679868276"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679868277"><span class="annot"><span class="annottext">entry :: WithBlockSize (Entry blk)
</span><a href="#local-6989586621679868277"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk)) -&gt; WithBlockSize (Entry blk)
forall a. NonEmpty a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#head"><span class="hs-identifier hs-var">NE.head</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
</span><a href="#local-6989586621679868261"><span class="hs-identifier hs-var">itsChunkEntries</span></a></span><span>
</span><span id="line-426"></span><span>              </span><span id="local-6989586621679868279"><span class="annot"><span class="annottext">currentChunkInfo :: CurrentChunkInfo
</span><a href="#local-6989586621679868279"><span class="hs-identifier hs-var hs-var">currentChunkInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; BlockOffset -&gt; CurrentChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier hs-var">CurrentChunkInfo</span></a></span><span>
</span><span id="line-427"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpenState m blk h -&gt; ChunkNo
forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunk"><span class="hs-identifier hs-var">currentChunk</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679868276"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpenState m blk h -&gt; BlockOffset
forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; BlockOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunkOffset"><span class="hs-identifier hs-var">currentChunkOffset</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679868276"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>          </span><span id="local-6989586621679868280"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679868280"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-430"></span><span>            </span><span class="annot"><span class="annottext">HasFS m h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; CodecConfig blk
-&gt; (blk -&gt; Bool)
-&gt; Handle h
-&gt; WithBlockSize (Entry blk)
-&gt; BlockComponent blk b
-&gt; m b
forall (m :: * -&gt; *) blk b h.
(HasHeader blk, ReconstructNestedCtxt Header blk,
 DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk, IOLike m) =&gt;
HasFS m h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; CodecConfig blk
-&gt; (blk -&gt; Bool)
-&gt; Handle h
-&gt; WithBlockSize (Entry blk)
-&gt; BlockComponent blk b
-&gt; m b
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#extractBlockComponent"><span class="hs-identifier hs-var">extractBlockComponent</span></a></span><span>
</span><span id="line-431"></span><span>              </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868256"><span class="hs-identifier hs-var">ithHasFS</span></a></span><span>
</span><span id="line-432"></span><span>              </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679868281"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-433"></span><span>              </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868262"><span class="hs-identifier hs-var">itsChunk</span></a></span><span>
</span><span id="line-434"></span><span>              </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679868282"><span class="hs-identifier hs-var">codecConfig</span></a></span><span>
</span><span id="line-435"></span><span>              </span><span class="annot"><span class="annottext">blk -&gt; Bool
</span><a href="#local-6989586621679868283"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span>
</span><span id="line-436"></span><span>              </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868263"><span class="hs-identifier hs-var">itsChunkHandle</span></a></span><span>
</span><span id="line-437"></span><span>              </span><span class="annot"><span class="annottext">WithBlockSize (Entry blk)
</span><a href="#local-6989586621679868277"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-438"></span><span>              </span><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679868259"><span class="hs-identifier hs-var">blockComponent</span></a></span><span>
</span><span id="line-439"></span><span>          </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; CurrentChunkInfo -&gt; IteratorHandle m blk h -&gt; m ()
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ResourceRegistry m
-&gt; CurrentChunkInfo -&gt; IteratorHandle m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#stepIterator"><span class="hs-identifier hs-var">stepIterator</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679868258"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">CurrentChunkInfo
</span><a href="#local-6989586621679868279"><span class="hs-identifier hs-var">currentChunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorHandle m blk h
</span><a href="#local-6989586621679868255"><span class="hs-identifier hs-var">ith</span></a></span><span>
</span><span id="line-440"></span><span>          </span><span class="annot"><span class="annottext">IteratorResult b -&gt; m (IteratorResult b)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(IteratorResult b -&gt; m (IteratorResult b))
-&gt; IteratorResult b -&gt; m (IteratorResult b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; IteratorResult b
forall b. b -&gt; IteratorResult b
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#IteratorResult"><span class="hs-identifier hs-var">IteratorResult</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679868280"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-442"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868282"><span class="annot"><span class="annottext">CodecConfig blk
codecConfig :: CodecConfig blk
codecConfig :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; CodecConfig blk
</span><a href="#local-6989586621679868282"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868281"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; ChunkInfo
chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868283"><span class="annot"><span class="annottext">blk -&gt; Bool
checkIntegrity :: blk -&gt; Bool
checkIntegrity :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; blk -&gt; Bool
</span><a href="#local-6989586621679868283"><span class="hs-identifier hs-var hs-var">checkIntegrity</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679868254"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span id="local-6989586621679867497"><span id="local-6989586621679867498"><span id="local-6989586621679867499"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorHasNextImpl"><span class="hs-identifier hs-type">iteratorHasNextImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-445"></span><span>     </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867497"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867497"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867498"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867497"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867498"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867499"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679867497"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867498"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-449"></span><span id="iteratorHasNextImpl"><span class="annot"><span class="annottext">iteratorHasNextImpl :: forall (m :: * -&gt; *) blk h.
IOLike m =&gt;
ImmutableDBEnv m blk
-&gt; IteratorHandle m blk h -&gt; STM m (Maybe (RealPoint blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorHasNextImpl"><span class="hs-identifier hs-var hs-var">iteratorHasNextImpl</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868299"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; ChunkInfo
chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868300"><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: forall (m :: * -&gt; *) blk h.
IteratorHandle m blk h
-&gt; StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithVarState"><span class="hs-identifier hs-var hs-var">ithVarState</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-450"></span><span>    </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
-&gt; STM m (IteratorStateOrExhausted m blk h)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679868300"><span class="hs-identifier hs-var">ithVarState</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (IteratorStateOrExhausted m blk h)
-&gt; (IteratorStateOrExhausted m blk h -&gt; Maybe (RealPoint blk))
-&gt; STM m (Maybe (RealPoint blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%26%3E"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-451"></span><span>      </span><span class="annot"><span class="annottext">IteratorStateOrExhausted m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateExhausted"><span class="hs-identifier hs-var">IteratorStateExhausted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (RealPoint blk)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-452"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-type">IteratorStateOpen</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868301"><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
itsChunkEntries :: forall (m :: * -&gt; *) blk h.
IteratorState m blk h -&gt; NonEmpty (WithBlockSize (Entry blk))
itsChunkEntries :: NonEmpty (WithBlockSize (Entry blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkEntries"><span class="hs-identifier hs-var hs-var">itsChunkEntries</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-453"></span><span>          </span><span class="annot"><span class="annottext">RealPoint blk -&gt; Maybe (RealPoint blk)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
forall blk. SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-var">RealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679868302"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry blk -&gt; HeaderHash blk
forall blk. Entry blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerHash"><span class="hs-identifier hs-var">Secondary.headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868303"><span class="hs-identifier hs-var">nextEntry</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-455"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-type">WithBlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679868303"><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868303"><span class="hs-identifier hs-var">nextEntry</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-type">NE.:|</span></a></span><span> </span><span class="annot"><span class="annottext">[WithBlockSize (Entry blk)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
</span><a href="#local-6989586621679868301"><span class="hs-identifier hs-var">itsChunkEntries</span></a></span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span>          </span><span class="annot"><a href="#local-6989586621679868302"><span class="hs-identifier hs-type">slotNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-458"></span><span>          </span><span id="local-6989586621679868302"><span class="annot"><span class="annottext">slotNo :: SlotNo
</span><a href="#local-6989586621679868302"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; BlockOrEBB -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#slotNoOfBlockOrEBB"><span class="hs-identifier hs-var">slotNoOfBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679868299"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry blk -&gt; BlockOrEBB
forall blk. Entry blk -&gt; BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var">Secondary.blockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868303"><span class="hs-identifier hs-var">nextEntry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span id="local-6989586621679867500"><span id="local-6989586621679867501"><span id="local-6989586621679867502"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorCloseImpl"><span class="hs-identifier hs-type">iteratorCloseImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-461"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867500"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867501"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867502"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867500"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-464"></span><span id="iteratorCloseImpl"><span class="annot"><span class="annottext">iteratorCloseImpl :: forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m) =&gt;
IteratorHandle m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorCloseImpl"><span class="hs-identifier hs-var hs-var">iteratorCloseImpl</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorHandle"><span class="hs-identifier hs-type">IteratorHandle</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868329"><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: forall (m :: * -&gt; *) blk h.
IteratorHandle m blk h
-&gt; StrictTVar m (IteratorStateOrExhausted m blk h)
ithVarState :: StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#ithVarState"><span class="hs-identifier hs-var hs-var">ithVarState</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-465"></span><span>    </span><span class="annot"><span class="annottext">STM m (IteratorStateOrExhausted m blk h)
-&gt; m (IteratorStateOrExhausted m blk h)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
-&gt; STM m (IteratorStateOrExhausted m blk h)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679868329"><span class="hs-identifier hs-var">ithVarState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (IteratorStateOrExhausted m blk h)
-&gt; (IteratorStateOrExhausted m blk h -&gt; m ()) -&gt; m ()
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-466"></span><span>      </span><span class="hs-comment">-- Already closed</span><span>
</span><span id="line-467"></span><span>      </span><span class="annot"><span class="annottext">IteratorStateOrExhausted m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateExhausted"><span class="hs-identifier hs-var">IteratorStateExhausted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateOpen"><span class="hs-identifier hs-type">IteratorStateOpen</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868330"><span class="annot"><span class="annottext">ResourceKey m
itsChunkKey :: forall (m :: * -&gt; *) blk h. IteratorState m blk h -&gt; ResourceKey m
itsChunkKey :: ResourceKey m
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkKey"><span class="hs-identifier hs-var hs-var">itsChunkKey</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-comment">-- First set it to Nothing to indicate it is closed, as the call to</span><span>
</span><span id="line-470"></span><span>        </span><span class="hs-comment">-- 'release' might fail, which would leave the iterator open in an</span><span>
</span><span id="line-471"></span><span>        </span><span class="hs-comment">-- invalid state.</span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
-&gt; IteratorStateOrExhausted m blk h -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (IteratorStateOrExhausted m blk h)
</span><a href="#local-6989586621679868329"><span class="hs-identifier hs-var">ithVarState</span></a></span><span> </span><span class="annot"><span class="annottext">IteratorStateOrExhausted m blk h
forall (m :: * -&gt; *) hash h. IteratorStateOrExhausted m hash h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorStateExhausted"><span class="hs-identifier hs-var">IteratorStateExhausted</span></a></span><span>
</span><span id="line-473"></span><span>        </span><span class="hs-comment">-- TODO: we must use 'unsafeRelease' instead of 'release' because we</span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-comment">-- might close the iterator from an /untracked thread/, i.e., a thread</span><span>
</span><span id="line-475"></span><span>        </span><span class="hs-comment">-- that was not spawned by the resource registry (or the thread that</span><span>
</span><span id="line-476"></span><span>        </span><span class="hs-comment">-- opened the resource registry) in which the handle was allocated.</span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-comment">-- This happens in the consensus tests (but not in the actual node),</span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-comment">-- where the protocol threads that open iterators (BlockFetchServer</span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-comment">-- and ChainSyncServer) are spawned using a different resource</span><span>
</span><span id="line-481"></span><span>        </span><span class="hs-comment">-- registry (A) than the one the ImmutableDB (and ChainDB) use (B).</span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-comment">-- When the ChainDB is closed (by the thread that opened B), we're</span><span>
</span><span id="line-483"></span><span>        </span><span class="hs-comment">-- closing all open iterators, i.e., the iterators opened by the</span><span>
</span><span id="line-484"></span><span>        </span><span class="hs-comment">-- protocol threads. So we're releasing handles allocated in resource</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-comment">-- registry A from a thread tracked by resource registry B. See #1390.</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">m (Maybe (Context m)) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (Context m)) -&gt; m ()) -&gt; m (Maybe (Context m)) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m -&gt; m (Maybe (Context m))
forall (m :: * -&gt; *).
IOLike m =&gt;
ResourceKey m -&gt; m (Maybe (Context m))
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#unsafeRelease"><span class="hs-identifier hs-var">unsafeRelease</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679868330"><span class="hs-identifier hs-var">itsChunkKey</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span id="local-6989586621679867464"><span id="local-6989586621679867465"><span id="local-6989586621679867466"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorStateForChunk"><span class="hs-identifier hs-type">iteratorStateForChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-489"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679867464"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867465"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679867465"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867466"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867465"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867464"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867466"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867465"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-493"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier hs-type">CurrentChunkInfo</span></a></span><span>
</span><span id="line-494"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679867464"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-495"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Hash of the end bound</span></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span>
</span><span id="line-498"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Where to start in the secondary index</span></span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-500"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Whether the first expected block will be an EBB or not.</span></span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867465"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867465"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867464"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867466"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-502"></span><span id="iteratorStateForChunk"><span class="annot"><span class="annottext">iteratorStateForChunk :: forall blk (m :: * -&gt; *) h.
(HasCallStack, HasHeader blk, IOLike m) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ResourceRegistry m
-&gt; CurrentChunkInfo
-&gt; HeaderHash blk
-&gt; ChunkNo
-&gt; SecondaryOffset
-&gt; IsEBB
-&gt; m (IteratorState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#iteratorStateForChunk"><span class="hs-identifier hs-var hs-var">iteratorStateForChunk</span></a></span></span><span> </span><span id="local-6989586621679868360"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868360"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679868361"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868361"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679868362"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679868362"><span class="hs-identifier hs-var">registry</span></a></span></span><span>
</span><span id="line-503"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#CurrentChunkInfo"><span class="hs-identifier hs-type">CurrentChunkInfo</span></a></span><span> </span><span id="local-6989586621679868363"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868363"><span class="hs-identifier hs-var">curChunk</span></a></span></span><span> </span><span id="local-6989586621679868364"><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679868364"><span class="hs-identifier hs-var">curChunkOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679868365"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679868365"><span class="hs-identifier hs-var">endHash</span></a></span></span><span>
</span><span id="line-504"></span><span>                      </span><span id="local-6989586621679868366"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868366"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679868367"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868367"><span class="hs-identifier hs-var">secondaryOffset</span></a></span></span><span> </span><span id="local-6989586621679868368"><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679868368"><span class="hs-identifier hs-var">firstIsEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-comment">-- Open the chunk file. Allocate the handle in the registry so that it</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-comment">-- will be closed in case of an exception.</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679868369"><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679868369"><span class="hs-identifier hs-var">key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868370"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868370"><span class="hs-identifier hs-var">eHnd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (ResourceId -&gt; m (Handle h))
-&gt; (Handle h -&gt; m ())
-&gt; m (ResourceKey m, Handle h)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m a) -&gt; (a -&gt; m ()) -&gt; m (ResourceKey m, a)
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocate"><span class="hs-identifier hs-var">allocate</span></a></span><span>
</span><span id="line-508"></span><span>      </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679868362"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-509"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679868371"><span class="annot"><span class="annottext">ResourceId
</span><a href="#local-6989586621679868371"><span class="hs-identifier hs-var">_key</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
FsPath -&gt; OpenMode -&gt; m (Handle h)
</span><a href="#local-6989586621679868372"><span class="hs-identifier hs-var">hOpen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868366"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OpenMode
</span><span class="hs-identifier hs-var">ReadMode</span></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m ()
Handle h -&gt; m ()
</span><a href="#local-6989586621679868375"><span class="hs-identifier hs-var">hClose</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-comment">-- If the last entry in @entries@ corresponds to the last block in the</span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-comment">-- chunk, we cannot calculate the block size based on the next block.</span><span>
</span><span id="line-514"></span><span>    </span><span class="hs-comment">-- Instead, we calculate it based on the size of the chunk file.</span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-516"></span><span>    </span><span class="hs-comment">-- IMPORTANT: for older chunks, this is fine, as the secondary index</span><span>
</span><span id="line-517"></span><span>    </span><span class="hs-comment">-- (entries) and the chunk file (size) are immutable. However, when doing</span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-comment">-- this for the current chunk, there is a potential race condition between</span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-comment">-- reading of the entries from the secondary index and obtaining the chunk</span><span>
</span><span id="line-520"></span><span>    </span><span class="hs-comment">-- file size: what if a new block was appended after reading the entries</span><span>
</span><span id="line-521"></span><span>    </span><span class="hs-comment">-- but before obtaining the chunk file size? Then the chunk file size will</span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-comment">-- not correspond to the last entry we read, but to the block after it.</span><span>
</span><span id="line-523"></span><span>    </span><span class="hs-comment">-- Similarly if we switch the order of the two operations.</span><span>
</span><span id="line-524"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-comment">-- To avoid this race condition, we use the value of 'currentChunkOffset'</span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-comment">-- from the state as the file size of the current chunk (stored in</span><span>
</span><span id="line-527"></span><span>    </span><span class="hs-comment">-- 'CurrentChunkInfo'). This value corresponds to the chunk file size at</span><span>
</span><span id="line-528"></span><span>    </span><span class="hs-comment">-- the time we /read the state/. We also know that the end bound of our</span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-comment">-- iterator is always &lt;= the tip from that same state, so all @entries@</span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-comment">-- must be &lt;= the tip from that state because we'll never stream beyond</span><span>
</span><span id="line-531"></span><span>    </span><span class="hs-comment">-- the tip. Remember that we only actually use the current chunk file size</span><span>
</span><span id="line-532"></span><span>    </span><span class="hs-comment">-- if the last entry we have read from the secondary index is the last</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-comment">-- entry in the file, in which case it would correspond to the tip from</span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-comment">-- the state. In this case, the chunk file size (@curChunkOffset@) we are</span><span>
</span><span id="line-535"></span><span>    </span><span class="hs-comment">-- passed is consistent with the tip, as it was obtained from the same</span><span>
</span><span id="line-536"></span><span>    </span><span class="hs-comment">-- consistent state.</span><span>
</span><span id="line-537"></span><span>    </span><span id="local-6989586621679868376"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679868376"><span class="hs-identifier hs-var">chunkFileSize</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868366"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868363"><span class="hs-identifier hs-var">curChunk</span></a></span><span>
</span><span id="line-538"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; m Word64
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unBlockOffset"><span class="hs-identifier hs-var">unBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679868364"><span class="hs-identifier hs-var">curChunkOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m Word64
Handle h -&gt; m Word64
</span><a href="#local-6989586621679868378"><span class="hs-identifier hs-var">hGetSize</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868370"><span class="hs-identifier hs-var">eHnd</span></a></span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span>    </span><span id="local-6989586621679868379"><span class="annot"><span class="annottext">[WithBlockSize (Entry blk)]
</span><a href="#local-6989586621679868379"><span class="hs-identifier hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Index m blk h
-&gt; HasCallStack =&gt;
   SecondaryOffset
   -&gt; ChunkNo
   -&gt; (Entry blk -&gt; Bool)
   -&gt; Word64
   -&gt; IsEBB
   -&gt; m [WithBlockSize (Entry blk)]
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; HasCallStack =&gt;
   SecondaryOffset
   -&gt; ChunkNo
   -&gt; (Entry blk -&gt; Bool)
   -&gt; Word64
   -&gt; IsEBB
   -&gt; m [WithBlockSize (Entry blk)]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readAllEntries"><span class="hs-identifier hs-var">Index.readAllEntries</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679868361"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868367"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868366"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-542"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk -&gt; HeaderHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679868365"><span class="hs-identifier hs-var">endHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Bool)
-&gt; (Entry blk -&gt; HeaderHash blk) -&gt; Entry blk -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; HeaderHash blk
forall blk. Entry blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerHash"><span class="hs-identifier hs-var">Secondary.headerHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679868376"><span class="hs-identifier hs-var">chunkFileSize</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679868368"><span class="hs-identifier hs-var">firstIsEBB</span></a></span><span>
</span><span id="line-543"></span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[WithBlockSize (Entry blk)]
-&gt; Maybe (NonEmpty (WithBlockSize (Entry blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[WithBlockSize (Entry blk)]
</span><a href="#local-6989586621679868379"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-545"></span><span>      </span><span class="hs-comment">-- We still haven't encountered the end bound, so it cannot be</span><span>
</span><span id="line-546"></span><span>      </span><span class="hs-comment">-- that this non-empty chunk contains no entries &lt;= the end bound.</span><span>
</span><span id="line-547"></span><span>      </span><span class="annot"><span class="annottext">Maybe (NonEmpty (WithBlockSize (Entry blk)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m (IteratorState m blk h)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span>
</span><span id="line-548"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;impossible: there must be entries according to the primary index&quot;</span></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679868381"><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
</span><a href="#local-6989586621679868381"><span class="hs-identifier hs-var">itsChunkEntries</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IteratorState m blk h -&gt; m (IteratorState m blk h)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#IteratorState"><span class="hs-identifier hs-type">IteratorState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-551"></span><span>          </span><span class="annot"><span class="annottext">itsChunk :: ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunk"><span class="hs-identifier hs-var">itsChunk</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868366"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-552"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">itsChunkHandle :: Handle h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkHandle"><span class="hs-identifier hs-var">itsChunkHandle</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868370"><span class="hs-identifier hs-var">eHnd</span></a></span><span>
</span><span id="line-553"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">itsChunkKey :: ResourceKey m
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkKey"><span class="hs-identifier hs-var">itsChunkKey</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceKey m
</span><a href="#local-6989586621679868369"><span class="hs-identifier hs-var">key</span></a></span><span>
</span><span id="line-554"></span><span>          </span><span class="hs-comment">-- Force so we don't store any thunks in the state</span><span>
</span><span id="line-555"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">itsChunkEntries :: NonEmpty (WithBlockSize (Entry blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#itsChunkEntries"><span class="hs-identifier hs-var">itsChunkEntries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
-&gt; NonEmpty (WithBlockSize (Entry blk))
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; t a
</span><span class="hs-identifier hs-var">forceElemsToWHNF</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (WithBlockSize (Entry blk))
</span><a href="#local-6989586621679868381"><span class="hs-identifier hs-var">itsChunkEntries</span></a></span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-558"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679868372"><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
hOpen :: HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
hOpen :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
</span><a href="#local-6989586621679868372"><span class="hs-identifier hs-var hs-var">hOpen</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868375"><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m ()
hClose :: HasCallStack =&gt; Handle h -&gt; m ()
hClose :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
</span><a href="#local-6989586621679868375"><span class="hs-identifier hs-var hs-var">hClose</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868378"><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; m Word64
hGetSize :: HasCallStack =&gt; Handle h -&gt; m Word64
hGetSize :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
</span><a href="#local-6989586621679868378"><span class="hs-identifier hs-var hs-var">hGetSize</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868360"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-559"></span><span>
</span><span id="line-560"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#extractBlockComponent"><span class="hs-identifier hs-type">extractBlockComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-561"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679867587"><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679867586"><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679867589"><span class="annot"><a href="#local-6989586621679867589"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621679867588"><span class="annot"><a href="#local-6989586621679867588"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-562"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-563"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#ReconstructNestedCtxt"><span class="hs-identifier hs-type">ReconstructNestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-564"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-565"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-566"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-567"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867588"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-569"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-570"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#CodecConfig"><span class="hs-identifier hs-type">CodecConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-572"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="annot"><a href="#local-6989586621679867588"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-type">WithBlockSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867589"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-576"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867589"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-577"></span><span id="extractBlockComponent"><span class="annot"><span class="annottext">extractBlockComponent :: forall (m :: * -&gt; *) blk b h.
(HasHeader blk, ReconstructNestedCtxt Header blk,
 DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk, IOLike m) =&gt;
HasFS m h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; CodecConfig blk
-&gt; (blk -&gt; Bool)
-&gt; Handle h
-&gt; WithBlockSize (Entry blk)
-&gt; BlockComponent blk b
-&gt; m b
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#extractBlockComponent"><span class="hs-identifier hs-var hs-var">extractBlockComponent</span></a></span></span><span> </span><span id="local-6989586621679868434"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868434"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679868435"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679868435"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span id="local-6989586621679868436"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868436"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679868437"><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679868437"><span class="hs-identifier hs-var">ccfg</span></a></span></span><span> </span><span id="local-6989586621679868438"><span class="annot"><span class="annottext">blk -&gt; Bool
</span><a href="#local-6989586621679868438"><span class="hs-identifier hs-var">checkIntegrity</span></a></span></span><span> </span><span id="local-6989586621679868439"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868439"><span class="hs-identifier hs-var">eHnd</span></a></span></span><span>
</span><span id="line-578"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-type">WithBlockSize</span></a></span><span> </span><span id="local-6989586621679868440"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868440"><span class="hs-identifier hs-var">blockSize</span></a></span></span><span> </span><span id="local-6989586621679868441"><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868441"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockComponent blk b -&gt; m b
forall b'. BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679868442"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-580"></span><span>    </span><span class="annot"><a href="#local-6989586621679868442"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679867635"><span class="annot"><a href="#local-6989586621679867635"><span class="hs-identifier hs-type">b'</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867635"><span class="hs-identifier hs-type">b'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867635"><span class="hs-identifier hs-type">b'</span></a></span><span>
</span><span id="line-581"></span><span>    </span><span id="local-6989586621679868442"><span class="annot"><span class="annottext">go :: forall b'. BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679868442"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHash"><span class="hs-identifier hs-var">GetHash</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
HeaderHash blk
</span><a href="#local-6989586621679868448"><span class="hs-identifier hs-var">headerHash</span></a></span><span>
</span><span id="line-583"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetSlot"><span class="hs-identifier hs-var">GetSlot</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
SlotNo
</span><a href="#local-6989586621679868452"><span class="hs-identifier hs-var">slotNo</span></a></span><span>
</span><span id="line-584"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetIsEBB"><span class="hs-identifier hs-var">GetIsEBB</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IsEBB -&gt; m IsEBB
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(IsEBB -&gt; m IsEBB) -&gt; IsEBB -&gt; m IsEBB
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOrEBB -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#isBlockOrEBB"><span class="hs-identifier hs-var">isBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOrEBB
</span><a href="#local-6989586621679868457"><span class="hs-identifier hs-var">blockOrEBB</span></a></span><span>
</span><span id="line-585"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlockSize"><span class="hs-identifier hs-var">GetBlockSize</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; m SizeInBytes
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(SizeInBytes -&gt; m SizeInBytes) -&gt; SizeInBytes -&gt; m SizeInBytes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset -&gt; SizeInBytes
</span><span class="hs-identifier hs-var">SizeInBytes</span></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868440"><span class="hs-identifier hs-var">blockSize</span></a></span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeaderSize"><span class="hs-identifier hs-var">GetHeaderSize</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(b' -&gt; m b') -&gt; b' -&gt; m b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; b'
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word16 -&gt; b') -&gt; Word16 -&gt; b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderSize -&gt; Word16
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unHeaderSize"><span class="hs-identifier hs-var">Secondary.unHeaderSize</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderSize
</span><a href="#local-6989586621679868470"><span class="hs-identifier hs-var">headerSize</span></a></span><span>
</span><span id="line-587"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawBlock"><span class="hs-identifier hs-var">GetRawBlock</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b'
m ByteString
</span><a href="#local-6989586621679868473"><span class="hs-identifier hs-var">readBlock</span></a></span><span>
</span><span id="line-588"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawHeader"><span class="hs-identifier hs-var">GetRawHeader</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b'
m ByteString
</span><a href="#local-6989586621679868476"><span class="hs-identifier hs-var">readHeader</span></a></span><span>
</span><span id="line-589"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetNestedCtxt"><span class="hs-identifier hs-var">GetNestedCtxt</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m b'
m (SomeSecond (NestedCtxt Header) blk)
</span><a href="#local-6989586621679868479"><span class="hs-identifier hs-var">readNestedCtxt</span></a></span><span>
</span><span id="line-590"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlock"><span class="hs-identifier hs-var">GetBlock</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679868483"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868483"><span class="hs-identifier hs-var">rawBlk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockComponent blk ByteString -&gt; m ByteString
forall b'. BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679868442"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk ByteString
forall blk. BlockComponent blk ByteString
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawBlock"><span class="hs-identifier hs-var">GetRawBlock</span></a></span><span>
</span><span id="line-591"></span><span>                               </span><span class="annot"><span class="annottext">ByteString -&gt; m blk
</span><a href="#local-6989586621679868484"><span class="hs-identifier hs-var">parseBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868483"><span class="hs-identifier hs-var">rawBlk</span></a></span><span>
</span><span id="line-592"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeader"><span class="hs-identifier hs-var">GetHeader</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679868489"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868489"><span class="hs-identifier hs-var">rawHdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockComponent blk ByteString -&gt; m ByteString
forall b'. BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679868442"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk ByteString
forall blk. BlockComponent blk ByteString
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawHeader"><span class="hs-identifier hs-var">GetRawHeader</span></a></span><span>
</span><span id="line-593"></span><span>                               </span><span id="local-6989586621679868490"><span class="annot"><span class="annottext">SomeSecond (NestedCtxt Header) blk
</span><a href="#local-6989586621679868490"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (SomeSecond (NestedCtxt Header) blk)
</span><a href="#local-6989586621679868479"><span class="hs-identifier hs-var">readNestedCtxt</span></a></span><span>
</span><span id="line-594"></span><span>                               </span><span class="annot"><span class="annottext">SomeSecond (NestedCtxt Header) blk -&gt; ByteString -&gt; m (Header blk)
</span><a href="#local-6989586621679868491"><span class="hs-identifier hs-var">parseHeader</span></a></span><span> </span><span class="annot"><span class="annottext">SomeSecond (NestedCtxt Header) blk
</span><a href="#local-6989586621679868490"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868489"><span class="hs-identifier hs-var">rawHdr</span></a></span><span>
</span><span id="line-595"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetVerifiedBlock"><span class="hs-identifier hs-var">GetVerifiedBlock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679868501"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679868501"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockComponent blk blk -&gt; m blk
forall b'. BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679868442"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk blk
forall blk. BlockComponent blk blk
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlock"><span class="hs-identifier hs-var">GetBlock</span></a></span><span>
</span><span id="line-596"></span><span>                               </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; Bool
</span><a href="#local-6989586621679868438"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679868501"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-597"></span><span>                                 </span><span class="annot"><span class="annottext">UnexpectedFailure blk -&gt; m ()
forall blk (m :: * -&gt; *) a.
(StandardHash blk, Typeable blk, MonadThrow m) =&gt;
UnexpectedFailure blk -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#throwUnexpectedFailure"><span class="hs-identifier hs-var">throwUnexpectedFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(UnexpectedFailure blk -&gt; m ()) -&gt; UnexpectedFailure blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; UnexpectedFailure blk
forall blk. RealPoint blk -&gt; UnexpectedFailure blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#CorruptBlockError"><span class="hs-identifier hs-var">CorruptBlockError</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868504"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-598"></span><span>                               </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">blk
b'
</span><a href="#local-6989586621679868501"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-599"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#GetPure"><span class="hs-identifier hs-type">GetPure</span></a></span><span> </span><span id="local-6989586621679868506"><span class="annot"><span class="annottext">b'
</span><a href="#local-6989586621679868506"><span class="hs-identifier hs-var">a</span></a></span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
</span><a href="#local-6989586621679868506"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-600"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#GetApply"><span class="hs-identifier hs-type">GetApply</span></a></span><span> </span><span id="local-6989586621679868509"><span class="annot"><span class="annottext">BlockComponent blk (a1 -&gt; b')
</span><a href="#local-6989586621679868509"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679868510"><span class="annot"><span class="annottext">BlockComponent blk a1
</span><a href="#local-6989586621679868510"><span class="hs-identifier hs-var">bc</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockComponent blk (a1 -&gt; b') -&gt; m (a1 -&gt; b')
forall b'. BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679868442"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk (a1 -&gt; b')
</span><a href="#local-6989586621679868509"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">m (a1 -&gt; b') -&gt; m a1 -&gt; m b'
forall a b. m (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk a1 -&gt; m a1
forall b'. BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679868442"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk a1
</span><a href="#local-6989586621679868510"><span class="hs-identifier hs-var">bc</span></a></span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-603"></span><span>          </span><span id="local-6989586621679868511"><span class="annot"><span class="annottext">BlockOffset
blockOffset :: BlockOffset
blockOffset :: forall blk. Entry blk -&gt; BlockOffset
</span><a href="#local-6989586621679868511"><span class="hs-identifier hs-var hs-var">blockOffset</span></a></span></span><span>
</span><span id="line-604"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868513"><span class="annot"><span class="annottext">CRC
checksum :: CRC
checksum :: forall blk. Entry blk -&gt; CRC
</span><a href="#local-6989586621679868513"><span class="hs-identifier hs-var hs-var">checksum</span></a></span></span><span>
</span><span id="line-605"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868448"><span class="annot"><span class="annottext">HeaderHash blk
headerHash :: forall blk. Entry blk -&gt; HeaderHash blk
headerHash :: HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerHash"><span class="hs-identifier hs-var hs-var">headerHash</span></a></span></span><span>
</span><span id="line-606"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868470"><span class="annot"><span class="annottext">HeaderSize
headerSize :: HeaderSize
headerSize :: forall blk. Entry blk -&gt; HeaderSize
</span><a href="#local-6989586621679868470"><span class="hs-identifier hs-var hs-var">headerSize</span></a></span></span><span>
</span><span id="line-607"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868516"><span class="annot"><span class="annottext">HeaderOffset
headerOffset :: HeaderOffset
headerOffset :: forall blk. Entry blk -&gt; HeaderOffset
</span><a href="#local-6989586621679868516"><span class="hs-identifier hs-var hs-var">headerOffset</span></a></span></span><span>
</span><span id="line-608"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868457"><span class="annot"><span class="annottext">BlockOrEBB
blockOrEBB :: forall blk. Entry blk -&gt; BlockOrEBB
blockOrEBB :: BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var hs-var">blockOrEBB</span></a></span></span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679868441"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span>    </span><span class="annot"><a href="#local-6989586621679868452"><span class="hs-identifier hs-type">slotNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-612"></span><span>    </span><span id="local-6989586621679868452"><span class="annot"><span class="annottext">slotNo :: SlotNo
</span><a href="#local-6989586621679868452"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; BlockOrEBB -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#slotNoOfBlockOrEBB"><span class="hs-identifier hs-var">slotNoOfBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679868435"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOrEBB
</span><a href="#local-6989586621679868457"><span class="hs-identifier hs-var">blockOrEBB</span></a></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>    </span><span class="annot"><a href="#local-6989586621679868504"><span class="hs-identifier hs-type">pt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-615"></span><span>    </span><span id="local-6989586621679868504"><span class="annot"><span class="annottext">pt :: RealPoint blk
</span><a href="#local-6989586621679868504"><span class="hs-identifier hs-var hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
forall blk. SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-var">RealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679868452"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679868448"><span class="hs-identifier hs-var">headerHash</span></a></span><span>
</span><span id="line-616"></span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-comment">-- | We don't rely on the position of the handle, we always use</span><span>
</span><span id="line-618"></span><span>    </span><span class="hs-comment">-- 'hGetExactlyAtCRC', i.e. @pread@ for reading from a given offset.</span><span>
</span><span id="line-619"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-comment">-- In case the requested chunk is the current chunk, we will be reading</span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-comment">-- from the chunk file while we're also writing to it. Are we guaranteed</span><span>
</span><span id="line-622"></span><span>    </span><span class="hs-comment">-- to read what have written? Duncan says: this is guaranteed at the OS</span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-comment">-- level (POSIX), but not for Haskell handles, which might perform other</span><span>
</span><span id="line-624"></span><span>    </span><span class="hs-comment">-- buffering. However, the 'HasFS' implementation we're using uses POSIX</span><span>
</span><span id="line-625"></span><span>    </span><span class="hs-comment">-- file handles (&quot;Ouroboros.Consensus.Storage.IO&quot;) so we're safe (other</span><span>
</span><span id="line-626"></span><span>    </span><span class="hs-comment">-- implementations of the 'HasFS' API guarantee this too).</span><span>
</span><span id="line-627"></span><span>    </span><span class="annot"><a href="#local-6989586621679868473"><span class="hs-identifier hs-type">readBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span>
</span><span id="line-628"></span><span>    </span><span id="local-6989586621679868473"><span class="annot"><span class="annottext">readBlock :: m ByteString
</span><a href="#local-6989586621679868473"><span class="hs-identifier hs-var hs-var">readBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-629"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679868518"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868518"><span class="hs-identifier hs-var">bl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868519"><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679868519"><span class="hs-identifier hs-var">checksum'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m (ByteString, CRC)
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m (ByteString, CRC)
</span><span class="hs-identifier hs-var">hGetExactlyAtCRC</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868434"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868439"><span class="hs-identifier hs-var">eHnd</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679868521"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679868522"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-630"></span><span>        </span><span class="annot"><span class="annottext">FsPath -&gt; RealPoint blk -&gt; CRC -&gt; CRC -&gt; m ()
forall blk (m :: * -&gt; *).
(HasCallStack, HasHeader blk, MonadThrow m) =&gt;
FsPath -&gt; RealPoint blk -&gt; CRC -&gt; CRC -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#checkChecksum"><span class="hs-identifier hs-var">checkChecksum</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679868524"><span class="hs-identifier hs-var">chunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868504"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679868513"><span class="hs-identifier hs-var">checksum</span></a></span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679868519"><span class="hs-identifier hs-var">checksum'</span></a></span><span>
</span><span id="line-631"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868518"><span class="hs-identifier hs-var">bl</span></a></span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-633"></span><span>        </span><span id="local-6989586621679868521"><span class="annot"><span class="annottext">size :: Word64
</span><a href="#local-6989586621679868521"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868440"><span class="hs-identifier hs-var">blockSize</span></a></span><span>
</span><span id="line-634"></span><span>        </span><span id="local-6989586621679868522"><span class="annot"><span class="annottext">offset :: AbsOffset
</span><a href="#local-6989586621679868522"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; AbsOffset
</span><span class="hs-identifier hs-var">AbsOffset</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; AbsOffset) -&gt; Word64 -&gt; AbsOffset
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unBlockOffset"><span class="hs-identifier hs-var">Secondary.unBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679868511"><span class="hs-identifier hs-var">blockOffset</span></a></span><span>
</span><span id="line-635"></span><span>        </span><span id="local-6989586621679868524"><span class="annot"><span class="annottext">chunkFile :: FsPath
</span><a href="#local-6989586621679868524"><span class="hs-identifier hs-var hs-var">chunkFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868436"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-comment">-- | We don't rely on the position of the handle, we always use</span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-comment">-- 'hGetExactlyAt', i.e. @pread@ for reading from a given offset.</span><span>
</span><span id="line-639"></span><span>    </span><span class="annot"><a href="#local-6989586621679868476"><span class="hs-identifier hs-type">readHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span>
</span><span id="line-640"></span><span>    </span><span id="local-6989586621679868476"><span class="annot"><span class="annottext">readHeader :: m ByteString
</span><a href="#local-6989586621679868476"><span class="hs-identifier hs-var hs-var">readHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-641"></span><span>        </span><span class="hs-comment">-- We cannot check the checksum in this case, as we're not reading the</span><span>
</span><span id="line-642"></span><span>        </span><span class="hs-comment">-- whole block</span><span>
</span><span id="line-643"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><span class="hs-identifier hs-var">hGetExactlyAt</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868434"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868439"><span class="hs-identifier hs-var">eHnd</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679868527"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679868528"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-644"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-645"></span><span>        </span><span id="local-6989586621679868527"><span class="annot"><span class="annottext">size :: Word64
</span><a href="#local-6989586621679868527"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word16 -&gt; Word64) -&gt; Word16 -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderSize -&gt; Word16
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unHeaderSize"><span class="hs-identifier hs-var">Secondary.unHeaderSize</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderSize
</span><a href="#local-6989586621679868470"><span class="hs-identifier hs-var">headerSize</span></a></span><span>
</span><span id="line-646"></span><span>        </span><span id="local-6989586621679868528"><span class="annot"><span class="annottext">offset :: AbsOffset
</span><a href="#local-6989586621679868528"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; AbsOffset
</span><span class="hs-identifier hs-var">AbsOffset</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; AbsOffset) -&gt; Word64 -&gt; AbsOffset
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-647"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unBlockOffset"><span class="hs-identifier hs-var">Secondary.unBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679868511"><span class="hs-identifier hs-var">blockOffset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span>
</span><span id="line-648"></span><span>          </span><span class="annot"><span class="annottext">Word16 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderOffset -&gt; Word16
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unHeaderOffset"><span class="hs-identifier hs-var">Secondary.unHeaderOffset</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderOffset
</span><a href="#local-6989586621679868516"><span class="hs-identifier hs-var">headerOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span>    </span><span class="annot"><a href="#local-6989586621679868479"><span class="hs-identifier hs-type">readNestedCtxt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#SomeSecond"><span class="hs-identifier hs-type">SomeSecond</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>    </span><span id="local-6989586621679868479"><span class="annot"><span class="annottext">readNestedCtxt :: m (SomeSecond (NestedCtxt Header) blk)
</span><a href="#local-6989586621679868479"><span class="hs-identifier hs-var hs-var">readNestedCtxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>        </span><span id="local-6989586621679868531"><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621679868531"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ShortByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Short.Internal.html#toShort"><span class="hs-identifier hs-var">Short.toShort</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ShortByteString)
-&gt; (ByteString -&gt; ByteString) -&gt; ByteString -&gt; ShortByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#toStrict"><span class="hs-identifier hs-var">Lazy.toStrict</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ShortByteString)
-&gt; m ByteString -&gt; m ShortByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-653"></span><span>                   </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><span class="hs-identifier hs-var">hGetExactlyAt</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679868434"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679868439"><span class="hs-identifier hs-var">eHnd</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679868534"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">AbsOffset
</span><a href="#local-6989586621679868535"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-654"></span><span>        </span><span class="annot"><span class="annottext">SomeSecond (NestedCtxt Header) blk
-&gt; m (SomeSecond (NestedCtxt Header) blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeSecond (NestedCtxt Header) blk
 -&gt; m (SomeSecond (NestedCtxt Header) blk))
-&gt; SomeSecond (NestedCtxt Header) blk
-&gt; m (SomeSecond (NestedCtxt Header) blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy (Header blk)
-&gt; ShortByteString
-&gt; SizeInBytes
-&gt; SomeSecond (NestedCtxt Header) blk
forall (proxy :: * -&gt; *).
proxy (Header blk)
-&gt; ShortByteString
-&gt; SizeInBytes
-&gt; SomeSecond (NestedCtxt Header) blk
forall (f :: * -&gt; *) blk (proxy :: * -&gt; *).
ReconstructNestedCtxt f blk =&gt;
proxy (f blk)
-&gt; ShortByteString -&gt; SizeInBytes -&gt; SomeSecond (NestedCtxt f) blk
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#reconstructNestedCtxt"><span class="hs-identifier hs-var">reconstructNestedCtxt</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy (Header blk)
</span><a href="#local-6989586621679868537"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">ShortByteString
</span><a href="#local-6989586621679868531"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecondaryOffset -&gt; SizeInBytes
</span><span class="hs-identifier hs-var">SizeInBytes</span></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679868440"><span class="hs-identifier hs-var">blockSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-656"></span><span>        </span><span class="annot"><a href="#local-6989586621679868537"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>        </span><span id="local-6989586621679868537"><span class="annot"><span class="annottext">p :: Proxy (Header blk)
</span><a href="#local-6989586621679868537"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy (Header blk)
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span>        </span><span id="local-6989586621679868534"><span class="annot"><span class="annottext">size :: Word64
</span><a href="#local-6989586621679868534"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrefixLen -&gt; Word8
</span><a href="Ouroboros.Consensus.Storage.Common.html#getPrefixLen"><span class="hs-identifier hs-var">getPrefixLen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy (Header blk) -&gt; PrefixLen
forall (proxy :: * -&gt; *). proxy (Header blk) -&gt; PrefixLen
forall (f :: * -&gt; *) blk (proxy :: * -&gt; *).
ReconstructNestedCtxt f blk =&gt;
proxy (f blk) -&gt; PrefixLen
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#reconstructPrefixLen"><span class="hs-identifier hs-var">reconstructPrefixLen</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy (Header blk)
</span><a href="#local-6989586621679868537"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>        </span><span id="local-6989586621679868535"><span class="annot"><span class="annottext">offset :: AbsOffset
</span><a href="#local-6989586621679868535"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; AbsOffset
</span><span class="hs-identifier hs-var">AbsOffset</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; AbsOffset) -&gt; Word64 -&gt; AbsOffset
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unBlockOffset"><span class="hs-identifier hs-var">Secondary.unBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679868511"><span class="hs-identifier hs-var">blockOffset</span></a></span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><a href="#local-6989586621679868484"><span class="hs-identifier hs-type">parseBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-663"></span><span>    </span><span id="local-6989586621679868484"><span class="annot"><span class="annottext">parseBlock :: ByteString -&gt; m blk
</span><a href="#local-6989586621679868484"><span class="hs-identifier hs-var hs-var">parseBlock</span></a></span></span><span> </span><span id="local-6989586621679868541"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868541"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
-&gt; m blk
forall b'.
ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; b') -&gt; m b'
</span><a href="#local-6989586621679868542"><span class="hs-identifier hs-var">throwParseErrors</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868541"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
 -&gt; m blk)
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
-&gt; m blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-664"></span><span>        </span><span class="annot"><span class="annottext">(forall s. Decoder s (ByteString -&gt; blk))
-&gt; ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
forall a.
(forall s. Decoder s a)
-&gt; ByteString -&gt; Either DeserialiseFailure (ByteString, a)
</span><span class="hs-identifier hs-var">CBOR.deserialiseFromBytes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig blk -&gt; forall s. Decoder s (ByteString -&gt; blk)
forall blk a.
DecodeDisk blk a =&gt;
CodecConfig blk -&gt; forall s. Decoder s a
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#decodeDisk"><span class="hs-identifier hs-var">decodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679868437"><span class="hs-identifier hs-var">ccfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868541"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span>    </span><span class="annot"><a href="#local-6989586621679868491"><span class="hs-identifier hs-type">parseHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-667"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Util.html#SomeSecond"><span class="hs-identifier hs-type">SomeSecond</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-668"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span>
</span><span id="line-669"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867586"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span>    </span><span id="local-6989586621679868491"><span class="annot"><span class="annottext">parseHeader :: SomeSecond (NestedCtxt Header) blk -&gt; ByteString -&gt; m (Header blk)
</span><a href="#local-6989586621679868491"><span class="hs-identifier hs-var hs-var">parseHeader</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#SomeSecond"><span class="hs-identifier hs-type">SomeSecond</span></a></span><span> </span><span id="local-6989586621679868547"><span class="annot"><span class="annottext">NestedCtxt Header blk b
</span><a href="#local-6989586621679868547"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679868548"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868548"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
-&gt; m (Header blk)
forall b'.
ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; b') -&gt; m b'
</span><a href="#local-6989586621679868542"><span class="hs-identifier hs-var">throwParseErrors</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868548"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
 -&gt; m (Header blk))
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
-&gt; m (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-671"></span><span>        </span><span class="annot"><span class="annottext">(forall s. Decoder s (ByteString -&gt; Header blk))
-&gt; ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
forall a.
(forall s. Decoder s a)
-&gt; ByteString -&gt; Either DeserialiseFailure (ByteString, a)
</span><span class="hs-identifier hs-var">CBOR.deserialiseFromBytes</span></span><span>
</span><span id="line-672"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679868553"><span class="annot"><span class="annottext">ByteString -&gt; b
</span><a href="#local-6989586621679868553"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DepPair (NestedCtxt Header blk) -&gt; Header blk
forall (f :: * -&gt; *) blk.
HasNestedContent f blk =&gt;
DepPair (NestedCtxt f blk) -&gt; f blk
</span><a href="Ouroboros.Consensus.Block.NestedContent.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">(DepPair (NestedCtxt Header blk) -&gt; Header blk)
-&gt; (ByteString -&gt; DepPair (NestedCtxt Header blk))
-&gt; ByteString
-&gt; Header blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk b -&gt; b -&gt; DepPair (NestedCtxt Header blk)
forall (f :: * -&gt; *) a. f a -&gt; a -&gt; DepPair f
</span><a href="Ouroboros.Consensus.Util.DepPair.html#DepPair"><span class="hs-identifier hs-var">DepPair</span></a></span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk b
</span><a href="#local-6989586621679868547"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; DepPair (NestedCtxt Header blk))
-&gt; (ByteString -&gt; b)
-&gt; ByteString
-&gt; DepPair (NestedCtxt Header blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; b
</span><a href="#local-6989586621679868553"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ByteString -&gt; b) -&gt; ByteString -&gt; Header blk)
-&gt; Decoder s (ByteString -&gt; b)
-&gt; Decoder s (ByteString -&gt; Header blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
-&gt; NestedCtxt Header blk b -&gt; forall s. Decoder s (ByteString -&gt; b)
forall a.
CodecConfig blk
-&gt; NestedCtxt Header blk a -&gt; forall s. Decoder s (ByteString -&gt; a)
forall (f :: * -&gt; * -&gt; *) blk a.
DecodeDiskDep f blk =&gt;
CodecConfig blk -&gt; f blk a -&gt; forall s. Decoder s (ByteString -&gt; a)
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#decodeDiskDep"><span class="hs-identifier hs-var">decodeDiskDep</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679868437"><span class="hs-identifier hs-var">ccfg</span></a></span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk b
</span><a href="#local-6989586621679868547"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>          </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868548"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span>    </span><span class="annot"><a href="#local-6989586621679868542"><span class="hs-identifier hs-type">throwParseErrors</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-676"></span><span>         </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679867673"><span class="annot"><a href="#local-6989586621679867673"><span class="hs-identifier hs-type">b'</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-677"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span>
</span><span id="line-678"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.DeserialiseFailure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867673"><span class="hs-identifier hs-type">b'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679867587"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867673"><span class="hs-identifier hs-type">b'</span></a></span><span>
</span><span id="line-680"></span><span>    </span><span id="local-6989586621679868542"><span class="annot"><span class="annottext">throwParseErrors :: forall b'.
ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; b') -&gt; m b'
</span><a href="#local-6989586621679868542"><span class="hs-identifier hs-var hs-var">throwParseErrors</span></a></span></span><span> </span><span id="local-6989586621679868564"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868564"><span class="hs-identifier hs-var">fullBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679868565"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868565"><span class="hs-identifier hs-var">trailing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679868566"><span class="annot"><span class="annottext">ByteString -&gt; b'
</span><a href="#local-6989586621679868566"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-682"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html#null"><span class="hs-identifier hs-var">Lazy.null</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868565"><span class="hs-identifier hs-var">trailing</span></a></span><span>
</span><span id="line-683"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(b' -&gt; m b') -&gt; b' -&gt; m b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; b'
</span><a href="#local-6989586621679868566"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868564"><span class="hs-identifier hs-var">fullBytes</span></a></span><span>
</span><span id="line-684"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-685"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnexpectedFailure blk -&gt; m b'
forall blk (m :: * -&gt; *) a.
(StandardHash blk, Typeable blk, MonadThrow m) =&gt;
UnexpectedFailure blk -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#throwUnexpectedFailure"><span class="hs-identifier hs-var">throwUnexpectedFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(UnexpectedFailure blk -&gt; m b') -&gt; UnexpectedFailure blk -&gt; m b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-686"></span><span>               </span><span class="annot"><span class="annottext">FsPath -&gt; RealPoint blk -&gt; ByteString -&gt; UnexpectedFailure blk
forall blk.
FsPath -&gt; RealPoint blk -&gt; ByteString -&gt; UnexpectedFailure blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#TrailingDataError"><span class="hs-identifier hs-var">TrailingDataError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868436"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868504"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679868565"><span class="hs-identifier hs-var">trailing</span></a></span><span>
</span><span id="line-687"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679868569"><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621679868569"><span class="hs-identifier hs-var">err</span></a></span></span><span>
</span><span id="line-688"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnexpectedFailure blk -&gt; m b'
forall blk (m :: * -&gt; *) a.
(StandardHash blk, Typeable blk, MonadThrow m) =&gt;
UnexpectedFailure blk -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#throwUnexpectedFailure"><span class="hs-identifier hs-var">throwUnexpectedFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(UnexpectedFailure blk -&gt; m b') -&gt; UnexpectedFailure blk -&gt; m b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-689"></span><span>               </span><span class="annot"><span class="annottext">FsPath
-&gt; RealPoint blk -&gt; DeserialiseFailure -&gt; UnexpectedFailure blk
forall blk.
FsPath
-&gt; RealPoint blk -&gt; DeserialiseFailure -&gt; UnexpectedFailure blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679868436"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679868504"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621679868569"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-690"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts     #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GADTs                #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase           #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf           #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns       #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE PatternSynonyms      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards      #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables  #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving   #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications     #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-comment">-- | Operations involving chain selection: the initial chain selection and</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- adding a block.</span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync"><span class="hs-identifier">addBlockAsync</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier">addBlockSync</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier">chainSelectionForBlock</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection"><span class="hs-identifier">initialChainSelection</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exported for testing purposes</span></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier">olderThanK</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#forM"><span class="hs-identifier">forM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier">void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html"><span class="hs-identifier">Control.Monad.Trans.State.Strict</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nullTracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html"><span class="hs-identifier">Data.Function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-identifier">on</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html"><span class="hs-identifier">Data.Functor.Contravariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator">(&gt;$&lt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#partition"><span class="hs-identifier">partition</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier">sortBy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier">NonEmpty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isJust"><span class="hs-identifier">isJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StrictMaybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isSNothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>                     </span><span class="annot"><span class="hs-identifier">strictMaybeToMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Config.html"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Diff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Diff</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Diff</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.InFuture</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html#CheckInFuture"><span class="hs-identifier">CheckInFuture</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.InFuture</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InFuture</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier">ValidatedFragment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Validated</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VF</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.ValidatedDiff</span></a></span><span>
</span><span id="line-52"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.ValidatedDiff</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ValidatedDiff</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Abstract</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.History</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">History</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Inspect</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#AddBlockPromise"><span class="hs-identifier">AddBlockPromise</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#AddBlockResult"><span class="hs-identifier">AddBlockResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier">BlockComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainType"><span class="hs-identifier">ChainType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier">InvalidBlockReason</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment</span></a></span><span>
</span><span id="line-64"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier">InvalidBlockPunishment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InvalidBlockPunishment</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache</span></a></span><span>
</span><span id="line-67"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier">BlockCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BlockCache</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier">LedgerDB'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDB"><span class="hs-identifier">LgrDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LgrDB</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Paths</span></a></span><span>
</span><span id="line-73"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#LookupBlockInfo"><span class="hs-identifier">LookupBlockInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Paths</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Paths</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Query</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Query</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Types</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDB"><span class="hs-identifier">ImmutableDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ImmutableDB</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier">VolatileDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VolatileDB</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#eitherToMaybe"><span class="hs-identifier">eitherToMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier">whenJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.AnchoredFragment.html"><span class="hs-identifier">Ouroboros.Consensus.Util.AnchoredFragment</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Enclose.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Enclose</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.Enclose.html#encloseWith"><span class="hs-identifier">encloseWith</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html"><span class="hs-identifier">Ouroboros.Consensus.Util.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.TentativeState.html"><span class="hs-identifier">Ouroboros.Consensus.Util.TentativeState</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Anchor</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AnchoredFragment</span></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>                     </span><span class="annot"><span class="hs-identifier">AnchoredSeq</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredSeq</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AS</span></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-comment">-- | Perform the initial chain selection based on the tip of the ImmutableDB</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- and the contents of the VolatileDB.</span><span>
</span><span id="line-94"></span><span class="hs-comment">--</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- Returns the chosen validated chain and corresponding ledger.</span><span>
</span><span id="line-96"></span><span class="hs-comment">--</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- See &quot;## Initialization&quot; in ChainDB.md.</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection"><span class="hs-identifier hs-type">initialChainSelection</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-99"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679900895"><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679900897"><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDB"><span class="hs-identifier hs-type">ImmutableDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-type">VolatileDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDB"><span class="hs-identifier hs-type">LgrDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceInitChainSelEvent"><span class="hs-identifier hs-type">TraceInitChainSelEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#FutureBlocks"><span class="hs-identifier hs-type">FutureBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html#CheckInFuture"><span class="hs-identifier hs-type">CheckInFuture</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span id="initialChainSelection"><span class="annot"><span class="annottext">initialChainSelection :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ImmutableDB m blk
-&gt; VolatileDB m blk
-&gt; LgrDB m blk
-&gt; Tracer m (TraceInitChainSelEvent blk)
-&gt; TopLevelConfig blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; StrictTVar m (FutureBlocks m blk)
-&gt; CheckInFuture m blk
-&gt; m (ChainAndLedger blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection"><span class="hs-identifier hs-var hs-var">initialChainSelection</span></a></span></span><span> </span><span id="local-6989586621679901600"><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679901600"><span class="hs-identifier hs-var">immutableDB</span></a></span></span><span> </span><span id="local-6989586621679901601"><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679901601"><span class="hs-identifier hs-var">volatileDB</span></a></span></span><span> </span><span id="local-6989586621679901602"><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679901602"><span class="hs-identifier hs-var">lgrDB</span></a></span></span><span> </span><span id="local-6989586621679901603"><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621679901603"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679901604"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679901604"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679901605"><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679901605"><span class="hs-identifier hs-var">varInvalid</span></a></span></span><span>
</span><span id="line-110"></span><span>                      </span><span id="local-6989586621679901606"><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk)
</span><a href="#local-6989586621679901606"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span></span><span> </span><span id="local-6989586621679901607"><span class="annot"><span class="annottext">CheckInFuture m blk
</span><a href="#local-6989586621679901607"><span class="hs-identifier hs-var">futureCheck</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">-- We follow the steps from section &quot;## Initialization&quot; in ChainDB.md</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679901608"><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621679901608"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Anchor</span></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679901609"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679901609"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679901610"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679901610"><span class="hs-identifier hs-var">ledger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
-&gt; m (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
      LedgerDB' blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
 -&gt; m (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
       LedgerDB' blk))
-&gt; STM
     m
     (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
-&gt; m (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
      LedgerDB' blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>      </span><span id="local-6989586621679901612"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679901612"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (InvalidBlocks blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679901605"><span class="hs-identifier hs-var">varInvalid</span></a></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="annottext">(Anchor blk
 -&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
 -&gt; LedgerDB' blk
 -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
     LedgerDB' blk))
-&gt; STM m (Anchor blk)
-&gt; STM
     m
     ((ChainHash blk -&gt; Set (HeaderHash blk))
      -&gt; LedgerDB' blk
      -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
          LedgerDB' blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; STM m (Anchor blk)
forall (m :: * -&gt; *) blk.
(MonadSTM m, HasCallStack) =&gt;
ImmutableDB m blk -&gt; STM m (Anchor blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getTipAnchor"><span class="hs-identifier hs-var">ImmutableDB.getTipAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679901600"><span class="hs-identifier hs-var">immutableDB</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">STM
  m
  ((ChainHash blk -&gt; Set (HeaderHash blk))
   -&gt; LedgerDB' blk
   -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
       LedgerDB' blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM
     m
     (LedgerDB' blk
      -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
          LedgerDB' blk))
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-var">ignoreInvalidSuc</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679901601"><span class="hs-identifier hs-var">volatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679901612"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">((ChainHash blk -&gt; Set (HeaderHash blk))
 -&gt; ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-118"></span><span>              </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (m :: * -&gt; *) blk.
VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#filterByPredecessor"><span class="hs-identifier hs-var">VolatileDB.filterByPredecessor</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679901601"><span class="hs-identifier hs-var">volatileDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">STM
  m
  (LedgerDB' blk
   -&gt; (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk),
       LedgerDB' blk))
-&gt; STM m (LedgerDB' blk)
-&gt; STM
     m
     (Anchor blk, ChainHash blk -&gt; Set (HeaderHash blk), LedgerDB' blk)
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#getCurrent"><span class="hs-identifier hs-var">LgrDB.getCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679901602"><span class="hs-identifier hs-var">lgrDB</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621679901620"><span class="annot"><span class="annottext">[AnchoredFragment (Header blk)]
</span><a href="#local-6989586621679901620"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Anchor blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; m [AnchoredFragment (Header blk)]
</span><a href="#local-6989586621679901621"><span class="hs-identifier hs-var">constructChains</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621679901608"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679901609"><span class="hs-identifier hs-var">succsOf</span></a></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-comment">-- We use the empty fragment anchored at @i@ as the current chain (and</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">-- ledger) and the default in case there is no better candidate.</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679901622"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901622"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk) -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; AnchoredSeq v a b
</span><span class="hs-identifier hs-var">Empty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor blk -&gt; Anchor (Header blk)
forall a b. (HeaderHash a ~ HeaderHash b) =&gt; Anchor a -&gt; Anchor b
</span><span class="hs-identifier hs-var">AF.castAnchor</span></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621679901608"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>        </span><span id="local-6989586621679901625"><span class="annot"><span class="annottext">curChainAndLedger :: ChainAndLedger blk
</span><a href="#local-6989586621679901625"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; LedgerDB' blk -&gt; ChainAndLedger blk
forall l b.
(GetTip l, HasHeader b, HeaderHash b ~ HeaderHash l,
 HasCallStack) =&gt;
AnchoredFragment b -&gt; l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-var">VF.ValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901622"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679901610"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment (Header blk)]
-&gt; Maybe (NonEmpty (AnchoredFragment (Header blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; [AnchoredFragment (Header blk)]
-&gt; [AnchoredFragment (Header blk)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679901629"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901622"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment (Header blk)]
</span><a href="#local-6989586621679901620"><span class="hs-identifier hs-var">chains</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-129"></span><span>      </span><span class="hs-comment">-- If there are no candidates, no chain selection is needed</span><span>
</span><span id="line-130"></span><span>      </span><span class="annot"><span class="annottext">Maybe (NonEmpty (AnchoredFragment (Header blk)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; m (ChainAndLedger blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679901625"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679901630"><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901630"><span class="hs-identifier hs-var">chains'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
-&gt; (ValidatedChainDiff (Header blk) (LedgerDB' blk)
    -&gt; ChainAndLedger blk)
-&gt; Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; ChainAndLedger blk
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679901625"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ChainAndLedger blk
</span><a href="#local-6989586621679901632"><span class="hs-identifier hs-var">toChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
 -&gt; ChainAndLedger blk)
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (ChainAndLedger blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-132"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
ChainAndLedger blk
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
ChainAndLedger blk
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621679901633"><span class="hs-identifier hs-var">chainSelection'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679901625"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901630"><span class="hs-identifier hs-var">chains'</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><a href="#local-6989586621679901629"><span class="hs-identifier hs-type">bcfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockConfig"><span class="hs-identifier hs-type">BlockConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621679901629"><span class="annot"><span class="annottext">bcfg :: BlockConfig blk
</span><a href="#local-6989586621679901629"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configBlock"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679901604"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">-- | Turn the 'ValidatedChainDiff' into a 'ChainAndLedger'.</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- The rollback of the 'ChainDiff' must be empty, as the suffix starts</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- from the tip of the ImmutableDB, and we can't roll back past that tip.</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">-- This is guaranteed by the fact that all constructed candidates start</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- from this tip.</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><a href="#local-6989586621679901632"><span class="hs-identifier hs-type">toChainAndLedger</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621679901632"><span class="annot"><span class="annottext">toChainAndLedger :: ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ChainAndLedger blk
</span><a href="#local-6989586621679901632"><span class="hs-identifier hs-var hs-var">toChainAndLedger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621679901636"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679901636"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span> </span><span id="local-6989586621679901637"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679901637"><span class="hs-identifier hs-var">ledger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679901636"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-148"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span id="local-6989586621679901639"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679901639"><span class="hs-identifier hs-var">rollback</span></a></span></span><span> </span><span id="local-6989586621679901640"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901640"><span class="hs-identifier hs-var">suffix</span></a></span></span><span>
</span><span id="line-149"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679901639"><span class="hs-identifier hs-var">rollback</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-150"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; LedgerDB' blk -&gt; ChainAndLedger blk
forall l b.
(GetTip l, HasHeader b, HeaderHash b ~ HeaderHash l,
 HasCallStack) =&gt;
AnchoredFragment b -&gt; l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-var">VF.ValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901640"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679901637"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-151"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ChainAndLedger blk
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;constructed an initial chain with rollback&quot;</span></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-comment">-- | Use the VolatileDB to construct all chains starting from the tip of</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-comment">-- the ImmutableDB.</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><a href="#local-6989586621679901621"><span class="hs-identifier hs-type">constructChains</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-157"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Anchor</span></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-comment">-- ^ Tip of the ImmutableDB, @i@</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621679901621"><span class="annot"><span class="annottext">constructChains :: Anchor blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; m [AnchoredFragment (Header blk)]
</span><a href="#local-6989586621679901621"><span class="hs-identifier hs-var hs-var">constructChains</span></a></span></span><span> </span><span id="local-6989586621679901642"><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621679901642"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679901643"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679901643"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StateT
   (Map (HeaderHash blk) (Header blk))
   m
   [AnchoredFragment (Header blk)]
 -&gt; Map (HeaderHash blk) (Header blk)
 -&gt; m [AnchoredFragment (Header blk)])
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     [AnchoredFragment (Header blk)]
-&gt; m [AnchoredFragment (Header blk)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">StateT
  (Map (HeaderHash blk) (Header blk))
  m
  [AnchoredFragment (Header blk)]
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; m [AnchoredFragment (Header blk)]
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#evalStateT"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk)
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT
   (Map (HeaderHash blk) (Header blk))
   m
   [AnchoredFragment (Header blk)]
 -&gt; m [AnchoredFragment (Header blk)])
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     [AnchoredFragment (Header blk)]
-&gt; m [AnchoredFragment (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="annottext">(NonEmpty (HeaderHash blk)
 -&gt; StateT
      (Map (HeaderHash blk) (Header blk))
      m
      (AnchoredFragment (Header blk)))
-&gt; [NonEmpty (HeaderHash blk)]
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     [AnchoredFragment (Header blk)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901648"><span class="hs-identifier hs-var">constructChain</span></a></span><span> </span><span class="annot"><span class="annottext">[NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621679901649"><span class="hs-identifier hs-var">suffixesAfterI</span></a></span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-163"></span><span>        </span><span class="annot"><a href="#local-6989586621679901649"><span class="hs-identifier hs-type">suffixesAfterI</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621679901649"><span class="annot"><span class="annottext">suffixesAfterI :: [NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621679901649"><span class="hs-identifier hs-var hs-var">suffixesAfterI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
forall blk.
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#maximalCandidates"><span class="hs-identifier hs-var">Paths.maximalCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679901643"><span class="hs-identifier hs-var">succsOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor blk -&gt; Point blk
forall block. Anchor block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorToPoint</span></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621679901642"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>        </span><span class="annot"><a href="#local-6989586621679901648"><span class="hs-identifier hs-type">constructChain</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-167"></span><span>             </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#StateT"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>                    </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-170"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>        </span><span id="local-6989586621679901648"><span class="annot"><span class="annottext">constructChain :: NonEmpty (HeaderHash blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901648"><span class="hs-identifier hs-var hs-var">constructChain</span></a></span></span><span> </span><span id="local-6989586621679901652"><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621679901652"><span class="hs-identifier hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><span class="annottext">Anchor (Header blk)
-&gt; [Header blk] -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; [b] -&gt; AnchoredSeq v a b
</span><span class="hs-identifier hs-var">AF.fromOldestFirst</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor blk -&gt; Anchor (Header blk)
forall a b. (HeaderHash a ~ HeaderHash b) =&gt; Anchor a -&gt; Anchor b
</span><span class="hs-identifier hs-var">AF.castAnchor</span></span><span> </span><span class="annot"><span class="annottext">Anchor blk
</span><a href="#local-6989586621679901642"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Header blk] -&gt; AnchoredFragment (Header blk))
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m [Header blk]
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (AnchoredFragment (Header blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-173"></span><span>            </span><span class="annot"><span class="annottext">(HeaderHash blk
 -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; [HeaderHash blk]
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m [Header blk]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (m :: * -&gt; *) blk.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var">getKnownHeaderThroughCache</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679901601"><span class="hs-identifier hs-var">volatileDB</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk) -&gt; [HeaderHash blk]
forall a. NonEmpty a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#toList"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621679901652"><span class="hs-identifier hs-var">hashes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- | Perform chain selection (including validation) on the given</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">-- candidates.</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-comment">-- PRECONDITION: all candidates are anchored at @i@.</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-comment">-- PRECONDITION: all candidates must be preferred over the current chain.</span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="#local-6989586621679901633"><span class="hs-identifier hs-type">chainSelection'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-182"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-184"></span><span>         </span><span class="hs-comment">-- ^ The current chain and ledger, corresponding to</span><span>
</span><span id="line-185"></span><span>         </span><span class="hs-comment">-- @i@.</span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>         </span><span class="hs-comment">-- ^ Candidates anchored at @i@</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679900895"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900897"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621679901633"><span class="annot"><span class="annottext">chainSelection' :: HasCallStack =&gt;
ChainAndLedger blk
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621679901633"><span class="hs-identifier hs-var hs-var">chainSelection'</span></a></span></span><span> </span><span id="local-6989586621679901696"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679901696"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span id="local-6989586621679901697"><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901697"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; NonEmpty (AnchoredFragment (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; Point blk
forall blk. UpdateLedger blk =&gt; LedgerDB' blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#currentPoint"><span class="hs-identifier hs-var">LgrDB.currentPoint</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679901700"><span class="hs-identifier hs-var">ledger</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk -&gt; Bool)
-&gt; (AnchoredFragment (Header blk) -&gt; Point blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span>
</span><span id="line-191"></span><span>                     </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; (AnchoredFragment (Header blk) -&gt; Point (Header blk))
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>                    </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901697"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; NonEmpty (AnchoredFragment (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679901629"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901704"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901697"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>          </span><span id="local-6989586621679901705"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679901705"><span class="hs-identifier hs-var">cse</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ChainSelEnv m blk)
</span><a href="#local-6989586621679901706"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span>
</span><span id="line-195"></span><span>          </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var">chainSelection</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679901705"><span class="hs-identifier hs-var">cse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk)
forall b. AnchoredFragment b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#extend"><span class="hs-identifier hs-var">Diff.extend</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk))
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; NonEmpty (ChainDiff (Header blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679901697"><span class="hs-identifier hs-var">candidates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-197"></span><span>        </span><span id="local-6989586621679901704"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901704"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679901696"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-198"></span><span>        </span><span id="local-6989586621679901700"><span class="annot"><span class="annottext">ledger :: LedgerDB' blk
</span><a href="#local-6989586621679901700"><span class="hs-identifier hs-var hs-var">ledger</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; LedgerDB' blk
forall b l. ValidatedFragment b l -&gt; l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedLedger"><span class="hs-identifier hs-var">VF.validatedLedger</span></a></span><span>   </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679901696"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-199"></span><span>        </span><span id="local-6989586621679901706"><span class="annot"><span class="annottext">chainSelEnv :: m (ChainSelEnv m blk)
</span><a href="#local-6989586621679901706"><span class="hs-identifier hs-var hs-var">chainSelEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>          </span><span id="local-6989586621679901711"><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk)
</span><a href="#local-6989586621679901711"><span class="hs-identifier hs-var">varTentativeState</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TentativeState blk -&gt; m (StrictTVar m (TentativeState blk))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">TentativeState blk
forall blk. TentativeState blk
</span><a href="Ouroboros.Consensus.Util.TentativeState.html#NoLastInvalidTentative"><span class="hs-identifier hs-var">NoLastInvalidTentative</span></a></span><span>
</span><span id="line-201"></span><span>          </span><span id="local-6989586621679901714"><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679901714"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
-&gt; m (StrictTVar m (StrictMaybe (Header blk)))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
forall a. StrictMaybe a
</span><span class="hs-identifier hs-var">SNothing</span></span><span>
</span><span id="line-202"></span><span>          </span><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; m (ChainSelEnv m blk)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
lgrDB :: LgrDB m blk
lgrDB :: LgrDB m blk
</span><a href="#local-6989586621679901602"><span class="hs-identifier hs-var hs-var">lgrDB</span></a></span><span>
</span><span id="line-204"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
bcfg :: BlockConfig blk
bcfg :: BlockConfig blk
</span><a href="#local-6989586621679901629"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span><span>
</span><span id="line-205"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679901605"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span><span>
</span><span id="line-206"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk)
varFutureBlocks :: StrictTVar m (FutureBlocks m blk)
varFutureBlocks :: StrictTVar m (FutureBlocks m blk)
</span><a href="#local-6989586621679901606"><span class="hs-identifier hs-var hs-var">varFutureBlocks</span></a></span><span>
</span><span id="line-207"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CheckInFuture m blk
futureCheck :: CheckInFuture m blk
futureCheck :: CheckInFuture m blk
</span><a href="#local-6989586621679901607"><span class="hs-identifier hs-var hs-var">futureCheck</span></a></span><span>
</span><span id="line-208"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockCache :: BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#blockCache"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-209"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
curChainAndLedger :: ChainAndLedger blk
curChainAndLedger :: ChainAndLedger blk
</span><a href="#local-6989586621679901696"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">validationTracer :: Tracer m (TraceValidationEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validationTracer"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; TraceInitChainSelEvent blk
forall blk. TraceValidationEvent blk -&gt; TraceInitChainSelEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InitChainSelValidation"><span class="hs-identifier hs-var">InitChainSelValidation</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; TraceInitChainSelEvent blk)
-&gt; Tracer m (TraceInitChainSelEvent blk)
-&gt; Tracer m (TraceValidationEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621679901603"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-211"></span><span>              </span><span class="hs-comment">-- initial chain selection is not concerned about pipelining</span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pipeliningTracer :: Tracer m (TracePipeliningEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#pipeliningTracer"><span class="hs-identifier hs-var">pipeliningTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TracePipeliningEvent blk)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk)
varTentativeState :: StrictTVar m (TentativeState blk)
varTentativeState :: StrictTVar m (TentativeState blk)
</span><a href="#local-6989586621679901711"><span class="hs-identifier hs-var hs-var">varTentativeState</span></a></span><span>
</span><span id="line-214"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
varTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
varTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679901714"><span class="hs-identifier hs-var hs-var">varTentativeHeader</span></a></span><span>
</span><span id="line-215"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">punish :: Maybe (RealPoint blk, InvalidBlockPunishment m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#punish"><span class="hs-identifier hs-var">punish</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (RealPoint blk, InvalidBlockPunishment m)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-216"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getTentativeFollowers :: STM m [FollowerHandle m blk]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getTentativeFollowers"><span class="hs-identifier hs-var">getTentativeFollowers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FollowerHandle m blk] -&gt; STM m [FollowerHandle m blk]
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-217"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">-- | Add a block to the ChainDB, /asynchronously/.</span><span>
</span><span id="line-220"></span><span class="hs-comment">--</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- This adds a 'BlockToAdd' corresponding to the given block to the</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- 'cdbBlocksToAdd' queue. The entries in that queue are processed using</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- 'addBlockSync', see that function for more information.</span><span>
</span><span id="line-224"></span><span class="hs-comment">--</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- When the queue is full, this function will still block.</span><span>
</span><span id="line-226"></span><span class="hs-comment">--</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- An important advantage of this asynchronous approach over a synchronous</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- approach is that it doesn't have the following disadvantage: when a thread</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- adding a block to the ChainDB is killed, which can happen when</span><span>
</span><span id="line-230"></span><span class="hs-comment">-- disconnecting from the corresponding node, we might have written the block</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- to disk, but not updated the corresponding in-memory state (e.g., that of</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- the VolatileDB), leaving both out of sync.</span><span>
</span><span id="line-233"></span><span class="hs-comment">--</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- With this asynchronous approach, threads adding blocks asynchronously can</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- be killed without worries, the background thread processing the blocks</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- synchronously won't be killed. Only when the whole ChainDB shuts down will</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- that background thread get killed. But since there will be no more</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- in-memory state, it can't get out of sync with the file system state. On</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- the next startup, a correct in-memory state will be reconstructed from the</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- file system state.</span><span>
</span><span id="line-241"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync"><span class="hs-identifier hs-type">addBlockAsync</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-242"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679901084"><span class="annot"><a href="#local-6989586621679901084"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679901085"><span class="annot"><a href="#local-6989586621679901085"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901084"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679901085"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901084"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901085"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier hs-type">InvalidBlockPunishment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901084"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901085"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901084"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#AddBlockPromise"><span class="hs-identifier hs-type">AddBlockPromise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901084"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901085"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span id="addBlockAsync"><span class="annot"><span class="annottext">addBlockAsync :: forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
ChainDbEnv m blk
-&gt; InvalidBlockPunishment m -&gt; blk -&gt; m (AddBlockPromise m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync"><span class="hs-identifier hs-var hs-var">addBlockAsync</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679901740"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
cdbTracer :: Tracer m (TraceEvent blk)
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679901740"><span class="hs-identifier hs-var hs-var">cdbTracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679901742"><span class="annot"><span class="annottext">BlocksToAdd m blk
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbBlocksToAdd :: BlocksToAdd m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbBlocksToAdd"><span class="hs-identifier hs-var hs-var">cdbBlocksToAdd</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
-&gt; BlocksToAdd m blk
-&gt; InvalidBlockPunishment m
-&gt; blk
-&gt; m (AddBlockPromise m blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
Tracer m (TraceAddBlockEvent blk)
-&gt; BlocksToAdd m blk
-&gt; InvalidBlockPunishment m
-&gt; blk
-&gt; m (AddBlockPromise m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#addBlockToAdd"><span class="hs-identifier hs-var">addBlockToAdd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679901740"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlocksToAdd m blk
</span><a href="#local-6989586621679901742"><span class="hs-identifier hs-var">cdbBlocksToAdd</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">-- | Add a block to the ChainDB, /synchronously/.</span><span>
</span><span id="line-251"></span><span class="hs-comment">--</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- This is the only operation that actually changes the ChainDB. It will store</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- the block on disk and trigger chain selection, possibly switching to a</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- fork.</span><span>
</span><span id="line-255"></span><span class="hs-comment">--</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- When the slot of the block is &gt; the current slot, a chain selection will be</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- scheduled in the slot of the block.</span><span>
</span><span id="line-258"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier hs-type">addBlockSync</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-259"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679901100"><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679901101"><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-260"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-261"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-262"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-263"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-264"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-265"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#BlockToAdd"><span class="hs-identifier hs-type">BlockToAdd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span id="addBlockSync"><span class="annot"><span class="annottext">addBlockSync :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockToAdd m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockSync"><span class="hs-identifier hs-var hs-var">addBlockSync</span></a></span></span><span> </span><span id="local-6989586621679901849"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621679901849"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679901850"><span id="local-6989586621679901851"><span id="local-6989586621679901852"><span id="local-6989586621679901853"><span id="local-6989586621679901854"><span id="local-6989586621679901855"><span id="local-6989586621679901856"><span id="local-6989586621679901857"><span id="local-6989586621679901858"><span id="local-6989586621679901859"><span id="local-6989586621679901860"><span id="local-6989586621679901861"><span id="local-6989586621679901862"><span id="local-6989586621679901863"><span id="local-6989586621679901864"><span id="local-6989586621679901865"><span id="local-6989586621679901866"><span id="local-6989586621679901867"><span id="local-6989586621679901868"><span id="local-6989586621679901869"><span id="local-6989586621679901870"><span id="local-6989586621679901871"><span id="local-6989586621679901872"><span id="local-6989586621679901873"><span class="annot"><span class="annottext">DiffTime
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictTVar m (m ())
StrictTVar m (FutureBlocks m blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m (TentativeState blk)
StrictTVar m (StrictMaybe (Header blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbImmutableDB :: ImmutableDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbLgrDB :: LgrDB m blk
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: StrictTVar m (TentativeState blk)
cdbTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbCopyLock :: StrictMVar m ()
cdbTracer :: Tracer m (TraceEvent blk)
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbRegistry :: ResourceRegistry m
cdbGcDelay :: DiffTime
cdbGcInterval :: DiffTime
cdbKillBgThreads :: StrictTVar m (m ())
cdbChunkInfo :: ChunkInfo
cdbCheckIntegrity :: blk -&gt; Bool
cdbCheckInFuture :: CheckInFuture m blk
cdbBlocksToAdd :: BlocksToAdd m blk
cdbFutureBlocks :: StrictTVar m (FutureBlocks m blk)
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (TentativeState blk)
cdbTentativeHeader :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbBlocksToAdd"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#BlockToAdd"><span class="hs-identifier hs-type">BlockToAdd</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">blockToAdd :: forall (m :: * -&gt; *) blk. BlockToAdd m blk -&gt; blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#blockToAdd"><span class="hs-identifier hs-var">blockToAdd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679901897"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679901898"><span id="local-6989586621679901899"><span id="local-6989586621679901900"><span class="annot"><span class="annottext">StrictTMVar m Bool
StrictTMVar m (AddBlockResult blk)
InvalidBlockPunishment m
blockPunish :: InvalidBlockPunishment m
varBlockWrittenToDisk :: StrictTMVar m Bool
varBlockProcessed :: StrictTMVar m (AddBlockResult blk)
blockPunish :: forall (m :: * -&gt; *) blk.
BlockToAdd m blk -&gt; InvalidBlockPunishment m
varBlockWrittenToDisk :: forall (m :: * -&gt; *) blk. BlockToAdd m blk -&gt; StrictTMVar m Bool
varBlockProcessed :: forall (m :: * -&gt; *) blk.
BlockToAdd m blk -&gt; StrictTMVar m (AddBlockResult blk)
</span><a href="#local-6989586621679901898"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679901904"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Bool
</span><a href="#local-6989586621679901904"><span class="hs-identifier hs-var">isMember</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679901905"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679901905"><span class="hs-identifier hs-var">invalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679901906"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901906"><span class="hs-identifier hs-var">curChain</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
   AnchoredFragment (Header blk))
-&gt; m (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
    AnchoredFragment (Header blk))
 -&gt; m (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
       AnchoredFragment (Header blk)))
-&gt; STM
     m
     (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
-&gt; m (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">((HeaderHash blk -&gt; Bool)
 -&gt; InvalidBlocks blk
 -&gt; AnchoredFragment (Header blk)
 -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
     AnchoredFragment (Header blk)))
-&gt; STM m (HeaderHash blk -&gt; Bool)
-&gt; STM
     m
     (InvalidBlocks blk
      -&gt; AnchoredFragment (Header blk)
      -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
          AnchoredFragment (Header blk)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk -&gt; STM m (HeaderHash blk -&gt; Bool)
forall (m :: * -&gt; *) blk.
Functor (STM m) =&gt;
VolatileDB m blk -&gt; STM m (HeaderHash blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getIsMember"><span class="hs-identifier hs-var">VolatileDB.getIsMember</span></a></span><span>          </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679901851"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>
</span><span id="line-272"></span><span>      </span><span class="annot"><span class="annottext">STM
  m
  (InvalidBlocks blk
   -&gt; AnchoredFragment (Header blk)
   -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
       AnchoredFragment (Header blk)))
-&gt; STM m (InvalidBlocks blk)
-&gt; STM
     m
     (AnchoredFragment (Header blk)
      -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
          AnchoredFragment (Header blk)))
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (InvalidBlocks blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679901859"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><span class="annottext">STM
  m
  (AnchoredFragment (Header blk)
   -&gt; (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
       AnchoredFragment (Header blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; STM
     m
     (HeaderHash blk -&gt; Bool, InvalidBlocks blk,
      AnchoredFragment (Header blk))
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk),
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getCurrentChain"><span class="hs-identifier hs-var">Query.getCurrentChain</span></a></span><span>           </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679901849"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679901909"><span class="annot"><span class="annottext">immBlockNo :: WithOrigin BlockNo
</span><a href="#local-6989586621679901909"><span class="hs-identifier hs-var hs-var">immBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block. AnchoredFragment block -&gt; WithOrigin BlockNo
</span><span class="hs-identifier hs-var">AF.anchorBlockNo</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679901906"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-comment">-- We follow the steps from section &quot;## Adding a block&quot; in ChainDB.md</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- Note: we call 'chainSelectionForFutureBlocks' in all branches instead</span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-comment">-- of once, before branching, because we want to do it /after/ writing the</span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-comment">-- block to the VolatileDB and delivering the 'varBlockWrittenToDisk'</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- promise, as this is the promise the BlockFetch client waits for.</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-comment">-- Otherwise, the BlockFetch client would have to wait for</span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-comment">-- 'chainSelectionForFutureBlocks'.</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>    </span><span class="hs-comment">-- ### Ignore</span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621679901911"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679901911"><span class="hs-identifier hs-var">newTip</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span>
</span><span id="line-288"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
forall blk.
HasHeader (Header blk) =&gt;
Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-var">olderThanK</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679901912"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679901913"><span class="hs-identifier hs-var">isEBB</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679901909"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679901914"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreBlockOlderThanK"><span class="hs-identifier hs-var">IgnoreBlockOlderThanK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621679901917"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679901849"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Bool
</span><a href="#local-6989586621679901904"><span class="hs-identifier hs-var">isMember</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; HeaderHash blk
forall b. HasHeader b =&gt; b -&gt; HeaderHash b
</span><span class="hs-identifier hs-var">blockHash</span></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679901914"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreBlockAlreadyInVolatileDB"><span class="hs-identifier hs-var">IgnoreBlockAlreadyInVolatileDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621679901917"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-296"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679901849"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-type">InvalidBlockInfo</span></a></span><span> </span><span id="local-6989586621679901922"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679901922"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Maybe (InvalidBlockInfo blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; HeaderHash blk
forall b. HasHeader b =&gt; b -&gt; HeaderHash b
</span><span class="hs-identifier hs-var">blockHash</span></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679901905"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679901914"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreInvalidBlock"><span class="hs-identifier hs-var">IgnoreInvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679901922"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-300"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621679901917"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span>        </span><span class="hs-comment">-- We wouldn't know the block is invalid if its prefix was invalid,</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-comment">-- hence 'InvalidBlockPunishment.BlockItself'.</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="annottext">InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
forall (m :: * -&gt; *).
InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#enact"><span class="hs-identifier hs-var">InvalidBlockPunishment.enact</span></a></span><span>
</span><span id="line-305"></span><span>          </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679901898"><span class="hs-identifier hs-var">blockPunish</span></a></span><span>
</span><span id="line-306"></span><span>          </span><span class="annot"><span class="annottext">Invalidity
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#BlockItself"><span class="hs-identifier hs-var">InvalidBlockPunishment.BlockItself</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679901849"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
forall blk. BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#empty"><span class="hs-identifier hs-var">BlockCache.empty</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>      </span><span class="hs-comment">-- The remaining cases</span><span>
</span><span id="line-311"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679901927"><span class="annot"><span class="annottext">traceEv :: Enclosing -&gt; TraceAddBlockEvent blk
</span><a href="#local-6989586621679901927"><span class="hs-identifier hs-var hs-var">traceEv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
-&gt; BlockNo -&gt; IsEBB -&gt; Enclosing -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk
-&gt; BlockNo -&gt; IsEBB -&gt; Enclosing -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#AddedBlockToVolatileDB"><span class="hs-identifier hs-var">AddedBlockToVolatileDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; BlockNo
forall b. HasHeader b =&gt; b -&gt; BlockNo
</span><span class="hs-identifier hs-var">blockNo</span></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679901913"><span class="hs-identifier hs-var">isEBB</span></a></span><span>
</span><span id="line-313"></span><span>        </span><span class="annot"><span class="annottext">Tracer m Enclosing -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Tracer m Enclosing -&gt; m a -&gt; m a
</span><a href="Ouroboros.Consensus.Util.Enclose.html#encloseWith"><span class="hs-identifier hs-var">encloseWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Enclosing -&gt; TraceAddBlockEvent blk
</span><a href="#local-6989586621679901927"><span class="hs-identifier hs-var">traceEv</span></a></span><span> </span><span class="annot"><span class="annottext">(Enclosing -&gt; TraceAddBlockEvent blk)
-&gt; Tracer m (TraceAddBlockEvent blk) -&gt; Tracer m Enclosing
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679901914"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-314"></span><span>          </span><span class="annot"><span class="annottext">VolatileDB m blk -&gt; HasCallStack =&gt; blk -&gt; m ()
forall (m :: * -&gt; *) blk.
VolatileDB m blk -&gt; HasCallStack =&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#putBlock"><span class="hs-identifier hs-var">VolatileDB.putBlock</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679901851"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-315"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m ()
</span><a href="#local-6989586621679901917"><span class="hs-identifier hs-var">deliverWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679901931"><span class="annot"><span class="annottext">blockCache :: BlockCache blk
</span><a href="#local-6989586621679901931"><span class="hs-identifier hs-var hs-var">blockCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; BlockCache blk
forall blk. HasHeader blk =&gt; blk -&gt; BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#singleton"><span class="hs-identifier hs-var">BlockCache.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-comment">-- Do chain selection for future blocks before chain selection for the</span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-comment">-- new block. When some future blocks are now older than the current</span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-comment">-- block, we will do chain selection in a more chronological order.</span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><span class="annottext">m (Point blk) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Point blk) -&gt; m ()) -&gt; m (Point blk) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679901849"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621679901931"><span class="hs-identifier hs-var">blockCache</span></a></span><span>
</span><span id="line-322"></span><span>        </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; BlockCache blk
-&gt; Header blk
-&gt; InvalidBlockPunishment m
-&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk
-&gt; BlockCache blk
-&gt; Header blk
-&gt; InvalidBlockPunishment m
-&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-var">chainSelectionForBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679901849"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621679901931"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679901912"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679901898"><span class="hs-identifier hs-var">blockPunish</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><span class="annottext">Point blk -&gt; m ()
</span><a href="#local-6989586621679901933"><span class="hs-identifier hs-var">deliverProcessed</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679901911"><span class="hs-identifier hs-var">newTip</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><a href="#local-6989586621679901914"><span class="hs-identifier hs-type">addBlockTracer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-type">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621679901914"><span class="annot"><span class="annottext">addBlockTracer :: Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679901914"><span class="hs-identifier hs-var hs-var">addBlockTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679901863"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="#local-6989586621679901912"><span class="hs-identifier hs-type">hdr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621679901912"><span class="annot"><span class="annottext">hdr :: Header blk
</span><a href="#local-6989586621679901912"><span class="hs-identifier hs-var hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; Header blk
forall blk. GetHeader blk =&gt; blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#getHeader"><span class="hs-identifier hs-var">getHeader</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679901897"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><a href="#local-6989586621679901913"><span class="hs-identifier hs-type">isEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621679901913"><span class="annot"><span class="annottext">isEBB :: IsEBB
</span><a href="#local-6989586621679901913"><span class="hs-identifier hs-var hs-var">isEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB
forall blk. GetHeader blk =&gt; Header blk -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerToIsEBB"><span class="hs-identifier hs-var">headerToIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679901912"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-comment">-- | Fill in the 'TMVar' for the 'varBlockWrittenToDisk' of the block's</span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-comment">-- 'AddBlockPromise' with the given 'Bool'.</span><span>
</span><span id="line-337"></span><span>    </span><span class="annot"><a href="#local-6989586621679901917"><span class="hs-identifier hs-type">deliverWrittenToDisk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621679901917"><span class="annot"><span class="annottext">deliverWrittenToDisk :: Bool -&gt; m ()
</span><a href="#local-6989586621679901917"><span class="hs-identifier hs-var hs-var">deliverWrittenToDisk</span></a></span></span><span> </span><span id="local-6989586621679901936"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679901936"><span class="hs-identifier hs-var">writtenToDisk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="annottext">StrictTMVar m Bool -&gt; Bool -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m Bool
</span><a href="#local-6989586621679901899"><span class="hs-identifier hs-var">varBlockWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679901936"><span class="hs-identifier hs-var">writtenToDisk</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-comment">-- | Fill in the 'TMVar' for the 'varBlockProcessed' of the block's</span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-comment">-- 'AddBlockPromise' with the given tip.</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><a href="#local-6989586621679901933"><span class="hs-identifier hs-type">deliverProcessed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679901101"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901100"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621679901933"><span class="annot"><span class="annottext">deliverProcessed :: Point blk -&gt; m ()
</span><a href="#local-6989586621679901933"><span class="hs-identifier hs-var hs-var">deliverProcessed</span></a></span></span><span> </span><span id="local-6989586621679901938"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679901938"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="annottext">StrictTMVar m (AddBlockResult blk)
-&gt; AddBlockResult blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTMVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTMVar m (AddBlockResult blk)
</span><a href="#local-6989586621679901900"><span class="hs-identifier hs-var">varBlockProcessed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; AddBlockResult blk
forall blk. Point blk -&gt; AddBlockResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#SuccesfullyAddedBlock"><span class="hs-identifier hs-var">SuccesfullyAddedBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679901938"><span class="hs-identifier hs-var">tip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span class="hs-comment">-- | Return 'True' when the given header should be ignored when adding it</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- because it is too old, i.e., we wouldn't be able to switch to a chain</span><span>
</span><span id="line-349"></span><span class="hs-comment">-- containing the corresponding block because its block number is more than</span><span>
</span><span id="line-350"></span><span class="hs-comment">-- @k@ blocks or exactly @k@ blocks back.</span><span>
</span><span id="line-351"></span><span class="hs-comment">--</span><span>
</span><span id="line-352"></span><span class="hs-comment">-- Special case: the header corresponds to an EBB which has the same block</span><span>
</span><span id="line-353"></span><span class="hs-comment">-- number as the block @k@ blocks back (the most recent \&quot;immutable\&quot; block).</span><span>
</span><span id="line-354"></span><span class="hs-comment">-- As EBBs share their block number with the block before them, the EBB is not</span><span>
</span><span id="line-355"></span><span class="hs-comment">-- too old in that case and can be adopted as part of our chain.</span><span>
</span><span id="line-356"></span><span class="hs-comment">--</span><span>
</span><span id="line-357"></span><span class="hs-comment">-- This special case can occur, for example, when the VolatileDB is empty</span><span>
</span><span id="line-358"></span><span class="hs-comment">-- (because of corruption). The \&quot;immutable\&quot; block is then also the tip of</span><span>
</span><span id="line-359"></span><span class="hs-comment">-- the chain. If we then try to add the EBB after it, it will have the same</span><span>
</span><span id="line-360"></span><span class="hs-comment">-- block number, so we must allow it.</span><span>
</span><span id="line-361"></span><span id="local-6989586621679901174"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-type">olderThanK</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-362"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901174"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901174"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-364"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Header of the block to add</span></span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-366"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Whether the block is an EBB or not</span></span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-368"></span><span>     </span><span class="hs-comment">-- ^ The block number of the most recent \&quot;immutable\&quot; block, i.e., the</span><span>
</span><span id="line-369"></span><span>     </span><span class="hs-comment">-- block @k@ blocks back.</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-371"></span><span id="olderThanK"><span class="annot"><span class="annottext">olderThanK :: forall blk.
HasHeader (Header blk) =&gt;
Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-var hs-var">olderThanK</span></a></span></span><span> </span><span id="local-6989586621679901952"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679901952"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621679901953"><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679901953"><span class="hs-identifier hs-var">isEBB</span></a></span></span><span> </span><span id="local-6989586621679901954"><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679901954"><span class="hs-identifier hs-var">immBlockNo</span></a></span></span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockNo -&gt; WithOrigin BlockNo
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679901956"><span class="hs-identifier hs-var">bNo</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo -&gt; WithOrigin BlockNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679901954"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679901953"><span class="hs-identifier hs-var">isEBB</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB -&gt; IsEBB -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-var">IsEBB</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockNo -&gt; WithOrigin BlockNo
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679901956"><span class="hs-identifier hs-var">bNo</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo -&gt; WithOrigin BlockNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679901954"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-378"></span><span>    </span><span id="local-6989586621679901956"><span class="annot"><span class="annottext">bNo :: BlockNo
</span><a href="#local-6989586621679901956"><span class="hs-identifier hs-var hs-var">bNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; BlockNo
forall b. HasHeader b =&gt; b -&gt; BlockNo
</span><span class="hs-identifier hs-var">blockNo</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679901952"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">-- | When we switch to a new selected chain, we are either extending the current</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- chain by adding blocks on top or we are switching to a fork.</span><span>
</span><span id="line-382"></span><span class="hs-keyword">data</span><span> </span><span id="ChainSwitchType"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSwitchType"><span class="hs-identifier hs-var">ChainSwitchType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AddingBlocks"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#AddingBlocks"><span class="hs-identifier hs-var">AddingBlocks</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="SwitchingToAFork"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#SwitchingToAFork"><span class="hs-identifier hs-var">SwitchingToAFork</span></a></span></span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679901962"><span id="local-6989586621679901964"><span id="local-6989586621679901968"><span class="annot"><span class="annottext">Int -&gt; ChainSwitchType -&gt; ShowS
[ChainSwitchType] -&gt; ShowS
ChainSwitchType -&gt; [Char]
(Int -&gt; ChainSwitchType -&gt; ShowS)
-&gt; (ChainSwitchType -&gt; [Char])
-&gt; ([ChainSwitchType] -&gt; ShowS)
-&gt; Show ChainSwitchType
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ChainSwitchType -&gt; ShowS
showsPrec :: Int -&gt; ChainSwitchType -&gt; ShowS
$cshow :: ChainSwitchType -&gt; [Char]
show :: ChainSwitchType -&gt; [Char]
$cshowList :: [ChainSwitchType] -&gt; ShowS
showList :: [ChainSwitchType] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679901972"><span id="local-6989586621679901974"><span class="annot"><span class="annottext">ChainSwitchType -&gt; ChainSwitchType -&gt; Bool
(ChainSwitchType -&gt; ChainSwitchType -&gt; Bool)
-&gt; (ChainSwitchType -&gt; ChainSwitchType -&gt; Bool)
-&gt; Eq ChainSwitchType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: ChainSwitchType -&gt; ChainSwitchType -&gt; Bool
== :: ChainSwitchType -&gt; ChainSwitchType -&gt; Bool
$c/= :: ChainSwitchType -&gt; ChainSwitchType -&gt; Bool
/= :: ChainSwitchType -&gt; ChainSwitchType -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="annot"><span class="hs-comment">-- | Return the new tip.</span></span><span>
</span><span id="line-386"></span><span id="local-6989586621679901179"><span id="local-6989586621679901180"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-type">chainSelectionForFutureBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-387"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901179"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-388"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901180"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-389"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901180"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-390"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901180"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-391"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-392"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901179"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901180"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier hs-type">BlockCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901180"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901179"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679901180"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-394"></span><span id="chainSelectionForFutureBlocks"><span class="annot"><span class="annottext">chainSelectionForFutureBlocks :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; BlockCache blk -&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForFutureBlocks"><span class="hs-identifier hs-var hs-var">chainSelectionForFutureBlocks</span></a></span></span><span> </span><span id="local-6989586621679902023"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621679902023"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621679902024"><span id="local-6989586621679902025"><span id="local-6989586621679902026"><span id="local-6989586621679902027"><span id="local-6989586621679902028"><span id="local-6989586621679902029"><span id="local-6989586621679902030"><span id="local-6989586621679902031"><span id="local-6989586621679902032"><span id="local-6989586621679902033"><span id="local-6989586621679902034"><span id="local-6989586621679902035"><span id="local-6989586621679902036"><span id="local-6989586621679902037"><span id="local-6989586621679902038"><span id="local-6989586621679902039"><span id="local-6989586621679902040"><span id="local-6989586621679902041"><span id="local-6989586621679902042"><span id="local-6989586621679902043"><span id="local-6989586621679902044"><span id="local-6989586621679902045"><span id="local-6989586621679902046"><span id="local-6989586621679902047"><span class="annot"><span class="annottext">DiffTime
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictTVar m (m ())
StrictTVar m (FutureBlocks m blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m (TentativeState blk)
StrictTVar m (StrictMaybe (Header blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (TentativeState blk)
cdbTentativeHeader :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks m blk)
cdbImmutableDB :: ImmutableDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbLgrDB :: LgrDB m blk
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: StrictTVar m (TentativeState blk)
cdbTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbCopyLock :: StrictMVar m ()
cdbTracer :: Tracer m (TraceEvent blk)
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbRegistry :: ResourceRegistry m
cdbGcDelay :: DiffTime
cdbGcInterval :: DiffTime
cdbKillBgThreads :: StrictTVar m (m ())
cdbChunkInfo :: ChunkInfo
cdbCheckIntegrity :: blk -&gt; Bool
cdbCheckInFuture :: CheckInFuture m blk
cdbBlocksToAdd :: BlocksToAdd m blk
cdbFutureBlocks :: StrictTVar m (FutureBlocks m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbBlocksToAdd"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679902048"><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621679902048"><span class="hs-identifier hs-var">blockCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-comment">-- Get 'cdbFutureBlocks' and empty the map in the TVar. It will be</span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-comment">-- repopulated with the blocks that are still from the future (but not the</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-comment">-- ones no longer from the future) during chain selection for those</span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-comment">-- blocks.</span><span>
</span><span id="line-399"></span><span>    </span><span id="local-6989586621679902049"><span class="annot"><span class="annottext">[(Header blk, InvalidBlockPunishment m)]
</span><a href="#local-6989586621679902049"><span class="hs-identifier hs-var">futureBlockHeaders</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m [(Header blk, InvalidBlockPunishment m)]
-&gt; m [(Header blk, InvalidBlockPunishment m)]
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m [(Header blk, InvalidBlockPunishment m)]
 -&gt; m [(Header blk, InvalidBlockPunishment m)])
-&gt; STM m [(Header blk, InvalidBlockPunishment m)]
-&gt; m [(Header blk, InvalidBlockPunishment m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>      </span><span id="local-6989586621679902050"><span class="annot"><span class="annottext">FutureBlocks m blk
</span><a href="#local-6989586621679902050"><span class="hs-identifier hs-var">futureBlocks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk) -&gt; STM m (FutureBlocks m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk)
</span><a href="#local-6989586621679902047"><span class="hs-identifier hs-var">cdbFutureBlocks</span></a></span><span>
</span><span id="line-401"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk) -&gt; FutureBlocks m blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk)
</span><a href="#local-6989586621679902047"><span class="hs-identifier hs-var">cdbFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks m blk
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-402"></span><span>      </span><span class="annot"><span class="annottext">[(Header blk, InvalidBlockPunishment m)]
-&gt; STM m [(Header blk, InvalidBlockPunishment m)]
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([(Header blk, InvalidBlockPunishment m)]
 -&gt; STM m [(Header blk, InvalidBlockPunishment m)])
-&gt; [(Header blk, InvalidBlockPunishment m)]
-&gt; STM m [(Header blk, InvalidBlockPunishment m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks m blk -&gt; [(Header blk, InvalidBlockPunishment m)]
forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">FutureBlocks m blk
</span><a href="#local-6989586621679902050"><span class="hs-identifier hs-var">futureBlocks</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><span class="annottext">[(Header blk, InvalidBlockPunishment m)]
-&gt; ((Header blk, InvalidBlockPunishment m) -&gt; m (Point blk))
-&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[(Header blk, InvalidBlockPunishment m)]
</span><a href="#local-6989586621679902049"><span class="hs-identifier hs-var">futureBlockHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">(((Header blk, InvalidBlockPunishment m) -&gt; m (Point blk)) -&gt; m ())
-&gt; ((Header blk, InvalidBlockPunishment m) -&gt; m (Point blk))
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679902053"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902053"><span class="hs-identifier hs-var">hdr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902054"><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679902054"><span class="hs-identifier hs-var">punish</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902055"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainSelectionForFutureBlock"><span class="hs-identifier hs-var">ChainSelectionForFutureBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk.
(HasHeader blk, HasHeader (Header blk)) =&gt;
Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902053"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; BlockCache blk
-&gt; Header blk
-&gt; InvalidBlockPunishment m
-&gt; m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk
-&gt; BlockCache blk
-&gt; Header blk
-&gt; InvalidBlockPunishment m
-&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-var">chainSelectionForBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679902023"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621679902048"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902053"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679902054"><span class="hs-identifier hs-var">punish</span></a></span><span>
</span><span id="line-406"></span><span>    </span><span class="annot"><span class="annottext">STM m (Point blk) -&gt; m (Point blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Point blk) -&gt; m (Point blk))
-&gt; STM m (Point blk) -&gt; m (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getTipPoint"><span class="hs-identifier hs-var">Query.getTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679902023"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-408"></span><span>    </span><span id="local-6989586621679902055"><span class="annot"><span class="annottext">tracer :: Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902055"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679902037"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="hs-comment">-- | Trigger chain selection for the given block.</span><span>
</span><span id="line-411"></span><span class="hs-comment">--</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- PRECONDITION: the block is in the VolatileDB.</span><span>
</span><span id="line-413"></span><span class="hs-comment">--</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- PRECONDITION: the slot of the block &lt;= the current (wall) slot</span><span>
</span><span id="line-415"></span><span class="hs-comment">--</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- The new tip of the current chain is returned.</span><span>
</span><span id="line-417"></span><span class="hs-comment">--</span><span>
</span><span id="line-418"></span><span class="hs-comment">-- = Constructing candidate fragments</span><span>
</span><span id="line-419"></span><span class="hs-comment">--</span><span>
</span><span id="line-420"></span><span class="hs-comment">-- The VolatileDB keeps a \&quot;successors\&quot; map in memory, telling us the hashes</span><span>
</span><span id="line-421"></span><span class="hs-comment">-- of the known successors of any block, but it does not keep /headers/ in</span><span>
</span><span id="line-422"></span><span class="hs-comment">-- memory, which are needed to construct candidate fargments. We try to reuse</span><span>
</span><span id="line-423"></span><span class="hs-comment">-- the headers from the current chain fragment where possible, but it will not</span><span>
</span><span id="line-424"></span><span class="hs-comment">-- contain all needed headers. This means that we will need to read some</span><span>
</span><span id="line-425"></span><span class="hs-comment">-- blocks from disk and extract their headers. Under normal circumstances this</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- does not matter too much; although this will be done every time we add a</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- block, the expected number of headers to read from disk is very small:</span><span>
</span><span id="line-428"></span><span class="hs-comment">--</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- * None if we stay on the current chain and this is just the next block</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- * A handful if we stay on the current chain and the block we just received</span><span>
</span><span id="line-431"></span><span class="hs-comment">--   was a missing block and we already received some of its successors</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- * A handful if we switch to a short fork</span><span>
</span><span id="line-433"></span><span class="hs-comment">--</span><span>
</span><span id="line-434"></span><span class="hs-comment">-- This is expensive only</span><span>
</span><span id="line-435"></span><span class="hs-comment">--</span><span>
</span><span id="line-436"></span><span class="hs-comment">-- * on startup: in this case we need to read at least @k@ blocks from the</span><span>
</span><span id="line-437"></span><span class="hs-comment">--   VolatileDB, and possibly more if there are some other chains in the</span><span>
</span><span id="line-438"></span><span class="hs-comment">--   VolatileDB starting from the tip of the ImmutableDB</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- * when we switch to a distant fork</span><span>
</span><span id="line-440"></span><span class="hs-comment">--</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- This cost is currently deemed acceptable.</span><span>
</span><span id="line-442"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-type">chainSelectionForBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-443"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679901197"><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679901198"><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-444"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-445"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-446"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-447"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-448"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-449"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-451"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier hs-type">BlockCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-452"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier hs-type">InvalidBlockPunishment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span id="chainSelectionForBlock"><span class="annot"><span class="annottext">chainSelectionForBlock :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk
-&gt; BlockCache blk
-&gt; Header blk
-&gt; InvalidBlockPunishment m
-&gt; m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelectionForBlock"><span class="hs-identifier hs-var hs-var">chainSelectionForBlock</span></a></span></span><span> </span><span id="local-6989586621679902190"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621679902190"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621679902191"><span id="local-6989586621679902192"><span id="local-6989586621679902193"><span id="local-6989586621679902194"><span id="local-6989586621679902195"><span id="local-6989586621679902196"><span id="local-6989586621679902197"><span id="local-6989586621679902198"><span id="local-6989586621679902199"><span id="local-6989586621679902200"><span id="local-6989586621679902201"><span id="local-6989586621679902202"><span id="local-6989586621679902203"><span id="local-6989586621679902204"><span id="local-6989586621679902205"><span id="local-6989586621679902206"><span id="local-6989586621679902207"><span id="local-6989586621679902208"><span id="local-6989586621679902209"><span id="local-6989586621679902210"><span id="local-6989586621679902211"><span id="local-6989586621679902212"><span id="local-6989586621679902213"><span id="local-6989586621679902214"><span class="annot"><span class="annottext">DiffTime
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictTVar m (m ())
StrictTVar m (FutureBlocks m blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m (TentativeState blk)
StrictTVar m (StrictMaybe (Header blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (TentativeState blk)
cdbTentativeHeader :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks m blk)
cdbImmutableDB :: ImmutableDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbLgrDB :: LgrDB m blk
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: StrictTVar m (TentativeState blk)
cdbTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbCopyLock :: StrictMVar m ()
cdbTracer :: Tracer m (TraceEvent blk)
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbRegistry :: ResourceRegistry m
cdbGcDelay :: DiffTime
cdbGcInterval :: DiffTime
cdbKillBgThreads :: StrictTVar m (m ())
cdbChunkInfo :: ChunkInfo
cdbCheckIntegrity :: blk -&gt; Bool
cdbCheckInFuture :: CheckInFuture m blk
cdbBlocksToAdd :: BlocksToAdd m blk
cdbFutureBlocks :: StrictTVar m (FutureBlocks m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbBlocksToAdd"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679902215"><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621679902215"><span class="hs-identifier hs-var">blockCache</span></a></span></span><span> </span><span id="local-6989586621679902216"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621679902217"><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679902217"><span class="hs-identifier hs-var">punish</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679902218"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679902218"><span class="hs-identifier hs-var">invalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902219"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902219"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902220"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902220"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902221"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902221"><span class="hs-identifier hs-var">curChain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902222"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902222"><span class="hs-identifier hs-var">tipPoint</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902223"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902223"><span class="hs-identifier hs-var">ledgerDB</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
   HeaderHash blk -&gt; Maybe (BlockInfo blk),
   AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
-&gt; m (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
    HeaderHash blk -&gt; Maybe (BlockInfo blk),
    AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
 -&gt; m (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM
     m
     (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
-&gt; m (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-458"></span><span>          </span><span class="annot"><span class="annottext">(InvalidBlocks blk
 -&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
 -&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
 -&gt; AnchoredFragment (Header blk)
 -&gt; Point blk
 -&gt; LedgerDB' blk
 -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
     HeaderHash blk -&gt; Maybe (BlockInfo blk),
     AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (InvalidBlocks blk)
-&gt; STM
     m
     ((ChainHash blk -&gt; Set (HeaderHash blk))
      -&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
      -&gt; AnchoredFragment (Header blk)
      -&gt; Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (InvalidBlocks blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679902200"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  ((ChainHash blk -&gt; Set (HeaderHash blk))
   -&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
   -&gt; AnchoredFragment (Header blk)
   -&gt; Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; STM
     m
     ((HeaderHash blk -&gt; Maybe (BlockInfo blk))
      -&gt; AnchoredFragment (Header blk)
      -&gt; Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (m :: * -&gt; *) blk.
VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#filterByPredecessor"><span class="hs-identifier hs-var">VolatileDB.filterByPredecessor</span></a></span><span>  </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679902192"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  ((HeaderHash blk -&gt; Maybe (BlockInfo blk))
   -&gt; AnchoredFragment (Header blk)
   -&gt; Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; STM
     m
     (AnchoredFragment (Header blk)
      -&gt; Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
forall (m :: * -&gt; *) blk.
VolatileDB m blk
-&gt; HasCallStack =&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getBlockInfo"><span class="hs-identifier hs-var">VolatileDB.getBlockInfo</span></a></span><span>         </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679902192"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>
</span><span id="line-461"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  (AnchoredFragment (Header blk)
   -&gt; Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; STM
     m
     (Point blk
      -&gt; LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk),
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getCurrentChain"><span class="hs-identifier hs-var">Query.getCurrentChain</span></a></span><span>           </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679902190"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-462"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  (Point blk
   -&gt; LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (Point blk)
-&gt; STM
     m
     (LedgerDB' blk
      -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
          HeaderHash blk -&gt; Maybe (BlockInfo blk),
          AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getTipPoint"><span class="hs-identifier hs-var">Query.getTipPoint</span></a></span><span>               </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679902190"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-463"></span><span>          </span><span class="annot"><span class="annottext">STM
  m
  (LedgerDB' blk
   -&gt; (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
       HeaderHash blk -&gt; Maybe (BlockInfo blk),
       AnchoredFragment (Header blk), Point blk, LedgerDB' blk))
-&gt; STM m (LedgerDB' blk)
-&gt; STM
     m
     (InvalidBlocks blk, ChainHash blk -&gt; Set (HeaderHash blk),
      HeaderHash blk -&gt; Maybe (BlockInfo blk),
      AnchoredFragment (Header blk), Point blk, LedgerDB' blk)
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#getCurrent"><span class="hs-identifier hs-var">LgrDB.getCurrent</span></a></span><span>                </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679902193"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679902225"><span class="hs-identifier hs-type">curChainAndLedger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-465"></span><span>        </span><span id="local-6989586621679902225"><span class="annot"><span class="annottext">curChainAndLedger :: ChainAndLedger blk
</span><a href="#local-6989586621679902225"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-466"></span><span>          </span><span class="hs-comment">-- The current chain we're working with here is not longer than @k@</span><span>
</span><span id="line-467"></span><span>          </span><span class="hs-comment">-- blocks (see 'getCurrentChain' and 'cdbChain'), which is easier to</span><span>
</span><span id="line-468"></span><span>          </span><span class="hs-comment">-- reason about when doing chain selection, etc.</span><span>
</span><span id="line-469"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; ChainAndLedger blk -&gt; ChainAndLedger blk
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><span class="hs-identifier hs-var">AF.length</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902221"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679902227"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChainAndLedger blk -&gt; ChainAndLedger blk)
-&gt; ChainAndLedger blk -&gt; ChainAndLedger blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-470"></span><span>          </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; LedgerDB' blk -&gt; ChainAndLedger blk
forall l b.
(GetTip l, HasHeader b, HeaderHash b ~ HeaderHash l,
 HasCallStack) =&gt;
AnchoredFragment b -&gt; l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-var">VF.ValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902221"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902223"><span class="hs-identifier hs-var">ledgerDB</span></a></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><a href="#local-6989586621679902228"><span class="hs-identifier hs-type">immBlockNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-473"></span><span>        </span><span id="local-6989586621679902228"><span class="annot"><span class="annottext">immBlockNo :: WithOrigin BlockNo
</span><a href="#local-6989586621679902228"><span class="hs-identifier hs-var hs-var">immBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block. AnchoredFragment block -&gt; WithOrigin BlockNo
</span><span class="hs-identifier hs-var">AF.anchorBlockNo</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902221"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>        </span><span class="hs-comment">-- Let these two functions ignore invalid blocks</span><span>
</span><span id="line-476"></span><span>        </span><span id="local-6989586621679902229"><span class="annot"><span class="annottext">lookupBlockInfo' :: HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902229"><span class="hs-identifier hs-var hs-var">lookupBlockInfo'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; InvalidBlocks blk
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; HeaderHash blk
-&gt; Maybe (BlockInfo blk)
forall blk (proxy :: * -&gt; *) a.
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (HeaderHash blk -&gt; Maybe a)
-&gt; HeaderHash blk
-&gt; Maybe a
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalid"><span class="hs-identifier hs-var">ignoreInvalid</span></a></span><span>    </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679902190"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679902218"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902220"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span><span>
</span><span id="line-477"></span><span>        </span><span id="local-6989586621679902231"><span class="annot"><span class="annottext">succsOf' :: ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902231"><span class="hs-identifier hs-var hs-var">succsOf'</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
forall blk (proxy :: * -&gt; *).
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-var">ignoreInvalidSuc</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679902190"><span class="hs-identifier hs-var">cdb</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679902218"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902219"><span class="hs-identifier hs-var">succsOf</span></a></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-comment">-- The preconditions</span><span>
</span><span id="line-480"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (BlockInfo blk) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (BlockInfo blk) -&gt; Bool) -&gt; Maybe (BlockInfo blk) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902220"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-keyword">if</span><span>
</span><span id="line-483"></span><span>      </span><span class="hs-comment">-- The chain might have grown since we added the block such that the</span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-comment">-- block is older than @k@.</span><span>
</span><span id="line-485"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
forall blk.
HasHeader (Header blk) =&gt;
Header blk -&gt; IsEBB -&gt; WithOrigin BlockNo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#olderThanK"><span class="hs-identifier hs-var">olderThanK</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679902233"><span class="hs-identifier hs-var">isEBB</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679902228"><span class="hs-identifier hs-var">immBlockNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-486"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreBlockOlderThanK"><span class="hs-identifier hs-var">IgnoreBlockOlderThanK</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-487"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902222"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span>      </span><span class="hs-comment">-- We might have validated the block in the meantime</span><span>
</span><span id="line-490"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-type">InvalidBlockInfo</span></a></span><span> </span><span id="local-6989586621679902236"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679902236"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Maybe (InvalidBlockInfo blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679902218"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-491"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk -&gt; InvalidBlockReason blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IgnoreInvalidBlock"><span class="hs-identifier hs-var">IgnoreInvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679902236"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>        </span><span class="hs-comment">-- We wouldn't know the block is invalid if its prefix was invalid,</span><span>
</span><span id="line-494"></span><span>        </span><span class="hs-comment">-- hence 'InvalidBlockPunishment.BlockItself'.</span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><span class="annottext">InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
forall (m :: * -&gt; *).
InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#enact"><span class="hs-identifier hs-var">InvalidBlockPunishment.enact</span></a></span><span>
</span><span id="line-496"></span><span>          </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679902217"><span class="hs-identifier hs-var">punish</span></a></span><span>
</span><span id="line-497"></span><span>          </span><span class="annot"><span class="annottext">Invalidity
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#BlockItself"><span class="hs-identifier hs-var">InvalidBlockPunishment.BlockItself</span></a></span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902222"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>      </span><span class="hs-comment">-- The block @b@ fits onto the end of our current chain</span><span>
</span><span id="line-502"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; ChainHash blk
forall {k} (block :: k). Point block -&gt; ChainHash block
</span><span class="hs-identifier hs-var">pointHash</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902222"><span class="hs-identifier hs-var">tipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; ChainHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; ChainHash blk
forall blk. GetPrevHash blk =&gt; Header blk -&gt; ChainHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPrevHash"><span class="hs-identifier hs-var">headerPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-503"></span><span>        </span><span class="hs-comment">-- ### Add to current chain</span><span>
</span><span id="line-504"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TryAddToCurrentChain"><span class="hs-identifier hs-var">TryAddToCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainAndLedger blk -&gt; m (Point blk)
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainAndLedger blk -&gt; m (Point blk)
</span><a href="#local-6989586621679902240"><span class="hs-identifier hs-var">addToCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902231"><span class="hs-identifier hs-var">succsOf'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902225"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902241"><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621679902241"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; AnchoredFragment (Header blk)
-&gt; RealPoint blk
-&gt; Maybe (ChainDiff (HeaderFields blk))
forall blk.
(HasHeader blk, GetHeader blk) =&gt;
LookupBlockInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; RealPoint blk
-&gt; Maybe (ChainDiff (HeaderFields blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#isReachable"><span class="hs-identifier hs-var">Paths.isReachable</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902229"><span class="hs-identifier hs-var">lookupBlockInfo'</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902221"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-508"></span><span>        </span><span class="hs-comment">-- ### Switch to a fork</span><span>
</span><span id="line-509"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
-&gt; ChainDiff (HeaderFields blk) -&gt; TraceAddBlockEvent blk
forall blk.
RealPoint blk
-&gt; ChainDiff (HeaderFields blk) -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TrySwitchToAFork"><span class="hs-identifier hs-var">TrySwitchToAFork</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621679902241"><span class="hs-identifier hs-var">diff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainAndLedger blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; m (Point blk)
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainAndLedger blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; m (Point blk)
</span><a href="#local-6989586621679902244"><span class="hs-identifier hs-var">switchToAFork</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902231"><span class="hs-identifier hs-var">succsOf'</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902229"><span class="hs-identifier hs-var">lookupBlockInfo'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902225"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621679902241"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-513"></span><span>        </span><span class="hs-comment">-- ### Store but don't change the current chain</span><span>
</span><span id="line-514"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; TraceAddBlockEvent blk
forall blk. RealPoint blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#StoreButDontChange"><span class="hs-identifier hs-var">StoreButDontChange</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902222"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span>    </span><span class="hs-comment">-- Note that we may have extended the chain, but have not trimmed it to</span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-comment">-- @k@ blocks/headers. That is the job of the background thread, which</span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-comment">-- will first copy the blocks/headers to trim (from the end of the</span><span>
</span><span id="line-520"></span><span>    </span><span class="hs-comment">-- fragment) from the VolatileDB to the ImmutableDB.</span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-522"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621679902227"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679902227"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; SecurityParam
forall blk.
ConsensusProtocol (BlockProtocol blk) =&gt;
TopLevelConfig blk -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Config.html#configSecurityParam"><span class="hs-identifier hs-var">configSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679902199"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-523"></span><span>
</span><span id="line-524"></span><span>    </span><span class="annot"><a href="#local-6989586621679902235"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span id="local-6989586621679902235"><span class="annot"><span class="annottext">p :: RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk.
(HasHeader blk, HasHeader (Header blk)) =&gt;
Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span>    </span><span class="annot"><a href="#local-6989586621679902233"><span class="hs-identifier hs-type">isEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-528"></span><span>    </span><span id="local-6989586621679902233"><span class="annot"><span class="annottext">isEBB :: IsEBB
</span><a href="#local-6989586621679902233"><span class="hs-identifier hs-var hs-var">isEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; IsEBB
forall blk. GetHeader blk =&gt; Header blk -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerToIsEBB"><span class="hs-identifier hs-var">headerToIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span>    </span><span class="annot"><a href="#local-6989586621679902234"><span class="hs-identifier hs-type">addBlockTracer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-type">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>    </span><span id="local-6989586621679902234"><span class="annot"><span class="annottext">addBlockTracer :: Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var hs-var">addBlockTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceAddBlockEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679902204"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>    </span><span class="annot"><a href="#local-6989586621679902248"><span class="hs-identifier hs-type">mkChainSelEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-534"></span><span>    </span><span id="local-6989586621679902248"><span class="annot"><span class="annottext">mkChainSelEnv :: ChainAndLedger blk -&gt; ChainSelEnv m blk
</span><a href="#local-6989586621679902248"><span class="hs-identifier hs-var hs-var">mkChainSelEnv</span></a></span></span><span> </span><span id="local-6989586621679902249"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902249"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span>
</span><span id="line-535"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lgrDB :: LgrDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#lgrDB"><span class="hs-identifier hs-var">lgrDB</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679902193"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">bcfg :: BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var">bcfg</span></a></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configBlock"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679902199"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-537"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varInvalid"><span class="hs-identifier hs-var">varInvalid</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679902200"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span>
</span><span id="line-538"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varFutureBlocks :: StrictTVar m (FutureBlocks m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varFutureBlocks"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk)
</span><a href="#local-6989586621679902214"><span class="hs-identifier hs-var">cdbFutureBlocks</span></a></span><span>
</span><span id="line-539"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varTentativeState :: StrictTVar m (TentativeState blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varTentativeState"><span class="hs-identifier hs-var">varTentativeState</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk)
</span><a href="#local-6989586621679902195"><span class="hs-identifier hs-var">cdbTentativeState</span></a></span><span>
</span><span id="line-540"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varTentativeHeader"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679902196"><span class="hs-identifier hs-var">cdbTentativeHeader</span></a></span><span>
</span><span id="line-541"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getTentativeFollowers :: STM m [FollowerHandle m blk]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getTentativeFollowers"><span class="hs-identifier hs-var">getTentativeFollowers</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-542"></span><span>              </span><span class="annot"><span class="annottext">(FollowerHandle m blk -&gt; Bool)
-&gt; [FollowerHandle m blk] -&gt; [FollowerHandle m blk]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#TentativeChain"><span class="hs-identifier hs-var">TentativeChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainType -&gt; ChainType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChainType -&gt; Bool)
-&gt; (FollowerHandle m blk -&gt; ChainType)
-&gt; FollowerHandle m blk
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FollowerHandle m blk -&gt; ChainType
forall (m :: * -&gt; *) blk. FollowerHandle m blk -&gt; ChainType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#fhChainType"><span class="hs-identifier hs-var">fhChainType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([FollowerHandle m blk] -&gt; [FollowerHandle m blk])
-&gt; (Map FollowerKey (FollowerHandle m blk)
    -&gt; [FollowerHandle m blk])
-&gt; Map FollowerKey (FollowerHandle m blk)
-&gt; [FollowerHandle m blk]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map FollowerKey (FollowerHandle m blk) -&gt; [FollowerHandle m blk]
forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">Map.elems</span></a></span><span>
</span><span id="line-543"></span><span>          </span><span class="annot"><span class="annottext">(Map FollowerKey (FollowerHandle m blk) -&gt; [FollowerHandle m blk])
-&gt; STM m (Map FollowerKey (FollowerHandle m blk))
-&gt; STM m [FollowerHandle m blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
-&gt; STM m (Map FollowerKey (FollowerHandle m blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
</span><a href="#local-6989586621679902198"><span class="hs-identifier hs-var">cdbFollowers</span></a></span><span>
</span><span id="line-544"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">futureCheck :: CheckInFuture m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheck"><span class="hs-identifier hs-var">futureCheck</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CheckInFuture m blk
</span><a href="#local-6989586621679902212"><span class="hs-identifier hs-var">cdbCheckInFuture</span></a></span><span>
</span><span id="line-545"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockCache :: BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#blockCache"><span class="hs-identifier hs-var">blockCache</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621679902215"><span class="hs-identifier hs-var">blockCache</span></a></span><span>
</span><span id="line-546"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">curChainAndLedger :: ChainAndLedger blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#curChainAndLedger"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902249"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-547"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">validationTracer :: Tracer m (TraceValidationEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validationTracer"><span class="hs-identifier hs-var">validationTracer</span></a></span><span>      </span><span class="hs-glyph">=</span><span>
</span><span id="line-548"></span><span>          </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; (TraceValidationEvent blk -&gt; TraceAddBlockEvent blk)
-&gt; TraceValidationEvent blk
-&gt; TraceEvent blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TraceValidationEvent blk -&gt; TraceAddBlockEvent blk
forall blk. TraceValidationEvent blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#AddBlockValidation"><span class="hs-identifier hs-var">AddBlockValidation</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceValidationEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679902204"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span>
</span><span id="line-549"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pipeliningTracer :: Tracer m (TracePipeliningEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#pipeliningTracer"><span class="hs-identifier hs-var">pipeliningTracer</span></a></span><span>       </span><span class="hs-glyph">=</span><span>
</span><span id="line-550"></span><span>          </span><span class="annot"><span class="annottext">TraceAddBlockEvent blk -&gt; TraceEvent blk
forall blk. TraceAddBlockEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier hs-var">TraceAddBlockEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; TraceEvent blk)
-&gt; (TracePipeliningEvent blk -&gt; TraceAddBlockEvent blk)
-&gt; TracePipeliningEvent blk
-&gt; TraceEvent blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TracePipeliningEvent blk -&gt; TraceAddBlockEvent blk
forall blk. TracePipeliningEvent blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#PipeliningEvent"><span class="hs-identifier hs-var">PipeliningEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TracePipeliningEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TracePipeliningEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679902204"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span>
</span><span id="line-551"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">punish :: Maybe (RealPoint blk, InvalidBlockPunishment m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#punish"><span class="hs-identifier hs-var">punish</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RealPoint blk, InvalidBlockPunishment m)
-&gt; Maybe (RealPoint blk, InvalidBlockPunishment m)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679902217"><span class="hs-identifier hs-var">punish</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-552"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-comment">-- | PRECONDITION: the header @hdr@ (and block @b@) fit onto the end of</span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-comment">-- the current chain.</span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><a href="#local-6989586621679902240"><span class="hs-identifier hs-type">addToCurrentChain</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-557"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-558"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-560"></span><span>         </span><span class="hs-comment">-- ^ The current chain and ledger</span><span>
</span><span id="line-561"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>    </span><span id="local-6989586621679902240"><span class="annot"><span class="annottext">addToCurrentChain :: HasCallStack =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainAndLedger blk -&gt; m (Point blk)
</span><a href="#local-6989586621679902240"><span class="hs-identifier hs-var hs-var">addToCurrentChain</span></a></span></span><span> </span><span id="local-6989586621679902286"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902286"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span id="local-6989586621679902287"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902287"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-563"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902288"><span class="annot"><span class="annottext">suffixesAfterB :: [NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621679902288"><span class="hs-identifier hs-var hs-var">suffixesAfterB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
forall blk.
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; Point blk -&gt; [NonEmpty (HeaderHash blk)]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#maximalCandidates"><span class="hs-identifier hs-var">Paths.maximalCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902286"><span class="hs-identifier hs-var">succsOf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; Point blk
forall blk. RealPoint blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointToPoint"><span class="hs-identifier hs-var">realPointToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span>        </span><span class="hs-comment">-- Fragments that are anchored at @curHead@, i.e. suffixes of the</span><span>
</span><span id="line-566"></span><span>        </span><span class="hs-comment">-- current chain.</span><span>
</span><span id="line-567"></span><span>        </span><span id="local-6989586621679902290"><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679902290"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[NonEmpty (HeaderHash blk)]
-&gt; Maybe (NonEmpty (NonEmpty (HeaderHash blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[NonEmpty (HeaderHash blk)]
</span><a href="#local-6989586621679902288"><span class="hs-identifier hs-var">suffixesAfterB</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-568"></span><span>          </span><span class="hs-comment">-- If there are no suffixes after @b@, just use the suffix just</span><span>
</span><span id="line-569"></span><span>          </span><span class="hs-comment">-- containing @b@ as the sole candidate.</span><span>
</span><span id="line-570"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (NonEmpty (HeaderHash blk)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>              </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-571"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (AnchoredFragment (Header blk))
 -&gt; m (NonEmpty (AnchoredFragment (Header blk))))
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor (Header blk)
-&gt; [Header blk] -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; [b] -&gt; AnchoredSeq v a b
</span><span class="hs-identifier hs-var">AF.fromOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
</span><a href="#local-6989586621679902291"><span class="hs-identifier hs-var">curHead</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; [AnchoredFragment (Header blk)]
-&gt; NonEmpty (AnchoredFragment (Header blk))
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">NE.:|</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-572"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902293"><span class="annot"><span class="annottext">NonEmpty (NonEmpty (HeaderHash blk))
</span><a href="#local-6989586621679902293"><span class="hs-identifier hs-var">suffixesAfterB'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-573"></span><span>            </span><span class="hs-comment">-- We can start with an empty cache, because we're only looking</span><span>
</span><span id="line-574"></span><span>            </span><span class="hs-comment">-- up the headers /after/ b, so they won't be on the current</span><span>
</span><span id="line-575"></span><span>            </span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-576"></span><span>            </span><span class="annot"><span class="annottext">(StateT
   (Map (HeaderHash blk) (Header blk))
   m
   (NonEmpty (AnchoredFragment (Header blk)))
 -&gt; Map (HeaderHash blk) (Header blk)
 -&gt; m (NonEmpty (AnchoredFragment (Header blk))))
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (NonEmpty (AnchoredFragment (Header blk)))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">StateT
  (Map (HeaderHash blk) (Header blk))
  m
  (NonEmpty (AnchoredFragment (Header blk)))
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#evalStateT"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk)
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT
   (Map (HeaderHash blk) (Header blk))
   m
   (NonEmpty (AnchoredFragment (Header blk)))
 -&gt; m (NonEmpty (AnchoredFragment (Header blk))))
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (NonEmpty (AnchoredFragment (Header blk)))
-&gt; m (NonEmpty (AnchoredFragment (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (NonEmpty (HeaderHash blk))
-&gt; (NonEmpty (HeaderHash blk)
    -&gt; StateT
         (Map (HeaderHash blk) (Header blk))
         m
         (AnchoredFragment (Header blk)))
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (NonEmpty (AnchoredFragment (Header blk)))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#forM"><span class="hs-identifier hs-var">forM</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (NonEmpty (HeaderHash blk))
</span><a href="#local-6989586621679902293"><span class="hs-identifier hs-var">suffixesAfterB'</span></a></span><span> </span><span class="annot"><span class="annottext">((NonEmpty (HeaderHash blk)
  -&gt; StateT
       (Map (HeaderHash blk) (Header blk))
       m
       (AnchoredFragment (Header blk)))
 -&gt; StateT
      (Map (HeaderHash blk) (Header blk))
      m
      (NonEmpty (AnchoredFragment (Header blk))))
-&gt; (NonEmpty (HeaderHash blk)
    -&gt; StateT
         (Map (HeaderHash blk) (Header blk))
         m
         (AnchoredFragment (Header blk)))
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (NonEmpty (AnchoredFragment (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679902294"><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621679902294"><span class="hs-identifier hs-var">hashes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-577"></span><span>              </span><span id="local-6989586621679902295"><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621679902295"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk
 -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; [HeaderHash blk]
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m [Header blk]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (m :: * -&gt; *) blk.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var">getKnownHeaderThroughCache</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679902192"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([HeaderHash blk]
 -&gt; StateT (Map (HeaderHash blk) (Header blk)) m [Header blk])
-&gt; [HeaderHash blk]
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m [Header blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-578"></span><span>                        </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk) -&gt; [HeaderHash blk]
forall a. NonEmpty a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#toList"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (HeaderHash blk)
</span><a href="#local-6989586621679902294"><span class="hs-identifier hs-var">hashes</span></a></span><span>
</span><span id="line-579"></span><span>              </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (AnchoredFragment (Header blk))
forall a. a -&gt; StateT (Map (HeaderHash blk) (Header blk)) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; StateT
      (Map (HeaderHash blk) (Header blk))
      m
      (AnchoredFragment (Header blk)))
-&gt; AnchoredFragment (Header blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk))
     m
     (AnchoredFragment (Header blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
-&gt; [Header blk] -&gt; AnchoredFragment (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; [b] -&gt; AnchoredSeq v a b
</span><span class="hs-identifier hs-var">AF.fromOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
</span><a href="#local-6989586621679902291"><span class="hs-identifier hs-var">curHead</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; [Header blk] -&gt; [Header blk]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621679902295"><span class="hs-identifier hs-var">hdrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902296"><span class="annot"><span class="annottext">chainDiffs :: Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="#local-6989586621679902296"><span class="hs-identifier hs-var hs-var">chainDiffs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; Maybe (NonEmpty (ChainDiff (Header blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span>
</span><span id="line-582"></span><span>              </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)]
 -&gt; Maybe (NonEmpty (ChainDiff (Header blk))))
-&gt; [ChainDiff (Header blk)]
-&gt; Maybe (NonEmpty (ChainDiff (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; Bool) -&gt; NonEmpty a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#filter"><span class="hs-identifier hs-var">NE.filter</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; BlockConfig blk
forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902298"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902299"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-583"></span><span>                          </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span>
</span><span id="line-584"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>              </span><span class="annot"><span class="annottext">(NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)])
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk))
-&gt; NonEmpty (AnchoredFragment (Header blk))
-&gt; NonEmpty (ChainDiff (Header blk))
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk)
forall b. AnchoredFragment b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#extend"><span class="hs-identifier hs-var">Diff.extend</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679902290"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-586"></span><span>        </span><span class="hs-comment">-- All candidates are longer than the current chain, so they will be</span><span>
</span><span id="line-587"></span><span>        </span><span class="hs-comment">-- preferred over it, /unless/ the block we just added is an EBB,</span><span>
</span><span id="line-588"></span><span>        </span><span class="hs-comment">-- which has the same 'BlockNo' as the block before it, so when</span><span>
</span><span id="line-589"></span><span>        </span><span class="hs-comment">-- using the 'BlockNo' as the proxy for the length (note that some</span><span>
</span><span id="line-590"></span><span>        </span><span class="hs-comment">-- protocols might do it differently), the candidate with the EBB</span><span>
</span><span id="line-591"></span><span>        </span><span class="hs-comment">-- appended will not be preferred over the current chain.</span><span>
</span><span id="line-592"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-593"></span><span>        </span><span class="hs-comment">-- The consequence of this is that when adding an EBB, it will not</span><span>
</span><span id="line-594"></span><span>        </span><span class="hs-comment">-- be selected by chain selection and thus not appended to the chain</span><span>
</span><span id="line-595"></span><span>        </span><span class="hs-comment">-- until the block after it is added, which will again result in a</span><span>
</span><span id="line-596"></span><span>        </span><span class="hs-comment">-- candidate preferred over the current chain. In this case, the</span><span>
</span><span id="line-597"></span><span>        </span><span class="hs-comment">-- candidate will be a two-block (the EBB and the new block)</span><span>
</span><span id="line-598"></span><span>        </span><span class="hs-comment">-- extension of the current chain.</span><span>
</span><span id="line-599"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="#local-6989586621679902296"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-600"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902301"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-601"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902302"><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902302"><span class="hs-identifier hs-var">chainDiffs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-602"></span><span>            </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var">chainSelection</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902298"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902302"><span class="hs-identifier hs-var">chainDiffs'</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
    -&gt; m (Point blk))
-&gt; m (Point blk)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-603"></span><span>              </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-604"></span><span>                </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902301"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-605"></span><span>              </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902303"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902303"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-606"></span><span>                </span><span class="annot"><span class="annottext">HasCallStack =&gt;
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; StrictTVar m (StrictMaybe (Header blk))
-&gt; ChainSwitchType
-&gt; m (Point blk)
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; StrictTVar m (StrictMaybe (Header blk))
-&gt; ChainSwitchType
-&gt; m (Point blk)
</span><a href="#local-6989586621679902304"><span class="hs-identifier hs-var">switchTo</span></a></span><span>
</span><span id="line-607"></span><span>                  </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902303"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-608"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varTentativeHeader"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902298"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>                  </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#AddingBlocks"><span class="hs-identifier hs-var">AddingBlocks</span></a></span><span>
</span><span id="line-610"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-611"></span><span>        </span><span id="local-6989586621679902298"><span class="annot"><span class="annottext">chainSelEnv :: ChainSelEnv m blk
</span><a href="#local-6989586621679902298"><span class="hs-identifier hs-var hs-var">chainSelEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; ChainSelEnv m blk
</span><a href="#local-6989586621679902248"><span class="hs-identifier hs-var">mkChainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902287"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-612"></span><span>        </span><span id="local-6989586621679902299"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902299"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902287"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-613"></span><span>        </span><span id="local-6989586621679902301"><span class="annot"><span class="annottext">curTip :: Point blk
</span><a href="#local-6989586621679902301"><span class="hs-identifier hs-var hs-var">curTip</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902299"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-614"></span><span>        </span><span id="local-6989586621679902291"><span class="annot"><span class="annottext">curHead :: Anchor (Header blk)
</span><a href="#local-6989586621679902291"><span class="hs-identifier hs-var hs-var">curHead</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Anchor (Header blk)
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; a
</span><span class="hs-identifier hs-var">AF.headAnchor</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902299"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-615"></span><span>
</span><span id="line-616"></span><span>    </span><span class="hs-comment">-- | We have found a 'ChainDiff' through the VolatileDB connecting the new</span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-comment">-- block to the current chain. We'll call the intersection/anchor @x@.</span><span>
</span><span id="line-618"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-619"></span><span>    </span><span class="hs-comment">-- We try to extend this path by looking for forks that start with the</span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-comment">-- given block, then we do chain selection and /possibly/ try to switch to</span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-comment">-- a new fork.</span><span>
</span><span id="line-622"></span><span>    </span><span class="annot"><a href="#local-6989586621679902244"><span class="hs-identifier hs-type">switchToAFork</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-623"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-624"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#LookupBlockInfo"><span class="hs-identifier hs-type">LookupBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-626"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-627"></span><span>         </span><span class="hs-comment">-- ^ The current chain (anchored at @i@) and ledger</span><span>
</span><span id="line-628"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderFields</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>         </span><span class="hs-comment">-- ^ Header fields for @(x,b]@</span><span>
</span><span id="line-630"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-631"></span><span>    </span><span id="local-6989586621679902244"><span class="annot"><span class="annottext">switchToAFork :: HasCallStack =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainAndLedger blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; m (Point blk)
</span><a href="#local-6989586621679902244"><span class="hs-identifier hs-var hs-var">switchToAFork</span></a></span></span><span> </span><span id="local-6989586621679902337"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902337"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span id="local-6989586621679902338"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902338"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span></span><span> </span><span id="local-6989586621679902339"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902339"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span></span><span> </span><span id="local-6989586621679902340"><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621679902340"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-632"></span><span>        </span><span class="hs-comment">-- We use a cache to avoid reading the headers from disk multiple</span><span>
</span><span id="line-633"></span><span>        </span><span class="hs-comment">-- times in case they're part of multiple forks that go through @b@.</span><span>
</span><span id="line-634"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902341"><span class="annot"><span class="annottext">initCache :: Map (HeaderHash blk) (Header blk)
</span><a href="#local-6989586621679902341"><span class="hs-identifier hs-var hs-var">initCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Header blk -&gt; Map (HeaderHash blk) (Header blk)
forall k a. k -&gt; a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#singleton"><span class="hs-identifier hs-var">Map.singleton</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902216"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-635"></span><span>        </span><span id="local-6989586621679902343"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902343"><span class="hs-identifier hs-var">chainDiffs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-636"></span><span>          </span><span class="hs-comment">-- 4. Filter out candidates that are not preferred over the current</span><span>
</span><span id="line-637"></span><span>          </span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-638"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-639"></span><span>          </span><span class="hs-comment">-- The suffixes all fork off from the current chain within @k@</span><span>
</span><span id="line-640"></span><span>          </span><span class="hs-comment">-- blocks, so it satisfies the precondition of 'preferCandidate'.</span><span>
</span><span id="line-641"></span><span>            </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)])
-&gt; m [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span>
</span><span id="line-642"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span>
</span><span id="line-643"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; BlockConfig blk
forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902344"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902345"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-644"></span><span>                  </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span>
</span><span id="line-645"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-646"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-647"></span><span>            </span><span class="hs-comment">-- 3. Translate the 'HeaderFields' to 'Header' by reading the</span><span>
</span><span id="line-648"></span><span>            </span><span class="hs-comment">-- headers from disk.</span><span>
</span><span id="line-649"></span><span>          </span><span class="annot"><span class="annottext">(m [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)])
-&gt; (ChainDiff (HeaderFields blk) -&gt; m [ChainDiff (Header blk)])
-&gt; ChainDiff (HeaderFields blk)
-&gt; m [ChainDiff (Header blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT
   (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)]
 -&gt; Map (HeaderHash blk) (Header blk) -&gt; m [ChainDiff (Header blk)])
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)]
-&gt; m [ChainDiff (Header blk)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">StateT
  (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)]
-&gt; Map (HeaderHash blk) (Header blk) -&gt; m [ChainDiff (Header blk)]
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#evalStateT"><span class="hs-identifier hs-var">evalStateT</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk)
</span><a href="#local-6989586621679902341"><span class="hs-identifier hs-var">initCache</span></a></span><span>
</span><span id="line-650"></span><span>          </span><span class="annot"><span class="annottext">(StateT
   (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)]
 -&gt; m [ChainDiff (Header blk)])
-&gt; (ChainDiff (HeaderFields blk)
    -&gt; StateT
         (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)])
-&gt; ChainDiff (HeaderFields blk)
-&gt; m [ChainDiff (Header blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (HeaderFields blk)
 -&gt; StateT
      (Map (HeaderHash blk) (Header blk)) m (ChainDiff (Header blk)))
-&gt; [ChainDiff (HeaderFields blk)]
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m (ChainDiff (Header blk))
</span><a href="#local-6989586621679902346"><span class="hs-identifier hs-var">translateToHeaders</span></a></span><span>
</span><span id="line-651"></span><span>            </span><span class="hs-comment">-- 2. Filter out candidates that are shorter than the current</span><span>
</span><span id="line-652"></span><span>            </span><span class="hs-comment">-- chain. We don't want to needlessly read the headers from disk</span><span>
</span><span id="line-653"></span><span>            </span><span class="hs-comment">-- for those candidates.</span><span>
</span><span id="line-654"></span><span>          </span><span class="annot"><span class="annottext">([ChainDiff (HeaderFields blk)]
 -&gt; StateT
      (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)])
-&gt; (ChainDiff (HeaderFields blk) -&gt; [ChainDiff (HeaderFields blk)])
-&gt; ChainDiff (HeaderFields blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m [ChainDiff (Header blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (HeaderFields blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (HeaderFields blk))
-&gt; [ChainDiff (HeaderFields blk)]
forall a. (a -&gt; Bool) -&gt; NonEmpty a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#filter"><span class="hs-identifier hs-var">NE.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (ChainDiff (HeaderFields blk) -&gt; Bool)
-&gt; ChainDiff (HeaderFields blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk) -&gt; Bool
forall b. HasHeader b =&gt; ChainDiff b -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">Diff.rollbackExceedsSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>            </span><span class="hs-comment">-- 1. Extend the diff with candidates fitting on @B@</span><span>
</span><span id="line-656"></span><span>          </span><span class="annot"><span class="annottext">(NonEmpty (ChainDiff (HeaderFields blk))
 -&gt; [ChainDiff (HeaderFields blk)])
-&gt; (ChainDiff (HeaderFields blk)
    -&gt; NonEmpty (ChainDiff (HeaderFields blk)))
-&gt; ChainDiff (HeaderFields blk)
-&gt; [ChainDiff (HeaderFields blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; (HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; ChainDiff (HeaderFields blk)
-&gt; NonEmpty (ChainDiff (HeaderFields blk))
forall blk.
HasHeader blk =&gt;
(ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; LookupBlockInfo blk
-&gt; ChainDiff (HeaderFields blk)
-&gt; NonEmpty (ChainDiff (HeaderFields blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Paths.html#extendWithSuccessors"><span class="hs-identifier hs-var">Paths.extendWithSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679902337"><span class="hs-identifier hs-var">succsOf</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (BlockInfo blk)
</span><a href="#local-6989586621679902338"><span class="hs-identifier hs-var">lookupBlockInfo</span></a></span><span>
</span><span id="line-657"></span><span>          </span><span class="annot"><span class="annottext">(ChainDiff (HeaderFields blk) -&gt; m [ChainDiff (Header blk)])
-&gt; ChainDiff (HeaderFields blk) -&gt; m [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (HeaderFields blk)
</span><a href="#local-6989586621679902340"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; Maybe (NonEmpty (ChainDiff (Header blk)))
forall a. [a] -&gt; Maybe (NonEmpty a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#nonEmpty"><span class="hs-identifier hs-var">NE.nonEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902343"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-660"></span><span>          </span><span class="hs-comment">-- No candidates preferred over the current chain</span><span>
</span><span id="line-661"></span><span>          </span><span class="annot"><span class="annottext">Maybe (NonEmpty (ChainDiff (Header blk)))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902350"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-662"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902351"><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902351"><span class="hs-identifier hs-var">chainDiffs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-663"></span><span>            </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var">chainSelection</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902344"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902351"><span class="hs-identifier hs-var">chainDiffs'</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
    -&gt; m (Point blk))
-&gt; m (Point blk)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-664"></span><span>              </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-665"></span><span>                </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902350"><span class="hs-identifier hs-var">curTip</span></a></span><span>
</span><span id="line-666"></span><span>              </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902352"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902352"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-667"></span><span>                </span><span class="annot"><span class="annottext">HasCallStack =&gt;
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; StrictTVar m (StrictMaybe (Header blk))
-&gt; ChainSwitchType
-&gt; m (Point blk)
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; StrictTVar m (StrictMaybe (Header blk))
-&gt; ChainSwitchType
-&gt; m (Point blk)
</span><a href="#local-6989586621679902304"><span class="hs-identifier hs-var">switchTo</span></a></span><span>
</span><span id="line-668"></span><span>                  </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902352"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-669"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSelEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varTentativeHeader"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902344"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-670"></span><span>                  </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#SwitchingToAFork"><span class="hs-identifier hs-var">SwitchingToAFork</span></a></span><span>
</span><span id="line-671"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-672"></span><span>        </span><span id="local-6989586621679902344"><span class="annot"><span class="annottext">chainSelEnv :: ChainSelEnv m blk
</span><a href="#local-6989586621679902344"><span class="hs-identifier hs-var hs-var">chainSelEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; ChainSelEnv m blk
</span><a href="#local-6989586621679902248"><span class="hs-identifier hs-var">mkChainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902339"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-673"></span><span>        </span><span id="local-6989586621679902345"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902345"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902339"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-674"></span><span>        </span><span id="local-6989586621679902350"><span class="annot"><span class="annottext">curTip :: Point blk
</span><a href="#local-6989586621679902350"><span class="hs-identifier hs-var hs-var">curTip</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902345"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span>    </span><span class="annot"><a href="#local-6989586621679902353"><span class="hs-identifier hs-type">mkSelectionChangedInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-677"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ old chain</span><span>
</span><span id="line-678"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ new chain</span><span>
</span><span id="line-679"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>                 </span><span class="hs-comment">-- ^ new LedgerDB</span><span>
</span><span id="line-680"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SelectionChangedInfo"><span class="hs-identifier hs-type">SelectionChangedInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-681"></span><span>    </span><span id="local-6989586621679902353"><span class="annot"><span class="annottext">mkSelectionChangedInfo :: AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; LedgerDB' blk
-&gt; SelectionChangedInfo blk
</span><a href="#local-6989586621679902353"><span class="hs-identifier hs-var hs-var">mkSelectionChangedInfo</span></a></span></span><span> </span><span id="local-6989586621679902354"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902354"><span class="hs-identifier hs-var">oldChain</span></a></span></span><span> </span><span id="local-6989586621679902355"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902355"><span class="hs-identifier hs-var">newChain</span></a></span></span><span> </span><span id="local-6989586621679902356"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902356"><span class="hs-identifier hs-var">newLedgerDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-682"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SelectionChangedInfo"><span class="hs-identifier hs-type">SelectionChangedInfo</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-683"></span><span>            </span><span class="annot"><span class="annottext">newTipPoint :: RealPoint blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipPoint"><span class="hs-identifier hs-var">newTipPoint</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint (Header blk) -&gt; RealPoint blk
forall blk blk'.
Coercible (HeaderHash blk) (HeaderHash blk') =&gt;
RealPoint blk -&gt; RealPoint blk'
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#castRealPoint"><span class="hs-identifier hs-var">castRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint (Header blk)
</span><a href="#local-6989586621679902360"><span class="hs-identifier hs-var">tipPoint</span></a></span><span>
</span><span id="line-684"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">newTipEpoch :: EpochNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipEpoch"><span class="hs-identifier hs-var">newTipEpoch</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679902362"><span class="hs-identifier hs-var">tipEpoch</span></a></span><span>
</span><span id="line-685"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">newTipSlotInEpoch :: Word64
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipSlotInEpoch"><span class="hs-identifier hs-var">newTipSlotInEpoch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679902364"><span class="hs-identifier hs-var">tipSlotInEpoch</span></a></span><span>
</span><span id="line-686"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">newTipTrigger :: RealPoint blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newTipTrigger"><span class="hs-identifier hs-var">newTipTrigger</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902235"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-687"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SelectView (BlockProtocol blk)
newTipSelectView :: SelectView (BlockProtocol blk)
newTipSelectView :: SelectView (BlockProtocol blk)
</span><a href="#local-6989586621679902366"><span class="hs-identifier hs-var hs-var">newTipSelectView</span></a></span><span>
</span><span id="line-688"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">oldTipSelectView :: Maybe (SelectView (BlockProtocol blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#oldTipSelectView"><span class="hs-identifier hs-var">oldTipSelectView</span></a></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-689"></span><span>                  </span><span class="annot"><span class="annottext">BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
forall blk.
BlockSupportsProtocol blk =&gt;
BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#selectView"><span class="hs-identifier hs-var">selectView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configBlock"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679902370"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>              </span><span class="annot"><span class="annottext">(Header blk -&gt; SelectView (BlockProtocol blk))
-&gt; Maybe (Header blk) -&gt; Maybe (SelectView (BlockProtocol blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Either (Anchor (Header blk)) (Header blk) -&gt; Maybe (Header blk)
forall a b. Either a b -&gt; Maybe b
</span><a href="Ouroboros.Consensus.Util.html#eitherToMaybe"><span class="hs-identifier hs-var">eitherToMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; Either (Anchor (Header blk)) (Header blk)
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Either a b
</span><span class="hs-identifier hs-var">AF.head</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902354"><span class="hs-identifier hs-var">oldChain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-692"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-693"></span><span>        </span><span class="annot"><a href="#local-6989586621679902370"><span class="hs-identifier hs-type">cfg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-694"></span><span>        </span><span id="local-6989586621679902370"><span class="annot"><span class="annottext">cfg :: TopLevelConfig blk
</span><a href="#local-6989586621679902370"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679902199"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>        </span><span class="annot"><a href="#local-6989586621679902372"><span class="hs-identifier hs-type">ledger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-697"></span><span>        </span><span id="local-6989586621679902372"><span class="annot"><span class="annottext">ledger :: LedgerState blk
</span><a href="#local-6989586621679902372"><span class="hs-identifier hs-var hs-var">ledger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902356"><span class="hs-identifier hs-var">newLedgerDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-698"></span><span>
</span><span id="line-699"></span><span>        </span><span class="annot"><a href="#local-6989586621679902375"><span class="hs-identifier hs-type">summary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.Summary.html#Summary"><span class="hs-identifier hs-type">History.Summary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HardForkIndices"><span class="hs-identifier hs-type">HardForkIndices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span>        </span><span id="local-6989586621679902375"><span class="annot"><span class="annottext">summary :: Summary (HardForkIndices blk)
</span><a href="#local-6989586621679902375"><span class="hs-identifier hs-var hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; LedgerState blk -&gt; Summary (HardForkIndices blk)
forall blk.
HasHardForkHistory blk =&gt;
LedgerConfig blk
-&gt; LedgerState blk -&gt; Summary (HardForkIndices blk)
</span><a href="Ouroboros.Consensus.HardFork.Abstract.html#hardForkSummary"><span class="hs-identifier hs-var">hardForkSummary</span></a></span><span>
</span><span id="line-701"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configLedger"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679902370"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>                    </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679902372"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679902360"><span class="annot"><span class="annottext">RealPoint (Header blk)
</span><a href="#local-6989586621679902360"><span class="hs-identifier hs-var">tipPoint</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679902362"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679902362"><span class="hs-identifier hs-var">tipEpoch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902364"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679902364"><span class="hs-identifier hs-var">tipSlotInEpoch</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902366"><span class="annot"><span class="annottext">SelectView (BlockProtocol blk)
</span><a href="#local-6989586621679902366"><span class="hs-identifier hs-var">newTipSelectView</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-705"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; Either (Anchor (Header blk)) (Header blk)
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Either a b
</span><span class="hs-identifier hs-var">AF.head</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902355"><span class="hs-identifier hs-var">newChain</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-706"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679902378"><span class="annot"><span class="annottext">Anchor (Header blk)
</span><a href="#local-6989586621679902378"><span class="hs-identifier hs-var">_anchor</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; (RealPoint (Header blk), (EpochNo, Word64),
    SelectView (BlockProtocol blk))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cannot have switched to an empty chain&quot;</span></span><span>
</span><span id="line-707"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679902379"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902379"><span class="hs-identifier hs-var">tipHdr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-708"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902380"><span class="annot"><span class="annottext">query :: Qry (EpochNo, Word64)
</span><a href="#local-6989586621679902380"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Qry (EpochNo, Word64)
</span><a href="Ouroboros.Consensus.HardFork.History.Qry.html#slotToEpoch%27"><span class="hs-identifier hs-var">History.slotToEpoch'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><span class="hs-identifier hs-var">blockSlot</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902379"><span class="hs-identifier hs-var">tipHdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span>                  </span><span id="local-6989586621679902383"><span class="annot"><span class="annottext">tipEpochData :: (EpochNo, Word64)
</span><a href="#local-6989586621679902383"><span class="hs-identifier hs-var hs-var">tipEpochData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Qry (EpochNo, Word64)
-&gt; Summary (HardForkIndices blk) -&gt; (EpochNo, Word64)
forall a (xs :: [*]). HasCallStack =&gt; Qry a -&gt; Summary xs -&gt; a
</span><a href="Ouroboros.Consensus.HardFork.History.Qry.html#runQueryPure"><span class="hs-identifier hs-var">History.runQueryPure</span></a></span><span> </span><span class="annot"><span class="annottext">Qry (EpochNo, Word64)
</span><a href="#local-6989586621679902380"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">Summary (HardForkIndices blk)
</span><a href="#local-6989586621679902375"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-710"></span><span>                  </span><span id="local-6989586621679902385"><span class="annot"><span class="annottext">sv :: SelectView (BlockProtocol blk)
</span><a href="#local-6989586621679902385"><span class="hs-identifier hs-var hs-var">sv</span></a></span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
forall blk.
BlockSupportsProtocol blk =&gt;
BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#selectView"><span class="hs-identifier hs-var">selectView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configBlock"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679902370"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902379"><span class="hs-identifier hs-var">tipHdr</span></a></span><span>
</span><span id="line-711"></span><span>              </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint (Header blk)
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902379"><span class="hs-identifier hs-var">tipHdr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(EpochNo, Word64)
</span><a href="#local-6989586621679902383"><span class="hs-identifier hs-var">tipEpochData</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SelectView (BlockProtocol blk)
</span><a href="#local-6989586621679902385"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span>    </span><span class="hs-comment">-- | Try to apply the given 'ChainDiff' on the current chain fragment. The</span><span>
</span><span id="line-714"></span><span>    </span><span class="hs-comment">-- 'LgrDB.LedgerDB' is updated in the same transaction.</span><span>
</span><span id="line-715"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-716"></span><span>    </span><span class="hs-comment">-- Note that we /cannot/ have switched to a different current chain in the</span><span>
</span><span id="line-717"></span><span>    </span><span class="hs-comment">-- meantime, since this function will only be called by a single</span><span>
</span><span id="line-718"></span><span>    </span><span class="hs-comment">-- background thread.</span><span>
</span><span id="line-719"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-720"></span><span>    </span><span class="hs-comment">-- It /is/ possible that the background thread copying headers older than</span><span>
</span><span id="line-721"></span><span>    </span><span class="hs-comment">-- @k@ from the VolatileDB to the ImmutableDB has removed some headers</span><span>
</span><span id="line-722"></span><span>    </span><span class="hs-comment">-- from the beginning of the current chain fragment, but does not affect</span><span>
</span><span id="line-723"></span><span>    </span><span class="hs-comment">-- us, as we cannot roll back more than @k@ headers anyway.</span><span>
</span><span id="line-724"></span><span>    </span><span class="annot"><a href="#local-6989586621679902304"><span class="hs-identifier hs-type">switchTo</span></a></span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-726"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-727"></span><span>         </span><span class="hs-comment">-- ^ Chain and ledger to switch to</span><span>
</span><span id="line-728"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>         </span><span class="hs-comment">-- ^ Tentative header</span><span>
</span><span id="line-730"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSwitchType"><span class="hs-identifier hs-type">ChainSwitchType</span></a></span><span>
</span><span id="line-731"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-732"></span><span>    </span><span id="local-6989586621679902304"><span class="annot"><span class="annottext">switchTo :: HasCallStack =&gt;
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; StrictTVar m (StrictMaybe (Header blk))
-&gt; ChainSwitchType
-&gt; m (Point blk)
</span><a href="#local-6989586621679902304"><span class="hs-identifier hs-var hs-var">switchTo</span></a></span></span><span> </span><span id="local-6989586621679902434"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902434"><span class="hs-identifier hs-var">vChainDiff</span></a></span></span><span> </span><span id="local-6989586621679902435"><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679902435"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span></span><span> </span><span id="local-6989586621679902436"><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="#local-6989586621679902436"><span class="hs-identifier hs-var">chainSwitchType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-733"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-734"></span><span>            </span><span class="annot"><span class="annottext">Point blk -&gt; TraceAddBlockEvent blk
forall blk. Point blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChangingSelection"><span class="hs-identifier hs-var">ChangingSelection</span></a></span><span>
</span><span id="line-735"></span><span>          </span><span class="annot"><span class="annottext">(Point blk -&gt; TraceAddBlockEvent blk)
-&gt; Point blk -&gt; TraceAddBlockEvent blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span>
</span><span id="line-736"></span><span>          </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span>
</span><span id="line-737"></span><span>          </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Point (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">getSuffix</span></a></span><span>
</span><span id="line-738"></span><span>          </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ChainDiff (Header blk)
forall b l. ValidatedChainDiff b l -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#getChainDiff"><span class="hs-identifier hs-var">getChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902434"><span class="hs-identifier hs-var">vChainDiff</span></a></span><span>
</span><span id="line-739"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679902439"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902439"><span class="hs-identifier hs-var">curChain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902440"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902440"><span class="hs-identifier hs-var">newChain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902441"><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679902441"><span class="hs-identifier hs-var">events</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902442"><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902442"><span class="hs-identifier hs-var">prevTentativeHeader</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
   [LedgerEvent blk], StrictMaybe (Header blk))
-&gt; m (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk], StrictMaybe (Header blk))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
    [LedgerEvent blk], StrictMaybe (Header blk))
 -&gt; m (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
       [LedgerEvent blk], StrictMaybe (Header blk)))
-&gt; STM
     m
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk], StrictMaybe (Header blk))
-&gt; m (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk], StrictMaybe (Header blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-740"></span><span>          </span><span id="local-6989586621679902443"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902443"><span class="hs-identifier hs-var">curChain</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span>         </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679902194"><span class="hs-identifier hs-var">cdbChain</span></a></span><span> </span><span class="hs-comment">-- Not Query.getCurrentChain!</span><span>
</span><span id="line-741"></span><span>          </span><span id="local-6989586621679902444"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902444"><span class="hs-identifier hs-var">curLedger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#getCurrent"><span class="hs-identifier hs-var">LgrDB.getCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679902193"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>
</span><span id="line-742"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; ChainDiff (Header blk) -&gt; Maybe (AnchoredFragment (Header blk))
forall b.
HasHeader b =&gt;
AnchoredFragment b -&gt; ChainDiff b -&gt; Maybe (AnchoredFragment b)
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#apply"><span class="hs-identifier hs-var">Diff.apply</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902443"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902446"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-743"></span><span>            </span><span class="hs-comment">-- Impossible, as described in the docstring</span><span>
</span><span id="line-744"></span><span>            </span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-745"></span><span>              </span><span class="annot"><span class="annottext">[Char]
-&gt; STM
     m
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk], StrictMaybe (Header blk))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;chainDiff doesn't fit onto current chain&quot;</span></span><span>
</span><span id="line-746"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902447"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902447"><span class="hs-identifier hs-var">newChain</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-747"></span><span>              </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679902194"><span class="hs-identifier hs-var">cdbChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902447"><span class="hs-identifier hs-var">newChain</span></a></span><span>
</span><span id="line-748"></span><span>              </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; LedgerDB' blk -&gt; STM m ()
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; LedgerDB' blk -&gt; STM m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#setCurrent"><span class="hs-identifier hs-var">LgrDB.setCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679902193"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902449"><span class="hs-identifier hs-var">newLedger</span></a></span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span>              </span><span class="hs-comment">-- Inspect the new ledger for potential problems</span><span>
</span><span id="line-751"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679902450"><span class="hs-identifier hs-type">events</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#LedgerEvent"><span class="hs-identifier hs-type">LedgerEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-752"></span><span>                  </span><span id="local-6989586621679902450"><span class="annot"><span class="annottext">events :: [LedgerEvent blk]
</span><a href="#local-6989586621679902450"><span class="hs-identifier hs-var hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; LedgerState blk -&gt; LedgerState blk -&gt; [LedgerEvent blk]
forall blk.
InspectLedger blk =&gt;
TopLevelConfig blk
-&gt; LedgerState blk -&gt; LedgerState blk -&gt; [LedgerEvent blk]
</span><a href="Ouroboros.Consensus.Ledger.Inspect.html#inspectLedger"><span class="hs-identifier hs-var">inspectLedger</span></a></span><span>
</span><span id="line-753"></span><span>                             </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679902199"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>
</span><span id="line-754"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; ExtLedgerState blk -&gt; LedgerState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902444"><span class="hs-identifier hs-var">curLedger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; ExtLedgerState blk -&gt; LedgerState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902449"><span class="hs-identifier hs-var">newLedger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span>              </span><span class="hs-comment">-- Clear the tentative header</span><span>
</span><span id="line-758"></span><span>              </span><span id="local-6989586621679902452"><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902452"><span class="hs-identifier hs-var">prevTentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
-&gt; StrictMaybe (Header blk) -&gt; STM m (StrictMaybe (Header blk))
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; a -&gt; STM m a
</span><span class="hs-identifier hs-var">swapTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679902435"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
forall a. StrictMaybe a
</span><span class="hs-identifier hs-var">SNothing</span></span><span>
</span><span id="line-759"></span><span>
</span><span id="line-760"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="#local-6989586621679902436"><span class="hs-identifier hs-var">chainSwitchType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-761"></span><span>                </span><span class="hs-comment">-- When adding blocks, the intersection point of the old and new</span><span>
</span><span id="line-762"></span><span>                </span><span class="hs-comment">-- tentative/selected chain is not receding, in which case</span><span>
</span><span id="line-763"></span><span>                </span><span class="hs-comment">-- `fhSwitchFork` is unnecessary. In the case of pipelining a</span><span>
</span><span id="line-764"></span><span>                </span><span class="hs-comment">-- block, it would even result in rolling back by one block and</span><span>
</span><span id="line-765"></span><span>                </span><span class="hs-comment">-- rolling forward again.</span><span>
</span><span id="line-766"></span><span>                </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#AddingBlocks"><span class="hs-identifier hs-var">AddingBlocks</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM m ()
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>                </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#SwitchingToAFork"><span class="hs-identifier hs-var">SwitchingToAFork</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-768"></span><span>                  </span><span class="hs-comment">-- Update the followers</span><span>
</span><span id="line-769"></span><span>                  </span><span class="hs-comment">--</span><span>
</span><span id="line-770"></span><span>                  </span><span class="hs-comment">-- 'Follower.switchFork' needs to know the intersection point</span><span>
</span><span id="line-771"></span><span>                  </span><span class="hs-comment">-- (@ipoint@) between the old and the current chain.</span><span>
</span><span id="line-772"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902454"><span class="annot"><span class="annottext">ipoint :: Point blk
</span><a href="#local-6989586621679902454"><span class="hs-identifier hs-var hs-var">ipoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Point (Header blk)
forall b. ChainDiff b -&gt; Point b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getAnchorPoint"><span class="hs-identifier hs-var">Diff.getAnchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902446"><span class="hs-identifier hs-var">chainDiff</span></a></span><span>
</span><span id="line-773"></span><span>                  </span><span id="local-6989586621679902456"><span class="annot"><span class="annottext">[FollowerHandle m blk]
</span><a href="#local-6989586621679902456"><span class="hs-identifier hs-var">followerHandles</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map FollowerKey (FollowerHandle m blk) -&gt; [FollowerHandle m blk]
forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">Map.elems</span></a></span><span> </span><span class="annot"><span class="annottext">(Map FollowerKey (FollowerHandle m blk) -&gt; [FollowerHandle m blk])
-&gt; STM m (Map FollowerKey (FollowerHandle m blk))
-&gt; STM m [FollowerHandle m blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
-&gt; STM m (Map FollowerKey (FollowerHandle m blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
</span><a href="#local-6989586621679902198"><span class="hs-identifier hs-var">cdbFollowers</span></a></span><span>
</span><span id="line-774"></span><span>                  </span><span class="annot"><span class="annottext">[FollowerHandle m blk]
-&gt; (FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[FollowerHandle m blk]
</span><a href="#local-6989586621679902456"><span class="hs-identifier hs-var">followerHandles</span></a></span><span> </span><span class="annot"><span class="annottext">((FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ())
-&gt; (FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; FollowerHandle m blk
-&gt; STM m ()
forall {blk} {m :: * -&gt; *}.
(HasHeader blk, HasHeader (Header blk)) =&gt;
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; FollowerHandle m blk
-&gt; STM m ()
</span><a href="#local-6989586621679902457"><span class="hs-identifier hs-var">switchFollowerToFork</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902443"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902447"><span class="hs-identifier hs-var">newChain</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902454"><span class="hs-identifier hs-var">ipoint</span></a></span><span>
</span><span id="line-775"></span><span>
</span><span id="line-776"></span><span>              </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk), AnchoredFragment (Header blk),
 [LedgerEvent blk], StrictMaybe (Header blk))
-&gt; STM
     m
     (AnchoredFragment (Header blk), AnchoredFragment (Header blk),
      [LedgerEvent blk], StrictMaybe (Header blk))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902443"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902447"><span class="hs-identifier hs-var">newChain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679902450"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902452"><span class="hs-identifier hs-var">prevTentativeHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span>
</span><span id="line-778"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902458"><span class="annot"><span class="annottext">mkTraceEvent :: [LedgerEvent blk]
-&gt; SelectionChangedInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="#local-6989586621679902458"><span class="hs-identifier hs-var hs-var">mkTraceEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="#local-6989586621679902436"><span class="hs-identifier hs-var">chainSwitchType</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-779"></span><span>              </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#AddingBlocks"><span class="hs-identifier hs-var">AddingBlocks</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
-&gt; SelectionChangedInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
forall blk.
[LedgerEvent blk]
-&gt; SelectionChangedInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#AddedToCurrentChain"><span class="hs-identifier hs-var">AddedToCurrentChain</span></a></span><span>
</span><span id="line-780"></span><span>              </span><span class="annot"><span class="annottext">ChainSwitchType
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#SwitchingToAFork"><span class="hs-identifier hs-var">SwitchingToAFork</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
-&gt; SelectionChangedInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
forall blk.
[LedgerEvent blk]
-&gt; SelectionChangedInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SwitchedToAFork"><span class="hs-identifier hs-var">SwitchedToAFork</span></a></span><span>
</span><span id="line-781"></span><span>            </span><span id="local-6989586621679902461"><span class="annot"><span class="annottext">selChangedInfo :: SelectionChangedInfo blk
</span><a href="#local-6989586621679902461"><span class="hs-identifier hs-var hs-var">selChangedInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; LedgerDB' blk
-&gt; SelectionChangedInfo blk
</span><a href="#local-6989586621679902353"><span class="hs-identifier hs-var">mkSelectionChangedInfo</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902439"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902440"><span class="hs-identifier hs-var">newChain</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902449"><span class="hs-identifier hs-var">newLedger</span></a></span><span>
</span><span id="line-782"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceAddBlockEvent blk -&gt; m ()) -&gt; TraceAddBlockEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-783"></span><span>          </span><span class="annot"><span class="annottext">[LedgerEvent blk]
-&gt; SelectionChangedInfo blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; TraceAddBlockEvent blk
</span><a href="#local-6989586621679902458"><span class="hs-identifier hs-var">mkTraceEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679902441"><span class="hs-identifier hs-var">events</span></a></span><span> </span><span class="annot"><span class="annottext">SelectionChangedInfo blk
</span><a href="#local-6989586621679902461"><span class="hs-identifier hs-var">selChangedInfo</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902439"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902440"><span class="hs-identifier hs-var">newChain</span></a></span><span>
</span><span id="line-784"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Header blk) -&gt; (Header blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictMaybe (Header blk) -&gt; Maybe (Header blk)
forall a. StrictMaybe a -&gt; Maybe a
</span><span class="hs-identifier hs-var">strictMaybeToMaybe</span></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902442"><span class="hs-identifier hs-var">prevTentativeHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Header blk -&gt; m ()) -&gt; m ()) -&gt; (Header blk -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (Header blk) -&gt; Header blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">(Tracer m (Header blk) -&gt; Header blk -&gt; m ())
-&gt; Tracer m (Header blk) -&gt; Header blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-785"></span><span>          </span><span class="annot"><span class="annottext">TracePipeliningEvent blk -&gt; TraceAddBlockEvent blk
forall blk. TracePipeliningEvent blk -&gt; TraceAddBlockEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#PipeliningEvent"><span class="hs-identifier hs-var">PipeliningEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TracePipeliningEvent blk -&gt; TraceAddBlockEvent blk)
-&gt; (Header blk -&gt; TracePipeliningEvent blk)
-&gt; Header blk
-&gt; TraceAddBlockEvent blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; TracePipeliningEvent blk
forall blk. Header blk -&gt; TracePipeliningEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#OutdatedTentativeHeader"><span class="hs-identifier hs-var">OutdatedTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; TraceAddBlockEvent blk)
-&gt; Tracer m (TraceAddBlockEvent blk) -&gt; Tracer m (Header blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceAddBlockEvent blk)
</span><a href="#local-6989586621679902234"><span class="hs-identifier hs-var">addBlockTracer</span></a></span><span>
</span><span id="line-786"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (LedgerDB' blk) -&gt; LedgerDB' blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (LedgerDB' blk)
</span><a href="#local-6989586621679902205"><span class="hs-identifier hs-var">cdbTraceLedger</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902449"><span class="hs-identifier hs-var">newLedger</span></a></span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; m (Point blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Point blk -&gt; m (Point blk)) -&gt; Point blk -&gt; m (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902440"><span class="hs-identifier hs-var">newChain</span></a></span><span>
</span><span id="line-789"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-790"></span><span>        </span><span class="hs-comment">-- Given the current chain and the new chain as chain fragments, and the</span><span>
</span><span id="line-791"></span><span>        </span><span class="hs-comment">-- intersection point (an optimization, since it has already been</span><span>
</span><span id="line-792"></span><span>        </span><span class="hs-comment">-- computed when calling this function), returns a function that updates</span><span>
</span><span id="line-793"></span><span>        </span><span class="hs-comment">-- the state of a follower via its handle.</span><span>
</span><span id="line-794"></span><span>        </span><span id="local-6989586621679902457"><span class="annot"><span class="annottext">switchFollowerToFork :: AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Point blk
-&gt; FollowerHandle m blk
-&gt; STM m ()
</span><a href="#local-6989586621679902457"><span class="hs-identifier hs-var hs-var">switchFollowerToFork</span></a></span></span><span> </span><span id="local-6989586621679902521"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902521"><span class="hs-identifier hs-var">curChain</span></a></span></span><span> </span><span id="local-6989586621679902522"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902522"><span class="hs-identifier hs-var">newChain</span></a></span></span><span> </span><span id="local-6989586621679902523"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902523"><span class="hs-identifier hs-var">ipoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-795"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902524"><span class="annot"><span class="annottext">oldPoints :: Set (Point blk)
</span><a href="#local-6989586621679902524"><span class="hs-identifier hs-var hs-var">oldPoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Point blk] -&gt; Set (Point blk)
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Point blk] -&gt; Set (Point blk))
-&gt; (AnchoredFragment (Header blk) -&gt; [Point blk])
-&gt; AnchoredFragment (Header blk)
-&gt; Set (Point blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; Point blk) -&gt; [Header blk] -&gt; [Point blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">([Header blk] -&gt; [Point blk])
-&gt; (AnchoredFragment (Header blk) -&gt; [Header blk])
-&gt; AnchoredFragment (Header blk)
-&gt; [Point blk]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AS.toOldestFirst</span></span><span>
</span><span id="line-796"></span><span>                        </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Set (Point blk))
-&gt; AnchoredFragment (Header blk) -&gt; Set (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span>
</span><span id="line-797"></span><span>                        </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; ChainDiff (Header blk)
forall b.
(HasHeader b, HasCallStack) =&gt;
AnchoredFragment b -&gt; AnchoredFragment b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#diff"><span class="hs-identifier hs-var">Diff.diff</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902522"><span class="hs-identifier hs-var">newChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902521"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-798"></span><span>          </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; (FollowerHandle m blk -&gt; STM m ())
-&gt; FollowerHandle m blk
-&gt; STM m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (Header blk) -&gt; AnchoredFragment (Header blk) -&gt; Bool
forall block.
HasHeader block =&gt;
Point block -&gt; AnchoredFragment block -&gt; Bool
</span><span class="hs-identifier hs-var">AF.withinFragmentBounds</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902523"><span class="hs-identifier hs-var">ipoint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902522"><span class="hs-identifier hs-var">newChain</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((FollowerHandle m blk -&gt; STM m ())
 -&gt; FollowerHandle m blk -&gt; STM m ())
-&gt; (FollowerHandle m blk -&gt; STM m ())
-&gt; FollowerHandle m blk
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-799"></span><span>             </span><span class="hs-glyph">\</span><span id="local-6989586621679902530"><span class="annot"><span class="annottext">FollowerHandle m blk
</span><a href="#local-6989586621679902530"><span class="hs-identifier hs-var">followerHandle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FollowerHandle m blk -&gt; Point blk -&gt; Set (Point blk) -&gt; STM m ()
forall (m :: * -&gt; *) blk.
FollowerHandle m blk -&gt; Point blk -&gt; Set (Point blk) -&gt; STM m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#fhSwitchFork"><span class="hs-identifier hs-var">fhSwitchFork</span></a></span><span> </span><span class="annot"><span class="annottext">FollowerHandle m blk
</span><a href="#local-6989586621679902530"><span class="hs-identifier hs-var">followerHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902523"><span class="hs-identifier hs-var">ipoint</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point blk)
</span><a href="#local-6989586621679902524"><span class="hs-identifier hs-var">oldPoints</span></a></span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621679902446"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902446"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span> </span><span id="local-6989586621679902449"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902449"><span class="hs-identifier hs-var">newLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902434"><span class="hs-identifier hs-var">vChainDiff</span></a></span><span>
</span><span id="line-802"></span><span>
</span><span id="line-803"></span><span>    </span><span class="hs-comment">-- | We have a new block @b@ that doesn't fit onto the current chain, but</span><span>
</span><span id="line-804"></span><span>    </span><span class="hs-comment">-- we have found a 'ChainDiff' connecting it to the current chain via</span><span>
</span><span id="line-805"></span><span>    </span><span class="hs-comment">-- intersection point @x@. We may also have extended that 'ChainDiff' with</span><span>
</span><span id="line-806"></span><span>    </span><span class="hs-comment">-- more blocks fitting onto @b@, i.e., a suffix @s@.</span><span>
</span><span id="line-807"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-808"></span><span>    </span><span class="hs-comment">-- We now translate that 'ChainDiff' from 'HeaderFields' to 'Header's by</span><span>
</span><span id="line-809"></span><span>    </span><span class="hs-comment">-- reading the headers from disk.</span><span>
</span><span id="line-810"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-811"></span><span>    </span><span class="hs-comment">-- Note that we need to read the headers corresponding to the hashes</span><span>
</span><span id="line-812"></span><span>    </span><span class="hs-comment">-- @(x,b)@ and @(b,?]@ from disk. Not for @b@, as that's in our cache.</span><span>
</span><span id="line-813"></span><span>    </span><span class="annot"><a href="#local-6989586621679902346"><span class="hs-identifier hs-type">translateToHeaders</span></a></span><span>
</span><span id="line-814"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderFields</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#StateT"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span>                </span><span class="annot"><a href="#local-6989586621679901197"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-817"></span><span>                </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901198"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span>         </span><span class="hs-comment">-- ^ Fork, anchored at @x@, contains (the header of) @b@ and ends</span><span>
</span><span id="line-819"></span><span>         </span><span class="hs-comment">-- with the suffix @s@.</span><span>
</span><span id="line-820"></span><span>    </span><span id="local-6989586621679902346"><span class="annot"><span class="annottext">translateToHeaders :: ChainDiff (HeaderFields blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m (ChainDiff (Header blk))
</span><a href="#local-6989586621679902346"><span class="hs-identifier hs-var hs-var">translateToHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-821"></span><span>        </span><span class="annot"><span class="annottext">(HeaderFields blk
 -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; ChainDiff (HeaderFields blk)
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m (ChainDiff (Header blk))
forall a b (m :: * -&gt; *).
(HasHeader b, HeaderHash a ~ HeaderHash b, Monad m) =&gt;
(a -&gt; m b) -&gt; ChainDiff a -&gt; m (ChainDiff b)
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#mapM"><span class="hs-identifier hs-var">Diff.mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (m :: * -&gt; *) blk.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var">getKnownHeaderThroughCache</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679902192"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk
 -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; (HeaderFields blk -&gt; HeaderHash blk)
-&gt; HeaderFields blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderFields blk -&gt; HeaderHash blk
forall k (b :: k). HeaderFields b -&gt; HeaderHash b
</span><span class="hs-identifier hs-var">headerFieldHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span class="hs-comment">-- | Check whether the header for the hash is in the cache, if not, get</span><span>
</span><span id="line-824"></span><span class="hs-comment">-- the corresponding header from the VolatileDB and store it in the cache.</span><span>
</span><span id="line-825"></span><span class="hs-comment">--</span><span>
</span><span id="line-826"></span><span class="hs-comment">-- PRECONDITION: the header (block) must exist in the VolatileDB.</span><span>
</span><span id="line-827"></span><span id="local-6989586621679901034"><span id="local-6989586621679901035"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-type">getKnownHeaderThroughCache</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-828"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679901034"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679901035"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-829"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-type">VolatileDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901035"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-830"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901035"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-831"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#StateT"><span class="hs-identifier hs-type">StateT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901035"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901035"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679901034"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901035"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-832"></span><span id="getKnownHeaderThroughCache"><span class="annot"><span class="annottext">getKnownHeaderThroughCache :: forall (m :: * -&gt; *) blk.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk
-&gt; HeaderHash blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getKnownHeaderThroughCache"><span class="hs-identifier hs-var hs-var">getKnownHeaderThroughCache</span></a></span></span><span> </span><span id="local-6989586621679902554"><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679902554"><span class="hs-identifier hs-var">volatileDB</span></a></span></span><span> </span><span id="local-6989586621679902555"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679902555"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map (HeaderHash blk) (Header blk) -&gt; Maybe (Header blk))
-&gt; StateT
     (Map (HeaderHash blk) (Header blk)) m (Maybe (Header blk))
forall (m :: * -&gt; *) s a. Monad m =&gt; (s -&gt; a) -&gt; StateT s m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; Map (HeaderHash blk) (Header blk) -&gt; Maybe (Header blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679902555"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StateT (Map (HeaderHash blk) (Header blk)) m (Maybe (Header blk))
-&gt; (Maybe (Header blk)
    -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall a b.
StateT (Map (HeaderHash blk) (Header blk)) m a
-&gt; (a -&gt; StateT (Map (HeaderHash blk) (Header blk)) m b)
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-833"></span><span>    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679902557"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902557"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Header blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall a. a -&gt; StateT (Map (HeaderHash blk) (Header blk)) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902557"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-834"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Header blk)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-835"></span><span>      </span><span id="local-6989586621679902558"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902558"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Header blk)
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (Map (HeaderHash blk) (Header blk)) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Header blk)
 -&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk))
-&gt; m (Header blk)
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
-&gt; BlockComponent blk (Header blk)
-&gt; HeaderHash blk
-&gt; m (Header blk)
forall (m :: * -&gt; *) blk b.
(MonadThrow m, HasHeader blk) =&gt;
VolatileDB m blk -&gt; BlockComponent blk b -&gt; HeaderHash blk -&gt; m b
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getKnownBlockComponent"><span class="hs-identifier hs-var">VolatileDB.getKnownBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679902554"><span class="hs-identifier hs-var">volatileDB</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk (Header blk)
forall blk. BlockComponent blk (Header blk)
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeader"><span class="hs-identifier hs-var">GetHeader</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679902555"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-836"></span><span>      </span><span class="annot"><span class="annottext">(Map (HeaderHash blk) (Header blk)
 -&gt; Map (HeaderHash blk) (Header blk))
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m ()
forall (m :: * -&gt; *) s. Monad m =&gt; (s -&gt; s) -&gt; StateT s m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.State.Strict.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; Header blk
-&gt; Map (HeaderHash blk) (Header blk)
-&gt; Map (HeaderHash blk) (Header blk)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#insert"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679902555"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902558"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span>      </span><span class="annot"><span class="annottext">Header blk
-&gt; StateT (Map (HeaderHash blk) (Header blk)) m (Header blk)
forall a. a -&gt; StateT (Map (HeaderHash blk) (Header blk)) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902558"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-838"></span><span>
</span><span id="line-839"></span><span class="annot"><span class="hs-comment">-- | Environment used by 'chainSelection' and related functions.</span></span><span>
</span><span id="line-840"></span><span class="hs-keyword">data</span><span> </span><span id="ChainSelEnv"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-var">ChainSelEnv</span></a></span></span><span> </span><span id="local-6989586621679901262"><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679901263"><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ChainSelEnv"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-var">ChainSelEnv</span></a></span></span><span>
</span><span id="line-841"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="lgrDB"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; LgrDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#lgrDB"><span class="hs-identifier hs-var hs-var">lgrDB</span></a></span></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDB"><span class="hs-identifier hs-type">LgrDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-842"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="validationTracer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; Tracer m (TraceValidationEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validationTracer"><span class="hs-identifier hs-var hs-var">validationTracer</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceValidationEvent"><span class="hs-identifier hs-type">TraceValidationEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pipeliningTracer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; Tracer m (TracePipeliningEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#pipeliningTracer"><span class="hs-identifier hs-var hs-var">pipeliningTracer</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TracePipeliningEvent"><span class="hs-identifier hs-type">TracePipeliningEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="bcfg"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#bcfg"><span class="hs-identifier hs-var hs-var">bcfg</span></a></span></span><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockConfig"><span class="hs-identifier hs-type">BlockConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-845"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="varInvalid"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varInvalid"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="varFutureBlocks"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (FutureBlocks m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varFutureBlocks"><span class="hs-identifier hs-var hs-var">varFutureBlocks</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#FutureBlocks"><span class="hs-identifier hs-type">FutureBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="varTentativeState"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (TentativeState blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varTentativeState"><span class="hs-identifier hs-var hs-var">varTentativeState</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.TentativeState.html#TentativeState"><span class="hs-identifier hs-type">TentativeState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-848"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="varTentativeHeader"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varTentativeHeader"><span class="hs-identifier hs-var hs-var">varTentativeHeader</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getTentativeFollowers"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; STM m [FollowerHandle m blk]
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#getTentativeFollowers"><span class="hs-identifier hs-var hs-var">getTentativeFollowers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#FollowerHandle"><span class="hs-identifier hs-type">FollowerHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-850"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="futureCheck"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; CheckInFuture m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheck"><span class="hs-identifier hs-var hs-var">futureCheck</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.InFuture.html#CheckInFuture"><span class="hs-identifier hs-type">CheckInFuture</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-851"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="blockCache"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#blockCache"><span class="hs-identifier hs-var hs-var">blockCache</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.BlockCache.html#BlockCache"><span class="hs-identifier hs-type">BlockCache</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-852"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="curChainAndLedger"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; ChainAndLedger blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#curChainAndLedger"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-type">ChainAndLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-853"></span><span>      </span><span class="hs-comment">-- | The block that this chain selection invocation is processing, and the</span><span>
</span><span id="line-854"></span><span>      </span><span class="hs-comment">-- punish action for the peer that sent that block; see</span><span>
</span><span id="line-855"></span><span>      </span><span class="hs-comment">-- 'InvalidBlockPunishment'.</span><span>
</span><span id="line-856"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-857"></span><span>      </span><span class="hs-comment">-- Two notable subtleties:</span><span>
</span><span id="line-858"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-859"></span><span>      </span><span class="hs-comment">-- o If a BlockFetch client adds an invalid block but that block isn't</span><span>
</span><span id="line-860"></span><span>      </span><span class="hs-comment">--   part of any desirable paths through the VolDB, then we won't attempt</span><span>
</span><span id="line-861"></span><span>      </span><span class="hs-comment">--   to validate it and so we won't discover it's invalid. The peer will</span><span>
</span><span id="line-862"></span><span>      </span><span class="hs-comment">--   not be punished. This seems acceptable, since it means we have turned</span><span>
</span><span id="line-863"></span><span>      </span><span class="hs-comment">--   our focus to a another peer offering better blocks and so this peer</span><span>
</span><span id="line-864"></span><span>      </span><span class="hs-comment">--   is no longer causing us BlockFetch work.</span><span>
</span><span id="line-865"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-866"></span><span>      </span><span class="hs-comment">-- o If the block is frome the future but with clock skew, we'll add it to</span><span>
</span><span id="line-867"></span><span>      </span><span class="hs-comment">--   'varFutureBlocks'. We retain the punishment information, so that if</span><span>
</span><span id="line-868"></span><span>      </span><span class="hs-comment">--   the peer is still active once we do process that block, we're still</span><span>
</span><span id="line-869"></span><span>      </span><span class="hs-comment">--   able to punish them.</span><span>
</span><span id="line-870"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-871"></span><span>      </span><span class="hs-comment">-- Thus invalid blocks can be skipped entirely or somewhat-arbitrarily</span><span>
</span><span id="line-872"></span><span>      </span><span class="hs-comment">-- delayed. This is part of the reason we bothered to restrict the</span><span>
</span><span id="line-873"></span><span>      </span><span class="hs-comment">-- expressiveness of the 'InvalidBlockPunishment' combiantors.</span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="punish"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; Maybe (RealPoint blk, InvalidBlockPunishment m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#punish"><span class="hs-identifier hs-var hs-var">punish</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901263"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier hs-type">InvalidBlockPunishment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901262"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-876"></span><span>
</span><span id="line-877"></span><span class="hs-comment">-- | Perform chain selection with the given candidates. If a validated</span><span>
</span><span id="line-878"></span><span class="hs-comment">-- candidate was chosen to replace the current chain, return it along with the</span><span>
</span><span id="line-879"></span><span class="hs-comment">-- corresponding ledger.</span><span>
</span><span id="line-880"></span><span class="hs-comment">--</span><span>
</span><span id="line-881"></span><span class="hs-comment">-- PRECONDITION: all candidates must be preferred over the current chain.</span><span>
</span><span id="line-882"></span><span class="hs-comment">--</span><span>
</span><span id="line-883"></span><span class="hs-comment">-- PRECONDITION: the candidate chain diffs must fit on the (given) current</span><span>
</span><span id="line-884"></span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-885"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-type">chainSelection</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-886"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679901059"><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679901060"><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-887"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-888"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-889"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-890"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-891"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-892"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-893"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-894"></span><span>     </span><span class="hs-comment">-- ^ The (valid) chain diff and corresponding LedgerDB that was selected,</span><span>
</span><span id="line-895"></span><span>     </span><span class="hs-comment">-- or 'Nothing' if there is no valid chain diff preferred over the current</span><span>
</span><span id="line-896"></span><span>     </span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-897"></span><span id="chainSelection"><span class="annot"><span class="annottext">chainSelection :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; NonEmpty (ChainDiff (Header blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#chainSelection"><span class="hs-identifier hs-var hs-var">chainSelection</span></a></span></span><span> </span><span id="local-6989586621679902673"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902673"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621679902674"><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902674"><span class="hs-identifier hs-var">chainDiffs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-898"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679902675"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902676"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-899"></span><span>                </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902674"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-900"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; NonEmpty (ChainDiff (Header blk)) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk)) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (AnchoredFragment (Header blk)) -&gt; Bool)
-&gt; (ChainDiff (Header blk)
    -&gt; Maybe (AnchoredFragment (Header blk)))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; ChainDiff (Header blk) -&gt; Maybe (AnchoredFragment (Header blk))
forall b.
HasHeader b =&gt;
AnchoredFragment b -&gt; ChainDiff b -&gt; Maybe (AnchoredFragment b)
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#apply"><span class="hs-identifier hs-var">Diff.apply</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902676"><span class="hs-identifier hs-var">curChain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-901"></span><span>                </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902674"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-902"></span><span>    </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621679902677"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902678"><span class="hs-identifier hs-var">sortCandidates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk)) -&gt; [ChainDiff (Header blk)]
forall a. NonEmpty a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html#toList"><span class="hs-identifier hs-var">NE.toList</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (ChainDiff (Header blk))
</span><a href="#local-6989586621679902674"><span class="hs-identifier hs-var">chainDiffs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-903"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-904"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679902675"><span id="local-6989586621679902679"><span id="local-6989586621679902680"><span id="local-6989586621679902681"><span id="local-6989586621679902682"><span id="local-6989586621679902683"><span id="local-6989586621679902684"><span id="local-6989586621679902685"><span id="local-6989586621679902686"><span id="local-6989586621679902687"><span id="local-6989586621679902688"><span id="local-6989586621679902689"><span id="local-6989586621679902690"><span class="annot"><span class="annottext">Maybe (RealPoint blk, InvalidBlockPunishment m)
Tracer m (TracePipeliningEvent blk)
Tracer m (TraceValidationEvent blk)
BlockConfig blk
STM m [FollowerHandle m blk]
StrictTVar m (FutureBlocks m blk)
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m (TentativeState blk)
StrictTVar m (StrictMaybe (Header blk))
BlockCache blk
ChainAndLedger blk
CheckInFuture m blk
LgrDB m blk
lgrDB :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; LgrDB m blk
bcfg :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockConfig blk
varInvalid :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
varFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (FutureBlocks m blk)
futureCheck :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; CheckInFuture m blk
blockCache :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockCache blk
curChainAndLedger :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; ChainAndLedger blk
validationTracer :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; Tracer m (TraceValidationEvent blk)
pipeliningTracer :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; Tracer m (TracePipeliningEvent blk)
varTentativeState :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (TentativeState blk)
varTentativeHeader :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
punish :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; Maybe (RealPoint blk, InvalidBlockPunishment m)
getTentativeFollowers :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; STM m [FollowerHandle m blk]
bcfg :: BlockConfig blk
lgrDB :: LgrDB m blk
validationTracer :: Tracer m (TraceValidationEvent blk)
pipeliningTracer :: Tracer m (TracePipeliningEvent blk)
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
varFutureBlocks :: StrictTVar m (FutureBlocks m blk)
varTentativeState :: StrictTVar m (TentativeState blk)
varTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
getTentativeFollowers :: STM m [FollowerHandle m blk]
futureCheck :: CheckInFuture m blk
blockCache :: BlockCache blk
curChainAndLedger :: ChainAndLedger blk
punish :: Maybe (RealPoint blk, InvalidBlockPunishment m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#lgrDB"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902673"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span>
</span><span id="line-905"></span><span>
</span><span id="line-906"></span><span>    </span><span id="local-6989586621679902676"><span class="annot"><span class="annottext">curChain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902676"><span class="hs-identifier hs-var hs-var">curChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902689"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span>    </span><span class="annot"><a href="#local-6989586621679902678"><span class="hs-identifier hs-type">sortCandidates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-909"></span><span>    </span><span id="local-6989586621679902678"><span class="annot"><span class="annottext">sortCandidates :: [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902678"><span class="hs-identifier hs-var hs-var">sortCandidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-910"></span><span>      </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; ChainDiff (Header blk) -&gt; Ordering)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; AnchoredFragment (Header blk) -&gt; Ordering)
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#compareAnchoredFragments"><span class="hs-identifier hs-var">compareAnchoredFragments</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679902675"><span class="hs-identifier hs-var">bcfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; AnchoredFragment (Header blk) -&gt; Ordering)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; ChainDiff (Header blk)
-&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span>    </span><span class="hs-comment">-- 1. Take the first candidate from the list of sorted candidates</span><span>
</span><span id="line-913"></span><span>    </span><span class="hs-comment">-- 2. Validate it</span><span>
</span><span id="line-914"></span><span>    </span><span class="hs-comment">--    - If it is invalid -&gt; discard it and go to 1 with the rest of the</span><span>
</span><span id="line-915"></span><span>    </span><span class="hs-comment">--      list.</span><span>
</span><span id="line-916"></span><span>    </span><span class="hs-comment">--    - If it is valid and has the same tip -&gt; return it</span><span>
</span><span id="line-917"></span><span>    </span><span class="hs-comment">--    - If it is valid, but is a prefix of the original -&gt;</span><span>
</span><span id="line-918"></span><span>    </span><span class="hs-comment">--        add it to the list, sort it and go to 1. See the comment</span><span>
</span><span id="line-919"></span><span>    </span><span class="hs-comment">--        [Ouroboros] below.</span><span>
</span><span id="line-920"></span><span>    </span><span class="annot"><a href="#local-6989586621679902677"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-921"></span><span>         </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-922"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>    </span><span id="local-6989586621679902677"><span class="annot"><span class="annottext">go :: [ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621679902677"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-924"></span><span>    </span><span class="annot"><a href="#local-6989586621679902677"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679902692"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902692"><span class="hs-identifier hs-var">candidate</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679902693"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902693"><span class="hs-identifier hs-var">candidates0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-925"></span><span>        </span><span id="local-6989586621679902694"><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902694"><span class="hs-identifier hs-var">mTentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679902695"><span class="hs-identifier hs-var">setTentativeHeader</span></a></span><span>
</span><span id="line-926"></span><span>        </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; ChainDiff (Header blk) -&gt; m (ValidationResult blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; ChainDiff (Header blk) -&gt; m (ValidationResult blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validateCandidate"><span class="hs-identifier hs-var">validateCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902673"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902692"><span class="hs-identifier hs-var">candidate</span></a></span><span> </span><span class="annot"><span class="annottext">m (ValidationResult blk)
-&gt; (ValidationResult blk
    -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-927"></span><span>          </span><span class="annot"><span class="annottext">ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-928"></span><span>            </span><span class="hs-comment">-- When the body of the tentative block turns out to be invalid, we</span><span>
</span><span id="line-929"></span><span>            </span><span class="hs-comment">-- have a valid *empty* prefix, as the tentative header fits on top</span><span>
</span><span id="line-930"></span><span>            </span><span class="hs-comment">-- of the current chain.</span><span>
</span><span id="line-931"></span><span>            </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictMaybe (Header blk) -&gt; Bool
forall a. StrictMaybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isSNothing</span></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902694"><span class="hs-identifier hs-var">mTentativeHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-932"></span><span>              </span><span id="local-6989586621679902698"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902698"><span class="hs-identifier hs-var">candidates1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902699"><span class="hs-identifier hs-var">truncateRejectedBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902693"><span class="hs-identifier hs-var">candidates0</span></a></span><span>
</span><span id="line-933"></span><span>              </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621679902677"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902678"><span class="hs-identifier hs-var">sortCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902698"><span class="hs-identifier hs-var">candidates1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-934"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#FullyValid"><span class="hs-identifier hs-type">FullyValid</span></a></span><span> </span><span id="local-6989586621679902701"><span class="annot"><span class="annottext">validatedCandidate :: ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902701"><span class="hs-identifier hs-var">validatedCandidate</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621679902702"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902702"><span class="hs-identifier hs-var">candidate'</span></a></span></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-935"></span><span>            </span><span class="hs-comment">-- The entire candidate is valid</span><span>
</span><span id="line-936"></span><span>            </span><span class="annot"><span class="annottext">Bool
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Point (Header blk)
forall b. HasHeader b =&gt; ChainDiff b -&gt; Point b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getTip"><span class="hs-identifier hs-var">Diff.getTip</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902692"><span class="hs-identifier hs-var">candidate</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Point (Header blk)
forall b. HasHeader b =&gt; ChainDiff b -&gt; Point b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getTip"><span class="hs-identifier hs-var">Diff.getTip</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902702"><span class="hs-identifier hs-var">candidate'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-937"></span><span>            </span><span class="annot"><span class="annottext">Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
 -&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))))
-&gt; Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902701"><span class="hs-identifier hs-var">validatedCandidate</span></a></span><span>
</span><span id="line-938"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-type">ValidPrefix</span></a></span><span> </span><span id="local-6989586621679902705"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902705"><span class="hs-identifier hs-var">candidate'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-939"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Header blk) -&gt; (Header blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictMaybe (Header blk) -&gt; Maybe (Header blk)
forall a. StrictMaybe a -&gt; Maybe a
</span><span class="hs-identifier hs-var">strictMaybeToMaybe</span></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902694"><span class="hs-identifier hs-var">mTentativeHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; m ()
</span><a href="#local-6989586621679902706"><span class="hs-identifier hs-var">clearTentativeHeader</span></a></span><span>
</span><span id="line-940"></span><span>            </span><span class="hs-comment">-- Prefix of the candidate because it contained rejected blocks</span><span>
</span><span id="line-941"></span><span>            </span><span class="hs-comment">-- (invalid blocks and/or blocks from the future). Note that the</span><span>
</span><span id="line-942"></span><span>            </span><span class="hs-comment">-- spec says go back to candidate selection, see [^whyGoBack],</span><span>
</span><span id="line-943"></span><span>            </span><span class="hs-comment">-- because there might still be some candidates that contain the</span><span>
</span><span id="line-944"></span><span>            </span><span class="hs-comment">-- same rejected block. To simplify the control flow, we do it</span><span>
</span><span id="line-945"></span><span>            </span><span class="hs-comment">-- differently: instead of recomputing the candidates taking</span><span>
</span><span id="line-946"></span><span>            </span><span class="hs-comment">-- rejected blocks into account, we just truncate the remaining</span><span>
</span><span id="line-947"></span><span>            </span><span class="hs-comment">-- candidates that contain rejected blocks.</span><span>
</span><span id="line-948"></span><span>            </span><span id="local-6989586621679902707"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902707"><span class="hs-identifier hs-var">candidates1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902699"><span class="hs-identifier hs-var">truncateRejectedBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902693"><span class="hs-identifier hs-var">candidates0</span></a></span><span>
</span><span id="line-949"></span><span>            </span><span class="hs-comment">-- Only include the prefix if it is still preferred over the current</span><span>
</span><span id="line-950"></span><span>            </span><span class="hs-comment">-- chain. When the candidate is now empty because of the truncation,</span><span>
</span><span id="line-951"></span><span>            </span><span class="hs-comment">-- it will be dropped here, as it will not be preferred over the</span><span>
</span><span id="line-952"></span><span>            </span><span class="hs-comment">-- current chain.</span><span>
</span><span id="line-953"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902708"><span class="annot"><span class="annottext">candidates2 :: [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902708"><span class="hs-identifier hs-var hs-var">candidates2</span></a></span></span><span>
</span><span id="line-954"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679902675"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902676"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902705"><span class="hs-identifier hs-var">candidate'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-955"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902705"><span class="hs-identifier hs-var">candidate'</span></a></span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902707"><span class="hs-identifier hs-var">candidates1</span></a></span><span>
</span><span id="line-956"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-957"></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902707"><span class="hs-identifier hs-var">candidates1</span></a></span><span>
</span><span id="line-958"></span><span>            </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
-&gt; m (Maybe (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="#local-6989586621679902677"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902678"><span class="hs-identifier hs-var">sortCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902708"><span class="hs-identifier hs-var">candidates2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-959"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-960"></span><span>        </span><span class="hs-comment">-- | Set and return the tentative header, if applicable. Also, notify</span><span>
</span><span id="line-961"></span><span>        </span><span class="hs-comment">-- the tentative followers.</span><span>
</span><span id="line-962"></span><span>        </span><span class="annot"><a href="#local-6989586621679902695"><span class="hs-identifier hs-type">setTentativeHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-963"></span><span>        </span><span id="local-6989586621679902695"><span class="annot"><span class="annottext">setTentativeHeader :: m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679902695"><span class="hs-identifier hs-var hs-var">setTentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-964"></span><span>            </span><span id="local-6989586621679902709"><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902709"><span class="hs-identifier hs-var">mTentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-965"></span><span>                  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679902710"><span class="annot"><span class="annottext">TentativeState blk
</span><a href="#local-6989586621679902710"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; TentativeState blk
-&gt; ChainDiff (Header blk)
-&gt; StrictMaybe (Header blk)
forall blk.
LedgerSupportsProtocol blk =&gt;
BlockConfig blk
-&gt; TentativeState blk
-&gt; ChainDiff (Header blk)
-&gt; StrictMaybe (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#isPipelineable"><span class="hs-identifier hs-var">isPipelineable</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679902675"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">TentativeState blk
</span><a href="#local-6989586621679902710"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902692"><span class="hs-identifier hs-var">candidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span>              </span><span class="annot"><span class="annottext">(TentativeState blk -&gt; StrictMaybe (Header blk))
-&gt; m (TentativeState blk) -&gt; m (StrictMaybe (Header blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk) -&gt; m (TentativeState blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk)
</span><a href="#local-6989586621679902684"><span class="hs-identifier hs-var">varTentativeState</span></a></span><span>
</span><span id="line-967"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Header blk) -&gt; (Header blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictMaybe (Header blk) -&gt; Maybe (Header blk)
forall a. StrictMaybe a -&gt; Maybe a
</span><span class="hs-identifier hs-var">strictMaybeToMaybe</span></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902709"><span class="hs-identifier hs-var">mTentativeHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Header blk -&gt; m ()) -&gt; m ()) -&gt; (Header blk -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679902713"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902713"><span class="hs-identifier hs-var">tentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-968"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902714"><span class="annot"><span class="annottext">setTentative :: Enclosing -&gt; TracePipeliningEvent blk
</span><a href="#local-6989586621679902714"><span class="hs-identifier hs-var hs-var">setTentative</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Enclosing -&gt; TracePipeliningEvent blk
forall blk. Header blk -&gt; Enclosing -&gt; TracePipeliningEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SetTentativeHeader"><span class="hs-identifier hs-var">SetTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902713"><span class="hs-identifier hs-var">tentativeHeader</span></a></span><span>
</span><span id="line-969"></span><span>              </span><span class="annot"><span class="annottext">Tracer m Enclosing -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Tracer m Enclosing -&gt; m a -&gt; m a
</span><a href="Ouroboros.Consensus.Util.Enclose.html#encloseWith"><span class="hs-identifier hs-var">encloseWith</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Enclosing -&gt; TracePipeliningEvent blk
</span><a href="#local-6989586621679902714"><span class="hs-identifier hs-var">setTentative</span></a></span><span> </span><span class="annot"><span class="annottext">(Enclosing -&gt; TracePipeliningEvent blk)
-&gt; Tracer m (TracePipeliningEvent blk) -&gt; Tracer m Enclosing
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TracePipeliningEvent blk)
</span><a href="#local-6989586621679902681"><span class="hs-identifier hs-var">pipeliningTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-970"></span><span>                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
-&gt; StrictMaybe (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679902685"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(StrictMaybe (Header blk) -&gt; STM m ())
-&gt; StrictMaybe (Header blk) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; StrictMaybe (Header blk)
forall a. a -&gt; StrictMaybe a
</span><span class="hs-identifier hs-var">SJust</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902713"><span class="hs-identifier hs-var">tentativeHeader</span></a></span><span>
</span><span id="line-971"></span><span>                </span><span class="hs-comment">-- As we are only extending the existing chain, the intersection</span><span>
</span><span id="line-972"></span><span>                </span><span class="hs-comment">-- point is not receding, in which case fhSwitchFork is not</span><span>
</span><span id="line-973"></span><span>                </span><span class="hs-comment">-- necessary.</span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span>              </span><span class="hs-comment">-- Just in case, explicitly yield to ensure that a capability (by</span><span>
</span><span id="line-976"></span><span>              </span><span class="hs-comment">-- default, the node uses just two) has the opportunity to switch</span><span>
</span><span id="line-977"></span><span>              </span><span class="hs-comment">-- to a ChainSync server thread.</span><span>
</span><span id="line-978"></span><span>              </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). MonadFork m =&gt; m ()
</span><span class="hs-identifier hs-var">yield</span></span><span>
</span><span id="line-979"></span><span>            </span><span class="annot"><span class="annottext">StrictMaybe (Header blk) -&gt; m (StrictMaybe (Header blk))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
</span><a href="#local-6989586621679902709"><span class="hs-identifier hs-var">mTentativeHeader</span></a></span><span>
</span><span id="line-980"></span><span>
</span><span id="line-981"></span><span>        </span><span class="hs-comment">-- | Clear a tentative header that turned out to be invalid. Also, roll</span><span>
</span><span id="line-982"></span><span>        </span><span class="hs-comment">-- back the tentative followers.</span><span>
</span><span id="line-983"></span><span>        </span><span class="annot"><a href="#local-6989586621679902706"><span class="hs-identifier hs-type">clearTentativeHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-984"></span><span>        </span><span id="local-6989586621679902706"><span class="annot"><span class="annottext">clearTentativeHeader :: Header blk -&gt; m ()
</span><a href="#local-6989586621679902706"><span class="hs-identifier hs-var hs-var">clearTentativeHeader</span></a></span></span><span> </span><span id="local-6989586621679902718"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902718"><span class="hs-identifier hs-var">tentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-985"></span><span>            </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-986"></span><span>              </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
-&gt; StrictMaybe (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679902685"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
forall a. StrictMaybe a
</span><span class="hs-identifier hs-var">SNothing</span></span><span>
</span><span id="line-987"></span><span>              </span><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk) -&gt; TentativeState blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk)
</span><a href="#local-6989586621679902684"><span class="hs-identifier hs-var">varTentativeState</span></a></span><span> </span><span class="annot"><span class="annottext">(TentativeState blk -&gt; STM m ()) -&gt; TentativeState blk -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-988"></span><span>                </span><span class="annot"><span class="annottext">SelectView (BlockProtocol blk) -&gt; TentativeState blk
forall blk. SelectView (BlockProtocol blk) -&gt; TentativeState blk
</span><a href="Ouroboros.Consensus.Util.TentativeState.html#LastInvalidTentative"><span class="hs-identifier hs-var">LastInvalidTentative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
forall blk.
BlockSupportsProtocol blk =&gt;
BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#selectView"><span class="hs-identifier hs-var">selectView</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679902675"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902718"><span class="hs-identifier hs-var">tentativeHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>              </span><span class="annot"><span class="annottext">(FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ()
</span><a href="#local-6989586621679902720"><span class="hs-identifier hs-var">forTentativeFollowers</span></a></span><span> </span><span class="annot"><span class="annottext">((FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ())
-&gt; (FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679902721"><span class="annot"><span class="annottext">FollowerHandle m blk
</span><a href="#local-6989586621679902721"><span class="hs-identifier hs-var">followerHandle</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-990"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902722"><span class="annot"><span class="annottext">curTipPoint :: Point blk
</span><a href="#local-6989586621679902722"><span class="hs-identifier hs-var hs-var">curTipPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902676"><span class="hs-identifier hs-var">curChain</span></a></span><span>
</span><span id="line-991"></span><span>                    </span><span id="local-6989586621679902723"><span class="annot"><span class="annottext">oldPoints :: Set (Point blk)
</span><a href="#local-6989586621679902723"><span class="hs-identifier hs-var hs-var">oldPoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Set (Point blk)
forall a. a -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#singleton"><span class="hs-identifier hs-var">Set.singleton</span></a></span><span> </span><span class="annot"><span class="annottext">(Point blk -&gt; Set (Point blk)) -&gt; Point blk -&gt; Set (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902718"><span class="hs-identifier hs-var">tentativeHeader</span></a></span><span>
</span><span id="line-992"></span><span>                </span><span class="annot"><span class="annottext">FollowerHandle m blk -&gt; Point blk -&gt; Set (Point blk) -&gt; STM m ()
forall (m :: * -&gt; *) blk.
FollowerHandle m blk -&gt; Point blk -&gt; Set (Point blk) -&gt; STM m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#fhSwitchFork"><span class="hs-identifier hs-var">fhSwitchFork</span></a></span><span> </span><span class="annot"><span class="annottext">FollowerHandle m blk
</span><a href="#local-6989586621679902721"><span class="hs-identifier hs-var">followerHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902722"><span class="hs-identifier hs-var">curTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point blk)
</span><a href="#local-6989586621679902723"><span class="hs-identifier hs-var">oldPoints</span></a></span><span>
</span><span id="line-993"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TracePipeliningEvent blk)
-&gt; TracePipeliningEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TracePipeliningEvent blk)
</span><a href="#local-6989586621679902681"><span class="hs-identifier hs-var">pipeliningTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TracePipeliningEvent blk -&gt; m ())
-&gt; TracePipeliningEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; TracePipeliningEvent blk
forall blk. Header blk -&gt; TracePipeliningEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TrapTentativeHeader"><span class="hs-identifier hs-var">TrapTentativeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902718"><span class="hs-identifier hs-var">tentativeHeader</span></a></span><span>
</span><span id="line-994"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-995"></span><span>            </span><span id="local-6989586621679902720"><span class="annot"><span class="annottext">forTentativeFollowers :: (FollowerHandle m blk -&gt; STM m ()) -&gt; STM m ()
</span><a href="#local-6989586621679902720"><span class="hs-identifier hs-var hs-var">forTentativeFollowers</span></a></span></span><span> </span><span id="local-6989586621679902726"><span class="annot"><span class="annottext">FollowerHandle m blk -&gt; STM m ()
</span><a href="#local-6989586621679902726"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m [FollowerHandle m blk]
</span><a href="#local-6989586621679902686"><span class="hs-identifier hs-var">getTentativeFollowers</span></a></span><span> </span><span class="annot"><span class="annottext">STM m [FollowerHandle m blk]
-&gt; ([FollowerHandle m blk] -&gt; STM m ()) -&gt; STM m ()
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">(FollowerHandle m blk -&gt; STM m ())
-&gt; [FollowerHandle m blk] -&gt; STM m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="annot"><span class="annottext">FollowerHandle m blk -&gt; STM m ()
</span><a href="#local-6989586621679902726"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-996"></span><span>
</span><span id="line-997"></span><span>    </span><span class="hs-comment">-- | Truncate the given (remaining) candidates that contain rejected</span><span>
</span><span id="line-998"></span><span>    </span><span class="hs-comment">-- blocks. Discard them if they are truncated so much that they are no</span><span>
</span><span id="line-999"></span><span>    </span><span class="hs-comment">-- longer preferred over the current chain.</span><span>
</span><span id="line-1000"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1001"></span><span>    </span><span class="hs-comment">-- A block is rejected if:</span><span>
</span><span id="line-1002"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1003"></span><span>    </span><span class="hs-comment">-- * It is invalid (present in 'varInvalid', i.e., 'cdbInvalid').</span><span>
</span><span id="line-1004"></span><span>    </span><span class="hs-comment">-- * It is from the future (present in 'varFutureBlocks', i.e.,</span><span>
</span><span id="line-1005"></span><span>    </span><span class="hs-comment">--   'cdbFutureBlocks').</span><span>
</span><span id="line-1006"></span><span>    </span><span class="annot"><a href="#local-6989586621679902699"><span class="hs-identifier hs-type">truncateRejectedBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1007"></span><span>         </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1008"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-1009"></span><span>    </span><span id="local-6989586621679902699"><span class="annot"><span class="annottext">truncateRejectedBlocks :: [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
</span><a href="#local-6989586621679902699"><span class="hs-identifier hs-var hs-var">truncateRejectedBlocks</span></a></span></span><span> </span><span id="local-6989586621679902728"><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902728"><span class="hs-identifier hs-var">cands</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1010"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679902729"><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk)
</span><a href="#local-6989586621679902729"><span class="hs-identifier hs-var">invalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902730"><span class="annot"><span class="annottext">FutureBlocks m blk
</span><a href="#local-6989586621679902730"><span class="hs-identifier hs-var">futureBlocks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1011"></span><span>        </span><span class="annot"><span class="annottext">STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk)
-&gt; m (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk)
 -&gt; m (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk)
-&gt; m (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (InvalidBlocks blk)
 -&gt; FutureBlocks m blk
 -&gt; (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
-&gt; STM
     m
     (FutureBlocks m blk
      -&gt; (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; STM m (WithFingerprint (InvalidBlocks blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679902682"><span class="hs-identifier hs-var">varInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m
  (FutureBlocks m blk
   -&gt; (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk))
-&gt; STM m (FutureBlocks m blk)
-&gt; STM m (WithFingerprint (InvalidBlocks blk), FutureBlocks m blk)
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk) -&gt; STM m (FutureBlocks m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (FutureBlocks m blk)
</span><a href="#local-6989586621679902683"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span>
</span><span id="line-1012"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902731"><span class="annot"><span class="annottext">isRejected :: Header blk -&gt; Bool
</span><a href="#local-6989586621679902731"><span class="hs-identifier hs-var hs-var">isRejected</span></a></span></span><span> </span><span id="local-6989586621679902732"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902732"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1013"></span><span>               </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#member"><span class="hs-identifier hs-var">Map.member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902732"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk) -&gt; InvalidBlocks blk
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">WithFingerprint (InvalidBlocks blk)
</span><a href="#local-6989586621679902729"><span class="hs-identifier hs-var">invalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1014"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; FutureBlocks m blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#member"><span class="hs-identifier hs-var">Map.member</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902732"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FutureBlocks m blk
</span><a href="#local-6989586621679902730"><span class="hs-identifier hs-var">futureBlocks</span></a></span><span>
</span><span id="line-1015"></span><span>      </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)])
-&gt; [ChainDiff (Header blk)] -&gt; m [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; Bool)
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679902675"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902676"><span class="hs-identifier hs-var">curChain</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk) -&gt; Bool)
-&gt; (ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk))
-&gt; ChainDiff (Header blk)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1016"></span><span>             </span><span class="annot"><span class="annottext">([ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)])
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk) -&gt; ChainDiff (Header blk))
-&gt; [ChainDiff (Header blk)] -&gt; [ChainDiff (Header blk)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Header blk -&gt; Bool)
-&gt; ChainDiff (Header blk) -&gt; ChainDiff (Header blk)
forall b. HasHeader b =&gt; (b -&gt; Bool) -&gt; ChainDiff b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#takeWhileOldest"><span class="hs-identifier hs-var">Diff.takeWhileOldest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Header blk -&gt; Bool) -&gt; Header blk -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Bool
</span><a href="#local-6989586621679902731"><span class="hs-identifier hs-var">isRejected</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ChainDiff (Header blk)]
</span><a href="#local-6989586621679902728"><span class="hs-identifier hs-var">cands</span></a></span><span>
</span><span id="line-1017"></span><span>
</span><span id="line-1018"></span><span>    </span><span class="hs-comment">-- [Ouroboros]</span><span>
</span><span id="line-1019"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1020"></span><span>    </span><span class="hs-comment">-- Ouroboros says that when we are given an invalid chain by a peer, we</span><span>
</span><span id="line-1021"></span><span>    </span><span class="hs-comment">-- should reject that peer's chain. However, since we're throwing all</span><span>
</span><span id="line-1022"></span><span>    </span><span class="hs-comment">-- blocks together in the ChainDB, we can't tell which block or which</span><span>
</span><span id="line-1023"></span><span>    </span><span class="hs-comment">-- chain came from which peer, so we can't simply reject a peer's chain.</span><span>
</span><span id="line-1024"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1025"></span><span>    </span><span class="hs-comment">-- It might be that a good peer gave us a valid chain, but another peer</span><span>
</span><span id="line-1026"></span><span>    </span><span class="hs-comment">-- gave us an invalid block that fits onto the chain of the good peer. In</span><span>
</span><span id="line-1027"></span><span>    </span><span class="hs-comment">-- that case, we do still want to adopt the chain of the good peer, which</span><span>
</span><span id="line-1028"></span><span>    </span><span class="hs-comment">-- is a prefix of the chain that we constructed using all the blocks we</span><span>
</span><span id="line-1029"></span><span>    </span><span class="hs-comment">-- found in the VolatileDB, including the invalid block.</span><span>
</span><span id="line-1030"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1031"></span><span>    </span><span class="hs-comment">-- This is the reason why we still take valid prefixes of a invalid chains</span><span>
</span><span id="line-1032"></span><span>    </span><span class="hs-comment">-- into account during chain selection: they might correspond to the good</span><span>
</span><span id="line-1033"></span><span>    </span><span class="hs-comment">-- peer's valid chain.</span><span>
</span><span id="line-1034"></span><span>
</span><span id="line-1035"></span><span class="annot"><span class="hs-comment">-- | Result of 'validateCandidate'.</span></span><span>
</span><span id="line-1036"></span><span class="hs-keyword">data</span><span> </span><span id="ValidationResult"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidationResult"><span class="hs-identifier hs-var">ValidationResult</span></a></span></span><span> </span><span id="local-6989586621679901458"><span class="annot"><a href="#local-6989586621679901458"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1037"></span><span>      </span><span class="hs-comment">-- | The entire candidate fragment was valid. No blocks were from the</span><span>
</span><span id="line-1038"></span><span>      </span><span class="hs-comment">-- future.</span><span>
</span><span id="line-1039"></span><span>      </span><span id="FullyValid"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#FullyValid"><span class="hs-identifier hs-var">FullyValid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901458"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901458"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1040"></span><span>
</span><span id="line-1041"></span><span>      </span><span class="hs-comment">-- | The candidate fragment contained invalid blocks and/or blocks from</span><span>
</span><span id="line-1042"></span><span>      </span><span class="hs-comment">-- the future that had to be truncated from the fragment.</span><span>
</span><span id="line-1043"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ValidPrefix"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-var">ValidPrefix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901458"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span>      </span><span class="hs-comment">-- | After truncating the invalid blocks or blocks from the future from</span><span>
</span><span id="line-1046"></span><span>      </span><span class="hs-comment">-- the 'ChainDiff', it no longer contains enough blocks in its suffix to</span><span>
</span><span id="line-1047"></span><span>      </span><span class="hs-comment">-- compensate for the number of blocks it wants to roll back.</span><span>
</span><span id="line-1048"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InsufficientSuffix"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span></span><span>
</span><span id="line-1049"></span><span>
</span><span id="line-1050"></span><span class="hs-comment">-- | Validate a candidate by applying its blocks to the ledger, and return a</span><span>
</span><span id="line-1051"></span><span class="hs-comment">-- 'ValidatedChainDiff' for it, i.e., a chain diff along with a ledger</span><span>
</span><span id="line-1052"></span><span class="hs-comment">-- corresponding to its tip (the most recent block).</span><span>
</span><span id="line-1053"></span><span class="hs-comment">--</span><span>
</span><span id="line-1054"></span><span class="hs-comment">-- PRECONDITION: the candidate (chain diff) must fit onto the given current</span><span>
</span><span id="line-1055"></span><span class="hs-comment">-- chain.</span><span>
</span><span id="line-1056"></span><span class="hs-comment">--</span><span>
</span><span id="line-1057"></span><span class="hs-comment">-- If all blocks in the fragment are valid, then the chain diff in the</span><span>
</span><span id="line-1058"></span><span class="hs-comment">-- returned 'ValidatedChainDiff' is the same as the given candidate chain</span><span>
</span><span id="line-1059"></span><span class="hs-comment">-- diff.</span><span>
</span><span id="line-1060"></span><span class="hs-comment">--</span><span>
</span><span id="line-1061"></span><span class="hs-comment">-- If a block in the fragment is invalid, then the fragment in the returned</span><span>
</span><span id="line-1062"></span><span class="hs-comment">-- 'ValidatedChainDiff' is a prefix of the given candidate chain diff (upto</span><span>
</span><span id="line-1063"></span><span class="hs-comment">-- the last valid block).</span><span>
</span><span id="line-1064"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ledgerValidateCandidate"><span class="hs-identifier hs-type">ledgerValidateCandidate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1065"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679901404"><span class="annot"><a href="#local-6989586621679901404"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679901405"><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1066"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901404"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1067"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1068"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-1069"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1070"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901404"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1072"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901404"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1073"></span><span id="ledgerValidateCandidate"><span class="annot"><span class="annottext">ledgerValidateCandidate :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; ChainDiff (Header blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ledgerValidateCandidate"><span class="hs-identifier hs-var hs-var">ledgerValidateCandidate</span></a></span></span><span> </span><span id="local-6989586621679902805"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902805"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621679902806"><span class="annot"><span class="annottext">chainDiff :: ChainDiff (Header blk)
</span><a href="#local-6989586621679902806"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span id="local-6989586621679902807"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679902807"><span class="hs-identifier hs-var">rollback</span></a></span></span><span> </span><span id="local-6989586621679902808"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902808"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1074"></span><span>    </span><span class="annot"><span class="annottext">LgrDB m blk
-&gt; LedgerDB' blk
-&gt; BlockCache blk
-&gt; Word64
-&gt; (UpdateLedgerDbTraceEvent blk -&gt; m ())
-&gt; [Header blk]
-&gt; m (ValidateResult blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
LgrDB m blk
-&gt; LedgerDB' blk
-&gt; BlockCache blk
-&gt; Word64
-&gt; (UpdateLedgerDbTraceEvent blk -&gt; m ())
-&gt; [Header blk]
-&gt; m (ValidateResult blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#validate"><span class="hs-identifier hs-var">LgrDB.validate</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679902810"><span class="hs-identifier hs-var">lgrDB</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902811"><span class="hs-identifier hs-var">curLedger</span></a></span><span> </span><span class="annot"><span class="annottext">BlockCache blk
</span><a href="#local-6989586621679902812"><span class="hs-identifier hs-var">blockCache</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679902807"><span class="hs-identifier hs-var">rollback</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateLedgerDbTraceEvent blk -&gt; m ()
</span><a href="#local-6989586621679902813"><span class="hs-identifier hs-var">traceUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621679902814"><span class="hs-identifier hs-var">newBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">m (ValidateResult blk)
-&gt; (ValidateResult blk
    -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1075"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#ValidateExceededRollBack"><span class="hs-identifier hs-type">LgrDB.ValidateExceededRollBack</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1076"></span><span>        </span><span class="hs-comment">-- Impossible: we asked the LgrDB to roll back past the immutable tip,</span><span>
</span><span id="line-1077"></span><span>        </span><span class="hs-comment">-- which is impossible, since the candidates we construct must connect</span><span>
</span><span id="line-1078"></span><span>        </span><span class="hs-comment">-- to the immutable tip.</span><span>
</span><span id="line-1079"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;found candidate requiring rolling back past the immutable tip&quot;</span></span><span>
</span><span id="line-1080"></span><span>
</span><span id="line-1081"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#ValidateLedgerError"><span class="hs-identifier hs-type">LgrDB.ValidateLedgerError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Update.html#AnnLedgerError"><span class="hs-identifier hs-type">LgrDB.AnnLedgerError</span></a></span><span> </span><span id="local-6989586621679902818"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902818"><span class="hs-identifier hs-var">ledger'</span></a></span></span><span> </span><span id="local-6989586621679902819"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902819"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621679902820"><span class="annot"><span class="annottext">LedgerErr (ExtLedgerState blk)
</span><a href="#local-6989586621679902820"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1082"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902821"><span class="annot"><span class="annottext">lastValid :: Point blk
</span><a href="#local-6989586621679902821"><span class="hs-identifier hs-var hs-var">lastValid</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; Point blk
forall blk. UpdateLedger blk =&gt; LedgerDB' blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#currentPoint"><span class="hs-identifier hs-var">LgrDB.currentPoint</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902818"><span class="hs-identifier hs-var">ledger'</span></a></span><span>
</span><span id="line-1083"></span><span>            </span><span id="local-6989586621679902822"><span class="annot"><span class="annottext">chainDiff' :: ChainDiff (Header blk)
</span><a href="#local-6989586621679902822"><span class="hs-identifier hs-var hs-var">chainDiff'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; ChainDiff (Header blk) -&gt; ChainDiff (Header blk)
forall b.
(HasHeader b, HasCallStack) =&gt;
Point b -&gt; ChainDiff b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#truncate"><span class="hs-identifier hs-var">Diff.truncate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902821"><span class="hs-identifier hs-var">lastValid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902806"><span class="hs-identifier hs-var">chainDiff</span></a></span><span>
</span><span id="line-1084"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
-&gt; TraceValidationEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
</span><a href="#local-6989586621679902824"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtValidationError blk -&gt; RealPoint blk -&gt; TraceValidationEvent blk
forall blk.
ExtValidationError blk -&gt; RealPoint blk -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerErr (ExtLedgerState blk)
ExtValidationError blk
</span><a href="#local-6989586621679902820"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902819"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span>        </span><span class="annot"><span class="annottext">ExtValidationError blk -&gt; RealPoint blk -&gt; m ()
</span><a href="#local-6989586621679902826"><span class="hs-identifier hs-var">addInvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerErr (ExtLedgerState blk)
ExtValidationError blk
</span><a href="#local-6989586621679902820"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902819"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1086"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
-&gt; TraceValidationEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
</span><a href="#local-6989586621679902824"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ValidCandidate"><span class="hs-identifier hs-var">ValidCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; AnchoredFragment (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902822"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1087"></span><span>
</span><span id="line-1088"></span><span>        </span><span class="hs-comment">-- punish the peer who sent a block if it is invalid or a block from its</span><span>
</span><span id="line-1089"></span><span>        </span><span class="hs-comment">-- prefix is invalid</span><span>
</span><span id="line-1090"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1091"></span><span>        </span><span class="hs-comment">-- Note that it is a chain selection invariant that all candidates</span><span>
</span><span id="line-1092"></span><span>        </span><span class="hs-comment">-- involve the block being processed: see Lemma 11.1 (Properties of the</span><span>
</span><span id="line-1093"></span><span>        </span><span class="hs-comment">-- set of candidates) in the Chain Selection chapter of the The Cardano</span><span>
</span><span id="line-1094"></span><span>        </span><span class="hs-comment">-- Consensus and Storage Layer technical report.</span><span>
</span><span id="line-1095"></span><span>        </span><span class="annot"><span class="annottext">Maybe (RealPoint blk, InvalidBlockPunishment m)
-&gt; ((RealPoint blk, InvalidBlockPunishment m) -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (RealPoint blk, InvalidBlockPunishment m)
</span><a href="#local-6989586621679902828"><span class="hs-identifier hs-var">punish</span></a></span><span> </span><span class="annot"><span class="annottext">(((RealPoint blk, InvalidBlockPunishment m) -&gt; m ()) -&gt; m ())
-&gt; ((RealPoint blk, InvalidBlockPunishment m) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679902829"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902829"><span class="hs-identifier hs-var">addedPt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902830"><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679902830"><span class="hs-identifier hs-var">punishment</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1096"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902831"><span class="annot"><span class="annottext">m :: m ()
</span><a href="#local-6989586621679902831"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
forall (m :: * -&gt; *).
InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#enact"><span class="hs-identifier hs-var">InvalidBlockPunishment.enact</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679902830"><span class="hs-identifier hs-var">punishment</span></a></span><span>
</span><span id="line-1097"></span><span>                </span><span class="annot"><span class="annottext">(Invalidity -&gt; m ()) -&gt; Invalidity -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902829"><span class="hs-identifier hs-var">addedPt</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; RealPoint blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902819"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1098"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Invalidity
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#BlockItself"><span class="hs-identifier hs-var">InvalidBlockPunishment.BlockItself</span></a></span><span>
</span><span id="line-1099"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Invalidity
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#BlockPrefix"><span class="hs-identifier hs-var">InvalidBlockPunishment.BlockPrefix</span></a></span><span>
</span><span id="line-1100"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; SlotNo
forall blk. RealPoint blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointSlot"><span class="hs-identifier hs-var">realPointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902819"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; SlotNo -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#compare"><span class="hs-operator hs-var">`compare`</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; SlotNo
forall blk. RealPoint blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointSlot"><span class="hs-identifier hs-var">realPointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902829"><span class="hs-identifier hs-var">addedPt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1101"></span><span>            </span><span class="annot"><span class="annottext">Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#LT"><span class="hs-identifier hs-var">LT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679902831"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1102"></span><span>            </span><span class="annot"><span class="annottext">Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#GT"><span class="hs-identifier hs-var">GT</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1103"></span><span>            </span><span class="annot"><span class="annottext">Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#EQ"><span class="hs-identifier hs-var">EQ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679902821"><span class="hs-identifier hs-var">lastValid</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; Point blk
forall blk. RealPoint blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointToPoint"><span class="hs-identifier hs-var">realPointToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679902829"><span class="hs-identifier hs-var">addedPt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679902831"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1104"></span><span>              </span><span class="hs-comment">-- If pt and addedPt have the same slot, and addedPt is the tip of</span><span>
</span><span id="line-1105"></span><span>              </span><span class="hs-comment">-- the ledger that pt was validated against, then addedPt is an</span><span>
</span><span id="line-1106"></span><span>              </span><span class="hs-comment">-- EBB and is valid.</span><span>
</span><span id="line-1107"></span><span>              </span><span class="hs-comment">--</span><span>
</span><span id="line-1108"></span><span>              </span><span class="hs-comment">-- Otherwise, either pt == addedPt or addedPt comes after pt, so</span><span>
</span><span id="line-1109"></span><span>              </span><span class="hs-comment">-- we should punish. (Tacit assumption made here: it's impossible</span><span>
</span><span id="line-1110"></span><span>              </span><span class="hs-comment">-- three blocks in a row have the same slot.)</span><span>
</span><span id="line-1111"></span><span>
</span><span id="line-1112"></span><span>        </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidatedChainDiff (Header blk) (LedgerDB' blk)
 -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; LedgerDB' blk -&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
forall b l.
(GetTip l, HasHeader b, HeaderHash l ~ HeaderHash b,
 HasCallStack) =&gt;
ChainDiff b -&gt; l -&gt; ValidatedChainDiff b l
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#new"><span class="hs-identifier hs-var">ValidatedDiff.new</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902822"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902818"><span class="hs-identifier hs-var">ledger'</span></a></span><span>
</span><span id="line-1113"></span><span>
</span><span id="line-1114"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#ValidateSuccessful"><span class="hs-identifier hs-type">LgrDB.ValidateSuccessful</span></a></span><span> </span><span id="local-6989586621679902838"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902838"><span class="hs-identifier hs-var">ledger'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1115"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
-&gt; TraceValidationEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
</span><a href="#local-6989586621679902824"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk) -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ValidCandidate"><span class="hs-identifier hs-var">ValidCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902808"><span class="hs-identifier hs-var">suffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1116"></span><span>        </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidatedChainDiff (Header blk) (LedgerDB' blk)
 -&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; LedgerDB' blk -&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
forall b l.
(GetTip l, HasHeader b, HeaderHash l ~ HeaderHash b,
 HasCallStack) =&gt;
ChainDiff b -&gt; l -&gt; ValidatedChainDiff b l
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#new"><span class="hs-identifier hs-var">ValidatedDiff.new</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902806"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679902838"><span class="hs-identifier hs-var">ledger'</span></a></span><span>
</span><span id="line-1117"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1118"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1119"></span><span>        </span><span id="local-6989586621679902810"><span class="annot"><span class="annottext">LgrDB m blk
lgrDB :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; LgrDB m blk
lgrDB :: LgrDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#lgrDB"><span class="hs-identifier hs-var hs-var">lgrDB</span></a></span></span><span>
</span><span id="line-1120"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902824"><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
validationTracer :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; Tracer m (TraceValidationEvent blk)
validationTracer :: Tracer m (TraceValidationEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validationTracer"><span class="hs-identifier hs-var hs-var">validationTracer</span></a></span></span><span>
</span><span id="line-1121"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902839"><span class="annot"><span class="annottext">ChainAndLedger blk
curChainAndLedger :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; ChainAndLedger blk
curChainAndLedger :: ChainAndLedger blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#curChainAndLedger"><span class="hs-identifier hs-var hs-var">curChainAndLedger</span></a></span></span><span>
</span><span id="line-1122"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902812"><span class="annot"><span class="annottext">BlockCache blk
blockCache :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; BlockCache blk
blockCache :: BlockCache blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#blockCache"><span class="hs-identifier hs-var hs-var">blockCache</span></a></span></span><span>
</span><span id="line-1123"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902840"><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varInvalid"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span></span><span>
</span><span id="line-1124"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902828"><span class="annot"><span class="annottext">Maybe (RealPoint blk, InvalidBlockPunishment m)
punish :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; Maybe (RealPoint blk, InvalidBlockPunishment m)
punish :: Maybe (RealPoint blk, InvalidBlockPunishment m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#punish"><span class="hs-identifier hs-var hs-var">punish</span></a></span></span><span>
</span><span id="line-1125"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902805"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span>    </span><span id="local-6989586621679902813"><span class="annot"><span class="annottext">traceUpdate :: UpdateLedgerDbTraceEvent blk -&gt; m ()
</span><a href="#local-6989586621679902813"><span class="hs-identifier hs-var hs-var">traceUpdate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (UpdateLedgerDbTraceEvent blk)
-&gt; UpdateLedgerDbTraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">(Tracer m (UpdateLedgerDbTraceEvent blk)
 -&gt; UpdateLedgerDbTraceEvent blk -&gt; m ())
-&gt; Tracer m (UpdateLedgerDbTraceEvent blk)
-&gt; UpdateLedgerDbTraceEvent blk
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateLedgerDbTraceEvent blk -&gt; TraceValidationEvent blk
forall blk.
UpdateLedgerDbTraceEvent blk -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#UpdateLedgerDbTraceEvent"><span class="hs-identifier hs-var">UpdateLedgerDbTraceEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(UpdateLedgerDbTraceEvent blk -&gt; TraceValidationEvent blk)
-&gt; Tracer m (TraceValidationEvent blk)
-&gt; Tracer m (UpdateLedgerDbTraceEvent blk)
forall (f :: * -&gt; *) a b. Contravariant f =&gt; (a -&gt; b) -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#%3E%24%3C"><span class="hs-operator hs-var">&gt;$&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
</span><a href="#local-6989586621679902824"><span class="hs-identifier hs-var">validationTracer</span></a></span><span>
</span><span id="line-1128"></span><span>
</span><span id="line-1129"></span><span>    </span><span class="annot"><a href="#local-6989586621679902811"><span class="hs-identifier hs-type">curLedger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1130"></span><span>    </span><span id="local-6989586621679902811"><span class="annot"><span class="annottext">curLedger :: LedgerDB' blk
</span><a href="#local-6989586621679902811"><span class="hs-identifier hs-var hs-var">curLedger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; LedgerDB' blk
forall b l. ValidatedFragment b l -&gt; l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedLedger"><span class="hs-identifier hs-var">VF.validatedLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679902839"><span class="hs-identifier hs-var">curChainAndLedger</span></a></span><span>
</span><span id="line-1131"></span><span>
</span><span id="line-1132"></span><span>    </span><span class="annot"><a href="#local-6989586621679902814"><span class="hs-identifier hs-type">newBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1133"></span><span>    </span><span id="local-6989586621679902814"><span class="annot"><span class="annottext">newBlocks :: [Header blk]
</span><a href="#local-6989586621679902814"><span class="hs-identifier hs-var hs-var">newBlocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AF.toOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902808"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-1134"></span><span>
</span><span id="line-1135"></span><span>    </span><span class="hs-comment">-- | Record the invalid block in 'cdbInvalid' and change its fingerprint.</span><span>
</span><span id="line-1136"></span><span>    </span><span class="annot"><a href="#local-6989586621679902826"><span class="hs-identifier hs-type">addInvalidBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtValidationError"><span class="hs-identifier hs-type">ExtValidationError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901405"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901404"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1137"></span><span>    </span><span id="local-6989586621679902826"><span class="annot"><span class="annottext">addInvalidBlock :: ExtValidationError blk -&gt; RealPoint blk -&gt; m ()
</span><a href="#local-6989586621679902826"><span class="hs-identifier hs-var hs-var">addInvalidBlock</span></a></span></span><span> </span><span id="local-6989586621679902842"><span class="annot"><span class="annottext">ExtValidationError blk
</span><a href="#local-6989586621679902842"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span id="local-6989586621679902844"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679902844"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621679902845"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679902845"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1138"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; (WithFingerprint (InvalidBlocks blk)
    -&gt; WithFingerprint (InvalidBlocks blk))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (WithFingerprint (InvalidBlocks blk))
</span><a href="#local-6989586621679902840"><span class="hs-identifier hs-var">varInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">((WithFingerprint (InvalidBlocks blk)
  -&gt; WithFingerprint (InvalidBlocks blk))
 -&gt; STM m ())
-&gt; (WithFingerprint (InvalidBlocks blk)
    -&gt; WithFingerprint (InvalidBlocks blk))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span id="local-6989586621679902848"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679902848"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621679902849"><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621679902849"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1139"></span><span>        </span><span class="annot"><span class="annottext">InvalidBlocks blk
-&gt; Fingerprint -&gt; WithFingerprint (InvalidBlocks blk)
forall a. a -&gt; Fingerprint -&gt; WithFingerprint a
</span><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-var">WithFingerprint</span></a></span><span>
</span><span id="line-1140"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; InvalidBlockInfo blk -&gt; InvalidBlocks blk -&gt; InvalidBlocks blk
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#insert"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679902845"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
forall blk.
InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-var">InvalidBlockInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtValidationError blk -&gt; InvalidBlockReason blk
forall blk. ExtValidationError blk -&gt; InvalidBlockReason blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ValidationError"><span class="hs-identifier hs-var">ValidationError</span></a></span><span> </span><span class="annot"><span class="annottext">ExtValidationError blk
</span><a href="#local-6989586621679902842"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679902844"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679902848"><span class="hs-identifier hs-var">invalid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1141"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fingerprint -&gt; Fingerprint
forall a. Enum a =&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Enum.html#succ"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621679902849"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1142"></span><span>
</span><span id="line-1143"></span><span class="hs-comment">-- | Truncate any future headers from the candidate 'ValidatedChainDiff'.</span><span>
</span><span id="line-1144"></span><span class="hs-comment">--</span><span>
</span><span id="line-1145"></span><span class="hs-comment">-- Future headers that don't exceed the clock skew</span><span>
</span><span id="line-1146"></span><span class="hs-comment">-- ('inFutureExceedsClockSkew') are added to 'cdbFutureBlocks'.</span><span>
</span><span id="line-1147"></span><span class="hs-comment">--</span><span>
</span><span id="line-1148"></span><span class="hs-comment">-- Future headers that exceed the clock skew are added to 'cdbInvalid' with</span><span>
</span><span id="line-1149"></span><span class="hs-comment">-- 'InFutureExceedsClockSkew' as the reason.</span><span>
</span><span id="line-1150"></span><span class="hs-comment">--</span><span>
</span><span id="line-1151"></span><span class="hs-comment">-- When truncation happened, 'Left' is returned, otherwise 'Right'.</span><span>
</span><span id="line-1152"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheckCandidate"><span class="hs-identifier hs-type">futureCheckCandidate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1153"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679901429"><span class="annot"><a href="#local-6989586621679901429"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679901430"><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901429"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1154"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901429"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1155"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1156"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901429"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1157"></span><span>               </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1158"></span><span id="futureCheckCandidate"><span class="annot"><span class="annottext">futureCheckCandidate :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ChainSelEnv m blk
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheckCandidate"><span class="hs-identifier hs-var hs-var">futureCheckCandidate</span></a></span></span><span> </span><span id="local-6989586621679902928"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902928"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621679902929"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))
</span><a href="#local-6989586621679902929"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1159"></span><span>    </span><span class="annot"><span class="annottext">CheckInFuture m blk
-&gt; ValidatedFragment (Header blk) (LedgerState blk)
-&gt; m (AnchoredFragment (Header blk), [InFuture m blk])
forall (m :: * -&gt; *) blk.
CheckInFuture m blk
-&gt; ValidatedFragment (Header blk) (LedgerState blk)
-&gt; m (AnchoredFragment (Header blk), [InFuture m blk])
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#checkInFuture"><span class="hs-identifier hs-var">checkInFuture</span></a></span><span> </span><span class="annot"><span class="annottext">CheckInFuture m blk
</span><a href="#local-6989586621679902931"><span class="hs-identifier hs-var">futureCheck</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedFragment (Header blk) (LedgerState blk)
</span><a href="#local-6989586621679902932"><span class="hs-identifier hs-var">validatedSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">m (AnchoredFragment (Header blk), [InFuture m blk])
-&gt; ((AnchoredFragment (Header blk), [InFuture m blk])
    -&gt; m (Either
            (ChainDiff (Header blk))
            (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679902933"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902933"><span class="hs-identifier hs-var">suffix'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1162"></span><span>        </span><span class="hs-comment">-- If no headers are in the future, then the fragment must be untouched</span><span>
</span><span id="line-1163"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902934"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902933"><span class="hs-identifier hs-var">suffix'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Either
      (ChainDiff (Header blk))
      (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
 -&gt; m (Either
         (ChainDiff (Header blk))
         (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1164"></span><span>        </span><span class="annot"><span class="annottext">Either
  (ChainDiff (Header blk))
  (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (ChainDiff (Header blk))
   (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
 -&gt; m (Either
         (ChainDiff (Header blk))
         (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))))
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))
</span><a href="#local-6989586621679902929"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-1165"></span><span>
</span><span id="line-1166"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679902935"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902935"><span class="hs-identifier hs-var">suffix'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902936"><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902936"><span class="hs-identifier hs-var">inFuture</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1167"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679902937"><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902937"><span class="hs-identifier hs-var">exceedClockSkew</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902938"><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902938"><span class="hs-identifier hs-var">inNearFuture</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1168"></span><span>              </span><span class="annot"><span class="annottext">(InFuture m blk -&gt; Bool)
-&gt; [InFuture m blk] -&gt; ([InFuture m blk], [InFuture m blk])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#partition"><span class="hs-identifier hs-var">partition</span></a></span><span> </span><span class="annot"><span class="annottext">InFuture m blk -&gt; Bool
forall (m :: * -&gt; *) blk. InFuture m blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFutureExceedsClockSkew"><span class="hs-identifier hs-var">InFuture.inFutureExceedsClockSkew</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902936"><span class="hs-identifier hs-var">inFuture</span></a></span><span>
</span><span id="line-1169"></span><span>        </span><span class="hs-comment">-- Record future blocks</span><span>
</span><span id="line-1170"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InFuture m blk] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902938"><span class="hs-identifier hs-var">inNearFuture</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1171"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902941"><span class="annot"><span class="annottext">futureBlocks :: Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
</span><a href="#local-6989586621679902941"><span class="hs-identifier hs-var hs-var">futureBlocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(HeaderHash blk, (Header blk, InvalidBlockPunishment m))]
-&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#fromList"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-1172"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902943"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902943"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InFuture m blk -&gt; InvalidBlockPunishment m
forall (m :: * -&gt; *) blk.
InFuture m blk -&gt; InvalidBlockPunishment m
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFuturePunish"><span class="hs-identifier hs-var">InFuture.inFuturePunish</span></a></span><span> </span><span class="annot"><span class="annottext">InFuture m blk
</span><a href="#local-6989586621679902945"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1173"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679902945"><span class="annot"><span class="annottext">InFuture m blk
</span><a href="#local-6989586621679902945"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902938"><span class="hs-identifier hs-var">inNearFuture</span></a></span><span>
</span><span id="line-1174"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902943"><span class="annot"><span class="annottext">hdr :: Header blk
</span><a href="#local-6989586621679902943"><span class="hs-identifier hs-var hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InFuture m blk -&gt; Header blk
forall (m :: * -&gt; *) blk. InFuture m blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFutureHeader"><span class="hs-identifier hs-var">InFuture.inFutureHeader</span></a></span><span> </span><span class="annot"><span class="annottext">InFuture m blk
</span><a href="#local-6989586621679902945"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-1175"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-1176"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
-&gt; (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
    -&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
</span><a href="#local-6989586621679902947"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">((Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
  -&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
 -&gt; STM m ())
-&gt; (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
    -&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
 -&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
 -&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
-&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
-&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
-&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
-&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
-&gt; Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#union"><span class="hs-identifier hs-var">Map.union</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
</span><a href="#local-6989586621679902941"><span class="hs-identifier hs-var">futureBlocks</span></a></span><span>
</span><span id="line-1177"></span><span>          </span><span class="hs-comment">-- Trace the original @suffix@, as it contains the headers from the</span><span>
</span><span id="line-1178"></span><span>          </span><span class="hs-comment">-- future</span><span>
</span><span id="line-1179"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
-&gt; TraceValidationEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
</span><a href="#local-6989586621679902949"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; m ())
-&gt; TraceValidationEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1180"></span><span>            </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CandidateContainsFutureBlocks"><span class="hs-identifier hs-var">CandidateContainsFutureBlocks</span></a></span><span>
</span><span id="line-1181"></span><span>              </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902934"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-1182"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InFuture m blk -&gt; Header blk
forall (m :: * -&gt; *) blk. InFuture m blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFutureHeader"><span class="hs-identifier hs-var">InFuture.inFutureHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(InFuture m blk -&gt; Header blk) -&gt; [InFuture m blk] -&gt; [Header blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902938"><span class="hs-identifier hs-var">inNearFuture</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1183"></span><span>
</span><span id="line-1184"></span><span>        </span><span class="hs-comment">-- Record any blocks exceeding the clock skew as invalid</span><span>
</span><span id="line-1185"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[InFuture m blk] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902937"><span class="hs-identifier hs-var">exceedClockSkew</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1186"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902951"><span class="annot"><span class="annottext">invalidHeaders :: [Header blk]
</span><a href="#local-6989586621679902951"><span class="hs-identifier hs-var hs-var">invalidHeaders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InFuture m blk -&gt; Header blk
forall (m :: * -&gt; *) blk. InFuture m blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFutureHeader"><span class="hs-identifier hs-var">InFuture.inFutureHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(InFuture m blk -&gt; Header blk) -&gt; [InFuture m blk] -&gt; [Header blk]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902937"><span class="hs-identifier hs-var">exceedClockSkew</span></a></span><span>
</span><span id="line-1187"></span><span>              </span><span id="local-6989586621679902952"><span class="annot"><span class="annottext">invalidBlocks :: Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621679902952"><span class="hs-identifier hs-var hs-var">invalidBlocks</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(HeaderHash blk, InvalidBlockInfo blk)]
-&gt; Map (HeaderHash blk) (InvalidBlockInfo blk)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#fromList"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span>
</span><span id="line-1188"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902953"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidBlockInfo blk
</span><a href="#local-6989586621679902954"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1189"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679902953"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902953"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621679902951"><span class="hs-identifier hs-var">invalidHeaders</span></a></span><span>
</span><span id="line-1190"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679902955"><span class="annot"><span class="annottext">reason :: InvalidBlockReason blk
</span><a href="#local-6989586621679902955"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; InvalidBlockReason blk
forall blk. RealPoint blk -&gt; InvalidBlockReason blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InFutureExceedsClockSkew"><span class="hs-identifier hs-var">InFutureExceedsClockSkew</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk.
(HasHeader blk, HasHeader (Header blk)) =&gt;
Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902953"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1191"></span><span>                      </span><span id="local-6989586621679902954"><span class="annot"><span class="annottext">info :: InvalidBlockInfo blk
</span><a href="#local-6989586621679902954"><span class="hs-identifier hs-var hs-var">info</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
forall blk.
InvalidBlockReason blk -&gt; SlotNo -&gt; InvalidBlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlockInfo"><span class="hs-identifier hs-var">InvalidBlockInfo</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679902955"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><span class="hs-identifier hs-var">blockSlot</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679902953"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1192"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-1193"></span><span>          </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
-&gt; (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
    -&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
</span><a href="#local-6989586621679902956"><span class="hs-identifier hs-var">varInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">((WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
  -&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
 -&gt; STM m ())
-&gt; (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
    -&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span id="local-6989586621679902957"><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621679902957"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621679902958"><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621679902958"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1194"></span><span>            </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
-&gt; Fingerprint
-&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
forall a. a -&gt; Fingerprint -&gt; WithFingerprint a
</span><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-var">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
-&gt; Map (HeaderHash blk) (InvalidBlockInfo blk)
-&gt; Map (HeaderHash blk) (InvalidBlockInfo blk)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#union"><span class="hs-identifier hs-var">Map.union</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621679902957"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
</span><a href="#local-6989586621679902952"><span class="hs-identifier hs-var">invalidBlocks</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fingerprint -&gt; Fingerprint
forall a. Enum a =&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Enum.html#succ"><span class="hs-identifier hs-var">succ</span></a></span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621679902958"><span class="hs-identifier hs-var">fp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1195"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
-&gt; TraceValidationEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
</span><a href="#local-6989586621679902949"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceValidationEvent blk -&gt; m ())
-&gt; TraceValidationEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1196"></span><span>            </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
forall blk.
AnchoredFragment (Header blk)
-&gt; [Header blk] -&gt; TraceValidationEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CandidateContainsFutureBlocksExceedingClockSkew"><span class="hs-identifier hs-var">CandidateContainsFutureBlocksExceedingClockSkew</span></a></span><span>
</span><span id="line-1197"></span><span>              </span><span class="hs-comment">-- Trace the original @suffix@, as it contains the headers</span><span>
</span><span id="line-1198"></span><span>              </span><span class="hs-comment">-- from the future</span><span>
</span><span id="line-1199"></span><span>              </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902934"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-1200"></span><span>              </span><span class="annot"><span class="annottext">[Header blk]
</span><a href="#local-6989586621679902951"><span class="hs-identifier hs-var">invalidHeaders</span></a></span><span>
</span><span id="line-1201"></span><span>
</span><span id="line-1202"></span><span>          </span><span class="hs-comment">-- It's possible the block's prefix is invalid, but we can't know for</span><span>
</span><span id="line-1203"></span><span>          </span><span class="hs-comment">-- sure. So we use 'InvalidBlockPunishment.BlockItself' to be more</span><span>
</span><span id="line-1204"></span><span>          </span><span class="hs-comment">-- conservative.</span><span>
</span><span id="line-1205"></span><span>          </span><span class="annot"><span class="annottext">[InFuture m blk] -&gt; (InFuture m blk -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[InFuture m blk]
</span><a href="#local-6989586621679902937"><span class="hs-identifier hs-var">exceedClockSkew</span></a></span><span> </span><span class="annot"><span class="annottext">((InFuture m blk -&gt; m ()) -&gt; m ())
-&gt; (InFuture m blk -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679902960"><span class="annot"><span class="annottext">InFuture m blk
</span><a href="#local-6989586621679902960"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1206"></span><span>            </span><span class="annot"><span class="annottext">InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
forall (m :: * -&gt; *).
InvalidBlockPunishment m -&gt; Invalidity -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#enact"><span class="hs-identifier hs-var">InvalidBlockPunishment.enact</span></a></span><span>
</span><span id="line-1207"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InFuture m blk -&gt; InvalidBlockPunishment m
forall (m :: * -&gt; *) blk.
InFuture m blk -&gt; InvalidBlockPunishment m
</span><a href="Ouroboros.Consensus.Fragment.InFuture.html#inFuturePunish"><span class="hs-identifier hs-var">InFuture.inFuturePunish</span></a></span><span> </span><span class="annot"><span class="annottext">InFuture m blk
</span><a href="#local-6989586621679902960"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1208"></span><span>              </span><span class="annot"><span class="annottext">Invalidity
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#BlockItself"><span class="hs-identifier hs-var">InvalidBlockPunishment.BlockItself</span></a></span><span>
</span><span id="line-1209"></span><span>
</span><span id="line-1210"></span><span>        </span><span class="hs-comment">-- Truncate the original 'ChainDiff' to match the truncated</span><span>
</span><span id="line-1211"></span><span>        </span><span class="hs-comment">-- 'AnchoredFragment'.</span><span>
</span><span id="line-1212"></span><span>        </span><span class="annot"><span class="annottext">Either
  (ChainDiff (Header blk))
  (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (ChainDiff (Header blk))
   (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
 -&gt; m (Either
         (ChainDiff (Header blk))
         (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))))
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDiff (Header blk)
 -&gt; Either
      (ChainDiff (Header blk))
      (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))))
-&gt; ChainDiff (Header blk)
-&gt; Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; ChainDiff (Header blk) -&gt; ChainDiff (Header blk)
forall b.
(HasHeader b, HasCallStack) =&gt;
Point b -&gt; ChainDiff b -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#truncate"><span class="hs-identifier hs-var">Diff.truncate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk)
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902935"><span class="hs-identifier hs-var">suffix'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902961"><span class="hs-identifier hs-var">chainDiff</span></a></span><span>
</span><span id="line-1213"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1214"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679902949"><span class="annot"><span class="annottext">Tracer m (TraceValidationEvent blk)
validationTracer :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; Tracer m (TraceValidationEvent blk)
validationTracer :: Tracer m (TraceValidationEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validationTracer"><span class="hs-identifier hs-var hs-var">validationTracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902956"><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
varInvalid :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
varInvalid :: StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varInvalid"><span class="hs-identifier hs-var hs-var">varInvalid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902947"><span class="annot"><span class="annottext">StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
varFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainSelEnv m blk -&gt; StrictTVar m (FutureBlocks m blk)
varFutureBlocks :: StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#varFutureBlocks"><span class="hs-identifier hs-var hs-var">varFutureBlocks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679902931"><span class="annot"><span class="annottext">CheckInFuture m blk
futureCheck :: forall (m :: * -&gt; *) blk. ChainSelEnv m blk -&gt; CheckInFuture m blk
futureCheck :: CheckInFuture m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheck"><span class="hs-identifier hs-var hs-var">futureCheck</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1215"></span><span>      </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902928"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span>
</span><span id="line-1216"></span><span>
</span><span id="line-1217"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#ValidatedChainDiff"><span class="hs-identifier hs-type">ValidatedChainDiff</span></a></span><span> </span><span id="local-6989586621679902961"><span class="annot"><span class="annottext">chainDiff :: ChainDiff (Header blk)
</span><a href="#local-6989586621679902961"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679902934"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679902934"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerDB (ExtLedgerState blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))
</span><a href="#local-6989586621679902929"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-1218"></span><span>
</span><span id="line-1219"></span><span>    </span><span class="annot"><a href="#local-6989586621679902932"><span class="hs-identifier hs-type">validatedSuffix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-type">ValidatedFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901430"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1220"></span><span>    </span><span id="local-6989586621679902932"><span class="annot"><span class="annottext">validatedSuffix :: ValidatedFragment (Header blk) (LedgerState blk)
</span><a href="#local-6989586621679902932"><span class="hs-identifier hs-var hs-var">validatedSuffix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1221"></span><span>      </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerState blk)
-&gt; (LedgerDB (ExtLedgerState blk) -&gt; ExtLedgerState blk)
-&gt; LedgerDB (ExtLedgerState blk)
-&gt; LedgerState blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB (ExtLedgerState blk) -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html#ledgerDbCurrent"><span class="hs-identifier hs-var">LgrDB.ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">(LedgerDB (ExtLedgerState blk) -&gt; LedgerState blk)
-&gt; ValidatedFragment (Header blk) (LedgerDB (ExtLedgerState blk))
-&gt; ValidatedFragment (Header blk) (LedgerState blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-1222"></span><span>      </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))
-&gt; ValidatedFragment (Header blk) (LedgerDB (ExtLedgerState blk))
forall l b.
(GetTip l, HasHeader b, HeaderHash l ~ HeaderHash b,
 HasCallStack) =&gt;
ValidatedChainDiff b l -&gt; ValidatedFragment b l
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#toValidatedFragment"><span class="hs-identifier hs-var">ValidatedDiff.toValidatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB (ExtLedgerState blk))
</span><a href="#local-6989586621679902929"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-1223"></span><span>
</span><span id="line-1224"></span><span class="hs-comment">-- | Validate a candidate chain using 'ledgerValidateCandidate' and</span><span>
</span><span id="line-1225"></span><span class="hs-comment">-- 'futureCheck'.</span><span>
</span><span id="line-1226"></span><span id="local-6989586621679901388"><span id="local-6989586621679901389"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validateCandidate"><span class="hs-identifier hs-type">validateCandidate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1227"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901388"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1228"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901389"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1229"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-1230"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1231"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainSelEnv"><span class="hs-identifier hs-type">ChainSelEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901388"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901389"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1232"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901389"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1233"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901388"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidationResult"><span class="hs-identifier hs-type">ValidationResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901389"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1234"></span><span id="validateCandidate"><span class="annot"><span class="annottext">validateCandidate :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; ChainDiff (Header blk) -&gt; m (ValidationResult blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#validateCandidate"><span class="hs-identifier hs-var hs-var">validateCandidate</span></a></span></span><span> </span><span id="local-6989586621679902992"><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902992"><span class="hs-identifier hs-var">chainSelEnv</span></a></span></span><span> </span><span id="local-6989586621679902993"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902993"><span class="hs-identifier hs-var">chainDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1235"></span><span>    </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; ChainDiff (Header blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, HasCallStack) =&gt;
ChainSelEnv m blk
-&gt; ChainDiff (Header blk)
-&gt; m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ledgerValidateCandidate"><span class="hs-identifier hs-var">ledgerValidateCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902992"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902993"><span class="hs-identifier hs-var">chainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">m (ValidatedChainDiff (Header blk) (LedgerDB' blk))
-&gt; (ValidatedChainDiff (Header blk) (LedgerDB' blk)
    -&gt; m (ValidationResult blk))
-&gt; m (ValidationResult blk)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1236"></span><span>      </span><span id="local-6989586621679902994"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902994"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span></span><span>
</span><span id="line-1237"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk) -&gt; Bool
forall b l. HasHeader b =&gt; ValidatedChainDiff b l -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">ValidatedDiff.rollbackExceedsSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902994"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span>
</span><span id="line-1238"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult blk
forall blk. ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span>
</span><span id="line-1239"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1240"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ChainSelEnv m blk
-&gt; ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; m (Either
        (ChainDiff (Header blk))
        (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#futureCheckCandidate"><span class="hs-identifier hs-var">futureCheckCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSelEnv m blk
</span><a href="#local-6989586621679902992"><span class="hs-identifier hs-var">chainSelEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902994"><span class="hs-identifier hs-var">validatedChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either
     (ChainDiff (Header blk))
     (ValidatedChainDiff (Header blk) (LedgerDB' blk)))
-&gt; (Either
      (ChainDiff (Header blk))
      (ValidatedChainDiff (Header blk) (LedgerDB' blk))
    -&gt; m (ValidationResult blk))
-&gt; m (ValidationResult blk)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1241"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679902996"><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902996"><span class="hs-identifier hs-var">chainDiff'</span></a></span></span><span>
</span><span id="line-1242"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; Bool
forall b. HasHeader b =&gt; ChainDiff b -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">Diff.rollbackExceedsSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902996"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span>
</span><span id="line-1243"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult blk
forall blk. ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span>
</span><span id="line-1244"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1245"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidationResult blk -&gt; m (ValidationResult blk))
-&gt; ValidationResult blk -&gt; m (ValidationResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; ValidationResult blk
forall blk. ChainDiff (Header blk) -&gt; ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-var">ValidPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902996"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span>
</span><span id="line-1246"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679902997"><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902997"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span></span><span>
</span><span id="line-1247"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk) -&gt; Bool
forall b l. HasHeader b =&gt; ValidatedChainDiff b l -&gt; Bool
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#rollbackExceedsSuffix"><span class="hs-identifier hs-var">ValidatedDiff.rollbackExceedsSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902997"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span><span>
</span><span id="line-1248"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult blk
forall blk. ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#InsufficientSuffix"><span class="hs-identifier hs-var">InsufficientSuffix</span></a></span><span>
</span><span id="line-1249"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><span class="hs-identifier hs-var">AF.length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902993"><span class="hs-identifier hs-var">chainDiff</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span>
</span><span id="line-1250"></span><span>                </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><span class="hs-identifier hs-var">AF.length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDiff (Header blk)
-&gt; AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
forall b. ChainDiff b -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-identifier hs-var">Diff.getSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902998"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1251"></span><span>                </span><span class="hs-comment">-- No truncation</span><span>
</span><span id="line-1252"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidationResult blk -&gt; m (ValidationResult blk))
-&gt; ValidationResult blk -&gt; m (ValidationResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ValidationResult blk
forall blk.
ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#FullyValid"><span class="hs-identifier hs-var">FullyValid</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902997"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span><span>
</span><span id="line-1253"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1254"></span><span>                </span><span class="hs-comment">-- In case of invalid blocks but no blocks from the future, we</span><span>
</span><span id="line-1255"></span><span>                </span><span class="hs-comment">-- throw away the ledger corresponding to the truncated</span><span>
</span><span id="line-1256"></span><span>                </span><span class="hs-comment">-- fragment and will have to validate it again, even when it's</span><span>
</span><span id="line-1257"></span><span>                </span><span class="hs-comment">-- the sole candidate.</span><span>
</span><span id="line-1258"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidationResult blk -&gt; m (ValidationResult blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidationResult blk -&gt; m (ValidationResult blk))
-&gt; ValidationResult blk -&gt; m (ValidationResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk) -&gt; ValidationResult blk
forall blk. ChainDiff (Header blk) -&gt; ValidationResult blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ValidPrefix"><span class="hs-identifier hs-var">ValidPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDiff (Header blk)
</span><a href="#local-6989586621679902998"><span class="hs-identifier hs-var">chainDiff'</span></a></span><span>
</span><span id="line-1259"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-1260"></span><span>              </span><span id="local-6989586621679902998"><span class="annot"><span class="annottext">chainDiff' :: ChainDiff (Header blk)
</span><a href="#local-6989586621679902998"><span class="hs-identifier hs-var hs-var">chainDiff'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
-&gt; ChainDiff (Header blk)
forall b l. ValidatedChainDiff b l -&gt; ChainDiff b
</span><a href="Ouroboros.Consensus.Fragment.ValidatedDiff.html#getChainDiff"><span class="hs-identifier hs-var">ValidatedDiff.getChainDiff</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatedChainDiff (Header blk) (LedgerDB' blk)
</span><a href="#local-6989586621679902997"><span class="hs-identifier hs-var">validatedChainDiff'</span></a></span><span>
</span><span id="line-1261"></span><span>
</span><span id="line-1262"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  'ChainAndLedger'
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1265"></span><span>
</span><span id="line-1266"></span><span class="annot"><span class="hs-comment">-- | Instantiate 'ValidatedFragment' in the way that chain selection requires.</span></span><span>
</span><span id="line-1267"></span><span class="hs-keyword">type</span><span> </span><span id="ChainAndLedger"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ChainAndLedger"><span class="hs-identifier hs-var">ChainAndLedger</span></a></span></span><span> </span><span id="local-6989586621679902999"><span class="annot"><a href="#local-6989586621679902999"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html#ValidatedFragment"><span class="hs-identifier hs-type">ValidatedFragment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679902999"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679902999"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1268"></span><span>
</span><span id="line-1269"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Diffusion pipelining
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1272"></span><span>
</span><span id="line-1273"></span><span class="hs-comment">-- | Check whether a 'ChainDiff' can be pipelined. If it can, the tentative</span><span>
</span><span id="line-1274"></span><span class="hs-comment">-- header is returned.</span><span>
</span><span id="line-1275"></span><span class="hs-comment">--</span><span>
</span><span id="line-1276"></span><span class="hs-comment">-- PRECONDITION: The 'ChainDiff' fits on top of the current chain and is better.</span><span>
</span><span id="line-1277"></span><span id="local-6989586621679901392"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#isPipelineable"><span class="hs-identifier hs-type">isPipelineable</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1278"></span><span>     </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901392"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1279"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockConfig"><span class="hs-identifier hs-type">BlockConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901392"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1280"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.TentativeState.html#TentativeState"><span class="hs-identifier hs-type">TentativeState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901392"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1281"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901392"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1282"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901392"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1283"></span><span id="isPipelineable"><span class="annot"><span class="annottext">isPipelineable :: forall blk.
LedgerSupportsProtocol blk =&gt;
BlockConfig blk
-&gt; TentativeState blk
-&gt; ChainDiff (Header blk)
-&gt; StrictMaybe (Header blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#isPipelineable"><span class="hs-identifier hs-var hs-var">isPipelineable</span></a></span></span><span> </span><span id="local-6989586621679903009"><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679903009"><span class="hs-identifier hs-var">bcfg</span></a></span></span><span> </span><span id="local-6989586621679903010"><span class="annot"><span class="annottext">TentativeState blk
</span><a href="#local-6989586621679903010"><span class="hs-identifier hs-var">tentativeState</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Diff.html#ChainDiff"><span class="hs-identifier hs-type">ChainDiff</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679903011"><span id="local-6989586621679903012"><span class="annot"><span class="annottext">Word64
AnchoredFragment (Header blk)
getSuffix :: forall b. ChainDiff b -&gt; AnchoredFragment b
getRollback :: Word64
getSuffix :: AnchoredFragment (Header blk)
getRollback :: forall b. ChainDiff b -&gt; Word64
</span><a href="Ouroboros.Consensus.Fragment.Diff.html#getSuffix"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-1284"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- we apply exactly one header</span><span>
</span><span id="line-1285"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">AF.Empty</span></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span id="local-6989586621679903015"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679903015"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679903012"><span class="hs-identifier hs-var">getSuffix</span></a></span><span>
</span><span id="line-1286"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk -&gt; TentativeState blk -&gt; Header blk -&gt; Bool
forall blk.
LedgerSupportsProtocol blk =&gt;
BlockConfig blk -&gt; TentativeState blk -&gt; Header blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Util.TentativeState.html#preferToLastInvalidTentative"><span class="hs-identifier hs-var">preferToLastInvalidTentative</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679903009"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">TentativeState blk
</span><a href="#local-6989586621679903010"><span class="hs-identifier hs-var">tentativeState</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679903015"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1287"></span><span>    </span><span class="hs-comment">-- ensure that the diff is applied to the chain tip</span><span>
</span><span id="line-1288"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679903011"><span class="hs-identifier hs-var">getRollback</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1289"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; StrictMaybe (Header blk)
forall a. a -&gt; StrictMaybe a
</span><span class="hs-identifier hs-var">SJust</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679903015"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1290"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
forall a. StrictMaybe a
</span><span class="hs-identifier hs-var">SNothing</span></span><span>
</span><span id="line-1291"></span><span>
</span><span id="line-1292"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Helpers
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1295"></span><span>
</span><span id="line-1296"></span><span class="annot"><span class="hs-comment">-- | Wrap a @getter@ function so that it returns 'Nothing' for invalid blocks.</span></span><span>
</span><span id="line-1297"></span><span id="local-6989586621679901242"><span id="local-6989586621679901243"><span id="local-6989586621679901244"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalid"><span class="hs-identifier hs-type">ignoreInvalid</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1298"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679901242"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1299"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679901243"><span class="hs-identifier hs-type">proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901242"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1300"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901242"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1301"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901242"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901244"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1302"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679901242"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679901244"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1303"></span><span id="ignoreInvalid"><span class="annot"><span class="annottext">ignoreInvalid :: forall blk (proxy :: * -&gt; *) a.
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (HeaderHash blk -&gt; Maybe a)
-&gt; HeaderHash blk
-&gt; Maybe a
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalid"><span class="hs-identifier hs-var hs-var">ignoreInvalid</span></a></span></span><span> </span><span class="annot"><span class="annottext">proxy blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679903021"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679903021"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621679903022"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe a
</span><a href="#local-6989586621679903022"><span class="hs-identifier hs-var">getter</span></a></span></span><span> </span><span id="local-6989586621679903023"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679903023"><span class="hs-identifier hs-var">hash</span></a></span></span><span>
</span><span id="line-1304"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#member"><span class="hs-identifier hs-var">Map.member</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679903023"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679903021"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1305"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe a
</span><a href="#local-6989586621679903022"><span class="hs-identifier hs-var">getter</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679903023"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-1306"></span><span>
</span><span id="line-1307"></span><span class="hs-comment">-- | Wrap a @successors@ function so that invalid blocks are not returned as</span><span>
</span><span id="line-1308"></span><span class="hs-comment">-- successors.</span><span>
</span><span id="line-1309"></span><span id="local-6989586621679900987"><span id="local-6989586621679900988"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-type">ignoreInvalidSuc</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1310"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679900987"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1311"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679900988"><span class="hs-identifier hs-type">proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900987"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1312"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InvalidBlocks"><span class="hs-identifier hs-type">InvalidBlocks</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679900987"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1313"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900987"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900987"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1314"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900987"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679900987"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1315"></span><span id="ignoreInvalidSuc"><span class="annot"><span class="annottext">ignoreInvalidSuc :: forall blk (proxy :: * -&gt; *).
HasHeader blk =&gt;
proxy blk
-&gt; InvalidBlocks blk
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#ignoreInvalidSuc"><span class="hs-identifier hs-var hs-var">ignoreInvalidSuc</span></a></span></span><span> </span><span class="annot"><span class="annottext">proxy blk
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679903028"><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679903028"><span class="hs-identifier hs-var">invalid</span></a></span></span><span> </span><span id="local-6989586621679903029"><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679903029"><span class="hs-identifier hs-var">succsOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1316"></span><span>    </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Bool)
-&gt; Set (HeaderHash blk) -&gt; Set (HeaderHash blk)
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#filter"><span class="hs-identifier hs-var">Set.filter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk -&gt; InvalidBlocks blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#notMember"><span class="hs-operator hs-var">`Map.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlocks blk
</span><a href="#local-6989586621679903028"><span class="hs-identifier hs-var">invalid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Set (HeaderHash blk) -&gt; Set (HeaderHash blk))
-&gt; (ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; ChainHash blk
-&gt; Set (HeaderHash blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; Set (HeaderHash blk)
</span><a href="#local-6989586621679903029"><span class="hs-identifier hs-var">succsOf</span></a></span><span>
</span><span id="line-1317"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DerivingVia         #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Index</span></span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier">Index</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntry"><span class="hs-identifier">readEntry</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffset"><span class="hs-identifier">readOffset</span></a></span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><span class="hs-comment">-- * File-backed index</span></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#fileBackedIndex"><span class="hs-identifier">fileBackedIndex</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Cached index</span></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier">CacheConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#cachedIndex"><span class="hs-identifier">cachedIndex</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html"><span class="hs-identifier">Data.Functor.Identity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier">Identity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html"><span class="hs-identifier">Data.Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html"><span class="hs-identifier">Data.Typeable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OnlyCheckWhnfNamed</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier">ConvertRawHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier">IsEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">StandardHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache</span></a></span><span>
</span><span id="line-29"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier">CacheConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cache</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary</span></a></span><span>
</span><span id="line-32"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier">SecondaryOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Primary</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a></span><span>
</span><span id="line-35"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier">BlockSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Secondary</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types</span></a></span><span>
</span><span id="line-38"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceCacheEvent"><span class="hs-identifier">TraceCacheEvent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier">WithBlockSize</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HasFS</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AllowExisting</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Handle</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-comment">{------------------------------------------------------------------------------
  Index
------------------------------------------------------------------------------}</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">-- | Bundle the operations on the primary and secondary index that touch the</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- files. This allows us to easily introduce an intermediary caching layer.</span><span>
</span><span id="line-50"></span><span class="hs-keyword">data</span><span> </span><span id="Index"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-var">Index</span></a></span></span><span> </span><span id="local-6989586621679865041"><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679865042"><span class="annot"><a href="#local-6989586621679865042"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679865043"><span class="annot"><a href="#local-6989586621679865043"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Index"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-var">Index</span></a></span></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-comment">-- | See 'Primary.readOffsets'</span></span><span>
</span><span id="line-52"></span><span>    </span><span id="readOffsets"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffsets"><span class="hs-identifier hs-var hs-var">readOffsets</span></a></span></span><span>
</span><span id="line-53"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679865046"><span class="annot"><a href="#local-6989586621679865046"><span class="hs-identifier hs-type">t</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#Traversable"><span class="hs-identifier hs-type">Traversable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865046"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-55"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865046"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span>
</span><span id="line-56"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679865046"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><span class="hs-comment">-- |  See 'Primary.readFirstFilledSlot'</span></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="readFirstFilledSlot"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readFirstFilledSlot"><span class="hs-identifier hs-var hs-var">readFirstFilledSlot</span></a></span></span><span>
</span><span id="line-60"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-61"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><span class="hs-comment">-- | See 'Primary.open'</span></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="openPrimaryIndex"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; HasCallStack =&gt; ChunkNo -&gt; AllowExisting -&gt; m (Handle h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#openPrimaryIndex"><span class="hs-identifier hs-var hs-var">openPrimaryIndex</span></a></span></span><span>
</span><span id="line-66"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-67"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-68"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AllowExisting</span></span><span>
</span><span id="line-69"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="annot"><a href="#local-6989586621679865043"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="hs-comment">-- | See 'Primary.appendOffsets'</span></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="appendOffsets"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (f :: * -&gt; *).
   (HasCallStack, Foldable f) =&gt;
   Handle h -&gt; f SecondaryOffset -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendOffsets"><span class="hs-identifier hs-var hs-var">appendOffsets</span></a></span></span><span>
</span><span id="line-73"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679865062"><span class="annot"><a href="#local-6989586621679865062"><span class="hs-identifier hs-type">f</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#Foldable"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865062"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="annot"><a href="#local-6989586621679865043"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-75"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865062"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span>
</span><span id="line-76"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><span class="hs-comment">-- | See 'Secondary.readEntries'</span></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="readEntries"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo
   -&gt; t (IsEBB, SecondaryOffset) -&gt; m (t (Entry blk, BlockSize))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntries"><span class="hs-identifier hs-var hs-var">readEntries</span></a></span></span><span>
</span><span id="line-80"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679865067"><span class="annot"><a href="#local-6989586621679865067"><span class="hs-identifier hs-type">t</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#Traversable"><span class="hs-identifier hs-type">Traversable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865067"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-82"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865067"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679865067"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865042"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier hs-type">BlockSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><span class="hs-comment">-- | See 'Secondary.readAllEntries'</span></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="readAllEntries"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; HasCallStack =&gt;
   SecondaryOffset
   -&gt; ChunkNo
   -&gt; (Entry blk -&gt; Bool)
   -&gt; Word64
   -&gt; IsEBB
   -&gt; m [WithBlockSize (Entry blk)]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readAllEntries"><span class="hs-identifier hs-var hs-var">readAllEntries</span></a></span></span><span>
</span><span id="line-87"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-88"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865042"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-type">WithBlockSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865042"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="hs-comment">-- | See 'Secondary.appendEntry'</span></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="appendEntry"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; HasCallStack =&gt;
   ChunkNo -&gt; Handle h -&gt; WithBlockSize (Entry blk) -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendEntry"><span class="hs-identifier hs-var hs-var">appendEntry</span></a></span></span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-99"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="annot"><a href="#local-6989586621679865043"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-type">WithBlockSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865042"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-comment">-- | Close the index and stop any background threads.</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-comment">-- Should be called when the ImmutableDB is closed.</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="close"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. Index m blk h -&gt; HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#close"><span class="hs-identifier hs-var hs-var">close</span></a></span></span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- | Restart a closed index using the given chunk as the current chunk,</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">-- drop all previously cached information.</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- NOTE: this will only used in the testsuite, when we need to truncate.</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="restart"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#restart"><span class="hs-identifier hs-var hs-var">restart</span></a></span></span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679865276"><span id="local-6989586621679865282"><span id="local-6989586621679865287"><span class="annot"><span class="annottext">Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo)
Proxy (Index m blk h) -&gt; String
(Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Index m blk h) -&gt; String)
-&gt; NoThunks (Index m blk h)
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
forall (m :: * -&gt; *) blk h.
Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo)
forall (m :: * -&gt; *) blk h. Proxy (Index m blk h) -&gt; String
$cnoThunks :: forall (m :: * -&gt; *) blk h.
Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall (m :: * -&gt; *) blk h.
Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; Index m blk h -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall (m :: * -&gt; *) blk h. Proxy (Index m blk h) -&gt; String
showTypeOf :: Proxy (Index m blk h) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span> </span><span class="hs-keyword">via</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OnlyCheckWhnfNamed</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Index&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865041"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865042"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865043"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="annot"><span class="hs-comment">-- | See 'Primary.readOffset'.</span></span><span>
</span><span id="line-122"></span><span id="local-6989586621679865105"><span id="local-6989586621679865106"><span id="local-6989586621679865107"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffset"><span class="hs-identifier hs-type">readOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-123"></span><span>     </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865105"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865105"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865106"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865107"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865105"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-128"></span><span id="readOffset"><span class="annot"><span class="annottext">readOffset :: forall (m :: * -&gt; *) blk h.
Functor m =&gt;
Index m blk h
-&gt; ChunkNo -&gt; RelativeSlot -&gt; m (Maybe SecondaryOffset)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffset"><span class="hs-identifier hs-var hs-var">readOffset</span></a></span></span><span> </span><span id="local-6989586621679865300"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679865300"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679865301"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865301"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679865302"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679865302"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (Maybe SecondaryOffset) -&gt; Maybe SecondaryOffset
forall a. Identity a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">(Identity (Maybe SecondaryOffset) -&gt; Maybe SecondaryOffset)
-&gt; m (Identity (Maybe SecondaryOffset))
-&gt; m (Maybe SecondaryOffset)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><span class="annottext">Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffsets"><span class="hs-identifier hs-var">readOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679865300"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865301"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; Identity RelativeSlot
forall a. a -&gt; Identity a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-var">Identity</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679865302"><span class="hs-identifier hs-var">slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="annot"><span class="hs-comment">-- | See 'Secondary.readEntry'.</span></span><span>
</span><span id="line-132"></span><span id="local-6989586621679865117"><span id="local-6989586621679865118"><span id="local-6989586621679865119"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntry"><span class="hs-identifier hs-type">readEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-133"></span><span>     </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Functor"><span class="hs-identifier hs-type">Functor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865117"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865117"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865118"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865119"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-type">IsEBB</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865117"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865118"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier hs-type">BlockSize</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-139"></span><span id="readEntry"><span class="annot"><span class="annottext">readEntry :: forall (m :: * -&gt; *) blk h.
Functor m =&gt;
Index m blk h
-&gt; ChunkNo -&gt; IsEBB -&gt; SecondaryOffset -&gt; m (Entry blk, BlockSize)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntry"><span class="hs-identifier hs-var hs-var">readEntry</span></a></span></span><span> </span><span id="local-6989586621679865312"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679865312"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679865313"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865313"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679865314"><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679865314"><span class="hs-identifier hs-var">isEBB</span></a></span></span><span> </span><span id="local-6989586621679865315"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679865315"><span class="hs-identifier hs-var">slotOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (Entry blk, BlockSize) -&gt; (Entry blk, BlockSize)
forall a. Identity a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#runIdentity"><span class="hs-identifier hs-var">runIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">(Identity (Entry blk, BlockSize) -&gt; (Entry blk, BlockSize))
-&gt; m (Identity (Entry blk, BlockSize)) -&gt; m (Entry blk, BlockSize)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo
   -&gt; t (IsEBB, SecondaryOffset) -&gt; m (t (Entry blk, BlockSize))
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (t :: * -&gt; *).
   (HasCallStack, Traversable t) =&gt;
   ChunkNo
   -&gt; t (IsEBB, SecondaryOffset) -&gt; m (t (Entry blk, BlockSize))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntries"><span class="hs-identifier hs-var">readEntries</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679865312"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865313"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IsEBB, SecondaryOffset) -&gt; Identity (IsEBB, SecondaryOffset)
forall a. a -&gt; Identity a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-var">Identity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679865314"><span class="hs-identifier hs-var">isEBB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679865315"><span class="hs-identifier hs-var">slotOffset</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">{------------------------------------------------------------------------------
  File-backed index
------------------------------------------------------------------------------}</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#fileBackedIndex"><span class="hs-identifier hs-type">fileBackedIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-147"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679865125"><span class="annot"><a href="#local-6989586621679865125"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679865123"><span class="annot"><a href="#local-6989586621679865123"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679865128"><span class="annot"><a href="#local-6989586621679865128"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-148"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865123"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621679865125"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679865123"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865123"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679865125"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865128"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865125"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865123"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865128"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-152"></span><span id="fileBackedIndex"><span class="annot"><span class="annottext">fileBackedIndex :: forall (m :: * -&gt; *) blk h.
(ConvertRawHash blk, MonadCatch m, StandardHash blk,
 Typeable blk) =&gt;
HasFS m h -&gt; ChunkInfo -&gt; Index m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#fileBackedIndex"><span class="hs-identifier hs-var hs-var">fileBackedIndex</span></a></span></span><span> </span><span id="local-6989586621679865324"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679865325"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679865325"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">readOffsets :: forall (t :: * -&gt; *).
(HasCallStack, Traversable t) =&gt;
ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffsets"><span class="hs-identifier hs-var">readOffsets</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; HasFS m h
-&gt; ChunkNo
-&gt; t RelativeSlot
-&gt; m (t (Maybe SecondaryOffset))
forall blk (m :: * -&gt; *) h (t :: * -&gt; *).
(HasCallStack, MonadThrow m, Traversable t, StandardHash blk,
 Typeable blk) =&gt;
Proxy blk
-&gt; HasFS m h
-&gt; ChunkNo
-&gt; t RelativeSlot
-&gt; m (t (Maybe SecondaryOffset))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#readOffsets"><span class="hs-identifier hs-var">Primary.readOffsets</span></a></span><span>         </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679865334"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readFirstFilledSlot :: HasCallStack =&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readFirstFilledSlot"><span class="hs-identifier hs-var">readFirstFilledSlot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; HasFS m h -&gt; ChunkInfo -&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
forall blk (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m, StandardHash blk, Typeable blk) =&gt;
Proxy blk
-&gt; HasFS m h -&gt; ChunkInfo -&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#readFirstFilledSlot"><span class="hs-identifier hs-var">Primary.readFirstFilledSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679865334"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679865325"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">openPrimaryIndex :: HasCallStack =&gt; ChunkNo -&gt; AllowExisting -&gt; m (Handle h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#openPrimaryIndex"><span class="hs-identifier hs-var">openPrimaryIndex</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; AllowExisting -&gt; m (Handle h)
forall (m :: * -&gt; *) h.
(HasCallStack, MonadCatch m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; AllowExisting -&gt; m (Handle h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#open"><span class="hs-identifier hs-var">Primary.open</span></a></span><span>                  </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">appendOffsets :: forall (f :: * -&gt; *).
(HasCallStack, Foldable f) =&gt;
Handle h -&gt; f SecondaryOffset -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendOffsets"><span class="hs-identifier hs-var">appendOffsets</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; f SecondaryOffset -&gt; m ()
forall (m :: * -&gt; *) (f :: * -&gt; *) h.
(Monad m, Foldable f, HasCallStack) =&gt;
HasFS m h -&gt; Handle h -&gt; f SecondaryOffset -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#appendOffsets"><span class="hs-identifier hs-var">Primary.appendOffsets</span></a></span><span>         </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readEntries :: forall (t :: * -&gt; *).
(HasCallStack, Traversable t) =&gt;
ChunkNo
-&gt; t (IsEBB, SecondaryOffset) -&gt; m (t (Entry blk, BlockSize))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntries"><span class="hs-identifier hs-var">readEntries</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
-&gt; ChunkNo
-&gt; t (IsEBB, SecondaryOffset)
-&gt; m (t (Entry blk, BlockSize))
forall (m :: * -&gt; *) blk h (t :: * -&gt; *).
(HasCallStack, ConvertRawHash blk, MonadThrow m, StandardHash blk,
 Typeable blk, Traversable t) =&gt;
HasFS m h
-&gt; ChunkNo
-&gt; t (IsEBB, SecondaryOffset)
-&gt; m (t (Entry blk, BlockSize))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#readEntries"><span class="hs-identifier hs-var">Secondary.readEntries</span></a></span><span>         </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readAllEntries :: HasCallStack =&gt;
SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readAllEntries"><span class="hs-identifier hs-var">readAllEntries</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
-&gt; SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, MonadThrow m, StandardHash blk,
 Typeable blk) =&gt;
HasFS m h
-&gt; SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#readAllEntries"><span class="hs-identifier hs-var">Secondary.readAllEntries</span></a></span><span>      </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">appendEntry :: HasCallStack =&gt;
ChunkNo -&gt; Handle h -&gt; WithBlockSize (Entry blk) -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendEntry"><span class="hs-identifier hs-var">appendEntry</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679865372"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865372"><span class="hs-identifier hs-var">_chunk</span></a></span></span><span> </span><span id="local-6989586621679865373"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679865373"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-type">WithBlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679865375"><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679865375"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-160"></span><span>                            </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Entry blk -&gt; m Word64
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, MonadThrow m) =&gt;
HasFS m h -&gt; Handle h -&gt; Entry blk -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#appendEntry"><span class="hs-identifier hs-var">Secondary.appendEntry</span></a></span><span>         </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865324"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679865373"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679865375"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-comment">-- Nothing to do</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">close :: HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#close"><span class="hs-identifier hs-var">close</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">restart :: HasCallStack =&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#restart"><span class="hs-identifier hs-var">restart</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679865380"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865380"><span class="hs-identifier hs-var">_newCurChunk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><a href="#local-6989586621679865334"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865123"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621679865334"><span class="annot"><span class="annottext">p :: Proxy blk
</span><a href="#local-6989586621679865334"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="hs-comment">{------------------------------------------------------------------------------
  Cached index
------------------------------------------------------------------------------}</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">-- | Caches the current chunk's indices as well as a number of past chunk's</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- indices.</span><span>
</span><span id="line-175"></span><span class="hs-comment">--</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- Spawns a background thread to expire past chunks from the cache that</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- haven't been used for a while.</span><span>
</span><span id="line-178"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#cachedIndex"><span class="hs-identifier hs-type">cachedIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-179"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679865166"><span class="annot"><a href="#local-6989586621679865166"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679865168"><span class="annot"><a href="#local-6989586621679865168"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679865169"><span class="annot"><a href="#local-6989586621679865169"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-180"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865166"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865168"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StandardHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679865168"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865168"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679865166"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865169"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865166"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679865166"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceCacheEvent"><span class="hs-identifier hs-type">TraceCacheEvent</span></a></span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier hs-type">CacheConfig</span></a></span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Current chunk</span></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679865166"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865166"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865168"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679865169"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span id="cachedIndex"><span class="annot"><span class="annottext">cachedIndex :: forall (m :: * -&gt; *) blk h.
(IOLike m, ConvertRawHash blk, StandardHash blk, Typeable blk) =&gt;
HasFS m h
-&gt; ResourceRegistry m
-&gt; Tracer m TraceCacheEvent
-&gt; CacheConfig
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; m (Index m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#cachedIndex"><span class="hs-identifier hs-var hs-var">cachedIndex</span></a></span></span><span> </span><span id="local-6989586621679865408"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865408"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679865409"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679865409"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679865410"><span class="annot"><span class="annottext">Tracer m TraceCacheEvent
</span><a href="#local-6989586621679865410"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679865411"><span class="annot"><span class="annottext">CacheConfig
</span><a href="#local-6989586621679865411"><span class="hs-identifier hs-var">cacheConfig</span></a></span></span><span> </span><span id="local-6989586621679865412"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679865412"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span id="local-6989586621679865413"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865413"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621679865414"><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h
-&gt; ResourceRegistry m
-&gt; Tracer m TraceCacheEvent
-&gt; CacheConfig
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; m (CacheEnv m blk h)
forall blk (m :: * -&gt; *) h.
(HasCallStack, ConvertRawHash blk, IOLike m, StandardHash blk,
 Typeable blk) =&gt;
HasFS m h
-&gt; ResourceRegistry m
-&gt; Tracer m TraceCacheEvent
-&gt; CacheConfig
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; m (CacheEnv m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#newEnv"><span class="hs-identifier hs-var">Cache.newEnv</span></a></span><span>
</span><span id="line-190"></span><span>                  </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679865408"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-191"></span><span>                  </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679865409"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-192"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m TraceCacheEvent
</span><a href="#local-6989586621679865410"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-193"></span><span>                  </span><span class="annot"><span class="annottext">CacheConfig
</span><a href="#local-6989586621679865411"><span class="hs-identifier hs-var">cacheConfig</span></a></span><span>
</span><span id="line-194"></span><span>                  </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679865412"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-195"></span><span>                  </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679865413"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">Index m blk h -&gt; m (Index m blk h)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">readOffsets :: forall (t :: * -&gt; *).
(HasCallStack, Traversable t) =&gt;
ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readOffsets"><span class="hs-identifier hs-var">readOffsets</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h
-&gt; ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
forall blk (m :: * -&gt; *) (t :: * -&gt; *) h.
(HasCallStack, ConvertRawHash blk, IOLike m, StandardHash blk,
 Typeable blk, Traversable t) =&gt;
CacheEnv m blk h
-&gt; ChunkNo -&gt; t RelativeSlot -&gt; m (t (Maybe SecondaryOffset))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#readOffsets"><span class="hs-identifier hs-var">Cache.readOffsets</span></a></span><span>         </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readFirstFilledSlot :: HasCallStack =&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readFirstFilledSlot"><span class="hs-identifier hs-var">readFirstFilledSlot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h -&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
forall blk (m :: * -&gt; *) h.
(HasCallStack, ConvertRawHash blk, IOLike m, StandardHash blk,
 Typeable blk) =&gt;
CacheEnv m blk h -&gt; ChunkNo -&gt; m (Maybe RelativeSlot)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#readFirstFilledSlot"><span class="hs-identifier hs-var">Cache.readFirstFilledSlot</span></a></span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">openPrimaryIndex :: HasCallStack =&gt; ChunkNo -&gt; AllowExisting -&gt; m (Handle h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#openPrimaryIndex"><span class="hs-identifier hs-var">openPrimaryIndex</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h -&gt; ChunkNo -&gt; AllowExisting -&gt; m (Handle h)
forall blk (m :: * -&gt; *) h.
(HasCallStack, ConvertRawHash blk, IOLike m, StandardHash blk,
 Typeable blk) =&gt;
CacheEnv m blk h -&gt; ChunkNo -&gt; AllowExisting -&gt; m (Handle h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#openPrimaryIndex"><span class="hs-identifier hs-var">Cache.openPrimaryIndex</span></a></span><span>    </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">appendOffsets :: forall (f :: * -&gt; *).
(HasCallStack, Foldable f) =&gt;
Handle h -&gt; f SecondaryOffset -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendOffsets"><span class="hs-identifier hs-var">appendOffsets</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h -&gt; Handle h -&gt; f SecondaryOffset -&gt; m ()
forall (f :: * -&gt; *) (m :: * -&gt; *) blk h.
(HasCallStack, Foldable f, IOLike m) =&gt;
CacheEnv m blk h -&gt; Handle h -&gt; f SecondaryOffset -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#appendOffsets"><span class="hs-identifier hs-var">Cache.appendOffsets</span></a></span><span>       </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readEntries :: forall (t :: * -&gt; *).
(HasCallStack, Traversable t) =&gt;
ChunkNo
-&gt; t (IsEBB, SecondaryOffset) -&gt; m (t (Entry blk, BlockSize))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readEntries"><span class="hs-identifier hs-var">readEntries</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h
-&gt; ChunkNo
-&gt; t (IsEBB, SecondaryOffset)
-&gt; m (t (Entry blk, BlockSize))
forall (m :: * -&gt; *) blk h (t :: * -&gt; *).
(HasCallStack, ConvertRawHash blk, IOLike m, StandardHash blk,
 Typeable blk, Traversable t) =&gt;
CacheEnv m blk h
-&gt; ChunkNo
-&gt; t (IsEBB, SecondaryOffset)
-&gt; m (t (Entry blk, BlockSize))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#readEntries"><span class="hs-identifier hs-var">Cache.readEntries</span></a></span><span>         </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">readAllEntries :: HasCallStack =&gt;
SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#readAllEntries"><span class="hs-identifier hs-var">readAllEntries</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h
-&gt; SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, IOLike m, StandardHash blk,
 Typeable blk) =&gt;
CacheEnv m blk h
-&gt; SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#readAllEntries"><span class="hs-identifier hs-var">Cache.readAllEntries</span></a></span><span>      </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">appendEntry :: HasCallStack =&gt;
ChunkNo -&gt; Handle h -&gt; WithBlockSize (Entry blk) -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendEntry"><span class="hs-identifier hs-var">appendEntry</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h
-&gt; ChunkNo -&gt; Handle h -&gt; WithBlockSize (Entry blk) -&gt; m Word64
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, IOLike m) =&gt;
CacheEnv m blk h -&gt; ChunkNo -&gt; Handle h -&gt; Entry blk -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#appendEntry"><span class="hs-identifier hs-var">Cache.appendEntry</span></a></span><span>         </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">close :: HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#close"><span class="hs-identifier hs-var">close</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h -&gt; m ()
forall (m :: * -&gt; *) blk h. IOLike m =&gt; CacheEnv m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#close"><span class="hs-identifier hs-var">Cache.close</span></a></span><span>               </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">restart :: HasCallStack =&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#restart"><span class="hs-identifier hs-var">restart</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheEnv m blk h -&gt; ChunkNo -&gt; m ()
forall blk (m :: * -&gt; *) h.
(ConvertRawHash blk, IOLike m, StandardHash blk, Typeable blk) =&gt;
CacheEnv m blk h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#restart"><span class="hs-identifier hs-var">Cache.restart</span></a></span><span>             </span><span class="annot"><span class="annottext">CacheEnv m blk h
</span><a href="#local-6989586621679865414"><span class="hs-identifier hs-var">cacheEnv</span></a></span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-207"></span></pre></body></html>
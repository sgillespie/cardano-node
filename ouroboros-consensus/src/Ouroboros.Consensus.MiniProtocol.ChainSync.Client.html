<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns               #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds                  #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies         #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields      #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification  #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase                 #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf                 #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns             #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE Rank2Types                 #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving         #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE TupleSections              #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications           #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies               #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances       #-}</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-strictness #-}</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- NOTE: With @-fstrictness@ optimisation (enabled by default for -O1), we get</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- an unexplained thunk in 'KnownIntersectionState' and thus a space leak. See</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- #1356.</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-comment">-- | The ChainSync client logic</span><span>
</span><span id="line-26"></span><span class="hs-comment">--</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- Its core specification is found in &quot;The Shelley Networking Protocol&quot;,</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- currently found at</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- &lt;https://ouroboros-network.cardano.intersectmbo.org/pdfs/network-spec/network-spec.pdf&gt;.</span><span>
</span><span id="line-30"></span><span class="hs-comment">--</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- It would be difficult to maintain or extrend this module without</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- understanding the @typed-protocols@ architecture; eg see</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- &lt;https://github.com/input-output-hk/typed-protocols&gt;.</span><span>
</span><span id="line-34"></span><span class="hs-comment">--</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- This module is intended for qualified import, aliased as either CSC,</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- CSClient, or CsClient.</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.ChainSync.Client</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-comment">-- * ChainSync client</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#bracketChainSyncClient"><span class="hs-identifier">bracketChainSyncClient</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#chainSyncClient"><span class="hs-identifier">chainSyncClient</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Arguments</span></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier">ChainDbView</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier">ConfigEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier">DynamicEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier">InternalEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#defaultChainDbView"><span class="hs-identifier">defaultChainDbView</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Results</span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier">ChainSyncClientException</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier">ChainSyncClientResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Misc</span></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier">Consensus</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Trace events</span></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier">InvalidBlockReason</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier">TraceChainSyncClientEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#join"><span class="hs-identifier">join</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExcept"><span class="hs-identifier">runExcept</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier">throwError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Kind.html"><span class="hs-identifier">Data.Kind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html"><span class="hs-identifier">Data.Proxy</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html"><span class="hs-identifier">Data.Typeable</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Network.TypedProtocol.Pipelined</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeNoThunks</span></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Config.html"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Forecast.html"><span class="hs-identifier">Ouroboros.Consensus.Forecast</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.History</span></a></span><span>
</span><span id="line-77"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.Qry.html#PastHorizonException"><span class="hs-identifier">PastHorizonException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.Qry.html#PastHorizon"><span class="hs-identifier">PastHorizon</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderStateHistory</span></a></span><span>
</span><span id="line-79"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier">HeaderStateHistory</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#validateHeader"><span class="hs-identifier">validateHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderStateHistory</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HeaderStateHistory</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderValidation</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#validateHeader"><span class="hs-identifier">validateHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Basics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier">LedgerState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html"><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InFutureCheck</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Node.NetworkProtocolVersion.html"><span class="hs-identifier">Ouroboros.Consensus.Node.NetworkProtocolVersion</span></a></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Abstract</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier">ChainDB</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier">InvalidBlockReason</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainDB</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Assert.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.Assert.html#assertWithMsg"><span class="hs-identifier">assertWithMsg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html"><span class="hs-identifier">Ouroboros.Consensus.Util.EarlyExit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#WithEarlyExit"><span class="hs-identifier">WithEarlyExit</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#exitEarly"><span class="hs-identifier">exitEarly</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html"><span class="hs-identifier">Ouroboros.Consensus.Util.EarlyExit</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EarlyExit</span></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html"><span class="hs-identifier">Ouroboros.Consensus.Util.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Fingerprint"><span class="hs-identifier">Fingerprint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Watcher"><span class="hs-identifier">Watcher</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#withWatcher"><span class="hs-identifier">withWatcher</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AnchoredFragment</span></span><span class="hs-special">,</span><span>
</span><span id="line-99"></span><span>                     </span><span class="annot"><span class="hs-identifier">AnchoredSeq</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredSeq</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AS</span></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tip</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">getTipBlockNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ConsensusInterface</span></span><span>
</span><span id="line-104"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">WhetherReceivingTentativeBlocks</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.ControlMessage</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ControlMessage</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>                     </span><span class="annot"><span class="hs-identifier">ControlMessageSTM</span></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.NodeToNode.Version</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isPipeliningEnabled</span></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerMetric.Type</span></span><span>
</span><span id="line-109"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HeaderMetricsTracer</span></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.ClientPipelined</span></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.PipelineDecision</span></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="annot"><span class="hs-comment">-- | Merely a helpful abbreviation</span></span><span>
</span><span id="line-114"></span><span class="hs-keyword">type</span><span> </span><span id="Consensus"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-var">Consensus</span></a></span></span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679909337"><span class="annot"><a href="#local-6989586621679909337"><span class="hs-identifier hs-type">client</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>        </span><span id="local-6989586621679909338"><span class="annot"><a href="#local-6989586621679909338"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-117"></span><span>        </span><span id="local-6989586621679909339"><span class="annot"><a href="#local-6989586621679909339"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679909337"><span class="hs-identifier hs-type">client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909338"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679909338"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909338"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679909339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="annot"><span class="hs-comment">-- | Abstract over the ChainDB</span></span><span>
</span><span id="line-121"></span><span class="hs-keyword">data</span><span> </span><span id="ChainDbView"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-var">ChainDbView</span></a></span></span><span> </span><span id="local-6989586621679908595"><span class="annot"><a href="#local-6989586621679908595"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908596"><span class="annot"><a href="#local-6989586621679908596"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ChainDbView"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-var">ChainDbView</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-122"></span><span>    </span><span id="%24sel%3AgetCurrentChain%3AChainDbView"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetCurrentChain%3AChainDbView"><span class="hs-identifier hs-var hs-var">getCurrentChain</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908595"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908596"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>    </span><span id="%24sel%3AgetHeaderStateHistory%3AChainDbView"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetHeaderStateHistory%3AChainDbView"><span class="hs-identifier hs-var hs-var">getHeaderStateHistory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908595"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908596"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-126"></span><span>    </span><span id="%24sel%3AgetPastLedger%3AChainDbView"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetPastLedger%3AChainDbView"><span class="hs-identifier hs-var hs-var">getPastLedger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679908596"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908595"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908596"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-128"></span><span>    </span><span id="%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="hs-identifier hs-var hs-var">getIsInvalidBlock</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908595"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-130"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span>
</span><span id="line-131"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679908596"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908596"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span id="local-6989586621679908611"><span id="local-6989586621679908613"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#defaultChainDbView"><span class="hs-identifier hs-type">defaultChainDbView</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-135"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908611"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908613"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">ChainDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908611"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908613"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908611"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908613"><span class="hs-identifier hs-type">blk</span></a></span></span></span><span>
</span><span id="line-137"></span><span id="defaultChainDbView"><span class="annot"><span class="annottext">defaultChainDbView :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ChainDB m blk -&gt; ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#defaultChainDbView"><span class="hs-identifier hs-var hs-var">defaultChainDbView</span></a></span></span><span> </span><span id="local-6989586621679909356"><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679909356"><span class="hs-identifier hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">$sel:getCurrentChain:ChainDbView :: STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetCurrentChain%3AChainDbView"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
ChainDB m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getCurrentChain"><span class="hs-identifier hs-var">ChainDB.getCurrentChain</span></a></span><span>       </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679909356"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getHeaderStateHistory:ChainDbView :: STM m (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetHeaderStateHistory%3AChainDbView"><span class="hs-identifier hs-var">getHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (HeaderStateHistory blk)
forall (m :: * -&gt; *) blk.
Monad (STM m) =&gt;
ChainDB m blk -&gt; STM m (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getHeaderStateHistory"><span class="hs-identifier hs-var">ChainDB.getHeaderStateHistory</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679909356"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getPastLedger:ChainDbView :: Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetPastLedger%3AChainDbView"><span class="hs-identifier hs-var">getPastLedger</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
forall (m :: * -&gt; *) blk.
(Monad (STM m), LedgerSupportsProtocol blk) =&gt;
ChainDB m blk -&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getPastLedger"><span class="hs-identifier hs-var">ChainDB.getPastLedger</span></a></span><span>         </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679909356"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:getIsInvalidBlock:ChainDbView :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
forall (m :: * -&gt; *) blk.
ChainDB m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getIsInvalidBlock"><span class="hs-identifier hs-var">ChainDB.getIsInvalidBlock</span></a></span><span>     </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679909356"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="annot"><span class="hs-comment">-- | A newtype wrapper to avoid confusing our tip with their tip.</span></span><span>
</span><span id="line-145"></span><span class="hs-keyword">newtype</span><span> </span><span id="Their"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span></span><span> </span><span id="local-6989586621679908630"><span class="annot"><a href="#local-6989586621679908630"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Their"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AunTheir%3ATheir"><span class="annot"><span class="annottext">forall a. Their a -&gt; a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AunTheir%3ATheir"><span class="hs-identifier hs-var hs-var">unTheir</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679908630"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679909365"><span id="local-6989586621679909368"><span class="annot"><span class="annottext">Their a -&gt; Their a -&gt; Bool
(Their a -&gt; Their a -&gt; Bool)
-&gt; (Their a -&gt; Their a -&gt; Bool) -&gt; Eq (Their a)
forall a. Eq a =&gt; Their a -&gt; Their a -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall a. Eq a =&gt; Their a -&gt; Their a -&gt; Bool
== :: Their a -&gt; Their a -&gt; Bool
$c/= :: forall a. Eq a =&gt; Their a -&gt; Their a -&gt; Bool
/= :: Their a -&gt; Their a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679909374"><span id="local-6989586621679909378"><span id="local-6989586621679909382"><span class="annot"><span class="annottext">Int -&gt; Their a -&gt; ShowS
[Their a] -&gt; ShowS
Their a -&gt; String
(Int -&gt; Their a -&gt; ShowS)
-&gt; (Their a -&gt; String) -&gt; ([Their a] -&gt; ShowS) -&gt; Show (Their a)
forall a. Show a =&gt; Int -&gt; Their a -&gt; ShowS
forall a. Show a =&gt; [Their a] -&gt; ShowS
forall a. Show a =&gt; Their a -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; Their a -&gt; ShowS
showsPrec :: Int -&gt; Their a -&gt; ShowS
$cshow :: forall a. Show a =&gt; Their a -&gt; String
show :: Their a -&gt; String
$cshowList :: forall a. Show a =&gt; [Their a] -&gt; ShowS
showList :: [Their a] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909388"><span id="local-6989586621679909392"><span id="local-6989586621679909396"><span class="annot"><span class="annottext">Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
Proxy (Their a) -&gt; String
(Context -&gt; Their a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Their a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Their a) -&gt; String)
-&gt; NoThunks (Their a)
forall a. NoThunks a =&gt; Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
forall a. NoThunks a =&gt; Proxy (Their a) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: forall a. NoThunks a =&gt; Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall a. NoThunks a =&gt; Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; Their a -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall a. NoThunks a =&gt; Proxy (Their a) -&gt; String
showTypeOf :: Proxy (Their a) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="annot"><span class="hs-comment">-- | A newtype wrapper to avoid confusing our tip with their tip.</span></span><span>
</span><span id="line-150"></span><span class="hs-keyword">newtype</span><span> </span><span id="Our"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-var">Our</span></a></span></span><span> </span><span id="local-6989586621679908649"><span class="annot"><a href="#local-6989586621679908649"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Our"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-var">Our</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AunOur%3AOur"><span class="annot"><span class="annottext">forall a. Our a -&gt; a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AunOur%3AOur"><span class="hs-identifier hs-var hs-var">unOur</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679908649"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679909405"><span id="local-6989586621679909408"><span class="annot"><span class="annottext">Our a -&gt; Our a -&gt; Bool
(Our a -&gt; Our a -&gt; Bool) -&gt; (Our a -&gt; Our a -&gt; Bool) -&gt; Eq (Our a)
forall a. Eq a =&gt; Our a -&gt; Our a -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall a. Eq a =&gt; Our a -&gt; Our a -&gt; Bool
== :: Our a -&gt; Our a -&gt; Bool
$c/= :: forall a. Eq a =&gt; Our a -&gt; Our a -&gt; Bool
/= :: Our a -&gt; Our a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679909413"><span id="local-6989586621679909417"><span id="local-6989586621679909421"><span class="annot"><span class="annottext">Int -&gt; Our a -&gt; ShowS
[Our a] -&gt; ShowS
Our a -&gt; String
(Int -&gt; Our a -&gt; ShowS)
-&gt; (Our a -&gt; String) -&gt; ([Our a] -&gt; ShowS) -&gt; Show (Our a)
forall a. Show a =&gt; Int -&gt; Our a -&gt; ShowS
forall a. Show a =&gt; [Our a] -&gt; ShowS
forall a. Show a =&gt; Our a -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; Our a -&gt; ShowS
showsPrec :: Int -&gt; Our a -&gt; ShowS
$cshow :: forall a. Show a =&gt; Our a -&gt; String
show :: Our a -&gt; String
$cshowList :: forall a. Show a =&gt; [Our a] -&gt; ShowS
showList :: [Our a] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909426"><span id="local-6989586621679909430"><span id="local-6989586621679909434"><span class="annot"><span class="annottext">Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
Proxy (Our a) -&gt; String
(Context -&gt; Our a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; Our a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy (Our a) -&gt; String)
-&gt; NoThunks (Our a)
forall a. NoThunks a =&gt; Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
forall a. NoThunks a =&gt; Proxy (Our a) -&gt; String
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: forall a. NoThunks a =&gt; Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: forall a. NoThunks a =&gt; Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; Our a -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: forall a. NoThunks a =&gt; Proxy (Our a) -&gt; String
showTypeOf :: Proxy (Our a) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span id="local-6989586621679908657"><span id="local-6989586621679908658"><span id="local-6989586621679908659"><span id="local-6989586621679908665"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#bracketChainSyncClient"><span class="hs-identifier hs-type">bracketChainSyncClient</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908658"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908659"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908659"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908659"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-161"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908658"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908659"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- ^ The candidate chains, we need the whole map because we</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- (de)register nodes (@peer@).</span><span>
</span><span id="line-164"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908658"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-165"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-166"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908659"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908665"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908665"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-168"></span><span id="bracketChainSyncClient"><span class="annot"><span class="annottext">bracketChainSyncClient :: forall (m :: * -&gt; *) peer blk a.
(IOLike m, Ord peer, LedgerSupportsProtocol blk) =&gt;
Tracer m (TraceChainSyncClientEvent blk)
-&gt; ChainDbView m blk
-&gt; StrictTVar
     m (Map peer (StrictTVar m (AnchoredFragment (Header blk))))
-&gt; peer
-&gt; NodeToNodeVersion
-&gt; (StrictTVar m (AnchoredFragment (Header blk)) -&gt; m a)
-&gt; m a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#bracketChainSyncClient"><span class="hs-identifier hs-var hs-var">bracketChainSyncClient</span></a></span></span><span>
</span><span id="line-169"></span><span>    </span><span id="local-6989586621679909486"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679909486"><span class="hs-identifier hs-var">tracer</span></a></span></span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679909487"><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
$sel:getIsInvalidBlock:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
getIsInvalidBlock :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="hs-identifier hs-var hs-var">getIsInvalidBlock</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621679909488"><span class="annot"><span class="annottext">StrictTVar
  m
  (Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
</span><a href="#local-6989586621679909488"><span class="hs-identifier hs-var">varCandidates</span></a></span></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621679909489"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679909489"><span class="hs-identifier hs-var">peer</span></a></span></span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621679909490"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679909490"><span class="hs-identifier hs-var">version</span></a></span></span><span>
</span><span id="line-174"></span><span>    </span><span id="local-6989586621679909491"><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; m a
</span><a href="#local-6989586621679909491"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>    </span><span class="annot"><span class="annottext">m (StrictTVar
     m
     (AnchoredSeq
        (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
-&gt; (StrictTVar
      m
      (AnchoredSeq
         (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
    -&gt; m ())
-&gt; (StrictTVar
      m
      (AnchoredSeq
         (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
    -&gt; m a)
-&gt; m a
forall a b c. m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="annot"><span class="annottext">m (StrictTVar
     m
     (AnchoredSeq
        (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
</span><a href="#local-6989586621679909493"><span class="hs-identifier hs-var">newCandidateVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; m ()
</span><a href="#local-6989586621679909494"><span class="hs-identifier hs-var">releaseCandidateVar</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="annottext">((StrictTVar
    m
    (AnchoredSeq
       (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
  -&gt; m a)
 -&gt; m a)
-&gt; (StrictTVar
      m
      (AnchoredSeq
         (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
    -&gt; m a)
-&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679909495"><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909495"><span class="hs-identifier hs-var">varCandidate</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
-&gt; m a
-&gt; m a
forall (m :: * -&gt; *) a fp r.
(IOLike m, Eq fp, HasCallStack) =&gt;
String -&gt; Watcher m a fp -&gt; m r -&gt; m r
</span><a href="Ouroboros.Consensus.Util.STM.html#withWatcher"><span class="hs-identifier hs-var">withWatcher</span></a></span><span>
</span><span id="line-179"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ChainSync.Client.rejectInvalidBlocks&quot;</span></span><span>
</span><span id="line-180"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="#local-6989586621679909496"><span class="hs-identifier hs-var">invalidBlockWatcher</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909495"><span class="hs-identifier hs-var">varCandidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>      </span><span class="annot"><span class="annottext">(m a -&gt; m a) -&gt; m a -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; m a
</span><a href="#local-6989586621679909491"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909495"><span class="hs-identifier hs-var">varCandidate</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-183"></span><span>    </span><span id="local-6989586621679909493"><span class="annot"><span class="annottext">newCandidateVar :: m (StrictTVar
     m
     (AnchoredSeq
        (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
</span><a href="#local-6989586621679909493"><span class="hs-identifier hs-var hs-var">newCandidateVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>        </span><span id="local-6989586621679909497"><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909497"><span class="hs-identifier hs-var">varCandidate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; m (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
 -&gt; m (StrictTVar
         m
         (AnchoredSeq
            (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
-&gt; AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; m (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
-&gt; AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
forall v a b. Anchorable v a b =&gt; a -&gt; AnchoredSeq v a b
</span><span class="hs-identifier hs-var">AF.Empty</span></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk)
forall block. Anchor block
</span><span class="hs-identifier hs-var">AF.AnchorGenesis</span></span><span>
</span><span id="line-185"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
-&gt; (Map
      peer
      (StrictTVar
         m
         (AnchoredSeq
            (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
    -&gt; Map
         peer
         (StrictTVar
            m
            (AnchoredSeq
               (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
</span><a href="#local-6989586621679909488"><span class="hs-identifier hs-var">varCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    peer
    (StrictTVar
       m
       (AnchoredSeq
          (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
  -&gt; Map
       peer
       (StrictTVar
          m
          (AnchoredSeq
             (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
 -&gt; STM m ())
-&gt; (Map
      peer
      (StrictTVar
         m
         (AnchoredSeq
            (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
    -&gt; Map
         peer
         (StrictTVar
            m
            (AnchoredSeq
               (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">peer
-&gt; StrictTVar
     m
     (AnchoredSeq
        (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
-&gt; Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#insert"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679909489"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909497"><span class="hs-identifier hs-var">varCandidate</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; m (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909497"><span class="hs-identifier hs-var">varCandidate</span></a></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621679909494"><span class="annot"><span class="annottext">releaseCandidateVar :: StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; m ()
</span><a href="#local-6989586621679909494"><span class="hs-identifier hs-var hs-var">releaseCandidateVar</span></a></span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
-&gt; (Map
      peer
      (StrictTVar
         m
         (AnchoredSeq
            (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
    -&gt; Map
         peer
         (StrictTVar
            m
            (AnchoredSeq
               (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
-&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
StrictTVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
</span><a href="#local-6989586621679909488"><span class="hs-identifier hs-var">varCandidates</span></a></span><span> </span><span class="annot"><span class="annottext">((Map
    peer
    (StrictTVar
       m
       (AnchoredSeq
          (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
  -&gt; Map
       peer
       (StrictTVar
          m
          (AnchoredSeq
             (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
 -&gt; STM m ())
-&gt; (Map
      peer
      (StrictTVar
         m
         (AnchoredSeq
            (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
    -&gt; Map
         peer
         (StrictTVar
            m
            (AnchoredSeq
               (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))))
-&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">peer
-&gt; Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
-&gt; Map
     peer
     (StrictTVar
        m
        (AnchoredSeq
           (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#delete"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679909489"><span class="hs-identifier hs-var">peer</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621679909496"><span class="annot"><span class="annottext">invalidBlockWatcher :: StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="#local-6989586621679909496"><span class="hs-identifier hs-var hs-var">invalidBlockWatcher</span></a></span></span><span> </span><span id="local-6989586621679909505"><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909505"><span class="hs-identifier hs-var">varCandidate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; NodeToNodeVersion
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM
     m
     (AnchoredSeq
        (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
Tracer m (TraceChainSyncClientEvent blk)
-&gt; NodeToNodeVersion
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#invalidBlockRejector"><span class="hs-identifier hs-var">invalidBlockRejector</span></a></span><span>
</span><span id="line-193"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679909486"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679909490"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621679909487"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
-&gt; STM
     m
     (AnchoredSeq
        (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m
  (AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk))
</span><a href="#local-6989586621679909505"><span class="hs-identifier hs-var">varCandidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- Our task: after connecting to an upstream node, try to maintain an</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- up-to-date header-only fragment representing their chain. We maintain</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- such candidate fragments in a map with upstream nodes as keys.</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- The block fetch logic will use these candidate fragments to download</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- blocks from, prioritising certain candidate fragments over others using</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- the consensus protocol. Whenever such a block has been downloaded and</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- added to the local 'ChainDB', the 'ChainDB' will perform chain</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- selection.</span><span>
</span><span id="line-204"></span><span class="hs-comment">--</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- We also validate the headers of a candidate fragment by advancing the</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- 'ChainDepState' with the headers, which returns an error when validation</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- failed. Thus, in addition to the chain fragment of each candidate, we also</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- store a 'ChainDepState' corresponding to the head of the candidate fragment.</span><span>
</span><span id="line-209"></span><span class="hs-comment">--</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- We must keep the candidate fragment synchronised with the corresponding</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- upstream chain. The upstream node's chain might roll forward or</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- backwards, and they will inform us about this. When we get these</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- messages, we will replicate these actions on the candidate fragment.</span><span>
</span><span id="line-214"></span><span class="hs-comment">--</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- INVARIANT:</span><span>
</span><span id="line-216"></span><span class="hs-comment">--</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- &gt;           our tip</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- &gt;             v</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- &gt;   /--* .... *</span><span>
</span><span id="line-220"></span><span class="hs-comment">-- &gt;   |</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- &gt; --*</span><span>
</span><span id="line-222"></span><span class="hs-comment">-- &gt;   |</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- &gt;   \--* .... *</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- &gt;        fragment tip</span><span>
</span><span id="line-225"></span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- The distance from our tip to the intersection between our chain and the</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- fragment maintained for the upstream node cannot exceed @k@ blocks. When</span><span>
</span><span id="line-228"></span><span class="hs-comment">-- this invariant cannot be maintained, the upstream node is on a fork that</span><span>
</span><span id="line-229"></span><span class="hs-comment">-- is too distant and we should disconnect.</span><span>
</span><span id="line-230"></span><span class="hs-comment">--</span><span>
</span><span id="line-231"></span><span class="hs-comment">-- TODO #423 rate-limit switching chains, otherwise we can't place blame (we</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- don't know which candidate's chain included the point that was</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- poisoned). E.g. two rollbacks per time slot -&gt; make it configurable -&gt;</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- just a simple argument for now.</span><span>
</span><span id="line-235"></span><span class="hs-comment">--</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- TODO #467 if the 'theirTip' that they sent us is on our chain, just</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- switch to it.</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="hs-comment">-- = Candidate fragment size</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- -------------------------</span><span>
</span><span id="line-242"></span><span class="hs-comment">--</span><span>
</span><span id="line-243"></span><span class="hs-comment">-- The size of the downloaded candidate fragment ('theirFrag') and the</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- corresponding header state history ('theirHeaderStateHistory', which has the</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- same size as 'theirFrag') is limited by how far in the future the ledger</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- view can forecast.</span><span>
</span><span id="line-247"></span><span class="hs-comment">--</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- For PBFT (Byron), we can forecast up to @2k@ slots ahead. Assuming a chain</span><span>
</span><span id="line-249"></span><span class="hs-comment">-- density of 100%, this means the look-ahead is @2k@ headers. For mainnet this</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- means @2 * 2160 = 4320@ headers.</span><span>
</span><span id="line-251"></span><span class="hs-comment">--</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- For TPraos (Shelley), we can forecast up to @3k/f@ slots ahead. Assuming a</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- density of @f@, this means the look-ahead is @3k@ headers. For mainnet, this</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- means @3 * 2160 = 6480@ headers.</span><span>
</span><span id="line-255"></span><span class="hs-comment">--</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- The figure below shows the relation between 'ourFrag' and 'theirFrag':</span><span>
</span><span id="line-257"></span><span class="hs-comment">--</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- &gt;                       k headers or less, when A is genesis</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- &gt;              &lt;---------------------&gt;</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- &gt;            anchor    header       tip</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- &gt;              |         |           |</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- &gt;              V         V           V</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- &gt; 'ourFrag':   A-H-H-H-H-H-H-H-H-...-H</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- &gt;                     \</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- &gt; 'theirFrag':         H-H-H-H-...   ...   ...</span><span>
</span><span id="line-266"></span><span class="hs-comment">-- &gt;                    ^</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- &gt;                    |</span><span>
</span><span id="line-268"></span><span class="hs-comment">-- &gt;           most recent intersection (between A and the tip)</span><span>
</span><span id="line-269"></span><span class="hs-comment">--</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- Note that the 'ourFrag' and 'theirFrag' share anchors /at all times/. In the</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- figure above, the first three headers on 'ourFrag' are thus also on</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- 'theirFrag'. The further away the most recent intersection is from the</span><span>
</span><span id="line-273"></span><span class="hs-comment">-- anchor point, the more headers 'theirFrag' and 'ourFrag' will have in</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- common.</span><span>
</span><span id="line-275"></span><span class="hs-comment">--</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- In the \&quot;worst\&quot; case 'theirFrag' has the following length:</span><span>
</span><span id="line-277"></span><span class="hs-comment">--</span><span>
</span><span id="line-278"></span><span class="hs-comment">-- &gt;                        k</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- &gt;              &lt;---------------------&gt;</span><span>
</span><span id="line-280"></span><span class="hs-comment">-- &gt; 'ourFrag':   A-H-H-H-H-H-H-H-H-...-H</span><span>
</span><span id="line-281"></span><span class="hs-comment">-- &gt;                                    \</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- &gt; 'theirFrag':                        H-H-H-H-H-H-H-H-H-H-H-H-H-H-H...-H</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- &gt;                                     &lt;--------------------------------&gt;</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- &gt;                                               max look-ahead</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- &gt; max length   &lt;-------------------------------------------------------&gt;</span><span>
</span><span id="line-286"></span><span class="hs-comment">-- &gt; of 'theirFrag'         k + max look-ahead</span><span>
</span><span id="line-287"></span><span class="hs-comment">--</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- For PBFT this is @2160 + 4320 = 6480@ headers, for TPraos this is @2160 +</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- 6480 = 8640@ headers. The header state history will have the same length.</span><span>
</span><span id="line-290"></span><span class="hs-comment">--</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- This worst case can happen when:</span><span>
</span><span id="line-292"></span><span class="annot"><span class="hs-comment">-- * We are more than 6480 or respectively 8640 blocks behind, bulk syncing,</span></span><span>
</span><span id="line-293"></span><span class="hs-comment">--   and the BlockFetch client and/or the ChainDB can't keep up with the</span><span>
</span><span id="line-294"></span><span class="hs-comment">--   ChainSync client.</span><span>
</span><span id="line-295"></span><span class="annot"><span class="hs-comment">-- * When our clock is running behind such that we are not adopting the</span></span><span>
</span><span id="line-296"></span><span class="hs-comment">--   corresponding blocks because we think they are from the future.</span><span>
</span><span id="line-297"></span><span class="annot"><span class="hs-comment">-- * When an attacker is serving us headers from the future.</span></span><span>
</span><span id="line-298"></span><span class="hs-comment">--</span><span>
</span><span id="line-299"></span><span class="hs-comment">-- When we are in sync with the network, the fragment will typically be @k@ to</span><span>
</span><span id="line-300"></span><span class="hs-comment">-- @k + 1@ headers long.</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- | State used when the intersection between the candidate and the current</span><span>
</span><span id="line-303"></span><span class="hs-comment">-- chain is unknown.</span><span>
</span><span id="line-304"></span><span class="hs-keyword">data</span><span> </span><span id="UnknownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-var">UnknownIntersectionState</span></a></span></span><span> </span><span id="local-6989586621679908720"><span class="annot"><a href="#local-6989586621679908720"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="UnknownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-var">UnknownIntersectionState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-305"></span><span>    </span><span id="%24sel%3AourFrag%3AUnknownIntersectionState"><span class="annot"><span class="annottext">forall blk.
UnknownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AUnknownIntersectionState"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908720"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">-- ^ A view of the current chain fragment. Note that this might be</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">-- temporarily out of date w.r.t. the actual current chain until we update</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- it again.</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- This fragment is used to select points from to find an intersection</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-comment">-- with the candidate.</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- INVARIANT: 'ourFrag' contains @k@ headers, unless close to genesis.</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-315"></span><span>    </span><span id="%24sel%3AourHeaderStateHistory%3AUnknownIntersectionState"><span class="annot"><span class="annottext">forall blk. UnknownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourHeaderStateHistory%3AUnknownIntersectionState"><span class="hs-identifier hs-var hs-var">ourHeaderStateHistory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908720"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- ^ 'HeaderStateHistory' corresponding to the tip (most recent block) of</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">-- 'ourFrag'.</span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679909514"><span id="local-6989586621679909516"><span class="annot"><span class="annottext">(forall x.
 UnknownIntersectionState blk
 -&gt; Rep (UnknownIntersectionState blk) x)
-&gt; (forall x.
    Rep (UnknownIntersectionState blk) x
    -&gt; UnknownIntersectionState blk)
-&gt; Generic (UnknownIntersectionState blk)
forall x.
Rep (UnknownIntersectionState blk) x
-&gt; UnknownIntersectionState blk
forall x.
UnknownIntersectionState blk
-&gt; Rep (UnknownIntersectionState blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x.
Rep (UnknownIntersectionState blk) x
-&gt; UnknownIntersectionState blk
forall blk x.
UnknownIntersectionState blk
-&gt; Rep (UnknownIntersectionState blk) x
$cfrom :: forall blk x.
UnknownIntersectionState blk
-&gt; Rep (UnknownIntersectionState blk) x
from :: forall x.
UnknownIntersectionState blk
-&gt; Rep (UnknownIntersectionState blk) x
$cto :: forall blk x.
Rep (UnknownIntersectionState blk) x
-&gt; UnknownIntersectionState blk
to :: forall x.
Rep (UnknownIntersectionState blk) x
-&gt; UnknownIntersectionState blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="hs-keyword">instance</span><span>
</span><span id="line-322"></span><span>     </span><span id="local-6989586621679908762"><span id="local-6989586621679909521"><span id="local-6989586621679909525"><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908762"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-323"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908762"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-324"></span><span>    </span><span id="local-6989586621679909572"><span class="annot"><span class="annottext">showTypeOf :: Proxy (UnknownIntersectionState blk) -&gt; String
</span><a href="#local-6989586621679909572"><span class="hs-identifier hs-var hs-var hs-var hs-var">showTypeOf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy (UnknownIntersectionState blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeRep -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeRep -&gt; String) -&gt; TypeRep -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy (UnknownIntersectionState blk) -&gt; TypeRep
forall {k} (proxy :: k -&gt; *) (a :: k).
Typeable a =&gt;
proxy a -&gt; TypeRep
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#typeRep"><span class="hs-identifier hs-var">typeRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908762"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span class="hs-comment">-- | State used when the intersection between the candidate and the current</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- chain is known.</span><span>
</span><span id="line-328"></span><span class="hs-keyword">data</span><span> </span><span id="KnownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-var">KnownIntersectionState</span></a></span></span><span> </span><span id="local-6989586621679908769"><span class="annot"><a href="#local-6989586621679908769"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="KnownIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-var">KnownIntersectionState</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-329"></span><span>    </span><span id="%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="annot"><span class="annottext">forall blk. KnownIntersectionState blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679908769"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-comment">-- ^ The most recent intersection point between 'theirFrag' and 'ourFrag'.</span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-comment">-- Note that this is not necessarily the anchor point of both 'theirFrag'</span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-comment">-- and 'ourFrag', they might have many more headers in common.</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-comment">-- INVARIANT:</span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-comment">-- @</span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-comment">-- (==)</span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-comment">--     (Just 'mostRecentIntersection')</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-comment">--     ('AF.intersectionPoint' 'theirFrag' 'ourFrag')</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-comment">-- @</span><span>
</span><span id="line-340"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-comment">-- It follows from the invariants on 'ourFrag' that this point is within</span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-comment">-- the last @k@ headers of the current chain fragment, at time of</span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-comment">-- computing the 'KnownIntersectionState'.</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-345"></span><span>    </span><span id="ourFrag"><span class="annot"><span class="annottext">forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>                 </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908769"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-comment">-- ^ A view of the current chain fragment used to maintain the invariants</span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-comment">-- with. Note that this might be temporarily out of date w.r.t. the actual</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-comment">-- current chain until we update it again.</span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-comment">-- INVARIANT: 'ourFrag' contains @k@ headers, unless close to genesis.</span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-comment">-- INVARIANT: 'theirFrag' and 'ourFrag' have the same anchor point. From</span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-comment">-- this follows that both fragments intersect. This also means that</span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-comment">-- 'theirFrag' forks off within the last @k@ headers/blocks of the</span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-comment">-- 'ourFrag'.</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-357"></span><span>    </span><span id="theirFrag"><span class="annot"><span class="annottext">forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>               </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908769"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-comment">-- ^ The candidate, the synched fragment of their chain.</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-comment">-- See the \&quot;Candidate fragment size\&quot; note above.</span><span>
</span><span id="line-361"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-362"></span><span>    </span><span id="%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="annot"><span class="annottext">forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908769"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-comment">-- ^ 'HeaderStateHistory' corresponding to the tip (most recent block) of</span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-comment">-- 'theirFrag'.</span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-comment">-- INVARIANT: the tips in 'theirHeaderStateHistory' correspond to the</span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-comment">-- headers in 'theirFrag', including the anchor.</span><span>
</span><span id="line-368"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-comment">-- See the \&quot;Candidate fragment size\&quot; note above.</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679909583"><span id="local-6989586621679909585"><span class="annot"><span class="annottext">(forall x.
 KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x)
-&gt; (forall x.
    Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk)
-&gt; Generic (KnownIntersectionState blk)
forall x.
Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk
forall x.
KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x.
Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk
forall blk x.
KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x
$cfrom :: forall blk x.
KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x
from :: forall x.
KnownIntersectionState blk -&gt; Rep (KnownIntersectionState blk) x
$cto :: forall blk x.
Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk
to :: forall x.
Rep (KnownIntersectionState blk) x -&gt; KnownIntersectionState blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-keyword">instance</span><span>
</span><span id="line-374"></span><span>     </span><span id="local-6989586621679908780"><span id="local-6989586621679909589"><span id="local-6989586621679909593"><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908780"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908780"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621679909641"><span class="annot"><span class="annottext">showTypeOf :: Proxy (KnownIntersectionState blk) -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">showTypeOf</span></span></span><span> </span><span class="annot"><span class="annottext">Proxy (KnownIntersectionState blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeRep -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeRep -&gt; String) -&gt; TypeRep -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy (KnownIntersectionState blk) -&gt; TypeRep
forall {k} (proxy :: k -&gt; *) (a :: k).
Typeable a =&gt;
proxy a -&gt; TypeRep
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#typeRep"><span class="hs-identifier hs-var">typeRep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908780"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span id="local-6989586621679908781"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownIntersectionInvariants"><span class="hs-identifier hs-type">checkKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-379"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679908781"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-380"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908781"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HasAnnTip"><span class="hs-identifier hs-type">HasAnnTip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908781"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusProtocol"><span class="hs-identifier hs-type">ConsensusProtocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908781"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-type">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908781"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908781"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-386"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-387"></span><span id="checkKnownIntersectionInvariants"><span class="annot"><span class="annottext">checkKnownIntersectionInvariants :: forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; Either String ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownIntersectionInvariants"><span class="hs-identifier hs-var hs-var">checkKnownIntersectionInvariants</span></a></span></span><span> </span><span id="local-6989586621679909712"><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621679909712"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679909713"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909713"><span class="hs-identifier hs-var">kis</span></a></span></span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-comment">-- 'theirHeaderStateHistory' invariant</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span id="local-6989586621679909714"><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
</span><a href="#local-6989586621679909714"><span class="hs-identifier hs-var">snapshots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679909715"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span>
</span><span id="line-390"></span><span>          </span><span id="local-6989586621679909716"><span class="annot"><span class="annottext">historyTips :: [WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621679909716"><span class="hs-identifier hs-var hs-var">historyTips</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderState blk -&gt; WithOrigin (AnnTip blk)
forall blk. HeaderState blk -&gt; WithOrigin (AnnTip blk)
</span><a href="Ouroboros.Consensus.HeaderValidation.html#headerStateTip"><span class="hs-identifier hs-var">headerStateTip</span></a></span><span>        </span><span class="annot"><span class="annottext">(HeaderState blk -&gt; WithOrigin (AnnTip blk))
-&gt; [HeaderState blk] -&gt; [WithOrigin (AnnTip blk)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
-&gt; [HeaderState blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AS.toOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
</span><a href="#local-6989586621679909714"><span class="hs-identifier hs-var">snapshots</span></a></span><span>
</span><span id="line-391"></span><span>          </span><span id="local-6989586621679909720"><span class="annot"><span class="annottext">fragmentTips :: [WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621679909720"><span class="hs-identifier hs-var hs-var">fragmentTips</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnTip blk -&gt; WithOrigin (AnnTip blk)
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">(AnnTip blk -&gt; WithOrigin (AnnTip blk))
-&gt; (Header blk -&gt; AnnTip blk)
-&gt; Header blk
-&gt; WithOrigin (AnnTip blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; AnnTip blk
forall blk.
(HasHeader (Header blk), HasAnnTip blk) =&gt;
Header blk -&gt; AnnTip blk
</span><a href="Ouroboros.Consensus.HeaderValidation.html#getAnnTip"><span class="hs-identifier hs-var">getAnnTip</span></a></span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; WithOrigin (AnnTip blk))
-&gt; [Header blk] -&gt; [WithOrigin (AnnTip blk)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AF.toOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909724"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>          </span><span id="local-6989586621679909725"><span class="annot"><span class="annottext">fragmentAnchorPoint :: Point blk
</span><a href="#local-6989586621679909725"><span class="hs-identifier hs-var hs-var">fragmentAnchorPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909724"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-394"></span><span>          </span><span id="local-6989586621679909728"><span class="annot"><span class="annottext">historyAnchorPoint :: Point blk
</span><a href="#local-6989586621679909728"><span class="hs-identifier hs-var hs-var">historyAnchorPoint</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>              </span><span class="annot"><span class="annottext">WithOrigin (RealPoint blk) -&gt; Point blk
forall blk. WithOrigin (RealPoint blk) -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#withOriginRealPointToPoint"><span class="hs-identifier hs-var">withOriginRealPointToPoint</span></a></span><span>
</span><span id="line-396"></span><span>            </span><span class="annot"><span class="annottext">(WithOrigin (RealPoint blk) -&gt; Point blk)
-&gt; WithOrigin (RealPoint blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnnTip blk -&gt; RealPoint blk
forall blk. HasAnnTip blk =&gt; AnnTip blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.HeaderValidation.html#annTipRealPoint"><span class="hs-identifier hs-var">annTipRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(AnnTip blk -&gt; RealPoint blk)
-&gt; WithOrigin (AnnTip blk) -&gt; WithOrigin (RealPoint blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderState blk -&gt; WithOrigin (AnnTip blk)
forall blk. HeaderState blk -&gt; WithOrigin (AnnTip blk)
</span><a href="Ouroboros.Consensus.HeaderValidation.html#headerStateTip"><span class="hs-identifier hs-var">headerStateTip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
-&gt; HeaderState blk
forall v a b. AnchoredSeq v a b -&gt; a
</span><span class="hs-identifier hs-var">AS.anchor</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (HeaderState blk) (HeaderState blk)
</span><a href="#local-6989586621679909714"><span class="hs-identifier hs-var">snapshots</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-special">,</span><span>    </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621679909716"><span class="hs-identifier hs-var">historyTips</span></a></span><span>        </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)] -&gt; [WithOrigin (AnnTip blk)] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621679909720"><span class="hs-identifier hs-var">fragmentTips</span></a></span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span>
</span><span id="line-399"></span><span>         </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679909728"><span class="hs-identifier hs-var">historyAnchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679909725"><span class="hs-identifier hs-var">fragmentAnchorPoint</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a. String -&gt; Either String a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#unwords"><span class="hs-identifier hs-var">unwords</span></a></span><span>
</span><span id="line-401"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;The tips in theirHeaderStateHistory&quot;</span></span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;didn't match the headers in theirFrag:&quot;</span></span><span>
</span><span id="line-403"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621679909716"><span class="hs-identifier hs-var">historyTips</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)] -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">[WithOrigin (AnnTip blk)]
</span><a href="#local-6989586621679909720"><span class="hs-identifier hs-var">fragmentTips</span></a></span><span>
</span><span id="line-406"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;with anchors&quot;</span></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679909728"><span class="hs-identifier hs-var">historyAnchorPoint</span></a></span><span>
</span><span id="line-408"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-409"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679909725"><span class="hs-identifier hs-var">fragmentAnchorPoint</span></a></span><span>
</span><span id="line-410"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-comment">-- 'ourFrag' invariants</span><span>
</span><span id="line-413"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679909735"><span class="annot"><span class="annottext">nbHeaders :: Int
</span><a href="#local-6989586621679909735"><span class="hs-identifier hs-var hs-var">nbHeaders</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><span class="hs-identifier hs-var">AF.length</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909737"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-414"></span><span>          </span><span id="local-6989586621679909738"><span class="annot"><span class="annottext">ourAnchorPoint :: Point (Header blk)
</span><a href="#local-6989586621679909738"><span class="hs-identifier hs-var hs-var">ourAnchorPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909737"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679909735"><span class="hs-identifier hs-var">nbHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679909740"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909738"><span class="hs-identifier hs-var">ourAnchorPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
forall {k} (block :: k). Point block
</span><span class="hs-identifier hs-var">GenesisPoint</span></span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a. String -&gt; Either String a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#unwords"><span class="hs-identifier hs-var">unwords</span></a></span><span>
</span><span id="line-418"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ourFrag contains fewer than k headers and not close to genesis:&quot;</span></span><span>
</span><span id="line-419"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679909735"><span class="hs-identifier hs-var">nbHeaders</span></a></span><span>
</span><span id="line-420"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679909740"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-422"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;with anchor&quot;</span></span><span>
</span><span id="line-423"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909738"><span class="hs-identifier hs-var">ourAnchorPoint</span></a></span><span>
</span><span id="line-424"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679909742"><span class="annot"><span class="annottext">ourFragAnchor :: Point (Header blk)
</span><a href="#local-6989586621679909742"><span class="hs-identifier hs-var hs-var">ourFragAnchor</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909737"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-427"></span><span>          </span><span id="local-6989586621679909743"><span class="annot"><span class="annottext">theirFragAnchor :: Point (Header blk)
</span><a href="#local-6989586621679909743"><span class="hs-identifier hs-var hs-var">theirFragAnchor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909724"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909742"><span class="hs-identifier hs-var">ourFragAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909743"><span class="hs-identifier hs-var">theirFragAnchor</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a. String -&gt; Either String a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#unwords"><span class="hs-identifier hs-var">unwords</span></a></span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ourFrag and theirFrag have different anchor points:&quot;</span></span><span>
</span><span id="line-431"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909742"><span class="hs-identifier hs-var">ourFragAnchor</span></a></span><span>
</span><span id="line-432"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909743"><span class="hs-identifier hs-var">theirFragAnchor</span></a></span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-435"></span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-comment">-- 'mostRecentIntersection' invariant</span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679909744"><span class="annot"><span class="annottext">actualMostRecentIntersection :: Maybe (Point blk)
</span><a href="#local-6989586621679909744"><span class="hs-identifier hs-var hs-var">actualMostRecentIntersection</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-438"></span><span>              </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Maybe (Point (Header blk)) -&gt; Maybe (Point blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; AnchoredSeq
     (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
-&gt; Maybe (Point (Header blk))
forall block1 block2.
(HasHeader block1, HasHeader block2,
 HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; AnchoredFragment block2 -&gt; Maybe (Point block1)
</span><span class="hs-identifier hs-var">AF.intersectionPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909724"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="#local-6989586621679909737"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-439"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Maybe (Point blk)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679909745"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk) -&gt; Maybe (Point blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk)
</span><a href="#local-6989586621679909744"><span class="hs-identifier hs-var">actualMostRecentIntersection</span></a></span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a. String -&gt; Either String a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String ()) -&gt; String -&gt; Either String ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#unwords"><span class="hs-identifier hs-var">unwords</span></a></span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mostRecentIntersection not the most recent intersection&quot;</span></span><span>
</span><span id="line-442"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;of theirFrag and ourFrag:&quot;</span></span><span>
</span><span id="line-443"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679909745"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-444"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;vs&quot;</span></span><span>
</span><span id="line-445"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Point blk)
</span><a href="#local-6989586621679909744"><span class="hs-identifier hs-var">actualMostRecentIntersection</span></a></span><span>
</span><span id="line-446"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either String ()
forall a. a -&gt; Either String a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621679909740"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679909740"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk) -&gt; SecurityParam
forall p. ConsensusProtocol p =&gt; ConsensusConfig p -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#protocolSecurityParam"><span class="hs-identifier hs-var">protocolSecurityParam</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621679909712"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-454"></span><span>        </span><span id="local-6989586621679909745"><span class="annot"><span class="annottext">Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
mostRecentIntersection :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-455"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909737"><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
ourFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
ourFrag :: AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909724"><span class="annot"><span class="annottext">AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
theirFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
theirFrag :: AnchoredSeq (WithOrigin SlotNo) (Anchor (Header blk)) (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909715"><span class="annot"><span class="annottext">HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-458"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909713"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span id="local-6989586621679908841"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-type">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679908841"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908841"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HasAnnTip"><span class="hs-identifier hs-type">HasAnnTip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908841"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusProtocol"><span class="hs-identifier hs-type">ConsensusProtocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908841"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#ConsensusConfig"><span class="hs-identifier hs-type">ConsensusConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908841"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908841"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-469"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908841"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-470"></span><span id="assertKnownIntersectionInvariants"><span class="annot"><span class="annottext">assertKnownIntersectionInvariants :: forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var hs-var">assertKnownIntersectionInvariants</span></a></span></span><span> </span><span id="local-6989586621679909760"><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621679909760"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679909761"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909761"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-471"></span><span>    </span><span class="annot"><span class="annottext">Either String ()
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a. HasCallStack =&gt; Either String () -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Util.Assert.html#assertWithMsg"><span class="hs-identifier hs-var">assertWithMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; Either String ()
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; Either String ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownIntersectionInvariants"><span class="hs-identifier hs-var">checkKnownIntersectionInvariants</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
</span><a href="#local-6989586621679909760"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909761"><span class="hs-identifier hs-var">kis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909761"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  The ChainSync client definition
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-476"></span><span>
</span><span id="line-477"></span><span class="hs-comment">-- | Arguments determined by configuration</span><span>
</span><span id="line-478"></span><span class="hs-comment">--</span><span>
</span><span id="line-479"></span><span class="hs-comment">-- These are available before the diffusion layer is online.</span><span>
</span><span id="line-480"></span><span class="hs-keyword">data</span><span> </span><span id="ConfigEnv"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-var">ConfigEnv</span></a></span></span><span> </span><span id="local-6989586621679908844"><span class="annot"><a href="#local-6989586621679908844"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908845"><span class="annot"><a href="#local-6989586621679908845"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ConfigEnv"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-var">ConfigEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-481"></span><span>    </span><span id="%24sel%3AmkPipelineDecision0%3AConfigEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; MkPipelineDecision
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmkPipelineDecision0%3AConfigEnv"><span class="hs-identifier hs-var hs-var">mkPipelineDecision0</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MkPipelineDecision</span></span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The pipelining decider to use after 'MsgFoundIntersect' arrives</span></span><span>
</span><span id="line-483"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Atracer%3AConfigEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ConfigEnv m blk -&gt; Tracer m (TraceChainSyncClientEvent blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Atracer%3AConfigEnv"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span>                  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679908844"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908845"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Acfg%3AConfigEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; TopLevelConfig blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Acfg%3AConfigEnv"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>                     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908845"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-485"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AsomeHeaderInFutureCheck%3AConfigEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ConfigEnv m blk -&gt; SomeHeaderInFutureCheck m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AsomeHeaderInFutureCheck%3AConfigEnv"><span class="hs-identifier hs-var hs-var">someHeaderInFutureCheck</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html#SomeHeaderInFutureCheck"><span class="hs-identifier hs-type">InFutureCheck.SomeHeaderInFutureCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908844"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908845"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AchainDbView%3AConfigEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AchainDbView%3AConfigEnv"><span class="hs-identifier hs-var hs-var">chainDbView</span></a></span></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908844"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908845"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-comment">-- | Arguments determined dynamically</span><span>
</span><span id="line-490"></span><span class="hs-comment">--</span><span>
</span><span id="line-491"></span><span class="hs-comment">-- These are available only after the diffusion layer is online and/or on per</span><span>
</span><span id="line-492"></span><span class="hs-comment">-- client basis.</span><span>
</span><span id="line-493"></span><span class="hs-keyword">data</span><span> </span><span id="DynamicEnv"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-var">DynamicEnv</span></a></span></span><span> </span><span id="local-6989586621679908860"><span class="annot"><a href="#local-6989586621679908860"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908861"><span class="annot"><a href="#local-6989586621679908861"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DynamicEnv"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-var">DynamicEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-494"></span><span>    </span><span id="%24sel%3Aversion%3ADynamicEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. DynamicEnv m blk -&gt; NodeToNodeVersion
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Aversion%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AcontrolMessageSTM%3ADynamicEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. DynamicEnv m blk -&gt; ControlMessageSTM m
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AcontrolMessageSTM%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">controlMessageSTM</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ControlMessageSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908860"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AheaderMetricsTracer%3ADynamicEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. DynamicEnv m blk -&gt; HeaderMetricsTracer m
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AheaderMetricsTracer%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">headerMetricsTracer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderMetricsTracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679908860"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AvarCandidate%3ADynamicEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
DynamicEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AvarCandidate%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">varCandidate</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679908860"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908861"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span class="annot"><span class="hs-comment">-- | General values collectively needed by the top-level entry points</span></span><span>
</span><span id="line-501"></span><span class="hs-keyword">data</span><span> </span><span id="InternalEnv"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-var">InternalEnv</span></a></span></span><span> </span><span id="local-6989586621679908873"><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908874"><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679908875"><span class="annot"><a href="#local-6989586621679908875"><span class="hs-identifier hs-type">arrival</span></a></span></span><span> </span><span id="local-6989586621679908876"><span class="annot"><a href="#local-6989586621679908876"><span class="hs-identifier hs-type">judgment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InternalEnv"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-var">InternalEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-502"></span><span>    </span><span id="%24sel%3AdrainThePipe%3AInternalEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall s (n :: N).
   NoThunks s =&gt;
   Nat n
   -&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
   -&gt; Stateful m blk s (ClientPipelinedStIdle n)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AdrainThePipe%3AInternalEnv"><span class="hs-identifier hs-var hs-var">drainThePipe</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-503"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908879"><span class="annot"><a href="#local-6989586621679908879"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679908880"><span class="annot"><a href="#local-6989586621679908880"><span class="hs-identifier hs-type">n</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-504"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679908879"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-505"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679908880"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-506"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908879"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908879"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679908880"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-comment">-- ^ &quot;Drain the pipe&quot;: collect and discard all in-flight responses and</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-comment">-- finally execute the given action.</span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-511"></span><span>    </span><span id="%24sel%3Adisconnect%3AInternalEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall (m' :: * -&gt; *) a.
   MonadThrow m' =&gt;
   ChainSyncClientException -&gt; m' a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Adisconnect%3AInternalEnv"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-512"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908891"><span class="annot"><a href="#local-6989586621679908891"><span class="hs-identifier hs-type">m'</span></a></span></span><span> </span><span id="local-6989586621679908893"><span class="annot"><a href="#local-6989586621679908893"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-513"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679908891"><span class="hs-identifier hs-type">m'</span></a></span><span>
</span><span id="line-514"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span><span>
</span><span id="line-515"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908891"><span class="hs-identifier hs-type">m'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908893"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-516"></span><span>    </span><span class="hs-comment">-- ^ Disconnect from the upstream node by throwing the given exception.</span><span>
</span><span id="line-517"></span><span>    </span><span class="hs-comment">-- The cleanup is handled in 'bracketChainSyncClient'.</span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-519"></span><span>    </span><span id="%24sel%3AheaderInFutureCheck%3AInternalEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; HeaderInFutureCheck m blk arrival judgment
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AheaderInFutureCheck%3AInternalEnv"><span class="hs-identifier hs-var hs-var">headerInFutureCheck</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-520"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html#HeaderInFutureCheck"><span class="hs-identifier hs-type">InFutureCheck.HeaderInFutureCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908875"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908876"><span class="hs-identifier hs-type">judgment</span></a></span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-522"></span><span>    </span><span id="%24sel%3AintersectsWithCurrentChain%3AInternalEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AintersectsWithCurrentChain%3AInternalEnv"><span class="hs-identifier hs-var hs-var">intersectsWithCurrentChain</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-523"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-524"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UpdatedIntersectionState"><span class="hs-identifier hs-type">UpdatedIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-comment">-- ^ A combinator necessary whenever relying on a</span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-comment">-- 'KnownIntersectionState', since it's always possible that that</span><span>
</span><span id="line-527"></span><span>    </span><span class="hs-comment">-- intersection will go stale.</span><span>
</span><span id="line-528"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-comment">-- Look at the current chain fragment that may have been updated in the</span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-comment">-- background. Check whether the candidate fragment still intersects with</span><span>
</span><span id="line-531"></span><span>    </span><span class="hs-comment">-- it. If so, update the 'KnownIntersectionState' and trim the candidate</span><span>
</span><span id="line-532"></span><span>    </span><span class="hs-comment">-- fragment to the new current chain fragment's anchor point. If not,</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-comment">-- return 'Nothing'.</span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-535"></span><span>    </span><span class="hs-comment">-- INVARIANT: This a read-only STM transaction.</span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-537"></span><span>    </span><span id="%24sel%3Aterminate%3AInternalEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Aterminate%3AInternalEnv"><span class="hs-identifier hs-var hs-var">terminate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-538"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span>
</span><span id="line-539"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-540"></span><span>    </span><span class="hs-comment">-- ^ Gracefully terminate the connection with the upstream node with the</span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-comment">-- given result.</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-543"></span><span>    </span><span id="%24sel%3AterminateAfterDrain%3AInternalEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall (n :: N).
   Nat n
   -&gt; ChainSyncClientResult
   -&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AterminateAfterDrain%3AInternalEnv"><span class="hs-identifier hs-var hs-var">terminateAfterDrain</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-544"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908916"><span class="annot"><a href="#local-6989586621679908916"><span class="hs-identifier hs-type">n</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-545"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679908916"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-546"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span>
</span><span id="line-547"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679908916"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679908874"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Same as 'terminate', but first 'drainThePipe'.</span></span><span>
</span><span id="line-549"></span><span>  </span><span class="hs-special">,</span><span>
</span><span id="line-550"></span><span>    </span><span id="%24sel%3AtraceException%3AInternalEnv"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment -&gt; forall a. m a -&gt; m a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtraceException%3AInternalEnv"><span class="hs-identifier hs-var hs-var">traceException</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908922"><span class="annot"><a href="#local-6989586621679908922"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908922"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908873"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908922"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-551"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Trace any 'ChainSyncClientException' if thrown.</span></span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span class="hs-comment">-- | Chain sync client</span><span>
</span><span id="line-555"></span><span class="hs-comment">--</span><span>
</span><span id="line-556"></span><span class="hs-comment">-- This never terminates. In case of a failure, a 'ChainSyncClientException'</span><span>
</span><span id="line-557"></span><span class="hs-comment">-- is thrown. The network layer classifies exception such that the</span><span>
</span><span id="line-558"></span><span class="hs-comment">-- corresponding peer will never be chosen again.</span><span>
</span><span id="line-559"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#chainSyncClient"><span class="hs-identifier hs-type">chainSyncClient</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908928"><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908929"><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-560"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-561"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-562"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-type">DynamicEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-565"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainSyncClientPipelined</span></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-566"></span><span id="chainSyncClient"><span class="annot"><span class="annottext">chainSyncClient :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk -&gt; Consensus ChainSyncClientPipelined blk m
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#chainSyncClient"><span class="hs-identifier hs-var hs-var">chainSyncClient</span></a></span></span><span> </span><span id="local-6989586621679909825"><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679909825"><span class="hs-identifier hs-var">cfgEnv</span></a></span></span><span> </span><span id="local-6989586621679909826"><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679909826"><span class="hs-identifier hs-var">dynEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-567"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk -&gt; SomeHeaderInFutureCheck m blk
forall (m :: * -&gt; *) blk.
ConfigEnv m blk -&gt; SomeHeaderInFutureCheck m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AsomeHeaderInFutureCheck%3AConfigEnv"><span class="hs-identifier hs-var">someHeaderInFutureCheck</span></a></span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679909825"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-568"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html#SomeHeaderInFutureCheck"><span class="hs-identifier hs-type">InFutureCheck.SomeHeaderInFutureCheck</span></a></span><span> </span><span id="local-6989586621679909833"><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
</span><a href="#local-6989586621679909833"><span class="hs-identifier hs-var">headerInFutureCheck</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-569"></span><span>            </span><span class="annot"><span class="annottext">m (ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Consensus ChainSyncClientPipelined blk m
forall header point tip (m :: * -&gt; *) a.
m (ClientPipelinedStIdle 'Z header point tip m a)
-&gt; ChainSyncClientPipelined header point tip m a
</span><span class="hs-identifier hs-var">ChainSyncClientPipelined</span></span><span>
</span><span id="line-570"></span><span>          </span><span class="annot"><span class="annottext">(m (ClientPipelinedStIdle
      'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; Consensus ChainSyncClientPipelined blk m)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Consensus ChainSyncClientPipelined blk m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">()
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>          </span><span class="annot"><span class="annottext">(Stateful m blk () (ClientPipelinedStIdle 'Z)
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-comment">-- Start ChainSync by looking for an intersection between our</span><span>
</span><span id="line-572"></span><span>            </span><span class="hs-comment">-- current chain fragment and their chain.</span><span>
</span><span id="line-573"></span><span>            </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#findIntersectionTop"><span class="hs-identifier hs-var">findIntersectionTop</span></a></span><span>
</span><span id="line-574"></span><span>                </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679909825"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-575"></span><span>                </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679909826"><span class="hs-identifier hs-var">dynEnv</span></a></span><span>
</span><span id="line-576"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
-&gt; InternalEnv m blk arrival judgment
forall arrival judgment.
HeaderInFutureCheck m blk arrival judgment
-&gt; InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679909837"><span class="hs-identifier hs-var">mkIntEnv</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
</span><a href="#local-6989586621679909833"><span class="hs-identifier hs-var">headerInFutureCheck</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-var">ForkTooDeep</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
forall {k} (block :: k). Point block
</span><span class="hs-identifier hs-var">GenesisPoint</span></span><span class="hs-special">)</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-579"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-580"></span><span>        </span><span id="local-6989586621679909839"><span class="annot"><span class="annottext">TopLevelConfig blk
$sel:cfg:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; TopLevelConfig blk
cfg :: TopLevelConfig blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Acfg%3AConfigEnv"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>
</span><span id="line-581"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909840"><span class="annot"><span class="annottext">ChainDbView m blk
$sel:chainDbView:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; ChainDbView m blk
chainDbView :: ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AchainDbView%3AConfigEnv"><span class="hs-identifier hs-var hs-var">chainDbView</span></a></span></span><span>
</span><span id="line-582"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909841"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
$sel:tracer:ConfigEnv :: forall (m :: * -&gt; *) blk.
ConfigEnv m blk -&gt; Tracer m (TraceChainSyncClientEvent blk)
tracer :: Tracer m (TraceChainSyncClientEvent blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Atracer%3AConfigEnv"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span>
</span><span id="line-583"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679909825"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-584"></span><span>
</span><span id="line-585"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-586"></span><span>        </span><span id="local-6989586621679909842"><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
$sel:getCurrentChain:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
getCurrentChain :: STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetCurrentChain%3AChainDbView"><span class="hs-identifier hs-var hs-var">getCurrentChain</span></a></span></span><span>
</span><span id="line-587"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679909840"><span class="hs-identifier hs-var">chainDbView</span></a></span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span>    </span><span id="local-6989586621679908949"><span id="local-6989586621679908950"><span class="annot"><a href="#local-6989586621679909837"><span class="hs-identifier hs-type">mkIntEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-590"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html#HeaderInFutureCheck"><span class="hs-identifier hs-type">InFutureCheck.HeaderInFutureCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908949"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908950"><span class="hs-identifier hs-type">judgment</span></a></span><span>
</span><span id="line-591"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span>                       </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908949"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908950"><span class="hs-identifier hs-type">judgment</span></a></span></span></span><span>
</span><span id="line-592"></span><span>    </span><span id="local-6989586621679909837"><span class="annot"><span class="annottext">mkIntEnv :: forall arrival judgment.
HeaderInFutureCheck m blk arrival judgment
-&gt; InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679909837"><span class="hs-identifier hs-var hs-var">mkIntEnv</span></a></span></span><span> </span><span id="local-6989586621679909843"><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
</span><a href="#local-6989586621679909843"><span class="hs-identifier hs-var">hifc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-593"></span><span>        </span><span class="annot"><span class="annottext">Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
$sel:drainThePipe:InternalEnv :: forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
drainThePipe :: forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AdrainThePipe%3AInternalEnv"><span class="hs-identifier hs-var hs-var">drainThePipe</span></a></span><span>
</span><span id="line-594"></span><span>      </span><span class="hs-special">,</span><span>
</span><span id="line-595"></span><span>        </span><span class="annot"><span class="annottext">$sel:disconnect:InternalEnv :: forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Adisconnect%3AInternalEnv"><span class="hs-identifier hs-var">disconnect</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m' a
forall e a. Exception e =&gt; e -&gt; m' a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><span class="hs-identifier hs-var">throwIO</span></span><span>
</span><span id="line-596"></span><span>      </span><span class="hs-special">,</span><span>
</span><span id="line-597"></span><span>        </span><span class="annot"><span class="annottext">$sel:headerInFutureCheck:InternalEnv :: HeaderInFutureCheck m blk arrival judgment
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AheaderInFutureCheck%3AInternalEnv"><span class="hs-identifier hs-var">headerInFutureCheck</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
</span><a href="#local-6989586621679909843"><span class="hs-identifier hs-var">hifc</span></a></span><span>
</span><span id="line-598"></span><span>      </span><span class="hs-special">,</span><span>
</span><span id="line-599"></span><span>        </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
$sel:intersectsWithCurrentChain:InternalEnv :: KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
intersectsWithCurrentChain :: KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AintersectsWithCurrentChain%3AInternalEnv"><span class="hs-identifier hs-var hs-var">intersectsWithCurrentChain</span></a></span><span>
</span><span id="line-600"></span><span>      </span><span class="hs-special">,</span><span>
</span><span id="line-601"></span><span>        </span><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
$sel:terminate:InternalEnv :: ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
terminate :: ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Aterminate%3AInternalEnv"><span class="hs-identifier hs-var hs-var">terminate</span></a></span><span>
</span><span id="line-602"></span><span>      </span><span class="hs-special">,</span><span>
</span><span id="line-603"></span><span>        </span><span class="annot"><span class="annottext">$sel:terminateAfterDrain:InternalEnv :: forall (n :: N).
Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AterminateAfterDrain%3AInternalEnv"><span class="hs-identifier hs-var">terminateAfterDrain</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679909856"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679909856"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679909857"><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621679909857"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-604"></span><span>            </span><span class="annot"><span class="annottext">()
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>          </span><span class="annot"><span class="annottext">(Stateful m blk () (ClientPipelinedStIdle n)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679909844"><span class="hs-identifier hs-var">drainThePipe</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679909856"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-606"></span><span>          </span><span class="annot"><span class="annottext">(Stateful m blk () (ClientPipelinedStIdle 'Z)
 -&gt; Stateful m blk () (ClientPipelinedStIdle n))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(()
 -&gt; m (ClientPipelinedStIdle
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
forall (m :: * -&gt; *) blk s
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
(s -&gt; m (Consensus st blk m)) -&gt; Stateful m blk s st
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((()
  -&gt; m (ClientPipelinedStIdle
          'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
 -&gt; Stateful m blk () (ClientPipelinedStIdle 'Z))
-&gt; (()
    -&gt; m (ClientPipelinedStIdle
            'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621679909853"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621679909857"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-607"></span><span>      </span><span class="hs-special">,</span><span>
</span><span id="line-608"></span><span>        </span><span class="annot"><span class="annottext">$sel:traceException:InternalEnv :: forall a. m a -&gt; m a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtraceException%3AInternalEnv"><span class="hs-identifier hs-var">traceException</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679909864"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679909864"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-609"></span><span>            </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679909864"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (ChainSyncClientException -&gt; m a) -&gt; m a
forall e a. Exception e =&gt; m a -&gt; (e -&gt; m a) -&gt; m a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catch`</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679909866"><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621679909866"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-610"></span><span>                </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679909841"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
forall blk.
ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceException"><span class="hs-identifier hs-var">TraceException</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621679909866"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-611"></span><span>                </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m a
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621679909866"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-612"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>    </span><span class="annot"><a href="#local-6989586621679909844"><span class="hs-identifier hs-type">drainThePipe</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-615"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679909869"><span class="annot"><a href="#local-6989586621679909869"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679909870"><span class="annot"><a href="#local-6989586621679909870"><span class="hs-identifier hs-type">n</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-616"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679909869"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-617"></span><span>      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679909870"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-618"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909869"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909869"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679909870"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span>    </span><span id="local-6989586621679909844"><span class="annot"><span class="annottext">drainThePipe :: forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679909844"><span class="hs-identifier hs-var hs-var">drainThePipe</span></a></span></span><span> </span><span id="local-6989586621679909872"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679909872"><span class="hs-identifier hs-var">n0</span></a></span></span><span> </span><span id="local-6989586621679909873"><span class="annot"><span class="annottext">Stateful m blk s (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621679909873"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-621"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679909874"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-622"></span><span>            </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908975"><span class="annot"><a href="#local-6989586621679908975"><span class="hs-identifier hs-type">n'</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-623"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679908975"><span class="hs-identifier hs-type">n'</span></a></span><span>
</span><span id="line-624"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909869"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-625"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679908975"><span class="hs-identifier hs-type">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>          </span><span id="local-6989586621679909874"><span class="annot"><span class="annottext">go :: forall (n' :: N).
Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621679909874"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679909875"><span class="annot"><span class="annottext">Nat n'
</span><a href="#local-6989586621679909875"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679909876"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679909876"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Nat n'
</span><a href="#local-6989586621679909875"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-627"></span><span>              </span><span class="annot"><span class="annottext">Nat n'
</span><span class="hs-identifier hs-var">Zero</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">s
-&gt; Stateful m blk s (ClientPipelinedStIdle n')
-&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679909876"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Stateful m blk s (ClientPipelinedStIdle n')
Stateful m blk s (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621679909873"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-628"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Succ</span></span><span> </span><span id="local-6989586621679909886"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679909886"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Consensus (ClientPipelinedStIdle n') blk m
-&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Consensus (ClientPipelinedStIdle n') blk m
 -&gt; m (Consensus (ClientPipelinedStIdle n') blk m))
-&gt; Consensus (ClientPipelinedStIdle n') blk m
-&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (m :: * -&gt; *) (n1 :: N) header point tip a.
Maybe (m (ClientPipelinedStIdle ('S n1) header point tip m a))
-&gt; ClientStNext n1 header point tip m a
-&gt; ClientPipelinedStIdle ('S n1) header point tip m a
</span><span class="hs-identifier hs-var">CollectResponse</span></span><span> </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientStNext
   n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; ClientPipelinedStIdle
      ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ClientStNext</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-629"></span><span>                  </span><span class="annot"><span class="annottext">recvMsgRollForward :: Header blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><span class="hs-identifier hs-var">recvMsgRollForward</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679909890"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679909890"><span class="hs-identifier hs-var">_hdr</span></a></span></span><span> </span><span id="local-6989586621679909891"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679909891"><span class="hs-identifier hs-var">_tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; s
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (n' :: N).
Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621679909874"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679909886"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679909876"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-630"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgRollBackward :: Point blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><span class="hs-identifier hs-var">recvMsgRollBackward</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679909893"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679909893"><span class="hs-identifier hs-var">_pt</span></a></span></span><span>  </span><span id="local-6989586621679909894"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679909894"><span class="hs-identifier hs-var">_tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; s
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall (n' :: N).
Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621679909874"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679909886"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679909876"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-631"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-632"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) blk s
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
(s -&gt; m (Consensus st blk m)) -&gt; Stateful m blk s st
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; Stateful m blk s (ClientPipelinedStIdle n))
-&gt; (s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (n' :: N).
Nat n' -&gt; s -&gt; m (Consensus (ClientPipelinedStIdle n') blk m)
</span><a href="#local-6989586621679909874"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679909872"><span class="hs-identifier hs-var">n0</span></a></span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span>    </span><span class="annot"><a href="#local-6989586621679909853"><span class="hs-identifier hs-type">terminate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-635"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span>
</span><span id="line-636"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>    </span><span id="local-6989586621679909853"><span class="annot"><span class="annottext">terminate :: ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><a href="#local-6989586621679909853"><span class="hs-identifier hs-var hs-var">terminate</span></a></span></span><span> </span><span id="local-6989586621679909895"><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621679909895"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-638"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679909841"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncClientResult -&gt; TraceChainSyncClientEvent blk
forall blk. ChainSyncClientResult -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceTermination"><span class="hs-identifier hs-var">TraceTermination</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621679909895"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>        </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall a header point tip (m :: * -&gt; *).
a -&gt; ClientPipelinedStIdle 'Z header point tip m a
</span><span class="hs-identifier hs-var">SendMsgDone</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="#local-6989586621679909895"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span>    </span><span class="annot"><a href="#local-6989586621679909852"><span class="hs-identifier hs-type">intersectsWithCurrentChain</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-642"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-643"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908928"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UpdatedIntersectionState"><span class="hs-identifier hs-type">UpdatedIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908929"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-644"></span><span>    </span><span id="local-6989586621679909852"><span class="annot"><span class="annottext">intersectsWithCurrentChain :: KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
</span><a href="#local-6989586621679909852"><span class="hs-identifier hs-var hs-var">intersectsWithCurrentChain</span></a></span></span><span> </span><span id="local-6989586621679909898"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909898"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-645"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-646"></span><span>                </span><span id="local-6989586621679909899"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-647"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909900"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-648"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909901"><span class="annot"><span class="annottext">HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-649"></span><span>              </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909898"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-650"></span><span>        </span><span id="local-6989586621679909902"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909902"><span class="hs-identifier hs-var">ourFrag'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679909842"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span>        </span><span class="hs-comment">-- Our current chain didn't change, and changes to their chain that</span><span>
</span><span id="line-653"></span><span>        </span><span class="hs-comment">-- might affect the intersection point are handled elsewhere</span><span>
</span><span id="line-654"></span><span>        </span><span class="hs-comment">-- ('rollBackward'), so we have nothing to do.</span><span>
</span><span id="line-655"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679909903"><span class="annot"><span class="annottext">noChange :: Bool
</span><a href="#local-6989586621679909903"><span class="hs-identifier hs-var hs-var">noChange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909899"><span class="hs-identifier hs-var">ourFrag</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point (Header blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909902"><span class="hs-identifier hs-var">ourFrag'</span></a></span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span>        </span><span class="annot"><span class="annottext">UpdatedIntersectionState blk ()
-&gt; STM m (UpdatedIntersectionState blk ())
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(UpdatedIntersectionState blk ()
 -&gt; STM m (UpdatedIntersectionState blk ()))
-&gt; UpdatedIntersectionState blk ()
-&gt; STM m (UpdatedIntersectionState blk ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679909903"><span class="hs-identifier hs-var">noChange</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">() -&gt; KnownIntersectionState blk -&gt; UpdatedIntersectionState blk ()
forall blk a.
a -&gt; KnownIntersectionState blk -&gt; UpdatedIntersectionState blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StillIntersects"><span class="hs-identifier hs-var">StillIntersects</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679909898"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="hs-keyword">else</span><span>
</span><span id="line-658"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Maybe (Point (Header blk), AnchoredFragment (Header blk))
forall blk.
HasHeader blk =&gt;
AnchoredFragment blk
-&gt; AnchoredFragment blk -&gt; Maybe (Point blk, AnchoredFragment blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#cross"><span class="hs-identifier hs-var">cross</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909902"><span class="hs-identifier hs-var">ourFrag'</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909900"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-659"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Point (Header blk), AnchoredFragment (Header blk))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UpdatedIntersectionState blk ()
forall blk a. UpdatedIntersectionState blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>                </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679909908"><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909908"><span class="hs-identifier hs-var">intersection</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909909"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909909"><span class="hs-identifier hs-var">trimmedCandidate</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-662"></span><span>                    </span><span class="hs-comment">-- Even though our current chain changed it still</span><span>
</span><span id="line-663"></span><span>                    </span><span class="hs-comment">-- intersects with candidate fragment, so update the</span><span>
</span><span id="line-664"></span><span>                    </span><span class="hs-comment">-- 'ourFrag' field and trim the candidate fragment to the</span><span>
</span><span id="line-665"></span><span>                    </span><span class="hs-comment">-- same anchor point.</span><span>
</span><span id="line-666"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-667"></span><span>                    </span><span class="hs-comment">-- Note that this is the only place we need to trim.</span><span>
</span><span id="line-668"></span><span>                    </span><span class="hs-comment">-- Headers on their chain can only become unnecessary</span><span>
</span><span id="line-669"></span><span>                    </span><span class="hs-comment">-- (eligible for trimming) in two ways: 1. we adopted them,</span><span>
</span><span id="line-670"></span><span>                    </span><span class="hs-comment">-- i.e., our chain changed (handled in this function); 2.</span><span>
</span><span id="line-671"></span><span>                    </span><span class="hs-comment">-- we will /never/ adopt them, which is handled in the &quot;no</span><span>
</span><span id="line-672"></span><span>                    </span><span class="hs-comment">-- more intersection case&quot;.</span><span>
</span><span id="line-673"></span><span>                    </span><span class="annot"><span class="annottext">() -&gt; KnownIntersectionState blk -&gt; UpdatedIntersectionState blk ()
forall blk a.
a -&gt; KnownIntersectionState blk -&gt; UpdatedIntersectionState blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StillIntersects"><span class="hs-identifier hs-var">StillIntersects</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-674"></span><span>                  </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; UpdatedIntersectionState blk ())
-&gt; KnownIntersectionState blk -&gt; UpdatedIntersectionState blk ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679909839"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>                  </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-676"></span><span>                        </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
</span><a href="#local-6989586621679909908"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-677"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909902"><span class="hs-identifier hs-var">ourFrag'</span></a></span><span>
</span><span id="line-678"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909909"><span class="hs-identifier hs-var">trimmedCandidate</span></a></span><span>
</span><span id="line-679"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-680"></span><span>                            </span><span class="hs-comment">-- We trim the 'HeaderStateHistory' to the same</span><span>
</span><span id="line-681"></span><span>                            </span><span class="hs-comment">-- size as our fragment so they keep in sync.</span><span>
</span><span id="line-682"></span><span>                            </span><span class="annot"><span class="annottext">Int -&gt; HeaderStateHistory blk -&gt; HeaderStateHistory blk
forall blk. Int -&gt; HeaderStateHistory blk -&gt; HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.HeaderStateHistory.html#trim"><span class="hs-identifier hs-var">HeaderStateHistory.trim</span></a></span><span>
</span><span id="line-683"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><span class="hs-identifier hs-var">AF.length</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909909"><span class="hs-identifier hs-var">trimmedCandidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>                                </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679909901"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span>
</span><span id="line-685"></span><span>                      </span><span class="hs-special">}</span><span>
</span><span id="line-686"></span><span>
</span><span id="line-687"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  (Re-)Establishing a common intersection
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-690"></span><span>
</span><span id="line-691"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#findIntersectionTop"><span class="hs-identifier hs-type">findIntersectionTop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908945"><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908946"><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679908947"><span class="annot"><a href="#local-6989586621679908947"><span class="hs-identifier hs-type">arrival</span></a></span></span><span> </span><span id="local-6989586621679908948"><span class="annot"><a href="#local-6989586621679908948"><span class="hs-identifier hs-type">judgment</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-693"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-694"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-695"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-type">DynamicEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908947"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908948"><span class="hs-identifier hs-type">judgment</span></a></span><span>
</span><span id="line-699"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Exception to throw when no intersection is found.</span></span><span>
</span><span id="line-701"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span id="findIntersectionTop"><span class="annot"><span class="annottext">findIntersectionTop :: forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#findIntersectionTop"><span class="hs-identifier hs-var hs-var">findIntersectionTop</span></a></span></span><span> </span><span id="local-6989586621679909979"><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679909979"><span class="hs-identifier hs-var">cfgEnv</span></a></span></span><span> </span><span id="local-6989586621679909980"><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679909980"><span class="hs-identifier hs-var">dynEnv</span></a></span></span><span> </span><span id="local-6989586621679909981"><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679909981"><span class="hs-identifier hs-var">intEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-703"></span><span>    </span><span class="annot"><span class="annottext">(Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621679909982"><span class="hs-identifier hs-var">findIntersection</span></a></span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-705"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-706"></span><span>        </span><span id="local-6989586621679909983"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
$sel:tracer:ConfigEnv :: forall (m :: * -&gt; *) blk.
ConfigEnv m blk -&gt; Tracer m (TraceChainSyncClientEvent blk)
tracer :: Tracer m (TraceChainSyncClientEvent blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Atracer%3AConfigEnv"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span>
</span><span id="line-707"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909984"><span class="annot"><span class="annottext">TopLevelConfig blk
$sel:cfg:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; TopLevelConfig blk
cfg :: TopLevelConfig blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Acfg%3AConfigEnv"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>
</span><span id="line-708"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909985"><span class="annot"><span class="annottext">ChainDbView m blk
$sel:chainDbView:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; ChainDbView m blk
chainDbView :: ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AchainDbView%3AConfigEnv"><span class="hs-identifier hs-var hs-var">chainDbView</span></a></span></span><span>
</span><span id="line-709"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679909979"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-710"></span><span>
</span><span id="line-711"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-712"></span><span>        </span><span id="local-6989586621679909986"><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
$sel:getCurrentChain:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
getCurrentChain :: STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetCurrentChain%3AChainDbView"><span class="hs-identifier hs-var hs-var">getCurrentChain</span></a></span></span><span>
</span><span id="line-713"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909987"><span class="annot"><span class="annottext">STM m (HeaderStateHistory blk)
$sel:getHeaderStateHistory:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (HeaderStateHistory blk)
getHeaderStateHistory :: STM m (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetHeaderStateHistory%3AChainDbView"><span class="hs-identifier hs-var hs-var">getHeaderStateHistory</span></a></span></span><span>
</span><span id="line-714"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679909985"><span class="hs-identifier hs-var">chainDbView</span></a></span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-type">DynamicEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-717"></span><span>        </span><span id="local-6989586621679909988"><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
$sel:varCandidate:DynamicEnv :: forall (m :: * -&gt; *) blk.
DynamicEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
varCandidate :: StrictTVar m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AvarCandidate%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">varCandidate</span></a></span></span><span>
</span><span id="line-718"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679909980"><span class="hs-identifier hs-var">dynEnv</span></a></span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-721"></span><span>        </span><span id="local-6989586621679909989"><span class="annot"><span class="annottext">forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
$sel:disconnect:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall (m' :: * -&gt; *) a.
   MonadThrow m' =&gt;
   ChainSyncClientException -&gt; m' a
disconnect :: forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Adisconnect%3AInternalEnv"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span>
</span><span id="line-722"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909990"><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
$sel:terminate:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
terminate :: ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Aterminate%3AInternalEnv"><span class="hs-identifier hs-var hs-var">terminate</span></a></span></span><span>
</span><span id="line-723"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909991"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
$sel:traceException:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment -&gt; forall a. m a -&gt; m a
traceException :: forall a. m a -&gt; m a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtraceException%3AInternalEnv"><span class="hs-identifier hs-var hs-var">traceException</span></a></span></span><span>
</span><span id="line-724"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679909981"><span class="hs-identifier hs-var">intEnv</span></a></span><span>
</span><span id="line-725"></span><span>
</span><span id="line-726"></span><span>    </span><span class="hs-comment">-- Try to find an intersection by sending points of our current chain to</span><span>
</span><span id="line-727"></span><span>    </span><span class="hs-comment">-- the server, if any of them intersect with their chain, roll back our</span><span>
</span><span id="line-728"></span><span>    </span><span class="hs-comment">-- chain to that point and start synching using that fragment. If none</span><span>
</span><span id="line-729"></span><span>    </span><span class="hs-comment">-- intersect, disconnect by throwing the exception obtained by calling the</span><span>
</span><span id="line-730"></span><span>    </span><span class="hs-comment">-- passed function.</span><span>
</span><span id="line-731"></span><span>    </span><span class="annot"><a href="#local-6989586621679909982"><span class="hs-identifier hs-type">findIntersection</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-732"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-733"></span><span>        </span><span class="hs-comment">-- ^ Exception to throw when no intersection is found.</span><span>
</span><span id="line-734"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>    </span><span id="local-6989586621679909982"><span class="annot"><span class="annottext">findIntersection :: (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621679909982"><span class="hs-identifier hs-var hs-var">findIntersection</span></a></span></span><span> </span><span id="local-6989586621679909992"><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="#local-6989586621679909992"><span class="hs-identifier hs-var">mkResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(() -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
forall (m :: * -&gt; *) blk s
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
(s -&gt; m (Consensus st blk m)) -&gt; Stateful m blk s st
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((() -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
 -&gt; Stateful m blk () (ClientPipelinedStIdle 'Z))
-&gt; (() -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-736"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679909993"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909993"><span class="hs-identifier hs-var">ourFrag</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679909994"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679909994"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
 -&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>            </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk)
 -&gt; HeaderStateHistory blk
 -&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; STM
     m
     (HeaderStateHistory blk
      -&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679909986"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>
</span><span id="line-738"></span><span>            </span><span class="annot"><span class="annottext">STM
  m
  (HeaderStateHistory blk
   -&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; STM m (HeaderStateHistory blk)
-&gt; STM m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a b. STM m (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (HeaderStateHistory blk)
</span><a href="#local-6989586621679909987"><span class="hs-identifier hs-var">getHeaderStateHistory</span></a></span><span>
</span><span id="line-739"></span><span>        </span><span class="hs-comment">-- This means that if an intersection is found for one of these points,</span><span>
</span><span id="line-740"></span><span>        </span><span class="hs-comment">-- it was an intersection within the last @k@ blocks of our current</span><span>
</span><span id="line-741"></span><span>        </span><span class="hs-comment">-- chain. If not, we could never switch to this candidate chain anyway.</span><span>
</span><span id="line-742"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679909995"><span class="annot"><span class="annottext">maxOffset :: Word64
</span><a href="#local-6989586621679909995"><span class="hs-identifier hs-var hs-var">maxOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Int
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; Int
</span><span class="hs-identifier hs-var">AF.length</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909993"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span>            </span><span id="local-6989586621679909996"><span class="annot"><span class="annottext">k :: SecurityParam
</span><a href="#local-6989586621679909996"><span class="hs-identifier hs-var hs-var">k</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk) -&gt; SecurityParam
forall p. ConsensusProtocol p =&gt; ConsensusConfig p -&gt; SecurityParam
</span><a href="Ouroboros.Consensus.Protocol.Abstract.html#protocolSecurityParam"><span class="hs-identifier hs-var">protocolSecurityParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679909984"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-744"></span><span>            </span><span id="local-6989586621679909997"><span class="annot"><span class="annottext">offsets :: [Word64]
</span><a href="#local-6989586621679909997"><span class="hs-identifier hs-var hs-var">offsets</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecurityParam -&gt; Word64 -&gt; [Word64]
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#mkOffsets"><span class="hs-identifier hs-var">mkOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">SecurityParam
</span><a href="#local-6989586621679909996"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679909995"><span class="hs-identifier hs-var">maxOffset</span></a></span><span>
</span><span id="line-745"></span><span>            </span><span id="local-6989586621679909999"><span class="annot"><span class="annottext">points :: [Point blk]
</span><a href="#local-6989586621679909999"><span class="hs-identifier hs-var hs-var">points</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span>
</span><span id="line-746"></span><span>                </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; [Point (Header blk)] -&gt; [Point blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span>
</span><span id="line-747"></span><span>              </span><span class="annot"><span class="annottext">([Point (Header blk)] -&gt; [Point blk])
-&gt; [Point (Header blk)] -&gt; [Point blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; AnchoredFragment (Header blk) -&gt; [Point (Header blk)]
forall block.
HasHeader block =&gt;
[Int] -&gt; AnchoredFragment block -&gt; [Point block]
</span><span class="hs-identifier hs-var">AF.selectPoints</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Word64 -&gt; Int) -&gt; [Word64] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">[Word64]
</span><a href="#local-6989586621679909997"><span class="hs-identifier hs-var">offsets</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909993"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span>            </span><span id="local-6989586621679910001"><span class="annot"><span class="annottext">uis :: UnknownIntersectionState blk
</span><a href="#local-6989586621679910001"><span class="hs-identifier hs-var hs-var">uis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-750"></span><span>                </span><span class="annot"><span class="annottext">$sel:ourFrag:UnknownIntersectionState :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AUnknownIntersectionState"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909993"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-751"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ourHeaderStateHistory:UnknownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourHeaderStateHistory%3AUnknownIntersectionState"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679909994"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span><span>
</span><span id="line-752"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-753"></span><span>
</span><span id="line-754"></span><span>        </span><span class="annot"><span class="annottext">Consensus (ClientPipelinedStIdle 'Z) blk m
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span>
</span><span id="line-755"></span><span>          </span><span class="annot"><span class="annottext">(Consensus (ClientPipelinedStIdle 'Z) blk m
 -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; Consensus (ClientPipelinedStIdle 'Z) blk m
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Point blk]
-&gt; ClientPipelinedStIntersect
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; Consensus (ClientPipelinedStIdle 'Z) blk m
forall point header tip (m :: * -&gt; *) a.
[point]
-&gt; ClientPipelinedStIntersect header point tip m a
-&gt; ClientPipelinedStIdle 'Z header point tip m a
</span><span class="hs-identifier hs-var">SendMsgFindIntersect</span></span><span> </span><span class="annot"><span class="annottext">[Point blk]
</span><a href="#local-6989586621679909999"><span class="hs-identifier hs-var">points</span></a></span><span>
</span><span id="line-756"></span><span>          </span><span class="annot"><span class="annottext">(ClientPipelinedStIntersect
   (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; Consensus (ClientPipelinedStIdle 'Z) blk m)
-&gt; ClientPipelinedStIntersect
     (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; Consensus (ClientPipelinedStIdle 'Z) blk m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIntersect</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-757"></span><span>                </span><span class="annot"><span class="annottext">recvMsgIntersectFound :: Point blk
-&gt; Tip blk -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
</span><span class="hs-identifier hs-var">recvMsgIntersectFound</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910005"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910005"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679910006"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910006"><span class="hs-identifier hs-var">theirTip'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-758"></span><span>                    </span><span class="annot"><span class="annottext">UnknownIntersectionState blk
-&gt; Stateful
     m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z)
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">UnknownIntersectionState blk
</span><a href="#local-6989586621679910001"><span class="hs-identifier hs-var">uis</span></a></span><span>
</span><span id="line-759"></span><span>                  </span><span class="annot"><span class="annottext">(Stateful
   m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z)
 -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; Stateful
     m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z)
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621679910007"><span class="hs-identifier hs-var">intersectFound</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910005"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910006"><span class="hs-identifier hs-var">theirTip'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-760"></span><span>              </span><span class="hs-special">,</span><span>
</span><span id="line-761"></span><span>                </span><span class="annot"><span class="annottext">recvMsgIntersectNotFound :: Tip blk -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
</span><span class="hs-identifier hs-var">recvMsgIntersectNotFound</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910009"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910009"><span class="hs-identifier hs-var">theirTip'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-762"></span><span>                    </span><span class="annot"><span class="annottext">ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
</span><a href="#local-6989586621679909990"><span class="hs-identifier hs-var">terminate</span></a></span><span>
</span><span id="line-763"></span><span>                  </span><span class="annot"><span class="annottext">(ChainSyncClientResult
 -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="#local-6989586621679909992"><span class="hs-identifier hs-var">mkResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
forall blk.
HasHeader (Header blk) =&gt;
AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourTipFromChain"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679909993"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910009"><span class="hs-identifier hs-var">theirTip'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-765"></span><span>
</span><span id="line-766"></span><span>    </span><span class="hs-comment">-- One of the points we sent intersected our chain. This intersection point</span><span>
</span><span id="line-767"></span><span>    </span><span class="hs-comment">-- will become the new tip of the candidate fragment.</span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><a href="#local-6989586621679910007"><span class="hs-identifier hs-type">intersectFound</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-769"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span>  </span><span class="hs-comment">-- ^ Intersection</span><span>
</span><span id="line-770"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-771"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908945"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-772"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908946"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>    </span><span id="local-6989586621679910007"><span class="annot"><span class="annottext">intersectFound :: Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z)
</span><a href="#local-6989586621679910007"><span class="hs-identifier hs-var hs-var">intersectFound</span></a></span></span><span> </span><span id="local-6989586621679910011"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910011"><span class="hs-identifier hs-var">intersection</span></a></span></span><span> </span><span id="local-6989586621679910012"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910012"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UnknownIntersectionState blk
 -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; Stateful
     m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z)
forall (m :: * -&gt; *) blk s
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
(s -&gt; m (Consensus st blk m)) -&gt; Stateful m blk s st
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((UnknownIntersectionState blk
  -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
 -&gt; Stateful
      m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z))
-&gt; (UnknownIntersectionState blk
    -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; Stateful
     m blk (UnknownIntersectionState blk) (ClientPipelinedStIdle 'Z)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910013"><span class="annot"><span class="annottext">UnknownIntersectionState blk
</span><a href="#local-6989586621679910013"><span class="hs-identifier hs-var">uis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-775"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UnknownIntersectionState"><span class="hs-identifier hs-type">UnknownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-776"></span><span>                </span><span id="local-6989586621679910014"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
$sel:ourFrag:UnknownIntersectionState :: forall blk.
UnknownIntersectionState blk -&gt; AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourFrag%3AUnknownIntersectionState"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-777"></span><span>              </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910015"><span class="annot"><span class="annottext">HeaderStateHistory blk
$sel:ourHeaderStateHistory:UnknownIntersectionState :: forall blk. UnknownIntersectionState blk -&gt; HeaderStateHistory blk
ourHeaderStateHistory :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AourHeaderStateHistory%3AUnknownIntersectionState"><span class="hs-identifier hs-var hs-var">ourHeaderStateHistory</span></a></span></span><span>
</span><span id="line-778"></span><span>              </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnknownIntersectionState blk
</span><a href="#local-6989586621679910013"><span class="hs-identifier hs-var">uis</span></a></span><span>
</span><span id="line-779"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679909983"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-780"></span><span>            </span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; TraceChainSyncClientEvent blk
forall blk.
Point blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceFoundIntersection"><span class="hs-identifier hs-var">TraceFoundIntersection</span></a></span><span>
</span><span id="line-781"></span><span>                </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910011"><span class="hs-identifier hs-var">intersection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
forall blk.
HasHeader (Header blk) =&gt;
AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourTipFromChain"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910014"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910012"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-782"></span><span>        </span><span class="annot"><span class="annottext">m (Consensus (ClientPipelinedStIdle 'Z) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall a. m a -&gt; m a
</span><a href="#local-6989586621679909991"><span class="hs-identifier hs-var">traceException</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Consensus (ClientPipelinedStIdle 'Z) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-783"></span><span>            </span><span class="hs-comment">-- Roll back the current chain fragment to the @intersection@.</span><span>
</span><span id="line-784"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-785"></span><span>            </span><span class="hs-comment">-- While the primitives in the ChainSync protocol are &quot;roll back&quot;,</span><span>
</span><span id="line-786"></span><span>            </span><span class="hs-comment">-- &quot;roll forward (apply block)&quot;, etc. The /real/ primitive is</span><span>
</span><span id="line-787"></span><span>            </span><span class="hs-comment">-- &quot;switch to fork&quot;, which means that a roll back is always</span><span>
</span><span id="line-788"></span><span>            </span><span class="hs-comment">-- followed by applying at least as many blocks that we rolled</span><span>
</span><span id="line-789"></span><span>            </span><span class="hs-comment">-- back.</span><span>
</span><span id="line-790"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-791"></span><span>            </span><span class="hs-comment">-- This is important for 'rewindHeaderStateHistory', which can only</span><span>
</span><span id="line-792"></span><span>            </span><span class="hs-comment">-- roll back up to @k@ blocks, /once/, i.e., we cannot keep rolling</span><span>
</span><span id="line-793"></span><span>            </span><span class="hs-comment">-- back the same chain state multiple times, because that would</span><span>
</span><span id="line-794"></span><span>            </span><span class="hs-comment">-- mean that we store the chain state for the /whole chain/, all</span><span>
</span><span id="line-795"></span><span>            </span><span class="hs-comment">-- the way to genesis.</span><span>
</span><span id="line-796"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-797"></span><span>            </span><span class="hs-comment">-- So the rewind below is fine when we are switching to a fork</span><span>
</span><span id="line-798"></span><span>            </span><span class="hs-comment">-- (i.e. it is followed by rolling forward again), but we need some</span><span>
</span><span id="line-799"></span><span>            </span><span class="hs-comment">-- guarantees that the ChainSync protocol /does/ in fact give us a</span><span>
</span><span id="line-800"></span><span>            </span><span class="hs-comment">-- switch-to-fork instead of a true rollback.</span><span>
</span><span id="line-801"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679910017"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910017"><span class="hs-identifier hs-var">theirFrag</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910018"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910018"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-802"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall blk.
(BlockSupportsProtocol blk, HasAnnTip blk) =&gt;
Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-var">attemptRollback</span></a></span><span>
</span><span id="line-803"></span><span>                         </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910011"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-804"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910014"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910015"><span class="hs-identifier hs-var">ourHeaderStateHistory</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>                  </span><span class="hs-keyword">of</span><span>
</span><span id="line-806"></span><span>                    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910020"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910020"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910021"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910021"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910020"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910021"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-808"></span><span>                        </span><span class="hs-comment">-- The @intersection@ is not on our fragment, even</span><span>
</span><span id="line-809"></span><span>                        </span><span class="hs-comment">-- though we sent only points from our fragment to find</span><span>
</span><span id="line-810"></span><span>                        </span><span class="hs-comment">-- an intersection with. The node must have sent us an</span><span>
</span><span id="line-811"></span><span>                        </span><span class="hs-comment">-- invalid intersection point.</span><span>
</span><span id="line-812"></span><span>                        </span><span class="annot"><span class="annottext">ChainSyncClientException
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="#local-6989586621679909989"><span class="hs-identifier hs-var">disconnect</span></a></span><span>
</span><span id="line-813"></span><span>                      </span><span class="annot"><span class="annottext">(ChainSyncClientException
 -&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk))
-&gt; ChainSyncClientException
-&gt; m (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientException
forall blk.
BlockSupportsProtocol blk =&gt;
Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-var">InvalidIntersection</span></a></span><span>
</span><span id="line-814"></span><span>                            </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910011"><span class="hs-identifier hs-var">intersection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
forall blk.
HasHeader (Header blk) =&gt;
AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourTipFromChain"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910014"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910012"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-815"></span><span>            </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679909988"><span class="hs-identifier hs-var">varCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910017"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-816"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910024"><span class="annot"><span class="annottext">kis :: KnownIntersectionState blk
</span><a href="#local-6989586621679910024"><span class="hs-identifier hs-var hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-817"></span><span>                   </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679909984"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span>                 </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-819"></span><span>                       </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910011"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-820"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span><span>
</span><span id="line-821"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span><span>
</span><span id="line-822"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span><span>
</span><span id="line-823"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-824"></span><span>            </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle 'Z)
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910024"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m blk (KnownIntersectionState blk) (ClientPipelinedStIdle 'Z)
 -&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle 'Z)
-&gt; m (Consensus (ClientPipelinedStIdle 'Z) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-825"></span><span>                </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle 'Z)
forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle 'Z)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#knownIntersectionStateTop"><span class="hs-identifier hs-var">knownIntersectionStateTop</span></a></span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679909979"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679909980"><span class="hs-identifier hs-var">dynEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679909981"><span class="hs-identifier hs-var">intEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910012"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Processing 'MsgRollForward' and 'MsgRollBackward'
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#knownIntersectionStateTop"><span class="hs-identifier hs-type">knownIntersectionStateTop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-832"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679909011"><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679909012"><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679909013"><span class="annot"><a href="#local-6989586621679909013"><span class="hs-identifier hs-type">arrival</span></a></span></span><span> </span><span id="local-6989586621679909014"><span class="annot"><a href="#local-6989586621679909014"><span class="hs-identifier hs-type">judgment</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-833"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-834"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-835"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-837"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-type">DynamicEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-838"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909013"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909014"><span class="hs-identifier hs-type">judgment</span></a></span><span>
</span><span id="line-839"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-840"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-841"></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Z</span></span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span id="knownIntersectionStateTop"><span class="annot"><span class="annottext">knownIntersectionStateTop :: forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle 'Z)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#knownIntersectionStateTop"><span class="hs-identifier hs-var hs-var">knownIntersectionStateTop</span></a></span></span><span> </span><span id="local-6989586621679910045"><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910045"><span class="hs-identifier hs-var">cfgEnv</span></a></span></span><span> </span><span id="local-6989586621679910046"><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679910046"><span class="hs-identifier hs-var">dynEnv</span></a></span></span><span> </span><span id="local-6989586621679910047"><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910047"><span class="hs-identifier hs-var">intEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-844"></span><span>    </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat 'Z
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle 'Z)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910048"><span class="hs-identifier hs-var">nextStep</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910049"><span class="hs-identifier hs-var">mkPipelineDecision0</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><span class="hs-identifier hs-var">Zero</span></span><span>
</span><span id="line-845"></span><span>      </span><span class="hs-comment">-- The 'MkPiplineDecision' and @'Nat' n@ arguments below could safely be</span><span>
</span><span id="line-846"></span><span>      </span><span class="hs-comment">-- merged into the 'KnownIntersectionState' record type, but it's</span><span>
</span><span id="line-847"></span><span>      </span><span class="hs-comment">-- unfortunately quite awkward to do so.</span><span>
</span><span id="line-848"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-849"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-850"></span><span>        </span><span id="local-6989586621679910049"><span class="annot"><span class="annottext">MkPipelineDecision
$sel:mkPipelineDecision0:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; MkPipelineDecision
mkPipelineDecision0 :: MkPipelineDecision
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmkPipelineDecision0%3AConfigEnv"><span class="hs-identifier hs-var hs-var">mkPipelineDecision0</span></a></span></span><span>
</span><span id="line-851"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910050"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
$sel:tracer:ConfigEnv :: forall (m :: * -&gt; *) blk.
ConfigEnv m blk -&gt; Tracer m (TraceChainSyncClientEvent blk)
tracer :: Tracer m (TraceChainSyncClientEvent blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Atracer%3AConfigEnv"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span>
</span><span id="line-852"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910051"><span class="annot"><span class="annottext">TopLevelConfig blk
$sel:cfg:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; TopLevelConfig blk
cfg :: TopLevelConfig blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Acfg%3AConfigEnv"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>
</span><span id="line-853"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910045"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-854"></span><span>
</span><span id="line-855"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-type">DynamicEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-856"></span><span>        </span><span id="local-6989586621679910052"><span class="annot"><span class="annottext">ControlMessageSTM m
$sel:controlMessageSTM:DynamicEnv :: forall (m :: * -&gt; *) blk. DynamicEnv m blk -&gt; ControlMessageSTM m
controlMessageSTM :: ControlMessageSTM m
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AcontrolMessageSTM%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">controlMessageSTM</span></a></span></span><span>
</span><span id="line-857"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910053"><span class="annot"><span class="annottext">HeaderMetricsTracer m
$sel:headerMetricsTracer:DynamicEnv :: forall (m :: * -&gt; *) blk. DynamicEnv m blk -&gt; HeaderMetricsTracer m
headerMetricsTracer :: HeaderMetricsTracer m
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AheaderMetricsTracer%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">headerMetricsTracer</span></a></span></span><span>
</span><span id="line-858"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910054"><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
$sel:varCandidate:DynamicEnv :: forall (m :: * -&gt; *) blk.
DynamicEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
varCandidate :: StrictTVar m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AvarCandidate%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">varCandidate</span></a></span></span><span>
</span><span id="line-859"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679910046"><span class="hs-identifier hs-var">dynEnv</span></a></span><span>
</span><span id="line-860"></span><span>
</span><span id="line-861"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-862"></span><span>        </span><span id="local-6989586621679910055"><span class="annot"><span class="annottext">forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
$sel:drainThePipe:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall s (n :: N).
   NoThunks s =&gt;
   Nat n
   -&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
   -&gt; Stateful m blk s (ClientPipelinedStIdle n)
drainThePipe :: forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AdrainThePipe%3AInternalEnv"><span class="hs-identifier hs-var hs-var">drainThePipe</span></a></span></span><span>
</span><span id="line-863"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910056"><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
$sel:headerInFutureCheck:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; HeaderInFutureCheck m blk arrival judgment
headerInFutureCheck :: HeaderInFutureCheck m blk arrival judgment
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AheaderInFutureCheck%3AInternalEnv"><span class="hs-identifier hs-var hs-var">headerInFutureCheck</span></a></span></span><span>
</span><span id="line-864"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910057"><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
$sel:intersectsWithCurrentChain:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
intersectsWithCurrentChain :: KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AintersectsWithCurrentChain%3AInternalEnv"><span class="hs-identifier hs-var hs-var">intersectsWithCurrentChain</span></a></span></span><span>
</span><span id="line-865"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910058"><span class="annot"><span class="annottext">forall (n :: N).
Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
$sel:terminateAfterDrain:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall (n :: N).
   Nat n
   -&gt; ChainSyncClientResult
   -&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
terminateAfterDrain :: forall (n :: N).
Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AterminateAfterDrain%3AInternalEnv"><span class="hs-identifier hs-var hs-var">terminateAfterDrain</span></a></span></span><span>
</span><span id="line-866"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910059"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
$sel:traceException:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment -&gt; forall a. m a -&gt; m a
traceException :: forall a. m a -&gt; m a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtraceException%3AInternalEnv"><span class="hs-identifier hs-var hs-var">traceException</span></a></span></span><span>
</span><span id="line-867"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910047"><span class="hs-identifier hs-var">intEnv</span></a></span><span>
</span><span id="line-868"></span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html#HeaderInFutureCheck"><span class="hs-identifier hs-type">InFutureCheck.HeaderInFutureCheck</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-870"></span><span>        </span><span id="local-6989586621679910061"><span class="annot"><span class="annottext">Header blk -&gt; m arrival
recordHeaderArrival :: Header blk -&gt; m arrival
recordHeaderArrival :: forall (m :: * -&gt; *) blk arrival judgment.
HeaderInFutureCheck m blk arrival judgment
-&gt; Header blk -&gt; m arrival
</span><a href="#local-6989586621679910061"><span class="hs-identifier hs-var hs-var">recordHeaderArrival</span></a></span></span><span>
</span><span id="line-871"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
</span><a href="#local-6989586621679910056"><span class="hs-identifier hs-var">headerInFutureCheck</span></a></span><span>
</span><span id="line-872"></span><span>
</span><span id="line-873"></span><span>    </span><span class="hs-comment">-- Request the next message (roll forward or backward), unless our chain</span><span>
</span><span id="line-874"></span><span>    </span><span class="hs-comment">-- has changed such that it no longer intersects with the candidate, in</span><span>
</span><span id="line-875"></span><span>    </span><span class="hs-comment">-- which case we initiate the intersection finding part of the protocol.</span><span>
</span><span id="line-876"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-877"></span><span>    </span><span class="hs-comment">-- This is the main place we check whether our current chain has changed.</span><span>
</span><span id="line-878"></span><span>    </span><span class="hs-comment">-- We also check it in 'rollForward' to make sure we have an up-to-date</span><span>
</span><span id="line-879"></span><span>    </span><span class="hs-comment">-- intersection before calling 'getLedgerView'.</span><span>
</span><span id="line-880"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-881"></span><span>    </span><span class="hs-comment">-- This is also the place where we checked whether we're asked to terminate</span><span>
</span><span id="line-882"></span><span>    </span><span class="hs-comment">-- by the mux layer.</span><span>
</span><span id="line-883"></span><span>    </span><span id="local-6989586621679909020"><span class="annot"><a href="#local-6989586621679910048"><span class="hs-identifier hs-type">nextStep</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-884"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MkPipelineDecision</span></span><span>
</span><span id="line-885"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679909020"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-886"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-887"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-888"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-889"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679909020"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-890"></span><span>    </span><span id="local-6989586621679910048"><span class="annot"><span class="annottext">nextStep :: forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910048"><span class="hs-identifier hs-var hs-var">nextStep</span></a></span></span><span> </span><span id="local-6989586621679910085"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910085"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621679910086"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910086"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679910087"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910087"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KnownIntersectionState blk
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) blk s
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
(s -&gt; m (Consensus st blk m)) -&gt; Stateful m blk s st
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((KnownIntersectionState blk
  -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; Stateful
      m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n))
-&gt; (KnownIntersectionState blk
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910088"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910088"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-891"></span><span>        </span><span class="annot"><span class="annottext">ControlMessageSTM m -&gt; m ControlMessage
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">ControlMessageSTM m
</span><a href="#local-6989586621679910052"><span class="hs-identifier hs-var">controlMessageSTM</span></a></span><span> </span><span class="annot"><span class="annottext">m ControlMessage
-&gt; (ControlMessage
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-892"></span><span>            </span><span class="hs-comment">-- We have been asked to terminate the client</span><span>
</span><span id="line-893"></span><span>            </span><span class="annot"><span class="annottext">ControlMessage
</span><span class="hs-identifier hs-var">Terminate</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (n :: N).
Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="#local-6989586621679910058"><span class="hs-identifier hs-var">terminateAfterDrain</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910086"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientResult
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span>
</span><span id="line-894"></span><span>            </span><span id="local-6989586621679910091"><span class="annot"><span class="annottext">ControlMessage
</span><a href="#local-6989586621679910091"><span class="hs-identifier hs-var">_continue</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-895"></span><span>                </span><span class="annot"><span class="annottext">STM m (UpdatedIntersectionState blk ())
-&gt; m (UpdatedIntersectionState blk ())
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
</span><a href="#local-6989586621679910057"><span class="hs-identifier hs-var">intersectsWithCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910088"><span class="hs-identifier hs-var">kis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (UpdatedIntersectionState blk ())
-&gt; (UpdatedIntersectionState blk ()
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-896"></span><span>                    </span><span class="hs-comment">-- Our chain (tip) didn't change or if it did, it still</span><span>
</span><span id="line-897"></span><span>                    </span><span class="hs-comment">-- intersects with the candidate fragment, so we can</span><span>
</span><span id="line-898"></span><span>                    </span><span class="hs-comment">-- continue requesting the next block.</span><span>
</span><span id="line-899"></span><span>                    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StillIntersects"><span class="hs-identifier hs-type">StillIntersects</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910092"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910092"><span class="hs-identifier hs-var">kis'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-900"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-901"></span><span>                                </span><span id="local-6989586621679910093"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-902"></span><span>                              </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910092"><span class="hs-identifier hs-var">kis'</span></a></span><span>
</span><span id="line-903"></span><span>                        </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679910054"><span class="hs-identifier hs-var">varCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910093"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-904"></span><span>                        </span><span class="annot"><span class="annottext">Consensus (ClientPipelinedStIdle n) blk m
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Consensus (ClientPipelinedStIdle n) blk m
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Consensus (ClientPipelinedStIdle n) blk m
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-905"></span><span>                            </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621679910094"><span class="hs-identifier hs-var">requestNext</span></a></span><span>
</span><span id="line-906"></span><span>                                </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910092"><span class="hs-identifier hs-var">kis'</span></a></span><span>
</span><span id="line-907"></span><span>                                </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910085"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span>
</span><span id="line-908"></span><span>                                </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910086"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-909"></span><span>                                </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910087"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-910"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; WithOrigin BlockNo
</span><span class="hs-identifier hs-var">AF.headBlockNo</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910093"><span class="hs-identifier hs-var">theirFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-911"></span><span>                    </span><span class="hs-comment">-- Our chain (tip) has changed and it no longer intersects</span><span>
</span><span id="line-912"></span><span>                    </span><span class="hs-comment">-- with the candidate fragment, so we have to find a new</span><span>
</span><span id="line-913"></span><span>                    </span><span class="hs-comment">-- intersection, but first drain the pipe.</span><span>
</span><span id="line-914"></span><span>                    </span><span class="annot"><span class="annottext">UpdatedIntersectionState blk ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-915"></span><span>                        </span><span class="annot"><span class="annottext">()
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-916"></span><span>                      </span><span class="annot"><span class="annottext">(Stateful m blk () (ClientPipelinedStIdle n)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910055"><span class="hs-identifier hs-var">drainThePipe</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910086"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-917"></span><span>                      </span><span class="annot"><span class="annottext">(Stateful m blk () (ClientPipelinedStIdle 'Z)
 -&gt; Stateful m blk () (ClientPipelinedStIdle n))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#findIntersectionTop"><span class="hs-identifier hs-var">findIntersectionTop</span></a></span><span>
</span><span id="line-918"></span><span>                          </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910045"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-919"></span><span>                          </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679910046"><span class="hs-identifier hs-var">dynEnv</span></a></span><span>
</span><span id="line-920"></span><span>                          </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910047"><span class="hs-identifier hs-var">intEnv</span></a></span><span>
</span><span id="line-921"></span><span>                          </span><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-var">NoMoreIntersection</span></a></span><span>
</span><span id="line-922"></span><span>
</span><span id="line-923"></span><span>    </span><span id="local-6989586621679909031"><span class="annot"><a href="#local-6989586621679910094"><span class="hs-identifier hs-type">requestNext</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-924"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-925"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MkPipelineDecision</span></span><span>
</span><span id="line-926"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679909031"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-927"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-928"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockNo</span></span><span>
</span><span id="line-929"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679909031"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-930"></span><span>    </span><span id="local-6989586621679910094"><span class="annot"><span class="annottext">requestNext :: forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621679910094"><span class="hs-identifier hs-var hs-var">requestNext</span></a></span></span><span> </span><span id="local-6989586621679910098"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910098"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910099"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910099"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621679910100"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910100"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679910101"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910101"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span id="local-6989586621679910102"><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679910102"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-931"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910103"><span class="annot"><span class="annottext">theirTipBlockNo :: WithOrigin BlockNo
</span><a href="#local-6989586621679910103"><span class="hs-identifier hs-var hs-var">theirTipBlockNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tip blk -&gt; WithOrigin BlockNo
forall {k} (b :: k). Tip b -&gt; WithOrigin BlockNo
</span><span class="hs-identifier hs-var">getTipBlockNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Their (Tip blk) -&gt; Tip blk
forall a. Their a -&gt; a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AunTheir%3ATheir"><span class="hs-identifier hs-var">unTheir</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910101"><span class="hs-identifier hs-var">theirTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>            </span><span id="local-6989586621679910104"><span class="annot"><span class="annottext">decision :: (PipelineDecision n, MkPipelineDecision)
</span><a href="#local-6989586621679910104"><span class="hs-identifier hs-var hs-var">decision</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span>
</span><span id="line-933"></span><span>              </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; WithOrigin BlockNo
-&gt; WithOrigin BlockNo
-&gt; (PipelineDecision n, MkPipelineDecision)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; WithOrigin BlockNo
-&gt; WithOrigin BlockNo
-&gt; (PipelineDecision n, MkPipelineDecision)
</span><span class="hs-identifier hs-var">runPipelineDecision</span></span><span>
</span><span id="line-934"></span><span>              </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910099"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span>
</span><span id="line-935"></span><span>              </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910100"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-936"></span><span>              </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679910102"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span><span>
</span><span id="line-937"></span><span>              </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679910103"><span class="hs-identifier hs-var">theirTipBlockNo</span></a></span><span>
</span><span id="line-938"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-939"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910100"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(PipelineDecision n, MkPipelineDecision)
</span><a href="#local-6989586621679910104"><span class="hs-identifier hs-var">decision</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-940"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n
</span><span class="hs-identifier hs-var">Zero</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><span class="hs-identifier hs-var">Request</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910115"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910115"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-941"></span><span>              </span><span class="annot"><span class="annottext">ClientStNext
  'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientStNext
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ClientPipelinedStIdle
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall header point tip (m :: * -&gt; *) a.
ClientStNext 'Z header point tip m a
-&gt; m (ClientStNext 'Z header point tip m a)
-&gt; ClientPipelinedStIdle 'Z header point tip m a
</span><span class="hs-identifier hs-var">SendMsgRequestNext</span></span><span>
</span><span id="line-942"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat 'Z
-&gt; ClientStNext
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621679910117"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910098"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910115"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><span class="hs-identifier hs-var">Zero</span></span><span class="hs-special">)</span><span>
</span><span id="line-943"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- when we have to wait</span><span>
</span><span id="line-944"></span><span>                    </span><span class="annot"><span class="annottext">ClientStNext
  'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientStNext
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientStNext
   'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; m (ClientStNext
         'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientStNext
        'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat 'Z
-&gt; ClientStNext
     'Z (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621679910117"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910098"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910115"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat 'Z
forall (n :: N). ('Z ~ n) =&gt; Nat n
</span><span class="hs-identifier hs-var">Zero</span></span><span>
</span><span id="line-945"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>
</span><span id="line-947"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><span class="hs-identifier hs-var">Pipeline</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910119"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910119"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-948"></span><span>              </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; Consensus (ClientPipelinedStIdle n) blk m
forall (n :: N) header point tip (m :: * -&gt; *) a.
ClientPipelinedStIdle ('S n) header point tip m a
-&gt; ClientPipelinedStIdle n header point tip m a
</span><span class="hs-identifier hs-var">SendMsgRequestNextPipelined</span></span><span>
</span><span id="line-949"></span><span>            </span><span class="annot"><span class="annottext">(ClientPipelinedStIdle
   ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; Consensus (ClientPipelinedStIdle n) blk m)
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; Consensus (ClientPipelinedStIdle n) blk m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat ('S n)
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621679910094"><span class="hs-identifier hs-var">requestNext</span></a></span><span>
</span><span id="line-950"></span><span>                  </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910098"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-951"></span><span>                  </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910119"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span>
</span><span id="line-952"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Nat ('S n)
forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><span class="hs-identifier hs-var">Succ</span></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910100"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-953"></span><span>                  </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910101"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-954"></span><span>                  </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679910102"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span><span>
</span><span id="line-955"></span><span>
</span><span id="line-956"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Succ</span></span><span> </span><span id="local-6989586621679910123"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910123"><span class="hs-identifier hs-var">n'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><span class="hs-identifier hs-var">CollectOrPipeline</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910129"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910129"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-957"></span><span>              </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (m :: * -&gt; *) (n1 :: N) header point tip a.
Maybe (m (ClientPipelinedStIdle ('S n1) header point tip m a))
-&gt; ClientStNext n1 header point tip m a
-&gt; ClientPipelinedStIdle ('S n1) header point tip m a
</span><span class="hs-identifier hs-var">CollectResponse</span></span><span>
</span><span id="line-958"></span><span>                  </span><span class="hs-special">(</span><span>    </span><span class="annot"><span class="annottext">m (ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Maybe
     (m (ClientPipelinedStIdle
           ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span>
</span><span id="line-959"></span><span>                    </span><span class="annot"><span class="annottext">(m (ClientPipelinedStIdle
      ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
 -&gt; Maybe
      (m (ClientPipelinedStIdle
            ('S n)
            (Header blk)
            (Point blk)
            (Tip blk)
            m
            ChainSyncClientResult)))
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; Maybe
     (m (ClientPipelinedStIdle
           ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-960"></span><span>                    </span><span class="annot"><span class="annottext">(ClientPipelinedStIdle
   ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
 -&gt; m (ClientPipelinedStIdle
         ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ClientPipelinedStIdle
  ('S ('S n))
  (Header blk)
  (Point blk)
  (Tip blk)
  m
  ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N) header point tip (m :: * -&gt; *) a.
ClientPipelinedStIdle ('S n) header point tip m a
-&gt; ClientPipelinedStIdle n header point tip m a
</span><span class="hs-identifier hs-var">SendMsgRequestNextPipelined</span></span><span>
</span><span id="line-961"></span><span>                    </span><span class="annot"><span class="annottext">(ClientPipelinedStIdle
   ('S ('S n))
   (Header blk)
   (Point blk)
   (Tip blk)
   m
   ChainSyncClientResult
 -&gt; ClientPipelinedStIdle
      ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
-&gt; ClientPipelinedStIdle
     ('S ('S n))
     (Header blk)
     (Point blk)
     (Tip blk)
     m
     ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat ('S ('S n))
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; ClientPipelinedStIdle
     ('S ('S n))
     (Header blk)
     (Point blk)
     (Tip blk)
     m
     ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; WithOrigin BlockNo
-&gt; Consensus (ClientPipelinedStIdle n) blk m
</span><a href="#local-6989586621679910094"><span class="hs-identifier hs-var">requestNext</span></a></span><span>
</span><span id="line-962"></span><span>                          </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910098"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-963"></span><span>                          </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910129"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span>
</span><span id="line-964"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nat n -&gt; Nat ('S ('S n))
forall (m :: N) (n :: N). (m ~ 'S n) =&gt; Nat n -&gt; Nat m
</span><span class="hs-identifier hs-var">Succ</span></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910100"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-965"></span><span>                          </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910101"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-966"></span><span>                          </span><span class="annot"><span class="annottext">WithOrigin BlockNo
</span><a href="#local-6989586621679910102"><span class="hs-identifier hs-var">candTipBlockNo</span></a></span><span>
</span><span id="line-967"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-968"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621679910117"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910098"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910129"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910123"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Succ</span></span><span> </span><span id="local-6989586621679910132"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910132"><span class="hs-identifier hs-var">n'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PipelineDecision n
</span><span class="hs-identifier hs-var">Collect</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910135"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910135"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-971"></span><span>              </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
-&gt; ClientPipelinedStIdle
     ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (m :: * -&gt; *) (n1 :: N) header point tip a.
Maybe (m (ClientPipelinedStIdle ('S n1) header point tip m a))
-&gt; ClientStNext n1 header point tip m a
-&gt; ClientPipelinedStIdle ('S n1) header point tip m a
</span><span class="hs-identifier hs-var">CollectResponse</span></span><span>
</span><span id="line-972"></span><span>                  </span><span class="annot"><span class="annottext">Maybe
  (m (ClientPipelinedStIdle
        ('S n) (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-973"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; MkPipelineDecision
-&gt; Nat n
-&gt; ClientStNext
     n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult
forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621679910117"><span class="hs-identifier hs-var">handleNext</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910098"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910135"><span class="hs-identifier hs-var">mkPipelineDecision'</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910132"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-974"></span><span>
</span><span id="line-975"></span><span>    </span><span id="local-6989586621679909039"><span class="annot"><a href="#local-6989586621679910117"><span class="hs-identifier hs-type">handleNext</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-976"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-977"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MkPipelineDecision</span></span><span>
</span><span id="line-978"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679909039"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-979"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientStNext</span></span><span> </span><span class="annot"><a href="#local-6989586621679909039"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-980"></span><span>    </span><span id="local-6989586621679910117"><span class="annot"><span class="annottext">handleNext :: forall (n :: N).
KnownIntersectionState blk
-&gt; MkPipelineDecision -&gt; Nat n -&gt; Consensus (ClientStNext n) blk m
</span><a href="#local-6989586621679910117"><span class="hs-identifier hs-var hs-var">handleNext</span></a></span></span><span> </span><span id="local-6989586621679910141"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910141"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910142"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910142"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621679910143"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910143"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ClientStNext</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-981"></span><span>        </span><span class="annot"><span class="annottext">recvMsgRollForward :: Header blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><span class="hs-identifier hs-var">recvMsgRollForward</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910144"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910144"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621679910145"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910145"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-982"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679910050"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; TraceChainSyncClientEvent blk
forall blk. Header blk -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceDownloadedHeader"><span class="hs-identifier hs-var">TraceDownloadedHeader</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910144"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-983"></span><span>            </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910141"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
 -&gt; m (ClientPipelinedStIdle
         n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-984"></span><span>                </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910147"><span class="hs-identifier hs-var">rollForward</span></a></span><span>
</span><span id="line-985"></span><span>                    </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910142"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span>
</span><span id="line-986"></span><span>                    </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910143"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-987"></span><span>                    </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910144"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-988"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910145"><span class="hs-identifier hs-var">theirTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>      </span><span class="hs-special">,</span><span>
</span><span id="line-990"></span><span>        </span><span class="annot"><span class="annottext">recvMsgRollBackward :: Point blk
-&gt; Tip blk
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
</span><span class="hs-identifier hs-var">recvMsgRollBackward</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910148"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910148"><span class="hs-identifier hs-var">intersection</span></a></span></span><span> </span><span id="local-6989586621679910149"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910149"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-991"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679910150"><span class="hs-identifier hs-type">intersection'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-992"></span><span>                </span><span id="local-6989586621679910150"><span class="annot"><span class="annottext">intersection' :: Point blk
</span><a href="#local-6989586621679910150"><span class="hs-identifier hs-var hs-var">intersection'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910148"><span class="hs-identifier hs-var">intersection</span></a></span><span>
</span><span id="line-993"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679910050"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; TraceChainSyncClientEvent blk
forall blk. Point blk -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceRolledBack"><span class="hs-identifier hs-var">TraceRolledBack</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910150"><span class="hs-identifier hs-var">intersection'</span></a></span><span>
</span><span id="line-994"></span><span>            </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910141"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
 -&gt; m (ClientPipelinedStIdle
         n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (ClientPipelinedStIdle
        n (Header blk) (Point blk) (Tip blk) m ChainSyncClientResult)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-995"></span><span>                </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910152"><span class="hs-identifier hs-var">rollBackward</span></a></span><span>
</span><span id="line-996"></span><span>                    </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910142"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span>
</span><span id="line-997"></span><span>                    </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910143"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-998"></span><span>                    </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910150"><span class="hs-identifier hs-var">intersection'</span></a></span><span>
</span><span id="line-999"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; Their (Tip blk)
forall a. a -&gt; Their a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-var">Their</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679910149"><span class="hs-identifier hs-var">theirTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1000"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-1001"></span><span>
</span><span id="line-1002"></span><span>    </span><span id="local-6989586621679909048"><span class="annot"><a href="#local-6989586621679910147"><span class="hs-identifier hs-type">rollForward</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1003"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MkPipelineDecision</span></span><span>
</span><span id="line-1004"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679909048"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-1005"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1006"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1007"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1008"></span><span>            </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679909048"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1010"></span><span>    </span><span id="local-6989586621679910147"><span class="annot"><span class="annottext">rollForward :: forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910147"><span class="hs-identifier hs-var hs-var">rollForward</span></a></span></span><span> </span><span id="local-6989586621679910183"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910183"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621679910184"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910184"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679910185"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910185"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621679910186"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910186"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1011"></span><span>        </span><span class="annot"><span class="annottext">(KnownIntersectionState blk
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) blk s
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
(s -&gt; m (Consensus st blk m)) -&gt; Stateful m blk s st
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((KnownIntersectionState blk
  -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; Stateful
      m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n))
-&gt; (KnownIntersectionState blk
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910187"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910187"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a. m a -&gt; m a
</span><a href="#local-6989586621679910059"><span class="hs-identifier hs-var">traceException</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Consensus (ClientPipelinedStIdle n) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1012"></span><span>            </span><span id="local-6989586621679910188"><span class="annot"><span class="annottext">arrival
</span><a href="#local-6989586621679910188"><span class="hs-identifier hs-var">arrival</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; m arrival
</span><a href="#local-6989586621679910061"><span class="hs-identifier hs-var">recordHeaderArrival</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910185"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1013"></span><span>            </span><span id="local-6989586621679910189"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679910189"><span class="hs-identifier hs-var">arrivalTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><span class="hs-identifier hs-var">getMonotonicTime</span></span><span>
</span><span id="line-1014"></span><span>
</span><span id="line-1015"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910191"><span class="annot"><span class="annottext">slotNo :: SlotNo
</span><a href="#local-6989586621679910191"><span class="hs-identifier hs-var hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><span class="hs-identifier hs-var">blockSlot</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910185"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1016"></span><span>
</span><span id="line-1017"></span><span>            </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Header blk
-&gt; m ()
forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Header blk
-&gt; m ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownInvalid"><span class="hs-identifier hs-var">checkKnownInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910045"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span> </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679910046"><span class="hs-identifier hs-var">dynEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910047"><span class="hs-identifier hs-var">intEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910185"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1018"></span><span>
</span><span id="line-1019"></span><span>            </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; KnownIntersectionState blk
-&gt; arrival
-&gt; SlotNo
-&gt; m (UpdatedIntersectionState
        blk (LedgerView (BlockProtocol blk)))
forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; KnownIntersectionState blk
-&gt; arrival
-&gt; SlotNo
-&gt; m (UpdatedIntersectionState
        blk (LedgerView (BlockProtocol blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkTime"><span class="hs-identifier hs-var">checkTime</span></a></span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910045"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910047"><span class="hs-identifier hs-var">intEnv</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910187"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">arrival
</span><a href="#local-6989586621679910188"><span class="hs-identifier hs-var">arrival</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679910191"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">m (UpdatedIntersectionState blk (LedgerView (BlockProtocol blk)))
-&gt; (UpdatedIntersectionState blk (LedgerView (BlockProtocol blk))
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1020"></span><span>                </span><span class="annot"><span class="annottext">UpdatedIntersectionState blk (LedgerView (BlockProtocol blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1021"></span><span>                    </span><span class="annot"><span class="annottext">()
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1022"></span><span>                  </span><span class="annot"><span class="annottext">(Stateful m blk () (ClientPipelinedStIdle n)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
forall s (n :: N).
NoThunks s =&gt;
Nat n
-&gt; Stateful m blk s (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk s (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910055"><span class="hs-identifier hs-var">drainThePipe</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910184"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1023"></span><span>                  </span><span class="annot"><span class="annottext">(Stateful m blk () (ClientPipelinedStIdle 'Z)
 -&gt; Stateful m blk () (ClientPipelinedStIdle n))
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
-&gt; Stateful m blk () (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; (Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult)
-&gt; Stateful m blk () (ClientPipelinedStIdle 'Z)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#findIntersectionTop"><span class="hs-identifier hs-var">findIntersectionTop</span></a></span><span>
</span><span id="line-1024"></span><span>                        </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910045"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-1025"></span><span>                        </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679910046"><span class="hs-identifier hs-var">dynEnv</span></a></span><span>
</span><span id="line-1026"></span><span>                        </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910047"><span class="hs-identifier hs-var">intEnv</span></a></span><span>
</span><span id="line-1027"></span><span>                        </span><span class="annot"><span class="annottext">Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-var">NoMoreIntersection</span></a></span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span>                </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StillIntersects"><span class="hs-identifier hs-type">StillIntersects</span></a></span><span> </span><span id="local-6989586621679910195"><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910195"><span class="hs-identifier hs-var">ledgerView</span></a></span></span><span> </span><span id="local-6989586621679910196"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910196"><span class="hs-identifier hs-var">kis'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1030"></span><span>                    </span><span id="local-6989586621679910197"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910197"><span class="hs-identifier hs-var">kis''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1031"></span><span>                        </span><span class="annot"><span class="annottext">ConfigEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; KnownIntersectionState blk
-&gt; LedgerView (BlockProtocol blk)
-&gt; m (KnownIntersectionState blk)
forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; KnownIntersectionState blk
-&gt; LedgerView (BlockProtocol blk)
-&gt; m (KnownIntersectionState blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkValid"><span class="hs-identifier hs-var">checkValid</span></a></span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910045"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910047"><span class="hs-identifier hs-var">intEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910185"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910186"><span class="hs-identifier hs-var">theirTip</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910196"><span class="hs-identifier hs-var">kis'</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910195"><span class="hs-identifier hs-var">ledgerView</span></a></span><span>
</span><span id="line-1032"></span><span>
</span><span id="line-1033"></span><span>                    </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679910054"><span class="hs-identifier hs-var">varCandidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910197"><span class="hs-identifier hs-var">kis''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1034"></span><span>                    </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span>
</span><span id="line-1035"></span><span>                      </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderMetricsTracer m -&gt; (SlotNo, Time) -&gt; STM m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">HeaderMetricsTracer m
</span><a href="#local-6989586621679910053"><span class="hs-identifier hs-var">headerMetricsTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679910191"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679910189"><span class="hs-identifier hs-var">arrivalTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1036"></span><span>
</span><span id="line-1037"></span><span>                    </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910197"><span class="hs-identifier hs-var">kis''</span></a></span><span>
</span><span id="line-1038"></span><span>                      </span><span class="annot"><span class="annottext">(Stateful
   m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910048"><span class="hs-identifier hs-var">nextStep</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910183"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910184"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910186"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-1039"></span><span>
</span><span id="line-1040"></span><span>    </span><span id="local-6989586621679909049"><span class="annot"><a href="#local-6989586621679910152"><span class="hs-identifier hs-type">rollBackward</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1041"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">MkPipelineDecision</span></span><span>
</span><span id="line-1042"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="#local-6989586621679909049"><span class="hs-identifier hs-type">n</span></a></span><span>
</span><span id="line-1043"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1044"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1045"></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1046"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909012"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1047"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientPipelinedStIdle</span></span><span> </span><span class="annot"><a href="#local-6989586621679909049"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1048"></span><span>    </span><span id="local-6989586621679910152"><span class="annot"><span class="annottext">rollBackward :: forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Point blk
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910152"><span class="hs-identifier hs-var hs-var">rollBackward</span></a></span></span><span> </span><span id="local-6989586621679910220"><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910220"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span></span><span> </span><span id="local-6989586621679910221"><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910221"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679910222"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910222"><span class="hs-identifier hs-var">rollBackPoint</span></a></span></span><span> </span><span id="local-6989586621679910223"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910223"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1049"></span><span>        </span><span class="annot"><span class="annottext">(KnownIntersectionState blk
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (m :: * -&gt; *) blk s
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
(s -&gt; m (Consensus st blk m)) -&gt; Stateful m blk s st
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span><span> </span><span class="annot"><span class="annottext">((KnownIntersectionState blk
  -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
 -&gt; Stateful
      m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n))
-&gt; (KnownIntersectionState blk
    -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910224"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910224"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1050"></span><span>            </span><span class="annot"><span class="annottext">m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a. m a -&gt; m a
</span><a href="#local-6989586621679910059"><span class="hs-identifier hs-var">traceException</span></a></span><span>
</span><span id="line-1051"></span><span>          </span><span class="annot"><span class="annottext">(m (Consensus (ClientPipelinedStIdle n) blk m)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1052"></span><span>                    </span><span id="local-6989586621679910225"><span class="annot"><span class="annottext">Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
mostRecentIntersection :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-1053"></span><span>                  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910226"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-1054"></span><span>                  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910227"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-1055"></span><span>                  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910228"><span class="annot"><span class="annottext">HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-1056"></span><span>                  </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910224"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1057"></span><span>            </span><span class="hs-keyword">in</span><span>
</span><span id="line-1058"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall blk.
(BlockSupportsProtocol blk, HasAnnTip blk) =&gt;
Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-var">attemptRollback</span></a></span><span>
</span><span id="line-1059"></span><span>                     </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910222"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span>
</span><span id="line-1060"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910227"><span class="hs-identifier hs-var">theirFrag</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910228"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1061"></span><span>              </span><span class="hs-keyword">of</span><span>
</span><span id="line-1062"></span><span>                </span><span class="annot"><span class="annottext">Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1063"></span><span>                    </span><span class="hs-comment">-- Remember that we use our current chain fragment as the</span><span>
</span><span id="line-1064"></span><span>                    </span><span class="hs-comment">-- starting point for the candidate's chain. Our fragment</span><span>
</span><span id="line-1065"></span><span>                    </span><span class="hs-comment">-- contained @k@ headers. At this point, the candidate</span><span>
</span><span id="line-1066"></span><span>                    </span><span class="hs-comment">-- fragment might have grown to more than @k@ or rolled</span><span>
</span><span id="line-1067"></span><span>                    </span><span class="hs-comment">-- back to less than @k@ headers.</span><span>
</span><span id="line-1068"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1069"></span><span>                    </span><span class="hs-comment">-- But now, it rolled back to some point that is not on the</span><span>
</span><span id="line-1070"></span><span>                    </span><span class="hs-comment">-- fragment, which means that it tried to roll back to some</span><span>
</span><span id="line-1071"></span><span>                    </span><span class="hs-comment">-- point before one of the last @k@ headers we initially</span><span>
</span><span id="line-1072"></span><span>                    </span><span class="hs-comment">-- started from. We could never switch to this fork anyway,</span><span>
</span><span id="line-1073"></span><span>                    </span><span class="hs-comment">-- so just disconnect. Furthermore, our current chain might</span><span>
</span><span id="line-1074"></span><span>                    </span><span class="hs-comment">-- have advanced in the meantime, so the point we would</span><span>
</span><span id="line-1075"></span><span>                    </span><span class="hs-comment">-- have to roll back to might have been much further back</span><span>
</span><span id="line-1076"></span><span>                    </span><span class="hs-comment">-- than @k@ blocks (&gt; @k@ + the number of blocks we have</span><span>
</span><span id="line-1077"></span><span>                    </span><span class="hs-comment">-- advanced since starting syncing).</span><span>
</span><span id="line-1078"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1079"></span><span>                    </span><span class="hs-comment">-- INVARIANT: a candidate fragment contains @&gt;=k@ headers</span><span>
</span><span id="line-1080"></span><span>                    </span><span class="hs-comment">-- (unless near genesis, in which case we mean the total</span><span>
</span><span id="line-1081"></span><span>                    </span><span class="hs-comment">-- number of blocks in the fragment) minus @r@ headers</span><span>
</span><span id="line-1082"></span><span>                    </span><span class="hs-comment">-- where @r &lt;= k@. This ghost variable @r@ indicates the</span><span>
</span><span id="line-1083"></span><span>                    </span><span class="hs-comment">-- number of headers we temporarily rolled back. Such a</span><span>
</span><span id="line-1084"></span><span>                    </span><span class="hs-comment">-- rollback must always be followed by rolling forward @s@</span><span>
</span><span id="line-1085"></span><span>                    </span><span class="hs-comment">-- new headers where @s &gt;= r@.</span><span>
</span><span id="line-1086"></span><span>                    </span><span class="hs-comment">--</span><span>
</span><span id="line-1087"></span><span>                    </span><span class="hs-comment">-- Thus, @k - r + s &gt;= k@.</span><span>
</span><span id="line-1088"></span><span>                    </span><span class="annot"><span class="annottext">Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall (n :: N).
Nat n
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
</span><a href="#local-6989586621679910058"><span class="hs-identifier hs-var">terminateAfterDrain</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910221"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1089"></span><span>                  </span><span class="annot"><span class="annottext">(ChainSyncClientResult
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; ChainSyncClientResult
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
forall blk.
BlockSupportsProtocol blk =&gt;
Point blk
-&gt; Our (Tip blk) -&gt; Their (Tip blk) -&gt; ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-var">RolledBackPastIntersection</span></a></span><span>
</span><span id="line-1090"></span><span>                        </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910222"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span>
</span><span id="line-1091"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
forall blk.
HasHeader (Header blk) =&gt;
AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourTipFromChain"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910226"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1092"></span><span>                        </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910223"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-1093"></span><span>
</span><span id="line-1094"></span><span>                </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910230"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910230"><span class="hs-identifier hs-var">theirFrag'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910231"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910231"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1095"></span><span>                  </span><span class="hs-comment">-- We just rolled back to @rollBackPoint@, either our most</span><span>
</span><span id="line-1096"></span><span>                  </span><span class="hs-comment">-- recent intersection was after or at @rollBackPoint@, in</span><span>
</span><span id="line-1097"></span><span>                  </span><span class="hs-comment">-- which case @rollBackPoint@ becomes the new most recent</span><span>
</span><span id="line-1098"></span><span>                  </span><span class="hs-comment">-- intersection.</span><span>
</span><span id="line-1099"></span><span>                  </span><span class="hs-comment">--</span><span>
</span><span id="line-1100"></span><span>                  </span><span class="hs-comment">-- But if the most recent intersection was /before/</span><span>
</span><span id="line-1101"></span><span>                  </span><span class="hs-comment">-- @rollBackPoint@, then the most recent intersection doesn't</span><span>
</span><span id="line-1102"></span><span>                  </span><span class="hs-comment">-- change.</span><span>
</span><span id="line-1103"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910232"><span class="annot"><span class="annottext">mostRecentIntersection' :: Point blk
</span><a href="#local-6989586621679910232"><span class="hs-identifier hs-var hs-var">mostRecentIntersection'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1104"></span><span>                          </span><span class="hs-keyword">if</span><span>   </span><span class="annot"><span class="annottext">Point (Header blk) -&gt; AnchoredFragment (Header blk) -&gt; Bool
forall block.
HasHeader block =&gt;
Point block -&gt; AnchoredFragment block -&gt; Bool
</span><span class="hs-identifier hs-var">AF.withinFragmentBounds</span></span><span>
</span><span id="line-1105"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910222"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1106"></span><span>                                   </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910226"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-1107"></span><span>                          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910222"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span>
</span><span id="line-1108"></span><span>                          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910225"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-1109"></span><span>
</span><span id="line-1110"></span><span>                      </span><span id="local-6989586621679910234"><span class="annot"><span class="annottext">kis' :: KnownIntersectionState blk
</span><a href="#local-6989586621679910234"><span class="hs-identifier hs-var hs-var">kis'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1111"></span><span>                          </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span>
</span><span id="line-1112"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679910051"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1113"></span><span>                        </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1114"></span><span>                              </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910232"><span class="hs-identifier hs-var">mostRecentIntersection'</span></a></span><span>
</span><span id="line-1115"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910226"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-1116"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910230"><span class="hs-identifier hs-var">theirFrag'</span></a></span><span>
</span><span id="line-1117"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910231"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span><span>
</span><span id="line-1118"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-1119"></span><span>                  </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; AnchoredFragment (Header blk) -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679910054"><span class="hs-identifier hs-var">varCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910230"><span class="hs-identifier hs-var">theirFrag'</span></a></span><span>
</span><span id="line-1120"></span><span>
</span><span id="line-1121"></span><span>                  </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var">continueWithState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910234"><span class="hs-identifier hs-var">kis'</span></a></span><span> </span><span class="annot"><span class="annottext">(Stateful
   m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
 -&gt; m (Consensus (ClientPipelinedStIdle n) blk m))
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
-&gt; m (Consensus (ClientPipelinedStIdle n) blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1122"></span><span>                      </span><span class="annot"><span class="annottext">MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
forall (n :: N).
MkPipelineDecision
-&gt; Nat n
-&gt; Their (Tip blk)
-&gt; Stateful
     m blk (KnownIntersectionState blk) (ClientPipelinedStIdle n)
</span><a href="#local-6989586621679910048"><span class="hs-identifier hs-var">nextStep</span></a></span><span> </span><span class="annot"><span class="annottext">MkPipelineDecision
</span><a href="#local-6989586621679910220"><span class="hs-identifier hs-var">mkPipelineDecision</span></a></span><span> </span><span class="annot"><span class="annottext">Nat n
</span><a href="#local-6989586621679910221"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910223"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-1123"></span><span>
</span><span id="line-1124"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Header checks
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1127"></span><span>
</span><span id="line-1128"></span><span class="hs-comment">-- | Check whether 'getIsInvalidBlock' indicates that the peer's most recent</span><span>
</span><span id="line-1129"></span><span class="hs-comment">-- header indicates they are either adversarial or buggy</span><span>
</span><span id="line-1130"></span><span class="hs-comment">--</span><span>
</span><span id="line-1131"></span><span class="hs-comment">-- If the peer is sending headers quickly, the 'invalidBlockRejector' might</span><span>
</span><span id="line-1132"></span><span class="hs-comment">-- miss one. So this call is a lightweight supplement. Note that neither check</span><span>
</span><span id="line-1133"></span><span class="hs-comment">-- /must/ be 100% reliable.</span><span>
</span><span id="line-1134"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownInvalid"><span class="hs-identifier hs-type">checkKnownInvalid</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1135"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679909054"><span class="annot"><a href="#local-6989586621679909054"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679909055"><span class="annot"><a href="#local-6989586621679909055"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679909056"><span class="annot"><a href="#local-6989586621679909056"><span class="hs-identifier hs-type">arrival</span></a></span></span><span> </span><span id="local-6989586621679909057"><span class="annot"><a href="#local-6989586621679909057"><span class="hs-identifier hs-type">judgment</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1136"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909054"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1137"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909055"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1138"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1139"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909055"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1140"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-type">DynamicEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909055"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1141"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909055"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909056"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909057"><span class="hs-identifier hs-type">judgment</span></a></span><span>
</span><span id="line-1142"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909055"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1143"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1144"></span><span id="checkKnownInvalid"><span class="annot"><span class="annottext">checkKnownInvalid :: forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; DynamicEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Header blk
-&gt; m ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkKnownInvalid"><span class="hs-identifier hs-var hs-var">checkKnownInvalid</span></a></span></span><span> </span><span id="local-6989586621679910262"><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910262"><span class="hs-identifier hs-var">cfgEnv</span></a></span></span><span> </span><span id="local-6989586621679910263"><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679910263"><span class="hs-identifier hs-var">dynEnv</span></a></span></span><span> </span><span id="local-6989586621679910264"><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910264"><span class="hs-identifier hs-var">intEnv</span></a></span></span><span> </span><span id="local-6989586621679910265"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910265"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679910266"><span class="hs-identifier hs-var">scrutinee</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1145"></span><span>    </span><span class="annot"><span class="annottext">ChainHash blk
</span><span class="hs-identifier hs-var">GenesisHash</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1146"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">BlockHash</span></span><span> </span><span id="local-6989586621679910269"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679910269"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1147"></span><span>        </span><span id="local-6989586621679910270"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621679910270"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
 -&gt; m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var">forgetFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
 -&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621679910272"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>
</span><span id="line-1148"></span><span>        </span><span class="annot"><span class="annottext">Maybe (InvalidBlockReason blk)
-&gt; (InvalidBlockReason blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621679910270"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679910269"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((InvalidBlockReason blk -&gt; m ()) -&gt; m ())
-&gt; (InvalidBlockReason blk -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910274"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679910274"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1149"></span><span>            </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m ()
forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="#local-6989586621679910275"><span class="hs-identifier hs-var">disconnect</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncClientException -&gt; m ())
-&gt; ChainSyncClientException -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; HeaderHash blk
-&gt; InvalidBlockReason blk
-&gt; ChainSyncClientException
forall blk.
LedgerSupportsProtocol blk =&gt;
Point blk
-&gt; HeaderHash blk
-&gt; InvalidBlockReason blk
-&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910265"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679910269"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679910274"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-1150"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1151"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1152"></span><span>        </span><span id="local-6989586621679910278"><span class="annot"><span class="annottext">ChainDbView m blk
$sel:chainDbView:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; ChainDbView m blk
chainDbView :: ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AchainDbView%3AConfigEnv"><span class="hs-identifier hs-var hs-var">chainDbView</span></a></span></span><span>
</span><span id="line-1153"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910262"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-1154"></span><span>
</span><span id="line-1155"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1156"></span><span>        </span><span id="local-6989586621679910272"><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
$sel:getIsInvalidBlock:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
getIsInvalidBlock :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetIsInvalidBlock%3AChainDbView"><span class="hs-identifier hs-var hs-var">getIsInvalidBlock</span></a></span></span><span>
</span><span id="line-1157"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679910278"><span class="hs-identifier hs-var">chainDbView</span></a></span><span>
</span><span id="line-1158"></span><span>
</span><span id="line-1159"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#DynamicEnv"><span class="hs-identifier hs-type">DynamicEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1160"></span><span>        </span><span id="local-6989586621679910279"><span class="annot"><span class="annottext">NodeToNodeVersion
$sel:version:DynamicEnv :: forall (m :: * -&gt; *) blk. DynamicEnv m blk -&gt; NodeToNodeVersion
version :: NodeToNodeVersion
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Aversion%3ADynamicEnv"><span class="hs-identifier hs-var hs-var">version</span></a></span></span><span>
</span><span id="line-1161"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DynamicEnv m blk
</span><a href="#local-6989586621679910263"><span class="hs-identifier hs-var">dynEnv</span></a></span><span>
</span><span id="line-1162"></span><span>
</span><span id="line-1163"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1164"></span><span>        </span><span id="local-6989586621679910275"><span class="annot"><span class="annottext">forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
$sel:disconnect:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall (m' :: * -&gt; *) a.
   MonadThrow m' =&gt;
   ChainSyncClientException -&gt; m' a
disconnect :: forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Adisconnect%3AInternalEnv"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span>
</span><span id="line-1165"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910264"><span class="hs-identifier hs-var">intEnv</span></a></span><span>
</span><span id="line-1166"></span><span>
</span><span id="line-1167"></span><span>    </span><span class="hs-comment">-- When pipelining, the tip of the candidate is forgiven for being an</span><span>
</span><span id="line-1168"></span><span>    </span><span class="hs-comment">-- invalid block, but not if it extends any invalid blocks.</span><span>
</span><span id="line-1169"></span><span>    </span><span id="local-6989586621679910266"><span class="annot"><span class="annottext">scrutinee :: ChainHash blk
</span><a href="#local-6989586621679910266"><span class="hs-identifier hs-var hs-var">scrutinee</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">isPipeliningEnabled</span></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679910279"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1170"></span><span>        </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">NotReceivingTentativeBlocks</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; ChainHash blk
forall {k} (b :: k). HeaderHash b -&gt; ChainHash b
</span><span class="hs-identifier hs-var">BlockHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910265"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>        </span><span class="hs-comment">-- Disconnect if the parent block of `hdr` is known to be invalid.</span><span>
</span><span id="line-1172"></span><span>        </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">ReceivingTentativeBlocks</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; ChainHash blk
forall blk. GetPrevHash blk =&gt; Header blk -&gt; ChainHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPrevHash"><span class="hs-identifier hs-var">headerPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910265"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1173"></span><span>
</span><span id="line-1174"></span><span class="hs-comment">-- | Manage the relationships between the header's slot, arrival time, and</span><span>
</span><span id="line-1175"></span><span class="hs-comment">-- intersection with the local selection</span><span>
</span><span id="line-1176"></span><span class="hs-comment">--</span><span>
</span><span id="line-1177"></span><span class="hs-comment">-- The first step is to determine the timestamp of the slot's onset. If the</span><span>
</span><span id="line-1178"></span><span class="hs-comment">-- intersection with local selection is much older than the header, then this</span><span>
</span><span id="line-1179"></span><span class="hs-comment">-- may not be possible. The client will block until that is no longer true.</span><span>
</span><span id="line-1180"></span><span class="hs-comment">-- However, it will stop blocking and 'exitEarly' as soon as</span><span>
</span><span id="line-1181"></span><span class="hs-comment">-- 'NoLongerIntersects' arises.</span><span>
</span><span id="line-1182"></span><span class="hs-comment">--</span><span>
</span><span id="line-1183"></span><span class="hs-comment">-- If the slot is from the far-future, the peer is buggy, so disconnect. If</span><span>
</span><span id="line-1184"></span><span class="hs-comment">-- it's from the near-future, follow the Ouroboros Chronos rule and ignore this</span><span>
</span><span id="line-1185"></span><span class="hs-comment">-- peer until this header is no longer from the future.</span><span>
</span><span id="line-1186"></span><span class="hs-comment">--</span><span>
</span><span id="line-1187"></span><span class="hs-comment">-- Finally, the client will block on the intersection a second time, if</span><span>
</span><span id="line-1188"></span><span class="hs-comment">-- necessary, since it's possible for a ledger state to determine the slot's</span><span>
</span><span id="line-1189"></span><span class="hs-comment">-- onset's timestamp without also determining the slot's 'LedgerView'.</span><span>
</span><span id="line-1190"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkTime"><span class="hs-identifier hs-type">checkTime</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1191"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679909059"><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679909060"><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679909061"><span class="annot"><a href="#local-6989586621679909061"><span class="hs-identifier hs-type">arrival</span></a></span></span><span> </span><span id="local-6989586621679909062"><span class="annot"><a href="#local-6989586621679909062"><span class="hs-identifier hs-type">judgment</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1192"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1193"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1194"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1195"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1196"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909061"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909062"><span class="hs-identifier hs-type">judgment</span></a></span><span>
</span><span id="line-1197"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1198"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909061"><span class="hs-identifier hs-type">arrival</span></a></span><span>
</span><span id="line-1199"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-1200"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UpdatedIntersectionState"><span class="hs-identifier hs-type">UpdatedIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1201"></span><span id="checkTime"><span class="annot"><span class="annottext">checkTime :: forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; KnownIntersectionState blk
-&gt; arrival
-&gt; SlotNo
-&gt; m (UpdatedIntersectionState
        blk (LedgerView (BlockProtocol blk)))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkTime"><span class="hs-identifier hs-var hs-var">checkTime</span></a></span></span><span> </span><span id="local-6989586621679910317"><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910317"><span class="hs-identifier hs-var">cfgEnv</span></a></span></span><span> </span><span id="local-6989586621679910318"><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910318"><span class="hs-identifier hs-var">intEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1202"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679910319"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910319"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910320"><span class="annot"><span class="annottext">arrival
</span><a href="#local-6989586621679910320"><span class="hs-identifier hs-var">arrival</span></a></span></span><span> </span><span id="local-6989586621679910321"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679910321"><span class="hs-identifier hs-var">slotNo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WithEarlyExit m (Intersects blk (LedgerView (BlockProtocol blk)))
-&gt; m (UpdatedIntersectionState
        blk (LedgerView (BlockProtocol blk)))
forall (m :: * -&gt; *) blk a.
Monad m =&gt;
WithEarlyExit m (Intersects blk a)
-&gt; m (UpdatedIntersectionState blk a)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#castEarlyExitIntersects"><span class="hs-identifier hs-var">castEarlyExitIntersects</span></a></span><span> </span><span class="annot"><span class="annottext">(WithEarlyExit m (Intersects blk (LedgerView (BlockProtocol blk)))
 -&gt; m (UpdatedIntersectionState
         blk (LedgerView (BlockProtocol blk))))
-&gt; WithEarlyExit
     m (Intersects blk (LedgerView (BlockProtocol blk)))
-&gt; m (UpdatedIntersectionState
        blk (LedgerView (BlockProtocol blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1203"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span id="local-6989586621679910324"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910324"><span class="hs-identifier hs-var">kis2</span></a></span></span><span> </span><span id="local-6989586621679910325"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910325"><span class="hs-identifier hs-var">lst</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; arrival -&gt; WithEarlyExit m (Intersects blk (LedgerState blk))
</span><a href="#local-6989586621679910326"><span class="hs-identifier hs-var">checkArrivalTime</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910319"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">arrival
</span><a href="#local-6989586621679910320"><span class="hs-identifier hs-var">arrival</span></a></span><span>
</span><span id="line-1204"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span id="local-6989586621679910327"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910327"><span class="hs-identifier hs-var">kis3</span></a></span></span><span> </span><span id="local-6989586621679910328"><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910328"><span class="hs-identifier hs-var">ledgerView</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; LedgerState blk -&gt; Maybe (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621679910329"><span class="hs-identifier hs-var">projectLedgerView</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679910321"><span class="hs-identifier hs-var">slotNo</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910325"><span class="hs-identifier hs-var">lst</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1205"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679910330"><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910330"><span class="hs-identifier hs-var">ledgerView</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Intersects blk (LedgerView (BlockProtocol blk))
-&gt; WithEarlyExit
     m (Intersects blk (LedgerView (BlockProtocol blk)))
forall a. a -&gt; WithEarlyExit m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Intersects blk (LedgerView (BlockProtocol blk))
 -&gt; WithEarlyExit
      m (Intersects blk (LedgerView (BlockProtocol blk))))
-&gt; Intersects blk (LedgerView (BlockProtocol blk))
-&gt; WithEarlyExit
     m (Intersects blk (LedgerView (BlockProtocol blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; LedgerView (BlockProtocol blk)
-&gt; Intersects blk (LedgerView (BlockProtocol blk))
forall blk a. KnownIntersectionState blk -&gt; a -&gt; Intersects blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-var">Intersects</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910324"><span class="hs-identifier hs-var">kis2</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910330"><span class="hs-identifier hs-var">ledgerView</span></a></span><span>
</span><span id="line-1206"></span><span>            </span><span class="annot"><span class="annottext">Maybe (LedgerView (BlockProtocol blk))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe (LedgerView (BlockProtocol blk)))
-&gt; WithEarlyExit
     m (Intersects blk (LedgerView (BlockProtocol blk)))
forall a.
KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe a)
-&gt; WithEarlyExit m (Intersects blk a)
</span><a href="#local-6989586621679910331"><span class="hs-identifier hs-var">readLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910324"><span class="hs-identifier hs-var">kis2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; LedgerState blk -&gt; Maybe (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621679910329"><span class="hs-identifier hs-var">projectLedgerView</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679910321"><span class="hs-identifier hs-var">slotNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1207"></span><span>        </span><span class="annot"><span class="annottext">Intersects blk (LedgerView (BlockProtocol blk))
-&gt; WithEarlyExit
     m (Intersects blk (LedgerView (BlockProtocol blk)))
forall a. a -&gt; WithEarlyExit m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Intersects blk (LedgerView (BlockProtocol blk))
 -&gt; WithEarlyExit
      m (Intersects blk (LedgerView (BlockProtocol blk))))
-&gt; Intersects blk (LedgerView (BlockProtocol blk))
-&gt; WithEarlyExit
     m (Intersects blk (LedgerView (BlockProtocol blk)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; LedgerView (BlockProtocol blk)
-&gt; Intersects blk (LedgerView (BlockProtocol blk))
forall blk a. KnownIntersectionState blk -&gt; a -&gt; Intersects blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-var">Intersects</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910327"><span class="hs-identifier hs-var">kis3</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910328"><span class="hs-identifier hs-var">ledgerView</span></a></span><span>
</span><span id="line-1208"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1209"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1210"></span><span>        </span><span id="local-6989586621679910332"><span class="annot"><span class="annottext">TopLevelConfig blk
$sel:cfg:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; TopLevelConfig blk
cfg :: TopLevelConfig blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Acfg%3AConfigEnv"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>
</span><span id="line-1211"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910333"><span class="annot"><span class="annottext">ChainDbView m blk
$sel:chainDbView:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; ChainDbView m blk
chainDbView :: ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AchainDbView%3AConfigEnv"><span class="hs-identifier hs-var hs-var">chainDbView</span></a></span></span><span>
</span><span id="line-1212"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910317"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-1213"></span><span>
</span><span id="line-1214"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1215"></span><span>        </span><span id="local-6989586621679910334"><span class="annot"><span class="annottext">Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
$sel:getPastLedger:ChainDbView :: forall (m :: * -&gt; *) blk.
ChainDbView m blk
-&gt; Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
getPastLedger :: Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AgetPastLedger%3AChainDbView"><span class="hs-identifier hs-var hs-var">getPastLedger</span></a></span></span><span>
</span><span id="line-1216"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679910333"><span class="hs-identifier hs-var">chainDbView</span></a></span><span>
</span><span id="line-1217"></span><span>
</span><span id="line-1218"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1219"></span><span>        </span><span id="local-6989586621679910335"><span class="annot"><span class="annottext">forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
$sel:disconnect:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall (m' :: * -&gt; *) a.
   MonadThrow m' =&gt;
   ChainSyncClientException -&gt; m' a
disconnect :: forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Adisconnect%3AInternalEnv"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span>
</span><span id="line-1220"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910336"><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
$sel:headerInFutureCheck:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; HeaderInFutureCheck m blk arrival judgment
headerInFutureCheck :: HeaderInFutureCheck m blk arrival judgment
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AheaderInFutureCheck%3AInternalEnv"><span class="hs-identifier hs-var hs-var">headerInFutureCheck</span></a></span></span><span>
</span><span id="line-1221"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910337"><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
$sel:intersectsWithCurrentChain:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
intersectsWithCurrentChain :: KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AintersectsWithCurrentChain%3AInternalEnv"><span class="hs-identifier hs-var hs-var">intersectsWithCurrentChain</span></a></span></span><span>
</span><span id="line-1222"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910318"><span class="hs-identifier hs-var">intEnv</span></a></span><span>
</span><span id="line-1223"></span><span>
</span><span id="line-1224"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html#HeaderInFutureCheck"><span class="hs-identifier hs-type">InFutureCheck.HeaderInFutureCheck</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1225"></span><span>        </span><span id="local-6989586621679910338"><span class="annot"><span class="annottext">judgment -&gt; m (Maybe HeaderArrivalException)
handleHeaderArrival :: judgment -&gt; m (Maybe HeaderArrivalException)
handleHeaderArrival :: forall (m :: * -&gt; *) blk arrival judgment.
HeaderInFutureCheck m blk arrival judgment
-&gt; judgment -&gt; m (Maybe HeaderArrivalException)
</span><a href="#local-6989586621679910338"><span class="hs-identifier hs-var hs-var">handleHeaderArrival</span></a></span></span><span>
</span><span id="line-1226"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910340"><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; LedgerState blk
-&gt; arrival
-&gt; Except PastHorizonException judgment
judgeHeaderArrival :: LedgerConfig blk
-&gt; LedgerState blk
-&gt; arrival
-&gt; Except PastHorizonException judgment
judgeHeaderArrival :: forall (m :: * -&gt; *) blk arrival judgment.
HeaderInFutureCheck m blk arrival judgment
-&gt; LedgerConfig blk
-&gt; LedgerState blk
-&gt; arrival
-&gt; Except PastHorizonException judgment
</span><a href="#local-6989586621679910340"><span class="hs-identifier hs-var hs-var">judgeHeaderArrival</span></a></span></span><span>
</span><span id="line-1227"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderInFutureCheck m blk arrival judgment
</span><a href="#local-6989586621679910336"><span class="hs-identifier hs-var">headerInFutureCheck</span></a></span><span>
</span><span id="line-1228"></span><span>
</span><span id="line-1229"></span><span>    </span><span class="hs-comment">-- Determine whether the header is from the future, and handle that fact if</span><span>
</span><span id="line-1230"></span><span>    </span><span class="hs-comment">-- so. Also return the ledger state used for the determination.</span><span>
</span><span id="line-1231"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1232"></span><span>    </span><span class="hs-comment">-- Relies on 'readLedgerState'.</span><span>
</span><span id="line-1233"></span><span>    </span><span class="annot"><a href="#local-6989586621679910326"><span class="hs-identifier hs-type">checkArrivalTime</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1234"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1235"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909061"><span class="hs-identifier hs-type">arrival</span></a></span><span>
</span><span id="line-1236"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#WithEarlyExit"><span class="hs-identifier hs-type">WithEarlyExit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1237"></span><span>    </span><span id="local-6989586621679910326"><span class="annot"><span class="annottext">checkArrivalTime :: KnownIntersectionState blk
-&gt; arrival -&gt; WithEarlyExit m (Intersects blk (LedgerState blk))
</span><a href="#local-6989586621679910326"><span class="hs-identifier hs-var hs-var">checkArrivalTime</span></a></span></span><span> </span><span id="local-6989586621679910342"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910342"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910343"><span class="annot"><span class="annottext">arrival
</span><a href="#local-6989586621679910343"><span class="hs-identifier hs-var">arrival</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1238"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span id="local-6989586621679910344"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910344"><span class="hs-identifier hs-var">kis'</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910345"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910345"><span class="hs-identifier hs-var">lst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910346"><span class="annot"><span class="annottext">judgment
</span><a href="#local-6989586621679910346"><span class="hs-identifier hs-var">judgment</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1239"></span><span>            </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe (LedgerState blk, judgment))
-&gt; WithEarlyExit m (Intersects blk (LedgerState blk, judgment))
forall a.
KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe a)
-&gt; WithEarlyExit m (Intersects blk a)
</span><a href="#local-6989586621679910331"><span class="hs-identifier hs-var">readLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910342"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">((LedgerState blk -&gt; Maybe (LedgerState blk, judgment))
 -&gt; WithEarlyExit m (Intersects blk (LedgerState blk, judgment)))
-&gt; (LedgerState blk -&gt; Maybe (LedgerState blk, judgment))
-&gt; WithEarlyExit m (Intersects blk (LedgerState blk, judgment))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679910347"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910347"><span class="hs-identifier hs-var">lst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1240"></span><span>                </span><span class="hs-keyword">case</span><span>   </span><span class="annot"><span class="annottext">Except PastHorizonException judgment
-&gt; Either PastHorizonException judgment
forall e a. Except e a -&gt; Either e a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExcept"><span class="hs-identifier hs-var">runExcept</span></a></span><span>
</span><span id="line-1241"></span><span>                     </span><span class="annot"><span class="annottext">(Except PastHorizonException judgment
 -&gt; Either PastHorizonException judgment)
-&gt; Except PastHorizonException judgment
-&gt; Either PastHorizonException judgment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; LedgerState blk
-&gt; arrival
-&gt; Except PastHorizonException judgment
</span><a href="#local-6989586621679910340"><span class="hs-identifier hs-var">judgeHeaderArrival</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configLedger"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679910332"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910347"><span class="hs-identifier hs-var">lst</span></a></span><span> </span><span class="annot"><span class="annottext">arrival
</span><a href="#local-6989586621679910343"><span class="hs-identifier hs-var">arrival</span></a></span><span>
</span><span id="line-1242"></span><span>                  </span><span class="hs-keyword">of</span><span>
</span><span id="line-1243"></span><span>                    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.Qry.html#PastHorizon"><span class="hs-identifier hs-type">PastHorizon</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (LedgerState blk, judgment)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1244"></span><span>                    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679910349"><span class="annot"><span class="annottext">judgment
</span><a href="#local-6989586621679910349"><span class="hs-identifier hs-var">judgment</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(LedgerState blk, judgment) -&gt; Maybe (LedgerState blk, judgment)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910347"><span class="hs-identifier hs-var">lst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">judgment
</span><a href="#local-6989586621679910349"><span class="hs-identifier hs-var">judgment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1245"></span><span>
</span><span id="line-1246"></span><span>        </span><span class="hs-comment">-- For example, throw an exception if the header is from the far</span><span>
</span><span id="line-1247"></span><span>        </span><span class="hs-comment">-- future.</span><span>
</span><span id="line-1248"></span><span>        </span><span class="annot"><span class="annottext">m (Intersects blk (LedgerState blk))
-&gt; WithEarlyExit m (Intersects blk (LedgerState blk))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; WithEarlyExit m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">EarlyExit.lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Intersects blk (LedgerState blk))
 -&gt; WithEarlyExit m (Intersects blk (LedgerState blk)))
-&gt; m (Intersects blk (LedgerState blk))
-&gt; WithEarlyExit m (Intersects blk (LedgerState blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">judgment -&gt; m (Maybe HeaderArrivalException)
</span><a href="#local-6989586621679910338"><span class="hs-identifier hs-var">handleHeaderArrival</span></a></span><span> </span><span class="annot"><span class="annottext">judgment
</span><a href="#local-6989586621679910346"><span class="hs-identifier hs-var">judgment</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe HeaderArrivalException)
-&gt; (Maybe HeaderArrivalException
    -&gt; m (Intersects blk (LedgerState blk)))
-&gt; m (Intersects blk (LedgerState blk))
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1249"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679910351"><span class="annot"><span class="annottext">HeaderArrivalException
</span><a href="#local-6989586621679910351"><span class="hs-identifier hs-var">exn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m (Intersects blk (LedgerState blk))
forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="#local-6989586621679910335"><span class="hs-identifier hs-var">disconnect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderArrivalException -&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InFutureHeaderExceedsClockSkew"><span class="hs-identifier hs-var">InFutureHeaderExceedsClockSkew</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderArrivalException
</span><a href="#local-6989586621679910351"><span class="hs-identifier hs-var">exn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1250"></span><span>            </span><span class="annot"><span class="annottext">Maybe HeaderArrivalException
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Intersects blk (LedgerState blk)
-&gt; m (Intersects blk (LedgerState blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Intersects blk (LedgerState blk)
 -&gt; m (Intersects blk (LedgerState blk)))
-&gt; Intersects blk (LedgerState blk)
-&gt; m (Intersects blk (LedgerState blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; LedgerState blk -&gt; Intersects blk (LedgerState blk)
forall blk a. KnownIntersectionState blk -&gt; a -&gt; Intersects blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-var">Intersects</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910344"><span class="hs-identifier hs-var">kis'</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910345"><span class="hs-identifier hs-var">lst</span></a></span><span>
</span><span id="line-1251"></span><span>
</span><span id="line-1252"></span><span>    </span><span class="hs-comment">-- Block until the the ledger state at the intersection with the local</span><span>
</span><span id="line-1253"></span><span>    </span><span class="hs-comment">-- selection returns 'Just'.</span><span>
</span><span id="line-1254"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1255"></span><span>    </span><span class="hs-comment">-- Exits early if the intersection no longer exists.</span><span>
</span><span id="line-1256"></span><span>    </span><span class="annot"><a href="#local-6989586621679910331"><span class="hs-identifier hs-type">readLedgerState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1257"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679909098"><span class="annot"><a href="#local-6989586621679909098"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1258"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1259"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909098"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1260"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#WithEarlyExit"><span class="hs-identifier hs-type">WithEarlyExit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909098"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1261"></span><span>    </span><span id="local-6989586621679910331"><span class="annot"><span class="annottext">readLedgerState :: forall a.
KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe a)
-&gt; WithEarlyExit m (Intersects blk a)
</span><a href="#local-6989586621679910331"><span class="hs-identifier hs-var hs-var">readLedgerState</span></a></span></span><span> </span><span id="local-6989586621679910354"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910354"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910355"><span class="annot"><span class="annottext">LedgerState blk -&gt; Maybe a
</span><a href="#local-6989586621679910355"><span class="hs-identifier hs-var">prj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (WithEarlyExit m (Intersects blk a))
-&gt; WithEarlyExit m (Intersects blk a)
forall (m :: * -&gt; *) x.
Monad m =&gt;
m (WithEarlyExit m x) -&gt; WithEarlyExit m x
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#castM"><span class="hs-identifier hs-var">castM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (WithEarlyExit m (Intersects blk a))
 -&gt; WithEarlyExit m (Intersects blk a))
-&gt; m (WithEarlyExit m (Intersects blk a))
-&gt; WithEarlyExit m (Intersects blk a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe a)
-&gt; m (WithEarlyExit m (Intersects blk a))
forall a.
KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe a)
-&gt; m (WithEarlyExit m (Intersects blk a))
</span><a href="#local-6989586621679910357"><span class="hs-identifier hs-var">readLedgerStateHelper</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910354"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk -&gt; Maybe a
</span><a href="#local-6989586621679910355"><span class="hs-identifier hs-var">prj</span></a></span><span>
</span><span id="line-1262"></span><span>
</span><span id="line-1263"></span><span>    </span><span class="annot"><a href="#local-6989586621679910357"><span class="hs-identifier hs-type">readLedgerStateHelper</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1264"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679909120"><span class="annot"><a href="#local-6989586621679909120"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1265"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1266"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909120"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1267"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#WithEarlyExit"><span class="hs-identifier hs-type">WithEarlyExit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909120"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1268"></span><span>    </span><span id="local-6989586621679910357"><span class="annot"><span class="annottext">readLedgerStateHelper :: forall a.
KnownIntersectionState blk
-&gt; (LedgerState blk -&gt; Maybe a)
-&gt; m (WithEarlyExit m (Intersects blk a))
</span><a href="#local-6989586621679910357"><span class="hs-identifier hs-var hs-var">readLedgerStateHelper</span></a></span></span><span> </span><span id="local-6989586621679910374"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910374"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910375"><span class="annot"><span class="annottext">LedgerState blk -&gt; Maybe a
</span><a href="#local-6989586621679910375"><span class="hs-identifier hs-var">prj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (WithEarlyExit m (Intersects blk a))
-&gt; m (WithEarlyExit m (Intersects blk a))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (WithEarlyExit m (Intersects blk a))
 -&gt; m (WithEarlyExit m (Intersects blk a)))
-&gt; STM m (WithEarlyExit m (Intersects blk a))
-&gt; m (WithEarlyExit m (Intersects blk a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1269"></span><span>        </span><span class="hs-comment">-- We must first find the most recent intersection with the current</span><span>
</span><span id="line-1270"></span><span>        </span><span class="hs-comment">-- chain. Note that this is cheap when the chain and candidate haven't</span><span>
</span><span id="line-1271"></span><span>        </span><span class="hs-comment">-- changed.</span><span>
</span><span id="line-1272"></span><span>        </span><span class="annot"><span class="annottext">KnownIntersectionState blk
-&gt; STM m (UpdatedIntersectionState blk ())
</span><a href="#local-6989586621679910337"><span class="hs-identifier hs-var">intersectsWithCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910374"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (UpdatedIntersectionState blk ())
-&gt; (UpdatedIntersectionState blk ()
    -&gt; STM m (WithEarlyExit m (Intersects blk a)))
-&gt; STM m (WithEarlyExit m (Intersects blk a))
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1273"></span><span>            </span><span class="annot"><span class="annottext">UpdatedIntersectionState blk ()
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WithEarlyExit m (Intersects blk a)
-&gt; STM m (WithEarlyExit m (Intersects blk a))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">WithEarlyExit m (Intersects blk a)
forall (m :: * -&gt; *) a. Applicative m =&gt; WithEarlyExit m a
</span><a href="Ouroboros.Consensus.Util.EarlyExit.html#exitEarly"><span class="hs-identifier hs-var">exitEarly</span></a></span><span>
</span><span id="line-1274"></span><span>            </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StillIntersects"><span class="hs-identifier hs-type">StillIntersects</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910376"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910376"><span class="hs-identifier hs-var">kis'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1275"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1276"></span><span>                        </span><span id="local-6989586621679910377"><span class="annot"><span class="annottext">Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
mostRecentIntersection :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-1277"></span><span>                      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910376"><span class="hs-identifier hs-var">kis'</span></a></span><span>
</span><span id="line-1278"></span><span>                </span><span id="local-6989586621679910378"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910378"><span class="hs-identifier hs-var">lst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1279"></span><span>                    </span><span class="annot"><span class="annottext">(Maybe (ExtLedgerState blk) -&gt; LedgerState blk)
-&gt; STM m (Maybe (ExtLedgerState blk)) -&gt; STM m (LedgerState blk)
forall a b. (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span>
</span><span id="line-1280"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerState blk
-&gt; (ExtLedgerState blk -&gt; LedgerState blk)
-&gt; Maybe (ExtLedgerState blk)
-&gt; LedgerState blk
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span>
</span><span id="line-1281"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; LedgerState blk
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; LedgerState blk) -&gt; String -&gt; LedgerState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1282"></span><span>                                 </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;intersection not within last k blocks: &quot;</span></span><span>
</span><span id="line-1283"></span><span>                              </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910377"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-1284"></span><span>                           </span><span class="hs-special">)</span><span>
</span><span id="line-1285"></span><span>                           </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span>
</span><span id="line-1286"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-1287"></span><span>                  </span><span class="annot"><span class="annottext">(STM m (Maybe (ExtLedgerState blk)) -&gt; STM m (LedgerState blk))
-&gt; STM m (Maybe (ExtLedgerState blk)) -&gt; STM m (LedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; STM m (Maybe (ExtLedgerState blk))
</span><a href="#local-6989586621679910334"><span class="hs-identifier hs-var">getPastLedger</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910377"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-1288"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LedgerState blk -&gt; Maybe a
</span><a href="#local-6989586621679910375"><span class="hs-identifier hs-var">prj</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910378"><span class="hs-identifier hs-var">lst</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1289"></span><span>                    </span><span class="annot"><span class="annottext">Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m (WithEarlyExit m (Intersects blk a))
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-1290"></span><span>                    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679910383"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679910383"><span class="hs-identifier hs-var">ledgerView</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1291"></span><span>                        </span><span class="annot"><span class="annottext">WithEarlyExit m (Intersects blk a)
-&gt; STM m (WithEarlyExit m (Intersects blk a))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(WithEarlyExit m (Intersects blk a)
 -&gt; STM m (WithEarlyExit m (Intersects blk a)))
-&gt; WithEarlyExit m (Intersects blk a)
-&gt; STM m (WithEarlyExit m (Intersects blk a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Intersects blk a -&gt; WithEarlyExit m (Intersects blk a)
forall a. a -&gt; WithEarlyExit m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Intersects blk a -&gt; WithEarlyExit m (Intersects blk a))
-&gt; Intersects blk a -&gt; WithEarlyExit m (Intersects blk a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; a -&gt; Intersects blk a
forall blk a. KnownIntersectionState blk -&gt; a -&gt; Intersects blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-var">Intersects</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910376"><span class="hs-identifier hs-var">kis'</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679910383"><span class="hs-identifier hs-var">ledgerView</span></a></span><span>
</span><span id="line-1292"></span><span>
</span><span id="line-1293"></span><span>    </span><span class="hs-comment">-- Returns 'Nothing' if the ledger state cannot forecast the ledger view</span><span>
</span><span id="line-1294"></span><span>    </span><span class="hs-comment">-- that far into the future.</span><span>
</span><span id="line-1295"></span><span>    </span><span class="annot"><a href="#local-6989586621679910329"><span class="hs-identifier hs-type">projectLedgerView</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1296"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-1297"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1298"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909060"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1299"></span><span>    </span><span id="local-6989586621679910329"><span class="annot"><span class="annottext">projectLedgerView :: SlotNo -&gt; LedgerState blk -&gt; Maybe (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621679910329"><span class="hs-identifier hs-var hs-var">projectLedgerView</span></a></span></span><span> </span><span id="local-6989586621679910384"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679910384"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span id="local-6989586621679910385"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910385"><span class="hs-identifier hs-var">lst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1300"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910386"><span class="annot"><span class="annottext">forecast :: Forecast (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621679910386"><span class="hs-identifier hs-var hs-var">forecast</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; LedgerState blk -&gt; Forecast (LedgerView (BlockProtocol blk))
forall blk.
(LedgerSupportsProtocol blk, HasCallStack) =&gt;
LedgerConfig blk
-&gt; LedgerState blk -&gt; Forecast (LedgerView (BlockProtocol blk))
</span><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#ledgerViewForecastAt"><span class="hs-identifier hs-var">ledgerViewForecastAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configLedger"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679910332"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679910385"><span class="hs-identifier hs-var">lst</span></a></span><span>
</span><span id="line-1301"></span><span>              </span><span class="hs-comment">-- TODO cache this in the KnownIntersectionState? Or even in the</span><span>
</span><span id="line-1302"></span><span>              </span><span class="hs-comment">-- LedgerDB?</span><span>
</span><span id="line-1303"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-1304"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Except OutsideForecastRange (LedgerView (BlockProtocol blk))
-&gt; Either OutsideForecastRange (LedgerView (BlockProtocol blk))
forall e a. Except e a -&gt; Either e a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExcept"><span class="hs-identifier hs-var">runExcept</span></a></span><span> </span><span class="annot"><span class="annottext">(Except OutsideForecastRange (LedgerView (BlockProtocol blk))
 -&gt; Either OutsideForecastRange (LedgerView (BlockProtocol blk)))
-&gt; Except OutsideForecastRange (LedgerView (BlockProtocol blk))
-&gt; Either OutsideForecastRange (LedgerView (BlockProtocol blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Forecast (LedgerView (BlockProtocol blk))
-&gt; SlotNo
-&gt; Except OutsideForecastRange (LedgerView (BlockProtocol blk))
forall a. Forecast a -&gt; SlotNo -&gt; Except OutsideForecastRange a
</span><a href="Ouroboros.Consensus.Forecast.html#forecastFor"><span class="hs-identifier hs-var">forecastFor</span></a></span><span> </span><span class="annot"><span class="annottext">Forecast (LedgerView (BlockProtocol blk))
</span><a href="#local-6989586621679910386"><span class="hs-identifier hs-var">forecast</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679910384"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1305"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679910389"><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910389"><span class="hs-identifier hs-var">ledgerView</span></a></span></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
-&gt; Maybe (LedgerView (BlockProtocol blk))
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910389"><span class="hs-identifier hs-var">ledgerView</span></a></span><span>
</span><span id="line-1306"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Forecast.html#OutsideForecastRange"><span class="hs-identifier hs-type">OutsideForecastRange</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1307"></span><span>                </span><span class="hs-comment">-- The header is too far ahead of the intersection point with</span><span>
</span><span id="line-1308"></span><span>                </span><span class="hs-comment">-- our current chain. We have to wait until our chain and the</span><span>
</span><span id="line-1309"></span><span>                </span><span class="hs-comment">-- intersection have advanced far enough. This will wait on</span><span>
</span><span id="line-1310"></span><span>                </span><span class="hs-comment">-- changes to the current chain via the call to</span><span>
</span><span id="line-1311"></span><span>                </span><span class="hs-comment">-- 'intersectsWithCurrentChain' before it.</span><span>
</span><span id="line-1312"></span><span>                </span><span class="annot"><span class="annottext">Maybe (LedgerView (BlockProtocol blk))
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1313"></span><span>
</span><span id="line-1314"></span><span class="hs-comment">-- | Update the 'KnownIntersectionState' according to the header, if it's valid</span><span>
</span><span id="line-1315"></span><span class="hs-comment">--</span><span>
</span><span id="line-1316"></span><span class="hs-comment">-- Crucially: disconnects if it isn't.</span><span>
</span><span id="line-1317"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkValid"><span class="hs-identifier hs-type">checkValid</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1318"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679909063"><span class="annot"><a href="#local-6989586621679909063"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679909064"><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679909065"><span class="annot"><a href="#local-6989586621679909065"><span class="hs-identifier hs-type">arrival</span></a></span></span><span> </span><span id="local-6989586621679909066"><span class="annot"><a href="#local-6989586621679909066"><span class="hs-identifier hs-type">judgment</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1319"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909063"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1320"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1321"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1322"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909063"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1323"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909063"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909065"><span class="hs-identifier hs-type">arrival</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909066"><span class="hs-identifier hs-type">judgment</span></a></span><span>
</span><span id="line-1324"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1325"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1326"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1327"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#LedgerView"><span class="hs-identifier hs-type">LedgerView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1328"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909063"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909064"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1329"></span><span id="checkValid"><span class="annot"><span class="annottext">checkValid :: forall (m :: * -&gt; *) blk arrival judgment.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ConfigEnv m blk
-&gt; InternalEnv m blk arrival judgment
-&gt; Header blk
-&gt; Their (Tip blk)
-&gt; KnownIntersectionState blk
-&gt; LedgerView (BlockProtocol blk)
-&gt; m (KnownIntersectionState blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#checkValid"><span class="hs-identifier hs-var hs-var">checkValid</span></a></span></span><span> </span><span id="local-6989586621679910434"><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910434"><span class="hs-identifier hs-var">cfgEnv</span></a></span></span><span> </span><span id="local-6989586621679910435"><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910435"><span class="hs-identifier hs-var">intEnv</span></a></span></span><span> </span><span id="local-6989586621679910436"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910436"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span id="local-6989586621679910437"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910437"><span class="hs-identifier hs-var">theirTip</span></a></span></span><span> </span><span id="local-6989586621679910438"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910438"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910439"><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910439"><span class="hs-identifier hs-var">ledgerView</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1330"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1331"></span><span>            </span><span id="local-6989586621679910440"><span class="annot"><span class="annottext">Point blk
$sel:mostRecentIntersection:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; Point blk
mostRecentIntersection :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">mostRecentIntersection</span></a></span></span><span>
</span><span id="line-1332"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910441"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
ourFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var hs-var">ourFrag</span></a></span></span><span>
</span><span id="line-1333"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910442"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
theirFrag :: forall blk.
KnownIntersectionState blk -&gt; AnchoredFragment (Header blk)
theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var hs-var">theirFrag</span></a></span></span><span>
</span><span id="line-1334"></span><span>          </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910443"><span class="annot"><span class="annottext">HeaderStateHistory blk
$sel:theirHeaderStateHistory:KnownIntersectionState :: forall blk. KnownIntersectionState blk -&gt; HeaderStateHistory blk
theirHeaderStateHistory :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var hs-var">theirHeaderStateHistory</span></a></span></span><span>
</span><span id="line-1335"></span><span>          </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910438"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1336"></span><span>
</span><span id="line-1337"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910444"><span class="annot"><span class="annottext">hdrPoint :: Point blk
</span><a href="#local-6989586621679910444"><span class="hs-identifier hs-var hs-var">hdrPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910436"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1338"></span><span>
</span><span id="line-1339"></span><span>    </span><span class="hs-comment">-- Validate header</span><span>
</span><span id="line-1340"></span><span>    </span><span id="local-6989586621679910445"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910445"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1341"></span><span>        </span><span class="hs-keyword">case</span><span>   </span><span class="annot"><span class="annottext">Except (HeaderError blk) (HeaderStateHistory blk)
-&gt; Either (HeaderError blk) (HeaderStateHistory blk)
forall e a. Except e a -&gt; Either e a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExcept"><span class="hs-identifier hs-var">runExcept</span></a></span><span>
</span><span id="line-1342"></span><span>             </span><span class="annot"><span class="annottext">(Except (HeaderError blk) (HeaderStateHistory blk)
 -&gt; Either (HeaderError blk) (HeaderStateHistory blk))
-&gt; Except (HeaderError blk) (HeaderStateHistory blk)
-&gt; Either (HeaderError blk) (HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; LedgerView (BlockProtocol blk)
-&gt; Header blk
-&gt; HeaderStateHistory blk
-&gt; Except (HeaderError blk) (HeaderStateHistory blk)
forall blk.
(BlockSupportsProtocol blk, ValidateEnvelope blk) =&gt;
TopLevelConfig blk
-&gt; LedgerView (BlockProtocol blk)
-&gt; Header blk
-&gt; HeaderStateHistory blk
-&gt; Except (HeaderError blk) (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.HeaderStateHistory.html#validateHeader"><span class="hs-identifier hs-var">validateHeader</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679910446"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerView (BlockProtocol blk)
</span><a href="#local-6989586621679910439"><span class="hs-identifier hs-var">ledgerView</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910436"><span class="hs-identifier hs-var">hdr</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910443"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span>
</span><span id="line-1343"></span><span>          </span><span class="hs-keyword">of</span><span>
</span><span id="line-1344"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679910447"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910447"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk -&gt; m (HeaderStateHistory blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910447"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span><span>
</span><span id="line-1345"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679910448"><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621679910448"><span class="hs-identifier hs-var">vErr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1346"></span><span>                </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m (HeaderStateHistory blk)
forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="#local-6989586621679910449"><span class="hs-identifier hs-var">disconnect</span></a></span><span>
</span><span id="line-1347"></span><span>              </span><span class="annot"><span class="annottext">(ChainSyncClientException -&gt; m (HeaderStateHistory blk))
-&gt; ChainSyncClientException -&gt; m (HeaderStateHistory blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; HeaderError blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; ChainSyncClientException
forall blk.
(BlockSupportsProtocol blk, ValidateEnvelope blk) =&gt;
Point blk
-&gt; HeaderError blk
-&gt; Our (Tip blk)
-&gt; Their (Tip blk)
-&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-var">HeaderError</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910444"><span class="hs-identifier hs-var">hdrPoint</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621679910448"><span class="hs-identifier hs-var">vErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Our (Tip blk)
forall blk.
HasHeader (Header blk) =&gt;
AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourTipFromChain"><span class="hs-identifier hs-var">ourTipFromChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910441"><span class="hs-identifier hs-var">ourFrag</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910437"><span class="hs-identifier hs-var">theirTip</span></a></span><span>
</span><span id="line-1348"></span><span>
</span><span id="line-1349"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910451"><span class="annot"><span class="annottext">theirFrag' :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910451"><span class="hs-identifier hs-var hs-var">theirFrag'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910442"><span class="hs-identifier hs-var">theirFrag</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; Header blk -&gt; AnchoredFragment (Header blk)
forall v a b.
Anchorable v a b =&gt;
AnchoredSeq v a b -&gt; b -&gt; AnchoredSeq v a b
</span><span class="hs-operator hs-var">:&gt;</span></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910436"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1350"></span><span>        </span><span class="hs-comment">-- Advance the most recent intersection if we have the same</span><span>
</span><span id="line-1351"></span><span>        </span><span class="hs-comment">-- header on our fragment too. This is cheaper than recomputing</span><span>
</span><span id="line-1352"></span><span>        </span><span class="hs-comment">-- the intersection from scratch.</span><span>
</span><span id="line-1353"></span><span>        </span><span id="local-6989586621679910453"><span class="annot"><span class="annottext">mostRecentIntersection' :: Point blk
</span><a href="#local-6989586621679910453"><span class="hs-identifier hs-var hs-var">mostRecentIntersection'</span></a></span></span><span>
</span><span id="line-1354"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679910454"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910454"><span class="hs-identifier hs-var">ourSuccessor</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1355"></span><span>                </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Maybe (Header blk)
forall block.
HasHeader block =&gt;
Point block -&gt; AnchoredFragment block -&gt; Maybe block
</span><span class="hs-identifier hs-var">AF.successorBlock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910440"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910441"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-1356"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910454"><span class="hs-identifier hs-var">ourSuccessor</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; HeaderHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910436"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1357"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910436"><span class="hs-identifier hs-var">hdr</span></a></span><span>
</span><span id="line-1358"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1359"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910440"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>
</span><span id="line-1360"></span><span>
</span><span id="line-1361"></span><span>    </span><span class="annot"><span class="annottext">KnownIntersectionState blk -&gt; m (KnownIntersectionState blk)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-1362"></span><span>      </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; m (KnownIntersectionState blk))
-&gt; KnownIntersectionState blk -&gt; m (KnownIntersectionState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall blk.
(HasHeader blk, HasHeader (Header blk), HasAnnTip blk,
 ConsensusProtocol (BlockProtocol blk), HasCallStack) =&gt;
ConsensusConfig (BlockProtocol blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#assertKnownIntersectionInvariants"><span class="hs-identifier hs-var">assertKnownIntersectionInvariants</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
forall blk.
TopLevelConfig blk -&gt; ConsensusConfig (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Config.html#configConsensus"><span class="hs-identifier hs-var">configConsensus</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679910446"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1363"></span><span>      </span><span class="annot"><span class="annottext">(KnownIntersectionState blk -&gt; KnownIntersectionState blk)
-&gt; KnownIntersectionState blk -&gt; KnownIntersectionState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1364"></span><span>            </span><span class="annot"><span class="annottext">$sel:mostRecentIntersection:KnownIntersectionState :: Point blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AmostRecentIntersection%3AKnownIntersectionState"><span class="hs-identifier hs-var">mostRecentIntersection</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910453"><span class="hs-identifier hs-var">mostRecentIntersection'</span></a></span><span>
</span><span id="line-1365"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ourFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourFrag"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910441"><span class="hs-identifier hs-var">ourFrag</span></a></span><span>
</span><span id="line-1366"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">theirFrag :: AnchoredFragment (Header blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#theirFrag"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910451"><span class="hs-identifier hs-var">theirFrag'</span></a></span><span>
</span><span id="line-1367"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:theirHeaderStateHistory:KnownIntersectionState :: HeaderStateHistory blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3AtheirHeaderStateHistory%3AKnownIntersectionState"><span class="hs-identifier hs-var">theirHeaderStateHistory</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910445"><span class="hs-identifier hs-var">theirHeaderStateHistory'</span></a></span><span>
</span><span id="line-1368"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1369"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1370"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ConfigEnv"><span class="hs-identifier hs-type">ConfigEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1371"></span><span>        </span><span id="local-6989586621679910446"><span class="annot"><span class="annottext">TopLevelConfig blk
$sel:cfg:ConfigEnv :: forall (m :: * -&gt; *) blk. ConfigEnv m blk -&gt; TopLevelConfig blk
cfg :: TopLevelConfig blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Acfg%3AConfigEnv"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>
</span><span id="line-1372"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConfigEnv m blk
</span><a href="#local-6989586621679910434"><span class="hs-identifier hs-var">cfgEnv</span></a></span><span>
</span><span id="line-1373"></span><span>
</span><span id="line-1374"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InternalEnv"><span class="hs-identifier hs-type">InternalEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1375"></span><span>        </span><span id="local-6989586621679910449"><span class="annot"><span class="annottext">forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
$sel:disconnect:InternalEnv :: forall (m :: * -&gt; *) blk arrival judgment.
InternalEnv m blk arrival judgment
-&gt; forall (m' :: * -&gt; *) a.
   MonadThrow m' =&gt;
   ChainSyncClientException -&gt; m' a
disconnect :: forall (m' :: * -&gt; *) a.
MonadThrow m' =&gt;
ChainSyncClientException -&gt; m' a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#%24sel%3Adisconnect%3AInternalEnv"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span>
</span><span id="line-1376"></span><span>      </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalEnv m blk arrival judgment
</span><a href="#local-6989586621679910435"><span class="hs-identifier hs-var">intEnv</span></a></span><span>
</span><span id="line-1377"></span><span>
</span><span id="line-1378"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Utilities used in the *top functions
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1381"></span><span>
</span><span id="line-1382"></span><span class="hs-keyword">data</span><span> </span><span id="UpdatedIntersectionState"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UpdatedIntersectionState"><span class="hs-identifier hs-var">UpdatedIntersectionState</span></a></span></span><span> </span><span id="local-6989586621679908990"><span class="annot"><a href="#local-6989586621679908990"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679908989"><span class="annot"><a href="#local-6989586621679908989"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1383"></span><span>    </span><span id="NoLongerIntersects"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span></span><span>
</span><span id="line-1384"></span><span>    </span><span class="hs-comment">-- ^ The local selection has changed such that 'ourFrag' no longer</span><span>
</span><span id="line-1385"></span><span>    </span><span class="hs-comment">-- intersects 'theirFrag'</span><span>
</span><span id="line-1386"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1387"></span><span>    </span><span class="hs-comment">-- (In general, the intersection could also be lost because of messages</span><span>
</span><span id="line-1388"></span><span>    </span><span class="hs-comment">-- they sent, but that's handled elsewhere, not involving this data type.)</span><span>
</span><span id="line-1389"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1390"></span><span>    </span><span id="StillIntersects"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StillIntersects"><span class="hs-identifier hs-var">StillIntersects</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679908989"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1391"></span><span>
</span><span id="line-1392"></span><span class="hs-keyword">data</span><span> </span><span id="Intersects"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-var">Intersects</span></a></span></span><span> </span><span id="local-6989586621679909096"><span class="annot"><a href="#local-6989586621679909096"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679909097"><span class="annot"><a href="#local-6989586621679909097"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1393"></span><span>    </span><span id="Intersects"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-var">Intersects</span></a></span></span><span>
</span><span id="line-1394"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#KnownIntersectionState"><span class="hs-identifier hs-type">KnownIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909096"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1395"></span><span>        </span><span class="annot"><a href="#local-6989586621679909097"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1396"></span><span>
</span><span id="line-1397"></span><span id="local-6989586621679909092"><span id="local-6989586621679909093"><span id="local-6989586621679909094"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#castEarlyExitIntersects"><span class="hs-identifier hs-type">castEarlyExitIntersects</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1398"></span><span>     </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909092"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1399"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#WithEarlyExit"><span class="hs-identifier hs-type">WithEarlyExit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909092"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909093"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909094"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1400"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909092"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#UpdatedIntersectionState"><span class="hs-identifier hs-type">UpdatedIntersectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909093"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909094"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1401"></span><span id="castEarlyExitIntersects"><span class="annot"><span class="annottext">castEarlyExitIntersects :: forall (m :: * -&gt; *) blk a.
Monad m =&gt;
WithEarlyExit m (Intersects blk a)
-&gt; m (UpdatedIntersectionState blk a)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#castEarlyExitIntersects"><span class="hs-identifier hs-var hs-var">castEarlyExitIntersects</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1402"></span><span>    </span><span class="annot"><span class="annottext">(Maybe (Intersects blk a) -&gt; UpdatedIntersectionState blk a)
-&gt; m (Maybe (Intersects blk a))
-&gt; m (UpdatedIntersectionState blk a)
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Intersects blk a) -&gt; UpdatedIntersectionState blk a
forall {blk} {a}.
Maybe (Intersects blk a) -&gt; UpdatedIntersectionState blk a
</span><a href="#local-6989586621679910460"><span class="hs-identifier hs-var">cnv</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (Intersects blk a))
 -&gt; m (UpdatedIntersectionState blk a))
-&gt; (WithEarlyExit m (Intersects blk a)
    -&gt; m (Maybe (Intersects blk a)))
-&gt; WithEarlyExit m (Intersects blk a)
-&gt; m (UpdatedIntersectionState blk a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">WithEarlyExit m (Intersects blk a) -&gt; m (Maybe (Intersects blk a))
forall (m :: * -&gt; *) a. WithEarlyExit m a -&gt; m (Maybe a)
</span><a href="Ouroboros.Consensus.Util.EarlyExit.html#withEarlyExit"><span class="hs-identifier hs-var">EarlyExit.withEarlyExit</span></a></span><span>
</span><span id="line-1403"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1404"></span><span>    </span><span id="local-6989586621679910460"><span class="annot"><span class="annottext">cnv :: Maybe (Intersects blk a) -&gt; UpdatedIntersectionState blk a
</span><a href="#local-6989586621679910460"><span class="hs-identifier hs-var hs-var">cnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1405"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Intersects blk a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UpdatedIntersectionState blk a
forall blk a. UpdatedIntersectionState blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoLongerIntersects"><span class="hs-identifier hs-var">NoLongerIntersects</span></a></span><span>
</span><span id="line-1406"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Intersects"><span class="hs-identifier hs-type">Intersects</span></a></span><span> </span><span id="local-6989586621679910462"><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910462"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span id="local-6989586621679910463"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679910463"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; KnownIntersectionState blk -&gt; UpdatedIntersectionState blk a
forall blk a.
a -&gt; KnownIntersectionState blk -&gt; UpdatedIntersectionState blk a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#StillIntersects"><span class="hs-identifier hs-var">StillIntersects</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679910463"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">KnownIntersectionState blk
</span><a href="#local-6989586621679910462"><span class="hs-identifier hs-var">kis</span></a></span><span>
</span><span id="line-1407"></span><span>
</span><span id="line-1408"></span><span class="hs-comment">-- | Recent offsets</span><span>
</span><span id="line-1409"></span><span class="hs-comment">--</span><span>
</span><span id="line-1410"></span><span class="hs-comment">-- These offsets are used to find an intersection point between our chain</span><span>
</span><span id="line-1411"></span><span class="hs-comment">-- and the upstream node's. We use the fibonacci sequence to try blocks</span><span>
</span><span id="line-1412"></span><span class="hs-comment">-- closer to our tip, and fewer blocks further down the chain. It is</span><span>
</span><span id="line-1413"></span><span class="hs-comment">-- important that this sequence constains at least a point @k@ back: if no</span><span>
</span><span id="line-1414"></span><span class="hs-comment">-- intersection can be found at most @k@ back, then this is not a peer</span><span>
</span><span id="line-1415"></span><span class="hs-comment">-- that we can sync with (since we will never roll back more than @k).</span><span>
</span><span id="line-1416"></span><span class="hs-comment">--</span><span>
</span><span id="line-1417"></span><span class="hs-comment">-- For @k = 2160@, this evaluates to</span><span>
</span><span id="line-1418"></span><span class="hs-comment">--</span><span>
</span><span id="line-1419"></span><span class="hs-comment">-- &gt; [0,1,2,3,5,8,13,21,34,55,89,144,233,377,610,987,1597,2160]</span><span>
</span><span id="line-1420"></span><span class="hs-comment">--</span><span>
</span><span id="line-1421"></span><span class="hs-comment">-- For @k = 5@ (during testing), this evaluates to</span><span>
</span><span id="line-1422"></span><span class="hs-comment">--</span><span>
</span><span id="line-1423"></span><span class="hs-comment">-- &gt; [0,1,2,3,5]</span><span>
</span><span id="line-1424"></span><span class="hs-comment">--</span><span>
</span><span id="line-1425"></span><span class="hs-comment">-- In case the fragment contains less than @k@ blocks, we use the length</span><span>
</span><span id="line-1426"></span><span class="hs-comment">-- of the fragment as @k@. This ensures that the oldest rollback point is</span><span>
</span><span id="line-1427"></span><span class="hs-comment">-- selected.</span><span>
</span><span id="line-1428"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#mkOffsets"><span class="hs-identifier hs-type">mkOffsets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1429"></span><span id="mkOffsets"><span class="annot"><span class="annottext">mkOffsets :: SecurityParam -&gt; Word64 -&gt; [Word64]
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#mkOffsets"><span class="hs-identifier hs-var hs-var">mkOffsets</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Config.SecurityParam.html#SecurityParam"><span class="hs-identifier hs-type">SecurityParam</span></a></span><span> </span><span id="local-6989586621679910464"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910464"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910465"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910465"><span class="hs-identifier hs-var">maxOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1430"></span><span>    </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Word64] -&gt; [Word64] -&gt; [Word64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Bool) -&gt; [Word64] -&gt; [Word64]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#takeWhile"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910467"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64 -&gt; Word64
</span><a href="Ouroboros.Consensus.Util.html#fib"><span class="hs-identifier hs-var">fib</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910469"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679910469"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910469"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">2</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Word64] -&gt; [Word64] -&gt; [Word64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910467"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1431"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1432"></span><span>    </span><span id="local-6989586621679910467"><span class="annot"><span class="annottext">l :: Word64
</span><a href="#local-6989586621679910467"><span class="hs-identifier hs-var hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910464"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#min"><span class="hs-operator hs-var">`min`</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679910465"><span class="hs-identifier hs-var">maxOffset</span></a></span><span>
</span><span id="line-1433"></span><span>
</span><span id="line-1434"></span><span id="local-6989586621679909006"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourTipFromChain"><span class="hs-identifier hs-type">ourTipFromChain</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1435"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909006"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1436"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909006"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1437"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679909006"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1438"></span><span id="ourTipFromChain"><span class="annot"><span class="annottext">ourTipFromChain :: forall blk.
HasHeader (Header blk) =&gt;
AnchoredFragment (Header blk) -&gt; Our (Tip blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ourTipFromChain"><span class="hs-identifier hs-var hs-var">ourTipFromChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tip blk -&gt; Our (Tip blk)
forall a. a -&gt; Our a
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-var">Our</span></a></span><span> </span><span class="annot"><span class="annottext">(Tip blk -&gt; Our (Tip blk))
-&gt; (AnchoredFragment (Header blk) -&gt; Tip blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Our (Tip blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Anchor (Header blk) -&gt; Tip blk
forall a b. (HeaderHash a ~ HeaderHash b) =&gt; Anchor a -&gt; Tip b
</span><span class="hs-identifier hs-var">AF.anchorToTip</span></span><span> </span><span class="annot"><span class="annottext">(Anchor (Header blk) -&gt; Tip blk)
-&gt; (AnchoredFragment (Header blk) -&gt; Anchor (Header blk))
-&gt; AnchoredFragment (Header blk)
-&gt; Tip blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Anchor (Header blk)
forall v a b. Anchorable v a b =&gt; AnchoredSeq v a b -&gt; a
</span><span class="hs-identifier hs-var">AF.headAnchor</span></span><span>
</span><span id="line-1439"></span><span>
</span><span id="line-1440"></span><span class="hs-comment">-- | If the two fragments `c1` and `c2` intersect, return the intersection</span><span>
</span><span id="line-1441"></span><span class="hs-comment">-- point and join the prefix of `c1` before the intersection with the suffix of</span><span>
</span><span id="line-1442"></span><span class="hs-comment">-- `c2` after the intersection. The resulting fragment has the same anchor as</span><span>
</span><span id="line-1443"></span><span class="hs-comment">-- `c1` and the same head as `c2`.</span><span>
</span><span id="line-1444"></span><span id="local-6989586621679908991"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#cross"><span class="hs-identifier hs-type">cross</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1445"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679908991"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1446"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679908991"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1447"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679908991"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1448"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679908991"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679908991"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1449"></span><span id="cross"><span class="annot"><span class="annottext">cross :: forall blk.
HasHeader blk =&gt;
AnchoredFragment blk
-&gt; AnchoredFragment blk -&gt; Maybe (Point blk, AnchoredFragment blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#cross"><span class="hs-identifier hs-var hs-var">cross</span></a></span></span><span> </span><span id="local-6989586621679910488"><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910488"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span id="local-6989586621679910489"><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910489"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1450"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679910490"><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910490"><span class="hs-identifier hs-var">p1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910491"><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910491"><span class="hs-identifier hs-var">_p2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910492"><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910492"><span class="hs-identifier hs-var">_s1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910493"><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910493"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
-&gt; AnchoredFragment blk
-&gt; Maybe
     (AnchoredFragment blk, AnchoredFragment blk, AnchoredFragment blk,
      AnchoredFragment blk)
forall block1 block2.
(HasHeader block1, HasHeader block2,
 HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; AnchoredFragment block2
-&gt; Maybe
     (AnchoredFragment block1, AnchoredFragment block2,
      AnchoredFragment block1, AnchoredFragment block2)
</span><span class="hs-identifier hs-var">AF.intersect</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910488"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910489"><span class="hs-identifier hs-var">c2</span></a></span><span>
</span><span id="line-1451"></span><span>    </span><span class="hs-comment">-- Note that the head of `p1` and `_p2` is the intersection point, and</span><span>
</span><span id="line-1452"></span><span>    </span><span class="hs-comment">-- `_s1` and `s2` are anchored in the intersection point.</span><span>
</span><span id="line-1453"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910495"><span class="annot"><span class="annottext">crossed :: AnchoredFragment blk
</span><a href="#local-6989586621679910495"><span class="hs-identifier hs-var hs-var">crossed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
-&gt; AnchoredFragment blk -&gt; Maybe (AnchoredFragment blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block
-&gt; AnchoredFragment block -&gt; Maybe (AnchoredFragment block)
</span><span class="hs-identifier hs-var">AF.join</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910490"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910493"><span class="hs-identifier hs-var">s2</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1454"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679910497"><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910497"><span class="hs-identifier hs-var">c</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910497"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1455"></span><span>            </span><span class="annot"><span class="annottext">Maybe (AnchoredFragment blk)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; AnchoredFragment blk
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invariant violation of AF.intersect&quot;</span></span><span>
</span><span id="line-1456"></span><span>    </span><span class="annot"><span class="annottext">(Point blk, AnchoredFragment blk)
-&gt; Maybe (Point blk, AnchoredFragment blk)
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment blk -&gt; Point blk
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910493"><span class="hs-identifier hs-var">s2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk
</span><a href="#local-6989586621679910495"><span class="hs-identifier hs-var">crossed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1457"></span><span>
</span><span id="line-1458"></span><span class="annot"><span class="hs-comment">-- | A type-legos auxillary function used in 'readLedgerState'.</span></span><span>
</span><span id="line-1459"></span><span id="local-6989586621679909118"><span id="local-6989586621679909119"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#castM"><span class="hs-identifier hs-type">castM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679909118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#WithEarlyExit"><span class="hs-identifier hs-type">WithEarlyExit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909119"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.EarlyExit.html#WithEarlyExit"><span class="hs-identifier hs-type">WithEarlyExit</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909118"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909119"><span class="hs-identifier hs-type">x</span></a></span></span></span><span>
</span><span id="line-1460"></span><span id="castM"><span class="annot"><span class="annottext">castM :: forall (m :: * -&gt; *) x.
Monad m =&gt;
m (WithEarlyExit m x) -&gt; WithEarlyExit m x
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#castM"><span class="hs-identifier hs-var hs-var">castM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithEarlyExit m (WithEarlyExit m x) -&gt; WithEarlyExit m x
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#join"><span class="hs-identifier hs-var">join</span></a></span><span> </span><span class="annot"><span class="annottext">(WithEarlyExit m (WithEarlyExit m x) -&gt; WithEarlyExit m x)
-&gt; (m (WithEarlyExit m x) -&gt; WithEarlyExit m (WithEarlyExit m x))
-&gt; m (WithEarlyExit m x)
-&gt; WithEarlyExit m x
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">m (WithEarlyExit m x) -&gt; WithEarlyExit m (WithEarlyExit m x)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; WithEarlyExit m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">EarlyExit.lift</span></a></span><span>
</span><span id="line-1461"></span><span>
</span><span id="line-1462"></span><span id="local-6989586621679909007"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-type">attemptRollback</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1463"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909007"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1464"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HasAnnTip"><span class="hs-identifier hs-type">HasAnnTip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909007"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1465"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1466"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679909007"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1467"></span><span>  </span><span class="hs-glyph">-&gt;</span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909007"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909007"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1468"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909007"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderStateHistory.html#HeaderStateHistory"><span class="hs-identifier hs-type">HeaderStateHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909007"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1469"></span><span id="attemptRollback"><span class="annot"><span class="annottext">attemptRollback :: forall blk.
(BlockSupportsProtocol blk, HasAnnTip blk) =&gt;
Point blk
-&gt; (AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#attemptRollback"><span class="hs-identifier hs-var hs-var">attemptRollback</span></a></span></span><span> </span><span id="local-6989586621679910513"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910513"><span class="hs-identifier hs-var">rollBackPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910514"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910514"><span class="hs-identifier hs-var">frag</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679910515"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910515"><span class="hs-identifier hs-var">state</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1470"></span><span>    </span><span id="local-6989586621679910516"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910516"><span class="hs-identifier hs-var">frag'</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Point (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Maybe (AnchoredFragment (Header blk))
forall block.
HasHeader block =&gt;
Point block
-&gt; AnchoredFragment block -&gt; Maybe (AnchoredFragment block)
</span><span class="hs-identifier hs-var">AF.rollback</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; Point (Header blk)
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910513"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910514"><span class="hs-identifier hs-var">frag</span></a></span><span>
</span><span id="line-1471"></span><span>    </span><span id="local-6989586621679910518"><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910518"><span class="hs-identifier hs-var">state'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; HeaderStateHistory blk -&gt; Maybe (HeaderStateHistory blk)
forall blk.
HasAnnTip blk =&gt;
Point blk
-&gt; HeaderStateHistory blk -&gt; Maybe (HeaderStateHistory blk)
</span><a href="Ouroboros.Consensus.HeaderStateHistory.html#rewind"><span class="hs-identifier hs-var">HeaderStateHistory.rewind</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910513"><span class="hs-identifier hs-var">rollBackPoint</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910515"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-1472"></span><span>    </span><span class="annot"><span class="annottext">(AnchoredFragment (Header blk), HeaderStateHistory blk)
-&gt; Maybe (AnchoredFragment (Header blk), HeaderStateHistory blk)
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910516"><span class="hs-identifier hs-var">frag'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderStateHistory blk
</span><a href="#local-6989586621679910518"><span class="hs-identifier hs-var">state'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>
</span><span id="line-1474"></span><span class="hs-comment">{-------------------------------------------------------------------------------
   Looking for newly-recognized trap headers on the existing candidate
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1477"></span><span>
</span><span id="line-1478"></span><span class="hs-comment">-- | Watch the invalid block checker function for changes (using its</span><span>
</span><span id="line-1479"></span><span class="hs-comment">-- fingerprint). Whenever it changes, i.e., a new invalid block is detected,</span><span>
</span><span id="line-1480"></span><span class="hs-comment">-- check whether the current candidate fragment contains any header that is</span><span>
</span><span id="line-1481"></span><span class="hs-comment">-- invalid, if so, disconnect by throwing an 'InvalidBlock' exception.</span><span>
</span><span id="line-1482"></span><span class="hs-comment">--</span><span>
</span><span id="line-1483"></span><span class="hs-comment">-- Note that it is possible, yet unlikely, that the candidate fragment</span><span>
</span><span id="line-1484"></span><span class="hs-comment">-- contains a header that corresponds to an invalid block, but before we have</span><span>
</span><span id="line-1485"></span><span class="hs-comment">-- discovered this (after downloading and validating the block), the upstream</span><span>
</span><span id="line-1486"></span><span class="hs-comment">-- node could have rolled back such that its candidate chain no longer</span><span>
</span><span id="line-1487"></span><span class="hs-comment">-- contains the invalid block, in which case we do not disconnect from it.</span><span>
</span><span id="line-1488"></span><span class="hs-comment">--</span><span>
</span><span id="line-1489"></span><span class="hs-comment">-- The cost of this check is \( O(cand * check) \) where /cand/ is the size of</span><span>
</span><span id="line-1490"></span><span class="hs-comment">-- the candidate fragment and /check/ is the cost of checking whether a block</span><span>
</span><span id="line-1491"></span><span class="hs-comment">-- is invalid (typically \( O(\log(invalid)) \) where /invalid/ is the number</span><span>
</span><span id="line-1492"></span><span class="hs-comment">-- of invalid blocks).</span><span>
</span><span id="line-1493"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#invalidBlockRejector"><span class="hs-identifier hs-type">invalidBlockRejector</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1494"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679908716"><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908717"><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1495"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1496"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1497"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-1498"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1499"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-1500"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1501"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Get the invalid block checker</span></span><span>
</span><span id="line-1502"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1503"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Get the candidate</span></span><span>
</span><span id="line-1504"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Watcher"><span class="hs-identifier hs-type">Watcher</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-1505"></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-type">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1506"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a></span><span>
</span><span id="line-1507"></span><span id="invalidBlockRejector"><span class="annot"><span class="annottext">invalidBlockRejector :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
Tracer m (TraceChainSyncClientEvent blk)
-&gt; NodeToNodeVersion
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; Watcher
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
     Fingerprint
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#invalidBlockRejector"><span class="hs-identifier hs-var hs-var">invalidBlockRejector</span></a></span></span><span> </span><span id="local-6989586621679910547"><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679910547"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679910548"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679910548"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679910549"><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621679910549"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span></span><span> </span><span id="local-6989586621679910550"><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679910550"><span class="hs-identifier hs-var">getCandidate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1508"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Watcher"><span class="hs-identifier hs-type">Watcher</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1509"></span><span>        </span><span class="annot"><span class="annottext">wFingerprint :: WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; Fingerprint
</span><a href="Ouroboros.Consensus.Util.STM.html#wFingerprint"><span class="hs-identifier hs-var">wFingerprint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; Fingerprint
forall a. WithFingerprint a -&gt; Fingerprint
</span><a href="Ouroboros.Consensus.Util.STM.html#getFingerprint"><span class="hs-identifier hs-var">getFingerprint</span></a></span><span>
</span><span id="line-1510"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wInitial :: Maybe Fingerprint
</span><a href="Ouroboros.Consensus.Util.STM.html#wInitial"><span class="hs-identifier hs-var">wInitial</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Fingerprint
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1511"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wNotify :: WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m ()
</span><a href="Ouroboros.Consensus.Util.STM.html#wNotify"><span class="hs-identifier hs-var">wNotify</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)) -&gt; m ()
</span><a href="#local-6989586621679910556"><span class="hs-identifier hs-var">checkInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">((HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)) -&gt; m ())
-&gt; (WithFingerprint
      (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
    -&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">WithFingerprint (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))
-&gt; HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
forall a. WithFingerprint a -&gt; a
</span><a href="Ouroboros.Consensus.Util.STM.html#forgetFingerprint"><span class="hs-identifier hs-var">forgetFingerprint</span></a></span><span>
</span><span id="line-1512"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">wReader :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.Util.STM.html#wReader"><span class="hs-identifier hs-var">wReader</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621679910549"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>
</span><span id="line-1513"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-1514"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1515"></span><span>    </span><span class="annot"><a href="#local-6989586621679910556"><span class="hs-identifier hs-type">checkInvalid</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1516"></span><span>    </span><span id="local-6989586621679910556"><span class="annot"><span class="annottext">checkInvalid :: (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)) -&gt; m ()
</span><a href="#local-6989586621679910556"><span class="hs-identifier hs-var hs-var">checkInvalid</span></a></span></span><span> </span><span id="local-6989586621679910558"><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621679910558"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1517"></span><span>        </span><span id="local-6989586621679910559"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910559"><span class="hs-identifier hs-var">theirFrag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
-&gt; m (AnchoredFragment (Header blk))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679910550"><span class="hs-identifier hs-var">getCandidate</span></a></span><span>
</span><span id="line-1518"></span><span>        </span><span class="hs-comment">-- The invalid block is likely to be a more recent block, so check from</span><span>
</span><span id="line-1519"></span><span>        </span><span class="hs-comment">-- newest to oldest.</span><span>
</span><span id="line-1520"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-1521"></span><span>        </span><span class="hs-comment">-- As of block diffusion pipelining, their tip header might be</span><span>
</span><span id="line-1522"></span><span>        </span><span class="hs-comment">-- tentative. Since they do not yet have a way to explicitly say</span><span>
</span><span id="line-1523"></span><span>        </span><span class="hs-comment">-- whether it is tentative, we assume it is and therefore skip their</span><span>
</span><span id="line-1524"></span><span>        </span><span class="hs-comment">-- tip here. TODO once it's explicit, only skip it if it's annotated as</span><span>
</span><span id="line-1525"></span><span>        </span><span class="hs-comment">-- tentative</span><span>
</span><span id="line-1526"></span><span>        </span><span class="annot"><span class="annottext">((Header blk, InvalidBlockReason blk) -&gt; m ())
-&gt; Maybe (Header blk, InvalidBlockReason blk) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Header blk -&gt; InvalidBlockReason blk -&gt; m ())
-&gt; (Header blk, InvalidBlockReason blk) -&gt; m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; InvalidBlockReason blk -&gt; m ()
</span><a href="#local-6989586621679910562"><span class="hs-identifier hs-var">disconnect</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1527"></span><span>          </span><span class="annot"><span class="annottext">(Maybe (Header blk, InvalidBlockReason blk) -&gt; m ())
-&gt; Maybe (Header blk, InvalidBlockReason blk) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; Maybe (Header blk, InvalidBlockReason blk))
-&gt; [Header blk] -&gt; Maybe (Header blk, InvalidBlockReason blk)
forall a b (f :: * -&gt; *).
Foldable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; Maybe b
</span><a href="Ouroboros.Consensus.Util.html#firstJust"><span class="hs-identifier hs-var">firstJust</span></a></span><span>
</span><span id="line-1528"></span><span>                </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679910564"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910564"><span class="hs-identifier hs-var">hdr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910564"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InvalidBlockReason blk -&gt; (Header blk, InvalidBlockReason blk))
-&gt; Maybe (InvalidBlockReason blk)
-&gt; Maybe (Header blk, InvalidBlockReason blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)
</span><a href="#local-6989586621679910558"><span class="hs-identifier hs-var">isInvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910564"><span class="hs-identifier hs-var">hdr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1529"></span><span>          </span><span class="annot"><span class="annottext">([Header blk] -&gt; Maybe (Header blk, InvalidBlockReason blk))
-&gt; [Header blk] -&gt; Maybe (Header blk, InvalidBlockReason blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span>   </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">isPipeliningEnabled</span></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679910548"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1530"></span><span>                    </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">ReceivingTentativeBlocks</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Header blk] -&gt; [Header blk]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#drop"><span class="hs-identifier hs-var">drop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-1531"></span><span>                    </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">NotReceivingTentativeBlocks</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Header blk] -&gt; [Header blk]
forall a. a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span>
</span><span id="line-1532"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-1533"></span><span>          </span><span class="annot"><span class="annottext">([Header blk] -&gt; [Header blk]) -&gt; [Header blk] -&gt; [Header blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; [Header blk]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AF.toNewestFirst</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679910559"><span class="hs-identifier hs-var">theirFrag</span></a></span><span>
</span><span id="line-1534"></span><span>
</span><span id="line-1535"></span><span>    </span><span class="annot"><a href="#local-6989586621679910562"><span class="hs-identifier hs-type">disconnect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908717"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908716"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1536"></span><span>    </span><span id="local-6989586621679910562"><span class="annot"><span class="annottext">disconnect :: Header blk -&gt; InvalidBlockReason blk -&gt; m ()
</span><a href="#local-6989586621679910562"><span class="hs-identifier hs-var hs-var">disconnect</span></a></span></span><span> </span><span id="local-6989586621679910568"><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910568"><span class="hs-identifier hs-var">invalidHeader</span></a></span></span><span> </span><span id="local-6989586621679910569"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679910569"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1537"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679910570"><span class="annot"><span class="annottext">ex :: ChainSyncClientException
</span><a href="#local-6989586621679910570"><span class="hs-identifier hs-var hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1538"></span><span>                </span><span class="annot"><span class="annottext">Point blk
-&gt; HeaderHash blk
-&gt; InvalidBlockReason blk
-&gt; ChainSyncClientException
forall blk.
LedgerSupportsProtocol blk =&gt;
Point blk
-&gt; HeaderHash blk
-&gt; InvalidBlockReason blk
-&gt; ChainSyncClientException
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span><span>
</span><span id="line-1539"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; Point blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerPoint"><span class="hs-identifier hs-var">headerPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910568"><span class="hs-identifier hs-var">invalidHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1540"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Header blk -&gt; HeaderHash blk
forall blk. HasHeader (Header blk) =&gt; Header blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk
</span><a href="#local-6989586621679910568"><span class="hs-identifier hs-var">invalidHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1541"></span><span>                  </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679910569"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-1542"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChainSyncClientEvent blk)
</span><a href="#local-6989586621679910547"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChainSyncClientEvent blk -&gt; m ())
-&gt; TraceChainSyncClientEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
forall blk.
ChainSyncClientException -&gt; TraceChainSyncClientEvent blk
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceException"><span class="hs-identifier hs-var">TraceException</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621679910570"><span class="hs-identifier hs-var">ex</span></a></span><span>
</span><span id="line-1543"></span><span>        </span><span class="annot"><span class="annottext">ChainSyncClientException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><a href="#local-6989586621679910570"><span class="hs-identifier hs-var">ex</span></a></span><span>
</span><span id="line-1544"></span><span>
</span><span id="line-1545"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Explicit state
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1548"></span><span>
</span><span id="line-1549"></span><span class="hs-comment">-- | Make the state maintained by the chain sync client explicit</span><span>
</span><span id="line-1550"></span><span class="hs-comment">--</span><span>
</span><span id="line-1551"></span><span class="hs-comment">-- The chain sync client contains of a bunch of functions that basically look</span><span>
</span><span id="line-1552"></span><span class="hs-comment">-- like &quot;do some network stuff, compute some stuff, and then continue with</span><span>
</span><span id="line-1553"></span><span class="hs-comment">-- such-and-such a new state&quot;. We want to make sure to keep that state in NF</span><span>
</span><span id="line-1554"></span><span class="hs-comment">-- at all times, but since we don't use a TVar to store it, we cannot reuse</span><span>
</span><span id="line-1555"></span><span class="hs-comment">-- the existing infrastructure for checking TVars for NF. Instead, we make</span><span>
</span><span id="line-1556"></span><span class="hs-comment">-- the state explicit in the types and do the check in 'continueWithState'.</span><span>
</span><span id="line-1557"></span><span class="hs-keyword">newtype</span><span> </span><span id="Stateful"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span></span><span> </span><span id="local-6989586621679908963"><span class="annot"><a href="#local-6989586621679908963"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679908965"><span class="annot"><a href="#local-6989586621679908965"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679908962"><span class="annot"><a href="#local-6989586621679908962"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621679908964"><span class="annot"><a href="#local-6989586621679908964"><span class="hs-identifier hs-type">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Stateful"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-var">Stateful</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679908962"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908963"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908964"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908965"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908963"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1558"></span><span>
</span><span id="line-1559"></span><span id="local-6989586621679908941"><span id="local-6989586621679908942"><span id="local-6989586621679908943"><span id="local-6989586621679908944"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-type">continueWithState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1560"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">NoThunks</span></span><span> </span><span class="annot"><a href="#local-6989586621679908941"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-1561"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908941"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-1562"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908942"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908943"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908941"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908944"><span class="hs-identifier hs-type">st</span></a></span><span>
</span><span id="line-1563"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679908942"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Consensus"><span class="hs-identifier hs-type">Consensus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908944"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908943"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908942"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1564"></span><span id="continueWithState"><span class="annot"><span class="annottext">continueWithState :: forall s (m :: * -&gt; *) blk
       (st :: * -&gt; * -&gt; * -&gt; (* -&gt; *) -&gt; * -&gt; *).
NoThunks s =&gt;
s -&gt; Stateful m blk s st -&gt; m (Consensus st blk m)
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#continueWithState"><span class="hs-identifier hs-var hs-var">continueWithState</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679910578"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679910578"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Stateful"><span class="hs-identifier hs-type">Stateful</span></a></span><span> </span><span id="local-6989586621679910579"><span class="annot"><span class="annottext">s -&gt; m (Consensus st blk m)
</span><a href="#local-6989586621679910579"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1565"></span><span>    </span><span class="annot"><span class="annottext">Maybe String -&gt; m (Consensus st blk m) -&gt; m (Consensus st blk m)
forall a. HasCallStack =&gt; Maybe String -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">checkInvariant</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThunkInfo -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(ThunkInfo -&gt; String) -&gt; Maybe ThunkInfo -&gt; Maybe String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; Maybe ThunkInfo
forall a. NoThunks a =&gt; a -&gt; Maybe ThunkInfo
</span><span class="hs-identifier hs-var">unsafeNoThunks</span></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679910578"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (Consensus st blk m) -&gt; m (Consensus st blk m))
-&gt; m (Consensus st blk m) -&gt; m (Consensus st blk m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; m (Consensus st blk m)
</span><a href="#local-6989586621679910579"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621679910578"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1566"></span><span>
</span><span id="line-1567"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Return value
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1570"></span><span>
</span><span id="line-1571"></span><span class="hs-comment">-- | The Chain sync client only _gracefully_ terminates when the upstream</span><span>
</span><span id="line-1572"></span><span class="hs-comment">-- node's chain is not interesting (e.g., forked off too far in the past). By</span><span>
</span><span id="line-1573"></span><span class="hs-comment">-- gracefully terminating, the network layer can keep the other mini-protocols</span><span>
</span><span id="line-1574"></span><span class="hs-comment">-- connect to the same upstream node running.</span><span>
</span><span id="line-1575"></span><span class="hs-comment">--</span><span>
</span><span id="line-1576"></span><span class="hs-comment">-- For example, a relay node will often receive connections from nodes syncing</span><span>
</span><span id="line-1577"></span><span class="hs-comment">-- from scratch or an old chain. Since these nodes have a chain that is shorter</span><span>
</span><span id="line-1578"></span><span class="hs-comment">-- than the relay node's chain, it's useless for the relay node to run the</span><span>
</span><span id="line-1579"></span><span class="hs-comment">-- client-side of the chain sync protocol. However, the other direction of the</span><span>
</span><span id="line-1580"></span><span class="hs-comment">-- protocol, and, e.g., the transaction submission protocol, should keep</span><span>
</span><span id="line-1581"></span><span class="hs-comment">-- running.</span><span>
</span><span id="line-1582"></span><span class="hs-keyword">data</span><span> </span><span id="ChainSyncClientResult"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-var">ChainSyncClientResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1583"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679910581"><span class="annot"><a href="#local-6989586621679910581"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910581"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1584"></span><span>    </span><span id="ForkTooDeep"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-var">ForkTooDeep</span></a></span></span><span>
</span><span id="line-1585"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910581"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Intersection</span></span><span>
</span><span id="line-1586"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910581"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1587"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910581"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1588"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The server we're connecting to forked more than @k@ blocks ago.</span></span><span>
</span><span id="line-1589"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1590"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679910582"><span class="annot"><a href="#local-6989586621679910582"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910582"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1591"></span><span>    </span><span id="NoMoreIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-var">NoMoreIntersection</span></a></span></span><span>
</span><span id="line-1592"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910582"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1593"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910582"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1594"></span><span>    </span><span class="hs-comment">-- ^ Our chain changed such that it no longer intersects with the</span><span>
</span><span id="line-1595"></span><span>    </span><span class="hs-comment">-- candidate's fragment, and asking for a new intersection did not yield</span><span>
</span><span id="line-1596"></span><span>    </span><span class="hs-comment">-- one.</span><span>
</span><span id="line-1597"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1598"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679910583"><span class="annot"><a href="#local-6989586621679910583"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910583"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1599"></span><span>    </span><span id="RolledBackPastIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-var">RolledBackPastIntersection</span></a></span></span><span>
</span><span id="line-1600"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910583"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Point asked to roll back to</span></span><span>
</span><span id="line-1601"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910583"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1602"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910583"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1603"></span><span>    </span><span class="hs-comment">-- ^ We were asked to roll back past the anchor point of the candidate's</span><span>
</span><span id="line-1604"></span><span>    </span><span class="hs-comment">-- fragment. This means the candidate chain no longer forks off within @k@,</span><span>
</span><span id="line-1605"></span><span>    </span><span class="hs-comment">-- making it impossible to switch to.</span><span>
</span><span id="line-1606"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1607"></span><span>    </span><span id="AskedToTerminate"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span></span><span>
</span><span id="line-1608"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ We were asked to terminate via the 'ControlMessageSTM'</span></span><span>
</span><span id="line-1609"></span><span>
</span><span id="line-1610"></span><span id="local-6989586621679910585"><span id="local-6989586621679910587"><span id="local-6989586621679910591"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span></span></span></span><span>
</span><span id="line-1611"></span><span>
</span><span id="line-1612"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679910595"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1613"></span><span>    </span><span id="local-6989586621679910598"><span class="annot"><span class="annottext">== :: ChainSyncClientResult -&gt; ChainSyncClientResult -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">(==)</span></a></span></span><span>
</span><span id="line-1614"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-type">ForkTooDeep</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910604"><span id="local-6989586621679910605"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910605"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910604"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679910606"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910606"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span id="local-6989586621679910607"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910607"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1615"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-type">ForkTooDeep</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910614"><span id="local-6989586621679910615"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910615"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910614"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910616"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910616"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621679910617"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910617"><span class="hs-identifier hs-var">c'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1616"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Type.Equality.html#Refl"><span class="hs-identifier hs-var">Refl</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
forall a b. (Typeable a, Typeable b) =&gt; Maybe (a :~: b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#eqT"><span class="hs-identifier hs-var">eqT</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910604"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910614"><span class="hs-identifier hs-type">blk'</span></a></span><span>
</span><span id="line-1617"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910605"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910606"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910607"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621679910615"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621679910616"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621679910617"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1618"></span><span>
</span><span id="line-1619"></span><span>    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span>
</span><span id="line-1620"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-type">NoMoreIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910633"><span id="local-6989586621679910634"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910634"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910633"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">)</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910635"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910635"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1621"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-type">NoMoreIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910642"><span id="local-6989586621679910643"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910643"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910642"><span class="hs-identifier hs-type">blk'</span></a></span><span class="hs-special">)</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910644"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910644"><span class="hs-identifier hs-var">b'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1622"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Type.Equality.html#Refl"><span class="hs-identifier hs-var">Refl</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
forall a b. (Typeable a, Typeable b) =&gt; Maybe (a :~: b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#eqT"><span class="hs-identifier hs-var">eqT</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910633"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910642"><span class="hs-identifier hs-type">blk'</span></a></span><span>
</span><span id="line-1623"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910634"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910635"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Our (Tip blk), Their (Tip blk))
-&gt; (Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621679910643"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621679910644"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1624"></span><span>
</span><span id="line-1625"></span><span>    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span>
</span><span id="line-1626"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-type">RolledBackPastIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910656"><span id="local-6989586621679910657"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910657"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910656"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910658"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910658"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span id="local-6989586621679910659"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910659"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1627"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-type">RolledBackPastIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910666"><span id="local-6989586621679910667"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910667"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910666"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910668"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910668"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621679910669"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910669"><span class="hs-identifier hs-var">c'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1628"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Type.Equality.html#Refl"><span class="hs-identifier hs-var">Refl</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
forall a b. (Typeable a, Typeable b) =&gt; Maybe (a :~: b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#eqT"><span class="hs-identifier hs-var">eqT</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910656"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910666"><span class="hs-identifier hs-type">blk'</span></a></span><span>
</span><span id="line-1629"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910657"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910658"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910659"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621679910667"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621679910668"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621679910669"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1630"></span><span>
</span><span id="line-1631"></span><span>    </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-1632"></span><span>
</span><span id="line-1633"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ForkTooDeep"><span class="hs-identifier hs-type">ForkTooDeep</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1634"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#NoMoreIntersection"><span class="hs-identifier hs-type">NoMoreIntersection</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1635"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#RolledBackPastIntersection"><span class="hs-identifier hs-type">RolledBackPastIntersection</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1636"></span><span>    </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#AskedToTerminate"><span class="hs-identifier hs-var">AskedToTerminate</span></a></span><span>             </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientResult
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1637"></span><span>
</span><span id="line-1638"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Exception
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1641"></span><span>
</span><span id="line-1642"></span><span class="hs-comment">-- | When the upstream node violates the protocol or exhibits malicious</span><span>
</span><span id="line-1643"></span><span class="hs-comment">-- behaviour, e.g., serving an invalid header or a header corresponding to a</span><span>
</span><span id="line-1644"></span><span class="hs-comment">-- known invalid block, we throw an exception to disconnect. This will bring</span><span>
</span><span id="line-1645"></span><span class="hs-comment">-- down all miniprotocols in both directions with that node.</span><span>
</span><span id="line-1646"></span><span class="hs-keyword">data</span><span> </span><span id="ChainSyncClientException"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-var">ChainSyncClientException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1647"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679910679"><span class="annot"><a href="#local-6989586621679910679"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910679"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#ValidateEnvelope"><span class="hs-identifier hs-type">ValidateEnvelope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910679"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1648"></span><span>    </span><span id="HeaderError"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-var">HeaderError</span></a></span></span><span>
</span><span id="line-1649"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910679"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Invalid header</span></span><span>
</span><span id="line-1650"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910679"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1651"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910679"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1652"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910679"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1653"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Header validation threw an error.</span></span><span>
</span><span id="line-1654"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1655"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679910680"><span class="annot"><a href="#local-6989586621679910680"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910680"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1656"></span><span>    </span><span id="InvalidIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-var">InvalidIntersection</span></a></span></span><span>
</span><span id="line-1657"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910680"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Intersection</span></span><span>
</span><span id="line-1658"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910680"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1659"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679910680"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1660"></span><span>    </span><span class="hs-comment">-- ^ We send the upstream node a bunch of points from a chain fragment and</span><span>
</span><span id="line-1661"></span><span>    </span><span class="hs-comment">-- the upstream node responded with an intersection point that is not on</span><span>
</span><span id="line-1662"></span><span>    </span><span class="hs-comment">-- our chain fragment, and thus not among the points we sent.</span><span>
</span><span id="line-1663"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1664"></span><span>    </span><span class="hs-comment">-- We store the intersection point the upstream node sent us.</span><span>
</span><span id="line-1665"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1666"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679910681"><span class="annot"><a href="#local-6989586621679910681"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910681"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1667"></span><span>    </span><span id="InvalidBlock"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-var">InvalidBlock</span></a></span></span><span>
</span><span id="line-1668"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910681"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1669"></span><span>        </span><span class="annot"><span class="hs-comment">-- ^ Block that triggered the validity check.</span></span><span>
</span><span id="line-1670"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679910681"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1671"></span><span>        </span><span class="hs-comment">-- ^ Invalid block. If pipelining was negotiated, this can be</span><span>
</span><span id="line-1672"></span><span>        </span><span class="hs-comment">-- different from the previous argument.</span><span>
</span><span id="line-1673"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#InvalidBlockReason"><span class="hs-identifier hs-type">InvalidBlockReason</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679910681"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1674"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The upstream node's chain contained a block that we know is invalid.</span></span><span>
</span><span id="line-1675"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1676"></span><span>    </span><span id="InFutureHeaderExceedsClockSkew"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InFutureHeaderExceedsClockSkew"><span class="hs-identifier hs-var">InFutureHeaderExceedsClockSkew</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.InFutureCheck.html#HeaderArrivalException"><span class="hs-identifier hs-type">InFutureCheck.HeaderArrivalException</span></a></span><span>
</span><span id="line-1677"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ A header arrived from the far future.</span></span><span>
</span><span id="line-1678"></span><span>
</span><span id="line-1679"></span><span id="local-6989586621679910683"><span id="local-6989586621679910687"><span id="local-6989586621679910691"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span></span></span></span><span>
</span><span id="line-1680"></span><span>
</span><span id="line-1681"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679910695"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1682"></span><span>    </span><span id="local-6989586621679910700"><span class="annot"><span class="annottext">== :: ChainSyncClientException -&gt; ChainSyncClientException -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">(==)</span></a></span></span><span>
</span><span id="line-1683"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910707"><span id="local-6989586621679910708"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910708"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910707"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910709"><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621679910709"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span id="local-6989586621679910710"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910710"><span class="hs-identifier hs-var">c</span></a></span></span><span>  </span><span id="local-6989586621679910711"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910711"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1684"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910719"><span id="local-6989586621679910720"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910720"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910719"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910721"><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621679910721"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621679910722"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910722"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span id="local-6989586621679910723"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910723"><span class="hs-identifier hs-var">d'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1685"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Type.Equality.html#Refl"><span class="hs-identifier hs-var">Refl</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
forall a b. (Typeable a, Typeable b) =&gt; Maybe (a :~: b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#eqT"><span class="hs-identifier hs-var">eqT</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910707"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910719"><span class="hs-identifier hs-type">blk'</span></a></span><span>
</span><span id="line-1686"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910708"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderError blk
</span><a href="#local-6989586621679910709"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910710"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910711"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, HeaderError blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, HeaderError blk, Our (Tip blk), Their (Tip blk))
-&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621679910720"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderError blk
HeaderError blk
</span><a href="#local-6989586621679910721"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621679910722"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621679910723"><span class="hs-identifier hs-var">d'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1687"></span><span>
</span><span id="line-1688"></span><span>    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span>
</span><span id="line-1689"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-type">InvalidIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910738"><span id="local-6989586621679910739"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910739"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910738"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910740"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910740"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span id="local-6989586621679910741"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910741"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1690"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-type">InvalidIntersection</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910748"><span id="local-6989586621679910749"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910749"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910748"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910750"><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910750"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621679910751"><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910751"><span class="hs-identifier hs-var">c'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1691"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Type.Equality.html#Refl"><span class="hs-identifier hs-var">Refl</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
forall a b. (Typeable a, Typeable b) =&gt; Maybe (a :~: b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#eqT"><span class="hs-identifier hs-var">eqT</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910738"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910748"><span class="hs-identifier hs-type">blk'</span></a></span><span>
</span><span id="line-1692"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910739"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
</span><a href="#local-6989586621679910740"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
</span><a href="#local-6989586621679910741"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, Our (Tip blk), Their (Tip blk))
-&gt; (Point blk, Our (Tip blk), Their (Tip blk)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621679910749"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Our (Tip blk)
Our (Tip blk)
</span><a href="#local-6989586621679910750"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Their (Tip blk)
Their (Tip blk)
</span><a href="#local-6989586621679910751"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1693"></span><span>
</span><span id="line-1694"></span><span>    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span>
</span><span id="line-1695"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-type">InvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910769"><span id="local-6989586621679910770"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910770"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910769"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679910771"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679910771"><span class="hs-identifier hs-var">b</span></a></span></span><span>  </span><span id="local-6989586621679910772"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679910772"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1696"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-type">InvalidBlock</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679910780"><span id="local-6989586621679910781"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910781"><span class="hs-identifier hs-var">a'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679910780"><span class="hs-identifier hs-type">blk'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679910782"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679910782"><span class="hs-identifier hs-var">b'</span></a></span></span><span> </span><span id="local-6989586621679910783"><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679910783"><span class="hs-identifier hs-var">c'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1697"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">blk :~: blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Type.Equality.html#Refl"><span class="hs-identifier hs-var">Refl</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall {k} (a :: k) (b :: k).
(Typeable a, Typeable b) =&gt;
Maybe (a :~: b)
forall a b. (Typeable a, Typeable b) =&gt; Maybe (a :~: b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html#eqT"><span class="hs-identifier hs-var">eqT</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910769"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679910780"><span class="hs-identifier hs-type">blk'</span></a></span><span>
</span><span id="line-1698"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679910770"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679910771"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
</span><a href="#local-6989586621679910772"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Point blk, HeaderHash blk, InvalidBlockReason blk)
-&gt; (Point blk, HeaderHash blk, InvalidBlockReason blk) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk
Point blk
</span><a href="#local-6989586621679910781"><span class="hs-identifier hs-var">a'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
HeaderHash blk
</span><a href="#local-6989586621679910782"><span class="hs-identifier hs-var">b'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InvalidBlockReason blk
InvalidBlockReason blk
</span><a href="#local-6989586621679910783"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1699"></span><span>
</span><span id="line-1700"></span><span>    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span>
</span><span id="line-1701"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InFutureHeaderExceedsClockSkew"><span class="hs-identifier hs-type">InFutureHeaderExceedsClockSkew</span></a></span><span> </span><span id="local-6989586621679910789"><span class="annot"><span class="annottext">HeaderArrivalException
</span><a href="#local-6989586621679910789"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1702"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InFutureHeaderExceedsClockSkew"><span class="hs-identifier hs-type">InFutureHeaderExceedsClockSkew</span></a></span><span> </span><span id="local-6989586621679910790"><span class="annot"><span class="annottext">HeaderArrivalException
</span><a href="#local-6989586621679910790"><span class="hs-identifier hs-var">a'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1703"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderArrivalException
</span><a href="#local-6989586621679910789"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderArrivalException -&gt; HeaderArrivalException -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderArrivalException
</span><a href="#local-6989586621679910790"><span class="hs-identifier hs-var">a'</span></a></span><span>
</span><span id="line-1704"></span><span>
</span><span id="line-1705"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#HeaderError"><span class="hs-identifier hs-type">HeaderError</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1706"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidIntersection"><span class="hs-identifier hs-type">InvalidIntersection</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1707"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InvalidBlock"><span class="hs-identifier hs-type">InvalidBlock</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span>                   </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1708"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#InFutureHeaderExceedsClockSkew"><span class="hs-identifier hs-type">InFutureHeaderExceedsClockSkew</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncClientException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-1709"></span><span>
</span><span id="line-1710"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679910800"><span id="local-6989586621679910803"><span id="local-6989586621679910806"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span></span></span></span><span>
</span><span id="line-1711"></span><span>
</span><span id="line-1712"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Trace events
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-1715"></span><span>
</span><span id="line-1716"></span><span class="annot"><span class="hs-comment">-- | Events traced by the Chain Sync Client.</span></span><span>
</span><span id="line-1717"></span><span class="hs-keyword">data</span><span> </span><span id="TraceChainSyncClientEvent"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-var">TraceChainSyncClientEvent</span></a></span></span><span> </span><span id="local-6989586621679908972"><span class="annot"><a href="#local-6989586621679908972"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1718"></span><span>    </span><span id="TraceDownloadedHeader"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceDownloadedHeader"><span class="hs-identifier hs-var">TraceDownloadedHeader</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679908972"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1719"></span><span>    </span><span class="hs-comment">-- ^ While following a candidate chain, we rolled forward by downloading a</span><span>
</span><span id="line-1720"></span><span>    </span><span class="hs-comment">-- header.</span><span>
</span><span id="line-1721"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1722"></span><span>    </span><span id="TraceRolledBack"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceRolledBack"><span class="hs-identifier hs-var">TraceRolledBack</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679908972"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1723"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ While following a candidate chain, we rolled back to the given point.</span></span><span>
</span><span id="line-1724"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1725"></span><span>    </span><span id="TraceFoundIntersection"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceFoundIntersection"><span class="hs-identifier hs-var">TraceFoundIntersection</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679908972"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Our"><span class="hs-identifier hs-type">Our</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679908972"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#Their"><span class="hs-identifier hs-type">Their</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tip</span></span><span> </span><span class="annot"><a href="#local-6989586621679908972"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1726"></span><span>    </span><span class="hs-comment">-- ^ We found an intersection between our chain fragment and the</span><span>
</span><span id="line-1727"></span><span>    </span><span class="hs-comment">-- candidate's chain.</span><span>
</span><span id="line-1728"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1729"></span><span>    </span><span id="TraceException"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceException"><span class="hs-identifier hs-var">TraceException</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientException"><span class="hs-identifier hs-type">ChainSyncClientException</span></a></span><span>
</span><span id="line-1730"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ An exception was thrown by the Chain Sync Client.</span></span><span>
</span><span id="line-1731"></span><span>  </span><span class="hs-glyph">|</span><span>
</span><span id="line-1732"></span><span>    </span><span id="TraceTermination"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceTermination"><span class="hs-identifier hs-var">TraceTermination</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#ChainSyncClientResult"><span class="hs-identifier hs-type">ChainSyncClientResult</span></a></span><span>
</span><span id="line-1733"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The client has terminated.</span></span><span>
</span><span id="line-1734"></span><span>
</span><span id="line-1735"></span><span id="local-6989586621679909235"><span id="local-6989586621679910812"><span id="local-6989586621679910823"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-1736"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909235"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1737"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909235"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1738"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-1739"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909235"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1740"></span><span>
</span><span id="line-1741"></span><span id="local-6989586621679909239"><span id="local-6989586621679910831"><span id="local-6989586621679910847"><span id="local-6989586621679910851"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span>
</span><span id="line-1742"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909239"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-1743"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909239"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1744"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-1745"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.ChainSync.Client.html#TraceChainSyncClientEvent"><span class="hs-identifier hs-type">TraceChainSyncClientEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679909239"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1746"></span></pre></body></html>
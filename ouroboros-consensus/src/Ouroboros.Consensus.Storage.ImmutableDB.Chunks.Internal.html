<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass             #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric              #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies         #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards            #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications           #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier">ChunkInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkInfoSupportsEBBs"><span class="hs-identifier">chunkInfoSupportsEBBs</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#simpleChunkInfo"><span class="hs-identifier">simpleChunkInfo</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#singleChunkInfo"><span class="hs-identifier">singleChunkInfo</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Chunk number</span></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier">ChunkNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoFromInt"><span class="hs-identifier">chunkNoFromInt</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoToInt"><span class="hs-identifier">chunkNoToInt</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunksBetween"><span class="hs-identifier">chunksBetween</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#countChunks"><span class="hs-identifier">countChunks</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier">firstChunkNo</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier">nextChunkNo</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#prevChunkNo"><span class="hs-identifier">prevChunkNo</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeChunkNoToEpochNo"><span class="hs-identifier">unsafeChunkNoToEpochNo</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeEpochNoToChunkNo"><span class="hs-identifier">unsafeEpochNoToChunkNo</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Chunk size</span></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier">ChunkSize</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#getChunkSize"><span class="hs-identifier">getChunkSize</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Layout</span></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier">RelativeSlot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertRelativeSlotInChunk"><span class="hs-identifier">assertRelativeSlotInChunk</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#compareRelativeSlot"><span class="hs-identifier">compareRelativeSlot</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#maxRelativeIndex"><span class="hs-identifier">maxRelativeIndex</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#mkRelativeSlot"><span class="hs-identifier">mkRelativeSlot</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Assertions</span></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkAssertionFailure"><span class="hs-identifier">ChunkAssertionFailure</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertChunkCanContainEBB"><span class="hs-identifier">assertChunkCanContainEBB</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier">assertSameChunk</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertWithinBounds"><span class="hs-identifier">assertWithinBounds</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">NoThunks.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NoThunks</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.CallStack.html"><span class="hs-identifier">Ouroboros.Consensus.Util.CallStack</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.RedundantConstraints.html"><span class="hs-identifier">Ouroboros.Consensus.Util.RedundantConstraints</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- | Size of the chunks of the immutable DB</span><span>
</span><span id="line-51"></span><span class="hs-comment">--</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- This is the key data structure that drives all layout functions.</span><span>
</span><span id="line-53"></span><span class="hs-comment">--</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- TODO: Add support for non-uniform 'ChunkInfo'</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- &lt;https://github.com/IntersectMBO/ouroboros-network/issues/1754&gt;</span><span>
</span><span id="line-56"></span><span class="hs-keyword">data</span><span> </span><span id="ChunkInfo"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-var">ChunkInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- | A single, uniform, chunk size</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-comment">-- If EBBs are present, the chunk size must line up precisely with the</span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-comment">-- epoch size (that is, the number of regular blocks in the chunk must equal</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-comment">-- the number of regular blocks in an epoch).</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-63"></span><span>    </span><span id="UniformChunkSize"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-var">UniformChunkSize</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679843400"><span id="local-6989586621679843406"><span id="local-6989586621679843410"><span class="annot"><span class="annottext">Int -&gt; ChunkInfo -&gt; ShowS
[ChunkInfo] -&gt; ShowS
ChunkInfo -&gt; String
(Int -&gt; ChunkInfo -&gt; ShowS)
-&gt; (ChunkInfo -&gt; String)
-&gt; ([ChunkInfo] -&gt; ShowS)
-&gt; Show ChunkInfo
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ChunkInfo -&gt; ShowS
showsPrec :: Int -&gt; ChunkInfo -&gt; ShowS
$cshow :: ChunkInfo -&gt; String
show :: ChunkInfo -&gt; String
$cshowList :: [ChunkInfo] -&gt; ShowS
showList :: [ChunkInfo] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679843414"><span id="local-6989586621679843416"><span class="annot"><span class="annottext">(forall x. ChunkInfo -&gt; Rep ChunkInfo x)
-&gt; (forall x. Rep ChunkInfo x -&gt; ChunkInfo) -&gt; Generic ChunkInfo
forall x. Rep ChunkInfo x -&gt; ChunkInfo
forall x. ChunkInfo -&gt; Rep ChunkInfo x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. ChunkInfo -&gt; Rep ChunkInfo x
from :: forall x. ChunkInfo -&gt; Rep ChunkInfo x
$cto :: forall x. Rep ChunkInfo x -&gt; ChunkInfo
to :: forall x. Rep ChunkInfo x -&gt; ChunkInfo
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679843420"><span id="local-6989586621679843424"><span id="local-6989586621679843430"><span class="annot"><span class="annottext">Context -&gt; ChunkInfo -&gt; IO (Maybe ThunkInfo)
Proxy ChunkInfo -&gt; String
(Context -&gt; ChunkInfo -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; ChunkInfo -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy ChunkInfo -&gt; String)
-&gt; NoThunks ChunkInfo
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; ChunkInfo -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; ChunkInfo -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; ChunkInfo -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; ChunkInfo -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy ChunkInfo -&gt; String
showTypeOf :: Proxy ChunkInfo -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">-- | Simple chunk config with a single chunk size</span><span>
</span><span id="line-68"></span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- This intentionally takes 'EpochSize' (number of slots) rather than</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- 'ChunkSize': the translation from 'EpochSize' to 'ChunkSize' (number of</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- available entries in a chunk) should not be done by client code.</span><span>
</span><span id="line-72"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#simpleChunkInfo"><span class="hs-identifier hs-type">simpleChunkInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochSize</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-73"></span><span id="simpleChunkInfo"><span class="annot"><span class="annottext">simpleChunkInfo :: EpochSize -&gt; ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#simpleChunkInfo"><span class="hs-identifier hs-var hs-var">simpleChunkInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">EpochSize</span></span><span> </span><span id="local-6989586621679843455"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843455"><span class="hs-identifier hs-var">sz</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkSize -&gt; ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-var">UniformChunkSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Word64 -&gt; ChunkSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-var">ChunkSize</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843455"><span class="hs-identifier hs-var">sz</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">-- | 'ChunkInfo' for a single 'ChunkSize'</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- See also 'simpleChunkInfo'.</span><span>
</span><span id="line-78"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#singleChunkInfo"><span class="hs-identifier hs-type">singleChunkInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-79"></span><span id="singleChunkInfo"><span class="annot"><span class="annottext">singleChunkInfo :: ChunkSize -&gt; ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#singleChunkInfo"><span class="hs-identifier hs-var hs-var">singleChunkInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkSize -&gt; ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-var">UniformChunkSize</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-comment">-- | Can we store EBBs in the chunks described by this 'ChunkInfo'?</span><span>
</span><span id="line-82"></span><span class="hs-comment">--</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- This is only used for tests. This API will need to change (and the tests will</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- become more complicated) once we support non-uniform 'ChunkInfo'.</span><span>
</span><span id="line-85"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkInfoSupportsEBBs"><span class="hs-identifier hs-type">chunkInfoSupportsEBBs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-86"></span><span id="chunkInfoSupportsEBBs"><span class="annot"><span class="annottext">chunkInfoSupportsEBBs :: ChunkInfo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkInfoSupportsEBBs"><span class="hs-identifier hs-var hs-var">chunkInfoSupportsEBBs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-type">UniformChunkSize</span></a></span><span> </span><span id="local-6989586621679843456"><span class="annot"><span class="annottext">ChunkSize
</span><a href="#local-6989586621679843456"><span class="hs-identifier hs-var">chunkSize</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="annottext">ChunkSize -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkCanContainEBB"><span class="hs-identifier hs-var">chunkCanContainEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSize
</span><a href="#local-6989586621679843456"><span class="hs-identifier hs-var">chunkSize</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Queries
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">-- | Size of a chunk</span><span>
</span><span id="line-94"></span><span class="hs-comment">--</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- The total number of slots available in a chunk is equal to 'numRegularBlocks'</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- if @not@ 'chunkCanContainEBB', and 'numRegularBlocks' @+ 1@ otherwise.</span><span>
</span><span id="line-97"></span><span class="hs-keyword">data</span><span> </span><span id="ChunkSize"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-var">ChunkSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ChunkSize"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-var">ChunkSize</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-98"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Does this chunk also accomodate an EBB?</span></span><span>
</span><span id="line-99"></span><span>      </span><span id="chunkCanContainEBB"><span class="annot"><span class="annottext">ChunkSize -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkCanContainEBB"><span class="hs-identifier hs-var hs-var">chunkCanContainEBB</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><span class="hs-comment">-- | The number of regular blocks in this chunk</span></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="numRegularBlocks"><span class="annot"><span class="annottext">ChunkSize -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#numRegularBlocks"><span class="hs-identifier hs-var hs-var">numRegularBlocks</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679843460"><span id="local-6989586621679843467"><span id="local-6989586621679843470"><span class="annot"><span class="annottext">Int -&gt; ChunkSize -&gt; ShowS
[ChunkSize] -&gt; ShowS
ChunkSize -&gt; String
(Int -&gt; ChunkSize -&gt; ShowS)
-&gt; (ChunkSize -&gt; String)
-&gt; ([ChunkSize] -&gt; ShowS)
-&gt; Show ChunkSize
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ChunkSize -&gt; ShowS
showsPrec :: Int -&gt; ChunkSize -&gt; ShowS
$cshow :: ChunkSize -&gt; String
show :: ChunkSize -&gt; String
$cshowList :: [ChunkSize] -&gt; ShowS
showList :: [ChunkSize] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679843473"><span id="local-6989586621679843475"><span class="annot"><span class="annottext">(forall x. ChunkSize -&gt; Rep ChunkSize x)
-&gt; (forall x. Rep ChunkSize x -&gt; ChunkSize) -&gt; Generic ChunkSize
forall x. Rep ChunkSize x -&gt; ChunkSize
forall x. ChunkSize -&gt; Rep ChunkSize x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. ChunkSize -&gt; Rep ChunkSize x
from :: forall x. ChunkSize -&gt; Rep ChunkSize x
$cto :: forall x. Rep ChunkSize x -&gt; ChunkSize
to :: forall x. Rep ChunkSize x -&gt; ChunkSize
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679843478"><span id="local-6989586621679843481"><span id="local-6989586621679843487"><span class="annot"><span class="annottext">Context -&gt; ChunkSize -&gt; IO (Maybe ThunkInfo)
Proxy ChunkSize -&gt; String
(Context -&gt; ChunkSize -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; ChunkSize -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy ChunkSize -&gt; String)
-&gt; NoThunks ChunkSize
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; ChunkSize -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; ChunkSize -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; ChunkSize -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; ChunkSize -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy ChunkSize -&gt; String
showTypeOf :: Proxy ChunkSize -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><span class="hs-comment">-- | Chunk number</span></span><span>
</span><span id="line-108"></span><span class="hs-keyword">newtype</span><span> </span><span id="ChunkNo"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ChunkNo"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="unChunkNo"><span class="annot"><span class="annottext">ChunkNo -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unChunkNo"><span class="hs-identifier hs-var hs-var">unChunkNo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679843519"><span id="local-6989586621679843523"><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
(ChunkNo -&gt; ChunkNo -&gt; Bool)
-&gt; (ChunkNo -&gt; ChunkNo -&gt; Bool) -&gt; Eq ChunkNo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: ChunkNo -&gt; ChunkNo -&gt; Bool
== :: ChunkNo -&gt; ChunkNo -&gt; Bool
$c/= :: ChunkNo -&gt; ChunkNo -&gt; Bool
/= :: ChunkNo -&gt; ChunkNo -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679843530"><span id="local-6989586621679843533"><span id="local-6989586621679843536"><span id="local-6989586621679843540"><span id="local-6989586621679843543"><span id="local-6989586621679843546"><span id="local-6989586621679843549"><span class="annot"><span class="annottext">Eq ChunkNo
Eq ChunkNo =&gt;
(ChunkNo -&gt; ChunkNo -&gt; Ordering)
-&gt; (ChunkNo -&gt; ChunkNo -&gt; Bool)
-&gt; (ChunkNo -&gt; ChunkNo -&gt; Bool)
-&gt; (ChunkNo -&gt; ChunkNo -&gt; Bool)
-&gt; (ChunkNo -&gt; ChunkNo -&gt; Bool)
-&gt; (ChunkNo -&gt; ChunkNo -&gt; ChunkNo)
-&gt; (ChunkNo -&gt; ChunkNo -&gt; ChunkNo)
-&gt; Ord ChunkNo
ChunkNo -&gt; ChunkNo -&gt; Bool
ChunkNo -&gt; ChunkNo -&gt; Ordering
ChunkNo -&gt; ChunkNo -&gt; ChunkNo
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: ChunkNo -&gt; ChunkNo -&gt; Ordering
compare :: ChunkNo -&gt; ChunkNo -&gt; Ordering
$c&lt; :: ChunkNo -&gt; ChunkNo -&gt; Bool
&lt; :: ChunkNo -&gt; ChunkNo -&gt; Bool
$c&lt;= :: ChunkNo -&gt; ChunkNo -&gt; Bool
&lt;= :: ChunkNo -&gt; ChunkNo -&gt; Bool
$c&gt; :: ChunkNo -&gt; ChunkNo -&gt; Bool
&gt; :: ChunkNo -&gt; ChunkNo -&gt; Bool
$c&gt;= :: ChunkNo -&gt; ChunkNo -&gt; Bool
&gt;= :: ChunkNo -&gt; ChunkNo -&gt; Bool
$cmax :: ChunkNo -&gt; ChunkNo -&gt; ChunkNo
max :: ChunkNo -&gt; ChunkNo -&gt; ChunkNo
$cmin :: ChunkNo -&gt; ChunkNo -&gt; ChunkNo
min :: ChunkNo -&gt; ChunkNo -&gt; ChunkNo
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679843553"><span id="local-6989586621679843555"><span class="annot"><span class="annottext">(forall x. ChunkNo -&gt; Rep ChunkNo x)
-&gt; (forall x. Rep ChunkNo x -&gt; ChunkNo) -&gt; Generic ChunkNo
forall x. Rep ChunkNo x -&gt; ChunkNo
forall x. ChunkNo -&gt; Rep ChunkNo x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. ChunkNo -&gt; Rep ChunkNo x
from :: forall x. ChunkNo -&gt; Rep ChunkNo x
$cto :: forall x. Rep ChunkNo x -&gt; ChunkNo
to :: forall x. Rep ChunkNo x -&gt; ChunkNo
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679843558"><span id="local-6989586621679843562"><span id="local-6989586621679843566"><span class="annot"><span class="annottext">Int -&gt; ChunkNo -&gt; ShowS
[ChunkNo] -&gt; ShowS
ChunkNo -&gt; String
(Int -&gt; ChunkNo -&gt; ShowS)
-&gt; (ChunkNo -&gt; String) -&gt; ([ChunkNo] -&gt; ShowS) -&gt; Show ChunkNo
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ChunkNo -&gt; ShowS
showsPrec :: Int -&gt; ChunkNo -&gt; ShowS
$cshow :: ChunkNo -&gt; String
show :: ChunkNo -&gt; String
$cshowList :: [ChunkNo] -&gt; ShowS
showList :: [ChunkNo] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679843571"><span id="local-6989586621679843575"><span id="local-6989586621679843579"><span class="annot"><span class="annottext">Context -&gt; ChunkNo -&gt; IO (Maybe ThunkInfo)
Proxy ChunkNo -&gt; String
(Context -&gt; ChunkNo -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; ChunkNo -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy ChunkNo -&gt; String)
-&gt; NoThunks ChunkNo
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; ChunkNo -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; ChunkNo -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; ChunkNo -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; ChunkNo -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy ChunkNo -&gt; String
showTypeOf :: Proxy ChunkNo -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="annot"><span class="hs-comment">-- | First chunk</span></span><span>
</span><span id="line-113"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-type">firstChunkNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-114"></span><span id="firstChunkNo"><span class="annot"><span class="annottext">firstChunkNo :: ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var hs-var">firstChunkNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- | Convert 'ChunkNo' to 'Int'</span><span>
</span><span id="line-117"></span><span class="hs-comment">--</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- This is primarily useful for the immutable DB, which uses an 'IntPSQ'.</span><span>
</span><span id="line-119"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoToInt"><span class="hs-identifier hs-type">chunkNoToInt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-120"></span><span id="chunkNoToInt"><span class="annot"><span class="annottext">chunkNoToInt :: ChunkNo -&gt; Int
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoToInt"><span class="hs-identifier hs-var hs-var">chunkNoToInt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843583"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843583"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843583"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-comment">-- | Convert 'Int' to 'ChunkNo'</span><span>
</span><span id="line-123"></span><span class="hs-comment">--</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- See 'chunkNoToInt' for motivation.</span><span>
</span><span id="line-125"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoFromInt"><span class="hs-identifier hs-type">chunkNoFromInt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-126"></span><span id="chunkNoFromInt"><span class="annot"><span class="annottext">chunkNoFromInt :: Int -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkNoFromInt"><span class="hs-identifier hs-var hs-var">chunkNoFromInt</span></a></span></span><span> </span><span id="local-6989586621679843584"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679843584"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679843584"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-type">nextChunkNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-129"></span><span id="nextChunkNo"><span class="annot"><span class="annottext">nextChunkNo :: ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var hs-var">nextChunkNo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843585"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843585"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843585"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#prevChunkNo"><span class="hs-identifier hs-type">prevChunkNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-132"></span><span id="prevChunkNo"><span class="annot"><span class="annottext">prevChunkNo :: ChunkNo -&gt; Maybe ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#prevChunkNo"><span class="hs-identifier hs-var hs-var">prevChunkNo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843587"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843587"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843587"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe ChunkNo -&gt; Maybe ChunkNo
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; Maybe ChunkNo
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; ChunkNo) -&gt; Word64 -&gt; ChunkNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843587"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- | Count number of chunks between two indices</span><span>
</span><span id="line-135"></span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- &gt; countChunks x              x  == 0</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- &gt; countChunks x (nextChunkNo x) == 1</span><span>
</span><span id="line-138"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#countChunks"><span class="hs-identifier hs-type">countChunks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-139"></span><span id="countChunks"><span class="annot"><span class="annottext">countChunks :: ChunkNo -&gt; ChunkNo -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#countChunks"><span class="hs-identifier hs-var hs-var">countChunks</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843589"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843589"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843590"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843590"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843589"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843590"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843589"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843590"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843590"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843589"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">-- | Enumerate all chunks</span><span>
</span><span id="line-142"></span><span class="hs-comment">--</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- &gt; chunksBetween x              x  == [x]</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- &gt; chunksBetween x (nextChunkNo x) == [x, nextChunkNo x]</span><span>
</span><span id="line-145"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunksBetween"><span class="hs-identifier hs-type">chunksBetween</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-146"></span><span id="chunksBetween"><span class="annot"><span class="annottext">chunksBetween :: ChunkNo -&gt; ChunkNo -&gt; [ChunkNo]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunksBetween"><span class="hs-identifier hs-var hs-var">chunksBetween</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843591"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843591"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843592"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843592"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; ChunkNo) -&gt; [Word64] -&gt; [ChunkNo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">([Word64] -&gt; [ChunkNo]) -&gt; [Word64] -&gt; [ChunkNo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-147"></span><span>                                          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843591"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843592"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843591"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843592"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843592"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843591"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-comment">-- | Translate 'EpochNo' to 'ChunkNo'</span><span>
</span><span id="line-150"></span><span class="hs-comment">--</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- This should /ONLY/ be used to translate the 'EpochNo' of an EBB, since the</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- invariant says EBBs can only exist in the first period of the DB, where the</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- chunk size must equal the epoch size. See 'ChunkInfo' for details.</span><span>
</span><span id="line-154"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeEpochNoToChunkNo"><span class="hs-identifier hs-type">unsafeEpochNoToChunkNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-155"></span><span id="unsafeEpochNoToChunkNo"><span class="annot"><span class="annottext">unsafeEpochNoToChunkNo :: EpochNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeEpochNoToChunkNo"><span class="hs-identifier hs-var hs-var">unsafeEpochNoToChunkNo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span> </span><span id="local-6989586621679843594"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843594"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-var">ChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843594"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="hs-comment">-- | Translate 'ChunkNo' to 'EpochNo'</span><span>
</span><span id="line-158"></span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- This should /ONLY/ be used for chunks that contain EBBs.</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- See 'unsafeEpochNoToChunkNo' and 'ChunkInfo' for details.</span><span>
</span><span id="line-161"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeChunkNoToEpochNo"><span class="hs-identifier hs-type">unsafeChunkNoToEpochNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span>
</span><span id="line-162"></span><span id="unsafeChunkNoToEpochNo"><span class="annot"><span class="annottext">unsafeChunkNoToEpochNo :: ChunkNo -&gt; EpochNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeChunkNoToEpochNo"><span class="hs-identifier hs-var hs-var">unsafeChunkNoToEpochNo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span id="local-6989586621679843595"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843595"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; EpochNo
</span><span class="hs-identifier hs-var">EpochNo</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843595"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#getChunkSize"><span class="hs-identifier hs-type">getChunkSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span>
</span><span id="line-165"></span><span id="getChunkSize"><span class="annot"><span class="annottext">getChunkSize :: ChunkInfo -&gt; ChunkNo -&gt; ChunkSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#getChunkSize"><span class="hs-identifier hs-var hs-var">getChunkSize</span></a></span></span><span> </span><span id="local-6989586621679843596"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679843596"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span id="local-6989586621679843597"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679843597"><span class="hs-identifier hs-var">_chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679843596"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#UniformChunkSize"><span class="hs-identifier hs-type">UniformChunkSize</span></a></span><span> </span><span id="local-6989586621679843598"><span class="annot"><span class="annottext">ChunkSize
</span><a href="#local-6989586621679843598"><span class="hs-identifier hs-var">sz</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkSize
</span><a href="#local-6989586621679843598"><span class="hs-identifier hs-var">sz</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Layout

  These are defined in the @Internal@ module so that most code can safely
  import from &quot;Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout&quot; without
  worrying that it's making assumptions that it shouldn't. All bets are off for
  modules that import &quot;Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal&quot;.
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="annot"><span class="hs-comment">-- | A /relative/ slot within a chunk</span></span><span>
</span><span id="line-179"></span><span class="hs-keyword">data</span><span> </span><span id="RelativeSlot"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-var">RelativeSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RelativeSlot"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-var">RelativeSlot</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-comment">-- | The chunk index of the chunk this slot is in</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-comment">-- Recorded primarily to be able to define a semi-sensible 'Ord' instance.</span><span>
</span><span id="line-183"></span><span>    </span><span id="relativeSlotChunkNo"><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var hs-var">relativeSlotChunkNo</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-comment">-- | The size of the chunk that this slot is in</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- We record this for bounds checking as well as to be able to answer</span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-comment">-- questions such as 'relativeSlotIsEBB'.</span><span>
</span><span id="line-189"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="relativeSlotChunkSize"><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkSize"><span class="hs-identifier hs-var hs-var">relativeSlotChunkSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="hs-comment">-- | The index within the chunk</span></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="relativeSlotIndex"><span class="annot"><span class="annottext">RelativeSlot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier hs-var hs-var">relativeSlotIndex</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679843604"><span id="local-6989586621679843610"><span id="local-6989586621679843614"><span class="annot"><span class="annottext">Int -&gt; RelativeSlot -&gt; ShowS
[RelativeSlot] -&gt; ShowS
RelativeSlot -&gt; String
(Int -&gt; RelativeSlot -&gt; ShowS)
-&gt; (RelativeSlot -&gt; String)
-&gt; ([RelativeSlot] -&gt; ShowS)
-&gt; Show RelativeSlot
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; RelativeSlot -&gt; ShowS
showsPrec :: Int -&gt; RelativeSlot -&gt; ShowS
$cshow :: RelativeSlot -&gt; String
show :: RelativeSlot -&gt; String
$cshowList :: [RelativeSlot] -&gt; ShowS
showList :: [RelativeSlot] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679843617"><span id="local-6989586621679843619"><span class="annot"><span class="annottext">(forall x. RelativeSlot -&gt; Rep RelativeSlot x)
-&gt; (forall x. Rep RelativeSlot x -&gt; RelativeSlot)
-&gt; Generic RelativeSlot
forall x. Rep RelativeSlot x -&gt; RelativeSlot
forall x. RelativeSlot -&gt; Rep RelativeSlot x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. RelativeSlot -&gt; Rep RelativeSlot x
from :: forall x. RelativeSlot -&gt; Rep RelativeSlot x
$cto :: forall x. Rep RelativeSlot x -&gt; RelativeSlot
to :: forall x. Rep RelativeSlot x -&gt; RelativeSlot
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679843622"><span id="local-6989586621679843626"><span id="local-6989586621679843632"><span class="annot"><span class="annottext">Context -&gt; RelativeSlot -&gt; IO (Maybe ThunkInfo)
Proxy RelativeSlot -&gt; String
(Context -&gt; RelativeSlot -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; RelativeSlot -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy RelativeSlot -&gt; String)
-&gt; NoThunks RelativeSlot
forall a.
(Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Context -&gt; a -&gt; IO (Maybe ThunkInfo))
-&gt; (Proxy a -&gt; String)
-&gt; NoThunks a
$cnoThunks :: Context -&gt; RelativeSlot -&gt; IO (Maybe ThunkInfo)
noThunks :: Context -&gt; RelativeSlot -&gt; IO (Maybe ThunkInfo)
$cwNoThunks :: Context -&gt; RelativeSlot -&gt; IO (Maybe ThunkInfo)
wNoThunks :: Context -&gt; RelativeSlot -&gt; IO (Maybe ThunkInfo)
$cshowTypeOf :: Proxy RelativeSlot -&gt; String
showTypeOf :: Proxy RelativeSlot -&gt; String
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">NoThunks</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="annot"><span class="hs-comment">-- | Maximum relative index within a chunk</span></span><span>
</span><span id="line-198"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#maxRelativeIndex"><span class="hs-identifier hs-type">maxRelativeIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-199"></span><span id="maxRelativeIndex"><span class="annot"><span class="annottext">maxRelativeIndex :: ChunkSize -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#maxRelativeIndex"><span class="hs-identifier hs-var hs-var">maxRelativeIndex</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span class="hs-special">{</span><span id="local-6989586621679843663"><span id="local-6989586621679843664"><span class="annot"><span class="annottext">Bool
Word64
chunkCanContainEBB :: ChunkSize -&gt; Bool
numRegularBlocks :: ChunkSize -&gt; Word64
chunkCanContainEBB :: Bool
numRegularBlocks :: Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#chunkCanContainEBB"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679843663"><span class="hs-identifier hs-var">chunkCanContainEBB</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843664"><span class="hs-identifier hs-var">numRegularBlocks</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843664"><span class="hs-identifier hs-var">numRegularBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="annot"><span class="hs-comment">-- | Smart constructor for 'RelativeSlot'</span></span><span>
</span><span id="line-204"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#mkRelativeSlot"><span class="hs-identifier hs-type">mkRelativeSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span>
</span><span id="line-205"></span><span id="mkRelativeSlot"><span class="annot"><span class="annottext">mkRelativeSlot :: HasCallStack =&gt; ChunkInfo -&gt; ChunkNo -&gt; Word64 -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#mkRelativeSlot"><span class="hs-identifier hs-var hs-var">mkRelativeSlot</span></a></span></span><span> </span><span id="local-6989586621679843668"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679843668"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span id="local-6989586621679843669"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679843669"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679843670"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843670"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><span class="annottext">Word64 -&gt; ChunkSize -&gt; RelativeSlot -&gt; RelativeSlot
forall a. HasCallStack =&gt; Word64 -&gt; ChunkSize -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertWithinBounds"><span class="hs-identifier hs-var">assertWithinBounds</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843670"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSize
</span><a href="#local-6989586621679843671"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">(RelativeSlot -&gt; RelativeSlot) -&gt; RelativeSlot -&gt; RelativeSlot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-208"></span><span>        </span><span class="annot"><span class="annottext">relativeSlotChunkNo :: ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679843669"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">relativeSlotChunkSize :: ChunkSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkSize"><span class="hs-identifier hs-var">relativeSlotChunkSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkSize
</span><a href="#local-6989586621679843671"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">relativeSlotIndex :: Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier hs-var">relativeSlotIndex</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679843670"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-211"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621679843671"><span class="annot"><span class="annottext">size :: ChunkSize
</span><a href="#local-6989586621679843671"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; ChunkNo -&gt; ChunkSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#getChunkSize"><span class="hs-identifier hs-var">getChunkSize</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679843668"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679843669"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679843674"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-216"></span><span>  </span><span id="local-6989586621679843681"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843681"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679843682"><span class="annot"><span class="annottext">== :: RelativeSlot -&gt; RelativeSlot -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span id="local-6989586621679843683"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843683"><span class="hs-identifier hs-var">b</span></a></span></span><span>
</span><span id="line-217"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843681"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843683"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-comment">-- If the 'ChunkNo's are the same, then the 'ChunkSize's /must/ also be</span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool -&gt; Bool
forall a. HasCallStack =&gt; ChunkNo -&gt; ChunkNo -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var">assertSameChunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843681"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843683"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-221"></span><span>          </span><span class="annot"><span class="annottext">RelativeSlot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier hs-var">relativeSlotIndex</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843681"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier hs-var">relativeSlotIndex</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843683"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">-- | 'RelativeSlot' is partially ordered, not totally ordered</span><span>
</span><span id="line-224"></span><span class="hs-comment">--</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- It makes no sense to compare 'RelativeSlots' from different chunks. Doing so</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- will result in an assertion failure.</span><span>
</span><span id="line-227"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#compareRelativeSlot"><span class="hs-identifier hs-type">compareRelativeSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Ordering"><span class="hs-identifier hs-type">Ordering</span></a></span><span>
</span><span id="line-228"></span><span id="compareRelativeSlot"><span class="annot"><span class="annottext">compareRelativeSlot :: HasCallStack =&gt; RelativeSlot -&gt; RelativeSlot -&gt; Ordering
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#compareRelativeSlot"><span class="hs-identifier hs-var hs-var">compareRelativeSlot</span></a></span></span><span> </span><span id="local-6989586621679843689"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843689"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679843690"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843690"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Ordering -&gt; Ordering
forall a. HasCallStack =&gt; ChunkNo -&gt; ChunkNo -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var">assertSameChunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843689"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843690"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Ordering -&gt; Ordering) -&gt; Ordering -&gt; Ordering
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#compare"><span class="hs-identifier hs-var">compare</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier hs-var">relativeSlotIndex</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843689"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier hs-var">relativeSlotIndex</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843690"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertRelativeSlotInChunk"><span class="hs-identifier hs-type">assertRelativeSlotInChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-233"></span><span id="assertRelativeSlotInChunk"><span class="annot"><span class="annottext">assertRelativeSlotInChunk :: HasCallStack =&gt; ChunkNo -&gt; RelativeSlot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertRelativeSlotInChunk"><span class="hs-identifier hs-var hs-var">assertRelativeSlotInChunk</span></a></span></span><span> </span><span id="local-6989586621679843695"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679843695"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679843696"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843696"><span class="hs-identifier hs-var">relSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-234"></span><span>    </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Word64 -&gt; Word64
forall a. HasCallStack =&gt; ChunkNo -&gt; ChunkNo -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var">assertSameChunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotChunkNo"><span class="hs-identifier hs-var">relativeSlotChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843696"><span class="hs-identifier hs-var">relSlot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679843695"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Word64) -&gt; Word64 -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><span class="annottext">RelativeSlot -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#relativeSlotIndex"><span class="hs-identifier hs-var">relativeSlotIndex</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679843696"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Assert failures

  We insist on keeping the HasCallStack constraint here, because if we make
  that constraint depend on CPP, we will get redundant constraint warnings for
  any functions that (transitively) call these functions.
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-keyword">data</span><span> </span><span id="ChunkAssertionFailure"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkAssertionFailure"><span class="hs-identifier hs-var">ChunkAssertionFailure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>    </span><span id="NotSameChunk"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#NotSameChunk"><span class="hs-identifier hs-var">NotSameChunk</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.CallStack.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="NotWithinBounds"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#NotWithinBounds"><span class="hs-identifier hs-var">NotWithinBounds</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.CallStack.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ChunkCannotContainEBBs"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkCannotContainEBBs"><span class="hs-identifier hs-var">ChunkCannotContainEBBs</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.CallStack.html#PrettyCallStack"><span class="hs-identifier hs-type">PrettyCallStack</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679843701"><span id="local-6989586621679843715"><span id="local-6989586621679843719"><span class="annot"><span class="annottext">Int -&gt; ChunkAssertionFailure -&gt; ShowS
[ChunkAssertionFailure] -&gt; ShowS
ChunkAssertionFailure -&gt; String
(Int -&gt; ChunkAssertionFailure -&gt; ShowS)
-&gt; (ChunkAssertionFailure -&gt; String)
-&gt; ([ChunkAssertionFailure] -&gt; ShowS)
-&gt; Show ChunkAssertionFailure
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ChunkAssertionFailure -&gt; ShowS
showsPrec :: Int -&gt; ChunkAssertionFailure -&gt; ShowS
$cshow :: ChunkAssertionFailure -&gt; String
show :: ChunkAssertionFailure -&gt; String
$cshowList :: [ChunkAssertionFailure] -&gt; ShowS
showList :: [ChunkAssertionFailure] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679843726"><span id="local-6989586621679843730"><span id="local-6989586621679843733"><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkAssertionFailure"><span class="hs-identifier hs-type">ChunkAssertionFailure</span></a></span></span></span></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span id="local-6989586621679843333"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-type">assertSameChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679843333"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679843333"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-cpp">
#if ENABLE_ASSERTIONS
</span><span class="hs-identifier">assertSameChunk</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">b</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">b</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">id</span><span>
</span><span id="line-257"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throw</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">NotSameChunk</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">b</span><span> </span><span class="hs-identifier">prettyCallStack</span><span class="hs-cpp">
#else
</span><span id="assertSameChunk"><span class="annot"><span class="annottext">assertSameChunk :: forall a. HasCallStack =&gt; ChunkNo -&gt; ChunkNo -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertSameChunk"><span class="hs-identifier hs-var hs-var">assertSameChunk</span></a></span></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a
forall a. a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy HasCallStack -&gt; ()
forall (c :: Constraint) (proxy :: Constraint -&gt; *).
c =&gt;
proxy c -&gt; ()
</span><a href="Ouroboros.Consensus.Util.RedundantConstraints.html#keepRedundantConstraint"><span class="hs-identifier hs-var">keepRedundantConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (t :: k). Proxy t
forall (t :: Constraint). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span id="local-6989586621679843332"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertWithinBounds"><span class="hs-identifier hs-type">assertWithinBounds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679843332"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679843332"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-cpp">
#if ENABLE_ASSERTIONS
</span><span class="hs-identifier">assertWithinBounds</span><span> </span><span class="hs-identifier">ix</span><span> </span><span class="hs-identifier">sz</span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ix</span><span> </span><span class="hs-operator">&lt;=</span><span> </span><span class="hs-identifier">maxRelativeIndex</span><span> </span><span class="hs-identifier">sz</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">id</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throw</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">NotWithinBounds</span><span> </span><span class="hs-identifier">ix</span><span> </span><span class="hs-identifier">sz</span><span> </span><span class="hs-identifier">prettyCallStack</span><span class="hs-cpp">
#else
</span><span id="assertWithinBounds"><span class="annot"><span class="annottext">assertWithinBounds :: forall a. HasCallStack =&gt; Word64 -&gt; ChunkSize -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertWithinBounds"><span class="hs-identifier hs-var hs-var">assertWithinBounds</span></a></span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChunkSize
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a
forall a. a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy HasCallStack -&gt; ()
forall (c :: Constraint) (proxy :: Constraint -&gt; *).
c =&gt;
proxy c -&gt; ()
</span><a href="Ouroboros.Consensus.Util.RedundantConstraints.html#keepRedundantConstraint"><span class="hs-identifier hs-var">keepRedundantConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (t :: k). Proxy t
forall (t :: Constraint). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span id="local-6989586621679843346"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertChunkCanContainEBB"><span class="hs-identifier hs-type">assertChunkCanContainEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkSize"><span class="hs-identifier hs-type">ChunkSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679843346"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679843346"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-cpp">
#if ENABLE_ASSERTIONS
</span><span class="hs-identifier">assertChunkCanContainEBB</span><span> </span><span class="hs-identifier">chunk</span><span> </span><span class="hs-identifier">size</span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">chunkCanContainEBB</span><span> </span><span class="hs-identifier">size</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">id</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">throw</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">ChunkCannotContainEBBs</span><span> </span><span class="hs-identifier">chunk</span><span> </span><span class="hs-identifier">prettyCallStack</span><span class="hs-cpp">
#else
</span><span id="assertChunkCanContainEBB"><span class="annot"><span class="annottext">assertChunkCanContainEBB :: forall a. HasCallStack =&gt; ChunkNo -&gt; ChunkSize -&gt; a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#assertChunkCanContainEBB"><span class="hs-identifier hs-var hs-var">assertChunkCanContainEBB</span></a></span></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChunkSize
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; a
forall a. a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy HasCallStack -&gt; ()
forall (c :: Constraint) (proxy :: Constraint -&gt; *).
c =&gt;
proxy c -&gt; ()
</span><a href="Ouroboros.Consensus.Util.RedundantConstraints.html#keepRedundantConstraint"><span class="hs-identifier hs-var">keepRedundantConstraint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall {k} (t :: k). Proxy t
forall (t :: Constraint). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span></pre></body></html>
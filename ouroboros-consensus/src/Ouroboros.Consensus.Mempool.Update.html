<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase       #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | Operations that update the mempool. They are internally divided in the pure</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- and impure sides of the operation.</span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Mempool.Update</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#implAddTx"><span class="hs-identifier">implAddTx</span></a></span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#implRemoveTxs"><span class="hs-identifier">implRemoveTxs</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#implSyncWithLedger"><span class="hs-identifier">implSyncWithLedger</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">withMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isJust"><span class="hs-identifier">isJust</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier">isNothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderValidation</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsMempool</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html"><span class="hs-identifier">Ouroboros.Consensus.Mempool.API</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Capacity.html"><span class="hs-identifier">Ouroboros.Consensus.Mempool.Capacity</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html"><span class="hs-identifier">Ouroboros.Consensus.Mempool.Impl.Common</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html"><span class="hs-identifier">Ouroboros.Consensus.Mempool.TxSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#TxTicket"><span class="hs-identifier">TxTicket</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html"><span class="hs-identifier">Ouroboros.Consensus.Mempool.TxSeq</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TxSeq</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier">whenJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">withMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Add transactions
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-comment">-- | Add a single transaction to the mempool, blocking if there is no space.</span><span>
</span><span id="line-33"></span><span class="hs-comment">--</span><span>
</span><span id="line-34"></span><span id="local-6989586621679917059"><span id="local-6989586621679917062"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#implAddTx"><span class="hs-identifier hs-type">implAddTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-35"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679917059"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-36"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679917059"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-37"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#LedgerSupportsMempool"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-38"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#HasTxId"><span class="hs-identifier hs-type">HasTxId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679917059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The InternalState TVar.</span></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679917059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The FIFO for remote peers</span></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679917059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The FIFO for all remote peers and local clients</span></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerConfig"><span class="hs-identifier hs-type">LedgerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-47"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The configuration of the ledger.</span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>     </span><span class="hs-comment">-- ^ The function to calculate the size of a</span><span>
</span><span id="line-50"></span><span>     </span><span class="hs-comment">-- transaction.</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679917059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceEventMempool"><span class="hs-identifier hs-type">TraceEventMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#AddTxOnBehalfOf"><span class="hs-identifier hs-type">AddTxOnBehalfOf</span></a></span><span>
</span><span id="line-53"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Whether we're acting on behalf of a remote peer or a local client.</span></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-55"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The transaction to add to the mempool.</span></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679917059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917062"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-57"></span><span id="implAddTx"><span class="annot"><span class="annottext">implAddTx :: forall (m :: * -&gt; *) blk.
(MonadSTM m, MonadMVar m, LedgerSupportsMempool blk,
 HasTxId (GenTx blk)) =&gt;
StrictTVar m (InternalState blk)
-&gt; MVar m ()
-&gt; MVar m ()
-&gt; LedgerConfig blk
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; Tracer m (TraceEventMempool blk)
-&gt; AddTxOnBehalfOf
-&gt; GenTx blk
-&gt; m (MempoolAddTxResult blk)
</span><a href="Ouroboros.Consensus.Mempool.Update.html#implAddTx"><span class="hs-identifier hs-var hs-var">implAddTx</span></a></span></span><span> </span><span id="local-6989586621679917325"><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917325"><span class="hs-identifier hs-var">istate</span></a></span></span><span> </span><span id="local-6989586621679917326"><span class="annot"><span class="annottext">MVar m ()
</span><a href="#local-6989586621679917326"><span class="hs-identifier hs-var">remoteFifo</span></a></span></span><span> </span><span id="local-6989586621679917327"><span class="annot"><span class="annottext">MVar m ()
</span><a href="#local-6989586621679917327"><span class="hs-identifier hs-var">allFifo</span></a></span></span><span> </span><span id="local-6989586621679917328"><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917328"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679917329"><span class="annot"><span class="annottext">GenTx blk -&gt; TxSizeInBytes
</span><a href="#local-6989586621679917329"><span class="hs-identifier hs-var">txSize</span></a></span></span><span> </span><span id="local-6989586621679917330"><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk)
</span><a href="#local-6989586621679917330"><span class="hs-identifier hs-var">trcr</span></a></span></span><span> </span><span id="local-6989586621679917331"><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="#local-6989586621679917331"><span class="hs-identifier hs-var">onbehalf</span></a></span></span><span> </span><span id="local-6989586621679917332"><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917332"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-comment">-- To ensure fair behaviour between threads that are trying to add</span><span>
</span><span id="line-59"></span><span>    </span><span class="hs-comment">-- transactions, we make them all queue in a fifo. Only the one at the head</span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-comment">-- of the queue gets to actually wait for space to get freed up in the</span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-comment">-- mempool. This avoids small transactions repeatedly squeezing in ahead of</span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-comment">-- larger transactions.</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-comment">-- The fifo behaviour is implemented using a simple MVar. And take this</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- MVar lock on a transaction by transaction basis. So if several threads</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">-- are each trying to add several transactions, then they'll interleave at</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- transaction granularity, not batches of transactions.</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- To add back in a bit of deliberate unfairness, we want to prioritise</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- transactions being added on behalf of local clients, over ones being</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- added on behalf of remote peers. We do this by using a pair of mvar</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">-- fifos: remote peers must wait on both mvars, while local clients only</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-comment">-- need to wait on the second.</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="#local-6989586621679917331"><span class="hs-identifier hs-var">onbehalf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-75"></span><span>      </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForRemotePeer"><span class="hs-identifier hs-var">AddTxForRemotePeer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-76"></span><span>        </span><span class="annot"><span class="annottext">MVar m ()
-&gt; (() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk)
forall a b. MVar m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadMVar m =&gt;
MVar m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar m ()
</span><a href="#local-6989586621679917326"><span class="hs-identifier hs-var">remoteFifo</span></a></span><span> </span><span class="annot"><span class="annottext">((() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk))
-&gt; (() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-77"></span><span>        </span><span class="annot"><span class="annottext">MVar m ()
-&gt; (() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk)
forall a b. MVar m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadMVar m =&gt;
MVar m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar m ()
</span><a href="#local-6989586621679917327"><span class="hs-identifier hs-var">allFifo</span></a></span><span> </span><span class="annot"><span class="annottext">((() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk))
-&gt; (() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-78"></span><span>          </span><span class="hs-comment">-- This action can also block. Holding the MVars means</span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-comment">-- there is only a single such thread blocking at once.</span><span>
</span><span id="line-80"></span><span>          </span><span class="annot"><span class="annottext">m (MempoolAddTxResult blk)
</span><a href="#local-6989586621679917334"><span class="hs-identifier hs-var">implAddTx'</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span>      </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForLocalClient"><span class="hs-identifier hs-var">AddTxForLocalClient</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>        </span><span class="annot"><span class="annottext">MVar m ()
-&gt; (() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk)
forall a b. MVar m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadMVar m =&gt;
MVar m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">withMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar m ()
</span><a href="#local-6989586621679917327"><span class="hs-identifier hs-var">allFifo</span></a></span><span> </span><span class="annot"><span class="annottext">((() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk))
-&gt; (() -&gt; m (MempoolAddTxResult blk)) -&gt; m (MempoolAddTxResult blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>          </span><span class="hs-comment">-- As above but skip the first MVar fifo so we will get</span><span>
</span><span id="line-85"></span><span>          </span><span class="hs-comment">-- service sooner if there's lots of other remote</span><span>
</span><span id="line-86"></span><span>          </span><span class="hs-comment">-- threads waiting.</span><span>
</span><span id="line-87"></span><span>          </span><span class="annot"><span class="annottext">m (MempoolAddTxResult blk)
</span><a href="#local-6989586621679917334"><span class="hs-identifier hs-var">implAddTx'</span></a></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621679917334"><span class="annot"><span class="annottext">implAddTx' :: m (MempoolAddTxResult blk)
</span><a href="#local-6989586621679917334"><span class="hs-identifier hs-var hs-var">implAddTx'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679917402"><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><a href="#local-6989586621679917402"><span class="hs-identifier hs-var">result</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679917403"><span class="annot"><span class="annottext">TraceEventMempool blk
</span><a href="#local-6989586621679917403"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (MempoolAddTxResult blk, TraceEventMempool blk)
-&gt; m (MempoolAddTxResult blk, TraceEventMempool blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (MempoolAddTxResult blk, TraceEventMempool blk)
 -&gt; m (MempoolAddTxResult blk, TraceEventMempool blk))
-&gt; STM m (MempoolAddTxResult blk, TraceEventMempool blk)
-&gt; m (MempoolAddTxResult blk, TraceEventMempool blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-91"></span><span>        </span><span id="local-6989586621679917405"><span class="annot"><span class="annottext">TryAddTx blk
</span><a href="#local-6989586621679917405"><span class="hs-identifier hs-var">outcome</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
-&gt; LedgerCfg (LedgerState blk)
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; STM m (TryAddTx blk)
forall (m :: * -&gt; *) blk.
(MonadSTM m, LedgerSupportsMempool blk, HasTxId (GenTx blk)) =&gt;
StrictTVar m (InternalState blk)
-&gt; LedgerConfig blk
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; STM m (TryAddTx blk)
</span><a href="Ouroboros.Consensus.Mempool.Update.html#implTryAddTx"><span class="hs-identifier hs-var">implTryAddTx</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917325"><span class="hs-identifier hs-var">istate</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917328"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk -&gt; TxSizeInBytes
</span><a href="#local-6989586621679917329"><span class="hs-identifier hs-var">txSize</span></a></span><span>
</span><span id="line-92"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AddTxOnBehalfOf -&gt; WhetherToIntervene
</span><a href="#local-6989586621679917407"><span class="hs-identifier hs-var">whetherToIntervene</span></a></span><span> </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="#local-6989586621679917331"><span class="hs-identifier hs-var">onbehalf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>                                </span><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917332"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-94"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TryAddTx blk
</span><a href="#local-6989586621679917405"><span class="hs-identifier hs-var">outcome</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-95"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-type">TryAddTx</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (InternalState blk)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679917409"><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><a href="#local-6989586621679917409"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span id="local-6989586621679917410"><span class="annot"><span class="annottext">TraceEventMempool blk
</span><a href="#local-6989586621679917410"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">(MempoolAddTxResult blk, TraceEventMempool blk)
-&gt; STM m (MempoolAddTxResult blk, TraceEventMempool blk)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><a href="#local-6989586621679917409"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TraceEventMempool blk
</span><a href="#local-6989586621679917410"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>          </span><span class="hs-comment">-- or block until space is available to fit the next transaction</span><span>
</span><span id="line-98"></span><span>          </span><span class="annot"><span class="annottext">TryAddTx blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#NoSpaceLeft"><span class="hs-identifier hs-var">NoSpaceLeft</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m (MempoolAddTxResult blk, TraceEventMempool blk)
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk) -&gt; TraceEventMempool blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk)
</span><a href="#local-6989586621679917330"><span class="hs-identifier hs-var">trcr</span></a></span><span> </span><span class="annot"><span class="annottext">TraceEventMempool blk
</span><a href="#local-6989586621679917403"><span class="hs-identifier hs-var">ev</span></a></span><span>
</span><span id="line-101"></span><span>      </span><span class="annot"><span class="annottext">MempoolAddTxResult blk -&gt; m (MempoolAddTxResult blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><a href="#local-6989586621679917402"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><a href="#local-6989586621679917407"><span class="hs-identifier hs-type">whetherToIntervene</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#AddTxOnBehalfOf"><span class="hs-identifier hs-type">AddTxOnBehalfOf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#WhetherToIntervene"><span class="hs-identifier hs-type">WhetherToIntervene</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span id="local-6989586621679917407"><span class="annot"><span class="annottext">whetherToIntervene :: AddTxOnBehalfOf -&gt; WhetherToIntervene
</span><a href="#local-6989586621679917407"><span class="hs-identifier hs-var hs-var">whetherToIntervene</span></a></span></span><span> </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForRemotePeer"><span class="hs-identifier hs-var">AddTxForRemotePeer</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WhetherToIntervene
</span><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#DoNotIntervene"><span class="hs-identifier hs-var">DoNotIntervene</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="#local-6989586621679917407"><span class="hs-identifier hs-var">whetherToIntervene</span></a></span><span> </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForLocalClient"><span class="hs-identifier hs-var">AddTxForLocalClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WhetherToIntervene
</span><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#Intervene"><span class="hs-identifier hs-var">Intervene</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><span class="hs-comment">-- | Result of trying to add a transaction to the mempool.</span></span><span>
</span><span id="line-108"></span><span class="hs-keyword">data</span><span> </span><span id="TryAddTx"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-var">TryAddTx</span></a></span></span><span> </span><span id="local-6989586621679917144"><span class="annot"><a href="#local-6989586621679917144"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- | No space is left in the mempool and no more transactions could be</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-comment">-- added.</span><span>
</span><span id="line-111"></span><span>    </span><span id="NoSpaceLeft"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#NoSpaceLeft"><span class="hs-identifier hs-var">NoSpaceLeft</span></a></span></span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="hs-comment">-- | A transaction was processed.</span></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TryAddTx"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-var">TryAddTx</span></a></span></span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917144"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-comment">-- ^ If the transaction was accepted, the new state that can be written to</span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-comment">-- the TVar.</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917144"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The result of trying to add the transaction to the mempool.</span></span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceEventMempool"><span class="hs-identifier hs-type">TraceEventMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917144"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><span class="hs-comment">-- ^ The event emitted by the operation.</span></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span class="hs-comment">-- | Add a single transaction by interpreting a 'TryAddTx' from 'pureTryAddTx'.</span><span>
</span><span id="line-123"></span><span class="hs-comment">--</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- This function returns whether the transaction was added or rejected, or if</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- the Mempool capacity is reached. See 'implAddTx' for a function that blocks</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- in case the Mempool capacity is reached.</span><span>
</span><span id="line-127"></span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- Transactions are added one by one, updating the Mempool each time one was</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- added successfully.</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- See the necessary invariants on the Haddock for 'API.tryAddTxs'.</span><span>
</span><span id="line-132"></span><span class="hs-comment">--</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- This function does not sync the Mempool contents with the ledger state in</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- case the latter changes, it relies on the background thread to do that.</span><span>
</span><span id="line-135"></span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- INVARIANT: The code needs that read and writes on the state are coupled</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- together or inconsistencies will arise. To ensure that STM transactions are</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- short, each iteration of the helper function is a separate STM transaction.</span><span>
</span><span id="line-139"></span><span id="local-6989586621679917121"><span id="local-6989586621679917122"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#implTryAddTx"><span class="hs-identifier hs-type">implTryAddTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-140"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679917121"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-141"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#LedgerSupportsMempool"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917122"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-142"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#HasTxId"><span class="hs-identifier hs-type">HasTxId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917122"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679917121"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917122"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The InternalState TVar.</span></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerConfig"><span class="hs-identifier hs-type">LedgerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917122"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-147"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The configuration of the ledger.</span></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917122"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>     </span><span class="hs-comment">-- ^ The function to calculate the size of a</span><span>
</span><span id="line-150"></span><span>     </span><span class="hs-comment">-- transaction.</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#WhetherToIntervene"><span class="hs-identifier hs-type">WhetherToIntervene</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917122"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-153"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The transaction to add to the mempool.</span></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679917121"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-type">TryAddTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917122"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-155"></span><span id="implTryAddTx"><span class="annot"><span class="annottext">implTryAddTx :: forall (m :: * -&gt; *) blk.
(MonadSTM m, LedgerSupportsMempool blk, HasTxId (GenTx blk)) =&gt;
StrictTVar m (InternalState blk)
-&gt; LedgerConfig blk
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; STM m (TryAddTx blk)
</span><a href="Ouroboros.Consensus.Mempool.Update.html#implTryAddTx"><span class="hs-identifier hs-var hs-var">implTryAddTx</span></a></span></span><span> </span><span id="local-6989586621679917460"><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917460"><span class="hs-identifier hs-var">istate</span></a></span></span><span> </span><span id="local-6989586621679917461"><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917461"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679917462"><span class="annot"><span class="annottext">GenTx blk -&gt; TxSizeInBytes
</span><a href="#local-6989586621679917462"><span class="hs-identifier hs-var">txSize</span></a></span></span><span> </span><span id="local-6989586621679917463"><span class="annot"><span class="annottext">WhetherToIntervene
</span><a href="#local-6989586621679917463"><span class="hs-identifier hs-var">wti</span></a></span></span><span> </span><span id="local-6989586621679917464"><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917464"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>        </span><span id="local-6989586621679917465"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917465"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk) -&gt; STM m (InternalState blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917460"><span class="hs-identifier hs-var">istate</span></a></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679917512"><span class="annot"><span class="annottext">outcome :: TryAddTx blk
</span><a href="#local-6989586621679917512"><span class="hs-identifier hs-var hs-var">outcome</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; InternalState blk
-&gt; TryAddTx blk
forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk)) =&gt;
LedgerCfg (LedgerState blk)
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; InternalState blk
-&gt; TryAddTx blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#pureTryAddTx"><span class="hs-identifier hs-var">pureTryAddTx</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917461"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk -&gt; TxSizeInBytes
</span><a href="#local-6989586621679917462"><span class="hs-identifier hs-var">txSize</span></a></span><span> </span><span class="annot"><span class="annottext">WhetherToIntervene
</span><a href="#local-6989586621679917463"><span class="hs-identifier hs-var">wti</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917464"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917465"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TryAddTx blk
</span><a href="#local-6989586621679917512"><span class="hs-identifier hs-var">outcome</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-159"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-type">TryAddTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679917513"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917513"><span class="hs-identifier hs-var">is'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TraceEventMempool blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk) -&gt; InternalState blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917460"><span class="hs-identifier hs-var">istate</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917513"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-160"></span><span>          </span><span class="annot"><span class="annottext">TryAddTx blk
</span><span class="hs-identifier">_</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM m ()
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="annottext">TryAddTx blk -&gt; STM m (TryAddTx blk)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">TryAddTx blk
</span><a href="#local-6989586621679917512"><span class="hs-identifier hs-var">outcome</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- | Craft a 'TryAddTx' value containing the resulting state if applicable, the</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- tracing event and the result of adding this transaction. See the</span><span>
</span><span id="line-165"></span><span class="hs-comment">-- documentation of 'implTryAddTx' for some more context.</span><span>
</span><span id="line-166"></span><span class="hs-comment">--</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- It returns 'NoSpaceLeft' only when the current mempool size is bigger or</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- equal than then mempool capacity. Otherwise it will validate the transaction</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- and add it to the mempool if there is at least one byte free on the mempool.</span><span>
</span><span id="line-170"></span><span id="local-6989586621679917131"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#pureTryAddTx"><span class="hs-identifier hs-type">pureTryAddTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-171"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#LedgerSupportsMempool"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917131"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-172"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#HasTxId"><span class="hs-identifier hs-type">HasTxId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917131"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerCfg"><span class="hs-identifier hs-type">LedgerCfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917131"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The ledger configuration.</span></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917131"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The function to claculate the size of a transaction.</span></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#WhetherToIntervene"><span class="hs-identifier hs-type">WhetherToIntervene</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917131"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-180"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The transaction to add to the mempool.</span></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917131"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-182"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ The current internal state of the mempool.</span></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-type">TryAddTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917131"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-184"></span><span id="pureTryAddTx"><span class="annot"><span class="annottext">pureTryAddTx :: forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk)) =&gt;
LedgerCfg (LedgerState blk)
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; InternalState blk
-&gt; TryAddTx blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#pureTryAddTx"><span class="hs-identifier hs-var hs-var">pureTryAddTx</span></a></span></span><span> </span><span id="local-6989586621679917562"><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917562"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679917563"><span class="annot"><span class="annottext">GenTx blk -&gt; TxSizeInBytes
</span><a href="#local-6989586621679917563"><span class="hs-identifier hs-var">txSize</span></a></span></span><span> </span><span id="local-6989586621679917564"><span class="annot"><span class="annottext">WhetherToIntervene
</span><a href="#local-6989586621679917564"><span class="hs-identifier hs-var">wti</span></a></span></span><span> </span><span id="local-6989586621679917565"><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917565"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span id="local-6989586621679917566"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917566"><span class="hs-identifier hs-var">is</span></a></span></span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679917567"><span class="annot"><span class="annottext">curSize :: TxSizeInBytes
</span><a href="#local-6989586621679917567"><span class="hs-identifier hs-var hs-var">curSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolSize -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.Capacity.html#msNumBytes"><span class="hs-identifier hs-var">msNumBytes</span></a></span><span>  </span><span class="annot"><span class="annottext">(MempoolSize -&gt; TxSizeInBytes) -&gt; MempoolSize -&gt; TxSizeInBytes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolSize
forall blk. InternalState blk -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isMempoolSize"><span class="hs-identifier hs-var">isMempoolSize</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917566"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes
</span><a href="#local-6989586621679917567"><span class="hs-identifier hs-var">curSize</span></a></span><span> </span><span class="annot"><span class="annottext">TxSizeInBytes -&gt; TxSizeInBytes -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolCapacityBytes -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.Capacity.html#getMempoolCapacityBytes"><span class="hs-identifier hs-var">getMempoolCapacityBytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolCapacityBytes
forall blk. InternalState blk -&gt; MempoolCapacityBytes
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isCapacity"><span class="hs-identifier hs-var">isCapacity</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917566"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- We add the transaction if there is at least one byte free left in the mempool.</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (ApplyTxErr blk) (Validated (GenTx blk))
</span><a href="#local-6989586621679917573"><span class="hs-identifier hs-var">eVtx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-comment">-- We only extended the ValidationResult with a single transaction</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-comment">-- ('tx'). So if it's not in 'vrInvalid', it must be in 'vrNewValid'.</span><span>
</span><span id="line-191"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679917574"><span class="annot"><span class="annottext">Validated (GenTx blk)
</span><a href="#local-6989586621679917574"><span class="hs-identifier hs-var">vtx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; TryAddTx blk -&gt; TryAddTx blk
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Validated (GenTx blk)) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk -&gt; Maybe (Validated (GenTx blk))
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; Maybe (Validated (GenTx blk))
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#vrNewValid"><span class="hs-identifier hs-var">vrNewValid</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk
</span><a href="#local-6989586621679917576"><span class="hs-identifier hs-var">vr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TryAddTx blk -&gt; TryAddTx blk) -&gt; TryAddTx blk -&gt; TryAddTx blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-193"></span><span>          </span><span class="annot"><span class="annottext">Maybe (InternalState blk)
-&gt; MempoolAddTxResult blk -&gt; TraceEventMempool blk -&gt; TryAddTx blk
forall blk.
Maybe (InternalState blk)
-&gt; MempoolAddTxResult blk -&gt; TraceEventMempool blk -&gt; TryAddTx blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-var">TryAddTx</span></a></span><span>
</span><span id="line-194"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; Maybe (InternalState blk)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917577"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Validated (GenTx blk) -&gt; MempoolAddTxResult blk
forall blk. Validated (GenTx blk) -&gt; MempoolAddTxResult blk
</span><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxAdded"><span class="hs-identifier hs-var">MempoolTxAdded</span></a></span><span> </span><span class="annot"><span class="annottext">Validated (GenTx blk)
</span><a href="#local-6989586621679917574"><span class="hs-identifier hs-var">vtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Validated (GenTx blk)
-&gt; MempoolSize -&gt; MempoolSize -&gt; TraceEventMempool blk
forall blk.
Validated (GenTx blk)
-&gt; MempoolSize -&gt; MempoolSize -&gt; TraceEventMempool blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceMempoolAddedTx"><span class="hs-identifier hs-var">TraceMempoolAddedTx</span></a></span><span>
</span><span id="line-197"></span><span>              </span><span class="annot"><span class="annottext">Validated (GenTx blk)
</span><a href="#local-6989586621679917574"><span class="hs-identifier hs-var">vtx</span></a></span><span>
</span><span id="line-198"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolSize
forall blk. InternalState blk -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isMempoolSize"><span class="hs-identifier hs-var">isMempoolSize</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917566"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolSize
forall blk. InternalState blk -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isMempoolSize"><span class="hs-identifier hs-var">isMempoolSize</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917577"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679917580"><span class="annot"><span class="annottext">ApplyTxErr blk
</span><a href="#local-6989586621679917580"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; TryAddTx blk -&gt; TryAddTx blk
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Validated (GenTx blk)) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#isNothing"><span class="hs-identifier hs-var">isNothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk -&gt; Maybe (Validated (GenTx blk))
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; Maybe (Validated (GenTx blk))
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#vrNewValid"><span class="hs-identifier hs-var">vrNewValid</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk
</span><a href="#local-6989586621679917576"><span class="hs-identifier hs-var">vr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="annottext">(TryAddTx blk -&gt; TryAddTx blk) -&gt; TryAddTx blk -&gt; TryAddTx blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-203"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; TryAddTx blk -&gt; TryAddTx blk
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(GenTx blk, ApplyTxErr blk)] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk -&gt; [(GenTx blk, ApplyTxErr blk)]
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; [(invalidTx, ApplyTxErr blk)]
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#vrInvalid"><span class="hs-identifier hs-var">vrInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk
</span><a href="#local-6989586621679917576"><span class="hs-identifier hs-var">vr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TryAddTx blk -&gt; TryAddTx blk) -&gt; TryAddTx blk -&gt; TryAddTx blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-204"></span><span>            </span><span class="annot"><span class="annottext">Maybe (InternalState blk)
-&gt; MempoolAddTxResult blk -&gt; TraceEventMempool blk -&gt; TryAddTx blk
forall blk.
Maybe (InternalState blk)
-&gt; MempoolAddTxResult blk -&gt; TraceEventMempool blk -&gt; TryAddTx blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#TryAddTx"><span class="hs-identifier hs-var">TryAddTx</span></a></span><span>
</span><span id="line-205"></span><span>              </span><span class="annot"><span class="annottext">Maybe (InternalState blk)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-206"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenTx blk -&gt; ApplyTxErr blk -&gt; MempoolAddTxResult blk
forall blk. GenTx blk -&gt; ApplyTxErr blk -&gt; MempoolAddTxResult blk
</span><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxRejected"><span class="hs-identifier hs-var">MempoolTxRejected</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917565"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">ApplyTxErr blk
</span><a href="#local-6989586621679917580"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GenTx blk -&gt; ApplyTxErr blk -&gt; MempoolSize -&gt; TraceEventMempool blk
forall blk.
GenTx blk -&gt; ApplyTxErr blk -&gt; MempoolSize -&gt; TraceEventMempool blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceMempoolRejectedTx"><span class="hs-identifier hs-var">TraceMempoolRejectedTx</span></a></span><span>
</span><span id="line-208"></span><span>               </span><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917565"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-209"></span><span>               </span><span class="annot"><span class="annottext">ApplyTxErr blk
</span><a href="#local-6989586621679917580"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-210"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolSize
forall blk. InternalState blk -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isMempoolSize"><span class="hs-identifier hs-var">isMempoolSize</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917566"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TryAddTx blk
forall blk. TryAddTx blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#NoSpaceLeft"><span class="hs-identifier hs-var">NoSpaceLeft</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679917573"><span class="annot"><span class="annottext">Either (ApplyTxErr blk) (Validated (GenTx blk))
</span><a href="#local-6989586621679917573"><span class="hs-identifier hs-var">eVtx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679917576"><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk
</span><a href="#local-6989586621679917576"><span class="hs-identifier hs-var">vr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; ValidationResult (GenTx blk) blk
-&gt; (Either (ApplyTxErr blk) (Validated (GenTx blk)),
    ValidationResult (GenTx blk) blk)
forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk)) =&gt;
LedgerConfig blk
-&gt; (GenTx blk -&gt; TxSizeInBytes)
-&gt; WhetherToIntervene
-&gt; GenTx blk
-&gt; ValidationResult (GenTx blk) blk
-&gt; (Either (ApplyTxErr blk) (Validated (GenTx blk)),
    ValidationResult (GenTx blk) blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#extendVRNew"><span class="hs-identifier hs-var">extendVRNew</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917562"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk -&gt; TxSizeInBytes
</span><a href="#local-6989586621679917563"><span class="hs-identifier hs-var">txSize</span></a></span><span> </span><span class="annot"><span class="annottext">WhetherToIntervene
</span><a href="#local-6989586621679917564"><span class="hs-identifier hs-var">wti</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk
</span><a href="#local-6989586621679917565"><span class="hs-identifier hs-var">tx</span></a></span><span> </span><span class="annot"><span class="annottext">(ValidationResult (GenTx blk) blk
 -&gt; (Either (ApplyTxErr blk) (Validated (GenTx blk)),
     ValidationResult (GenTx blk) blk))
-&gt; ValidationResult (GenTx blk) blk
-&gt; (Either (ApplyTxErr blk) (Validated (GenTx blk)),
    ValidationResult (GenTx blk) blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk -&gt; ValidationResult (GenTx blk) blk
forall blk invalidTx.
InternalState blk -&gt; ValidationResult invalidTx blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#validationResultFromIS"><span class="hs-identifier hs-var">validationResultFromIS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917566"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-216"></span><span>      </span><span id="local-6989586621679917577"><span class="annot"><span class="annottext">is' :: InternalState blk
</span><a href="#local-6989586621679917577"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk -&gt; InternalState blk
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; InternalState blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#internalStateFromVR"><span class="hs-identifier hs-var">internalStateFromVR</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (GenTx blk) blk
</span><a href="#local-6989586621679917576"><span class="hs-identifier hs-var">vr</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Remove transactions
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-comment">-- | A datatype containing the state resulting after removing the requested</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- transactions from the mempool and maybe a message to be traced while removing</span><span>
</span><span id="line-224"></span><span class="hs-comment">-- them.</span><span>
</span><span id="line-225"></span><span class="hs-keyword">data</span><span> </span><span id="RemoveTxs"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#RemoveTxs"><span class="hs-identifier hs-var">RemoveTxs</span></a></span></span><span> </span><span id="local-6989586621679917226"><span class="annot"><a href="#local-6989586621679917226"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>    </span><span id="WriteRemoveTxs"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#WriteRemoveTxs"><span class="hs-identifier hs-var">WriteRemoveTxs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917226"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceEventMempool"><span class="hs-identifier hs-type">TraceEventMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917226"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="annot"><span class="hs-comment">-- | See 'Ouroboros.Consensus.Mempool.API.removeTxs'.</span></span><span>
</span><span id="line-229"></span><span id="local-6989586621679917157"><span id="local-6989586621679917159"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#implRemoveTxs"><span class="hs-identifier hs-type">implRemoveTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-230"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917157"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-231"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#LedgerSupportsMempool"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917159"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-232"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#HasTxId"><span class="hs-identifier hs-type">HasTxId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917159"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#ValidateEnvelope"><span class="hs-identifier hs-type">ValidateEnvelope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917159"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-234"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#MempoolEnv"><span class="hs-identifier hs-type">MempoolEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917157"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917159"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917159"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679917157"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-238"></span><span id="implRemoveTxs"><span class="annot"><span class="annottext">implRemoveTxs :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsMempool blk, HasTxId (GenTx blk),
 ValidateEnvelope blk) =&gt;
MempoolEnv m blk -&gt; [GenTxId blk] -&gt; m ()
</span><a href="Ouroboros.Consensus.Mempool.Update.html#implRemoveTxs"><span class="hs-identifier hs-var hs-var">implRemoveTxs</span></a></span></span><span> </span><span id="local-6989586621679917726"><span class="annot"><span class="annottext">MempoolEnv m blk
</span><a href="#local-6989586621679917726"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span id="local-6989586621679917727"><span class="annot"><span class="annottext">[TxId (GenTx blk)]
</span><a href="#local-6989586621679917727"><span class="hs-identifier hs-var">txs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>    </span><span id="local-6989586621679917728"><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679917728"><span class="hs-identifier hs-var">tr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Maybe (TraceEventMempool blk))
-&gt; m (Maybe (TraceEventMempool blk))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Maybe (TraceEventMempool blk))
 -&gt; m (Maybe (TraceEventMempool blk)))
-&gt; STM m (Maybe (TraceEventMempool blk))
-&gt; m (Maybe (TraceEventMempool blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>        </span><span id="local-6989586621679917729"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917729"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk) -&gt; STM m (InternalState blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917730"><span class="hs-identifier hs-var">istate</span></a></span><span>
</span><span id="line-241"></span><span>        </span><span id="local-6989586621679917731"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679917731"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LedgerInterface m blk -&gt; STM m (LedgerState blk)
forall (m :: * -&gt; *) blk.
LedgerInterface m blk -&gt; STM m (LedgerState blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#getCurrentLedgerState"><span class="hs-identifier hs-var">getCurrentLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerInterface m blk
</span><a href="#local-6989586621679917733"><span class="hs-identifier hs-var">ldgrInterface</span></a></span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#WriteRemoveTxs"><span class="hs-identifier hs-type">WriteRemoveTxs</span></a></span><span> </span><span id="local-6989586621679917831"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917831"><span class="hs-identifier hs-var">is'</span></a></span></span><span> </span><span id="local-6989586621679917832"><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679917832"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
-&gt; MempoolCapacityBytesOverride
-&gt; [TxId (GenTx blk)]
-&gt; InternalState blk
-&gt; LedgerState blk
-&gt; RemoveTxs blk
forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk),
 ValidateEnvelope blk) =&gt;
LedgerConfig blk
-&gt; MempoolCapacityBytesOverride
-&gt; [GenTxId blk]
-&gt; InternalState blk
-&gt; LedgerState blk
-&gt; RemoveTxs blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#pureRemoveTxs"><span class="hs-identifier hs-var">pureRemoveTxs</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917834"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679917835"><span class="hs-identifier hs-var">co</span></a></span><span> </span><span class="annot"><span class="annottext">[TxId (GenTx blk)]
</span><a href="#local-6989586621679917727"><span class="hs-identifier hs-var">txs</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917729"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679917731"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk) -&gt; InternalState blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917730"><span class="hs-identifier hs-var">istate</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917831"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-244"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
-&gt; STM m (Maybe (TraceEventMempool blk))
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679917832"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
-&gt; (TraceEventMempool blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679917728"><span class="hs-identifier hs-var">tr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk) -&gt; TraceEventMempool blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk)
</span><a href="#local-6989586621679917836"><span class="hs-identifier hs-var">trcr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#MempoolEnv"><span class="hs-identifier hs-type">MempoolEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mpEnvStateVar :: forall (m :: * -&gt; *) blk.
MempoolEnv m blk -&gt; StrictTVar m (InternalState blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvStateVar"><span class="hs-identifier hs-var">mpEnvStateVar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679917730"><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679917730"><span class="hs-identifier hs-var">istate</span></a></span></span><span>
</span><span id="line-248"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvLedger :: forall (m :: * -&gt; *) blk. MempoolEnv m blk -&gt; LedgerInterface m blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvLedger"><span class="hs-identifier hs-var">mpEnvLedger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679917733"><span class="annot"><span class="annottext">LedgerInterface m blk
</span><a href="#local-6989586621679917733"><span class="hs-identifier hs-var">ldgrInterface</span></a></span></span><span>
</span><span id="line-249"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvTracer :: forall (m :: * -&gt; *) blk.
MempoolEnv m blk -&gt; Tracer m (TraceEventMempool blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvTracer"><span class="hs-identifier hs-var">mpEnvTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679917836"><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk)
</span><a href="#local-6989586621679917836"><span class="hs-identifier hs-var">trcr</span></a></span></span><span>
</span><span id="line-250"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvLedgerCfg :: forall (m :: * -&gt; *) blk. MempoolEnv m blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvLedgerCfg"><span class="hs-identifier hs-var">mpEnvLedgerCfg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679917834"><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917834"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-251"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvCapacityOverride :: forall (m :: * -&gt; *) blk.
MempoolEnv m blk -&gt; MempoolCapacityBytesOverride
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvCapacityOverride"><span class="hs-identifier hs-var">mpEnvCapacityOverride</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679917835"><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679917835"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-252"></span><span>               </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolEnv m blk
</span><a href="#local-6989586621679917726"><span class="hs-identifier hs-var">menv</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- | Craft a 'RemoveTxs' that manually removes the given transactions from the</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- mempool, returning inside it an updated InternalState.</span><span>
</span><span id="line-256"></span><span id="local-6989586621679917185"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#pureRemoveTxs"><span class="hs-identifier hs-type">pureRemoveTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-257"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#LedgerSupportsMempool"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-258"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#HasTxId"><span class="hs-identifier hs-type">HasTxId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#ValidateEnvelope"><span class="hs-identifier hs-type">ValidateEnvelope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-260"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerConfig"><span class="hs-identifier hs-type">LedgerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Capacity.html#MempoolCapacityBytesOverride"><span class="hs-identifier hs-type">MempoolCapacityBytesOverride</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#RemoveTxs"><span class="hs-identifier hs-type">RemoveTxs</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917185"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-267"></span><span id="pureRemoveTxs"><span class="annot"><span class="annottext">pureRemoveTxs :: forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk),
 ValidateEnvelope blk) =&gt;
LedgerConfig blk
-&gt; MempoolCapacityBytesOverride
-&gt; [GenTxId blk]
-&gt; InternalState blk
-&gt; LedgerState blk
-&gt; RemoveTxs blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#pureRemoveTxs"><span class="hs-identifier hs-var hs-var">pureRemoveTxs</span></a></span></span><span> </span><span id="local-6989586621679917893"><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917893"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679917894"><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679917894"><span class="hs-identifier hs-var">capacityOverride</span></a></span></span><span> </span><span id="local-6989586621679917895"><span class="annot"><span class="annottext">[TxId (GenTx blk)]
</span><a href="#local-6989586621679917895"><span class="hs-identifier hs-var">txIds</span></a></span></span><span> </span><span id="local-6989586621679917896"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917896"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621679917897"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679917897"><span class="hs-identifier hs-var">lstate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-comment">-- Filtering is O(n), but this function will rarely be used, as it is an</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-comment">-- escape hatch when there's an inconsistency between the ledger and the</span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-comment">-- mempool.</span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679917900"><span class="annot"><span class="annottext">toRemove :: Set (TxId (GenTx blk))
</span><a href="#local-6989586621679917900"><span class="hs-identifier hs-var hs-var">toRemove</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TxId (GenTx blk)] -&gt; Set (TxId (GenTx blk))
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[TxId (GenTx blk)]
</span><a href="#local-6989586621679917895"><span class="hs-identifier hs-var">txIds</span></a></span><span>
</span><span id="line-272"></span><span>        </span><span id="local-6989586621679917950"><span class="annot"><span class="annottext">txTickets' :: [TxTicket (Validated (GenTx blk))]
</span><a href="#local-6989586621679917950"><span class="hs-identifier hs-var hs-var">txTickets'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TxTicket (Validated (GenTx blk)) -&gt; Bool)
-&gt; [TxTicket (Validated (GenTx blk))]
-&gt; [TxTicket (Validated (GenTx blk))]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span>
</span><span id="line-273"></span><span>                           </span><span class="hs-special">(</span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxId (GenTx blk) -&gt; Set (TxId (GenTx blk)) -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#notElem"><span class="hs-operator hs-var">`notElem`</span></a></span><span> </span><span class="annot"><span class="annottext">Set (TxId (GenTx blk))
</span><a href="#local-6989586621679917900"><span class="hs-identifier hs-var">toRemove</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>                             </span><span class="annot"><span class="annottext">(TxId (GenTx blk) -&gt; Bool)
-&gt; (TxTicket (Validated (GenTx blk)) -&gt; TxId (GenTx blk))
-&gt; TxTicket (Validated (GenTx blk))
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">GenTx blk -&gt; TxId (GenTx blk)
forall tx. HasTxId tx =&gt; tx -&gt; TxId tx
</span><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#txId"><span class="hs-identifier hs-var">txId</span></a></span><span>
</span><span id="line-275"></span><span>                             </span><span class="annot"><span class="annottext">(GenTx blk -&gt; TxId (GenTx blk))
-&gt; (TxTicket (Validated (GenTx blk)) -&gt; GenTx blk)
-&gt; TxTicket (Validated (GenTx blk))
-&gt; TxId (GenTx blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Validated (GenTx blk) -&gt; GenTx blk
forall blk.
LedgerSupportsMempool blk =&gt;
Validated (GenTx blk) -&gt; GenTx blk
</span><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#txForgetValidated"><span class="hs-identifier hs-var">txForgetValidated</span></a></span><span>
</span><span id="line-276"></span><span>                             </span><span class="annot"><span class="annottext">(Validated (GenTx blk) -&gt; GenTx blk)
-&gt; (TxTicket (Validated (GenTx blk)) -&gt; Validated (GenTx blk))
-&gt; TxTicket (Validated (GenTx blk))
-&gt; GenTx blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxTicket (Validated (GenTx blk)) -&gt; Validated (GenTx blk)
forall tx. TxTicket tx -&gt; tx
</span><a href="Ouroboros.Consensus.Mempool.TxSeq.html#txTicketTx"><span class="hs-identifier hs-var">txTicketTx</span></a></span><span>
</span><span id="line-277"></span><span>                           </span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxSeq (Validated (GenTx blk)) -&gt; [TxTicket (Validated (GenTx blk))]
forall tx. TxSeq tx -&gt; [TxTicket tx]
</span><a href="Ouroboros.Consensus.Mempool.TxSeq.html#toList"><span class="hs-identifier hs-var">TxSeq.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; TxSeq (Validated (GenTx blk))
forall blk. InternalState blk -&gt; TxSeq (Validated (GenTx blk))
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isTxs"><span class="hs-identifier hs-var">isTxs</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917896"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679918043"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679918043"><span class="hs-identifier hs-var">slot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679918044"><span class="annot"><span class="annottext">Ticked (LedgerState blk)
</span><a href="#local-6989586621679918044"><span class="hs-identifier hs-var">ticked</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
-&gt; ForgeLedgerState blk -&gt; (SlotNo, Ticked (LedgerState blk))
forall blk.
(UpdateLedger blk, ValidateEnvelope blk) =&gt;
LedgerConfig blk
-&gt; ForgeLedgerState blk -&gt; (SlotNo, TickedLedgerState blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#tickLedgerState"><span class="hs-identifier hs-var">tickLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917893"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerState blk -&gt; ForgeLedgerState blk
forall blk. LedgerState blk -&gt; ForgeLedgerState blk
</span><a href="Ouroboros.Consensus.Mempool.API.html#ForgeInUnknownSlot"><span class="hs-identifier hs-var">ForgeInUnknownSlot</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679917897"><span class="hs-identifier hs-var">lstate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>        </span><span id="local-6989586621679918092"><span class="annot"><span class="annottext">vr :: ValidationResult (Validated (GenTx blk)) blk
</span><a href="#local-6989586621679918092"><span class="hs-identifier hs-var hs-var">vr</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
-&gt; LedgerCfg (LedgerState blk)
-&gt; SlotNo
-&gt; Ticked (LedgerState blk)
-&gt; TicketNo
-&gt; [TxTicket (Validated (GenTx blk))]
-&gt; ValidationResult (Validated (GenTx blk)) blk
forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk)) =&gt;
MempoolCapacityBytesOverride
-&gt; LedgerConfig blk
-&gt; SlotNo
-&gt; TickedLedgerState blk
-&gt; TicketNo
-&gt; [TxTicket (Validated (GenTx blk))]
-&gt; ValidationResult (Validated (GenTx blk)) blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#revalidateTxsFor"><span class="hs-identifier hs-var">revalidateTxsFor</span></a></span><span>
</span><span id="line-281"></span><span>                           </span><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679917894"><span class="hs-identifier hs-var">capacityOverride</span></a></span><span>
</span><span id="line-282"></span><span>                           </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679917893"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-283"></span><span>                           </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679918043"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-284"></span><span>                           </span><span class="annot"><span class="annottext">Ticked (LedgerState blk)
</span><a href="#local-6989586621679918044"><span class="hs-identifier hs-var">ticked</span></a></span><span>
</span><span id="line-285"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; TicketNo
forall blk. InternalState blk -&gt; TicketNo
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isLastTicketNo"><span class="hs-identifier hs-var">isLastTicketNo</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679917896"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>                           </span><span class="annot"><span class="annottext">[TxTicket (Validated (GenTx blk))]
</span><a href="#local-6989586621679917950"><span class="hs-identifier hs-var">txTickets'</span></a></span><span>
</span><span id="line-287"></span><span>        </span><span id="local-6989586621679918095"><span class="annot"><span class="annottext">is' :: InternalState blk
</span><a href="#local-6989586621679918095"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk -&gt; InternalState blk
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; InternalState blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#internalStateFromVR"><span class="hs-identifier hs-var">internalStateFromVR</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk
</span><a href="#local-6989586621679918092"><span class="hs-identifier hs-var">vr</span></a></span><span>
</span><span id="line-288"></span><span>        </span><span id="local-6989586621679918097"><span class="annot"><span class="annottext">needsTrace :: Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918097"><span class="hs-identifier hs-var hs-var">needsTrace</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[TxId (GenTx blk)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[TxId (GenTx blk)]
</span><a href="#local-6989586621679917895"><span class="hs-identifier hs-var">txIds</span></a></span><span>
</span><span id="line-289"></span><span>                         </span><span class="hs-keyword">then</span><span>
</span><span id="line-290"></span><span>                           </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-291"></span><span>                         </span><span class="hs-keyword">else</span><span>
</span><span id="line-292"></span><span>                           </span><span class="annot"><span class="annottext">TraceEventMempool blk -&gt; Maybe (TraceEventMempool blk)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEventMempool blk -&gt; Maybe (TraceEventMempool blk))
-&gt; TraceEventMempool blk -&gt; Maybe (TraceEventMempool blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[TxId (GenTx blk)]
-&gt; [Validated (GenTx blk)] -&gt; MempoolSize -&gt; TraceEventMempool blk
forall blk.
[GenTxId blk]
-&gt; [Validated (GenTx blk)] -&gt; MempoolSize -&gt; TraceEventMempool blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceMempoolManuallyRemovedTxs"><span class="hs-identifier hs-var">TraceMempoolManuallyRemovedTxs</span></a></span><span>
</span><span id="line-293"></span><span>                             </span><span class="annot"><span class="annottext">[TxId (GenTx blk)]
</span><a href="#local-6989586621679917895"><span class="hs-identifier hs-var">txIds</span></a></span><span>
</span><span id="line-294"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Validated (GenTx blk), ApplyTxErr blk) -&gt; Validated (GenTx blk))
-&gt; [(Validated (GenTx blk), ApplyTxErr blk)]
-&gt; [Validated (GenTx blk)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Validated (GenTx blk), ApplyTxErr blk) -&gt; Validated (GenTx blk)
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk
-&gt; [(Validated (GenTx blk), ApplyTxErr blk)]
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; [(invalidTx, ApplyTxErr blk)]
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#vrInvalid"><span class="hs-identifier hs-var">vrInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk
</span><a href="#local-6989586621679918092"><span class="hs-identifier hs-var">vr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolSize
forall blk. InternalState blk -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isMempoolSize"><span class="hs-identifier hs-var">isMempoolSize</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918095"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">InternalState blk -&gt; Maybe (TraceEventMempool blk) -&gt; RemoveTxs blk
forall blk.
InternalState blk -&gt; Maybe (TraceEventMempool blk) -&gt; RemoveTxs blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#WriteRemoveTxs"><span class="hs-identifier hs-var">WriteRemoveTxs</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918095"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918097"><span class="hs-identifier hs-var">needsTrace</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Sync with ledger
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- | A datatype containing the new state produced by syncing with the Ledger, a</span><span>
</span><span id="line-303"></span><span class="hs-comment">-- snapshot of that mempool state and, if needed, a tracing message.</span><span>
</span><span id="line-304"></span><span class="hs-keyword">data</span><span> </span><span id="SyncWithLedger"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#SyncWithLedger"><span class="hs-identifier hs-var">SyncWithLedger</span></a></span></span><span> </span><span id="local-6989586621679917237"><span class="annot"><a href="#local-6989586621679917237"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>    </span><span id="NewSyncedState"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#NewSyncedState"><span class="hs-identifier hs-var">NewSyncedState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917237"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917237"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceEventMempool"><span class="hs-identifier hs-type">TraceEventMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917237"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="annot"><span class="hs-comment">-- | See 'Ouroboros.Consensus.Mempool.API.syncWithLedger'.</span></span><span>
</span><span id="line-310"></span><span id="local-6989586621679917227"><span id="local-6989586621679917228"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#implSyncWithLedger"><span class="hs-identifier hs-type">implSyncWithLedger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-311"></span><span>     </span><span class="hs-special">(</span><span>
</span><span id="line-312"></span><span>       </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917227"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-313"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#LedgerSupportsMempool"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917228"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-314"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#HasTxId"><span class="hs-identifier hs-type">HasTxId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917228"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#ValidateEnvelope"><span class="hs-identifier hs-type">ValidateEnvelope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917228"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-316"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#MempoolEnv"><span class="hs-identifier hs-type">MempoolEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917227"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917228"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679917227"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917228"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-319"></span><span id="implSyncWithLedger"><span class="annot"><span class="annottext">implSyncWithLedger :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsMempool blk, HasTxId (GenTx blk),
 ValidateEnvelope blk) =&gt;
MempoolEnv m blk -&gt; m (MempoolSnapshot blk)
</span><a href="Ouroboros.Consensus.Mempool.Update.html#implSyncWithLedger"><span class="hs-identifier hs-var hs-var">implSyncWithLedger</span></a></span></span><span> </span><span id="local-6989586621679918175"><span class="annot"><span class="annottext">MempoolEnv m blk
</span><a href="#local-6989586621679918175"><span class="hs-identifier hs-var">menv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679918176"><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918176"><span class="hs-identifier hs-var">mTrace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679918177"><span class="annot"><span class="annottext">MempoolSnapshot blk
</span><a href="#local-6989586621679918177"><span class="hs-identifier hs-var">mp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Maybe (TraceEventMempool blk), MempoolSnapshot blk)
-&gt; m (Maybe (TraceEventMempool blk), MempoolSnapshot blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Maybe (TraceEventMempool blk), MempoolSnapshot blk)
 -&gt; m (Maybe (TraceEventMempool blk), MempoolSnapshot blk))
-&gt; STM m (Maybe (TraceEventMempool blk), MempoolSnapshot blk)
-&gt; m (Maybe (TraceEventMempool blk), MempoolSnapshot blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-321"></span><span>      </span><span id="local-6989586621679918178"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918178"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk) -&gt; STM m (InternalState blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679918179"><span class="hs-identifier hs-var">istate</span></a></span><span>
</span><span id="line-322"></span><span>      </span><span id="local-6989586621679918180"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679918180"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LedgerInterface m blk -&gt; STM m (LedgerState blk)
forall (m :: * -&gt; *) blk.
LedgerInterface m blk -&gt; STM m (LedgerState blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#getCurrentLedgerState"><span class="hs-identifier hs-var">getCurrentLedgerState</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerInterface m blk
</span><a href="#local-6989586621679918181"><span class="hs-identifier hs-var">ldgrInterface</span></a></span><span>
</span><span id="line-323"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#NewSyncedState"><span class="hs-identifier hs-type">NewSyncedState</span></a></span><span> </span><span id="local-6989586621679918279"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918279"><span class="hs-identifier hs-var">is'</span></a></span></span><span> </span><span id="local-6989586621679918280"><span class="annot"><span class="annottext">MempoolSnapshot blk
</span><a href="#local-6989586621679918280"><span class="hs-identifier hs-var">msp</span></a></span></span><span> </span><span id="local-6989586621679918281"><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918281"><span class="hs-identifier hs-var">mTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalState blk
-&gt; LedgerState blk
-&gt; LedgerCfg (LedgerState blk)
-&gt; MempoolCapacityBytesOverride
-&gt; SyncWithLedger blk
forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk),
 ValidateEnvelope blk) =&gt;
InternalState blk
-&gt; LedgerState blk
-&gt; LedgerConfig blk
-&gt; MempoolCapacityBytesOverride
-&gt; SyncWithLedger blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#pureSyncWithLedger"><span class="hs-identifier hs-var">pureSyncWithLedger</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918178"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679918180"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679918283"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679918284"><span class="hs-identifier hs-var">co</span></a></span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk) -&gt; InternalState blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679918179"><span class="hs-identifier hs-var">istate</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918279"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (TraceEventMempool blk), MempoolSnapshot blk)
-&gt; STM m (Maybe (TraceEventMempool blk), MempoolSnapshot blk)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918281"><span class="hs-identifier hs-var">mTrace</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk
</span><a href="#local-6989586621679918280"><span class="hs-identifier hs-var">msp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
-&gt; (TraceEventMempool blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918176"><span class="hs-identifier hs-var">mTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk) -&gt; TraceEventMempool blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk)
</span><a href="#local-6989586621679918285"><span class="hs-identifier hs-var">trcr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">MempoolSnapshot blk -&gt; m (MempoolSnapshot blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk
</span><a href="#local-6989586621679918177"><span class="hs-identifier hs-var">mp</span></a></span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#MempoolEnv"><span class="hs-identifier hs-type">MempoolEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mpEnvStateVar :: forall (m :: * -&gt; *) blk.
MempoolEnv m blk -&gt; StrictTVar m (InternalState blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvStateVar"><span class="hs-identifier hs-var">mpEnvStateVar</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679918179"><span class="annot"><span class="annottext">StrictTVar m (InternalState blk)
</span><a href="#local-6989586621679918179"><span class="hs-identifier hs-var">istate</span></a></span></span><span>
</span><span id="line-330"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvLedger :: forall (m :: * -&gt; *) blk. MempoolEnv m blk -&gt; LedgerInterface m blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvLedger"><span class="hs-identifier hs-var">mpEnvLedger</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679918181"><span class="annot"><span class="annottext">LedgerInterface m blk
</span><a href="#local-6989586621679918181"><span class="hs-identifier hs-var">ldgrInterface</span></a></span></span><span>
</span><span id="line-331"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvTracer :: forall (m :: * -&gt; *) blk.
MempoolEnv m blk -&gt; Tracer m (TraceEventMempool blk)
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvTracer"><span class="hs-identifier hs-var">mpEnvTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679918285"><span class="annot"><span class="annottext">Tracer m (TraceEventMempool blk)
</span><a href="#local-6989586621679918285"><span class="hs-identifier hs-var">trcr</span></a></span></span><span>
</span><span id="line-332"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvLedgerCfg :: forall (m :: * -&gt; *) blk. MempoolEnv m blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvLedgerCfg"><span class="hs-identifier hs-var">mpEnvLedgerCfg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679918283"><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679918283"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-333"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">mpEnvCapacityOverride :: forall (m :: * -&gt; *) blk.
MempoolEnv m blk -&gt; MempoolCapacityBytesOverride
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#mpEnvCapacityOverride"><span class="hs-identifier hs-var">mpEnvCapacityOverride</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679918284"><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679918284"><span class="hs-identifier hs-var">co</span></a></span></span><span>
</span><span id="line-334"></span><span>               </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolEnv m blk
</span><a href="#local-6989586621679918175"><span class="hs-identifier hs-var">menv</span></a></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">-- | Create a 'SyncWithLedger' value representing the values that will need to</span><span>
</span><span id="line-337"></span><span class="hs-comment">-- be stored for committing this synchronization with the Ledger.</span><span>
</span><span id="line-338"></span><span class="hs-comment">--</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- See the documentation of 'runSyncWithLedger' for more context.</span><span>
</span><span id="line-340"></span><span id="local-6989586621679917233"><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#pureSyncWithLedger"><span class="hs-identifier hs-type">pureSyncWithLedger</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-341"></span><span>     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#LedgerSupportsMempool"><span class="hs-identifier hs-type">LedgerSupportsMempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917233"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#HasTxId"><span class="hs-identifier hs-type">HasTxId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917233"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#ValidateEnvelope"><span class="hs-identifier hs-type">ValidateEnvelope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917233"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#InternalState"><span class="hs-identifier hs-type">InternalState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917233"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917233"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerConfig"><span class="hs-identifier hs-type">LedgerConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917233"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Capacity.html#MempoolCapacityBytesOverride"><span class="hs-identifier hs-type">MempoolCapacityBytesOverride</span></a></span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Update.html#SyncWithLedger"><span class="hs-identifier hs-type">SyncWithLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679917233"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-347"></span><span id="pureSyncWithLedger"><span class="annot"><span class="annottext">pureSyncWithLedger :: forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk),
 ValidateEnvelope blk) =&gt;
InternalState blk
-&gt; LedgerState blk
-&gt; LedgerConfig blk
-&gt; MempoolCapacityBytesOverride
-&gt; SyncWithLedger blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#pureSyncWithLedger"><span class="hs-identifier hs-var hs-var">pureSyncWithLedger</span></a></span></span><span> </span><span id="local-6989586621679918336"><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918336"><span class="hs-identifier hs-var">istate</span></a></span></span><span> </span><span id="local-6989586621679918337"><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679918337"><span class="hs-identifier hs-var">lstate</span></a></span></span><span> </span><span id="local-6989586621679918338"><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679918338"><span class="hs-identifier hs-var">lcfg</span></a></span></span><span> </span><span id="local-6989586621679918339"><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679918339"><span class="hs-identifier hs-var">capacityOverride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679918437"><span class="annot"><span class="annottext">vr :: ValidationResult (Validated (GenTx blk)) blk
</span><a href="#local-6989586621679918437"><span class="hs-identifier hs-var hs-var">vr</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
-&gt; LedgerCfg (LedgerState blk)
-&gt; ForgeLedgerState blk
-&gt; InternalState blk
-&gt; ValidationResult (Validated (GenTx blk)) blk
forall blk.
(LedgerSupportsMempool blk, HasTxId (GenTx blk),
 ValidateEnvelope blk) =&gt;
MempoolCapacityBytesOverride
-&gt; LedgerConfig blk
-&gt; ForgeLedgerState blk
-&gt; InternalState blk
-&gt; ValidationResult (Validated (GenTx blk)) blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#validateStateFor"><span class="hs-identifier hs-var">validateStateFor</span></a></span><span>
</span><span id="line-349"></span><span>                        </span><span class="annot"><span class="annottext">MempoolCapacityBytesOverride
</span><a href="#local-6989586621679918339"><span class="hs-identifier hs-var">capacityOverride</span></a></span><span>
</span><span id="line-350"></span><span>                        </span><span class="annot"><span class="annottext">LedgerCfg (LedgerState blk)
</span><a href="#local-6989586621679918338"><span class="hs-identifier hs-var">lcfg</span></a></span><span>
</span><span id="line-351"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerState blk -&gt; ForgeLedgerState blk
forall blk. LedgerState blk -&gt; ForgeLedgerState blk
</span><a href="Ouroboros.Consensus.Mempool.API.html#ForgeInUnknownSlot"><span class="hs-identifier hs-var">ForgeInUnknownSlot</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerState blk
</span><a href="#local-6989586621679918337"><span class="hs-identifier hs-var">lstate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>                        </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918336"><span class="hs-identifier hs-var">istate</span></a></span><span>
</span><span id="line-353"></span><span>        </span><span id="local-6989586621679918439"><span class="annot"><span class="annottext">removed :: [(Validated (GenTx blk), ApplyTxErr blk)]
</span><a href="#local-6989586621679918439"><span class="hs-identifier hs-var hs-var">removed</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk
-&gt; [(Validated (GenTx blk), ApplyTxErr blk)]
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; [(invalidTx, ApplyTxErr blk)]
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#vrInvalid"><span class="hs-identifier hs-var">vrInvalid</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk
</span><a href="#local-6989586621679918437"><span class="hs-identifier hs-var">vr</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span id="local-6989586621679918440"><span class="annot"><span class="annottext">istate' :: InternalState blk
</span><a href="#local-6989586621679918440"><span class="hs-identifier hs-var hs-var">istate'</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk -&gt; InternalState blk
forall invalidTx blk.
ValidationResult invalidTx blk -&gt; InternalState blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#internalStateFromVR"><span class="hs-identifier hs-var">internalStateFromVR</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationResult (Validated (GenTx blk)) blk
</span><a href="#local-6989586621679918437"><span class="hs-identifier hs-var">vr</span></a></span><span>
</span><span id="line-355"></span><span>        </span><span id="local-6989586621679918442"><span class="annot"><span class="annottext">mTrace :: Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918442"><span class="hs-identifier hs-var hs-var">mTrace</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[(Validated (GenTx blk), ApplyTxErr blk)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[(Validated (GenTx blk), ApplyTxErr blk)]
</span><a href="#local-6989586621679918439"><span class="hs-identifier hs-var">removed</span></a></span><span>
</span><span id="line-356"></span><span>                      </span><span class="hs-keyword">then</span><span>
</span><span id="line-357"></span><span>                        </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-358"></span><span>                      </span><span class="hs-keyword">else</span><span>
</span><span id="line-359"></span><span>                        </span><span class="annot"><span class="annottext">TraceEventMempool blk -&gt; Maybe (TraceEventMempool blk)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEventMempool blk -&gt; Maybe (TraceEventMempool blk))
-&gt; TraceEventMempool blk -&gt; Maybe (TraceEventMempool blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(Validated (GenTx blk), ApplyTxErr blk)]
-&gt; MempoolSize -&gt; TraceEventMempool blk
forall blk.
[(Validated (GenTx blk), ApplyTxErr blk)]
-&gt; MempoolSize -&gt; TraceEventMempool blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#TraceMempoolRemoveTxs"><span class="hs-identifier hs-var">TraceMempoolRemoveTxs</span></a></span><span> </span><span class="annot"><span class="annottext">[(Validated (GenTx blk), ApplyTxErr blk)]
</span><a href="#local-6989586621679918439"><span class="hs-identifier hs-var">removed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolSize
forall blk. InternalState blk -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#isMempoolSize"><span class="hs-identifier hs-var">isMempoolSize</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918440"><span class="hs-identifier hs-var">istate'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>        </span><span id="local-6989586621679918449"><span class="annot"><span class="annottext">snapshot :: MempoolSnapshot blk
</span><a href="#local-6989586621679918449"><span class="hs-identifier hs-var hs-var">snapshot</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalState blk -&gt; MempoolSnapshot blk
forall blk.
HasTxId (GenTx blk) =&gt;
InternalState blk -&gt; MempoolSnapshot blk
</span><a href="Ouroboros.Consensus.Mempool.Impl.Common.html#snapshotFromIS"><span class="hs-identifier hs-var">snapshotFromIS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918440"><span class="hs-identifier hs-var">istate'</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><span class="annottext">InternalState blk
-&gt; MempoolSnapshot blk
-&gt; Maybe (TraceEventMempool blk)
-&gt; SyncWithLedger blk
forall blk.
InternalState blk
-&gt; MempoolSnapshot blk
-&gt; Maybe (TraceEventMempool blk)
-&gt; SyncWithLedger blk
</span><a href="Ouroboros.Consensus.Mempool.Update.html#NewSyncedState"><span class="hs-identifier hs-var">NewSyncedState</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk
</span><a href="#local-6989586621679918440"><span class="hs-identifier hs-var">istate'</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolSnapshot blk
</span><a href="#local-6989586621679918449"><span class="hs-identifier hs-var">snapshot</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TraceEventMempool blk)
</span><a href="#local-6989586621679918442"><span class="hs-identifier hs-var">mTrace</span></a></span><span>
</span><span id="line-363"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds           #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass            #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric             #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE GADTs                     #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase                #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf                #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns            #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings         #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE QuantifiedConstraints     #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes                #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards           #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables       #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE TupleSections             #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications          #-}</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- | Volatile on-disk database of blocks</span><span>
</span><span id="line-18"></span><span class="hs-comment">--</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- = Logic</span><span>
</span><span id="line-20"></span><span class="hs-comment">--</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- The VolatileDB is a key-value store of blocks indexed by their hashes. It is</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- parameterised by the block type @blk@.</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- The \&quot;volatile\&quot; in the name refers to the fact that the blocks stored in it</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- make up the /volatile/ part of the chain, i.e., the last @k@ blocks of the</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- chain, which can still be rolled back. Not only the last @k@ blocks of the</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- current chain are stored in this database, but also blocks of forks which we</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- have switched from or will switch to.</span><span>
</span><span id="line-29"></span><span class="hs-comment">--</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- The VolatileDB appends new blocks sequentially to a file. When</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- 'volMaxBlocksPerFile' are stored in the current file, a new file is started.</span><span>
</span><span id="line-32"></span><span class="hs-comment">--</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- The VolatileDB provides four main operations:</span><span>
</span><span id="line-34"></span><span class="hs-comment">--</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- 1. Adding blocks with 'putBlock'</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- 2. Get blocks or information about them with 'getBlockComponent'</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- 3. Accessing the in-memory indices using 'getBlockInfo' and</span><span>
</span><span id="line-38"></span><span class="hs-comment">--   'filterByPredecessor'</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- 4. Garbage collecting blocks older than a given slot using 'garbageCollect'</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- Garbage collection will only delete a file from the VolatileDB when all</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- blocks in it have a slot older than the one passed to 'garbageCollect'.</span><span>
</span><span id="line-43"></span><span class="hs-comment">--</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- = Errors</span><span>
</span><span id="line-45"></span><span class="hs-comment">--</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- When an exception occurs while modifying the VolatileDB, we close the</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- database as a safety measure, e.g., in case a file could not be written to</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- disk, as we can no longer make sure the in-memory indices match what's stored</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- on the file system. When reopening, we validate the blocks stored in the file</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- system and reconstruct the in-memory indices.</span><span>
</span><span id="line-51"></span><span class="hs-comment">--</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- NOTE: this means that when a thread modifying the VolatileDB is killed, the</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- database will be closed. This is an intentional choice to simplify things.</span><span>
</span><span id="line-54"></span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- The in-memory indices can always be reconstructed from the file system.</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- This is important, as we must be resilient against unexpected shutdowns,</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- power losses, etc.</span><span>
</span><span id="line-58"></span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- We achieve this by only performing basic operations on the VolatileDB:</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- * 'putBlock' only appends a new block to a file. Losing an update means we</span><span>
</span><span id="line-61"></span><span class="hs-comment">--   only lose a block, which is not a problem, it can be redownloaded.</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- * 'garbageCollect' only deletes entire files.</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- * There is no operation that modifies a file in-place. This means we do not</span><span>
</span><span id="line-64"></span><span class="hs-comment">--   have to keep any rollback journals to make sure we are safe in case of</span><span>
</span><span id="line-65"></span><span class="hs-comment">--   unexpected shutdowns.</span><span>
</span><span id="line-66"></span><span class="hs-comment">--</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- We only throw 'VolatileDBError'. File-system errors are caught, wrapped in a</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- 'VolatileDBError', and rethrown. We make sure that all calls to 'HasFS'</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- functions are properly wrapped. This wrapping is automatically done when</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- inside the scope of 'modifyOpenState' and 'withOpenState'. Otherwise, we use</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- 'wrapFsError'.</span><span>
</span><span id="line-72"></span><span class="hs-comment">--</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- = Concurrency</span><span>
</span><span id="line-74"></span><span class="hs-comment">--</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- A single folder should only be used by a single VolatileDB. Naturally, a</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- VolatileDB can be accessed concurrently by multiple threads.</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- = File-system layout:</span><span>
</span><span id="line-79"></span><span class="hs-comment">--</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- The on-disk representation is as follows:</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- &gt; dbFolder/</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- &gt;   blocks-0.dat</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- &gt;   blocks-1.dat</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- &gt;   ...</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- Files not fitting the naming scheme are ignored. The numbering of these</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- files does not correlate to the blocks stored in them.</span><span>
</span><span id="line-89"></span><span class="hs-comment">--</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- Each file stores a fixed number of blocks, specified by</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- 'volMaxBlocksPerFile'. When opening the VolatileDB, it will start appending</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- to the file with the highest number that is not yet full. If all are full or</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- none exist, a new file will be created.</span><span>
</span><span id="line-94"></span><span class="hs-comment">--</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- There is an implicit ordering of block files, which is NOT alpharithmetic.</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- For example, @blocks-20.dat@ &lt; @blocks-100.dat@.</span><span>
</span><span id="line-97"></span><span class="hs-comment">--</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- = Recovery</span><span>
</span><span id="line-99"></span><span class="hs-comment">--</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- The VolatileDB will always try to recover to a consistent state even if this</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- means deleting all of its contents. In order to achieve this, it truncates</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- the files containing blocks if some blocks fail to parse, are invalid, or are</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- duplicated.</span><span>
</span><span id="line-104"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Opening the database</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier">VolatileDbArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbSerialiseConstraints"><span class="hs-identifier">VolatileDbSerialiseConstraints</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#defaultArgs"><span class="hs-identifier">defaultArgs</span></a></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#openDB"><span class="hs-identifier">openDB</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-exported</span></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockValidationPolicy"><span class="hs-identifier">BlockValidationPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlocksPerFile"><span class="hs-identifier">BlocksPerFile</span></a></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ParseError"><span class="hs-identifier">ParseError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#TraceEvent"><span class="hs-identifier">TraceEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser.html#extractBlockInfo"><span class="hs-identifier">extractBlockInfo</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#mkBlocksPerFile"><span class="hs-identifier">mkBlocksPerFile</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Read</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Write</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Strict.html"><span class="hs-identifier">Control.Monad.State.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier">get</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier">gets</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier">modify</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#put"><span class="hs-identifier">put</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-123"></span><span>                     </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#state"><span class="hs-identifier">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nullTracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lazy</span></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#foldl%27"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#mapMaybe"><span class="hs-identifier">mapMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier">BlockComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Serialisation</span></a></span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.API</span></a></span><span>
</span><span id="line-137"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#FileInfo"><span class="hs-identifier">FileInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FileInfo</span></span><span>
</span><span id="line-139"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Index</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Index</span></span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser</span></a></span><span>
</span><span id="line-141"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.State</span></a></span><span>
</span><span id="line-142"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Types</span></a></span><span>
</span><span id="line-143"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB.Impl.Util</span></a></span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Args</span></a></span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-146"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html"><span class="hs-identifier">Ouroboros.Consensus.Util.MonadSTM.RAWLock</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">RAWLock</span></span><span>
</span><span id="line-147"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span>
</span><span id="line-148"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MaxSlotNo</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API.Lazy</span></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-comment">{------------------------------------------------------------------------------
  Opening the database
------------------------------------------------------------------------------}</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-keyword">data</span><span> </span><span id="VolatileDbArgs"><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-var">VolatileDbArgs</span></a></span></span><span> </span><span id="local-6989586621679856723"><span class="annot"><a href="#local-6989586621679856723"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679856724"><span class="annot"><a href="#local-6989586621679856724"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856725"><span class="annot"><a href="#local-6989586621679856725"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="VolatileDbArgs"><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-var">VolatileDbArgs</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-156"></span><span>      </span><span id="volCheckIntegrity"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; HKD f (blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volCheckIntegrity"><span class="hs-identifier hs-var hs-var">volCheckIntegrity</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856723"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679856725"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="volCodecConfig"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; HKD f (CodecConfig blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volCodecConfig"><span class="hs-identifier hs-var hs-var">volCodecConfig</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856723"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#CodecConfig"><span class="hs-identifier hs-type">CodecConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856725"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="volHasFS"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; SomeHasFS m
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volHasFS"><span class="hs-identifier hs-var hs-var">volHasFS</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679856724"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="volMaxBlocksPerFile"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; BlocksPerFile
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volMaxBlocksPerFile"><span class="hs-identifier hs-var hs-var">volMaxBlocksPerFile</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlocksPerFile"><span class="hs-identifier hs-type">BlocksPerFile</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="volTracer"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volTracer"><span class="hs-identifier hs-var hs-var">volTracer</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679856724"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#TraceEvent"><span class="hs-identifier hs-type">TraceEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856725"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="volValidationPolicy"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; BlockValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volValidationPolicy"><span class="hs-identifier hs-var hs-var">volValidationPolicy</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockValidationPolicy"><span class="hs-identifier hs-type">BlockValidationPolicy</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="annot"><span class="hs-comment">-- | Default arguments</span></span><span>
</span><span id="line-165"></span><span id="local-6989586621679856752"><span id="local-6989586621679856754"><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#defaultArgs"><span class="hs-identifier hs-type">defaultArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Applicative"><span class="hs-identifier hs-type">Applicative</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856752"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679856752"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-type">VolatileDbArgs</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#Defaults"><span class="hs-identifier hs-type">Defaults</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856752"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856754"><span class="hs-identifier hs-type">blk</span></a></span></span></span><span>
</span><span id="line-166"></span><span id="defaultArgs"><span class="annot"><span class="annottext">defaultArgs :: forall (m :: * -&gt; *) blk.
Applicative m =&gt;
SomeHasFS m -&gt; VolatileDbArgs Defaults m blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#defaultArgs"><span class="hs-identifier hs-var hs-var">defaultArgs</span></a></span></span><span> </span><span id="local-6989586621679857184"><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679857184"><span class="hs-identifier hs-var">volHasFS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-type">VolatileDbArgs</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="annottext">volCheckIntegrity :: HKD Defaults (blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volCheckIntegrity"><span class="hs-identifier hs-var">volCheckIntegrity</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Defaults (blk -&gt; Bool)
Defaults (blk -&gt; Bool)
forall t. Defaults t
</span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">volCodecConfig :: HKD Defaults (CodecConfig blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volCodecConfig"><span class="hs-identifier hs-var">volCodecConfig</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Defaults (CodecConfig blk)
Defaults (CodecConfig blk)
forall t. Defaults t
</span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
volHasFS :: SomeHasFS m
volHasFS :: SomeHasFS m
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volHasFS"><span class="hs-identifier hs-var hs-var">volHasFS</span></a></span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">volMaxBlocksPerFile :: BlocksPerFile
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volMaxBlocksPerFile"><span class="hs-identifier hs-var">volMaxBlocksPerFile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; BlocksPerFile
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#mkBlocksPerFile"><span class="hs-identifier hs-var">mkBlocksPerFile</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">volTracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volTracer"><span class="hs-identifier hs-var">volTracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">volValidationPolicy :: BlockValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volValidationPolicy"><span class="hs-identifier hs-var">volValidationPolicy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#NoValidation"><span class="hs-identifier hs-var">NoValidation</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="annot"><span class="hs-comment">-- | 'EncodeDisk' and 'DecodeDisk' constraints needed for the VolatileDB.</span></span><span>
</span><span id="line-176"></span><span class="hs-keyword">type</span><span> </span><span id="VolatileDbSerialiseConstraints"><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbSerialiseConstraints"><span class="hs-identifier hs-var">VolatileDbSerialiseConstraints</span></a></span></span><span> </span><span id="local-6989586621679857187"><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#EncodeDisk"><span class="hs-identifier hs-type">EncodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#HasNestedContent"><span class="hs-identifier hs-type">HasNestedContent</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857187"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#openDB"><span class="hs-identifier hs-type">openDB</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-185"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856761"><span class="annot"><a href="#local-6989586621679856761"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856763"><span class="annot"><a href="#local-6989586621679856763"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679856770"><span class="annot"><a href="#local-6989586621679856770"><span class="hs-identifier hs-type">ans</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-186"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-187"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856761"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-188"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856763"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-189"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbSerialiseConstraints"><span class="hs-identifier hs-type">VolatileDbSerialiseConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856763"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-190"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-type">VolatileDbArgs</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856761"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856763"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856767"><span class="annot"><a href="#local-6989586621679856767"><span class="hs-identifier hs-type">st</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856767"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856761"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-type">VolatileDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856761"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856763"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679856767"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856770"><span class="hs-identifier hs-type">ans</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856770"><span class="hs-identifier hs-type">ans</span></a></span><span>
</span><span id="line-194"></span><span id="openDB"><span class="annot"><span class="annottext">openDB :: forall (m :: * -&gt; *) blk ans.
(HasCallStack, IOLike m, GetPrevHash blk,
 VolatileDbSerialiseConstraints blk) =&gt;
VolatileDbArgs Identity m blk
-&gt; (forall st. WithTempRegistry st m (VolatileDB m blk, st) -&gt; ans)
-&gt; ans
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#openDB"><span class="hs-identifier hs-var hs-var">openDB</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbArgs"><span class="hs-identifier hs-type">VolatileDbArgs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">volHasFS :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; SomeHasFS m
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volHasFS"><span class="hs-identifier hs-var">volHasFS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span id="local-6989586621679857233"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857233"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857234"><span id="local-6989586621679857235"><span id="local-6989586621679857236"><span id="local-6989586621679857237"><span id="local-6989586621679857238"><span class="annot"><span class="annottext">HKD Identity (CodecConfig blk)
HKD Identity (blk -&gt; Bool)
Tracer m (TraceEvent blk)
BlockValidationPolicy
BlocksPerFile
volMaxBlocksPerFile :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; BlocksPerFile
volCheckIntegrity :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; HKD f (blk -&gt; Bool)
volCodecConfig :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; HKD f (CodecConfig blk)
volTracer :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; Tracer m (TraceEvent blk)
volValidationPolicy :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
VolatileDbArgs f m blk -&gt; BlockValidationPolicy
volCheckIntegrity :: HKD Identity (blk -&gt; Bool)
volCodecConfig :: HKD Identity (CodecConfig blk)
volMaxBlocksPerFile :: BlocksPerFile
volTracer :: Tracer m (TraceEvent blk)
volValidationPolicy :: BlockValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#volMaxBlocksPerFile"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679857239"><span class="annot"><span class="annottext">forall st. WithTempRegistry st m (VolatileDB m blk, st) -&gt; ans
</span><a href="#local-6989586621679857239"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry
  (OpenState blk h) m (VolatileDB m blk, OpenState blk h)
-&gt; ans
forall st. WithTempRegistry st m (VolatileDB m blk, st) -&gt; ans
</span><a href="#local-6989586621679857239"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry
   (OpenState blk h) m (VolatileDB m blk, OpenState blk h)
 -&gt; ans)
-&gt; WithTempRegistry
     (OpenState blk h) m (VolatileDB m blk, OpenState blk h)
-&gt; ans
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
</span><span class="hs-identifier hs-var">createDirectoryIfMissing</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857233"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; FsPath
</span><span class="hs-identifier hs-var">mkFsPath</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621679857242"><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857242"><span class="hs-identifier hs-var">ost</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
-&gt; HasFS m h
-&gt; (blk -&gt; Bool)
-&gt; BlockValidationPolicy
-&gt; Tracer m (TraceEvent blk)
-&gt; BlocksPerFile
-&gt; WithTempRegistry (OpenState blk h) m (OpenState blk h)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 HasNestedContent Header blk, DecodeDisk blk (ByteString -&gt; blk),
 Eq h) =&gt;
CodecConfig blk
-&gt; HasFS m h
-&gt; (blk -&gt; Bool)
-&gt; BlockValidationPolicy
-&gt; Tracer m (TraceEvent blk)
-&gt; BlocksPerFile
-&gt; WithTempRegistry (OpenState blk h) m (OpenState blk h)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#mkOpenState"><span class="hs-identifier hs-var">mkOpenState</span></a></span><span>
</span><span id="line-197"></span><span>               </span><span class="annot"><span class="annottext">HKD Identity (CodecConfig blk)
CodecConfig blk
</span><a href="#local-6989586621679857235"><span class="hs-identifier hs-var">volCodecConfig</span></a></span><span>
</span><span id="line-198"></span><span>               </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857233"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-199"></span><span>               </span><span class="annot"><span class="annottext">HKD Identity (blk -&gt; Bool)
blk -&gt; Bool
</span><a href="#local-6989586621679857234"><span class="hs-identifier hs-var">volCheckIntegrity</span></a></span><span>
</span><span id="line-200"></span><span>               </span><span class="annot"><span class="annottext">BlockValidationPolicy
</span><a href="#local-6989586621679857238"><span class="hs-identifier hs-var">volValidationPolicy</span></a></span><span>
</span><span id="line-201"></span><span>               </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679857237"><span class="hs-identifier hs-var">volTracer</span></a></span><span>
</span><span id="line-202"></span><span>               </span><span class="annot"><span class="annottext">BlocksPerFile
</span><a href="#local-6989586621679857236"><span class="hs-identifier hs-var">volMaxBlocksPerFile</span></a></span><span>
</span><span id="line-203"></span><span>    </span><span id="local-6989586621679857244"><span class="annot"><span class="annottext">RAWLock m (InternalState blk h)
</span><a href="#local-6989586621679857244"><span class="hs-identifier hs-var">stVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (RAWLock m (InternalState blk h))
-&gt; WithTempRegistry
     (OpenState blk h) m (RAWLock m (InternalState blk h))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (RAWLock m (InternalState blk h))
 -&gt; WithTempRegistry
      (OpenState blk h) m (RAWLock m (InternalState blk h)))
-&gt; m (RAWLock m (InternalState blk h))
-&gt; WithTempRegistry
     (OpenState blk h) m (RAWLock m (InternalState blk h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState blk h -&gt; m (RAWLock m (InternalState blk h))
forall (m :: * -&gt; *) st.
(IOLike m, NoThunks st) =&gt;
st -&gt; m (RAWLock m st)
</span><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html#new"><span class="hs-identifier hs-var">RAWLock.new</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpenState blk h -&gt; InternalState blk h
forall blk h. OpenState blk h -&gt; InternalState blk h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857242"><span class="hs-identifier hs-var">ost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679857247"><span class="annot"><span class="annottext">env :: VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-205"></span><span>            </span><span class="annot"><span class="annottext">hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#hasFS"><span class="hs-identifier hs-var">hasFS</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857233"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-206"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varInternalState :: RAWLock m (InternalState blk h)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#varInternalState"><span class="hs-identifier hs-var">varInternalState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RAWLock m (InternalState blk h)
</span><a href="#local-6989586621679857244"><span class="hs-identifier hs-var">stVar</span></a></span><span>
</span><span id="line-207"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">maxBlocksPerFile :: BlocksPerFile
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#maxBlocksPerFile"><span class="hs-identifier hs-var">maxBlocksPerFile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlocksPerFile
</span><a href="#local-6989586621679857236"><span class="hs-identifier hs-var">volMaxBlocksPerFile</span></a></span><span>
</span><span id="line-208"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#tracer"><span class="hs-identifier hs-var">tracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679857237"><span class="hs-identifier hs-var">volTracer</span></a></span><span>
</span><span id="line-209"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">codecConfig :: CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#codecConfig"><span class="hs-identifier hs-var">codecConfig</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity (CodecConfig blk)
CodecConfig blk
</span><a href="#local-6989586621679857235"><span class="hs-identifier hs-var">volCodecConfig</span></a></span><span>
</span><span id="line-210"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checkIntegrity :: blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#checkIntegrity"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity (blk -&gt; Bool)
blk -&gt; Bool
</span><a href="#local-6989586621679857234"><span class="hs-identifier hs-var">volCheckIntegrity</span></a></span><span>
</span><span id="line-211"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-212"></span><span>        </span><span id="local-6989586621679857255"><span class="annot"><span class="annottext">volatileDB :: VolatileDB m blk
</span><a href="#local-6989586621679857255"><span class="hs-identifier hs-var hs-var">volatileDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#VolatileDB"><span class="hs-identifier hs-type">VolatileDB</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-213"></span><span>            </span><span class="annot"><span class="annottext">closeDB :: HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#closeDB"><span class="hs-identifier hs-var">closeDB</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#closeDBImpl"><span class="hs-identifier hs-var">closeDBImpl</span></a></span><span>             </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-214"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getBlockComponent :: forall b.
HasCallStack =&gt;
BlockComponent blk b -&gt; HeaderHash blk -&gt; m (Maybe b)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getBlockComponent"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
-&gt; BlockComponent blk b -&gt; HeaderHash blk -&gt; m (Maybe b)
forall (m :: * -&gt; *) blk b.
(IOLike m, HasHeader blk, DecodeDisk blk (ByteString -&gt; blk),
 HasNestedContent Header blk, DecodeDiskDep (NestedCtxt Header) blk,
 HasCallStack) =&gt;
VolatileDBEnv m blk
-&gt; BlockComponent blk b -&gt; HeaderHash blk -&gt; m (Maybe b)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier hs-var">getBlockComponentImpl</span></a></span><span>   </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-215"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">putBlock :: HasCallStack =&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#putBlock"><span class="hs-identifier hs-var">putBlock</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk -&gt; blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(GetPrevHash blk, EncodeDisk blk blk, HasBinaryBlockInfo blk,
 HasNestedContent Header blk, IOLike m) =&gt;
VolatileDBEnv m blk -&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#putBlockImpl"><span class="hs-identifier hs-var">putBlockImpl</span></a></span><span>            </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-216"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">garbageCollect :: HasCallStack =&gt; SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#garbageCollect"><span class="hs-identifier hs-var">garbageCollect</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk -&gt; SlotNo -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk -&gt; SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectImpl"><span class="hs-identifier hs-var">garbageCollectImpl</span></a></span><span>      </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-217"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">filterByPredecessor :: HasCallStack =&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#filterByPredecessor"><span class="hs-identifier hs-var">filterByPredecessor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#filterByPredecessorImpl"><span class="hs-identifier hs-var">filterByPredecessorImpl</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-218"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getBlockInfo :: HasCallStack =&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getBlockInfo"><span class="hs-identifier hs-var">getBlockInfo</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
-&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk
-&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockInfoImpl"><span class="hs-identifier hs-var">getBlockInfoImpl</span></a></span><span>        </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-219"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getMaxSlotNo :: HasCallStack =&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#getMaxSlotNo"><span class="hs-identifier hs-var">getMaxSlotNo</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk -&gt; STM m MaxSlotNo
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getMaxSlotNoImpl"><span class="hs-identifier hs-var">getMaxSlotNoImpl</span></a></span><span>        </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857247"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-220"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><span class="annottext">(VolatileDB m blk, OpenState blk h)
-&gt; WithTempRegistry
     (OpenState blk h) m (VolatileDB m blk, OpenState blk h)
forall a. a -&gt; WithTempRegistry (OpenState blk h) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679857255"><span class="hs-identifier hs-var">volatileDB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857242"><span class="hs-identifier hs-var">ost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">{------------------------------------------------------------------------------
  VolatileDB API
------------------------------------------------------------------------------}</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#closeDBImpl"><span class="hs-identifier hs-type">closeDBImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-228"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856832"><span class="annot"><a href="#local-6989586621679856832"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856833"><span class="annot"><a href="#local-6989586621679856833"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856832"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679856833"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856832"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856833"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856832"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span id="closeDBImpl"><span class="annot"><span class="annottext">closeDBImpl :: forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#closeDBImpl"><span class="hs-identifier hs-var hs-var">closeDBImpl</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857310"><span class="annot"><span class="annottext">RAWLock m (InternalState blk h)
varInternalState :: ()
varInternalState :: RAWLock m (InternalState blk h)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#varInternalState"><span class="hs-identifier hs-var hs-var">varInternalState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857311"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
tracer :: forall (m :: * -&gt; *) blk.
VolatileDBEnv m blk -&gt; Tracer m (TraceEvent blk)
tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857312"><span class="annot"><span class="annottext">HasFS m h
hasFS :: ()
hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621679857313"><span class="annot"><span class="annottext">InternalState blk h
</span><a href="#local-6989586621679857313"><span class="hs-identifier hs-var">mbInternalState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-233"></span><span>      </span><span class="annot"><span class="annottext">RAWLock m (InternalState blk h)
-&gt; (InternalState blk h
    -&gt; m (InternalState blk h, InternalState blk h))
-&gt; m (InternalState blk h)
forall (m :: * -&gt; *) st a.
IOLike m =&gt;
RAWLock m st -&gt; (st -&gt; m (st, a)) -&gt; m a
</span><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html#withWriteAccess"><span class="hs-identifier hs-var">RAWLock.withWriteAccess</span></a></span><span> </span><span class="annot"><span class="annottext">RAWLock m (InternalState blk h)
</span><a href="#local-6989586621679857310"><span class="hs-identifier hs-var">varInternalState</span></a></span><span> </span><span class="annot"><span class="annottext">((InternalState blk h
  -&gt; m (InternalState blk h, InternalState blk h))
 -&gt; m (InternalState blk h))
-&gt; (InternalState blk h
    -&gt; m (InternalState blk h, InternalState blk h))
-&gt; m (InternalState blk h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857315"><span class="annot"><span class="annottext">InternalState blk h
</span><a href="#local-6989586621679857315"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(InternalState blk h, InternalState blk h)
-&gt; m (InternalState blk h, InternalState blk h)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InternalState blk h
forall blk h. InternalState blk h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InternalState blk h
</span><a href="#local-6989586621679857315"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InternalState blk h
</span><a href="#local-6989586621679857313"><span class="hs-identifier hs-var">mbInternalState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><span class="annottext">InternalState blk h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679857311"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">TraceEvent blk
forall blk. TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#DBAlreadyClosed"><span class="hs-identifier hs-var">DBAlreadyClosed</span></a></span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-type">DbOpen</span></a></span><span> </span><span id="local-6989586621679857318"><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857318"><span class="hs-identifier hs-var">ost</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>        </span><span class="annot"><span class="annottext">Proxy blk -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) a blk.
(MonadCatch m, StandardHash blk, Typeable blk) =&gt;
Proxy blk -&gt; m a -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#wrapFsError"><span class="hs-identifier hs-var">wrapFsError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679856833"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; OpenState blk h -&gt; m ()
forall (m :: * -&gt; *) h blk. HasFS m h -&gt; OpenState blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#closeOpenHandles"><span class="hs-identifier hs-var">closeOpenHandles</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857312"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857318"><span class="hs-identifier hs-var">ost</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier hs-type">getBlockComponentImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-240"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856835"><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856836"><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679856837"><span class="annot"><a href="#local-6989586621679856837"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-241"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-242"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-243"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#HasNestedContent"><span class="hs-identifier hs-type">HasNestedContent</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-245"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-246"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-247"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856837"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856837"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span id="getBlockComponentImpl"><span class="annot"><span class="annottext">getBlockComponentImpl :: forall (m :: * -&gt; *) blk b.
(IOLike m, HasHeader blk, DecodeDisk blk (ByteString -&gt; blk),
 HasNestedContent Header blk, DecodeDiskDep (NestedCtxt Header) blk,
 HasCallStack) =&gt;
VolatileDBEnv m blk
-&gt; BlockComponent blk b -&gt; HeaderHash blk -&gt; m (Maybe b)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier hs-var hs-var">getBlockComponentImpl</span></a></span></span><span> </span><span id="local-6989586621679857339"><span class="annot"><span class="annottext">env :: VolatileDBEnv m blk
</span><a href="#local-6989586621679857339"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857344"><span class="annot"><span class="annottext">CodecConfig blk
codecConfig :: forall (m :: * -&gt; *) blk. VolatileDBEnv m blk -&gt; CodecConfig blk
codecConfig :: CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#codecConfig"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857345"><span class="annot"><span class="annottext">blk -&gt; Bool
checkIntegrity :: forall (m :: * -&gt; *) blk. VolatileDBEnv m blk -&gt; blk -&gt; Bool
checkIntegrity :: blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#checkIntegrity"><span class="hs-identifier hs-var hs-var">checkIntegrity</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679857346"><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679857346"><span class="hs-identifier hs-var">blockComponent</span></a></span></span><span> </span><span id="local-6989586621679857347"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857347"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
-&gt; (forall {h}. HasFS m h -&gt; OpenState blk h -&gt; m (Maybe b))
-&gt; m (Maybe b)
forall blk (m :: * -&gt; *) r.
(IOLike m, StandardHash blk, Typeable blk) =&gt;
VolatileDBEnv m blk
-&gt; (forall h. HasFS m h -&gt; OpenState blk h -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#withOpenState"><span class="hs-identifier hs-var">withOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857339"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}. HasFS m h -&gt; OpenState blk h -&gt; m (Maybe b))
 -&gt; m (Maybe b))
-&gt; (forall {h}. HasFS m h -&gt; OpenState blk h -&gt; m (Maybe b))
-&gt; m (Maybe b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857351"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857351"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857353"><span class="annot"><span class="annottext">ReverseIndex blk
currentRevMap :: ReverseIndex blk
currentRevMap :: forall blk h. OpenState blk h -&gt; ReverseIndex blk
</span><a href="#local-6989586621679857353"><span class="hs-identifier hs-var hs-var">currentRevMap</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-254"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; ReverseIndex blk -&gt; Maybe (InternalBlockInfo blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857347"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseIndex blk
</span><a href="#local-6989586621679857353"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-255"></span><span>        </span><span class="annot"><span class="annottext">Maybe (InternalBlockInfo blk)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe b -&gt; m (Maybe b)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe b
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679857356"><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857356"><span class="hs-identifier hs-var">internalBlockInfo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; Maybe b
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; Maybe b) -&gt; m b -&gt; m (Maybe b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-257"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b -&gt; m b
forall b' h.
HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679857358"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857351"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857356"><span class="hs-identifier hs-var">internalBlockInfo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679857346"><span class="hs-identifier hs-var">blockComponent</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><a href="#local-6989586621679857358"><span class="hs-identifier hs-type">getBlockComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-260"></span><span>         </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856900"><span class="annot"><a href="#local-6989586621679856900"><span class="hs-identifier hs-type">b'</span></a></span></span><span> </span><span id="local-6989586621679856899"><span class="annot"><a href="#local-6989586621679856899"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856899"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-261"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#InternalBlockInfo"><span class="hs-identifier hs-type">InternalBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-262"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856900"><span class="hs-identifier hs-type">b'</span></a></span><span>
</span><span id="line-263"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856900"><span class="hs-identifier hs-type">b'</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span id="local-6989586621679857358"><span class="annot"><span class="annottext">getBlockComponent :: forall b' h.
HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679857358"><span class="hs-identifier hs-var hs-var">getBlockComponent</span></a></span></span><span> </span><span id="local-6989586621679857360"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679857361"><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857361"><span class="hs-identifier hs-var">ibi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHash"><span class="hs-identifier hs-var">GetHash</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
HeaderHash blk
</span><a href="#local-6989586621679857347"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-266"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetSlot"><span class="hs-identifier hs-var">GetSlot</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
SlotNo
</span><a href="#local-6989586621679857369"><span class="hs-identifier hs-var">biSlotNo</span></a></span><span>
</span><span id="line-267"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetIsEBB"><span class="hs-identifier hs-var">GetIsEBB</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
IsEBB
</span><a href="#local-6989586621679857373"><span class="hs-identifier hs-var">biIsEBB</span></a></span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlockSize"><span class="hs-identifier hs-var">GetBlockSize</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(b' -&gt; m b') -&gt; b' -&gt; m b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; b'
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; b') -&gt; Word32 -&gt; b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockSize -&gt; Word32
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#unBlockSize"><span class="hs-identifier hs-var">unBlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679857383"><span class="hs-identifier hs-var">ibiBlockSize</span></a></span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeaderSize"><span class="hs-identifier hs-var">GetHeaderSize</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
Word16
</span><a href="#local-6989586621679857387"><span class="hs-identifier hs-var">biHeaderSize</span></a></span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#GetPure"><span class="hs-identifier hs-type">GetPure</span></a></span><span> </span><span id="local-6989586621679857389"><span class="annot"><span class="annottext">b'
</span><a href="#local-6989586621679857389"><span class="hs-identifier hs-var">a</span></a></span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
</span><a href="#local-6989586621679857389"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-271"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#GetApply"><span class="hs-identifier hs-type">GetApply</span></a></span><span> </span><span id="local-6989586621679857392"><span class="annot"><span class="annottext">BlockComponent blk (a1 -&gt; b')
</span><a href="#local-6989586621679857392"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679857393"><span class="annot"><span class="annottext">BlockComponent blk a1
</span><a href="#local-6989586621679857393"><span class="hs-identifier hs-var">bc</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-272"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
-&gt; InternalBlockInfo blk
-&gt; BlockComponent blk (a1 -&gt; b')
-&gt; m (a1 -&gt; b')
forall b' h.
HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679857358"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857361"><span class="hs-identifier hs-var">ibi</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk (a1 -&gt; b')
</span><a href="#local-6989586621679857392"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">m (a1 -&gt; b') -&gt; m a1 -&gt; m b'
forall a b. m (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%2A%3E"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk a1 -&gt; m a1
forall b' h.
HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679857358"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857361"><span class="hs-identifier hs-var">ibi</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk a1
</span><a href="#local-6989586621679857393"><span class="hs-identifier hs-var">bc</span></a></span><span>
</span><span id="line-273"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlock"><span class="hs-identifier hs-var">GetBlock</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-274"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
-&gt; InternalBlockInfo blk
-&gt; BlockComponent blk ByteString
-&gt; m ByteString
forall b' h.
HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679857358"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857361"><span class="hs-identifier hs-var">ibi</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk ByteString
forall blk. BlockComponent blk ByteString
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawBlock"><span class="hs-identifier hs-var">GetRawBlock</span></a></span><span> </span><span class="annot"><span class="annottext">m ByteString -&gt; (ByteString -&gt; m b') -&gt; m b'
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m blk
ByteString -&gt; m b'
</span><a href="#local-6989586621679857398"><span class="hs-identifier hs-var">parseBlock</span></a></span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawBlock"><span class="hs-identifier hs-var">GetRawBlock</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m b') -&gt; m b'
forall (m :: * -&gt; *) h a.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679857410"><span class="hs-identifier hs-var">ibiFile</span></a></span><span> </span><span class="annot"><span class="annottext">OpenMode
</span><span class="hs-identifier hs-var">ReadMode</span></span><span> </span><span class="annot"><span class="annottext">((Handle h -&gt; m b') -&gt; m b') -&gt; (Handle h -&gt; m b') -&gt; m b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857412"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857412"><span class="hs-identifier hs-var">hndl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679857413"><span class="annot"><span class="annottext">size :: Word64
</span><a href="#local-6989586621679857413"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; Word64) -&gt; Word32 -&gt; Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockSize -&gt; Word32
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#unBlockSize"><span class="hs-identifier hs-var">unBlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679857383"><span class="hs-identifier hs-var">ibiBlockSize</span></a></span><span>
</span><span id="line-277"></span><span>              </span><span id="local-6989586621679857414"><span class="annot"><span class="annottext">offset :: Word64
</span><a href="#local-6989586621679857414"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#unBlockOffset"><span class="hs-identifier hs-var">unBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679857416"><span class="hs-identifier hs-var">ibiBlockOffset</span></a></span><span>
</span><span id="line-278"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><span class="hs-identifier hs-var">hGetExactlyAt</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857412"><span class="hs-identifier hs-var">hndl</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857413"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; AbsOffset
</span><span class="hs-identifier hs-var">AbsOffset</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857414"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetHeader"><span class="hs-identifier hs-var">GetHeader</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
-&gt; InternalBlockInfo blk
-&gt; BlockComponent blk ByteString
-&gt; m ByteString
forall b' h.
HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679857358"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857361"><span class="hs-identifier hs-var">ibi</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk ByteString
forall blk. BlockComponent blk ByteString
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawHeader"><span class="hs-identifier hs-var">GetRawHeader</span></a></span><span> </span><span class="annot"><span class="annottext">m ByteString -&gt; (ByteString -&gt; m b') -&gt; m b'
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; m b'
ByteString -&gt; m (Header blk)
</span><a href="#local-6989586621679857423"><span class="hs-identifier hs-var">parseHeader</span></a></span><span>
</span><span id="line-281"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetRawHeader"><span class="hs-identifier hs-var">GetRawHeader</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m b') -&gt; m b'
forall (m :: * -&gt; *) h a.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679857410"><span class="hs-identifier hs-var">ibiFile</span></a></span><span> </span><span class="annot"><span class="annottext">OpenMode
</span><span class="hs-identifier hs-var">ReadMode</span></span><span> </span><span class="annot"><span class="annottext">((Handle h -&gt; m b') -&gt; m b') -&gt; (Handle h -&gt; m b') -&gt; m b'
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857437"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857437"><span class="hs-identifier hs-var">hndl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679857438"><span class="annot"><span class="annottext">size :: Word64
</span><a href="#local-6989586621679857438"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679857387"><span class="hs-identifier hs-var">biHeaderSize</span></a></span><span>
</span><span id="line-283"></span><span>              </span><span id="local-6989586621679857439"><span class="annot"><span class="annottext">offset :: Word64
</span><a href="#local-6989586621679857439"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#unBlockOffset"><span class="hs-identifier hs-var">unBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679857416"><span class="hs-identifier hs-var">ibiBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679857441"><span class="hs-identifier hs-var">biHeaderOffset</span></a></span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; Handle h -&gt; Word64 -&gt; AbsOffset -&gt; m ByteString
</span><span class="hs-identifier hs-var">hGetExactlyAt</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857437"><span class="hs-identifier hs-var">hndl</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857438"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; AbsOffset
</span><span class="hs-identifier hs-var">AbsOffset</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857439"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetNestedCtxt"><span class="hs-identifier hs-var">GetNestedCtxt</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b'
SomeSecond (NestedCtxt Header) blk
</span><a href="#local-6989586621679857445"><span class="hs-identifier hs-var">ibiNestedCtxt</span></a></span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">BlockComponent blk b'
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetVerifiedBlock"><span class="hs-identifier hs-var">GetVerifiedBlock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-287"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
-&gt; InternalBlockInfo blk -&gt; BlockComponent blk blk -&gt; m blk
forall b' h.
HasFS m h -&gt; InternalBlockInfo blk -&gt; BlockComponent blk b' -&gt; m b'
</span><a href="#local-6989586621679857358"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857360"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857361"><span class="hs-identifier hs-var">ibi</span></a></span><span> </span><span class="annot"><span class="annottext">BlockComponent blk blk
forall blk. BlockComponent blk blk
</span><a href="Ouroboros.Consensus.Storage.Common.html#GetBlock"><span class="hs-identifier hs-var">GetBlock</span></a></span><span> </span><span class="annot"><span class="annottext">m blk -&gt; (blk -&gt; m b') -&gt; m b'
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857455"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679857455"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; Bool
</span><a href="#local-6989586621679857345"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679857455"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-289"></span><span>              </span><span class="annot"><span class="annottext">VolatileDBError blk -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(VolatileDBError blk -&gt; m ()) -&gt; VolatileDBError blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UnexpectedFailure blk -&gt; VolatileDBError blk
forall blk. UnexpectedFailure blk -&gt; VolatileDBError blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#UnexpectedFailure"><span class="hs-identifier hs-var">UnexpectedFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(UnexpectedFailure blk -&gt; VolatileDBError blk)
-&gt; UnexpectedFailure blk -&gt; VolatileDBError blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall blk. HeaderHash blk -&gt; UnexpectedFailure blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#CorruptBlockError"><span class="hs-identifier hs-var">CorruptBlockError</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857347"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-290"></span><span>            </span><span class="annot"><span class="annottext">b' -&gt; m b'
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">blk
b'
</span><a href="#local-6989586621679857455"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-291"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#InternalBlockInfo"><span class="hs-identifier hs-type">InternalBlockInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ibiBlockInfo :: forall blk. InternalBlockInfo blk -&gt; BlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiBlockInfo"><span class="hs-identifier hs-var">ibiBlockInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#BlockInfo"><span class="hs-identifier hs-type">BlockInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679857369"><span id="local-6989586621679857373"><span id="local-6989586621679857387"><span id="local-6989586621679857441"><span id="local-6989586621679857462"><span id="local-6989586621679857463"><span id="local-6989586621679857464"><span class="annot"><span class="annottext">Word16
SlotNo
BlockNo
ChainHash blk
HeaderHash blk
IsEBB
biSlotNo :: SlotNo
biIsEBB :: IsEBB
biHeaderSize :: Word16
biHeaderOffset :: Word16
biHash :: HeaderHash blk
biBlockNo :: BlockNo
biPrevHash :: ChainHash blk
biHash :: forall blk. BlockInfo blk -&gt; HeaderHash blk
biSlotNo :: forall blk. BlockInfo blk -&gt; SlotNo
biBlockNo :: forall blk. BlockInfo blk -&gt; BlockNo
biPrevHash :: forall blk. BlockInfo blk -&gt; ChainHash blk
biIsEBB :: forall blk. BlockInfo blk -&gt; IsEBB
biHeaderOffset :: forall blk. BlockInfo blk -&gt; Word16
biHeaderSize :: forall blk. BlockInfo blk -&gt; Word16
</span><a href="#local-6989586621679857369"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857383"><span id="local-6989586621679857410"><span id="local-6989586621679857416"><span id="local-6989586621679857445"><span class="annot"><span class="annottext">SomeSecond (NestedCtxt Header) blk
FsPath
BlockOffset
BlockSize
ibiBlockSize :: BlockSize
ibiFile :: FsPath
ibiBlockOffset :: BlockOffset
ibiNestedCtxt :: SomeSecond (NestedCtxt Header) blk
ibiFile :: forall blk. InternalBlockInfo blk -&gt; FsPath
ibiBlockOffset :: forall blk. InternalBlockInfo blk -&gt; BlockOffset
ibiBlockSize :: forall blk. InternalBlockInfo blk -&gt; BlockSize
ibiNestedCtxt :: forall blk.
InternalBlockInfo blk -&gt; SomeSecond (NestedCtxt Header) blk
</span><a href="#local-6989586621679857383"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857361"><span class="hs-identifier hs-var">ibi</span></a></span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><a href="#local-6989586621679857398"><span class="hs-identifier hs-type">parseBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span id="local-6989586621679857398"><span class="annot"><span class="annottext">parseBlock :: ByteString -&gt; m blk
</span><a href="#local-6989586621679857398"><span class="hs-identifier hs-var hs-var">parseBlock</span></a></span></span><span> </span><span id="local-6989586621679857476"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857476"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
-&gt; m blk
forall b''.
ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; b'')
-&gt; m b''
</span><a href="#local-6989586621679857477"><span class="hs-identifier hs-var">throwParseErrors</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857476"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
 -&gt; m blk)
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
-&gt; m blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-296"></span><span>            </span><span class="annot"><span class="annottext">(forall s. Decoder s (ByteString -&gt; blk))
-&gt; ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; blk)
forall a.
(forall s. Decoder s a)
-&gt; ByteString -&gt; Either DeserialiseFailure (ByteString, a)
</span><span class="hs-identifier hs-var">CBOR.deserialiseFromBytes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CodecConfig blk -&gt; forall s. Decoder s (ByteString -&gt; blk)
forall blk a.
DecodeDisk blk a =&gt;
CodecConfig blk -&gt; forall s. Decoder s a
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#decodeDisk"><span class="hs-identifier hs-var">decodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679857344"><span class="hs-identifier hs-var">codecConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857476"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><a href="#local-6989586621679857423"><span class="hs-identifier hs-type">parseHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>        </span><span id="local-6989586621679857423"><span class="annot"><span class="annottext">parseHeader :: ByteString -&gt; m (Header blk)
</span><a href="#local-6989586621679857423"><span class="hs-identifier hs-var hs-var">parseHeader</span></a></span></span><span> </span><span id="local-6989586621679857481"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857481"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
-&gt; m (Header blk)
forall b''.
ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; b'')
-&gt; m b''
</span><a href="#local-6989586621679857477"><span class="hs-identifier hs-var">throwParseErrors</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857481"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
 -&gt; m (Header blk))
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
-&gt; m (Header blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-300"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeSecond (NestedCtxt Header) blk
</span><a href="#local-6989586621679857445"><span class="hs-identifier hs-var">ibiNestedCtxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-301"></span><span>              </span><span class="annot"><a href="Ouroboros.Consensus.Util.html#SomeSecond"><span class="hs-identifier hs-type">SomeSecond</span></a></span><span> </span><span id="local-6989586621679857483"><span class="annot"><span class="annottext">NestedCtxt Header blk b
</span><a href="#local-6989586621679857483"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>                </span><span class="annot"><span class="annottext">(forall s. Decoder s (ByteString -&gt; Header blk))
-&gt; ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; Header blk)
forall a.
(forall s. Decoder s a)
-&gt; ByteString -&gt; Either DeserialiseFailure (ByteString, a)
</span><span class="hs-identifier hs-var">CBOR.deserialiseFromBytes</span></span><span>
</span><span id="line-303"></span><span>                  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679857488"><span class="annot"><span class="annottext">ByteString -&gt; b
</span><a href="#local-6989586621679857488"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DepPair (NestedCtxt Header blk) -&gt; Header blk
forall (f :: * -&gt; *) blk.
HasNestedContent f blk =&gt;
DepPair (NestedCtxt f blk) -&gt; f blk
</span><a href="Ouroboros.Consensus.Block.NestedContent.html#nest"><span class="hs-identifier hs-var">nest</span></a></span><span> </span><span class="annot"><span class="annottext">(DepPair (NestedCtxt Header blk) -&gt; Header blk)
-&gt; (ByteString -&gt; DepPair (NestedCtxt Header blk))
-&gt; ByteString
-&gt; Header blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk b -&gt; b -&gt; DepPair (NestedCtxt Header blk)
forall (f :: * -&gt; *) a. f a -&gt; a -&gt; DepPair f
</span><a href="Ouroboros.Consensus.Util.DepPair.html#DepPair"><span class="hs-identifier hs-var">DepPair</span></a></span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk b
</span><a href="#local-6989586621679857483"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; DepPair (NestedCtxt Header blk))
-&gt; (ByteString -&gt; b)
-&gt; ByteString
-&gt; DepPair (NestedCtxt Header blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; b
</span><a href="#local-6989586621679857488"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ByteString -&gt; b) -&gt; ByteString -&gt; Header blk)
-&gt; Decoder s (ByteString -&gt; b)
-&gt; Decoder s (ByteString -&gt; Header blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-304"></span><span>                      </span><span class="annot"><span class="annottext">CodecConfig blk
-&gt; NestedCtxt Header blk b -&gt; forall s. Decoder s (ByteString -&gt; b)
forall a.
CodecConfig blk
-&gt; NestedCtxt Header blk a -&gt; forall s. Decoder s (ByteString -&gt; a)
forall (f :: * -&gt; * -&gt; *) blk a.
DecodeDiskDep f blk =&gt;
CodecConfig blk -&gt; f blk a -&gt; forall s. Decoder s (ByteString -&gt; a)
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#decodeDiskDep"><span class="hs-identifier hs-var">decodeDiskDep</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679857344"><span class="hs-identifier hs-var">codecConfig</span></a></span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk b
</span><a href="#local-6989586621679857483"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>                  </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857481"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span>        </span><span class="annot"><a href="#local-6989586621679857493"><span class="hs-identifier hs-type">pt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856836"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-308"></span><span>        </span><span id="local-6989586621679857493"><span class="annot"><span class="annottext">pt :: RealPoint blk
</span><a href="#local-6989586621679857493"><span class="hs-identifier hs-var hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
forall blk. SlotNo -&gt; HeaderHash blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-var">RealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679857369"><span class="hs-identifier hs-var">biSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857347"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>        </span><span class="annot"><a href="#local-6989586621679857477"><span class="hs-identifier hs-type">throwParseErrors</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-311"></span><span>             </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856948"><span class="annot"><a href="#local-6989586621679856948"><span class="hs-identifier hs-type">b''</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-312"></span><span>             </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span>
</span><span id="line-313"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CBOR.DeserialiseFailure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856948"><span class="hs-identifier hs-type">b''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856835"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856948"><span class="hs-identifier hs-type">b''</span></a></span><span>
</span><span id="line-315"></span><span>        </span><span id="local-6989586621679857477"><span class="annot"><span class="annottext">throwParseErrors :: forall b''.
ByteString
-&gt; Either DeserialiseFailure (ByteString, ByteString -&gt; b'')
-&gt; m b''
</span><a href="#local-6989586621679857477"><span class="hs-identifier hs-var hs-var">throwParseErrors</span></a></span></span><span> </span><span id="local-6989586621679857500"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857500"><span class="hs-identifier hs-var">fullBytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-316"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679857501"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857501"><span class="hs-identifier hs-var">trailing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857502"><span class="annot"><span class="annottext">ByteString -&gt; b''
</span><a href="#local-6989586621679857502"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html#null"><span class="hs-identifier hs-var">Lazy.null</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857501"><span class="hs-identifier hs-var">trailing</span></a></span><span>
</span><span id="line-318"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b'' -&gt; m b''
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(b'' -&gt; m b'') -&gt; b'' -&gt; m b''
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; b''
</span><a href="#local-6989586621679857502"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857500"><span class="hs-identifier hs-var">fullBytes</span></a></span><span>
</span><span id="line-319"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-320"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VolatileDBError blk -&gt; m b''
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(VolatileDBError blk -&gt; m b'') -&gt; VolatileDBError blk -&gt; m b''
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UnexpectedFailure blk -&gt; VolatileDBError blk
forall blk. UnexpectedFailure blk -&gt; VolatileDBError blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#UnexpectedFailure"><span class="hs-identifier hs-var">UnexpectedFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(UnexpectedFailure blk -&gt; VolatileDBError blk)
-&gt; UnexpectedFailure blk -&gt; VolatileDBError blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath -&gt; RealPoint blk -&gt; ByteString -&gt; UnexpectedFailure blk
forall blk.
FsPath -&gt; RealPoint blk -&gt; ByteString -&gt; UnexpectedFailure blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#TrailingDataError"><span class="hs-identifier hs-var">TrailingDataError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679857410"><span class="hs-identifier hs-var">ibiFile</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679857493"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857501"><span class="hs-identifier hs-var">trailing</span></a></span><span>
</span><span id="line-321"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679857505"><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621679857505"><span class="hs-identifier hs-var">err</span></a></span></span><span>
</span><span id="line-322"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VolatileDBError blk -&gt; m b''
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(VolatileDBError blk -&gt; m b'') -&gt; VolatileDBError blk -&gt; m b''
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">UnexpectedFailure blk -&gt; VolatileDBError blk
forall blk. UnexpectedFailure blk -&gt; VolatileDBError blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#UnexpectedFailure"><span class="hs-identifier hs-var">UnexpectedFailure</span></a></span><span> </span><span class="annot"><span class="annottext">(UnexpectedFailure blk -&gt; VolatileDBError blk)
-&gt; UnexpectedFailure blk -&gt; VolatileDBError blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
-&gt; RealPoint blk -&gt; DeserialiseFailure -&gt; UnexpectedFailure blk
forall blk.
FsPath
-&gt; RealPoint blk -&gt; DeserialiseFailure -&gt; UnexpectedFailure blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#ParseError"><span class="hs-identifier hs-var">ParseError</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679857410"><span class="hs-identifier hs-var">ibiFile</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679857493"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">DeserialiseFailure
</span><a href="#local-6989586621679857505"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">-- | This function follows the approach:</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- (1) hPut bytes to the file</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- (2) if full hClose the write file</span><span>
</span><span id="line-327"></span><span class="hs-comment">-- (3)         hOpen a new write file</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- (4) update the Internal State.</span><span>
</span><span id="line-329"></span><span class="hs-comment">--</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- If there is an error after (1) or after (2) we should make sure that when</span><span>
</span><span id="line-331"></span><span class="hs-comment">-- we reopen a db from scratch, it can successfully recover, even if it does</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- not find an empty file to write and all other files are full.</span><span>
</span><span id="line-333"></span><span class="hs-comment">--</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- We should also make sure that the db can recover if we get an</span><span>
</span><span id="line-335"></span><span class="hs-comment">-- exception/error at any moment and that we are left with an empty Internal</span><span>
</span><span id="line-336"></span><span class="hs-comment">-- State.</span><span>
</span><span id="line-337"></span><span class="hs-comment">--</span><span>
</span><span id="line-338"></span><span class="hs-comment">-- We should be careful about not leaking open fds when we open a new file,</span><span>
</span><span id="line-339"></span><span class="hs-comment">-- since this can affect garbage collection of files.</span><span>
</span><span id="line-340"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#putBlockImpl"><span class="hs-identifier hs-type">putBlockImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-341"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856839"><span class="annot"><a href="#local-6989586621679856839"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856838"><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-342"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-343"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#EncodeDisk"><span class="hs-identifier hs-type">EncodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-344"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-345"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#HasNestedContent"><span class="hs-identifier hs-type">HasNestedContent</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-346"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856839"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-347"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856839"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856839"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span id="putBlockImpl"><span class="annot"><span class="annottext">putBlockImpl :: forall (m :: * -&gt; *) blk.
(GetPrevHash blk, EncodeDisk blk blk, HasBinaryBlockInfo blk,
 HasNestedContent Header blk, IOLike m) =&gt;
VolatileDBEnv m blk -&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#putBlockImpl"><span class="hs-identifier hs-var hs-var">putBlockImpl</span></a></span></span><span> </span><span id="local-6989586621679857522"><span class="annot"><span class="annottext">env :: VolatileDBEnv m blk
</span><a href="#local-6989586621679857522"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857529"><span class="annot"><span class="annottext">BlocksPerFile
maxBlocksPerFile :: forall (m :: * -&gt; *) blk. VolatileDBEnv m blk -&gt; BlocksPerFile
maxBlocksPerFile :: BlocksPerFile
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#maxBlocksPerFile"><span class="hs-identifier hs-var hs-var">maxBlocksPerFile</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857530"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
tracer :: forall (m :: * -&gt; *) blk.
VolatileDBEnv m blk -&gt; Tracer m (TraceEvent blk)
tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857531"><span class="annot"><span class="annottext">CodecConfig blk
codecConfig :: forall (m :: * -&gt; *) blk. VolatileDBEnv m blk -&gt; CodecConfig blk
codecConfig :: CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#codecConfig"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-352"></span><span>             </span><span id="local-6989586621679857532"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679857532"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall blk (m :: * -&gt; *) a.
(IOLike m, Typeable blk, StandardHash blk) =&gt;
VolatileDBEnv m blk
-&gt; (forall h. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h a)
-&gt; m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#appendOpenState"><span class="hs-identifier hs-var">appendOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857522"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
 -&gt; m ())
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857563"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857563"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857564"><span class="annot"><span class="annottext">ReverseIndex blk
currentRevMap :: forall blk h. OpenState blk h -&gt; ReverseIndex blk
currentRevMap :: ReverseIndex blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentRevMap"><span class="hs-identifier hs-var hs-var">currentRevMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857565"><span class="annot"><span class="annottext">Handle h
currentWriteHandle :: Handle h
currentWriteHandle :: forall blk h. OpenState blk h -&gt; Handle h
</span><a href="#local-6989586621679857565"><span class="hs-identifier hs-var hs-var">currentWriteHandle</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (OpenState blk h)
  (WithTempRegistry (OpenState blk h) m)
  (OpenState blk h)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; ReverseIndex blk -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#member"><span class="hs-identifier hs-var">Map.member</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857568"><span class="hs-identifier hs-var">biHash</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseIndex blk
</span><a href="#local-6989586621679857564"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679857530"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; TraceEvent blk
forall blk. HeaderHash blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockAlreadyHere"><span class="hs-identifier hs-var">BlockAlreadyHere</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857568"><span class="hs-identifier hs-var">biHash</span></a></span><span>
</span><span id="line-357"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679857570"><span class="annot"><span class="annottext">bytes :: ByteString
</span><a href="#local-6989586621679857570"><span class="hs-identifier hs-var hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; ByteString
</span><span class="hs-identifier hs-var">CBOR.toLazyByteString</span></span><span> </span><span class="annot"><span class="annottext">(Encoding -&gt; ByteString) -&gt; Encoding -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk -&gt; blk -&gt; Encoding
forall blk a. EncodeDisk blk a =&gt; CodecConfig blk -&gt; a -&gt; Encoding
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#encodeDisk"><span class="hs-identifier hs-var">encodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679857531"><span class="hs-identifier hs-var">codecConfig</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679857532"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-359"></span><span>        </span><span id="local-6989586621679857573"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857573"><span class="hs-identifier hs-var">bytesWritten</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState blk h) m Word64
-&gt; StateT
     (OpenState blk h) (WithTempRegistry (OpenState blk h) m) Word64
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState blk h) m Word64
 -&gt; StateT
      (OpenState blk h) (WithTempRegistry (OpenState blk h) m) Word64)
-&gt; WithTempRegistry (OpenState blk h) m Word64
-&gt; StateT
     (OpenState blk h) (WithTempRegistry (OpenState blk h) m) Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m Word64 -&gt; WithTempRegistry (OpenState blk h) m Word64
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m Word64 -&gt; WithTempRegistry (OpenState blk h) m Word64)
-&gt; m Word64 -&gt; WithTempRegistry (OpenState blk h) m Word64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m Word64
</span><span class="hs-identifier hs-var">hPutAll</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857563"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857565"><span class="hs-identifier hs-var">currentWriteHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679857570"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-360"></span><span>        </span><span id="local-6989586621679857575"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679857575"><span class="hs-identifier hs-var">fileIsFull</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(OpenState blk h -&gt; (Bool, OpenState blk h))
-&gt; StateT
     (OpenState blk h) (WithTempRegistry (OpenState blk h) m) Bool
forall a.
(OpenState blk h -&gt; (a, OpenState blk h))
-&gt; StateT
     (OpenState blk h) (WithTempRegistry (OpenState blk h) m) a
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">((OpenState blk h -&gt; (Bool, OpenState blk h))
 -&gt; StateT
      (OpenState blk h) (WithTempRegistry (OpenState blk h) m) Bool)
-&gt; (OpenState blk h -&gt; (Bool, OpenState blk h))
-&gt; StateT
     (OpenState blk h) (WithTempRegistry (OpenState blk h) m) Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; OpenState blk h -&gt; (Bool, OpenState blk h)
forall h. Word64 -&gt; OpenState blk h -&gt; (Bool, OpenState blk h)
</span><a href="#local-6989586621679857576"><span class="hs-identifier hs-var">updateStateAfterWrite</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857573"><span class="hs-identifier hs-var">bytesWritten</span></a></span><span>
</span><span id="line-361"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679857575"><span class="hs-identifier hs-var">fileIsFull</span></a></span><span> </span><span class="annot"><span class="annottext">(ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ())
-&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; ModifyOpenState m blk h ()
forall h (m :: * -&gt; *) blk.
(IOLike m, Eq h) =&gt;
HasFS m h -&gt; ModifyOpenState m blk h ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#nextFile"><span class="hs-identifier hs-var">nextFile</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857563"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621679857578"><span class="annot"><span class="annottext">blockInfo :: BlockInfo blk
</span><a href="#local-6989586621679857578"><span class="hs-identifier hs-var">blockInfo</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#BlockInfo"><span class="hs-identifier hs-type">BlockInfo</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857568"><span class="annot"><span class="annottext">HeaderHash blk
biHash :: forall blk. BlockInfo blk -&gt; HeaderHash blk
biHash :: HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#biHash"><span class="hs-identifier hs-var hs-var">biHash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857579"><span class="annot"><span class="annottext">SlotNo
biSlotNo :: forall blk. BlockInfo blk -&gt; SlotNo
biSlotNo :: SlotNo
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#biSlotNo"><span class="hs-identifier hs-var hs-var">biSlotNo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857580"><span class="annot"><span class="annottext">ChainHash blk
biPrevHash :: forall blk. BlockInfo blk -&gt; ChainHash blk
biPrevHash :: ChainHash blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#biPrevHash"><span class="hs-identifier hs-var hs-var">biPrevHash</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; BlockInfo blk
forall blk.
(GetPrevHash blk, HasBinaryBlockInfo blk) =&gt;
blk -&gt; BlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Parser.html#extractBlockInfo"><span class="hs-identifier hs-var">extractBlockInfo</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679857532"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><a href="#local-6989586621679857576"><span class="hs-identifier hs-type">updateStateAfterWrite</span></a></span><span>
</span><span id="line-366"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679857010"><span class="annot"><a href="#local-6989586621679857010"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-367"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857010"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-369"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856838"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857010"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ True: current file is full</span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621679857576"><span class="annot"><span class="annottext">updateStateAfterWrite :: forall h. Word64 -&gt; OpenState blk h -&gt; (Bool, OpenState blk h)
</span><a href="#local-6989586621679857576"><span class="hs-identifier hs-var hs-var">updateStateAfterWrite</span></a></span></span><span> </span><span id="local-6989586621679857600"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857600"><span class="hs-identifier hs-var">bytesWritten</span></a></span></span><span> </span><span id="local-6989586621679857601"><span class="annot"><span class="annottext">st :: OpenState blk h
</span><a href="#local-6989586621679857601"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span class="hs-special">{</span><span id="local-6989586621679857602"><span id="local-6989586621679857603"><span id="local-6989586621679857604"><span id="local-6989586621679857605"><span id="local-6989586621679857606"><span id="local-6989586621679857607"><span id="local-6989586621679857608"><span id="local-6989586621679857609"><span class="annot"><span class="annottext">FileId
Word64
SuccessorsIndex blk
ReverseIndex blk
MaxSlotNo
FsPath
Handle h
Index blk
currentRevMap :: forall blk h. OpenState blk h -&gt; ReverseIndex blk
currentWriteHandle :: forall blk h. OpenState blk h -&gt; Handle h
currentWriteHandle :: Handle h
currentWritePath :: FsPath
currentWriteId :: FileId
currentWriteOffset :: Word64
currentMap :: Index blk
currentRevMap :: ReverseIndex blk
currentSuccMap :: SuccessorsIndex blk
currentMaxSlotNo :: MaxSlotNo
currentWritePath :: forall blk h. OpenState blk h -&gt; FsPath
currentWriteId :: forall blk h. OpenState blk h -&gt; FileId
currentWriteOffset :: forall blk h. OpenState blk h -&gt; Word64
currentMap :: forall blk h. OpenState blk h -&gt; Index blk
currentSuccMap :: forall blk h. OpenState blk h -&gt; SuccessorsIndex blk
currentMaxSlotNo :: forall blk h. OpenState blk h -&gt; MaxSlotNo
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentRevMap"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-371"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlocksPerFile -&gt; FileInfo blk -&gt; Bool
forall blk. BlocksPerFile -&gt; FileInfo blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#isFull"><span class="hs-identifier hs-var">FileInfo.isFull</span></a></span><span> </span><span class="annot"><span class="annottext">BlocksPerFile
</span><a href="#local-6989586621679857529"><span class="hs-identifier hs-var">maxBlocksPerFile</span></a></span><span> </span><span class="annot"><span class="annottext">FileInfo blk
</span><a href="#local-6989586621679857617"><span class="hs-identifier hs-var">fileInfo'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857618"><span class="hs-identifier hs-var">st'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-373"></span><span>        </span><span id="local-6989586621679857619"><span class="annot"><span class="annottext">fileInfo :: FileInfo blk
</span><a href="#local-6989586621679857619"><span class="hs-identifier hs-var hs-var">fileInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FileInfo blk -&gt; Maybe (FileInfo blk) -&gt; FileInfo blk
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span>
</span><span id="line-374"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FileInfo blk
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; FileInfo blk) -&gt; String -&gt; FileInfo blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;VolatileDB invariant violation:&quot;</span></span><span>
</span><span id="line-375"></span><span>                    </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Current write file not found in Index.&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileId -&gt; Index blk -&gt; Maybe (FileInfo blk)
forall blk. FileId -&gt; Index blk -&gt; Maybe (FileInfo blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#lookup"><span class="hs-identifier hs-var">Index.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857604"><span class="hs-identifier hs-var">currentWriteId</span></a></span><span> </span><span class="annot"><span class="annottext">Index blk
</span><a href="#local-6989586621679857606"><span class="hs-identifier hs-var">currentMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>        </span><span id="local-6989586621679857617"><span class="annot"><span class="annottext">fileInfo' :: FileInfo blk
</span><a href="#local-6989586621679857617"><span class="hs-identifier hs-var hs-var">fileInfo'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; HeaderHash blk -&gt; FileInfo blk -&gt; FileInfo blk
forall blk.
StandardHash blk =&gt;
SlotNo -&gt; HeaderHash blk -&gt; FileInfo blk -&gt; FileInfo blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#addBlock"><span class="hs-identifier hs-var">FileInfo.addBlock</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679857579"><span class="hs-identifier hs-var">biSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857568"><span class="hs-identifier hs-var">biHash</span></a></span><span> </span><span class="annot"><span class="annottext">FileInfo blk
</span><a href="#local-6989586621679857619"><span class="hs-identifier hs-var">fileInfo</span></a></span><span>
</span><span id="line-378"></span><span>        </span><span id="local-6989586621679857623"><span class="annot"><span class="annottext">currentMap' :: Index blk
</span><a href="#local-6989586621679857623"><span class="hs-identifier hs-var hs-var">currentMap'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FileId -&gt; FileInfo blk -&gt; Index blk -&gt; Index blk
forall blk. FileId -&gt; FileInfo blk -&gt; Index blk -&gt; Index blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#insert"><span class="hs-identifier hs-var">Index.insert</span></a></span><span> </span><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857604"><span class="hs-identifier hs-var">currentWriteId</span></a></span><span> </span><span class="annot"><span class="annottext">FileInfo blk
</span><a href="#local-6989586621679857617"><span class="hs-identifier hs-var">fileInfo'</span></a></span><span> </span><span class="annot"><span class="annottext">Index blk
</span><a href="#local-6989586621679857606"><span class="hs-identifier hs-var">currentMap</span></a></span><span>
</span><span id="line-379"></span><span>        </span><span id="local-6989586621679857625"><span class="annot"><span class="annottext">internalBlockInfo' :: InternalBlockInfo blk
</span><a href="#local-6989586621679857625"><span class="hs-identifier hs-var hs-var">internalBlockInfo'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#InternalBlockInfo"><span class="hs-identifier hs-type">InternalBlockInfo</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-380"></span><span>            </span><span class="annot"><span class="annottext">ibiFile :: FsPath
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiFile"><span class="hs-identifier hs-var">ibiFile</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679857603"><span class="hs-identifier hs-var">currentWritePath</span></a></span><span>
</span><span id="line-381"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ibiBlockOffset :: BlockOffset
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiBlockOffset"><span class="hs-identifier hs-var">ibiBlockOffset</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; BlockOffset
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockOffset"><span class="hs-identifier hs-var">BlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857605"><span class="hs-identifier hs-var">currentWriteOffset</span></a></span><span>
</span><span id="line-382"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ibiBlockSize :: BlockSize
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiBlockSize"><span class="hs-identifier hs-var">ibiBlockSize</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; BlockSize
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#BlockSize"><span class="hs-identifier hs-var">BlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; BlockSize) -&gt; Word32 -&gt; BlockSize
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679857600"><span class="hs-identifier hs-var">bytesWritten</span></a></span><span>
</span><span id="line-383"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ibiBlockInfo :: BlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiBlockInfo"><span class="hs-identifier hs-var">ibiBlockInfo</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockInfo blk
</span><a href="#local-6989586621679857578"><span class="hs-identifier hs-var">blockInfo</span></a></span><span>
</span><span id="line-384"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ibiNestedCtxt :: SomeSecond (NestedCtxt Header) blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiNestedCtxt"><span class="hs-identifier hs-var">ibiNestedCtxt</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; DepPair (NestedCtxt Header blk)
forall (f :: * -&gt; *) blk.
HasNestedContent f blk =&gt;
f blk -&gt; DepPair (NestedCtxt f blk)
</span><a href="Ouroboros.Consensus.Block.NestedContent.html#unnest"><span class="hs-identifier hs-var">unnest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; Header blk
forall blk. GetHeader blk =&gt; blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#getHeader"><span class="hs-identifier hs-var">getHeader</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679857532"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-385"></span><span>                                </span><span class="annot"><a href="Ouroboros.Consensus.Util.DepPair.html#DepPair"><span class="hs-identifier hs-type">DepPair</span></a></span><span> </span><span id="local-6989586621679857630"><span class="annot"><span class="annottext">NestedCtxt Header blk a
</span><a href="#local-6989586621679857630"><span class="hs-identifier hs-var">nestedCtxt</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk a -&gt; SomeSecond (NestedCtxt Header) blk
forall (f :: * -&gt; * -&gt; *) a b. f a b -&gt; SomeSecond f a
</span><a href="Ouroboros.Consensus.Util.html#SomeSecond"><span class="hs-identifier hs-var">SomeSecond</span></a></span><span> </span><span class="annot"><span class="annottext">NestedCtxt Header blk a
</span><a href="#local-6989586621679857630"><span class="hs-identifier hs-var">nestedCtxt</span></a></span><span>
</span><span id="line-386"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-387"></span><span>        </span><span id="local-6989586621679857631"><span class="annot"><span class="annottext">currentRevMap' :: ReverseIndex blk
</span><a href="#local-6989586621679857631"><span class="hs-identifier hs-var hs-var">currentRevMap'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; InternalBlockInfo blk -&gt; ReverseIndex blk -&gt; ReverseIndex blk
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#insert"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857568"><span class="hs-identifier hs-var">biHash</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk
</span><a href="#local-6989586621679857625"><span class="hs-identifier hs-var">internalBlockInfo'</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseIndex blk
</span><a href="#local-6989586621679857607"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span id="local-6989586621679857618"><span class="annot"><span class="annottext">st' :: OpenState blk h
</span><a href="#local-6989586621679857618"><span class="hs-identifier hs-var hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857601"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-389"></span><span>            </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteOffset"><span class="hs-identifier hs-var">currentWriteOffset</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857605"><span class="hs-identifier hs-type">currentWriteOffset</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-type">+</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857600"><span class="hs-identifier hs-type">bytesWritten</span></a></span><span>
</span><span id="line-390"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMap"><span class="hs-identifier hs-var">currentMap</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857623"><span class="hs-identifier hs-type">currentMap'</span></a></span><span>
</span><span id="line-391"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentRevMap"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857631"><span class="hs-identifier hs-type">currentRevMap'</span></a></span><span>
</span><span id="line-392"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentSuccMap"><span class="hs-identifier hs-var">currentSuccMap</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#insertMapSet"><span class="hs-identifier hs-type">insertMapSet</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857580"><span class="hs-identifier hs-type">biPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857568"><span class="hs-identifier hs-type">biHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857608"><span class="hs-identifier hs-type">currentSuccMap</span></a></span><span>
</span><span id="line-393"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMaxSlotNo"><span class="hs-identifier hs-var">currentMaxSlotNo</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857609"><span class="hs-identifier hs-type">currentMaxSlotNo</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#max"><span class="hs-operator hs-type">`max`</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span> </span><span class="annot"><a href="#local-6989586621679857579"><span class="hs-identifier hs-type">biSlotNo</span></a></span><span>
</span><span id="line-394"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span class="hs-comment">-- | Garbage collect all files of which the highest slot is less than the</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- given slot.</span><span>
</span><span id="line-398"></span><span class="hs-comment">--</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- We first check whether we actually can garbage collect any file. If we can,</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- we obtain the more expensive write lock and remove the files that can be</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- garbage collected. We update the 'InternalState' for each garbage collected</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- file.</span><span>
</span><span id="line-403"></span><span class="hs-comment">--</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- If an exception is thrown while garbage collecting, we close the database.</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- This means we don't have to worry the file system getting out of sync with</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- the in-memory indices, as the indices are rebuilt when reopening.</span><span>
</span><span id="line-407"></span><span class="hs-comment">--</span><span>
</span><span id="line-408"></span><span class="hs-comment">-- NOTE: the current file is never garbage collected.</span><span>
</span><span id="line-409"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectImpl"><span class="hs-identifier hs-type">garbageCollectImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-410"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856840"><span class="annot"><a href="#local-6989586621679856840"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856841"><span class="annot"><a href="#local-6989586621679856841"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856840"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679856841"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856840"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856841"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679856840"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span id="garbageCollectImpl"><span class="annot"><span class="annottext">garbageCollectImpl :: forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk -&gt; SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectImpl"><span class="hs-identifier hs-var hs-var">garbageCollectImpl</span></a></span></span><span> </span><span id="local-6989586621679857660"><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857660"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679857661"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679857661"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-comment">-- Check if we can actually GC something using a cheaper read (allowing</span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-comment">-- for more concurrency) before obtaining the more expensive exclusive</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-comment">-- write lock.</span><span>
</span><span id="line-418"></span><span>    </span><span id="local-6989586621679857662"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679857662"><span class="hs-identifier hs-var">usefulGC</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m Bool -&gt; m Bool
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m Bool -&gt; m Bool) -&gt; STM m Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(forall h. OpenState blk h -&gt; Bool)
-&gt; VolatileDBEnv m blk -&gt; STM m Bool
forall (m :: * -&gt; *) blk a.
(IOLike m, HasHeader blk) =&gt;
(forall h. OpenState blk h -&gt; a) -&gt; VolatileDBEnv m blk -&gt; STM m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; Bool
forall h. OpenState blk h -&gt; Bool
</span><a href="#local-6989586621679857665"><span class="hs-identifier hs-var">gcPossible</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857660"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679857662"><span class="hs-identifier hs-var">usefulGC</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall blk (m :: * -&gt; *) a.
(IOLike m, Typeable blk, StandardHash blk) =&gt;
VolatileDBEnv m blk
-&gt; (forall h. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h a)
-&gt; m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#writeOpenState"><span class="hs-identifier hs-var">writeOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDBEnv m blk
</span><a href="#local-6989586621679857660"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
 -&gt; m ())
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857690"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857690"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-comment">-- This event will be picked up by ghc-events-analyze</span><span>
</span><span id="line-423"></span><span>        </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadEventlog m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">traceEventIO</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;START garbage collection&quot;</span></span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-comment">-- Note that this is /monotonic/: if 'usefulGC' is @True@, then</span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-comment">-- 'filesToGC' has to be non-empty.</span><span>
</span><span id="line-426"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-427"></span><span>        </span><span class="hs-comment">-- Only a single thread performs garbage collection, so no files could</span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-comment">-- have been GC'ed in the meantime. The only thing that could have</span><span>
</span><span id="line-429"></span><span>        </span><span class="hs-comment">-- happened is that blocks have been appended. If they have been</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-comment">-- appended to the current file, nothing changes, as we never GC the</span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-comment">-- current file anyway. If a new file was opened, either we can now GC</span><span>
</span><span id="line-432"></span><span>        </span><span class="hs-comment">-- the previous file (increase in the number of files to GC) or not</span><span>
</span><span id="line-433"></span><span>        </span><span class="hs-comment">-- (same number of files to GC).</span><span>
</span><span id="line-434"></span><span>        </span><span id="local-6989586621679857692"><span class="annot"><span class="annottext">[(FileId, FileInfo blk)]
</span><a href="#local-6989586621679857692"><span class="hs-identifier hs-var">filesToGC</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(OpenState blk h -&gt; [(FileId, FileInfo blk)])
-&gt; StateT
     (OpenState blk h)
     (WithTempRegistry (OpenState blk h) m)
     [(FileId, FileInfo blk)]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; [(FileId, FileInfo blk)]
forall h. OpenState blk h -&gt; [(FileId, FileInfo blk)]
</span><a href="#local-6989586621679857693"><span class="hs-identifier hs-var">getFilesToGC</span></a></span><span>
</span><span id="line-435"></span><span>        </span><span class="annot"><span class="annottext">((FileId, FileInfo blk) -&gt; ModifyOpenState m blk h ())
-&gt; [(FileId, FileInfo blk)] -&gt; ModifyOpenState m blk h ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasFS m h -&gt; (FileId, FileInfo blk) -&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) h blk.
(MonadThrow m, HasHeader blk) =&gt;
HasFS m h -&gt; (FileId, FileInfo blk) -&gt; ModifyOpenState m blk h ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectFile"><span class="hs-identifier hs-var">garbageCollectFile</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857690"><span class="hs-identifier hs-var">hasFS</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(FileId, FileInfo blk)]
</span><a href="#local-6989586621679857692"><span class="hs-identifier hs-var">filesToGC</span></a></span><span>
</span><span id="line-436"></span><span>        </span><span class="hs-comment">-- Recompute the 'MaxSlotNo' based on the files left in the</span><span>
</span><span id="line-437"></span><span>        </span><span class="hs-comment">-- VolatileDB. This value can never go down, except to 'NoMaxSlotNo'</span><span>
</span><span id="line-438"></span><span>        </span><span class="hs-comment">-- (when we GC everything), because a GC can only delete blocks &lt; a</span><span>
</span><span id="line-439"></span><span>        </span><span class="hs-comment">-- slot.</span><span>
</span><span id="line-440"></span><span>        </span><span class="annot"><span class="annottext">(OpenState blk h -&gt; OpenState blk h) -&gt; ModifyOpenState m blk h ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((OpenState blk h -&gt; OpenState blk h)
 -&gt; ModifyOpenState m blk h ())
-&gt; (OpenState blk h -&gt; OpenState blk h)
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857696"><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857696"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857696"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-441"></span><span>            </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMaxSlotNo"><span class="hs-identifier hs-var">currentMaxSlotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#maxSlotNoInFiles"><span class="hs-identifier hs-type">FileInfo.maxSlotNoInFiles</span></a></span><span>
</span><span id="line-442"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#elems"><span class="hs-identifier hs-type">Index.elems</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMap"><span class="hs-identifier hs-var">currentMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857696"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-444"></span><span>        </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *). MonadEventlog m =&gt; String -&gt; m ()
</span><span class="hs-identifier hs-var">traceEventIO</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;STOP garbage collection&quot;</span></span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-446"></span><span>    </span><span class="hs-comment">-- | Return 'True' if a garbage collection would actually garbage collect</span><span>
</span><span id="line-447"></span><span>    </span><span class="hs-comment">-- at least one file.</span><span>
</span><span id="line-448"></span><span>    </span><span id="local-6989586621679857699"><span class="annot"><a href="#local-6989586621679857665"><span class="hs-identifier hs-type">gcPossible</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856841"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857699"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-449"></span><span>    </span><span id="local-6989586621679857665"><span class="annot"><span class="annottext">gcPossible :: forall h. OpenState blk h -&gt; Bool
</span><a href="#local-6989586621679857665"><span class="hs-identifier hs-var hs-var">gcPossible</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (OpenState blk h -&gt; Bool) -&gt; OpenState blk h -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[(FileId, FileInfo blk)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">([(FileId, FileInfo blk)] -&gt; Bool)
-&gt; (OpenState blk h -&gt; [(FileId, FileInfo blk)])
-&gt; OpenState blk h
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; [(FileId, FileInfo blk)]
forall h. OpenState blk h -&gt; [(FileId, FileInfo blk)]
</span><a href="#local-6989586621679857693"><span class="hs-identifier hs-var">getFilesToGC</span></a></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-comment">-- | Return the list of files that can be garbage collected.</span><span>
</span><span id="line-452"></span><span>    </span><span id="local-6989586621679857073"><span class="annot"><a href="#local-6989586621679857693"><span class="hs-identifier hs-type">getFilesToGC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856841"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857073"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#FileId"><span class="hs-identifier hs-type">FileId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856841"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621679857693"><span class="annot"><span class="annottext">getFilesToGC :: forall h. OpenState blk h -&gt; [(FileId, FileInfo blk)]
</span><a href="#local-6989586621679857693"><span class="hs-identifier hs-var hs-var">getFilesToGC</span></a></span></span><span> </span><span id="local-6989586621679857705"><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857705"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((FileId, FileInfo blk) -&gt; Bool)
-&gt; [(FileId, FileInfo blk)] -&gt; [(FileId, FileInfo blk)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">(FileId, FileInfo blk) -&gt; Bool
</span><a href="#local-6989586621679857706"><span class="hs-identifier hs-var">canGC</span></a></span><span> </span><span class="annot"><span class="annottext">([(FileId, FileInfo blk)] -&gt; [(FileId, FileInfo blk)])
-&gt; (OpenState blk h -&gt; [(FileId, FileInfo blk)])
-&gt; OpenState blk h
-&gt; [(FileId, FileInfo blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Index blk -&gt; [(FileId, FileInfo blk)]
forall blk. Index blk -&gt; [(FileId, FileInfo blk)]
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#toAscList"><span class="hs-identifier hs-var">Index.toAscList</span></a></span><span> </span><span class="annot"><span class="annottext">(Index blk -&gt; [(FileId, FileInfo blk)])
-&gt; (OpenState blk h -&gt; Index blk)
-&gt; OpenState blk h
-&gt; [(FileId, FileInfo blk)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; Index blk
forall blk h. OpenState blk h -&gt; Index blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMap"><span class="hs-identifier hs-var">currentMap</span></a></span><span> </span><span class="annot"><span class="annottext">(OpenState blk h -&gt; [(FileId, FileInfo blk)])
-&gt; OpenState blk h -&gt; [(FileId, FileInfo blk)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857705"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-454"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-455"></span><span>        </span><span class="hs-comment">-- We don't GC the current file. This is unlikely to happen in</span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-comment">-- practice anyway, and it makes things simpler.</span><span>
</span><span id="line-457"></span><span>        </span><span id="local-6989586621679857706"><span class="annot"><span class="annottext">canGC :: (FileId, FileInfo blk) -&gt; Bool
</span><a href="#local-6989586621679857706"><span class="hs-identifier hs-var hs-var">canGC</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679857708"><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857708"><span class="hs-identifier hs-var">fileId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857709"><span class="annot"><span class="annottext">FileInfo blk
</span><a href="#local-6989586621679857709"><span class="hs-identifier hs-var">fileInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-458"></span><span>          </span><span class="annot"><span class="annottext">FileInfo blk -&gt; SlotNo -&gt; Bool
forall blk. FileInfo blk -&gt; SlotNo -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#canGC"><span class="hs-identifier hs-var">FileInfo.canGC</span></a></span><span> </span><span class="annot"><span class="annottext">FileInfo blk
</span><a href="#local-6989586621679857709"><span class="hs-identifier hs-var">fileInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679857661"><span class="hs-identifier hs-var">slot</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857708"><span class="hs-identifier hs-var">fileId</span></a></span><span> </span><span class="annot"><span class="annottext">FileId -&gt; FileId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; FileId
forall blk h. OpenState blk h -&gt; FileId
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteId"><span class="hs-identifier hs-var">currentWriteId</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857705"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">-- | Garbage collect the given file /unconditionally/, updating the</span><span>
</span><span id="line-461"></span><span class="hs-comment">-- 'OpenState'.</span><span>
</span><span id="line-462"></span><span class="hs-comment">--</span><span>
</span><span id="line-463"></span><span class="hs-comment">-- Important to note here is that, every call should leave the file system in</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- a consistent state, without depending on other calls. We achieve this by</span><span>
</span><span id="line-465"></span><span class="hs-comment">-- only needed a single system call: 'removeFile'.</span><span>
</span><span id="line-466"></span><span class="hs-comment">--</span><span>
</span><span id="line-467"></span><span class="hs-comment">-- NOTE: the updated 'OpenState' is inconsistent in the follow respect:</span><span>
</span><span id="line-468"></span><span class="hs-comment">-- the cached 'currentMaxSlotNo' hasn't been updated yet.</span><span>
</span><span id="line-469"></span><span class="hs-comment">--</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- This may throw an FsError.</span><span>
</span><span id="line-471"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectFile"><span class="hs-identifier hs-type">garbageCollectFile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-472"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679857078"><span class="annot"><a href="#local-6989586621679857078"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679857080"><span class="annot"><a href="#local-6989586621679857080"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span id="local-6989586621679857079"><span class="annot"><a href="#local-6989586621679857079"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679857078"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679857079"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679857078"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857080"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-474"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#FileId"><span class="hs-identifier hs-type">FileId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#FileInfo"><span class="hs-identifier hs-type">FileInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857079"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier hs-type">ModifyOpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857078"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857079"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857080"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span id="garbageCollectFile"><span class="annot"><span class="annottext">garbageCollectFile :: forall (m :: * -&gt; *) h blk.
(MonadThrow m, HasHeader blk) =&gt;
HasFS m h -&gt; (FileId, FileInfo blk) -&gt; ModifyOpenState m blk h ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#garbageCollectFile"><span class="hs-identifier hs-var hs-var">garbageCollectFile</span></a></span></span><span> </span><span id="local-6989586621679857738"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857738"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679857739"><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857739"><span class="hs-identifier hs-var">fileId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857740"><span class="annot"><span class="annottext">FileInfo blk
</span><a href="#local-6989586621679857740"><span class="hs-identifier hs-var">fileInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>    </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
forall (m :: * -&gt; *) h. HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m ()
</span><span class="hs-identifier hs-var">removeFile</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857738"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">(FsPath -&gt; m ()) -&gt; FsPath -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FileId -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#filePath"><span class="hs-identifier hs-var">filePath</span></a></span><span> </span><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857739"><span class="hs-identifier hs-var">fileId</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>    </span><span id="local-6989586621679857742"><span class="annot"><span class="annottext">st :: OpenState blk h
</span><a href="#local-6989586621679857742"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857743"><span class="annot"><span class="annottext">Index blk
currentMap :: forall blk h. OpenState blk h -&gt; Index blk
currentMap :: Index blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMap"><span class="hs-identifier hs-var hs-var">currentMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857744"><span class="annot"><span class="annottext">ReverseIndex blk
currentRevMap :: forall blk h. OpenState blk h -&gt; ReverseIndex blk
currentRevMap :: ReverseIndex blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentRevMap"><span class="hs-identifier hs-var hs-var">currentRevMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857745"><span class="annot"><span class="annottext">SuccessorsIndex blk
currentSuccMap :: forall blk h. OpenState blk h -&gt; SuccessorsIndex blk
currentSuccMap :: SuccessorsIndex blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentSuccMap"><span class="hs-identifier hs-var hs-var">currentSuccMap</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (OpenState blk h)
  (WithTempRegistry (OpenState blk h) m)
  (OpenState blk h)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679857746"><span class="annot"><span class="annottext">hashes :: Set (HeaderHash blk)
</span><a href="#local-6989586621679857746"><span class="hs-identifier hs-var hs-var">hashes</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FileInfo blk -&gt; Set (HeaderHash blk)
forall blk. FileInfo blk -&gt; Set (HeaderHash blk)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#hashes"><span class="hs-identifier hs-var">FileInfo.hashes</span></a></span><span> </span><span class="annot"><span class="annottext">FileInfo blk
</span><a href="#local-6989586621679857740"><span class="hs-identifier hs-var">fileInfo</span></a></span><span>
</span><span id="line-483"></span><span>        </span><span id="local-6989586621679857748"><span class="annot"><span class="annottext">currentRevMap' :: ReverseIndex blk
</span><a href="#local-6989586621679857748"><span class="hs-identifier hs-var hs-var">currentRevMap'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReverseIndex blk -&gt; Set (HeaderHash blk) -&gt; ReverseIndex blk
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#withoutKeys"><span class="hs-identifier hs-var">Map.withoutKeys</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseIndex blk
</span><a href="#local-6989586621679857744"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span> </span><span class="annot"><span class="annottext">Set (HeaderHash blk)
</span><a href="#local-6989586621679857746"><span class="hs-identifier hs-var">hashes</span></a></span><span>
</span><span id="line-484"></span><span>        </span><span id="local-6989586621679857750"><span class="annot"><span class="annottext">deletedPairs :: [(ChainHash blk, HeaderHash blk)]
</span><a href="#local-6989586621679857750"><span class="hs-identifier hs-var hs-var">deletedPairs</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span>
</span><span id="line-485"></span><span>          </span><span class="annot"><span class="annottext">(HeaderHash blk -&gt; Maybe (ChainHash blk, HeaderHash blk))
-&gt; [HeaderHash blk] -&gt; [(ChainHash blk, HeaderHash blk)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span>
</span><span id="line-486"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679857751"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857751"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857751"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChainHash blk -&gt; (ChainHash blk, HeaderHash blk))
-&gt; (InternalBlockInfo blk -&gt; ChainHash blk)
-&gt; InternalBlockInfo blk
-&gt; (ChainHash blk, HeaderHash blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">BlockInfo blk -&gt; ChainHash blk
forall blk. BlockInfo blk -&gt; ChainHash blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#biPrevHash"><span class="hs-identifier hs-var">biPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockInfo blk -&gt; ChainHash blk)
-&gt; (InternalBlockInfo blk -&gt; BlockInfo blk)
-&gt; InternalBlockInfo blk
-&gt; ChainHash blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InternalBlockInfo blk -&gt; BlockInfo blk
forall blk. InternalBlockInfo blk -&gt; BlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiBlockInfo"><span class="hs-identifier hs-var">ibiBlockInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(InternalBlockInfo blk -&gt; (ChainHash blk, HeaderHash blk))
-&gt; Maybe (InternalBlockInfo blk)
-&gt; Maybe (ChainHash blk, HeaderHash blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; ReverseIndex blk -&gt; Maybe (InternalBlockInfo blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857751"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ReverseIndex blk
</span><a href="#local-6989586621679857744"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set (HeaderHash blk) -&gt; [HeaderHash blk]
forall a. Set a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">Set.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Set (HeaderHash blk)
</span><a href="#local-6989586621679857746"><span class="hs-identifier hs-var">hashes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>        </span><span id="local-6989586621679857753"><span class="annot"><span class="annottext">currentSuccMap' :: SuccessorsIndex blk
</span><a href="#local-6989586621679857753"><span class="hs-identifier hs-var hs-var">currentSuccMap'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-489"></span><span>          </span><span class="annot"><span class="annottext">(SuccessorsIndex blk
 -&gt; (ChainHash blk, HeaderHash blk) -&gt; SuccessorsIndex blk)
-&gt; SuccessorsIndex blk
-&gt; [(ChainHash blk, HeaderHash blk)]
-&gt; SuccessorsIndex blk
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((ChainHash blk, HeaderHash blk)
 -&gt; SuccessorsIndex blk -&gt; SuccessorsIndex blk)
-&gt; SuccessorsIndex blk
-&gt; (ChainHash blk, HeaderHash blk)
-&gt; SuccessorsIndex blk
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainHash blk
 -&gt; HeaderHash blk -&gt; SuccessorsIndex blk -&gt; SuccessorsIndex blk)
-&gt; (ChainHash blk, HeaderHash blk)
-&gt; SuccessorsIndex blk
-&gt; SuccessorsIndex blk
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#uncurry"><span class="hs-identifier hs-var">uncurry</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
-&gt; HeaderHash blk -&gt; SuccessorsIndex blk -&gt; SuccessorsIndex blk
forall k v.
(Ord k, Ord v) =&gt;
k -&gt; v -&gt; Map k (Set v) -&gt; Map k (Set v)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#deleteMapSet"><span class="hs-identifier hs-var">deleteMapSet</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SuccessorsIndex blk
</span><a href="#local-6989586621679857745"><span class="hs-identifier hs-var">currentSuccMap</span></a></span><span> </span><span class="annot"><span class="annottext">[(ChainHash blk, HeaderHash blk)]
</span><a href="#local-6989586621679857750"><span class="hs-identifier hs-var">deletedPairs</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>    </span><span class="annot"><span class="annottext">OpenState blk h -&gt; ModifyOpenState m blk h ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857742"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-492"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMap"><span class="hs-identifier hs-var">currentMap</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#delete"><span class="hs-identifier hs-type">Index.delete</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857739"><span class="hs-identifier hs-type">fileId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857743"><span class="hs-identifier hs-type">currentMap</span></a></span><span>
</span><span id="line-493"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentRevMap"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857748"><span class="hs-identifier hs-type">currentRevMap'</span></a></span><span>
</span><span id="line-494"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentSuccMap"><span class="hs-identifier hs-var">currentSuccMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857753"><span class="hs-identifier hs-type">currentSuccMap'</span></a></span><span>
</span><span id="line-495"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#filterByPredecessorImpl"><span class="hs-identifier hs-type">filterByPredecessorImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-498"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856842"><span class="annot"><a href="#local-6989586621679856842"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856843"><span class="annot"><a href="#local-6989586621679856843"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856842"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679856843"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856842"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856843"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679856842"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679856843"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679856843"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span id="filterByPredecessorImpl"><span class="annot"><span class="annottext">filterByPredecessorImpl :: forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#filterByPredecessorImpl"><span class="hs-identifier hs-var hs-var">filterByPredecessorImpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall h.
 OpenState blk h -&gt; ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; VolatileDBEnv m blk
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall (m :: * -&gt; *) blk a.
(IOLike m, HasHeader blk) =&gt;
(forall h. OpenState blk h -&gt; a) -&gt; VolatileDBEnv m blk -&gt; STM m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a></span><span> </span><span class="annot"><span class="annottext">((forall h.
  OpenState blk h -&gt; ChainHash blk -&gt; Set (HeaderHash blk))
 -&gt; VolatileDBEnv m blk
 -&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk)))
-&gt; (forall h.
    OpenState blk h -&gt; ChainHash blk -&gt; Set (HeaderHash blk))
-&gt; VolatileDBEnv m blk
-&gt; STM m (ChainHash blk -&gt; Set (HeaderHash blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857764"><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857764"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679857765"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679857765"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-502"></span><span>    </span><span class="annot"><span class="annottext">Set (HeaderHash blk)
-&gt; Maybe (Set (HeaderHash blk)) -&gt; Set (HeaderHash blk)
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Set (HeaderHash blk)
forall a. Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainHash blk
-&gt; Map (ChainHash blk) (Set (HeaderHash blk))
-&gt; Maybe (Set (HeaderHash blk))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679857765"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpenState blk h -&gt; Map (ChainHash blk) (Set (HeaderHash blk))
forall blk h. OpenState blk h -&gt; SuccessorsIndex blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentSuccMap"><span class="hs-identifier hs-var">currentSuccMap</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857764"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span>
</span><span id="line-504"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockInfoImpl"><span class="hs-identifier hs-type">getBlockInfoImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-505"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856844"><span class="annot"><a href="#local-6989586621679856844"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856845"><span class="annot"><a href="#local-6989586621679856845"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856844"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679856845"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856844"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856845"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-507"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679856844"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679856845"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#BlockInfo"><span class="hs-identifier hs-type">BlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856845"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span id="getBlockInfoImpl"><span class="annot"><span class="annottext">getBlockInfoImpl :: forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk
-&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getBlockInfoImpl"><span class="hs-identifier hs-var hs-var">getBlockInfoImpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall h.
 OpenState blk h -&gt; HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; VolatileDBEnv m blk
-&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
forall (m :: * -&gt; *) blk a.
(IOLike m, HasHeader blk) =&gt;
(forall h. OpenState blk h -&gt; a) -&gt; VolatileDBEnv m blk -&gt; STM m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a></span><span> </span><span class="annot"><span class="annottext">((forall h.
  OpenState blk h -&gt; HeaderHash blk -&gt; Maybe (BlockInfo blk))
 -&gt; VolatileDBEnv m blk
 -&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk)))
-&gt; (forall h.
    OpenState blk h -&gt; HeaderHash blk -&gt; Maybe (BlockInfo blk))
-&gt; VolatileDBEnv m blk
-&gt; STM m (HeaderHash blk -&gt; Maybe (BlockInfo blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679857775"><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857775"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span id="local-6989586621679857776"><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857776"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-509"></span><span>    </span><span class="annot"><span class="annottext">InternalBlockInfo blk -&gt; BlockInfo blk
forall blk. InternalBlockInfo blk -&gt; BlockInfo blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Types.html#ibiBlockInfo"><span class="hs-identifier hs-var">ibiBlockInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(InternalBlockInfo blk -&gt; BlockInfo blk)
-&gt; Maybe (InternalBlockInfo blk) -&gt; Maybe (BlockInfo blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
-&gt; Map (HeaderHash blk) (InternalBlockInfo blk)
-&gt; Maybe (InternalBlockInfo blk)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><a href="#local-6989586621679857776"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpenState blk h -&gt; Map (HeaderHash blk) (InternalBlockInfo blk)
forall blk h. OpenState blk h -&gt; ReverseIndex blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentRevMap"><span class="hs-identifier hs-var">currentRevMap</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857775"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getMaxSlotNoImpl"><span class="hs-identifier hs-type">getMaxSlotNoImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-512"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679856846"><span class="annot"><a href="#local-6989586621679856846"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679856847"><span class="annot"><a href="#local-6989586621679856847"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856846"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679856847"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856846"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679856847"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-514"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679856846"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-515"></span><span id="getMaxSlotNoImpl"><span class="annot"><span class="annottext">getMaxSlotNoImpl :: forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
VolatileDBEnv m blk -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getMaxSlotNoImpl"><span class="hs-identifier hs-var hs-var">getMaxSlotNoImpl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall h. OpenState blk h -&gt; MaxSlotNo)
-&gt; VolatileDBEnv m blk -&gt; STM m MaxSlotNo
forall (m :: * -&gt; *) blk a.
(IOLike m, HasHeader blk) =&gt;
(forall h. OpenState blk h -&gt; a) -&gt; VolatileDBEnv m blk -&gt; STM m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var">getterSTM</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; MaxSlotNo
forall h. OpenState blk h -&gt; MaxSlotNo
forall blk h. OpenState blk h -&gt; MaxSlotNo
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMaxSlotNo"><span class="hs-identifier hs-var">currentMaxSlotNo</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-comment">{------------------------------------------------------------------------------
  Internal functions
------------------------------------------------------------------------------}</span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span class="hs-comment">-- | Creates a new file and updates the 'OpenState' accordingly.</span><span>
</span><span id="line-522"></span><span class="hs-comment">-- This may throw an FsError.</span><span>
</span><span id="line-523"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#nextFile"><span class="hs-identifier hs-type">nextFile</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-524"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679857012"><span class="annot"><a href="#local-6989586621679857012"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span id="local-6989586621679857011"><span class="annot"><a href="#local-6989586621679857011"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679857013"><span class="annot"><a href="#local-6989586621679857013"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857011"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857012"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679857011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857012"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier hs-type">ModifyOpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857011"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857013"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857012"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span id="nextFile"><span class="annot"><span class="annottext">nextFile :: forall h (m :: * -&gt; *) blk.
(IOLike m, Eq h) =&gt;
HasFS m h -&gt; ModifyOpenState m blk h ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#nextFile"><span class="hs-identifier hs-var hs-var">nextFile</span></a></span></span><span> </span><span id="local-6989586621679857813"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857813"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>    </span><span id="local-6989586621679857814"><span class="annot"><span class="annottext">st :: OpenState blk h
</span><a href="#local-6989586621679857814"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">currentWriteHandle :: forall blk h. OpenState blk h -&gt; Handle h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteHandle"><span class="hs-identifier hs-var">currentWriteHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679857815"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857815"><span class="hs-identifier hs-var">curHndl</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857816"><span class="annot"><span class="annottext">FileId
currentWriteId :: forall blk h. OpenState blk h -&gt; FileId
currentWriteId :: FileId
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteId"><span class="hs-identifier hs-var hs-var">currentWriteId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679857817"><span class="annot"><span class="annottext">Index blk
currentMap :: forall blk h. OpenState blk h -&gt; Index blk
currentMap :: Index blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMap"><span class="hs-identifier hs-var hs-var">currentMap</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (OpenState blk h)
  (WithTempRegistry (OpenState blk h) m)
  (OpenState blk h)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679857818"><span class="annot"><span class="annottext">currentWriteId' :: FileId
</span><a href="#local-6989586621679857818"><span class="hs-identifier hs-var hs-var">currentWriteId'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857816"><span class="hs-identifier hs-var">currentWriteId</span></a></span><span> </span><span class="annot"><span class="annottext">FileId -&gt; FileId -&gt; FileId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">FileId
</span><span class="hs-number">1</span></span><span>
</span><span id="line-530"></span><span>        </span><span id="local-6989586621679857819"><span class="annot"><span class="annottext">file :: FsPath
</span><a href="#local-6989586621679857819"><span class="hs-identifier hs-var hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FileId -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Util.html#filePath"><span class="hs-identifier hs-var">filePath</span></a></span><span> </span><span class="annot"><span class="annottext">FileId
</span><a href="#local-6989586621679857818"><span class="hs-identifier hs-var">currentWriteId'</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span>    </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857813"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857815"><span class="hs-identifier hs-var">curHndl</span></a></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>    </span><span id="local-6989586621679857821"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679857821"><span class="hs-identifier hs-var">hndl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState blk h) m (Handle h)
-&gt; StateT
     (OpenState blk h) (WithTempRegistry (OpenState blk h) m) (Handle h)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState blk h) m (Handle h)
 -&gt; StateT
      (OpenState blk h)
      (WithTempRegistry (OpenState blk h) m)
      (Handle h))
-&gt; WithTempRegistry (OpenState blk h) m (Handle h)
-&gt; StateT
     (OpenState blk h) (WithTempRegistry (OpenState blk h) m) (Handle h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m (Handle h)
-&gt; (Handle h -&gt; m Bool)
-&gt; (OpenState blk h -&gt; Handle h -&gt; Bool)
-&gt; WithTempRegistry (OpenState blk h) m (Handle h)
forall (m :: * -&gt; *) a st.
(IOLike m, HasCallStack) =&gt;
m a
-&gt; (a -&gt; m Bool) -&gt; (st -&gt; a -&gt; Bool) -&gt; WithTempRegistry st m a
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocateTemp"><span class="hs-identifier hs-var">allocateTemp</span></a></span><span>
</span><span id="line-535"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; OpenMode -&gt; m (Handle h)
</span><span class="hs-identifier hs-var">hOpen</span></span><span>   </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857813"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679857819"><span class="hs-identifier hs-var">file</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AllowExisting -&gt; OpenMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">MustBeNew</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; m Bool
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; Handle h -&gt; m Bool
</span><span class="hs-identifier hs-var">hClose'</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679857813"><span class="hs-identifier hs-var">hasFS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handle h -&gt; Handle h -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span> </span><span class="annot"><span class="annottext">(Handle h -&gt; Handle h -&gt; Bool)
-&gt; (OpenState blk h -&gt; Handle h)
-&gt; OpenState blk h
-&gt; Handle h
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; Handle h
forall blk h. OpenState blk h -&gt; Handle h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteHandle"><span class="hs-identifier hs-var">currentWriteHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>    </span><span class="annot"><span class="annottext">OpenState blk h -&gt; ModifyOpenState m blk h ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857814"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-539"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteHandle"><span class="hs-identifier hs-var">currentWriteHandle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857821"><span class="hs-identifier hs-type">hndl</span></a></span><span>
</span><span id="line-540"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWritePath"><span class="hs-identifier hs-var">currentWritePath</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857819"><span class="hs-identifier hs-type">file</span></a></span><span>
</span><span id="line-541"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteId"><span class="hs-identifier hs-var">currentWriteId</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679857818"><span class="hs-identifier hs-type">currentWriteId'</span></a></span><span>
</span><span id="line-542"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentWriteOffset"><span class="hs-identifier hs-var">currentWriteOffset</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-number">0</span></span><span>
</span><span id="line-543"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#currentMap"><span class="hs-identifier hs-var">currentMap</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.Index.html#insert"><span class="hs-identifier hs-type">Index.insert</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857818"><span class="hs-identifier hs-type">currentWriteId'</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.FileInfo.html#empty"><span class="hs-identifier hs-type">FileInfo.empty</span></a></span><span>
</span><span id="line-544"></span><span>                                </span><span class="annot"><a href="#local-6989586621679857817"><span class="hs-identifier hs-type">currentMap</span></a></span><span>
</span><span id="line-545"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-546"></span><span>
</span><span id="line-547"></span><span class="annot"><span class="hs-comment">-- | Gets part of the 'OpenState' in 'STM'.</span></span><span>
</span><span id="line-548"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-type">getterSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-549"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679857063"><span class="annot"><a href="#local-6989586621679857063"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679857064"><span class="annot"><a href="#local-6989586621679857064"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679857065"><span class="annot"><a href="#local-6989586621679857065"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857063"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679857064"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679857062"><span class="annot"><a href="#local-6989586621679857062"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857064"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857062"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679857065"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857063"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857064"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679857063"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679857065"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-553"></span><span id="getterSTM"><span class="annot"><span class="annottext">getterSTM :: forall (m :: * -&gt; *) blk a.
(IOLike m, HasHeader blk) =&gt;
(forall h. OpenState blk h -&gt; a) -&gt; VolatileDBEnv m blk -&gt; STM m a
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#getterSTM"><span class="hs-identifier hs-var hs-var">getterSTM</span></a></span></span><span> </span><span id="local-6989586621679857840"><span class="annot"><span class="annottext">forall h. OpenState blk h -&gt; a
</span><a href="#local-6989586621679857840"><span class="hs-identifier hs-var">fromSt</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#VolatileDBEnv"><span class="hs-identifier hs-type">VolatileDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679857847"><span class="annot"><span class="annottext">RAWLock m (InternalState blk h)
varInternalState :: ()
varInternalState :: RAWLock m (InternalState blk h)
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#varInternalState"><span class="hs-identifier hs-var hs-var">varInternalState</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-554"></span><span>    </span><span id="local-6989586621679857848"><span class="annot"><span class="annottext">InternalState blk h
</span><a href="#local-6989586621679857848"><span class="hs-identifier hs-var">mSt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RAWLock m (InternalState blk h) -&gt; STM m (InternalState blk h)
forall (m :: * -&gt; *) st. IOLike m =&gt; RAWLock m st -&gt; STM m st
</span><a href="Ouroboros.Consensus.Util.MonadSTM.RAWLock.html#read"><span class="hs-identifier hs-var">RAWLock.read</span></a></span><span> </span><span class="annot"><span class="annottext">RAWLock m (InternalState blk h)
</span><a href="#local-6989586621679857847"><span class="hs-identifier hs-var">varInternalState</span></a></span><span>
</span><span id="line-555"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InternalState blk h
</span><a href="#local-6989586621679857848"><span class="hs-identifier hs-var">mSt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-556"></span><span>      </span><span class="annot"><span class="annottext">InternalState blk h
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VolatileDBError blk -&gt; STM m a
forall e a. Exception e =&gt; e -&gt; STM m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(VolatileDBError blk -&gt; STM m a) -&gt; VolatileDBError blk -&gt; STM m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall blk. ApiMisuse -&gt; VolatileDBError blk
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#ApiMisuse"><span class="hs-identifier hs-var">ApiMisuse</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679857064"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="annottext">(ApiMisuse -&gt; VolatileDBError blk)
-&gt; ApiMisuse -&gt; VolatileDBError blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SomeException -&gt; ApiMisuse
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#ClosedDBError"><span class="hs-identifier hs-var">ClosedDBError</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-557"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-type">DbOpen</span></a></span><span> </span><span id="local-6989586621679857852"><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857852"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; STM m a
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; STM m a) -&gt; a -&gt; STM m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h -&gt; a
forall h. OpenState blk h -&gt; a
</span><a href="#local-6989586621679857840"><span class="hs-identifier hs-var">fromSt</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState blk h
</span><a href="#local-6989586621679857852"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-558"></span></pre></body></html>
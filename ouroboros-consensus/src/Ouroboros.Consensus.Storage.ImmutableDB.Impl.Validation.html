<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings   #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TupleSections       #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier">ValidateEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateAndReopen"><span class="hs-identifier">validateAndReopen</span></a></span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exported for testing purposes</span></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldBeFinalised"><span class="hs-identifier">ShouldBeFinalised</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#reconstructPrimaryIndex"><span class="hs-identifier">reconstructPrimaryIndex</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier">forM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier">ExceptT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier">runExceptT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier">throwError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lazy</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%24%3E"><span class="hs-operator">($&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier">fromMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#mapMaybe"><span class="hs-identifier">mapMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#hashSize"><span class="hs-identifier">hashSize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.API</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal</span></a></span><span>
</span><span id="line-34"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unChunkNo"><span class="hs-identifier">unChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeEpochNoToChunkNo"><span class="hs-identifier">unsafeEpochNoToChunkNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a></span><span>
</span><span id="line-36"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#cachedIndex"><span class="hs-identifier">cachedIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Index</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary</span></a></span><span>
</span><span id="line-39"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#PrimaryIndex"><span class="hs-identifier">PrimaryIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier">SecondaryOffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Primary</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Secondary</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser</span></a></span><span>
</span><span id="line-43"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html#BlockSummary"><span class="hs-identifier">BlockSummary</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html#parseChunkFile"><span class="hs-identifier">parseChunkFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.State</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Serialisation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier">DecodeDisk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier">HasBinaryBlockInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#lastMaybe"><span class="hs-identifier">lastMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier">whenJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Streaming</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Of</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Streaming.Prelude</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API</span></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">-- | Bundle of arguments used most validation functions.</span><span>
</span><span id="line-57"></span><span class="hs-comment">--</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- Note that we don't use &quot;Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index&quot;</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- because we are reading and manipulating index files in different ways, e.g.,</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- truncating them.</span><span>
</span><span id="line-61"></span><span class="hs-keyword">data</span><span> </span><span id="ValidateEnv"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-var">ValidateEnv</span></a></span></span><span> </span><span id="local-6989586621679866339"><span class="annot"><a href="#local-6989586621679866339"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679866340"><span class="annot"><a href="#local-6989586621679866340"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679866341"><span class="annot"><a href="#local-6989586621679866341"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ValidateEnv"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-var">ValidateEnv</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-62"></span><span>      </span><span id="hasFS"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679866339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866341"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="chunkInfo"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="tracer"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h.
ValidateEnv m blk h -&gt; Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679866339"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceEvent"><span class="hs-identifier hs-type">TraceEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866340"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="cacheConfig"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; CacheConfig
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#cacheConfig"><span class="hs-identifier hs-var hs-var">cacheConfig</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier hs-type">Index.CacheConfig</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="codecConfig"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#codecConfig"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#CodecConfig"><span class="hs-identifier hs-type">CodecConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866340"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="checkIntegrity"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#checkIntegrity"><span class="hs-identifier hs-var hs-var">checkIntegrity</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679866340"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">-- | Perform validation as per the 'ValidationPolicy' using 'validate' and</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- create an 'OpenState' corresponding to its outcome using 'mkOpenState'.</span><span>
</span><span id="line-72"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateAndReopen"><span class="hs-identifier hs-type">validateAndReopen</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-73"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679866367"><span class="annot"><a href="#local-6989586621679866367"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679866369"><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679866375"><span class="annot"><a href="#local-6989586621679866375"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-74"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866367"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-75"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-76"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-77"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-79"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866375"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-80"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-81"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866375"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866367"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidationPolicy"><span class="hs-identifier hs-type">ValidationPolicy</span></a></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866375"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679866367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866375"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span id="validateAndReopen"><span class="annot"><span class="annottext">validateAndReopen :: forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk, Eq h,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; ResourceRegistry m
-&gt; ValidationPolicy
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateAndReopen"><span class="hs-identifier hs-var hs-var">validateAndReopen</span></a></span></span><span> </span><span id="local-6989586621679866707"><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866707"><span class="hs-identifier hs-var">validateEnv</span></a></span></span><span> </span><span id="local-6989586621679866708"><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679866708"><span class="hs-identifier hs-var">registry</span></a></span></span><span> </span><span id="local-6989586621679866709"><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="#local-6989586621679866709"><span class="hs-identifier hs-var">valPol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall blk (m :: * -&gt; *) a.
(MonadCatch m, StandardHash blk, Typeable blk) =&gt;
Proxy blk -&gt; m a -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#wrapFsError"><span class="hs-identifier hs-var">wrapFsError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679866369"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
 -&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h))
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679866712"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866712"><span class="hs-identifier hs-var">chunk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679866713"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679866713"><span class="hs-identifier hs-var">tip</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ChunkNo, WithOrigin (Tip blk))
-&gt; WithTempRegistry
     (OpenState m blk h) m (ChunkNo, WithOrigin (Tip blk))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ChunkNo, WithOrigin (Tip blk))
 -&gt; WithTempRegistry
      (OpenState m blk h) m (ChunkNo, WithOrigin (Tip blk)))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
-&gt; WithTempRegistry
     (OpenState m blk h) m (ChunkNo, WithOrigin (Tip blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
-&gt; ValidationPolicy -&gt; m (ChunkNo, WithOrigin (Tip blk))
forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; ValidationPolicy -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validate"><span class="hs-identifier hs-var">validate</span></a></span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866707"><span class="hs-identifier hs-var">validateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="#local-6989586621679866709"><span class="hs-identifier hs-var">valPol</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621679866714"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679866714"><span class="hs-identifier hs-var">index</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Index m blk h)
-&gt; WithTempRegistry (OpenState m blk h) m (Index m blk h)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Index m blk h)
 -&gt; WithTempRegistry (OpenState m blk h) m (Index m blk h))
-&gt; m (Index m blk h)
-&gt; WithTempRegistry (OpenState m blk h) m (Index m blk h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
-&gt; ResourceRegistry m
-&gt; Tracer m TraceCacheEvent
-&gt; CacheConfig
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; m (Index m blk h)
forall (m :: * -&gt; *) blk h.
(IOLike m, ConvertRawHash blk, StandardHash blk, Typeable blk) =&gt;
HasFS m h
-&gt; ResourceRegistry m
-&gt; Tracer m TraceCacheEvent
-&gt; CacheConfig
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; m (Index m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#cachedIndex"><span class="hs-identifier hs-var">cachedIndex</span></a></span><span>
</span><span id="line-89"></span><span>                      </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866715"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-90"></span><span>                      </span><span class="annot"><span class="annottext">ResourceRegistry m
</span><a href="#local-6989586621679866708"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-91"></span><span>                      </span><span class="annot"><span class="annottext">Tracer m TraceCacheEvent
</span><a href="#local-6989586621679866716"><span class="hs-identifier hs-var">cacheTracer</span></a></span><span>
</span><span id="line-92"></span><span>                      </span><span class="annot"><span class="annottext">CacheConfig
</span><a href="#local-6989586621679866717"><span class="hs-identifier hs-var">cacheConfig</span></a></span><span>
</span><span id="line-93"></span><span>                      </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679866718"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-94"></span><span>                      </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866712"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679866713"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-96"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866712"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
 -&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h))
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-97"></span><span>        </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState m blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679866721"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">TraceEvent blk
forall blk. TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#NoValidLastLocation"><span class="hs-identifier hs-var">NoValidLastLocation</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, Eq h) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#mkOpenState"><span class="hs-identifier hs-var">mkOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866715"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679866714"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866712"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
forall t. WithOrigin t
</span><span class="hs-identifier hs-var">Origin</span></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">MustBeNew</span></span><span>
</span><span id="line-99"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621679866725"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679866725"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState m blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679866721"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; Tip blk -&gt; TraceEvent blk
forall blk. ChunkNo -&gt; Tip blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidatedLastLocation"><span class="hs-identifier hs-var">ValidatedLastLocation</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866712"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679866725"><span class="hs-identifier hs-var">tip'</span></a></span><span>
</span><span id="line-101"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, Eq h) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#mkOpenState"><span class="hs-identifier hs-var">mkOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866715"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679866714"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866712"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679866713"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">AllowExisting</span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679866715"><span class="annot"><span class="annottext">HasFS m h
hasFS :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; HasFS m h
hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679866721"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
tracer :: forall (m :: * -&gt; *) blk h.
ValidateEnv m blk h -&gt; Tracer m (TraceEvent blk)
tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679866717"><span class="annot"><span class="annottext">CacheConfig
cacheConfig :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; CacheConfig
cacheConfig :: CacheConfig
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#cacheConfig"><span class="hs-identifier hs-var hs-var">cacheConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679866718"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; ChunkInfo
chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866707"><span class="hs-identifier hs-var">validateEnv</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span id="local-6989586621679866716"><span class="annot"><span class="annottext">cacheTracer :: Tracer m TraceCacheEvent
</span><a href="#local-6989586621679866716"><span class="hs-identifier hs-var hs-var">cacheTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TraceCacheEvent -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m TraceCacheEvent
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceCacheEvent -&gt; TraceEvent blk
forall blk. TraceCacheEvent -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceCacheEvent"><span class="hs-identifier hs-var">TraceCacheEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679866721"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="hs-comment">-- | Execute the 'ValidationPolicy'.</span><span>
</span><span id="line-107"></span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- Migrates first.</span><span>
</span><span id="line-109"></span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- NOTE: we don't use a 'ResourceRegistry' to allocate file handles in,</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- because validation happens on startup, so when an exception is thrown, the</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- database hasn't even been opened and the node will shut down. In which case</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- we don't have to worry about leaking handles, they will be closed when the</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- process terminates.</span><span>
</span><span id="line-115"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validate"><span class="hs-identifier hs-type">validate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-116"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679866413"><span class="annot"><a href="#local-6989586621679866413"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679866414"><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679866415"><span class="annot"><a href="#local-6989586621679866415"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-117"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866413"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-118"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-119"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-120"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-122"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-123"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866415"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidationPolicy"><span class="hs-identifier hs-type">ValidationPolicy</span></a></span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span id="validate"><span class="annot"><span class="annottext">validate :: forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; ValidationPolicy -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validate"><span class="hs-identifier hs-var hs-var">validate</span></a></span></span><span> </span><span id="local-6989586621679866768"><span class="annot"><span class="annottext">validateEnv :: ValidateEnv m blk h
</span><a href="#local-6989586621679866768"><span class="hs-identifier hs-var">validateEnv</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span class="hs-special">{</span><span> </span><span id="local-6989586621679866769"><span class="annot"><span class="annottext">HasFS m h
hasFS :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; HasFS m h
hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679866770"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
tracer :: forall (m :: * -&gt; *) blk h.
ValidateEnv m blk h -&gt; Tracer m (TraceEvent blk)
tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679866771"><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="#local-6989586621679866771"><span class="hs-identifier hs-var">valPol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">-- First migrate any old files before validating them</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="annottext">ValidateEnv m blk h -&gt; m ()
forall (m :: * -&gt; *) blk h.
(IOLike m, HasCallStack) =&gt;
ValidateEnv m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#migrate"><span class="hs-identifier hs-var">migrate</span></a></span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866768"><span class="hs-identifier hs-var">validateEnv</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621679866773"><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679866773"><span class="hs-identifier hs-var">filesInDBFolder</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m (Set String)
FsPath -&gt; m (Set String)
</span><a href="#local-6989586621679866774"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; FsPath
</span><span class="hs-identifier hs-var">mkFsPath</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679866776"><span class="annot"><span class="annottext">Set ChunkNo
</span><a href="#local-6989586621679866776"><span class="hs-identifier hs-var">chunkFiles</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set ChunkNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set ChunkNo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set String -&gt; (Set ChunkNo, Set ChunkNo, Set ChunkNo)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#dbFilesOnDisk"><span class="hs-identifier hs-var">dbFilesOnDisk</span></a></span><span> </span><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679866773"><span class="hs-identifier hs-var">filesInDBFolder</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Set ChunkNo -&gt; Maybe ChunkNo
forall a. Set a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#lookupMax"><span class="hs-identifier hs-var">Set.lookupMax</span></a></span><span> </span><span class="annot"><span class="annottext">Set ChunkNo
</span><a href="#local-6989586621679866776"><span class="hs-identifier hs-var">chunkFiles</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><span class="annottext">Maybe ChunkNo
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-comment">-- Remove left-over index files</span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-comment">-- TODO calls listDirectory again</span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#removeFilesStartingFrom"><span class="hs-identifier hs-var">removeFilesStartingFrom</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866769"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
forall t. WithOrigin t
</span><span class="hs-identifier hs-var">Origin</span></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679866780"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866780"><span class="hs-identifier hs-var">lastChunkOnDisk</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-142"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679866781"><span class="annot"><span class="annottext">validateTracer :: Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866781"><span class="hs-identifier hs-var hs-var">validateTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-143"></span><span>              </span><span class="annot"><span class="annottext">ChunkNo
-&gt; Tracer m (TraceEvent blk)
-&gt; Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866782"><span class="hs-identifier hs-var">decorateValidateTracer</span></a></span><span>
</span><span id="line-144"></span><span>                </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866780"><span class="hs-identifier hs-var">lastChunkOnDisk</span></a></span><span>
</span><span id="line-145"></span><span>                </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679866770"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-146"></span><span>        </span><span class="hs-keyword">in</span><span>
</span><span id="line-147"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="#local-6989586621679866771"><span class="hs-identifier hs-var">valPol</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-148"></span><span>          </span><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidateAllChunks"><span class="hs-identifier hs-var">ValidateAllChunks</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-149"></span><span>            </span><span class="annot"><span class="annottext">ValidateEnv m blk h
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ChunkNo
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ChunkNo
-&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateAllChunks"><span class="hs-identifier hs-var">validateAllChunks</span></a></span><span>       </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866768"><span class="hs-identifier hs-var">validateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866781"><span class="hs-identifier hs-var">validateTracer</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866780"><span class="hs-identifier hs-var">lastChunkOnDisk</span></a></span><span>
</span><span id="line-150"></span><span>          </span><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidateMostRecentChunk"><span class="hs-identifier hs-var">ValidateMostRecentChunk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-151"></span><span>            </span><span class="annot"><span class="annottext">ValidateEnv m blk h
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ChunkNo
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ChunkNo
-&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateMostRecentChunk"><span class="hs-identifier hs-var">validateMostRecentChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866768"><span class="hs-identifier hs-var">validateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866781"><span class="hs-identifier hs-var">validateTracer</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866780"><span class="hs-identifier hs-var">lastChunkOnDisk</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679866774"><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m (Set String)
listDirectory :: HasCallStack =&gt; FsPath -&gt; m (Set String)
listDirectory :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
</span><a href="#local-6989586621679866774"><span class="hs-identifier hs-var hs-var">listDirectory</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866769"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-comment">-- | Using the Functor instance of TraceChunkValidation, by a contravariant</span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-comment">-- tracer annotate the event with the total number of chunks on the relevant</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- constructors of the datatype.</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><a href="#local-6989586621679866782"><span class="hs-identifier hs-type">decorateValidateTracer</span></a></span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679866413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceEvent"><span class="hs-identifier hs-type">TraceEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679866413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceChunkValidation"><span class="hs-identifier hs-type">TraceChunkValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866414"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621679866782"><span class="annot"><span class="annottext">decorateValidateTracer :: ChunkNo
-&gt; Tracer m (TraceEvent blk)
-&gt; Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866782"><span class="hs-identifier hs-var hs-var">decorateValidateTracer</span></a></span></span><span> </span><span id="local-6989586621679866789"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866789"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk)
-&gt; Tracer m (TraceChunkValidation blk ())
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TraceChunkValidation blk ChunkNo -&gt; TraceEvent blk
forall blk. TraceChunkValidation blk ChunkNo -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ChunkValidationEvent"><span class="hs-identifier hs-var">ChunkValidationEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk ChunkNo -&gt; TraceEvent blk)
-&gt; (TraceChunkValidation blk ()
    -&gt; TraceChunkValidation blk ChunkNo)
-&gt; TraceChunkValidation blk ()
-&gt; TraceEvent blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(() -&gt; ChunkNo)
-&gt; TraceChunkValidation blk () -&gt; TraceChunkValidation blk ChunkNo
forall a b.
(a -&gt; b)
-&gt; TraceChunkValidation blk a -&gt; TraceChunkValidation blk b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; () -&gt; ChunkNo
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866789"><span class="hs-identifier hs-var">c'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="hs-comment">-- | Validate chunks from oldest to newest, stop after the most recent chunk</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- on disk. During this validation, keep track of the last valid block we</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- encountered. If at the end, that block is not in the last chunk on disk,</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- remove the chunk and index files after that chunk.</span><span>
</span><span id="line-170"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateAllChunks"><span class="hs-identifier hs-type">validateAllChunks</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-171"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679866452"><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679866453"><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679866454"><span class="annot"><a href="#local-6989586621679866454"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-172"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-173"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-174"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-175"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-177"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-178"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866454"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceChunkValidation"><span class="hs-identifier hs-type">TraceChunkValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-182"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Most recent chunk on disk</span></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span id="validateAllChunks"><span class="annot"><span class="annottext">validateAllChunks :: forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ChunkNo
-&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateAllChunks"><span class="hs-identifier hs-var hs-var">validateAllChunks</span></a></span></span><span> </span><span id="local-6989586621679866841"><span class="annot"><span class="annottext">validateEnv :: ValidateEnv m blk h
</span><a href="#local-6989586621679866841"><span class="hs-identifier hs-var">validateEnv</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679866842"><span class="annot"><span class="annottext">HasFS m h
hasFS :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; HasFS m h
hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679866843"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; ChunkInfo
chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679866844"><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866844"><span class="hs-identifier hs-var">validateTracer</span></a></span></span><span> </span><span id="local-6989586621679866845"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866845"><span class="hs-identifier hs-var">lastChunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; ChunkNo -&gt; ChainHash blk -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866846"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
forall t. WithOrigin t
</span><span class="hs-identifier hs-var">Origin</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
forall {k} (b :: k). ChainHash b
</span><span class="hs-identifier hs-var">GenesisHash</span></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><a href="#local-6989586621679866846"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-188"></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ The last valid chunk and tip</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>                          </span><span class="hs-comment">-- ^ The chunk to validate now</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span>                    </span><span class="hs-comment">-- ^ The hash of the last block of</span><span>
</span><span id="line-191"></span><span>                                          </span><span class="hs-comment">-- the previous chunk</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621679866846"><span class="annot"><span class="annottext">go :: (ChunkNo, WithOrigin (Tip blk))
-&gt; ChunkNo -&gt; ChainHash blk -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866846"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679866848"><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866848"><span class="hs-identifier hs-var">lastValid</span></a></span></span><span> </span><span id="local-6989586621679866849"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866849"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679866850"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679866850"><span class="hs-identifier hs-var">prevHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679866852"><span class="annot"><span class="annottext">shouldBeFinalised :: ShouldBeFinalised
</span><a href="#local-6989586621679866852"><span class="hs-identifier hs-var hs-var">shouldBeFinalised</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866849"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866845"><span class="hs-identifier hs-var">lastChunk</span></a></span><span>
</span><span id="line-196"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldNotBeFinalised"><span class="hs-identifier hs-var">ShouldNotBeFinalised</span></a></span><span>
</span><span id="line-197"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldBeFinalised"><span class="hs-identifier hs-var">ShouldBeFinalised</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="annot"><span class="annottext">ExceptT () m (Maybe (Tip blk)) -&gt; m (Either () (Maybe (Tip blk)))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span>
</span><span id="line-199"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidateEnv m blk h
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; Maybe (ChainHash blk)
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ExceptT () m (Maybe (Tip blk))
forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; Maybe (ChainHash blk)
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ExceptT () m (Maybe (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateChunk"><span class="hs-identifier hs-var">validateChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866841"><span class="hs-identifier hs-var">validateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="#local-6989586621679866852"><span class="hs-identifier hs-var">shouldBeFinalised</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866849"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainHash blk -&gt; Maybe (ChainHash blk)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679866850"><span class="hs-identifier hs-var">prevHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866844"><span class="hs-identifier hs-var">validateTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Either () (Maybe (Tip blk)))
-&gt; (Either () (Maybe (Tip blk))
    -&gt; m (ChunkNo, WithOrigin (Tip blk)))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-200"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span class="hs-special">(</span><span class="hs-special">)</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk)) -&gt; ChunkNo -&gt; m ()
</span><a href="#local-6989586621679866856"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866848"><span class="hs-identifier hs-var">lastValid</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866849"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
-&gt; (ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; b -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%24%3E"><span class="hs-operator hs-var">$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866848"><span class="hs-identifier hs-var">lastValid</span></a></span><span>
</span><span id="line-201"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Tip blk)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; ChunkNo -&gt; ChainHash blk -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866857"><span class="hs-identifier hs-var">continueOrStop</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866848"><span class="hs-identifier hs-var">lastValid</span></a></span><span>                   </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866849"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679866850"><span class="hs-identifier hs-var">prevHash</span></a></span><span>
</span><span id="line-202"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679866858"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679866858"><span class="hs-identifier hs-var">validBlk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; ChunkNo -&gt; ChainHash blk -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866857"><span class="hs-identifier hs-var">continueOrStop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866849"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Tip blk -&gt; WithOrigin (Tip blk)
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679866858"><span class="hs-identifier hs-var">validBlk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866849"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679866859"><span class="hs-identifier hs-var">prevHash'</span></a></span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-204"></span><span>              </span><span id="local-6989586621679866859"><span class="annot"><span class="annottext">prevHash' :: ChainHash blk
</span><a href="#local-6989586621679866859"><span class="hs-identifier hs-var hs-var">prevHash'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderHash blk -&gt; ChainHash blk
forall {k} (b :: k). HeaderHash b -&gt; ChainHash b
</span><span class="hs-identifier hs-var">BlockHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; HeaderHash blk
forall blk. Tip blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipHash"><span class="hs-identifier hs-var">tipHash</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679866858"><span class="hs-identifier hs-var">validBlk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-comment">-- | Validate the next chunk, unless the chunk just validated is the last</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-comment">-- chunk to validate. Cleanup files corresponding to chunks after the</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- chunk in which we found the last valid block. Return that chunk and the</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- tip corresponding to that block.</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><a href="#local-6989586621679866857"><span class="hs-identifier hs-type">continueOrStop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-211"></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>        </span><span class="hs-comment">-- ^ The chunk just validated</span><span>
</span><span id="line-213"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span>  </span><span class="hs-comment">-- ^ The hash of the last block of the previous chunk</span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>    </span><span id="local-6989586621679866857"><span class="annot"><span class="annottext">continueOrStop :: (ChunkNo, WithOrigin (Tip blk))
-&gt; ChunkNo -&gt; ChainHash blk -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866857"><span class="hs-identifier hs-var hs-var">continueOrStop</span></a></span></span><span> </span><span id="local-6989586621679866862"><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866862"><span class="hs-identifier hs-var">lastValid</span></a></span></span><span> </span><span id="local-6989586621679866863"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866863"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679866864"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679866864"><span class="hs-identifier hs-var">prevHash</span></a></span></span><span>
</span><span id="line-216"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866863"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866845"><span class="hs-identifier hs-var">lastChunk</span></a></span><span>
</span><span id="line-217"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866844"><span class="hs-identifier hs-var">validateTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; () -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; validateTo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidatedChunk"><span class="hs-identifier hs-var">ValidatedChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866863"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; ChunkNo -&gt; ChainHash blk -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866846"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866862"><span class="hs-identifier hs-var">lastValid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866863"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679866864"><span class="hs-identifier hs-var">prevHash</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; m (ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866863"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866845"><span class="hs-identifier hs-var">lastChunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (ChunkNo, WithOrigin (Tip blk))
 -&gt; m (ChunkNo, WithOrigin (Tip blk)))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-comment">-- Cleanup is only needed when the final chunk was empty, yet valid.</span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk)) -&gt; ChunkNo -&gt; m ()
</span><a href="#local-6989586621679866856"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866862"><span class="hs-identifier hs-var">lastValid</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866863"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866862"><span class="hs-identifier hs-var">lastValid</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- | Remove left over files from chunks newer than the last chunk</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">-- containing a valid file. Also unfinalise it if necessary.</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><a href="#local-6989586621679866856"><span class="hs-identifier hs-type">cleanup</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-229"></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ The last valid chunk and tip</span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>  </span><span class="hs-comment">-- ^ The last validated chunk, could have been invalid or</span><span>
</span><span id="line-231"></span><span>                  </span><span class="hs-comment">-- empty</span><span>
</span><span id="line-232"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866452"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621679866856"><span class="annot"><span class="annottext">cleanup :: (ChunkNo, WithOrigin (Tip blk)) -&gt; ChunkNo -&gt; m ()
</span><a href="#local-6989586621679866856"><span class="hs-identifier hs-var hs-var">cleanup</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679866868"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866868"><span class="hs-identifier hs-var">lastValidChunk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679866869"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679866869"><span class="hs-identifier hs-var">tip</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679866870"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866870"><span class="hs-identifier hs-var">lastValidatedChunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679866869"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#removeFilesStartingFrom"><span class="hs-identifier hs-var">removeFilesStartingFrom</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866842"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#removeFilesStartingFrom"><span class="hs-identifier hs-var">removeFilesStartingFrom</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866842"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866868"><span class="hs-identifier hs-var">lastValidChunk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866868"><span class="hs-identifier hs-var">lastValidChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866870"><span class="hs-identifier hs-var">lastValidatedChunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-239"></span><span>          </span><span class="annot"><span class="annottext">Proxy blk -&gt; HasFS m h -&gt; ChunkInfo -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) blk h.
(HasCallStack, MonadThrow m, StandardHash blk, Typeable blk) =&gt;
Proxy blk -&gt; HasFS m h -&gt; ChunkInfo -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#unfinalise"><span class="hs-identifier hs-var">Primary.unfinalise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679866453"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866842"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679866843"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866868"><span class="hs-identifier hs-var">lastValidChunk</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">-- | Validate the given most recent chunk. If that chunk contains no valid</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- block, try the chunk before it, and so on. Stop as soon as an chunk with a</span><span>
</span><span id="line-243"></span><span class="hs-comment">-- valid block is found, returning that chunk and the tip corresponding to</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- that block. If no valid blocks are found, chunk 0 and 'TipGen' is returned.</span><span>
</span><span id="line-245"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateMostRecentChunk"><span class="hs-identifier hs-type">validateMostRecentChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-246"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679866872"><span class="annot"><a href="#local-6989586621679866872"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679866873"><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679866874"><span class="annot"><a href="#local-6989586621679866874"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-247"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866872"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-248"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-249"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-250"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-252"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-253"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866874"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679866872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceChunkValidation"><span class="hs-identifier hs-type">TraceChunkValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-257"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Most recent chunk on disk, the chunk to validate</span></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span id="validateMostRecentChunk"><span class="annot"><span class="annottext">validateMostRecentChunk :: forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ChunkNo
-&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateMostRecentChunk"><span class="hs-identifier hs-var hs-var">validateMostRecentChunk</span></a></span></span><span> </span><span id="local-6989586621679866904"><span class="annot"><span class="annottext">validateEnv :: ValidateEnv m blk h
</span><a href="#local-6989586621679866904"><span class="hs-identifier hs-var">validateEnv</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679866905"><span class="annot"><span class="annottext">HasFS m h
hasFS :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; HasFS m h
hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679866906"><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866906"><span class="hs-identifier hs-var">validateTracer</span></a></span></span><span> </span><span id="local-6989586621679866907"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866907"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>    </span><span id="local-6989586621679866908"><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866908"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866909"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866907"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866906"><span class="hs-identifier hs-var">validateTracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; () -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; validateTo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidatedChunk"><span class="hs-identifier hs-var">ValidatedChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866907"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866908"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><a href="#local-6989586621679866909"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866872"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866873"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>    </span><span id="local-6989586621679866909"><span class="annot"><span class="annottext">go :: ChunkNo -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866909"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679866910"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866910"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT () m (Maybe (Tip blk)) -&gt; m (Either () (Maybe (Tip blk)))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValidateEnv m blk h
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; Maybe (ChainHash blk)
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ExceptT () m (Maybe (Tip blk))
forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; Maybe (ChainHash blk)
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ExceptT () m (Maybe (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateChunk"><span class="hs-identifier hs-var">validateChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679866904"><span class="hs-identifier hs-var">validateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldNotBeFinalised"><span class="hs-identifier hs-var">ShouldNotBeFinalised</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866910"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ChainHash blk)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679866906"><span class="hs-identifier hs-var">validateTracer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Either () (Maybe (Tip blk)))
-&gt; (Either () (Maybe (Tip blk))
    -&gt; m (ChunkNo, WithOrigin (Tip blk)))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-267"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679866911"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679866911"><span class="hs-identifier hs-var">validBlk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>            </span><span class="hs-comment">-- Found a valid block, we can stop now.</span><span>
</span><span id="line-269"></span><span>            </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#removeFilesStartingFrom"><span class="hs-identifier hs-var">removeFilesStartingFrom</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866905"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866910"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>            </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866910"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Tip blk -&gt; WithOrigin (Tip blk)
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679866911"><span class="hs-identifier hs-var">validBlk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>        </span><span class="annot"><span class="annottext">Either () (Maybe (Tip blk))
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-comment">-- This chunk file is unusable: either the chunk is empty or</span><span>
</span><span id="line-272"></span><span>           </span><span class="hs-comment">-- everything after it should be truncated.</span><span>
</span><span id="line-273"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679866912"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866912"><span class="hs-identifier hs-var">chunk'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; Maybe ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#prevChunkNo"><span class="hs-identifier hs-var">prevChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866910"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; m (ChunkNo, WithOrigin (Tip blk))
</span><a href="#local-6989586621679866909"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679866912"><span class="hs-identifier hs-var">chunk'</span></a></span><span>
</span><span id="line-274"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>            </span><span class="hs-comment">-- Found no valid blocks on disk.</span><span>
</span><span id="line-276"></span><span>            </span><span class="hs-comment">-- TODO be more precise in which cases we need which cleanup.</span><span>
</span><span id="line-277"></span><span>            </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#removeFilesStartingFrom"><span class="hs-identifier hs-var">removeFilesStartingFrom</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679866905"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span>
</span><span id="line-278"></span><span>            </span><span class="annot"><span class="annottext">(ChunkNo, WithOrigin (Tip blk))
-&gt; m (ChunkNo, WithOrigin (Tip blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
forall t. WithOrigin t
</span><span class="hs-identifier hs-var">Origin</span></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">-- | Iff the chunk is the most recent chunk, it should not be finalised.</span><span>
</span><span id="line-281"></span><span class="hs-comment">--</span><span>
</span><span id="line-282"></span><span class="hs-comment">-- With finalising, we mean: if there are one or more empty slots at the end</span><span>
</span><span id="line-283"></span><span class="hs-comment">-- of the chunk, the primary index should be padded with offsets to indicate</span><span>
</span><span id="line-284"></span><span class="hs-comment">-- that these slots are empty. See 'Primary.backfill'.</span><span>
</span><span id="line-285"></span><span class="hs-keyword">data</span><span> </span><span id="ShouldBeFinalised"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldBeFinalised"><span class="hs-identifier hs-var">ShouldBeFinalised</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-286"></span><span>    </span><span id="ShouldBeFinalised"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldBeFinalised"><span class="hs-identifier hs-var">ShouldBeFinalised</span></a></span></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ShouldNotBeFinalised"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldNotBeFinalised"><span class="hs-identifier hs-var">ShouldNotBeFinalised</span></a></span></span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679866916"><span id="local-6989586621679866918"><span id="local-6989586621679866922"><span class="annot"><span class="annottext">Int -&gt; ShouldBeFinalised -&gt; ShowS
[ShouldBeFinalised] -&gt; ShowS
ShouldBeFinalised -&gt; String
(Int -&gt; ShouldBeFinalised -&gt; ShowS)
-&gt; (ShouldBeFinalised -&gt; String)
-&gt; ([ShouldBeFinalised] -&gt; ShowS)
-&gt; Show ShouldBeFinalised
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ShouldBeFinalised -&gt; ShowS
showsPrec :: Int -&gt; ShouldBeFinalised -&gt; ShowS
$cshow :: ShouldBeFinalised -&gt; String
show :: ShouldBeFinalised -&gt; String
$cshowList :: [ShouldBeFinalised] -&gt; ShowS
showList :: [ShouldBeFinalised] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="hs-comment">-- | Validate the given chunk</span><span>
</span><span id="line-291"></span><span class="hs-comment">--</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- * Invalid or missing chunk files will cause truncation. All blocks after a</span><span>
</span><span id="line-293"></span><span class="hs-comment">--   gap in blocks (due to a missing blocks or invalid block(s)) are</span><span>
</span><span id="line-294"></span><span class="hs-comment">--   truncated.</span><span>
</span><span id="line-295"></span><span class="hs-comment">--</span><span>
</span><span id="line-296"></span><span class="hs-comment">-- * Chunk files are the main source of truth. Primary and secondary index</span><span>
</span><span id="line-297"></span><span class="hs-comment">--   files can be reconstructed from the chunk files using the</span><span>
</span><span id="line-298"></span><span class="hs-comment">--   'ChunkFileParser'. If index files are missing, corrupt, or do not match</span><span>
</span><span id="line-299"></span><span class="hs-comment">--   the chunk files, they are overwritten.</span><span>
</span><span id="line-300"></span><span class="hs-comment">--</span><span>
</span><span id="line-301"></span><span class="hs-comment">-- * The 'ChunkFileParser' checks whether the hashes (header hash) line up</span><span>
</span><span id="line-302"></span><span class="hs-comment">--   within an chunk. When they do not, we truncate the chunk, including the</span><span>
</span><span id="line-303"></span><span class="hs-comment">--   block of which its previous hash does not match the hash of the previous</span><span>
</span><span id="line-304"></span><span class="hs-comment">--   block.</span><span>
</span><span id="line-305"></span><span class="hs-comment">--</span><span>
</span><span id="line-306"></span><span class="hs-comment">-- * For each block, the 'ChunkFileParser' checks whether the checksum (and</span><span>
</span><span id="line-307"></span><span class="hs-comment">--   other fields) from the secondary index file match the ones retrieved from</span><span>
</span><span id="line-308"></span><span class="hs-comment">--   the actual block. If they do, the block has not been corrupted. If they</span><span>
</span><span id="line-309"></span><span class="hs-comment">--   don't match or if the secondary index file is missing or corrupt, we have</span><span>
</span><span id="line-310"></span><span class="hs-comment">--   to do the expensive integrity check of the block itself to determine</span><span>
</span><span id="line-311"></span><span class="hs-comment">--   whether it is corrupt or not.</span><span>
</span><span id="line-312"></span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span class="hs-comment">-- * This function checks whether the first block in the chunk fits onto the</span><span>
</span><span id="line-314"></span><span class="hs-comment">--   last block of the previous chunk by checking the hashes. If they do not</span><span>
</span><span id="line-315"></span><span class="hs-comment">--   fit, this chunk is truncated and @()@ is thrown.</span><span>
</span><span id="line-316"></span><span class="hs-comment">--</span><span>
</span><span id="line-317"></span><span class="hs-comment">-- * When an invalid block needs to be truncated, trailing empty slots are</span><span>
</span><span id="line-318"></span><span class="hs-comment">--   also truncated so that the tip of the database will always point to a</span><span>
</span><span id="line-319"></span><span class="hs-comment">--   valid block or EBB.</span><span>
</span><span id="line-320"></span><span class="hs-comment">--</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- * All but the most recent chunk in the database should be finalised, i.e.</span><span>
</span><span id="line-322"></span><span class="hs-comment">--   padded to the size of the chunk.</span><span>
</span><span id="line-323"></span><span class="hs-comment">--</span><span>
</span><span id="line-324"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateChunk"><span class="hs-identifier hs-type">validateChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-325"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679866478"><span class="annot"><a href="#local-6989586621679866478"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679866479"><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679866480"><span class="annot"><a href="#local-6989586621679866480"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-326"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866478"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-327"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-328"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-329"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-331"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-332"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866478"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866480"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldBeFinalised"><span class="hs-identifier hs-type">ShouldBeFinalised</span></a></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ChainHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>     </span><span class="hs-comment">-- ^ The hash of the last block of the previous chunk. 'Nothing' if</span><span>
</span><span id="line-338"></span><span>     </span><span class="hs-comment">-- unknown. When this is the first chunk, it should be 'Just Origin'.</span><span>
</span><span id="line-339"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679866478"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceChunkValidation"><span class="hs-identifier hs-type">TraceChunkValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679866478"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>     </span><span class="hs-comment">-- ^ When non-empty, the 'Tip' corresponds to the last valid block in the</span><span>
</span><span id="line-342"></span><span>     </span><span class="hs-comment">-- chunk.</span><span>
</span><span id="line-343"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-344"></span><span>     </span><span class="hs-comment">-- When the chunk file is missing or when we should truncate starting from</span><span>
</span><span id="line-345"></span><span>     </span><span class="hs-comment">-- this chunk because it doesn't fit onto the previous one, @()@ is thrown.</span><span>
</span><span id="line-346"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-347"></span><span>     </span><span class="hs-comment">-- Note that when an invalid block is detected, we don't throw, but we</span><span>
</span><span id="line-348"></span><span>     </span><span class="hs-comment">-- truncate the chunk file. When validating the chunk file after it, we</span><span>
</span><span id="line-349"></span><span>     </span><span class="hs-comment">-- would notice it doesn't fit anymore, and then throw.</span><span>
</span><span id="line-350"></span><span id="validateChunk"><span class="annot"><span class="annottext">validateChunk :: forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; Maybe (ChainHash blk)
-&gt; Tracer m (TraceChunkValidation blk ())
-&gt; ExceptT () m (Maybe (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateChunk"><span class="hs-identifier hs-var hs-var">validateChunk</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621679867052"><span id="local-6989586621679867053"><span id="local-6989586621679867054"><span id="local-6989586621679867055"><span id="local-6989586621679867056"><span id="local-6989586621679867057"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
CodecConfig blk
HasFS m h
ChunkInfo
CacheConfig
blk -&gt; Bool
hasFS :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; HasFS m h
chunkInfo :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; ChunkInfo
tracer :: forall (m :: * -&gt; *) blk h.
ValidateEnv m blk h -&gt; Tracer m (TraceEvent blk)
cacheConfig :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; CacheConfig
codecConfig :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; CodecConfig blk
checkIntegrity :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; blk -&gt; Bool
hasFS :: HasFS m h
chunkInfo :: ChunkInfo
tracer :: Tracer m (TraceEvent blk)
cacheConfig :: CacheConfig
codecConfig :: CodecConfig blk
checkIntegrity :: blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679867058"><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="#local-6989586621679867058"><span class="hs-identifier hs-var">shouldBeFinalised</span></a></span></span><span> </span><span id="local-6989586621679867059"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679867060"><span class="annot"><span class="annottext">Maybe (ChainHash blk)
</span><a href="#local-6989586621679867060"><span class="hs-identifier hs-var">mbPrevHash</span></a></span></span><span> </span><span id="local-6989586621679867061"><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-351"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; ExceptT () m ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ExceptT () m ()) -&gt; m () -&gt; ExceptT () m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; () -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; validateTo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#StartedValidatingChunk"><span class="hs-identifier hs-var">StartedValidatingChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>    </span><span id="local-6989586621679867063"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867063"><span class="hs-identifier hs-var">chunkFileExists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; ExceptT () m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; ExceptT () m Bool) -&gt; m Bool -&gt; ExceptT () m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m Bool
FsPath -&gt; m Bool
</span><a href="#local-6989586621679867064"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679867065"><span class="hs-identifier hs-var">chunkFile</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ExceptT () m () -&gt; ExceptT () m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867063"><span class="hs-identifier hs-var">chunkFileExists</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT () m () -&gt; ExceptT () m ())
-&gt; ExceptT () m () -&gt; ExceptT () m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; ExceptT () m ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ExceptT () m ()) -&gt; m () -&gt; ExceptT () m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#MissingChunkFile"><span class="hs-identifier hs-var">MissingChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">() -&gt; ExceptT () m ()
forall a. () -&gt; ExceptT () m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-comment">-- Read the entries from the secondary index file, if it exists.</span><span>
</span><span id="line-358"></span><span>    </span><span id="local-6989586621679867067"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867067"><span class="hs-identifier hs-var">secondaryIndexFileExists</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; ExceptT () m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; ExceptT () m Bool) -&gt; m Bool -&gt; ExceptT () m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m Bool
FsPath -&gt; m Bool
</span><a href="#local-6989586621679867064"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679867068"><span class="hs-identifier hs-var">secondaryIndexFile</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span id="local-6989586621679867069"><span class="annot"><span class="annottext">[Entry blk]
</span><a href="#local-6989586621679867069"><span class="hs-identifier hs-var">entriesFromSecondaryIndex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [Entry blk] -&gt; ExceptT () m [Entry blk]
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m [Entry blk] -&gt; ExceptT () m [Entry blk])
-&gt; m [Entry blk] -&gt; ExceptT () m [Entry blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867067"><span class="hs-identifier hs-var">secondaryIndexFileExists</span></a></span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(ImmutableDBError blk -&gt; Maybe ())
-&gt; m [WithBlockSize (Entry blk)]
-&gt; m (Either () [WithBlockSize (Entry blk)])
forall e b a.
Exception e =&gt;
(e -&gt; Maybe b) -&gt; m a -&gt; m (Either b a)
forall (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b) -&gt; m a -&gt; m (Either b a)
</span><span class="hs-identifier hs-var">tryJust</span></span><span> </span><span class="annot"><span class="annottext">ImmutableDBError blk -&gt; Maybe ()
</span><a href="#local-6989586621679867071"><span class="hs-identifier hs-var">isInvalidFileError</span></a></span><span>
</span><span id="line-361"></span><span>        </span><span class="hs-comment">-- Note the 'maxBound': it is used to calculate the block size for</span><span>
</span><span id="line-362"></span><span>        </span><span class="hs-comment">-- each entry, but we don't care about block sizes here, so we use</span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-comment">-- some dummy value.</span><span>
</span><span id="line-364"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasFS m h
-&gt; SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, MonadThrow m, StandardHash blk,
 Typeable blk) =&gt;
HasFS m h
-&gt; SecondaryOffset
-&gt; ChunkNo
-&gt; (Entry blk -&gt; Bool)
-&gt; Word64
-&gt; IsEBB
-&gt; m [WithBlockSize (Entry blk)]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#readAllEntries"><span class="hs-identifier hs-var">Secondary.readAllEntries</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867052"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Entry blk -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64
forall a. Bounded a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="Ouroboros.Consensus.Block.EBB.html#IsEBB"><span class="hs-identifier hs-var">IsEBB</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Either () [WithBlockSize (Entry blk)])
-&gt; (Either () [WithBlockSize (Entry blk)] -&gt; m [Entry blk])
-&gt; m [Entry blk]
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-365"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#InvalidSecondaryIndex"><span class="hs-identifier hs-var">InvalidSecondaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-367"></span><span>            </span><span class="annot"><span class="annottext">[Entry blk] -&gt; m [Entry blk]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-368"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679867076"><span class="annot"><span class="annottext">[WithBlockSize (Entry blk)]
</span><a href="#local-6989586621679867076"><span class="hs-identifier hs-var">entriesFromFile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">[Entry blk] -&gt; m [Entry blk]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">([Entry blk] -&gt; m [Entry blk]) -&gt; [Entry blk] -&gt; m [Entry blk]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Entry blk] -&gt; [Entry blk]
forall hash. [Entry hash] -&gt; [Entry hash]
</span><a href="#local-6989586621679867077"><span class="hs-identifier hs-var">fixupEBB</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(WithBlockSize (Entry blk) -&gt; Entry blk)
-&gt; [WithBlockSize (Entry blk)] -&gt; [Entry blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">WithBlockSize (Entry blk) -&gt; Entry blk
forall a. WithBlockSize a -&gt; a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#withoutBlockSize"><span class="hs-identifier hs-var">withoutBlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">[WithBlockSize (Entry blk)]
</span><a href="#local-6989586621679867076"><span class="hs-identifier hs-var">entriesFromFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-371"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#MissingSecondaryIndex"><span class="hs-identifier hs-var">MissingSecondaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-372"></span><span>        </span><span class="annot"><span class="annottext">[Entry blk] -&gt; m [Entry blk]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-373"></span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-comment">-- Parse the chunk file using the checksums from the secondary index file</span><span>
</span><span id="line-375"></span><span>    </span><span class="hs-comment">-- as input. If the checksums match, the parser doesn't have to do the</span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-comment">-- expensive integrity check of a block.</span><span>
</span><span id="line-377"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679867080"><span class="annot"><span class="annottext">expectedChecksums :: [CRC]
</span><a href="#local-6989586621679867080"><span class="hs-identifier hs-var hs-var">expectedChecksums</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Entry blk -&gt; CRC) -&gt; [Entry blk] -&gt; [CRC]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; CRC
forall blk. Entry blk -&gt; CRC
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#checksum"><span class="hs-identifier hs-var">Secondary.checksum</span></a></span><span> </span><span class="annot"><span class="annottext">[Entry blk]
</span><a href="#local-6989586621679867069"><span class="hs-identifier hs-var">entriesFromSecondaryIndex</span></a></span><span>
</span><span id="line-378"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679867082"><span class="annot"><span class="annottext">[(BlockSummary blk, ChainHash blk)]
</span><a href="#local-6989586621679867082"><span class="hs-identifier hs-var">entriesWithPrevHashes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867083"><span class="annot"><span class="annottext">Maybe (ChunkFileError blk, Word64)
</span><a href="#local-6989586621679867083"><span class="hs-identifier hs-var">mbErr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ([(BlockSummary blk, ChainHash blk)],
   Maybe (ChunkFileError blk, Word64))
-&gt; ExceptT
     ()
     m
     ([(BlockSummary blk, ChainHash blk)],
      Maybe (ChunkFileError blk, Word64))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m ([(BlockSummary blk, ChainHash blk)],
    Maybe (ChunkFileError blk, Word64))
 -&gt; ExceptT
      ()
      m
      ([(BlockSummary blk, ChainHash blk)],
       Maybe (ChunkFileError blk, Word64)))
-&gt; m ([(BlockSummary blk, ChainHash blk)],
      Maybe (ChunkFileError blk, Word64))
-&gt; ExceptT
     ()
     m
     ([(BlockSummary blk, ChainHash blk)],
      Maybe (ChunkFileError blk, Word64))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-379"></span><span>        </span><span class="annot"><span class="annottext">CodecConfig blk
-&gt; HasFS m h
-&gt; (blk -&gt; Bool)
-&gt; FsPath
-&gt; [CRC]
-&gt; (Stream
      (Of (BlockSummary blk, ChainHash blk))
      m
      (Maybe (ChunkFileError blk, Word64))
    -&gt; m ([(BlockSummary blk, ChainHash blk)],
          Maybe (ChunkFileError blk, Word64)))
-&gt; m ([(BlockSummary blk, ChainHash blk)],
      Maybe (ChunkFileError blk, Word64))
forall (m :: * -&gt; *) blk h r.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk)) =&gt;
CodecConfig blk
-&gt; HasFS m h
-&gt; (blk -&gt; Bool)
-&gt; FsPath
-&gt; [CRC]
-&gt; (Stream
      (Of (BlockSummary blk, ChainHash blk))
      m
      (Maybe (ChunkFileError blk, Word64))
    -&gt; m r)
-&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html#parseChunkFile"><span class="hs-identifier hs-var">parseChunkFile</span></a></span><span>
</span><span id="line-380"></span><span>          </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679867056"><span class="hs-identifier hs-var">codecConfig</span></a></span><span>
</span><span id="line-381"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867052"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-382"></span><span>          </span><span class="annot"><span class="annottext">blk -&gt; Bool
</span><a href="#local-6989586621679867057"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span>
</span><span id="line-383"></span><span>          </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679867065"><span class="hs-identifier hs-var">chunkFile</span></a></span><span>
</span><span id="line-384"></span><span>          </span><span class="annot"><span class="annottext">[CRC]
</span><a href="#local-6989586621679867080"><span class="hs-identifier hs-var">expectedChecksums</span></a></span><span>
</span><span id="line-385"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679867084"><span class="annot"><span class="annottext">Stream
  (Of (BlockSummary blk, ChainHash blk))
  m
  (Maybe (ChunkFileError blk, Word64))
</span><a href="#local-6989586621679867084"><span class="hs-identifier hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679867085"><span class="annot"><span class="annottext">[(BlockSummary blk, ChainHash blk)]
</span><a href="#local-6989586621679867085"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&gt;</span></span><span> </span><span id="local-6989586621679867087"><span class="annot"><span class="annottext">Maybe (ChunkFileError blk, Word64)
</span><a href="#local-6989586621679867087"><span class="hs-identifier hs-var">mbErr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(BlockSummary blk, ChainHash blk)]
</span><a href="#local-6989586621679867085"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ChunkFileError blk, Word64)
</span><a href="#local-6989586621679867087"><span class="hs-identifier hs-var">mbErr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Of
   [(BlockSummary blk, ChainHash blk)]
   (Maybe (ChunkFileError blk, Word64))
 -&gt; ([(BlockSummary blk, ChainHash blk)],
     Maybe (ChunkFileError blk, Word64)))
-&gt; m (Of
        [(BlockSummary blk, ChainHash blk)]
        (Maybe (ChunkFileError blk, Word64)))
-&gt; m ([(BlockSummary blk, ChainHash blk)],
      Maybe (ChunkFileError blk, Word64))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
  (Of (BlockSummary blk, ChainHash blk))
  m
  (Maybe (ChunkFileError blk, Word64))
-&gt; m (Of
        [(BlockSummary blk, ChainHash blk)]
        (Maybe (ChunkFileError blk, Word64)))
forall (m :: * -&gt; *) a r.
Monad m =&gt;
Stream (Of a) m r -&gt; m (Of [a] r)
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">Stream
  (Of (BlockSummary blk, ChainHash blk))
  m
  (Maybe (ChunkFileError blk, Word64))
</span><a href="#local-6989586621679867084"><span class="hs-identifier hs-var">entries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-comment">-- Check whether the first block of this chunk fits onto the last block of</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-comment">-- the previous chunk.</span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(BlockSummary blk, ChainHash blk)]
</span><a href="#local-6989586621679867082"><span class="hs-identifier hs-var">entriesWithPrevHashes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-390"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockSummary blk
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867090"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679867090"><span class="hs-identifier hs-var">actualPrevHash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">[(BlockSummary blk, ChainHash blk)]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679867091"><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679867091"><span class="hs-identifier hs-var">expectedPrevHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (ChainHash blk)
</span><a href="#local-6989586621679867060"><span class="hs-identifier hs-var">mbPrevHash</span></a></span><span>
</span><span id="line-392"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679867091"><span class="hs-identifier hs-var">expectedPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; ChainHash blk -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679867090"><span class="hs-identifier hs-var">actualPrevHash</span></a></span><span>
</span><span id="line-393"></span><span>          </span><span class="hs-comment">-- The previous hash of the first block in the chunk does not match</span><span>
</span><span id="line-394"></span><span>          </span><span class="hs-comment">-- the hash of the last block of the previous chunk. There must be a</span><span>
</span><span id="line-395"></span><span>          </span><span class="hs-comment">-- gap. This chunk should be truncated.</span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-397"></span><span>          </span><span class="annot"><span class="annottext">m () -&gt; ExceptT () m ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ExceptT () m ()) -&gt; m () -&gt; ExceptT () m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679867054"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk -&gt; ChainHash blk -&gt; TraceEvent blk
forall blk. ChainHash blk -&gt; ChainHash blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ChunkFileDoesntFit"><span class="hs-identifier hs-var">ChunkFileDoesntFit</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679867091"><span class="hs-identifier hs-var">expectedPrevHash</span></a></span><span> </span><span class="annot"><span class="annottext">ChainHash blk
</span><a href="#local-6989586621679867090"><span class="hs-identifier hs-var">actualPrevHash</span></a></span><span>
</span><span id="line-398"></span><span>          </span><span class="annot"><span class="annottext">() -&gt; ExceptT () m ()
forall a. () -&gt; ExceptT () m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>      </span><span class="annot"><span class="annottext">[(BlockSummary blk, ChainHash blk)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExceptT () m ()
forall a. a -&gt; ExceptT () m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span>    </span><span class="annot"><span class="annottext">m (Maybe (Tip blk)) -&gt; ExceptT () m (Maybe (Tip blk))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; ExceptT () m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Maybe (Tip blk)) -&gt; ExceptT () m (Maybe (Tip blk)))
-&gt; m (Maybe (Tip blk)) -&gt; ExceptT () m (Maybe (Tip blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span>      </span><span class="hs-comment">-- If the parser returneds a deserialisation error, truncate the chunk</span><span>
</span><span id="line-404"></span><span>      </span><span class="hs-comment">-- file. Don't truncate the database just yet, because the</span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-comment">-- deserialisation error may be due to some extra random bytes that</span><span>
</span><span id="line-406"></span><span>      </span><span class="hs-comment">-- shouldn't have been there in the first place.</span><span>
</span><span id="line-407"></span><span>      </span><span class="annot"><span class="annottext">Maybe (ChunkFileError blk, Word64)
-&gt; ((ChunkFileError blk, Word64) -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ChunkFileError blk, Word64)
</span><a href="#local-6989586621679867083"><span class="hs-identifier hs-var">mbErr</span></a></span><span> </span><span class="annot"><span class="annottext">(((ChunkFileError blk, Word64) -&gt; m ()) -&gt; m ())
-&gt; ((ChunkFileError blk, Word64) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679867094"><span class="annot"><span class="annottext">ChunkFileError blk
</span><a href="#local-6989586621679867094"><span class="hs-identifier hs-var">parseErr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867095"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679867095"><span class="hs-identifier hs-var">endOfLastValidBlock</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-408"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkFileError blk -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo
-&gt; ChunkFileError blk -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#InvalidChunkFile"><span class="hs-identifier hs-var">InvalidChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkFileError blk
</span><a href="#local-6989586621679867094"><span class="hs-identifier hs-var">parseErr</span></a></span><span>
</span><span id="line-409"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) h a.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867052"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679867065"><span class="hs-identifier hs-var">chunkFile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AllowExisting -&gt; OpenMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">AllowExisting</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Handle h -&gt; m ()) -&gt; m ()) -&gt; (Handle h -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679867099"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679867099"><span class="hs-identifier hs-var">eHnd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-410"></span><span>          </span><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
Handle h -&gt; Word64 -&gt; m ()
</span><a href="#local-6989586621679867100"><span class="hs-identifier hs-var">hTruncate</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679867099"><span class="hs-identifier hs-var">eHnd</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679867095"><span class="hs-identifier hs-var">endOfLastValidBlock</span></a></span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span>      </span><span class="hs-comment">-- If the secondary index file is missing, parsing it failed, or it does</span><span>
</span><span id="line-413"></span><span>      </span><span class="hs-comment">-- not match the entries from the chunk file, overwrite it using those</span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-comment">-- (truncate first).</span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679867101"><span class="annot"><span class="annottext">summary :: [BlockSummary blk]
</span><a href="#local-6989586621679867101"><span class="hs-identifier hs-var hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((BlockSummary blk, ChainHash blk) -&gt; BlockSummary blk)
-&gt; [(BlockSummary blk, ChainHash blk)] -&gt; [BlockSummary blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockSummary blk, ChainHash blk) -&gt; BlockSummary blk
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">[(BlockSummary blk, ChainHash blk)]
</span><a href="#local-6989586621679867082"><span class="hs-identifier hs-var">entriesWithPrevHashes</span></a></span><span>
</span><span id="line-416"></span><span>          </span><span id="local-6989586621679867103"><span class="annot"><span class="annottext">entries :: [Entry blk]
</span><a href="#local-6989586621679867103"><span class="hs-identifier hs-var hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(BlockSummary blk -&gt; Entry blk)
-&gt; [BlockSummary blk] -&gt; [Entry blk]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">BlockSummary blk -&gt; Entry blk
forall blk. BlockSummary blk -&gt; Entry blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html#summaryEntry"><span class="hs-identifier hs-var">summaryEntry</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockSummary blk]
</span><a href="#local-6989586621679867101"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-417"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Entry blk]
</span><a href="#local-6989586621679867069"><span class="hs-identifier hs-var">entriesFromSecondaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[Entry blk] -&gt; [Entry blk] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">[Entry blk]
</span><a href="#local-6989586621679867103"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span>
</span><span id="line-418"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867067"><span class="hs-identifier hs-var">secondaryIndexFileExists</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-419"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#RewriteSecondaryIndex"><span class="hs-identifier hs-var">RewriteSecondaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-420"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; [Entry blk] -&gt; m ()
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, MonadThrow m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; [Entry blk] -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#writeAllEntries"><span class="hs-identifier hs-var">Secondary.writeAllEntries</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867052"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">[Entry blk]
</span><a href="#local-6989586621679867103"><span class="hs-identifier hs-var">entries</span></a></span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>      </span><span class="hs-comment">-- Reconstruct the primary index from the 'Secondary.Entry's.</span><span>
</span><span id="line-423"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-424"></span><span>      </span><span class="hs-comment">-- Read the primary index file, if it is missing, parsing fails, or it</span><span>
</span><span id="line-425"></span><span>      </span><span class="hs-comment">-- does not match the reconstructed primary index, overwrite it using</span><span>
</span><span id="line-426"></span><span>      </span><span class="hs-comment">-- the reconstructed index (truncate first).</span><span>
</span><span id="line-427"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679867112"><span class="annot"><span class="annottext">primaryIndex :: PrimaryIndex
</span><a href="#local-6989586621679867112"><span class="hs-identifier hs-var hs-var">primaryIndex</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; ChunkInfo
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; [BlockOrEBB]
-&gt; PrimaryIndex
forall blk.
(ConvertRawHash blk, HasCallStack) =&gt;
Proxy blk
-&gt; ChunkInfo
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; [BlockOrEBB]
-&gt; PrimaryIndex
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#reconstructPrimaryIndex"><span class="hs-identifier hs-var">reconstructPrimaryIndex</span></a></span><span>
</span><span id="line-428"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>                           </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867053"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-430"></span><span>                           </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="#local-6989586621679867058"><span class="hs-identifier hs-var">shouldBeFinalised</span></a></span><span>
</span><span id="line-431"></span><span>                           </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-432"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Entry blk -&gt; BlockOrEBB) -&gt; [Entry blk] -&gt; [BlockOrEBB]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; BlockOrEBB
forall blk. Entry blk -&gt; BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var">Secondary.blockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">[Entry blk]
</span><a href="#local-6989586621679867103"><span class="hs-identifier hs-var">entries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>      </span><span id="local-6989586621679867114"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867114"><span class="hs-identifier hs-var">primaryIndexFileExists</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m Bool
FsPath -&gt; m Bool
</span><a href="#local-6989586621679867064"><span class="hs-identifier hs-var">doesFileExist</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679867115"><span class="hs-identifier hs-var">primaryIndexFile</span></a></span><span>
</span><span id="line-434"></span><span>      </span><span id="local-6989586621679867116"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867116"><span class="hs-identifier hs-var">primaryIndexFileMatches</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867114"><span class="hs-identifier hs-var">primaryIndexFileExists</span></a></span><span>
</span><span id="line-435"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(ImmutableDBError blk -&gt; Maybe ())
-&gt; m PrimaryIndex -&gt; m (Either () PrimaryIndex)
forall e b a.
Exception e =&gt;
(e -&gt; Maybe b) -&gt; m a -&gt; m (Either b a)
forall (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b) -&gt; m a -&gt; m (Either b a)
</span><span class="hs-identifier hs-var">tryJust</span></span><span> </span><span class="annot"><span class="annottext">ImmutableDBError blk -&gt; Maybe ()
</span><a href="#local-6989586621679867071"><span class="hs-identifier hs-var">isInvalidFileError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy blk -&gt; HasFS m h -&gt; ChunkNo -&gt; m PrimaryIndex
forall blk (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m, StandardHash blk, Typeable blk) =&gt;
Proxy blk -&gt; HasFS m h -&gt; ChunkNo -&gt; m PrimaryIndex
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#load"><span class="hs-identifier hs-var">Primary.load</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867052"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Either () PrimaryIndex)
-&gt; (Either () PrimaryIndex -&gt; m Bool) -&gt; m Bool
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-436"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#InvalidPrimaryIndex"><span class="hs-identifier hs-var">InvalidPrimaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-438"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-439"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679867119"><span class="annot"><span class="annottext">PrimaryIndex
</span><a href="#local-6989586621679867119"><span class="hs-identifier hs-var">primaryIndexFromFile</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-440"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; m Bool) -&gt; Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryIndex
</span><a href="#local-6989586621679867119"><span class="hs-identifier hs-var">primaryIndexFromFile</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryIndex -&gt; PrimaryIndex -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryIndex
</span><a href="#local-6989586621679867112"><span class="hs-identifier hs-var">primaryIndex</span></a></span><span>
</span><span id="line-441"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>          </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#MissingPrimaryIndex"><span class="hs-identifier hs-var">MissingPrimaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-443"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-444"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679867116"><span class="hs-identifier hs-var">primaryIndexFileMatches</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-445"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceChunkValidation blk ())
</span><a href="#local-6989586621679867061"><span class="hs-identifier hs-var">validationTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceChunkValidation blk () -&gt; m ())
-&gt; TraceChunkValidation blk () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; TraceChunkValidation blk ()
forall blk validateTo.
ChunkNo -&gt; TraceChunkValidation blk validateTo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#RewritePrimaryIndex"><span class="hs-identifier hs-var">RewritePrimaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-446"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; PrimaryIndex -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; PrimaryIndex -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#write"><span class="hs-identifier hs-var">Primary.write</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867052"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryIndex
</span><a href="#local-6989586621679867112"><span class="hs-identifier hs-var">primaryIndex</span></a></span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Tip blk) -&gt; m (Maybe (Tip blk))
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Tip blk) -&gt; m (Maybe (Tip blk)))
-&gt; Maybe (Tip blk) -&gt; m (Maybe (Tip blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockSummary blk -&gt; Tip blk
</span><a href="#local-6989586621679867123"><span class="hs-identifier hs-var">summaryToTipInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockSummary blk -&gt; Tip blk)
-&gt; Maybe (BlockSummary blk) -&gt; Maybe (Tip blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockSummary blk] -&gt; Maybe (BlockSummary blk)
forall a. [a] -&gt; Maybe a
</span><a href="Ouroboros.Consensus.Util.html#lastMaybe"><span class="hs-identifier hs-var">lastMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">[BlockSummary blk]
</span><a href="#local-6989586621679867101"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-450"></span><span>    </span><span id="local-6989586621679867065"><span class="annot"><span class="annottext">chunkFile :: FsPath
</span><a href="#local-6989586621679867065"><span class="hs-identifier hs-var hs-var">chunkFile</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span>          </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-451"></span><span>    </span><span id="local-6989586621679867115"><span class="annot"><span class="annottext">primaryIndexFile :: FsPath
</span><a href="#local-6989586621679867115"><span class="hs-identifier hs-var hs-var">primaryIndexFile</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathPrimaryIndexFile"><span class="hs-identifier hs-var">fsPathPrimaryIndexFile</span></a></span><span>   </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-452"></span><span>    </span><span id="local-6989586621679867068"><span class="annot"><span class="annottext">secondaryIndexFile :: FsPath
</span><a href="#local-6989586621679867068"><span class="hs-identifier hs-var hs-var">secondaryIndexFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathSecondaryIndexFile"><span class="hs-identifier hs-var">fsPathSecondaryIndexFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679867100"><span class="annot"><span class="annottext">HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hTruncate :: HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
hTruncate :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
</span><a href="#local-6989586621679867100"><span class="hs-identifier hs-var hs-var">hTruncate</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867064"><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m Bool
doesFileExist :: HasCallStack =&gt; FsPath -&gt; m Bool
doesFileExist :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m Bool
</span><a href="#local-6989586621679867064"><span class="hs-identifier hs-var hs-var">doesFileExist</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867052"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><a href="#local-6989586621679867123"><span class="hs-identifier hs-type">summaryToTipInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html#BlockSummary"><span class="hs-identifier hs-type">BlockSummary</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span id="local-6989586621679867123"><span class="annot"><span class="annottext">summaryToTipInfo :: BlockSummary blk -&gt; Tip blk
</span><a href="#local-6989586621679867123"><span class="hs-identifier hs-var hs-var">summaryToTipInfo</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html#BlockSummary"><span class="hs-identifier hs-type">BlockSummary</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679867130"><span id="local-6989586621679867131"><span id="local-6989586621679867132"><span class="annot"><span class="annottext">SlotNo
BlockNo
Entry blk
summaryEntry :: forall blk. BlockSummary blk -&gt; Entry blk
summaryEntry :: Entry blk
summaryBlockNo :: BlockNo
summarySlotNo :: SlotNo
summaryBlockNo :: forall blk. BlockSummary blk -&gt; BlockNo
summarySlotNo :: forall blk. BlockSummary blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html#summaryEntry"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-458"></span><span>          </span><span class="annot"><span class="annottext">tipSlotNo :: SlotNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipSlotNo"><span class="hs-identifier hs-var">tipSlotNo</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679867132"><span class="hs-identifier hs-var">summarySlotNo</span></a></span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tipIsEBB :: IsEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipIsEBB"><span class="hs-identifier hs-var">tipIsEBB</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockOrEBB -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#isBlockOrEBB"><span class="hs-identifier hs-var">isBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockOrEBB -&gt; IsEBB) -&gt; BlockOrEBB -&gt; IsEBB
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; BlockOrEBB
forall blk. Entry blk -&gt; BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var">Secondary.blockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679867130"><span class="hs-identifier hs-var">summaryEntry</span></a></span><span>
</span><span id="line-460"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tipBlockNo :: BlockNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipBlockNo"><span class="hs-identifier hs-var">tipBlockNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockNo
</span><a href="#local-6989586621679867131"><span class="hs-identifier hs-var">summaryBlockNo</span></a></span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tipHash :: HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipHash"><span class="hs-identifier hs-var">tipHash</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entry blk -&gt; HeaderHash blk
forall blk. Entry blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerHash"><span class="hs-identifier hs-var">Secondary.headerHash</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679867130"><span class="hs-identifier hs-var">summaryEntry</span></a></span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">-- | 'InvalidFileError' is the only error that can be thrown while loading</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-comment">-- a primary or a secondary index file</span><span>
</span><span id="line-466"></span><span>    </span><span class="annot"><a href="#local-6989586621679867071"><span class="hs-identifier hs-type">isInvalidFileError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDBError"><span class="hs-identifier hs-type">ImmutableDBError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866479"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621679867071"><span class="annot"><span class="annottext">isInvalidFileError :: ImmutableDBError blk -&gt; Maybe ()
</span><a href="#local-6989586621679867071"><span class="hs-identifier hs-var hs-var">isInvalidFileError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-468"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#UnexpectedFailure"><span class="hs-identifier hs-type">UnexpectedFailure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#InvalidFileError"><span class="hs-identifier hs-type">InvalidFileError</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Maybe ()
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>      </span><span class="annot"><span class="annottext">ImmutableDBError blk
</span><span class="hs-identifier">_</span></span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ()
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-comment">-- | When reading the entries from the secondary index file, we need to</span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-comment">-- pass in a value of type 'IsEBB' so we know whether the first entry</span><span>
</span><span id="line-473"></span><span>    </span><span class="hs-comment">-- corresponds to an EBB or a regular block. We need this information to</span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-comment">-- correctly interpret the deserialised 'Word64' as a 'BlockOrEBB': if</span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-comment">-- it's an EBB, it's the 'EpochNo' ('Word64'), if it's a regular block,</span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-comment">-- it's a 'SlotNo' ('Word64').</span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-478"></span><span>    </span><span class="hs-comment">-- However, at the point we are reading the secondary index file, we don't</span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-comment">-- yet know whether the first block will be an EBB or a regular block. We</span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-comment">-- will find that out when we read the actual block from the chunk file.</span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-comment">-- Fortunately, we can make a /very/ good guess: if the 'Word64' of the</span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-comment">-- 'BlockOrEBB' matches the chunk number, it is almost certainly an EBB,</span><span>
</span><span id="line-484"></span><span>    </span><span class="hs-comment">-- as the slot numbers increase @10k@ times faster than chunk numbers</span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-comment">-- (remember that for EBBs, chunk numbers and epoch numbers must line up).</span><span>
</span><span id="line-486"></span><span>    </span><span class="hs-comment">-- Property: for every chunk @e &gt; 0@, for all slot numbers @s@ in chunk</span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-comment">-- @e@ we have @s &gt; e@. The only exception is chunk 0, which contains a</span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-comment">-- slot number 0. From this follows that it's an EBB if and only if the</span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-comment">-- 'Word64' matches the chunk number.</span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-491"></span><span>    </span><span class="hs-comment">-- E.g., the first slot number in chunk 1 will be 21600 if @k = 2160@. We</span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-comment">-- could only make the wrong guess in the first very first chunk, i.e.,</span><span>
</span><span id="line-493"></span><span>    </span><span class="hs-comment">-- chunk 0, as the first slot number is also 0. However, we know that the</span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-comment">-- real blockchain starts with an EBB, so even in that case we're fine.</span><span>
</span><span id="line-495"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-496"></span><span>    </span><span class="hs-comment">-- If the chunk size were 1, then we would make the wrong guess for each</span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-comment">-- chunk that contains an EBB, which is a rather unrealistic scenario.</span><span>
</span><span id="line-498"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-comment">-- Note that even making the wrong guess is not a problem. The (CRC)</span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-comment">-- checksums are the only thing we extract from the secondary index file.</span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-comment">-- These are passed to the 'ChunkFileParser'. We then reconstruct the</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">-- secondary index using the output of the 'ChunkFileParser'. If that</span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">-- output doesn't match the parsed secondary index file, we will overwrite</span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">-- the secondary index file.</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-comment">-- So the only thing that wouldn't go according to plan is that we will</span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-comment">-- needlessly overwrite the secondary index file.</span><span>
</span><span id="line-508"></span><span>    </span><span class="annot"><a href="#local-6989586621679867077"><span class="hs-identifier hs-type">fixupEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679866535"><span class="annot"><a href="#local-6989586621679866535"><span class="hs-identifier hs-type">hash</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866535"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866535"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-509"></span><span>    </span><span id="local-6989586621679867077"><span class="annot"><span class="annottext">fixupEBB :: forall hash. [Entry hash] -&gt; [Entry hash]
</span><a href="#local-6989586621679867077"><span class="hs-identifier hs-var hs-var">fixupEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-510"></span><span>      </span><span id="local-6989586621679867143"><span class="annot"><span class="annottext">entry :: Entry hash
</span><a href="#local-6989586621679867143"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">blockOrEBB :: forall blk. Entry blk -&gt; BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var">blockOrEBB</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#EBB"><span class="hs-identifier hs-type">EBB</span></a></span><span> </span><span id="local-6989586621679867146"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679867146"><span class="hs-identifier hs-var">epoch'</span></a></span></span><span> </span><span class="hs-special">}</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679867147"><span class="annot"><span class="annottext">[Entry hash]
</span><a href="#local-6989586621679867147"><span class="hs-identifier hs-var">rest</span></a></span></span><span>
</span><span id="line-511"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679867148"><span class="annot"><span class="annottext">chunk' :: ChunkNo
</span><a href="#local-6989586621679867148"><span class="hs-identifier hs-var hs-var">chunk'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unsafeEpochNoToChunkNo"><span class="hs-identifier hs-var">unsafeEpochNoToChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679867146"><span class="hs-identifier hs-var">epoch'</span></a></span><span>
</span><span id="line-512"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867148"><span class="hs-identifier hs-var">chunk'</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867059"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-513"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Entry hash
</span><a href="#local-6989586621679867143"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var">Secondary.blockOrEBB</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#unChunkNo"><span class="hs-identifier hs-var">unChunkNo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679867148"><span class="hs-identifier hs-type">chunk'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span class="annot"><span class="annottext">Entry hash -&gt; [Entry hash] -&gt; [Entry hash]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[Entry hash]
</span><a href="#local-6989586621679867147"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-514"></span><span>      </span><span id="local-6989586621679867151"><span class="annot"><span class="annottext">[Entry hash]
</span><a href="#local-6989586621679867151"><span class="hs-identifier hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Entry hash]
</span><a href="#local-6989586621679867151"><span class="hs-identifier hs-var">entries</span></a></span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span class="annot"><span class="hs-comment">-- | Reconstruct a 'PrimaryIndex' based on a list of 'Secondary.Entry's.</span></span><span>
</span><span id="line-517"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#reconstructPrimaryIndex"><span class="hs-identifier hs-type">reconstructPrimaryIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-518"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679866569"><span class="annot"><a href="#local-6989586621679866569"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866569"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866569"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldBeFinalised"><span class="hs-identifier hs-type">ShouldBeFinalised</span></a></span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#BlockOrEBB"><span class="hs-identifier hs-type">BlockOrEBB</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#PrimaryIndex"><span class="hs-identifier hs-type">PrimaryIndex</span></a></span><span>
</span><span id="line-525"></span><span id="reconstructPrimaryIndex"><span class="annot"><span class="annottext">reconstructPrimaryIndex :: forall blk.
(ConvertRawHash blk, HasCallStack) =&gt;
Proxy blk
-&gt; ChunkInfo
-&gt; ShouldBeFinalised
-&gt; ChunkNo
-&gt; [BlockOrEBB]
-&gt; PrimaryIndex
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#reconstructPrimaryIndex"><span class="hs-identifier hs-var hs-var">reconstructPrimaryIndex</span></a></span></span><span> </span><span id="local-6989586621679867160"><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679867160"><span class="hs-identifier hs-var">pb</span></a></span></span><span> </span><span id="local-6989586621679867161"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867161"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span id="local-6989586621679867162"><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="#local-6989586621679867162"><span class="hs-identifier hs-var">shouldBeFinalised</span></a></span></span><span> </span><span id="local-6989586621679867163"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867163"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679867164"><span class="annot"><span class="annottext">[BlockOrEBB]
</span><a href="#local-6989586621679867164"><span class="hs-identifier hs-var">blockOrEBBs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-526"></span><span>    </span><span class="annot"><span class="annottext">PrimaryIndex -&gt; Maybe PrimaryIndex -&gt; PrimaryIndex
forall a. a -&gt; Maybe a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; PrimaryIndex
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867166"><span class="hs-identifier hs-var">nonIncreasing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe PrimaryIndex -&gt; PrimaryIndex)
-&gt; Maybe PrimaryIndex -&gt; PrimaryIndex
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-527"></span><span>      </span><span class="annot"><span class="annottext">ChunkNo -&gt; [SecondaryOffset] -&gt; Maybe PrimaryIndex
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#mk"><span class="hs-identifier hs-var">Primary.mk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867163"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">([SecondaryOffset] -&gt; Maybe PrimaryIndex)
-&gt; ([SecondaryOffset] -&gt; [SecondaryOffset])
-&gt; [SecondaryOffset]
-&gt; Maybe PrimaryIndex
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-number">0</span></span><span class="annot"><span class="annottext">SecondaryOffset -&gt; [SecondaryOffset] -&gt; [SecondaryOffset]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SecondaryOffset] -&gt; Maybe PrimaryIndex)
-&gt; [SecondaryOffset] -&gt; Maybe PrimaryIndex
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-528"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
NextRelativeSlot
-&gt; SecondaryOffset -&gt; [RelativeSlot] -&gt; [SecondaryOffset]
NextRelativeSlot
-&gt; SecondaryOffset -&gt; [RelativeSlot] -&gt; [SecondaryOffset]
</span><a href="#local-6989586621679867168"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RelativeSlot -&gt; NextRelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#NextRelativeSlot"><span class="hs-identifier hs-var">NextRelativeSlot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkInfo -&gt; ChunkNo -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#firstBlockOrEBB"><span class="hs-identifier hs-var">firstBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867161"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867163"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([RelativeSlot] -&gt; [SecondaryOffset])
-&gt; [RelativeSlot] -&gt; [SecondaryOffset]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-529"></span><span>          </span><span class="annot"><span class="annottext">(BlockOrEBB -&gt; RelativeSlot) -&gt; [BlockOrEBB] -&gt; [RelativeSlot]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkSlot -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkRelative"><span class="hs-identifier hs-var">chunkRelative</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkSlot -&gt; RelativeSlot)
-&gt; (BlockOrEBB -&gt; ChunkSlot) -&gt; BlockOrEBB -&gt; RelativeSlot
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; BlockOrEBB -&gt; ChunkSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkSlotForBlockOrEBB"><span class="hs-identifier hs-var">chunkSlotForBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867161"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[BlockOrEBB]
</span><a href="#local-6989586621679867164"><span class="hs-identifier hs-var">blockOrEBBs</span></a></span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-531"></span><span>    </span><span class="annot"><a href="#local-6989586621679867166"><span class="hs-identifier hs-type">nonIncreasing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-532"></span><span>    </span><span id="local-6989586621679867166"><span class="annot"><span class="annottext">nonIncreasing :: String
</span><a href="#local-6989586621679867166"><span class="hs-identifier hs-var hs-var">nonIncreasing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;blocks have non-increasing slot numbers&quot;</span></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>    </span><span class="annot"><a href="#local-6989586621679867168"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-535"></span><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#NextRelativeSlot"><span class="hs-identifier hs-type">NextRelativeSlot</span></a></span><span>
</span><span id="line-536"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span>
</span><span id="line-537"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-538"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#SecondaryOffset"><span class="hs-identifier hs-type">SecondaryOffset</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-539"></span><span>    </span><span id="local-6989586621679867168"><span class="annot"><span class="annottext">go :: HasCallStack =&gt;
NextRelativeSlot
-&gt; SecondaryOffset -&gt; [RelativeSlot] -&gt; [SecondaryOffset]
</span><a href="#local-6989586621679867168"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679867186"><span class="annot"><span class="annottext">NextRelativeSlot
</span><a href="#local-6989586621679867186"><span class="hs-identifier hs-var">expected</span></a></span></span><span> </span><span id="local-6989586621679867187"><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867187"><span class="hs-identifier hs-var">lastSecondaryOffset</span></a></span></span><span> </span><span id="local-6989586621679867188"><span class="annot"><span class="annottext">[RelativeSlot]
</span><a href="#local-6989586621679867188"><span class="hs-identifier hs-var">relSlots</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-540"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NextRelativeSlot
</span><a href="#local-6989586621679867186"><span class="hs-identifier hs-var">expected</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[RelativeSlot]
</span><a href="#local-6989586621679867188"><span class="hs-identifier hs-var">relSlots</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-541"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NextRelativeSlot
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-542"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="#local-6989586621679867162"><span class="hs-identifier hs-var">shouldBeFinalised</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-543"></span><span>              </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldNotBeFinalised"><span class="hs-identifier hs-var">ShouldNotBeFinalised</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-544"></span><span>              </span><span class="annot"><span class="annottext">ShouldBeFinalised
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ShouldBeFinalised"><span class="hs-identifier hs-var">ShouldBeFinalised</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkInfo
-&gt; ChunkNo
-&gt; NextRelativeSlot
-&gt; SecondaryOffset
-&gt; [SecondaryOffset]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#backfillChunk"><span class="hs-identifier hs-var">Primary.backfillChunk</span></a></span><span>
</span><span id="line-545"></span><span>                                        </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679867161"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-546"></span><span>                                        </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867163"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-547"></span><span>                                        </span><span class="annot"><span class="annottext">NextRelativeSlot
</span><a href="#local-6989586621679867186"><span class="hs-identifier hs-var">expected</span></a></span><span>
</span><span id="line-548"></span><span>                                        </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867187"><span class="hs-identifier hs-var">lastSecondaryOffset</span></a></span><span>
</span><span id="line-549"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NextRelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#NoMoreRelativeSlots"><span class="hs-identifier hs-var">NoMoreRelativeSlots</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[RelativeSlot]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-550"></span><span>            </span><span class="hs-comment">-- Assumption: when we validate the chunk file, we check its size</span><span>
</span><span id="line-551"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; [SecondaryOffset]
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reconstructPrimaryIndex: too many entries&quot;</span></span><span>
</span><span id="line-552"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#NextRelativeSlot"><span class="hs-identifier hs-type">NextRelativeSlot</span></a></span><span> </span><span id="local-6989586621679867191"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867191"><span class="hs-identifier hs-var">nextExpectedRelSlot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867192"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867192"><span class="hs-identifier hs-var">relSlot</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679867193"><span class="annot"><span class="annottext">[RelativeSlot]
</span><a href="#local-6989586621679867193"><span class="hs-identifier hs-var">relSlots'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-553"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; RelativeSlot -&gt; RelativeSlot -&gt; Ordering
RelativeSlot -&gt; RelativeSlot -&gt; Ordering
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#compareRelativeSlot"><span class="hs-identifier hs-var">compareRelativeSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867192"><span class="hs-identifier hs-var">relSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867191"><span class="hs-identifier hs-var">nextExpectedRelSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#LT"><span class="hs-identifier hs-var">LT</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-554"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; [SecondaryOffset]
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867166"><span class="hs-identifier hs-var">nonIncreasing</span></a></span><span>
</span><span id="line-555"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-556"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679867195"><span class="annot"><span class="annottext">backfilled :: [SecondaryOffset]
</span><a href="#local-6989586621679867195"><span class="hs-identifier hs-var hs-var">backfilled</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RelativeSlot
-&gt; RelativeSlot -&gt; SecondaryOffset -&gt; [SecondaryOffset]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#backfill"><span class="hs-identifier hs-var">Primary.backfill</span></a></span><span>
</span><span id="line-557"></span><span>                                      </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867192"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-558"></span><span>                                      </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867191"><span class="hs-identifier hs-var">nextExpectedRelSlot</span></a></span><span>
</span><span id="line-559"></span><span>                                      </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867187"><span class="hs-identifier hs-var">lastSecondaryOffset</span></a></span><span>
</span><span id="line-560"></span><span>                  </span><span id="local-6989586621679867198"><span class="annot"><span class="annottext">secondaryOffset :: SecondaryOffset
</span><a href="#local-6989586621679867198"><span class="hs-identifier hs-var hs-var">secondaryOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867187"><span class="hs-identifier hs-var">lastSecondaryOffset</span></a></span><span>
</span><span id="line-561"></span><span>                                  </span><span class="annot"><span class="annottext">SecondaryOffset -&gt; SecondaryOffset -&gt; SecondaryOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy blk -&gt; SecondaryOffset
forall blk. ConvertRawHash blk =&gt; Proxy blk -&gt; SecondaryOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#entrySize"><span class="hs-identifier hs-var">Secondary.entrySize</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy blk
</span><a href="#local-6989586621679867160"><span class="hs-identifier hs-var">pb</span></a></span><span>
</span><span id="line-562"></span><span>              </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[SecondaryOffset]
</span><a href="#local-6989586621679867195"><span class="hs-identifier hs-var">backfilled</span></a></span><span> </span><span class="annot"><span class="annottext">[SecondaryOffset] -&gt; [SecondaryOffset] -&gt; [SecondaryOffset]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867198"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span>
</span><span id="line-563"></span><span>               </span><span class="annot"><span class="annottext">SecondaryOffset -&gt; [SecondaryOffset] -&gt; [SecondaryOffset]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt;
NextRelativeSlot
-&gt; SecondaryOffset -&gt; [RelativeSlot] -&gt; [SecondaryOffset]
NextRelativeSlot
-&gt; SecondaryOffset -&gt; [RelativeSlot] -&gt; [SecondaryOffset]
</span><a href="#local-6989586621679867168"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; RelativeSlot -&gt; NextRelativeSlot
RelativeSlot -&gt; NextRelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#nextRelativeSlot"><span class="hs-identifier hs-var">nextRelativeSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679867192"><span class="hs-identifier hs-var">relSlot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SecondaryOffset
</span><a href="#local-6989586621679867198"><span class="hs-identifier hs-var">secondaryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">[RelativeSlot]
</span><a href="#local-6989586621679867193"><span class="hs-identifier hs-var">relSlots'</span></a></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span class="hs-comment">{------------------------------------------------------------------------------
  Migration
------------------------------------------------------------------------------}</span><span>
</span><span id="line-569"></span><span>
</span><span id="line-570"></span><span class="hs-comment">-- | Migrate the files in the database to the latest version.</span><span>
</span><span id="line-571"></span><span class="hs-comment">--</span><span>
</span><span id="line-572"></span><span class="hs-comment">-- We always migrate the database to the latest version before opening it. If</span><span>
</span><span id="line-573"></span><span class="hs-comment">-- a migration was unsuccessful, an error is thrown and the database is not</span><span>
</span><span id="line-574"></span><span class="hs-comment">-- opened. User intervention will be needed before the database can be</span><span>
</span><span id="line-575"></span><span class="hs-comment">-- reopened, as without it, the same error will be thrown when reopening the</span><span>
</span><span id="line-576"></span><span class="hs-comment">-- database the next time.</span><span>
</span><span id="line-577"></span><span class="hs-comment">--</span><span>
</span><span id="line-578"></span><span class="hs-comment">-- For example, when during a migration we have to rename a file A to B, but</span><span>
</span><span id="line-579"></span><span class="hs-comment">-- we don't have permissions to do so, we require user intervention.</span><span>
</span><span id="line-580"></span><span class="hs-comment">--</span><span>
</span><span id="line-581"></span><span class="hs-comment">-- We have the following versions, from current to oldest:</span><span>
</span><span id="line-582"></span><span class="hs-comment">--</span><span>
</span><span id="line-583"></span><span class="hs-comment">-- * Current version:</span><span>
</span><span id="line-584"></span><span class="hs-comment">--</span><span>
</span><span id="line-585"></span><span class="hs-comment">--   - Chunk files are named &quot;XXXXX.chunk&quot; where &quot;XXXXX&quot; is the chunk/epoch</span><span>
</span><span id="line-586"></span><span class="hs-comment">--     number padded with zeroes to five decimals. A chunk file stores the</span><span>
</span><span id="line-587"></span><span class="hs-comment">--     blocks in that chunk sequentially. Empty slots are skipped.</span><span>
</span><span id="line-588"></span><span class="hs-comment">--</span><span>
</span><span id="line-589"></span><span class="hs-comment">--   - Primary index files are named &quot;XXXXX.primary&quot;. See 'PrimaryIndex' for</span><span>
</span><span id="line-590"></span><span class="hs-comment">--     more information.</span><span>
</span><span id="line-591"></span><span class="hs-comment">--</span><span>
</span><span id="line-592"></span><span class="hs-comment">--   - Secondary index files are named &quot;XXXXX.secondary&quot;. See</span><span>
</span><span id="line-593"></span><span class="hs-comment">--     'Secondary.Entry' for more information.</span><span>
</span><span id="line-594"></span><span class="hs-comment">--</span><span>
</span><span id="line-595"></span><span class="hs-comment">-- * The only difference with the version after it was that chunk files were</span><span>
</span><span id="line-596"></span><span class="hs-comment">--   named &quot;XXXXX.epoch&quot; instead of &quot;XXXXX.chunk&quot;. The contents of all files</span><span>
</span><span id="line-597"></span><span class="hs-comment">--   remain identical because we chose the chunk size to be equal to the Byron</span><span>
</span><span id="line-598"></span><span class="hs-comment">--   epoch size and allowed EBBs in the chunk.</span><span>
</span><span id="line-599"></span><span class="hs-comment">--</span><span>
</span><span id="line-600"></span><span class="hs-comment">-- We don't include versions before the first release, as we don't have to</span><span>
</span><span id="line-601"></span><span class="hs-comment">-- migrate from them.</span><span>
</span><span id="line-602"></span><span class="hs-comment">--</span><span>
</span><span id="line-603"></span><span class="hs-comment">-- Note that primary index files also contain a version number, but since the</span><span>
</span><span id="line-604"></span><span class="hs-comment">-- binary format hasn't changed yet, this version number hasn't been changed</span><span>
</span><span id="line-605"></span><span class="hs-comment">-- yet.</span><span>
</span><span id="line-606"></span><span class="hs-comment">--</span><span>
</span><span id="line-607"></span><span class="hs-comment">-- Implementation note: as currently the sole migration we need to be able to</span><span>
</span><span id="line-608"></span><span class="hs-comment">-- perform only requires renaming files, we keep it simple for now.</span><span>
</span><span id="line-609"></span><span id="local-6989586621679866441"><span id="local-6989586621679866442"><span id="local-6989586621679866443"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#migrate"><span class="hs-identifier hs-type">migrate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866441"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866441"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866442"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679866443"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679866441"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-610"></span><span id="migrate"><span class="annot"><span class="annottext">migrate :: forall (m :: * -&gt; *) blk h.
(IOLike m, HasCallStack) =&gt;
ValidateEnv m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#migrate"><span class="hs-identifier hs-var hs-var">migrate</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679867227"><span class="annot"><span class="annottext">HasFS m h
hasFS :: forall (m :: * -&gt; *) blk h. ValidateEnv m blk h -&gt; HasFS m h
hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867228"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
tracer :: forall (m :: * -&gt; *) blk h.
ValidateEnv m blk h -&gt; Tracer m (TraceEvent blk)
tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-611"></span><span>    </span><span id="local-6989586621679867229"><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679867229"><span class="hs-identifier hs-var">filesInDBFolder</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m (Set String)
FsPath -&gt; m (Set String)
</span><a href="#local-6989586621679867230"><span class="hs-identifier hs-var">listDirectory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; FsPath
</span><span class="hs-identifier hs-var">mkFsPath</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-comment">-- Any old &quot;XXXXX.epoch&quot; files</span><span>
</span><span id="line-613"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679867231"><span class="hs-identifier hs-type">epochFileChunkNos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FsPath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-614"></span><span>        </span><span id="local-6989586621679867231"><span class="annot"><span class="annottext">epochFileChunkNos :: [(FsPath, ChunkNo)]
</span><a href="#local-6989586621679867231"><span class="hs-identifier hs-var hs-var">epochFileChunkNos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-615"></span><span>          </span><span class="annot"><span class="annottext">(String -&gt; Maybe (FsPath, ChunkNo))
-&gt; [String] -&gt; [(FsPath, ChunkNo)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span>
</span><span id="line-616"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679867232"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867232"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; FsPath
</span><span class="hs-identifier hs-var">mkFsPath</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867232"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ChunkNo -&gt; (FsPath, ChunkNo))
-&gt; Maybe ChunkNo -&gt; Maybe (FsPath, ChunkNo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe ChunkNo
</span><a href="#local-6989586621679867233"><span class="hs-identifier hs-var">isEpochFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867232"><span class="hs-identifier hs-var">file</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set String -&gt; [String]
forall a. Set a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#toAscList"><span class="hs-identifier hs-var">Set.toAscList</span></a></span><span> </span><span class="annot"><span class="annottext">Set String
</span><a href="#local-6989586621679867229"><span class="hs-identifier hs-var">filesInDBFolder</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(FsPath, ChunkNo)] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[(FsPath, ChunkNo)]
</span><a href="#local-6989586621679867231"><span class="hs-identifier hs-var">epochFileChunkNos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-620"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679867228"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; TraceEvent blk
forall blk. Text -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#Migrating"><span class="hs-identifier hs-var">Migrating</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.epoch files to .chunk files&quot;</span></span><span>
</span><span id="line-621"></span><span>      </span><span class="annot"><span class="annottext">[(FsPath, ChunkNo)] -&gt; ((FsPath, ChunkNo) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[(FsPath, ChunkNo)]
</span><a href="#local-6989586621679867231"><span class="hs-identifier hs-var">epochFileChunkNos</span></a></span><span> </span><span class="annot"><span class="annottext">(((FsPath, ChunkNo) -&gt; m ()) -&gt; m ())
-&gt; ((FsPath, ChunkNo) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679867237"><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679867237"><span class="hs-identifier hs-var">epochFile</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867238"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867238"><span class="hs-identifier hs-var">chunk</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-622"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
FsPath -&gt; FsPath -&gt; m ()
</span><a href="#local-6989586621679867239"><span class="hs-identifier hs-var">renameFile</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679867237"><span class="hs-identifier hs-var">epochFile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867238"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-624"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679867230"><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; m (Set String)
listDirectory :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; m (Set String)
listDirectory :: HasCallStack =&gt; FsPath -&gt; m (Set String)
</span><span class="hs-identifier hs-var hs-var">listDirectory</span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867239"><span class="annot"><span class="annottext">HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
renameFile :: HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
renameFile :: forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; FsPath -&gt; FsPath -&gt; m ()
</span><a href="#local-6989586621679867239"><span class="hs-identifier hs-var hs-var">renameFile</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679867227"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span>    </span><span class="annot"><a href="#local-6989586621679867233"><span class="hs-identifier hs-type">isEpochFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-627"></span><span>    </span><span id="local-6989586621679867233"><span class="annot"><span class="annottext">isEpochFile :: String -&gt; Maybe ChunkNo
</span><a href="#local-6989586621679867233"><span class="hs-identifier hs-var hs-var">isEpochFile</span></a></span></span><span> </span><span id="local-6989586621679867241"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867241"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe (String, ChunkNo)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#parseDBFile"><span class="hs-identifier hs-var">parseDBFile</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867241"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-628"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679867243"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867243"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679867244"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867244"><span class="hs-identifier hs-var">chunk</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679867243"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;epoch&quot;</span></span><span>
</span><span id="line-630"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; Maybe ChunkNo
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679867244"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-631"></span><span>      </span><span class="annot"><span class="annottext">Maybe (String, ChunkNo)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ChunkNo
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-632"></span></pre></body></html>
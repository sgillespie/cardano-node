<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts           #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase                 #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables        #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving         #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances       #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-comment">-- | Exposes the @'Mempool'@ datatype which captures the public API of the</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- Mempool. Also exposes all the types used to interact with said API.</span><span>
</span><span id="line-10"></span><span class="hs-comment">--</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- The interface is then initialized in &quot;Ouroboros.Consensus.Mempool.Init&quot; with</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- the functions from &quot;Ouroboros.Consensus.Mempool.Update&quot; and</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- &quot;Ouroboros.Consensus.Mempool.Query&quot;.</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Mempool.API</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Mempool</span></span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier">Mempool</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Transaction adding</span></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#AddTxOnBehalfOf"><span class="hs-identifier">AddTxOnBehalfOf</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier">MempoolAddTxResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#addLocalTxs"><span class="hs-identifier">addLocalTxs</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#addTxs"><span class="hs-identifier">addTxs</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier">isMempoolTxAdded</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier">isMempoolTxRejected</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#mempoolTxAddedToMaybe"><span class="hs-identifier">mempoolTxAddedToMaybe</span></a></span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Ledger state to forge on top of</span></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeLedgerState"><span class="hs-identifier">ForgeLedgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Mempool Snapshot</span></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier">MempoolSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-exports</span></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#TicketNo"><span class="hs-identifier">TicketNo</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TxSizeInBytes</span></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#zeroTicketNo"><span class="hs-identifier">zeroTicketNo</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SlotNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsMempool</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Capacity.html"><span class="hs-identifier">Ouroboros.Consensus.Mempool.Capacity</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cap</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html"><span class="hs-identifier">Ouroboros.Consensus.Mempool.TxSeq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#TicketNo"><span class="hs-identifier">TicketNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#zeroTicketNo"><span class="hs-identifier">zeroTicketNo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.TxSubmission2.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TxSizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Mempool API
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">-- | Mempool</span><span>
</span><span id="line-48"></span><span class="hs-comment">--</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- The mempool is the set of transactions that should be included in the next</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- block. In principle this is a /set/ of all the transactions that we receive</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- from our peers. In order to avoid flooding the network with invalid</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- transactions, however, we only want to keep /valid/ transactions in the</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- mempool. That raises the question: valid with respect to which ledger state?</span><span>
</span><span id="line-54"></span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- We opt for a very simple answer to this: the mempool will be interpreted</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- as a /list/ of transactions; which are validated strictly in order, starting</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- from the current ledger state. This has a number of advantages:</span><span>
</span><span id="line-58"></span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- * It's simple to implement and it's efficient. In particular, no search for</span><span>
</span><span id="line-60"></span><span class="hs-comment">--   a valid subset is ever required.</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- * When producing a block, we can simply take the longest possible prefix</span><span>
</span><span id="line-62"></span><span class="hs-comment">--   of transactions that fits in a block.</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- * It supports wallets that submit dependent transactions (where later</span><span>
</span><span id="line-64"></span><span class="hs-comment">--   transaction depends on outputs from earlier ones).</span><span>
</span><span id="line-65"></span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- The mempool provides fairness guarantees for the case of multiple threads</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- performing 'addTx' concurrently. Implementations of this interface must</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- provide this guarantee, and users of this interface may rely on it.</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- Specifically, multiple threads that continuously use 'addTx' will, over</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- time, get a share of the mempool resource (measured by the number of txs</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- only, not their sizes) roughly proportional to their \&quot;weight\&quot;. The weight</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- depends on the 'AddTxOnBehalfOf': either acting on behalf of remote peers</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- ('AddTxForRemotePeer') or on behalf of a local client</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- ('AddTxForLocalClient'). The weighting for threads acting on behalf of</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- remote peers is the same for all remote peers, so all remote peers will get</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- a roughly equal share of the resource. The weighting for local clients is</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- the same for all local clients but /may/ be higher than the weighting for</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- remote peers. The weighting is not unboundedly higher however, so there is</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- still (weighted) fairness between remote peers and local clients. Thus</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- local clients will also get a roughly equal share of the resource, but that</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- share may be strictly greater than the share for each remote peer.</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- Furthermore, this implies local clients cannot starve remote peers, despite</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- their higher weighting.</span><span>
</span><span id="line-84"></span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- This fairness specification in terms of weighting is deliberately</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- non-specific, which allows multiple strategies. The existing default</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- strategy (for the implementation in &quot;Ouroboros.Consensus.Mempool&quot;) is as</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- follows. The design uses two FIFOs, to give strictly in-order behaviour.</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- All remote peers get equal weight and all local clients get equal weight.</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- The relative weight between remote and local is that if there are N remote</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- peers and M local clients, each local client gets weight 1/(M+1), while all</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- of the N remote peers together also get total weight 1/(M+1). This means</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- individual remote peers get weight 1/(N * (M+1)). Intuitively: a single local</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- client has the same weight as all the remote peers put together.</span><span>
</span><span id="line-95"></span><span class="hs-comment">--</span><span>
</span><span id="line-96"></span><span class="hs-keyword">data</span><span> </span><span id="Mempool"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier hs-var">Mempool</span></a></span></span><span> </span><span id="local-6989586621679840707"><span class="annot"><a href="#local-6989586621679840707"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679840708"><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Mempool"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier hs-var">Mempool</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-comment">-- | Add a single transaction to the mempool.</span><span>
</span><span id="line-98"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-99"></span><span>      </span><span class="hs-comment">-- The new transaction provided will be validated, /in order/, against</span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-comment">-- the ledger state obtained by applying all the transactions already in</span><span>
</span><span id="line-101"></span><span>      </span><span class="hs-comment">-- the Mempool to it. Transactions which are found to be invalid, with</span><span>
</span><span id="line-102"></span><span>      </span><span class="hs-comment">-- respect to the ledger state, are dropped, whereas valid transactions</span><span>
</span><span id="line-103"></span><span>      </span><span class="hs-comment">-- are added to the mempool.</span><span>
</span><span id="line-104"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-comment">-- Note that transactions that are invalid, with respect to the ledger</span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-comment">-- state, will /never/ be added to the mempool. However, it is possible</span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-comment">-- that, at a given point in time, transactions which were once valid</span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-comment">-- but are now invalid, with respect to the current ledger state, could</span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-comment">-- exist within the mempool until they are revalidated and dropped from</span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-comment">-- the mempool via a call to 'syncWithLedger' or by the background</span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-comment">-- thread that watches the ledger for changes.</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-comment">-- This action returns one of two results</span><span>
</span><span id="line-114"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-115"></span><span>      </span><span class="hs-comment">--  * A 'MempoolTxAdded' value if the transaction provided was found to</span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-comment">--    be valid. This transactions is now in the Mempool.</span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-comment">--  * A 'MempoolTxRejected' value if the transaction provided was found</span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-comment">--    to be invalid, along with its accompanying validation errors. This</span><span>
</span><span id="line-120"></span><span>      </span><span class="hs-comment">--    transactions is not in the Mempool.</span><span>
</span><span id="line-121"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-122"></span><span>      </span><span class="hs-comment">-- Note that this is a blocking action. It will block until the</span><span>
</span><span id="line-123"></span><span>      </span><span class="hs-comment">-- transaction fits into the mempool. This includes transactions that</span><span>
</span><span id="line-124"></span><span>      </span><span class="hs-comment">-- turn out to be invalid: the action waits for there to be space for</span><span>
</span><span id="line-125"></span><span>      </span><span class="hs-comment">-- the transaction before it gets validated.</span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-comment">-- Note that it is safe to use this from multiple threads concurrently.</span><span>
</span><span id="line-128"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span>      </span><span class="hs-comment">-- POSTCONDITION:</span><span>
</span><span id="line-130"></span><span>      </span><span class="hs-comment">-- &gt; let prj = \case</span><span>
</span><span id="line-131"></span><span>      </span><span class="hs-comment">-- &gt;       MempoolTxAdded vtx        -&gt; txForgetValidated vtx</span><span>
</span><span id="line-132"></span><span>      </span><span class="hs-comment">-- &gt;       MempoolTxRejected tx _err -&gt; tx</span><span>
</span><span id="line-133"></span><span>      </span><span class="hs-comment">-- &gt; processed &lt;- addTx wti txs</span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-comment">-- &gt; prj processed == tx</span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span>      </span><span class="hs-comment">-- Note that previously valid transaction that are now invalid with</span><span>
</span><span id="line-137"></span><span>      </span><span class="hs-comment">-- respect to the current ledger state are dropped from the mempool, but</span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-comment">-- are not part of the first returned list (nor the second).</span><span>
</span><span id="line-139"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-comment">-- In principle it is possible that validation errors are transient; for</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-comment">-- example, it is possible that a transaction is rejected because one of</span><span>
</span><span id="line-142"></span><span>      </span><span class="hs-comment">-- its inputs is not /yet/ available in the UTxO (the transaction it</span><span>
</span><span id="line-143"></span><span>      </span><span class="hs-comment">-- depends on is not yet in the chain, nor in the mempool). In practice</span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-comment">-- however it is likely that rejected transactions will still be</span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-comment">-- rejected later, and should just be dropped.</span><span>
</span><span id="line-146"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-comment">-- It is important to note one important special case of transactions</span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-comment">-- being &quot;invalid&quot;: a transaction will /also/ be considered invalid if</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-comment">-- /that very same transaction/ is already included on the blockchain</span><span>
</span><span id="line-150"></span><span>      </span><span class="hs-comment">-- (after all, by definition that must mean its inputs have been used).</span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-comment">-- Rejected transactions are therefore not necessarily a sign of</span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-comment">-- malicious behaviour. Indeed, we would expect /most/ transactions that</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-comment">-- are reported as invalid by 'tryAddTxs' to be invalid precisely</span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-comment">-- because they have already been included. Distinguishing between these</span><span>
</span><span id="line-155"></span><span>      </span><span class="hs-comment">-- two cases can be done in theory, but it is expensive unless we have</span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-comment">-- an index of transaction hashes that have been included on the</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-comment">-- blockchain.</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-comment">-- As long as we keep the mempool entirely in-memory this could live in</span><span>
</span><span id="line-160"></span><span>      </span><span class="hs-comment">-- @STM m@; we keep it in @m@ instead to leave open the possibility of</span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-comment">-- persistence.</span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-163"></span><span>      </span><span id="addTx"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
Mempool m blk
-&gt; AddTxOnBehalfOf -&gt; GenTx blk -&gt; m (MempoolAddTxResult blk)
</span><a href="Ouroboros.Consensus.Mempool.API.html#addTx"><span class="hs-identifier hs-var hs-var">addTx</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#AddTxOnBehalfOf"><span class="hs-identifier hs-type">AddTxOnBehalfOf</span></a></span><span>
</span><span id="line-164"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-165"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679840707"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Manually remove the given transactions from the mempool.</span></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="removeTxs"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. Mempool m blk -&gt; [GenTxId blk] -&gt; m ()
</span><a href="Ouroboros.Consensus.Mempool.API.html#removeTxs"><span class="hs-identifier hs-var hs-var">removeTxs</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679840707"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-comment">-- | Sync the transactions in the mempool with the current ledger state</span><span>
</span><span id="line-171"></span><span>      </span><span class="hs-comment">--  of the 'ChainDB'.</span><span>
</span><span id="line-172"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-173"></span><span>      </span><span class="hs-comment">-- The transactions that exist within the mempool will be revalidated</span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-comment">-- against the current ledger state. Transactions which are found to be</span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-comment">-- invalid with respect to the current ledger state, will be dropped</span><span>
</span><span id="line-176"></span><span>      </span><span class="hs-comment">-- from the mempool, whereas valid transactions will remain.</span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-178"></span><span>      </span><span class="hs-comment">-- We keep this in @m@ instead of @STM m@ to leave open the possibility</span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-comment">-- of persistence. Additionally, this makes it possible to trace the</span><span>
</span><span id="line-180"></span><span>      </span><span class="hs-comment">-- removal of invalid transactions.</span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-comment">-- n.b. in our current implementation, when one opens a mempool, we</span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-comment">-- spawn a thread which performs this action whenever the 'ChainDB' tip</span><span>
</span><span id="line-184"></span><span>      </span><span class="hs-comment">-- point changes.</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="syncWithLedger"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. Mempool m blk -&gt; m (MempoolSnapshot blk)
</span><a href="Ouroboros.Consensus.Mempool.API.html#syncWithLedger"><span class="hs-identifier hs-var hs-var">syncWithLedger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679840707"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>      </span><span class="hs-comment">-- | Get a snapshot of the current mempool state. This allows for</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-comment">-- further pure queries on the snapshot.</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-comment">-- This doesn't look at the ledger state at all.</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getSnapshot"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
Mempool m blk -&gt; STM m (MempoolSnapshot blk)
</span><a href="Ouroboros.Consensus.Mempool.API.html#getSnapshot"><span class="hs-identifier hs-var hs-var">getSnapshot</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679840707"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>      </span><span class="hs-comment">-- | Get a snapshot of the mempool state that is valid with respect to</span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-comment">-- the given ledger state</span><span>
</span><span id="line-195"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-196"></span><span>      </span><span class="hs-comment">-- This does not update the state of the mempool.</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getSnapshotFor"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
Mempool m blk
-&gt; ForgeLedgerState blk -&gt; STM m (MempoolSnapshot blk)
</span><a href="Ouroboros.Consensus.Mempool.API.html#getSnapshotFor"><span class="hs-identifier hs-var hs-var">getSnapshotFor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeLedgerState"><span class="hs-identifier hs-type">ForgeLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679840707"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-type">MempoolSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-comment">-- | Get the mempool's capacity in bytes.</span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span>      </span><span class="hs-comment">-- Note that the capacity of the Mempool, unless it is overridden with</span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-comment">-- 'MempoolCapacityBytesOverride', can dynamically change when the</span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-comment">-- ledger state is updated: it will be set to twice the current ledger's</span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-comment">-- maximum transaction capacity of a block.</span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-comment">-- When the capacity happens to shrink at some point, we /do not/ remove</span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-comment">-- transactions from the Mempool to satisfy this new lower limit.</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-comment">-- Instead, we treat it the same way as a Mempool which is /at/</span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-comment">-- capacity, i.e., we won't admit new transactions until some have been</span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-comment">-- removed because they have become invalid.</span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getCapacity"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
Mempool m blk -&gt; STM m MempoolCapacityBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#getCapacity"><span class="hs-identifier hs-var hs-var">getCapacity</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679840707"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Capacity.html#MempoolCapacityBytes"><span class="hs-identifier hs-type">Cap.MempoolCapacityBytes</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Return the post-serialisation size in bytes of a 'GenTx'.</span></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="getTxSize"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
Mempool m blk -&gt; GenTx blk -&gt; TxSizeInBytes
</span><a href="Ouroboros.Consensus.Mempool.API.html#getTxSize"><span class="hs-identifier hs-var hs-var">getTxSize</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840708"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxSizeInBytes</span></span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Result of adding a transaction to the mempool
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><span class="hs-comment">-- | The result of attempting to add a transaction to the mempool.</span></span><span>
</span><span id="line-222"></span><span class="hs-keyword">data</span><span> </span><span id="MempoolAddTxResult"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-var">MempoolAddTxResult</span></a></span></span><span> </span><span id="local-6989586621679840790"><span class="annot"><a href="#local-6989586621679840790"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MempoolTxAdded"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxAdded"><span class="hs-identifier hs-var">MempoolTxAdded</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#Validated"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840790"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The transaction was added to the mempool.</span></span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MempoolTxRejected"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxRejected"><span class="hs-identifier hs-var">MempoolTxRejected</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840790"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840790"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">-- ^ The transaction was rejected and could not be added to the mempool</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">-- for the specified reason.</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span id="local-6989586621679840737"><span id="local-6989586621679840795"><span id="local-6989586621679840800"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840737"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#Validated"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840737"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840737"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840737"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-230"></span><span id="local-6989586621679840741"><span id="local-6989586621679840808"><span id="local-6989586621679840816"><span id="local-6989586621679840820"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840741"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#Validated"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840741"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#ApplyTxErr"><span class="hs-identifier hs-type">ApplyTxErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840741"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840741"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span id="local-6989586621679840742"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#mempoolTxAddedToMaybe"><span class="hs-identifier hs-type">mempoolTxAddedToMaybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840742"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#Validated"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840742"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-233"></span><span id="mempoolTxAddedToMaybe"><span class="annot"><span class="annottext">mempoolTxAddedToMaybe :: forall blk. MempoolAddTxResult blk -&gt; Maybe (Validated (GenTx blk))
</span><a href="Ouroboros.Consensus.Mempool.API.html#mempoolTxAddedToMaybe"><span class="hs-identifier hs-var hs-var">mempoolTxAddedToMaybe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxAdded"><span class="hs-identifier hs-type">MempoolTxAdded</span></a></span><span> </span><span id="local-6989586621679840823"><span class="annot"><span class="annottext">Validated (GenTx blk)
</span><a href="#local-6989586621679840823"><span class="hs-identifier hs-var">vtx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Validated (GenTx blk) -&gt; Maybe (Validated (GenTx blk))
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Validated (GenTx blk)
</span><a href="#local-6989586621679840823"><span class="hs-identifier hs-var">vtx</span></a></span><span>
</span><span id="line-234"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#mempoolTxAddedToMaybe"><span class="hs-identifier hs-var">mempoolTxAddedToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Validated (GenTx blk))
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span id="local-6989586621679840745"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier hs-type">isMempoolTxAdded</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840745"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-237"></span><span id="isMempoolTxAdded"><span class="annot"><span class="annottext">isMempoolTxAdded :: forall blk. MempoolAddTxResult blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier hs-var hs-var">isMempoolTxAdded</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxAdded"><span class="hs-identifier hs-type">MempoolTxAdded</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-238"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxAdded"><span class="hs-identifier hs-var">isMempoolTxAdded</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span id="local-6989586621679840824"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier hs-type">isMempoolTxRejected</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840824"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-241"></span><span id="isMempoolTxRejected"><span class="annot"><span class="annottext">isMempoolTxRejected :: forall blk. MempoolAddTxResult blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier hs-var hs-var">isMempoolTxRejected</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolTxRejected"><span class="hs-identifier hs-type">MempoolTxRejected</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-242"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#isMempoolTxRejected"><span class="hs-identifier hs-var">isMempoolTxRejected</span></a></span><span> </span><span class="annot"><span class="annottext">MempoolAddTxResult blk
</span><span class="hs-identifier">_</span></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | A wrapper around 'addTx' that adds a sequence of transactions on behalf of</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- a remote peer.</span><span>
</span><span id="line-246"></span><span class="hs-comment">--</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- Note that transactions are added one by one, and can interleave with other</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- concurrent threads using 'addTx'.</span><span>
</span><span id="line-249"></span><span class="hs-comment">--</span><span>
</span><span id="line-250"></span><span class="hs-comment">-- See 'addTx' for further details.</span><span>
</span><span id="line-251"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#addTxs"><span class="hs-identifier hs-type">addTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-252"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679840748"><span class="annot"><a href="#local-6989586621679840748"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679840750"><span class="annot"><a href="#local-6989586621679840750"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679840748"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier hs-type">Mempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840750"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840750"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679840748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840750"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-256"></span><span id="addTxs"><span class="annot"><span class="annottext">addTxs :: forall (m :: * -&gt; *) blk.
MonadSTM m =&gt;
Mempool m blk -&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
</span><a href="Ouroboros.Consensus.Mempool.API.html#addTxs"><span class="hs-identifier hs-var hs-var">addTxs</span></a></span></span><span> </span><span id="local-6989586621679840831"><span class="annot"><span class="annottext">Mempool m blk
</span><a href="#local-6989586621679840831"><span class="hs-identifier hs-var">mempool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GenTx blk -&gt; m (MempoolAddTxResult blk))
-&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Mempool m blk
-&gt; AddTxOnBehalfOf -&gt; GenTx blk -&gt; m (MempoolAddTxResult blk)
forall (m :: * -&gt; *) blk.
Mempool m blk
-&gt; AddTxOnBehalfOf -&gt; GenTx blk -&gt; m (MempoolAddTxResult blk)
</span><a href="Ouroboros.Consensus.Mempool.API.html#addTx"><span class="hs-identifier hs-var">addTx</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk
</span><a href="#local-6989586621679840831"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForRemotePeer"><span class="hs-identifier hs-var">AddTxForRemotePeer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="hs-comment">-- | A wrapper around 'addTx' that adds a sequence of transactions on behalf of</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- a local client. This reports more errors for local clients, see 'Intervene'.</span><span>
</span><span id="line-260"></span><span class="hs-comment">--</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- Note that transactions are added one by one, and can interleave with other</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- concurrent threads using 'addTx'.</span><span>
</span><span id="line-263"></span><span class="hs-comment">--</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- See 'addTx' for further details.</span><span>
</span><span id="line-265"></span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#addLocalTxs"><span class="hs-identifier hs-type">addLocalTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-266"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679840834"><span class="annot"><a href="#local-6989586621679840834"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679840835"><span class="annot"><a href="#local-6989586621679840835"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679840834"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#Mempool"><span class="hs-identifier hs-type">Mempool</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840834"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840835"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840835"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679840834"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolAddTxResult"><span class="hs-identifier hs-type">MempoolAddTxResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840835"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-270"></span><span id="addLocalTxs"><span class="annot"><span class="annottext">addLocalTxs :: forall (m :: * -&gt; *) blk.
MonadSTM m =&gt;
Mempool m blk -&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
</span><a href="Ouroboros.Consensus.Mempool.API.html#addLocalTxs"><span class="hs-identifier hs-var hs-var">addLocalTxs</span></a></span></span><span> </span><span id="local-6989586621679840840"><span class="annot"><span class="annottext">Mempool m blk
</span><a href="#local-6989586621679840840"><span class="hs-identifier hs-var">mempool</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(GenTx blk -&gt; m (MempoolAddTxResult blk))
-&gt; [GenTx blk] -&gt; m [MempoolAddTxResult blk]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Mempool m blk
-&gt; AddTxOnBehalfOf -&gt; GenTx blk -&gt; m (MempoolAddTxResult blk)
forall (m :: * -&gt; *) blk.
Mempool m blk
-&gt; AddTxOnBehalfOf -&gt; GenTx blk -&gt; m (MempoolAddTxResult blk)
</span><a href="Ouroboros.Consensus.Mempool.API.html#addTx"><span class="hs-identifier hs-var">addTx</span></a></span><span> </span><span class="annot"><span class="annottext">Mempool m blk
</span><a href="#local-6989586621679840840"><span class="hs-identifier hs-var">mempool</span></a></span><span> </span><span class="annot"><span class="annottext">AddTxOnBehalfOf
</span><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForLocalClient"><span class="hs-identifier hs-var">AddTxForLocalClient</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="hs-comment">-- | Who are we adding a tx on behalf of, a remote peer or a local client?</span><span>
</span><span id="line-273"></span><span class="hs-comment">--</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- This affects two things:</span><span>
</span><span id="line-275"></span><span class="hs-comment">--</span><span>
</span><span id="line-276"></span><span class="hs-comment">-- 1. how certain errors are treated: we want to be helpful to local clients.</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- 2. priority of service: local clients are prioritised over remote peers.</span><span>
</span><span id="line-278"></span><span class="hs-comment">--</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- See 'Mempool' for a discussion of fairness and priority.</span><span>
</span><span id="line-280"></span><span class="hs-comment">--</span><span>
</span><span id="line-281"></span><span class="hs-keyword">data</span><span> </span><span id="AddTxOnBehalfOf"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#AddTxOnBehalfOf"><span class="hs-identifier hs-var">AddTxOnBehalfOf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AddTxForRemotePeer"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForRemotePeer"><span class="hs-identifier hs-var">AddTxForRemotePeer</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="AddTxForLocalClient"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#AddTxForLocalClient"><span class="hs-identifier hs-var">AddTxForLocalClient</span></a></span></span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Ledger state considered for forging
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | The ledger state wrt to which we should produce a block</span><span>
</span><span id="line-289"></span><span class="hs-comment">--</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- The transactions in the mempool will be part of the body of a block, but a</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- block consists of a header and a body, and the full validation of a block</span><span>
</span><span id="line-292"></span><span class="hs-comment">-- consists of first processing its header and only then processing the body.</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- This is important, because processing the header may change the state of the</span><span>
</span><span id="line-294"></span><span class="hs-comment">-- ledger: the update system might be updated, scheduled delegations might be</span><span>
</span><span id="line-295"></span><span class="hs-comment">-- applied, etc., and such changes should take effect before we validate any</span><span>
</span><span id="line-296"></span><span class="hs-comment">-- transactions.</span><span>
</span><span id="line-297"></span><span class="hs-keyword">data</span><span> </span><span id="ForgeLedgerState"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeLedgerState"><span class="hs-identifier hs-var">ForgeLedgerState</span></a></span></span><span> </span><span id="local-6989586621679840841"><span class="annot"><a href="#local-6989586621679840841"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-comment">-- | The slot number of the block is known</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-comment">-- This will only be the case when we realized that we are the slot leader</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-comment">-- and we are actually producing a block. It is the caller's responsibility</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-comment">-- to call 'applyChainTick' and produce the ticked ledger state.</span><span>
</span><span id="line-303"></span><span>    </span><span id="ForgeInKnownSlot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeInKnownSlot"><span class="hs-identifier hs-var">ForgeInKnownSlot</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#TickedLedgerState"><span class="hs-identifier hs-type">TickedLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840841"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-comment">-- | The slot number of the block is not yet known</span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-comment">-- When we are validating transactions before we know in which block they</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- will end up, we have to make an assumption about which slot number to use</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-comment">-- for 'applyChainTick' to prepare the ledger state; we will assume that</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-comment">-- they will end up in the slot after the slot at the tip of the ledger.</span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ForgeInUnknownSlot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#ForgeInUnknownSlot"><span class="hs-identifier hs-var">ForgeInUnknownSlot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840841"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Snapshot of the mempool
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="hs-comment">-- | A pure snapshot of the contents of the mempool. It allows fetching</span><span>
</span><span id="line-319"></span><span class="hs-comment">-- information about transactions in the mempool, and fetching individual</span><span>
</span><span id="line-320"></span><span class="hs-comment">-- transactions.</span><span>
</span><span id="line-321"></span><span class="hs-comment">--</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- This uses a transaction sequence number type for identifying transactions</span><span>
</span><span id="line-323"></span><span class="hs-comment">-- within the mempool sequence. The sequence number is local to this mempool,</span><span>
</span><span id="line-324"></span><span class="hs-comment">-- unlike the transaction hash. This allows us to ask for all transactions</span><span>
</span><span id="line-325"></span><span class="hs-comment">-- after a known sequence number, to get new transactions. It is also used to</span><span>
</span><span id="line-326"></span><span class="hs-comment">-- look up individual transactions.</span><span>
</span><span id="line-327"></span><span class="hs-comment">--</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- Note that it is expected that 'getTx' will often return 'Nothing'</span><span>
</span><span id="line-329"></span><span class="hs-comment">-- even for tx sequence numbers returned in previous snapshots. This happens</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- when the transaction has been removed from the mempool between snapshots.</span><span>
</span><span id="line-331"></span><span class="hs-comment">--</span><span>
</span><span id="line-332"></span><span class="hs-keyword">data</span><span> </span><span id="MempoolSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-var">MempoolSnapshot</span></a></span></span><span> </span><span id="local-6989586621679840760"><span class="annot"><a href="#local-6989586621679840760"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MempoolSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Mempool.API.html#MempoolSnapshot"><span class="hs-identifier hs-var">MempoolSnapshot</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-comment">-- | Get all transactions (oldest to newest) in the mempool snapshot along</span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-comment">-- with their ticket number.</span><span>
</span><span id="line-335"></span><span>    </span><span id="snapshotTxs"><span class="annot"><span class="annottext">forall blk.
MempoolSnapshot blk -&gt; [(Validated (GenTx blk), TicketNo)]
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotTxs"><span class="hs-identifier hs-var hs-var">snapshotTxs</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#Validated"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840760"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#TicketNo"><span class="hs-identifier hs-type">TicketNo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-comment">-- | Get all transactions (oldest to newest) in the mempool snapshot,</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-comment">-- along with their ticket number, which are associated with a ticket</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-comment">-- number greater than the one provided.</span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotTxsAfter"><span class="annot"><span class="annottext">forall blk.
MempoolSnapshot blk
-&gt; TicketNo -&gt; [(Validated (GenTx blk), TicketNo)]
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotTxsAfter"><span class="hs-identifier hs-var hs-var">snapshotTxsAfter</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#TicketNo"><span class="hs-identifier hs-type">TicketNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#Validated"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840760"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#TicketNo"><span class="hs-identifier hs-type">TicketNo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-comment">-- | Get a specific transaction from the mempool snapshot by its ticket</span><span>
</span><span id="line-343"></span><span>    </span><span class="hs-comment">-- number, if it exists.</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotLookupTx"><span class="annot"><span class="annottext">forall blk.
MempoolSnapshot blk -&gt; TicketNo -&gt; Maybe (Validated (GenTx blk))
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotLookupTx"><span class="hs-identifier hs-var hs-var">snapshotLookupTx</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.TxSeq.html#TicketNo"><span class="hs-identifier hs-type">TicketNo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html#Validated"><span class="hs-identifier hs-type">Validated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTx"><span class="hs-identifier hs-type">GenTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840760"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-comment">-- | Determine whether a specific transaction exists within the mempool</span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-comment">-- snapshot.</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotHasTx"><span class="annot"><span class="annottext">forall blk. MempoolSnapshot blk -&gt; GenTxId blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotHasTx"><span class="hs-identifier hs-var hs-var">snapshotHasTx</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsMempool.html#GenTxId"><span class="hs-identifier hs-type">GenTxId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840760"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Get the size of the mempool snapshot.</span></span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotMempoolSize"><span class="annot"><span class="annottext">forall blk. MempoolSnapshot blk -&gt; MempoolSize
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotMempoolSize"><span class="hs-identifier hs-var hs-var">snapshotMempoolSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Mempool.Capacity.html#MempoolSize"><span class="hs-identifier hs-type">Cap.MempoolSize</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="hs-comment">-- | The block number of the &quot;virtual block&quot; under construction</span></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotSlotNo"><span class="annot"><span class="annottext">forall blk. MempoolSnapshot blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotSlotNo"><span class="hs-identifier hs-var hs-var">snapshotSlotNo</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SlotNo</span></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><span class="hs-comment">-- | The ledger state after all transactions in the snapshot</span></span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="snapshotLedgerState"><span class="annot"><span class="annottext">forall blk. MempoolSnapshot blk -&gt; TickedLedgerState blk
</span><a href="Ouroboros.Consensus.Mempool.API.html#snapshotLedgerState"><span class="hs-identifier hs-var hs-var">snapshotLedgerState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#TickedLedgerState"><span class="hs-identifier hs-type">TickedLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679840760"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-359"></span></pre></body></html>
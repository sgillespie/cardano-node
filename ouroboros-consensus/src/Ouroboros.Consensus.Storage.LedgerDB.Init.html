<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric       #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="annot"><span class="hs-comment">-- | LedgerDB initialization either from a LedgerState or from a DiskSnapshot</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.Init</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Initialization</span></span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitLog"><span class="hs-identifier">InitLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier">ReplayStart</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initLedgerDB"><span class="hs-identifier">initLedgerDB</span></a></span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Trace</span></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier">ReplayGoal</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier">TraceReplayEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithGoal"><span class="hs-identifier">decorateReplayTracerWithGoal</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithStart"><span class="hs-identifier">decorateReplayTracerWithStart</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Codec.Serialise.Decoding</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decoder</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier">ExceptT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier">runExceptT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier">throwError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>                     </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#withExceptT"><span class="hs-identifier">withExceptT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html"><span class="hs-identifier">Ouroboros.Consensus.HeaderValidation</span></a></span><span>
</span><span id="line-30"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#HeaderState"><span class="hs-identifier">HeaderState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#headerStateTip"><span class="hs-identifier">headerStateTip</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HeaderValidation.html#annTipPoint"><span class="hs-identifier">annTipPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Inspect</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.LedgerDB</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.Query</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.Snapshots</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.Stream</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Update.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.LedgerDB.Update</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Point</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Point</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API</span></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Initialize the DB
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">-- | Initialization log</span><span>
</span><span id="line-49"></span><span class="hs-comment">--</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- The initialization log records which snapshots from disk were considered,</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- in which order, and why some snapshots were rejected. It is primarily useful</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- for monitoring purposes.</span><span>
</span><span id="line-53"></span><span class="hs-keyword">data</span><span> </span><span id="InitLog"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitLog"><span class="hs-identifier hs-var">InitLog</span></a></span></span><span> </span><span id="local-6989586621679877056"><span class="annot"><a href="#local-6989586621679877056"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-comment">-- | Defaulted to initialization from genesis</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-comment">-- NOTE: Unless the blockchain is near genesis, we should see this /only/</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- if data corrupted occurred.</span><span>
</span><span id="line-58"></span><span>    </span><span id="InitFromGenesis"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitFromGenesis"><span class="hs-identifier hs-var">InitFromGenesis</span></a></span></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Used a snapshot corresponding to the specified tip</span></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InitFromSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitFromSnapshot"><span class="hs-identifier hs-var">InitFromSnapshot</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877056"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-comment">-- | Initialization skipped a snapshot</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- We record the reason why it was skipped.</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- NOTE: We should /only/ see this if data corrupted occurred.</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InitFailure"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitFailure"><span class="hs-identifier hs-var">InitFailure</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#SnapshotFailure"><span class="hs-identifier hs-type">SnapshotFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877056"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitLog"><span class="hs-identifier hs-type">InitLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877056"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679877209"><span id="local-6989586621679877223"><span id="local-6989586621679877226"><span class="annot"><span class="annottext">Int -&gt; InitLog blk -&gt; ShowS
[InitLog blk] -&gt; ShowS
InitLog blk -&gt; String
(Int -&gt; InitLog blk -&gt; ShowS)
-&gt; (InitLog blk -&gt; String)
-&gt; ([InitLog blk] -&gt; ShowS)
-&gt; Show (InitLog blk)
forall blk. StandardHash blk =&gt; Int -&gt; InitLog blk -&gt; ShowS
forall blk. StandardHash blk =&gt; [InitLog blk] -&gt; ShowS
forall blk. StandardHash blk =&gt; InitLog blk -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall blk. StandardHash blk =&gt; Int -&gt; InitLog blk -&gt; ShowS
showsPrec :: Int -&gt; InitLog blk -&gt; ShowS
$cshow :: forall blk. StandardHash blk =&gt; InitLog blk -&gt; String
show :: InitLog blk -&gt; String
$cshowList :: forall blk. StandardHash blk =&gt; [InitLog blk] -&gt; ShowS
showList :: [InitLog blk] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877231"><span id="local-6989586621679877242"><span class="annot"><span class="annottext">InitLog blk -&gt; InitLog blk -&gt; Bool
(InitLog blk -&gt; InitLog blk -&gt; Bool)
-&gt; (InitLog blk -&gt; InitLog blk -&gt; Bool) -&gt; Eq (InitLog blk)
forall blk. StandardHash blk =&gt; InitLog blk -&gt; InitLog blk -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall blk. StandardHash blk =&gt; InitLog blk -&gt; InitLog blk -&gt; Bool
== :: InitLog blk -&gt; InitLog blk -&gt; Bool
$c/= :: forall blk. StandardHash blk =&gt; InitLog blk -&gt; InitLog blk -&gt; Bool
/= :: InitLog blk -&gt; InitLog blk -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877246"><span id="local-6989586621679877248"><span class="annot"><span class="annottext">(forall x. InitLog blk -&gt; Rep (InitLog blk) x)
-&gt; (forall x. Rep (InitLog blk) x -&gt; InitLog blk)
-&gt; Generic (InitLog blk)
forall x. Rep (InitLog blk) x -&gt; InitLog blk
forall x. InitLog blk -&gt; Rep (InitLog blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x. Rep (InitLog blk) x -&gt; InitLog blk
forall blk x. InitLog blk -&gt; Rep (InitLog blk) x
$cfrom :: forall blk x. InitLog blk -&gt; Rep (InitLog blk) x
from :: forall x. InitLog blk -&gt; Rep (InitLog blk) x
$cto :: forall blk x. Rep (InitLog blk) x -&gt; InitLog blk
to :: forall x. Rep (InitLog blk) x -&gt; InitLog blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-comment">-- | Initialize the ledger DB from the most recent snapshot on disk</span><span>
</span><span id="line-72"></span><span class="hs-comment">--</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- If no such snapshot can be found, use the genesis ledger DB. Returns the</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- initialized DB as well as the block reference corresponding to the snapshot</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- we found on disk (the latter primarily for testing/monitoring purposes).</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- We do /not/ catch any exceptions thrown during streaming; should any be</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- thrown, it is the responsibility of the 'ChainDB' to catch these</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- and trigger (further) validation. We only discard snapshots if</span><span>
</span><span id="line-80"></span><span class="hs-comment">--</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- * We cannot deserialise them, or</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- * they are /ahead/ of the chain</span><span>
</span><span id="line-83"></span><span class="hs-comment">--</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- It is possible that the Ledger DB will not be able to roll back @k@ blocks</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- after initialization if the chain has been truncated (data corruption).</span><span>
</span><span id="line-86"></span><span class="hs-comment">--</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- We do /not/ attempt to use multiple ledger states from disk to construct the</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- ledger DB. Instead we load only a /single/ ledger state from disk, and</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- /compute/ all subsequent ones. This is important, because the ledger states</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- obtained in this way will (hopefully) share much of their memory footprint</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- with their predecessors.</span><span>
</span><span id="line-92"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initLedgerDB"><span class="hs-identifier hs-type">initLedgerDB</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-93"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679876988"><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679876990"><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-94"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-95"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-96"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-97"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-98"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-type">TraceReplayEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#TraceSnapshotEvent"><span class="hs-identifier hs-type">TraceSnapshotEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679876999"><span class="annot"><a href="#local-6989586621679876999"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679876999"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679877002"><span class="annot"><a href="#local-6989586621679877002"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679877002"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDbCfg"><span class="hs-identifier hs-type">LedgerDbCfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ Genesis ledger state</span></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier hs-type">StreamAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitLog"><span class="hs-identifier hs-type">InitLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span id="initLedgerDB"><span class="annot"><span class="annottext">initLedgerDB :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasCallStack) =&gt;
Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer m (TraceSnapshotEvent blk)
-&gt; SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; m (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; m (InitLog blk, LedgerDB' blk, Word64)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initLedgerDB"><span class="hs-identifier hs-var hs-var">initLedgerDB</span></a></span></span><span> </span><span id="local-6989586621679877297"><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877297"><span class="hs-identifier hs-var">replayTracer</span></a></span></span><span>
</span><span id="line-109"></span><span>             </span><span id="local-6989586621679877298"><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent blk)
</span><a href="#local-6989586621679877298"><span class="hs-identifier hs-var">tracer</span></a></span></span><span>
</span><span id="line-110"></span><span>             </span><span id="local-6989586621679877299"><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679877299"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span>
</span><span id="line-111"></span><span>             </span><span id="local-6989586621679877300"><span class="annot"><span class="annottext">forall s. Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621679877300"><span class="hs-identifier hs-var">decLedger</span></a></span></span><span>
</span><span id="line-112"></span><span>             </span><span id="local-6989586621679877301"><span class="annot"><span class="annottext">forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621679877301"><span class="hs-identifier hs-var">decHash</span></a></span></span><span>
</span><span id="line-113"></span><span>             </span><span id="local-6989586621679877302"><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877302"><span class="hs-identifier hs-var">cfg</span></a></span></span><span>
</span><span id="line-114"></span><span>             </span><span id="local-6989586621679877303"><span class="annot"><span class="annottext">m (ExtLedgerState blk)
</span><a href="#local-6989586621679877303"><span class="hs-identifier hs-var">getGenesisLedger</span></a></span></span><span>
</span><span id="line-115"></span><span>             </span><span id="local-6989586621679877304"><span class="annot"><span class="annottext">StreamAPI m blk
</span><a href="#local-6989586621679877304"><span class="hs-identifier hs-var">streamAPI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621679877305"><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621679877305"><span class="hs-identifier hs-var">snapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeHasFS m -&gt; m [DiskSnapshot]
forall (m :: * -&gt; *). Monad m =&gt; SomeHasFS m -&gt; m [DiskSnapshot]
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#listSnapshots"><span class="hs-identifier hs-var">listSnapshots</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679877299"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="annottext">(InitLog blk -&gt; InitLog blk)
-&gt; [DiskSnapshot] -&gt; m (InitLog blk, LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877307"><span class="hs-identifier hs-var">tryNewestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">InitLog blk -&gt; InitLog blk
forall a. a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#id"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621679877305"><span class="hs-identifier hs-var">snapshots</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><a href="#local-6989586621679877307"><span class="hs-identifier hs-type">tryNewestFirst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitLog"><span class="hs-identifier hs-type">InitLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitLog"><span class="hs-identifier hs-type">InitLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-121"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679876988"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitLog"><span class="hs-identifier hs-type">InitLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679876990"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621679877307"><span class="annot"><span class="annottext">tryNewestFirst :: (InitLog blk -&gt; InitLog blk)
-&gt; [DiskSnapshot] -&gt; m (InitLog blk, LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877307"><span class="hs-identifier hs-var hs-var">tryNewestFirst</span></a></span></span><span> </span><span id="local-6989586621679877309"><span class="annot"><span class="annottext">InitLog blk -&gt; InitLog blk
</span><a href="#local-6989586621679877309"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>        </span><span class="hs-comment">-- We're out of snapshots. Start at genesis</span><span>
</span><span id="line-124"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; (ReplayGoal blk -&gt; TraceReplayEvent blk) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877297"><span class="hs-identifier hs-var">replayTracer</span></a></span><span> </span><span class="annot"><span class="annottext">ReplayGoal blk -&gt; TraceReplayEvent blk
forall blk. ReplayGoal blk -&gt; TraceReplayEvent blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayFromGenesis"><span class="hs-identifier hs-var">ReplayFromGenesis</span></a></span><span>
</span><span id="line-125"></span><span>        </span><span id="local-6989586621679877312"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877312"><span class="hs-identifier hs-var">initDb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerDB' blk
forall l. GetTip l =&gt; l -&gt; LedgerDB l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Update.html#ledgerDbWithAnchor"><span class="hs-identifier hs-var">ledgerDbWithAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; LedgerDB' blk)
-&gt; m (ExtLedgerState blk) -&gt; m (LedgerDB' blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m (ExtLedgerState blk)
</span><a href="#local-6989586621679877303"><span class="hs-identifier hs-var">getGenesisLedger</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679877315"><span class="annot"><span class="annottext">replayTracer' :: Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877315"><span class="hs-identifier hs-var hs-var">replayTracer'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer
     m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
forall blk (m :: * -&gt; *).
Point blk
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer
     m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithStart"><span class="hs-identifier hs-var">decorateReplayTracerWithStart</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithOrigin (Block SlotNo (HeaderHash blk)) -&gt; Point blk
forall {k} (block :: k).
WithOrigin (Block SlotNo (HeaderHash block)) -&gt; Point block
</span><span class="hs-identifier hs-var">Point</span></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Block SlotNo (HeaderHash blk))
forall t. WithOrigin t
</span><span class="hs-identifier hs-var">Origin</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877297"><span class="hs-identifier hs-var">replayTracer</span></a></span><span>
</span><span id="line-127"></span><span>        </span><span id="local-6989586621679877317"><span class="annot"><span class="annottext">Either (SnapshotFailure blk) (LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877317"><span class="hs-identifier hs-var">ml</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
-&gt; m (Either (SnapshotFailure blk) (LedgerDB' blk, Word64))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
 -&gt; m (Either (SnapshotFailure blk) (LedgerDB' blk, Word64)))
-&gt; ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
-&gt; m (Either (SnapshotFailure blk) (LedgerDB' blk, Word64))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; LedgerDB' blk
-&gt; ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
forall (m :: * -&gt; *) blk.
(Monad m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasCallStack) =&gt;
Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; LedgerDB' blk
-&gt; ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initStartingWith"><span class="hs-identifier hs-var">initStartingWith</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877315"><span class="hs-identifier hs-var">replayTracer'</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877302"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">StreamAPI m blk
</span><a href="#local-6989586621679877304"><span class="hs-identifier hs-var">streamAPI</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877312"><span class="hs-identifier hs-var">initDb</span></a></span><span>
</span><span id="line-128"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (SnapshotFailure blk) (LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877317"><span class="hs-identifier hs-var">ml</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-129"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">SnapshotFailure blk
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m (InitLog blk, LedgerDB' blk, Word64)
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invariant violation: invalid current chain&quot;</span></span><span>
</span><span id="line-130"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679877320"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877320"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877321"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877321"><span class="hs-identifier hs-var">replayed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(InitLog blk, LedgerDB' blk, Word64)
-&gt; m (InitLog blk, LedgerDB' blk, Word64)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InitLog blk -&gt; InitLog blk
</span><a href="#local-6989586621679877309"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">InitLog blk
forall blk. InitLog blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitFromGenesis"><span class="hs-identifier hs-var">InitFromGenesis</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877320"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877321"><span class="hs-identifier hs-var">replayed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>    </span><span class="annot"><a href="#local-6989586621679877307"><span class="hs-identifier hs-var">tryNewestFirst</span></a></span><span> </span><span id="local-6989586621679877322"><span class="annot"><span class="annottext">InitLog blk -&gt; InitLog blk
</span><a href="#local-6989586621679877322"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679877323"><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877323"><span class="hs-identifier hs-var">s</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679877324"><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621679877324"><span class="hs-identifier hs-var">ss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-comment">-- If we fail to use this snapshot, delete it and try an older one</span><span>
</span><span id="line-133"></span><span>        </span><span id="local-6989586621679877325"><span class="annot"><span class="annottext">Either (SnapshotFailure blk) (RealPoint blk, LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877325"><span class="hs-identifier hs-var">ml</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT
  (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
-&gt; m (Either
        (SnapshotFailure blk) (RealPoint blk, LedgerDB' blk, Word64))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
 -&gt; m (Either
         (SnapshotFailure blk) (RealPoint blk, LedgerDB' blk, Word64)))
-&gt; ExceptT
     (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
-&gt; m (Either
        (SnapshotFailure blk) (RealPoint blk, LedgerDB' blk, Word64))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; DiskSnapshot
-&gt; ExceptT
     (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasCallStack) =&gt;
Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; DiskSnapshot
-&gt; ExceptT
     (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initFromSnapshot"><span class="hs-identifier hs-var">initFromSnapshot</span></a></span><span>
</span><span id="line-134"></span><span>                             </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877297"><span class="hs-identifier hs-var">replayTracer</span></a></span><span>
</span><span id="line-135"></span><span>                             </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679877299"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-136"></span><span>                             </span><span class="annot"><span class="annottext">Decoder s (ExtLedgerState blk)
forall s. Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621679877300"><span class="hs-identifier hs-var">decLedger</span></a></span><span>
</span><span id="line-137"></span><span>                             </span><span class="annot"><span class="annottext">Decoder s (HeaderHash blk)
forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621679877301"><span class="hs-identifier hs-var">decHash</span></a></span><span>
</span><span id="line-138"></span><span>                             </span><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877302"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-139"></span><span>                             </span><span class="annot"><span class="annottext">StreamAPI m blk
</span><a href="#local-6989586621679877304"><span class="hs-identifier hs-var">streamAPI</span></a></span><span>
</span><span id="line-140"></span><span>                             </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877323"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-141"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (SnapshotFailure blk) (RealPoint blk, LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877325"><span class="hs-identifier hs-var">ml</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-142"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679877327"><span class="annot"><span class="annottext">SnapshotFailure blk
</span><a href="#local-6989586621679877327"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiskSnapshot -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#diskSnapshotIsTemporary"><span class="hs-identifier hs-var">diskSnapshotIsTemporary</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877323"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-144"></span><span>              </span><span class="hs-comment">-- We don't delete permanent snapshots, even if we couldn't parse</span><span>
</span><span id="line-145"></span><span>              </span><span class="hs-comment">-- them</span><span>
</span><span id="line-146"></span><span>              </span><span class="annot"><span class="annottext">SomeHasFS m -&gt; DiskSnapshot -&gt; m ()
forall (m :: * -&gt; *).
HasCallStack =&gt;
SomeHasFS m -&gt; DiskSnapshot -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#deleteSnapshot"><span class="hs-identifier hs-var">deleteSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679877299"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877323"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-147"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent blk) -&gt; TraceSnapshotEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceSnapshotEvent blk)
</span><a href="#local-6989586621679877298"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceSnapshotEvent blk -&gt; m ()) -&gt; TraceSnapshotEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; SnapshotFailure blk -&gt; TraceSnapshotEvent blk
forall blk.
DiskSnapshot -&gt; SnapshotFailure blk -&gt; TraceSnapshotEvent blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InvalidSnapshot"><span class="hs-identifier hs-var">InvalidSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877323"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SnapshotFailure blk
</span><a href="#local-6989586621679877327"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-148"></span><span>            </span><span class="annot"><span class="annottext">(InitLog blk -&gt; InitLog blk)
-&gt; [DiskSnapshot] -&gt; m (InitLog blk, LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877307"><span class="hs-identifier hs-var">tryNewestFirst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InitLog blk -&gt; InitLog blk
</span><a href="#local-6989586621679877322"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">(InitLog blk -&gt; InitLog blk)
-&gt; (InitLog blk -&gt; InitLog blk) -&gt; InitLog blk -&gt; InitLog blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot -&gt; SnapshotFailure blk -&gt; InitLog blk -&gt; InitLog blk
forall blk.
DiskSnapshot -&gt; SnapshotFailure blk -&gt; InitLog blk -&gt; InitLog blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitFailure"><span class="hs-identifier hs-var">InitFailure</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877323"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">SnapshotFailure blk
</span><a href="#local-6989586621679877327"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DiskSnapshot]
</span><a href="#local-6989586621679877324"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-149"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679877332"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679877332"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877333"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877333"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877334"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877334"><span class="hs-identifier hs-var">replayed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>            </span><span class="annot"><span class="annottext">(InitLog blk, LedgerDB' blk, Word64)
-&gt; m (InitLog blk, LedgerDB' blk, Word64)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InitLog blk -&gt; InitLog blk
</span><a href="#local-6989586621679877322"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiskSnapshot -&gt; RealPoint blk -&gt; InitLog blk
forall blk. DiskSnapshot -&gt; RealPoint blk -&gt; InitLog blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#InitFromSnapshot"><span class="hs-identifier hs-var">InitFromSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877323"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679877332"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877333"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877334"><span class="hs-identifier hs-var">replayed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Internal: initialize using the given snapshot
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">-- | Attempt to initialize the ledger DB from the given snapshot</span><span>
</span><span id="line-157"></span><span class="hs-comment">--</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- If the chain DB or ledger layer reports an error, the whole thing is aborted</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- and an error is returned. This should not throw any errors itself (ignoring</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- unexpected exceptions such as asynchronous exceptions, of course).</span><span>
</span><span id="line-161"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initFromSnapshot"><span class="hs-identifier hs-type">initFromSnapshot</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-162"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679877057"><span class="annot"><a href="#local-6989586621679877057"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679877058"><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-163"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877057"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-164"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-165"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-166"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-167"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679877057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-type">TraceReplayEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679877057"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679877059"><span class="annot"><a href="#local-6989586621679877059"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679877059"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679877060"><span class="annot"><a href="#local-6989586621679877060"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decoder</span></span><span> </span><span class="annot"><a href="#local-6989586621679877060"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDbCfg"><span class="hs-identifier hs-type">LedgerDbCfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier hs-type">StreamAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#SnapshotFailure"><span class="hs-identifier hs-type">SnapshotFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679877057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877058"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span id="initFromSnapshot"><span class="annot"><span class="annottext">initFromSnapshot :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasCallStack) =&gt;
Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; DiskSnapshot
-&gt; ExceptT
     (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initFromSnapshot"><span class="hs-identifier hs-var hs-var">initFromSnapshot</span></a></span></span><span> </span><span id="local-6989586621679877407"><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877407"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679877408"><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679877408"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679877409"><span class="annot"><span class="annottext">forall s. Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621679877409"><span class="hs-identifier hs-var">decLedger</span></a></span></span><span> </span><span id="local-6989586621679877410"><span class="annot"><span class="annottext">forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621679877410"><span class="hs-identifier hs-var">decHash</span></a></span></span><span> </span><span id="local-6989586621679877411"><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877411"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679877412"><span class="annot"><span class="annottext">StreamAPI m blk
</span><a href="#local-6989586621679877412"><span class="hs-identifier hs-var">streamAPI</span></a></span></span><span> </span><span id="local-6989586621679877413"><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877413"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621679877414"><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679877414"><span class="hs-identifier hs-var">initSS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ReadIncrementalErr -&gt; SnapshotFailure blk)
-&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk)
-&gt; ExceptT (SnapshotFailure blk) m (ExtLedgerState blk)
forall (m :: * -&gt; *) e e' a.
Functor m =&gt;
(e -&gt; e') -&gt; ExceptT e m a -&gt; ExceptT e' m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#withExceptT"><span class="hs-identifier hs-var">withExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">ReadIncrementalErr -&gt; SnapshotFailure blk
forall blk. ReadIncrementalErr -&gt; SnapshotFailure blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InitFailureRead"><span class="hs-identifier hs-var">InitFailureRead</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT ReadIncrementalErr m (ExtLedgerState blk)
 -&gt; ExceptT (SnapshotFailure blk) m (ExtLedgerState blk))
-&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk)
-&gt; ExceptT (SnapshotFailure blk) m (ExtLedgerState blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-178"></span><span>                </span><span class="annot"><span class="annottext">SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; DiskSnapshot
-&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
SomeHasFS m
-&gt; (forall s. Decoder s (ExtLedgerState blk))
-&gt; (forall s. Decoder s (HeaderHash blk))
-&gt; DiskSnapshot
-&gt; ExceptT ReadIncrementalErr m (ExtLedgerState blk)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#readSnapshot"><span class="hs-identifier hs-var">readSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679877408"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (ExtLedgerState blk)
forall s. Decoder s (ExtLedgerState blk)
</span><a href="#local-6989586621679877409"><span class="hs-identifier hs-var">decLedger</span></a></span><span> </span><span class="annot"><span class="annottext">Decoder s (HeaderHash blk)
forall s. Decoder s (HeaderHash blk)
</span><a href="#local-6989586621679877410"><span class="hs-identifier hs-var">decHash</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877413"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679877428"><span class="annot"><span class="annottext">initialPoint :: Point blk
</span><a href="#local-6989586621679877428"><span class="hs-identifier hs-var hs-var">initialPoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; (AnnTip blk -&gt; Point blk)
-&gt; WithOrigin (AnnTip blk)
-&gt; Point blk
forall b t. b -&gt; (t -&gt; b) -&gt; WithOrigin t -&gt; b
</span><span class="hs-identifier hs-var">withOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithOrigin (Block SlotNo (HeaderHash blk)) -&gt; Point blk
forall {k} (block :: k).
WithOrigin (Block SlotNo (HeaderHash block)) -&gt; Point block
</span><span class="hs-identifier hs-var">Point</span></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Block SlotNo (HeaderHash blk))
forall t. WithOrigin t
</span><span class="hs-identifier hs-var">Origin</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnnTip blk -&gt; Point blk
forall blk. HasAnnTip blk =&gt; AnnTip blk -&gt; Point blk
</span><a href="Ouroboros.Consensus.HeaderValidation.html#annTipPoint"><span class="hs-identifier hs-var">annTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(WithOrigin (AnnTip blk) -&gt; Point blk)
-&gt; WithOrigin (AnnTip blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderState blk -&gt; WithOrigin (AnnTip blk)
forall blk. HeaderState blk -&gt; WithOrigin (AnnTip blk)
</span><a href="Ouroboros.Consensus.HeaderValidation.html#headerStateTip"><span class="hs-identifier hs-var">headerStateTip</span></a></span><span> </span><span class="annot"><span class="annottext">(HeaderState blk -&gt; WithOrigin (AnnTip blk))
-&gt; HeaderState blk -&gt; WithOrigin (AnnTip blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; HeaderState blk
forall blk. ExtLedgerState blk -&gt; HeaderState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#headerState"><span class="hs-identifier hs-var">headerState</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; HeaderState blk)
-&gt; ExtLedgerState blk -&gt; HeaderState blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679877414"><span class="hs-identifier hs-var">initSS</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; WithOrigin (RealPoint blk)
forall blk. Point blk -&gt; WithOrigin (RealPoint blk)
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#pointToWithOriginRealPoint"><span class="hs-identifier hs-var">pointToWithOriginRealPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (ExtLedgerState blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Point (ExtLedgerState blk)
forall l. GetTip l =&gt; l -&gt; Point l
</span><a href="Ouroboros.Consensus.Ledger.Basics.html#getTip"><span class="hs-identifier hs-var">getTip</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679877414"><span class="hs-identifier hs-var">initSS</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-181"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin (RealPoint blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SnapshotFailure blk
-&gt; ExceptT
     (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
forall a. SnapshotFailure blk -&gt; ExceptT (SnapshotFailure blk) m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">SnapshotFailure blk
forall blk. SnapshotFailure blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InitFailureGenesis"><span class="hs-identifier hs-var">InitFailureGenesis</span></a></span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621679877436"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679877436"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>        </span><span class="annot"><span class="annottext">m () -&gt; ExceptT (SnapshotFailure blk) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (SnapshotFailure blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ExceptT (SnapshotFailure blk) m ())
-&gt; m () -&gt; ExceptT (SnapshotFailure blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; (ReplayGoal blk -&gt; TraceReplayEvent blk) -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877407"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">((ReplayGoal blk -&gt; TraceReplayEvent blk) -&gt; m ())
-&gt; (ReplayGoal blk -&gt; TraceReplayEvent blk) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
-&gt; RealPoint blk
-&gt; ReplayStart blk
-&gt; ReplayGoal blk
-&gt; TraceReplayEvent blk
forall blk.
DiskSnapshot
-&gt; RealPoint blk
-&gt; ReplayStart blk
-&gt; ReplayGoal blk
-&gt; TraceReplayEvent blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayFromSnapshot"><span class="hs-identifier hs-var">ReplayFromSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">DiskSnapshot
</span><a href="#local-6989586621679877413"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679877436"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; ReplayStart blk
forall blk. Point blk -&gt; ReplayStart blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-var">ReplayStart</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679877428"><span class="hs-identifier hs-var">initialPoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679877439"><span class="annot"><span class="annottext">tracer' :: Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877439"><span class="hs-identifier hs-var hs-var">tracer'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Point blk
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer
     m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
forall blk (m :: * -&gt; *).
Point blk
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer
     m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithStart"><span class="hs-identifier hs-var">decorateReplayTracerWithStart</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679877428"><span class="hs-identifier hs-var">initialPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877407"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-185"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679877440"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877440"><span class="hs-identifier hs-var">initDB</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877441"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877441"><span class="hs-identifier hs-var">replayed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-186"></span><span>          </span><span class="annot"><span class="annottext">Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; LedgerDB' blk
-&gt; ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
forall (m :: * -&gt; *) blk.
(Monad m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasCallStack) =&gt;
Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; LedgerDB' blk
-&gt; ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initStartingWith"><span class="hs-identifier hs-var">initStartingWith</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877439"><span class="hs-identifier hs-var">tracer'</span></a></span><span>
</span><span id="line-188"></span><span>            </span><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877411"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-189"></span><span>            </span><span class="annot"><span class="annottext">StreamAPI m blk
</span><a href="#local-6989586621679877412"><span class="hs-identifier hs-var">streamAPI</span></a></span><span>
</span><span id="line-190"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerDB' blk
forall l. GetTip l =&gt; l -&gt; LedgerDB l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Update.html#ledgerDbWithAnchor"><span class="hs-identifier hs-var">ledgerDbWithAnchor</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk
</span><a href="#local-6989586621679877414"><span class="hs-identifier hs-var">initSS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>        </span><span class="annot"><span class="annottext">(RealPoint blk, LedgerDB' blk, Word64)
-&gt; ExceptT
     (SnapshotFailure blk) m (RealPoint blk, LedgerDB' blk, Word64)
forall a. a -&gt; ExceptT (SnapshotFailure blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679877436"><span class="hs-identifier hs-var">tip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877440"><span class="hs-identifier hs-var">initDB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877441"><span class="hs-identifier hs-var">replayed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="annot"><span class="hs-comment">-- | Attempt to initialize the ledger DB starting from the given ledger DB</span></span><span>
</span><span id="line-194"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initStartingWith"><span class="hs-identifier hs-type">initStartingWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-195"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679877051"><span class="annot"><a href="#local-6989586621679877051"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679877052"><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-196"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877051"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-197"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-198"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-199"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-200"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679877051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-type">ReplayStart</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-type">TraceReplayEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDbCfg"><span class="hs-identifier hs-type">LedgerDbCfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#StreamAPI"><span class="hs-identifier hs-type">StreamAPI</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#ExceptT"><span class="hs-identifier hs-type">ExceptT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#SnapshotFailure"><span class="hs-identifier hs-type">SnapshotFailure</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679877051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span id="initStartingWith"><span class="annot"><span class="annottext">initStartingWith :: forall (m :: * -&gt; *) blk.
(Monad m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasCallStack) =&gt;
Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; LedgerDbCfg (ExtLedgerState blk)
-&gt; StreamAPI m blk
-&gt; LedgerDB' blk
-&gt; ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#initStartingWith"><span class="hs-identifier hs-var hs-var">initStartingWith</span></a></span></span><span> </span><span id="local-6989586621679877473"><span class="annot"><span class="annottext">Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877473"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621679877474"><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877474"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679877475"><span class="annot"><span class="annottext">StreamAPI m blk
</span><a href="#local-6989586621679877475"><span class="hs-identifier hs-var">streamAPI</span></a></span></span><span> </span><span id="local-6989586621679877476"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877476"><span class="hs-identifier hs-var">initDb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">StreamAPI m blk
-&gt; Point blk
-&gt; (RealPoint blk -&gt; SnapshotFailure blk)
-&gt; (LedgerDB' blk, Word64)
-&gt; (blk -&gt; (LedgerDB' blk, Word64) -&gt; m (LedgerDB' blk, Word64))
-&gt; ExceptT (SnapshotFailure blk) m (LedgerDB' blk, Word64)
forall (m :: * -&gt; *) blk e a.
(Monad m, HasCallStack) =&gt;
StreamAPI m blk
-&gt; Point blk
-&gt; (RealPoint blk -&gt; e)
-&gt; a
-&gt; (blk -&gt; a -&gt; m a)
-&gt; ExceptT e m a
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Stream.html#streamAll"><span class="hs-identifier hs-var">streamAll</span></a></span><span> </span><span class="annot"><span class="annottext">StreamAPI m blk
</span><a href="#local-6989586621679877475"><span class="hs-identifier hs-var">streamAPI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (ExtLedgerState blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; Point (ExtLedgerState blk)
forall l. GetTip l =&gt; LedgerDB l -&gt; Point l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html#ledgerDbTip"><span class="hs-identifier hs-var">ledgerDbTip</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877476"><span class="hs-identifier hs-var">initDb</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><span class="annottext">RealPoint blk -&gt; SnapshotFailure blk
forall blk. RealPoint blk -&gt; SnapshotFailure blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#InitFailureTooRecent"><span class="hs-identifier hs-var">InitFailureTooRecent</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877476"><span class="hs-identifier hs-var">initDb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>      </span><span class="annot"><span class="annottext">blk -&gt; (LedgerDB' blk, Word64) -&gt; m (LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877480"><span class="hs-identifier hs-var">push</span></a></span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><a href="#local-6989586621679877480"><span class="hs-identifier hs-type">push</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679877051"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#LedgerDB%27"><span class="hs-identifier hs-type">LedgerDB'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621679877480"><span class="annot"><span class="annottext">push :: blk -&gt; (LedgerDB' blk, Word64) -&gt; m (LedgerDB' blk, Word64)
</span><a href="#local-6989586621679877480"><span class="hs-identifier hs-var hs-var">push</span></a></span></span><span> </span><span id="local-6989586621679877481"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679877481"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679877482"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877482"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679877483"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877483"><span class="hs-identifier hs-var">replayed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679877484"><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877484"><span class="hs-identifier hs-var">db'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
-&gt; Ap m (ExtLedgerState blk) blk (() :: Constraint)
-&gt; LedgerDB' blk
-&gt; m (LedgerDB' blk)
forall (m :: * -&gt; *) (c :: Constraint) l blk.
(ApplyBlock l blk, Monad m, c) =&gt;
LedgerDbCfg l -&gt; Ap m l blk c -&gt; LedgerDB l -&gt; m (LedgerDB l)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Update.html#ledgerDbPush"><span class="hs-identifier hs-var">ledgerDbPush</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877474"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; Ap m (ExtLedgerState blk) blk (() :: Constraint)
forall blk (m :: * -&gt; *) l. blk -&gt; Ap m l blk (() :: Constraint)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Update.html#ReapplyVal"><span class="hs-identifier hs-var">ReapplyVal</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679877481"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877482"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679877487"><span class="hs-identifier hs-type">replayed'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span>
</span><span id="line-217"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621679877487"><span class="annot"><span class="annottext">replayed' :: Word64
</span><a href="#local-6989586621679877487"><span class="hs-identifier hs-var hs-var">replayed'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877483"><span class="hs-identifier hs-var">replayed</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span>            </span><span class="annot"><a href="#local-6989586621679877489"><span class="hs-identifier hs-type">events</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#LedgerEvent"><span class="hs-identifier hs-type">LedgerEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877052"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-220"></span><span>            </span><span id="local-6989586621679877489"><span class="annot"><span class="annottext">events :: [LedgerEvent blk]
</span><a href="#local-6989586621679877489"><span class="hs-identifier hs-var hs-var">events</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
-&gt; LedgerState blk -&gt; LedgerState blk -&gt; [LedgerEvent blk]
forall blk.
InspectLedger blk =&gt;
TopLevelConfig blk
-&gt; LedgerState blk -&gt; LedgerState blk -&gt; [LedgerEvent blk]
</span><a href="Ouroboros.Consensus.Ledger.Inspect.html#inspectLedger"><span class="hs-identifier hs-var">inspectLedger</span></a></span><span>
</span><span id="line-221"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerCfg blk -&gt; TopLevelConfig blk
forall blk. ExtLedgerCfg blk -&gt; TopLevelConfig blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#getExtLedgerCfg"><span class="hs-identifier hs-var">getExtLedgerCfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk) -&gt; LedgerCfg (ExtLedgerState blk)
forall l. LedgerDbCfg l -&gt; LedgerCfg l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.LedgerDB.html#ledgerDbCfg"><span class="hs-identifier hs-var">ledgerDbCfg</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDbCfg (ExtLedgerState blk)
</span><a href="#local-6989586621679877474"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html#ledgerDbCurrent"><span class="hs-identifier hs-var">ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877482"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk -&gt; ExtLedgerState blk
forall l. GetTip l =&gt; LedgerDB l -&gt; l
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Query.html#ledgerDbCurrent"><span class="hs-identifier hs-var">ledgerDbCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877484"><span class="hs-identifier hs-var">db'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="annottext">Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer
  m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679877473"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk
-&gt; [LedgerEvent blk]
-&gt; ReplayStart blk
-&gt; ReplayGoal blk
-&gt; TraceReplayEvent blk
forall blk.
RealPoint blk
-&gt; [LedgerEvent blk]
-&gt; ReplayStart blk
-&gt; ReplayGoal blk
-&gt; TraceReplayEvent blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayedBlock"><span class="hs-identifier hs-var">ReplayedBlock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679877481"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LedgerEvent blk]
</span><a href="#local-6989586621679877489"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>        </span><span class="annot"><span class="annottext">(LedgerDB' blk, Word64) -&gt; m (LedgerDB' blk, Word64)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679877484"><span class="hs-identifier hs-var">db'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679877487"><span class="hs-identifier hs-var">replayed'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Trace events
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">-- | Add the tip of the Immutable DB to the trace event</span><span>
</span><span id="line-233"></span><span class="hs-comment">--</span><span>
</span><span id="line-234"></span><span class="hs-comment">-- Between the tip of the immutable DB and the point of the starting block,</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- the node could (if it so desired) easily compute a &quot;percentage complete&quot;.</span><span>
</span><span id="line-236"></span><span id="local-6989586621679877159"><span id="local-6989586621679877160"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithGoal"><span class="hs-identifier hs-type">decorateReplayTracerWithGoal</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-237"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679877159"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Tip of the ImmutableDB</span></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679877160"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-type">TraceReplayEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877159"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679877160"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877159"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-type">TraceReplayEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877159"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-240"></span><span id="decorateReplayTracerWithGoal"><span class="annot"><span class="annottext">decorateReplayTracerWithGoal :: forall blk (m :: * -&gt; *).
Point blk
-&gt; Tracer m (TraceReplayEvent blk)
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithGoal"><span class="hs-identifier hs-var hs-var">decorateReplayTracerWithGoal</span></a></span></span><span> </span><span id="local-6989586621679877499"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679877499"><span class="hs-identifier hs-var">immTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((ReplayGoal blk -&gt; TraceReplayEvent blk) -&gt; TraceReplayEvent blk)
-&gt; Tracer m (TraceReplayEvent blk)
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; ReplayGoal blk -&gt; TraceReplayEvent blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; ReplayGoal blk
forall blk. Point blk -&gt; ReplayGoal blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-var">ReplayGoal</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679877499"><span class="hs-identifier hs-var">immTip</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-comment">-- | Add the block at which a replay started.</span><span>
</span><span id="line-243"></span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- This allows to compute a &quot;percentage complete&quot; when tracing the events.</span><span>
</span><span id="line-245"></span><span id="local-6989586621679877036"><span id="local-6989586621679877037"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithStart"><span class="hs-identifier hs-type">decorateReplayTracerWithStart</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-246"></span><span>     </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679877036"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Starting point of the replay</span></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679877037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877036"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-type">TraceReplayEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877036"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679877037"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-type">ReplayStart</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877036"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877036"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-type">TraceReplayEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877036"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-249"></span><span id="decorateReplayTracerWithStart"><span class="annot"><span class="annottext">decorateReplayTracerWithStart :: forall blk (m :: * -&gt; *).
Point blk
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer
     m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithStart"><span class="hs-identifier hs-var hs-var">decorateReplayTracerWithStart</span></a></span></span><span> </span><span id="local-6989586621679877503"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679877503"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
 -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; Tracer
     m (ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; ReplayStart blk -&gt; ReplayGoal blk -&gt; TraceReplayEvent blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point blk -&gt; ReplayStart blk
forall blk. Point blk -&gt; ReplayStart blk
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-var">ReplayStart</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679877503"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span class="annot"><span class="hs-comment">-- | Which point the replay started from</span></span><span>
</span><span id="line-252"></span><span class="hs-keyword">newtype</span><span> </span><span id="ReplayStart"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-var">ReplayStart</span></a></span></span><span> </span><span id="local-6989586621679877131"><span class="annot"><a href="#local-6989586621679877131"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ReplayStart"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-var">ReplayStart</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679877131"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679877506"><span id="local-6989586621679877511"><span class="annot"><span class="annottext">ReplayStart blk -&gt; ReplayStart blk -&gt; Bool
(ReplayStart blk -&gt; ReplayStart blk -&gt; Bool)
-&gt; (ReplayStart blk -&gt; ReplayStart blk -&gt; Bool)
-&gt; Eq (ReplayStart blk)
forall blk.
StandardHash blk =&gt;
ReplayStart blk -&gt; ReplayStart blk -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall blk.
StandardHash blk =&gt;
ReplayStart blk -&gt; ReplayStart blk -&gt; Bool
== :: ReplayStart blk -&gt; ReplayStart blk -&gt; Bool
$c/= :: forall blk.
StandardHash blk =&gt;
ReplayStart blk -&gt; ReplayStart blk -&gt; Bool
/= :: ReplayStart blk -&gt; ReplayStart blk -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877517"><span id="local-6989586621679877522"><span id="local-6989586621679877526"><span class="annot"><span class="annottext">Int -&gt; ReplayStart blk -&gt; ShowS
[ReplayStart blk] -&gt; ShowS
ReplayStart blk -&gt; String
(Int -&gt; ReplayStart blk -&gt; ShowS)
-&gt; (ReplayStart blk -&gt; String)
-&gt; ([ReplayStart blk] -&gt; ShowS)
-&gt; Show (ReplayStart blk)
forall blk. StandardHash blk =&gt; Int -&gt; ReplayStart blk -&gt; ShowS
forall blk. StandardHash blk =&gt; [ReplayStart blk] -&gt; ShowS
forall blk. StandardHash blk =&gt; ReplayStart blk -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall blk. StandardHash blk =&gt; Int -&gt; ReplayStart blk -&gt; ShowS
showsPrec :: Int -&gt; ReplayStart blk -&gt; ShowS
$cshow :: forall blk. StandardHash blk =&gt; ReplayStart blk -&gt; String
show :: ReplayStart blk -&gt; String
$cshowList :: forall blk. StandardHash blk =&gt; [ReplayStart blk] -&gt; ShowS
showList :: [ReplayStart blk] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="annot"><span class="hs-comment">-- | Which point the replay is expected to end at</span></span><span>
</span><span id="line-255"></span><span class="hs-keyword">newtype</span><span> </span><span id="ReplayGoal"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-var">ReplayGoal</span></a></span></span><span> </span><span id="local-6989586621679877168"><span class="annot"><a href="#local-6989586621679877168"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ReplayGoal"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-var">ReplayGoal</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679877168"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679877530"><span id="local-6989586621679877534"><span class="annot"><span class="annottext">ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool
(ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool)
-&gt; (ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool)
-&gt; Eq (ReplayGoal blk)
forall blk.
StandardHash blk =&gt;
ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall blk.
StandardHash blk =&gt;
ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool
== :: ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool
$c/= :: forall blk.
StandardHash blk =&gt;
ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool
/= :: ReplayGoal blk -&gt; ReplayGoal blk -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877540"><span id="local-6989586621679877544"><span id="local-6989586621679877548"><span class="annot"><span class="annottext">Int -&gt; ReplayGoal blk -&gt; ShowS
[ReplayGoal blk] -&gt; ShowS
ReplayGoal blk -&gt; String
(Int -&gt; ReplayGoal blk -&gt; ShowS)
-&gt; (ReplayGoal blk -&gt; String)
-&gt; ([ReplayGoal blk] -&gt; ShowS)
-&gt; Show (ReplayGoal blk)
forall blk. StandardHash blk =&gt; Int -&gt; ReplayGoal blk -&gt; ShowS
forall blk. StandardHash blk =&gt; [ReplayGoal blk] -&gt; ShowS
forall blk. StandardHash blk =&gt; ReplayGoal blk -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall blk. StandardHash blk =&gt; Int -&gt; ReplayGoal blk -&gt; ShowS
showsPrec :: Int -&gt; ReplayGoal blk -&gt; ShowS
$cshow :: forall blk. StandardHash blk =&gt; ReplayGoal blk -&gt; String
show :: ReplayGoal blk -&gt; String
$cshowList :: forall blk. StandardHash blk =&gt; [ReplayGoal blk] -&gt; ShowS
showList :: [ReplayGoal blk] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-comment">-- | Events traced while replaying blocks against the ledger to bring it up to</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- date w.r.t. the tip of the ImmutableDB during initialisation. As this</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- process takes a while, we trace events to inform higher layers of our</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- progress.</span><span>
</span><span id="line-261"></span><span class="hs-keyword">data</span><span> </span><span id="TraceReplayEvent"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier hs-var">TraceReplayEvent</span></a></span></span><span> </span><span id="local-6989586621679877028"><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span></span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- | There were no LedgerDB snapshots on disk, so we're replaying all blocks</span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-comment">-- starting from Genesis against the initial ledger.</span><span>
</span><span id="line-264"></span><span>    </span><span id="ReplayFromGenesis"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayFromGenesis"><span class="hs-identifier hs-var">ReplayFromGenesis</span></a></span></span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ the block at the tip of the ImmutableDB</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-comment">-- | There was a LedgerDB snapshot on disk corresponding to the given tip.</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">-- We're replaying more recent blocks against it.</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ReplayFromSnapshot"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayFromSnapshot"><span class="hs-identifier hs-var">ReplayFromSnapshot</span></a></span></span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Snapshots.html#DiskSnapshot"><span class="hs-identifier hs-type">DiskSnapshot</span></a></span><span>
</span><span id="line-270"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-type">ReplayStart</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ the block at which this replay started</span></span><span>
</span><span id="line-272"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ the block at the tip of the ImmutableDB</span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-comment">-- | We replayed the given block (reference) on the genesis snapshot during</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-comment">-- the initialisation of the LedgerDB. Used during ImmutableDB replay.</span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ReplayedBlock"><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayedBlock"><span class="hs-identifier hs-var">ReplayedBlock</span></a></span></span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>   </span><span class="annot"><span class="hs-comment">-- ^ the block being replayed</span></span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-special">[</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#LedgerEvent"><span class="hs-identifier hs-type">LedgerEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayStart"><span class="hs-identifier hs-type">ReplayStart</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ the block at which this replay started</span></span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#ReplayGoal"><span class="hs-identifier hs-type">ReplayGoal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679877028"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>  </span><span class="annot"><span class="hs-comment">-- ^ the block at the tip of the ImmutableDB</span></span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679877551"><span id="local-6989586621679877553"><span class="annot"><span class="annottext">(forall x. TraceReplayEvent blk -&gt; Rep (TraceReplayEvent blk) x)
-&gt; (forall x. Rep (TraceReplayEvent blk) x -&gt; TraceReplayEvent blk)
-&gt; Generic (TraceReplayEvent blk)
forall x. Rep (TraceReplayEvent blk) x -&gt; TraceReplayEvent blk
forall x. TraceReplayEvent blk -&gt; Rep (TraceReplayEvent blk) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall blk x. Rep (TraceReplayEvent blk) x -&gt; TraceReplayEvent blk
forall blk x. TraceReplayEvent blk -&gt; Rep (TraceReplayEvent blk) x
$cfrom :: forall blk x. TraceReplayEvent blk -&gt; Rep (TraceReplayEvent blk) x
from :: forall x. TraceReplayEvent blk -&gt; Rep (TraceReplayEvent blk) x
$cto :: forall blk x. Rep (TraceReplayEvent blk) x -&gt; TraceReplayEvent blk
to :: forall x. Rep (TraceReplayEvent blk) x -&gt; TraceReplayEvent blk
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Generics.html#Generic"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877558"><span id="local-6989586621679877571"><span class="annot"><span class="annottext">TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool
(TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool)
-&gt; (TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool)
-&gt; Eq (TraceReplayEvent blk)
forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool
== :: TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool
$c/= :: forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool
/= :: TraceReplayEvent blk -&gt; TraceReplayEvent blk -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679877578"><span id="local-6989586621679877594"><span id="local-6989586621679877598"><span class="annot"><span class="annottext">Int -&gt; TraceReplayEvent blk -&gt; ShowS
[TraceReplayEvent blk] -&gt; ShowS
TraceReplayEvent blk -&gt; String
(Int -&gt; TraceReplayEvent blk -&gt; ShowS)
-&gt; (TraceReplayEvent blk -&gt; String)
-&gt; ([TraceReplayEvent blk] -&gt; ShowS)
-&gt; Show (TraceReplayEvent blk)
forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
Int -&gt; TraceReplayEvent blk -&gt; ShowS
forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
[TraceReplayEvent blk] -&gt; ShowS
forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
TraceReplayEvent blk -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
Int -&gt; TraceReplayEvent blk -&gt; ShowS
showsPrec :: Int -&gt; TraceReplayEvent blk -&gt; ShowS
$cshow :: forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
TraceReplayEvent blk -&gt; String
show :: TraceReplayEvent blk -&gt; String
$cshowList :: forall blk.
(StandardHash blk, InspectLedger blk) =&gt;
[TraceReplayEvent blk] -&gt; ShowS
showList :: [TraceReplayEvent blk] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span></pre></body></html>
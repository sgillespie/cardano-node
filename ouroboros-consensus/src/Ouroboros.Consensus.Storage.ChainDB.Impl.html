<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DisambiguateRecordFields #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts         #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase               #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE PatternSynonyms          #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards          #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables      #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Initialization</span></span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#ChainDbArgs"><span class="hs-identifier">ChainDbArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SerialiseDiskConstraints"><span class="hs-identifier">SerialiseDiskConstraints</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#defaultArgs"><span class="hs-identifier">defaultArgs</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDB"><span class="hs-identifier">openDB</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#withDB"><span class="hs-identifier">withDB</span></a></span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Trace types</span></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#TraceReplayEvent"><span class="hs-identifier">LgrDB.TraceReplayEvent</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SelectionChangedInfo"><span class="hs-identifier">SelectionChangedInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceAddBlockEvent"><span class="hs-identifier">TraceAddBlockEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceCopyToImmutableDBEvent"><span class="hs-identifier">TraceCopyToImmutableDBEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceEvent"><span class="hs-identifier">TraceEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceFollowerEvent"><span class="hs-identifier">TraceFollowerEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceGCEvent"><span class="hs-identifier">TraceGCEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceInitChainSelEvent"><span class="hs-identifier">TraceInitChainSelEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceIteratorEvent"><span class="hs-identifier">TraceIteratorEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier">TraceOpenEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TracePipeliningEvent"><span class="hs-identifier">TracePipeliningEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceValidationEvent"><span class="hs-identifier">TraceValidationEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-exported for convenience</span></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#RelativeMountPoint"><span class="hs-identifier">Args.RelativeMountPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbSerialiseConstraints"><span class="hs-identifier">ImmutableDB.ImmutableDbSerialiseConstraints</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#LgrDbSerialiseConstraints"><span class="hs-identifier">LgrDB.LgrDbSerialiseConstraints</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#VolatileDbSerialiseConstraints"><span class="hs-identifier">VolatileDB.VolatileDbSerialiseConstraints</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Internals for testing purposes</span></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#Internal"><span class="hs-identifier">Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDBInternal"><span class="hs-identifier">openDBInternal</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html"><span class="hs-identifier">Control.Monad.Trans.Class</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%26%3E"><span class="hs-operator">(&lt;&amp;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html"><span class="hs-identifier">Data.Functor.Identity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier">Identity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Maybe.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StrictMaybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Fragment.Validated.html"><span class="hs-identifier">Ouroboros.Consensus.Fragment.Validated</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VF</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Abstract</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Inspect</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.SupportsProtocol</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier">ChainDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">API</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#ChainDbArgs"><span class="hs-identifier">ChainDbArgs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#defaultArgs"><span class="hs-identifier">defaultArgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Args</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Args</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Background</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Background</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainSel</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Follower.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Follower</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Follower</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Iterator</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LgrDB</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Query</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Query</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.Impl.Types</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ImmutableDB</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.VolatileDB.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.VolatileDB</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VolatileDB</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier">whenJust</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier">WithTempRegistry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocate"><span class="hs-identifier">allocate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#runInnerWithTempRegistry"><span class="hs-identifier">runInnerWithTempRegistry</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier">runWithTempRegistry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html"><span class="hs-identifier">Ouroboros.Consensus.Util.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#Fingerprint"><span class="hs-identifier">Fingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>                     </span><span class="annot"><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier">WithFingerprint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.TentativeState.html"><span class="hs-identifier">Ouroboros.Consensus.Util.TentativeState</span></a></span><span>
</span><span id="line-72"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.TentativeState.html#TentativeState"><span class="hs-identifier">TentativeState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.TentativeState.html#NoLastInvalidTentative"><span class="hs-identifier">NoLastInvalidTentative</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Initialization
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#withDB"><span class="hs-identifier hs-type">withDB</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-80"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679904381"><span class="annot"><a href="#local-6989586621679904381"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679904383"><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679904392"><span class="annot"><a href="#local-6989586621679904392"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-81"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904381"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-82"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-83"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-84"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-85"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-86"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SerialiseDiskConstraints"><span class="hs-identifier hs-type">SerialiseDiskConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-87"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#ChainDbArgs"><span class="hs-identifier hs-type">ChainDbArgs</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">ChainDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904383"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679904381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904392"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679904381"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904392"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-91"></span><span id="withDB"><span class="annot"><span class="annottext">withDB :: forall (m :: * -&gt; *) blk a.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, ConvertRawHash blk,
 SerialiseDiskConstraints blk) =&gt;
ChainDbArgs Identity m blk -&gt; (ChainDB m blk -&gt; m a) -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#withDB"><span class="hs-identifier hs-var hs-var">withDB</span></a></span></span><span> </span><span id="local-6989586621679904921"><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679904921"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (ChainDB m blk)
-&gt; (ChainDB m blk -&gt; m ()) -&gt; (ChainDB m blk -&gt; m a) -&gt; m a
forall a b c. m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
forall (m :: * -&gt; *) a b c.
MonadThrow m =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainDB m blk, Internal m blk) -&gt; ChainDB m blk
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((ChainDB m blk, Internal m blk) -&gt; ChainDB m blk)
-&gt; m (ChainDB m blk, Internal m blk) -&gt; m (ChainDB m blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
-&gt; Bool -&gt; m (ChainDB m blk, Internal m blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, ConvertRawHash blk,
 SerialiseDiskConstraints blk) =&gt;
ChainDbArgs Identity m blk
-&gt; Bool -&gt; m (ChainDB m blk, Internal m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDBInternal"><span class="hs-identifier hs-var">openDBInternal</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679904921"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; m ()
forall (m :: * -&gt; *) blk. ChainDB m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#closeDB"><span class="hs-identifier hs-var">API.closeDB</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDB"><span class="hs-identifier hs-type">openDB</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-94"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679904416"><span class="annot"><a href="#local-6989586621679904416"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679904417"><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-95"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904416"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-96"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-97"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-98"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-99"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-100"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SerialiseDiskConstraints"><span class="hs-identifier hs-type">SerialiseDiskConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-101"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#ChainDbArgs"><span class="hs-identifier hs-type">ChainDbArgs</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904416"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679904416"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">ChainDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904416"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904417"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span id="openDB"><span class="annot"><span class="annottext">openDB :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, ConvertRawHash blk,
 SerialiseDiskConstraints blk) =&gt;
ChainDbArgs Identity m blk -&gt; m (ChainDB m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDB"><span class="hs-identifier hs-var hs-var">openDB</span></a></span></span><span> </span><span id="local-6989586621679904943"><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679904943"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChainDB m blk, Internal m blk) -&gt; ChainDB m blk
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((ChainDB m blk, Internal m blk) -&gt; ChainDB m blk)
-&gt; m (ChainDB m blk, Internal m blk) -&gt; m (ChainDB m blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
-&gt; Bool -&gt; m (ChainDB m blk, Internal m blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, ConvertRawHash blk,
 SerialiseDiskConstraints blk) =&gt;
ChainDbArgs Identity m blk
-&gt; Bool -&gt; m (ChainDB m blk, Internal m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDBInternal"><span class="hs-identifier hs-var">openDBInternal</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679904943"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDBInternal"><span class="hs-identifier hs-type">openDBInternal</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-107"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679904412"><span class="annot"><a href="#local-6989586621679904412"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679904413"><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-108"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904412"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-109"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.SupportsProtocol.html#LedgerSupportsProtocol"><span class="hs-identifier hs-type">LedgerSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-110"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Inspect.html#InspectLedger"><span class="hs-identifier hs-type">InspectLedger</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-111"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-112"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-113"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#SerialiseDiskConstraints"><span class="hs-identifier hs-type">SerialiseDiskConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-114"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#ChainDbArgs"><span class="hs-identifier hs-type">ChainDbArgs</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ 'True' = Launch background tasks</span></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679904412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">ChainDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#Internal"><span class="hs-identifier hs-type">Internal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904412"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904413"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span id="openDBInternal"><span class="annot"><span class="annottext">openDBInternal :: forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, ConvertRawHash blk,
 SerialiseDiskConstraints blk) =&gt;
ChainDbArgs Identity m blk
-&gt; Bool -&gt; m (ChainDB m blk, Internal m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#openDBInternal"><span class="hs-identifier hs-var hs-var">openDBInternal</span></a></span></span><span> </span><span id="local-6989586621679905322"><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621679905323"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679905323"><span class="hs-identifier hs-var">launchBgTasks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry
  (ChainDbEnv m blk)
  m
  ((ChainDB m blk, Internal m blk), ChainDbEnv m blk)
-&gt; m (ChainDB m blk, Internal m blk)
forall (m :: * -&gt; *) st a.
(IOLike m, HasCallStack) =&gt;
WithTempRegistry st m (a, st) -&gt; m a
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#runWithTempRegistry"><span class="hs-identifier hs-var">runWithTempRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry
   (ChainDbEnv m blk)
   m
   ((ChainDB m blk, Internal m blk), ChainDbEnv m blk)
 -&gt; m (ChainDB m blk, Internal m blk))
-&gt; WithTempRegistry
     (ChainDbEnv m blk)
     m
     ((ChainDB m blk, Internal m blk), ChainDbEnv m blk)
-&gt; m (ChainDB m blk, Internal m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ())
-&gt; m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk
forall blk. TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#StartedOpeningDB"><span class="hs-identifier hs-var">StartedOpeningDB</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ())
-&gt; m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk
forall blk. TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#StartedOpeningImmutableDB"><span class="hs-identifier hs-var">StartedOpeningImmutableDB</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621679905329"><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679905329"><span class="hs-identifier hs-var">immutableDB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImmutableDbArgs Identity m blk
-&gt; (forall {st}.
    WithTempRegistry st m (ImmutableDB m blk, st)
    -&gt; WithTempRegistry (ChainDbEnv m blk) m (ImmutableDB m blk))
-&gt; WithTempRegistry (ChainDbEnv m blk) m (ImmutableDB m blk)
forall (m :: * -&gt; *) blk ans.
(IOLike m, GetPrevHash blk, ConvertRawHash blk,
 ImmutableDbSerialiseConstraints blk, HasCallStack) =&gt;
ImmutableDbArgs Identity m blk
-&gt; (forall st.
    WithTempRegistry st m (ImmutableDB m blk, st) -&gt; ans)
-&gt; ans
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDB"><span class="hs-identifier hs-var">ImmutableDB.openDB</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDbArgs Identity m blk
</span><a href="#local-6989586621679905331"><span class="hs-identifier hs-var">argsImmutableDb</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {st}.
  WithTempRegistry st m (ImmutableDB m blk, st)
  -&gt; WithTempRegistry (ChainDbEnv m blk) m (ImmutableDB m blk))
 -&gt; WithTempRegistry (ChainDbEnv m blk) m (ImmutableDB m blk))
-&gt; (forall {st}.
    WithTempRegistry st m (ImmutableDB m blk, st)
    -&gt; WithTempRegistry (ChainDbEnv m blk) m (ImmutableDB m blk))
-&gt; WithTempRegistry (ChainDbEnv m blk) m (ImmutableDB m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(ImmutableDB m blk -&gt; m ())
-&gt; WithTempRegistry st m (ImmutableDB m blk, st)
-&gt; WithTempRegistry (ChainDbEnv m blk) m (ImmutableDB m blk)
forall (m :: * -&gt; *) innerDB st blk.
IOLike m =&gt;
(innerDB -&gt; m ())
-&gt; WithTempRegistry st m (innerDB, st)
-&gt; WithTempRegistry (ChainDbEnv m blk) m innerDB
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#innerOpenCont"><span class="hs-identifier hs-var">innerOpenCont</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; m ()
forall (m :: * -&gt; *) blk. HasCallStack =&gt; ImmutableDB m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#closeDB"><span class="hs-identifier hs-var">ImmutableDB.closeDB</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621679905337"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679905337"><span class="hs-identifier hs-var">immutableDbTipPoint</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Point blk) -&gt; WithTempRegistry (ChainDbEnv m blk) m (Point blk)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Point blk)
 -&gt; WithTempRegistry (ChainDbEnv m blk) m (Point blk))
-&gt; m (Point blk)
-&gt; WithTempRegistry (ChainDbEnv m blk) m (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (Point blk) -&gt; m (Point blk)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Point blk) -&gt; m (Point blk))
-&gt; STM m (Point blk) -&gt; m (Point blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; STM m (Point blk)
forall (m :: * -&gt; *) blk.
(MonadSTM m, HasCallStack) =&gt;
ImmutableDB m blk -&gt; STM m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getTipPoint"><span class="hs-identifier hs-var">ImmutableDB.getTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679905329"><span class="hs-identifier hs-var">immutableDB</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679905340"><span class="annot"><span class="annottext">immutableDbTipChunk :: ChunkNo
</span><a href="#local-6989586621679905340"><span class="hs-identifier hs-var hs-var">immutableDbTipChunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>          </span><span class="annot"><span class="annottext">ChunkInfo -&gt; Point blk -&gt; ChunkNo
forall blk. ChunkInfo -&gt; Point blk -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#chunkIndexOfPoint"><span class="hs-identifier hs-var">chunkIndexOfPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity ChunkInfo
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbChunkInfo"><span class="hs-identifier hs-var">Args.cdbChunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679905337"><span class="hs-identifier hs-var">immutableDbTipPoint</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ())
-&gt; m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-126"></span><span>      </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceOpenEvent blk -&gt; TraceEvent blk)
-&gt; TraceOpenEvent blk -&gt; TraceEvent blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><span class="annottext">Point blk -&gt; ChunkNo -&gt; TraceOpenEvent blk
forall blk. Point blk -&gt; ChunkNo -&gt; TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#OpenedImmutableDB"><span class="hs-identifier hs-var">OpenedImmutableDB</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679905337"><span class="hs-identifier hs-var">immutableDbTipPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679905340"><span class="hs-identifier hs-var">immutableDbTipChunk</span></a></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ())
-&gt; m () -&gt; WithTempRegistry (ChainDbEnv m blk) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk
forall blk. TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#StartedOpeningVolatileDB"><span class="hs-identifier hs-var">StartedOpeningVolatileDB</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span id="local-6989586621679905345"><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679905345"><span class="hs-identifier hs-var">volatileDB</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VolatileDbArgs Identity m blk
-&gt; (forall {st}.
    WithTempRegistry st m (VolatileDB m blk, st)
    -&gt; WithTempRegistry (ChainDbEnv m blk) m (VolatileDB m blk))
-&gt; WithTempRegistry (ChainDbEnv m blk) m (VolatileDB m blk)
forall (m :: * -&gt; *) blk ans.
(HasCallStack, IOLike m, GetPrevHash blk,
 VolatileDbSerialiseConstraints blk) =&gt;
VolatileDbArgs Identity m blk
-&gt; (forall st. WithTempRegistry st m (VolatileDB m blk, st) -&gt; ans)
-&gt; ans
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.Impl.html#openDB"><span class="hs-identifier hs-var">VolatileDB.openDB</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDbArgs Identity m blk
</span><a href="#local-6989586621679905347"><span class="hs-identifier hs-var">argsVolatileDb</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {st}.
  WithTempRegistry st m (VolatileDB m blk, st)
  -&gt; WithTempRegistry (ChainDbEnv m blk) m (VolatileDB m blk))
 -&gt; WithTempRegistry (ChainDbEnv m blk) m (VolatileDB m blk))
-&gt; (forall {st}.
    WithTempRegistry st m (VolatileDB m blk, st)
    -&gt; WithTempRegistry (ChainDbEnv m blk) m (VolatileDB m blk))
-&gt; WithTempRegistry (ChainDbEnv m blk) m (VolatileDB m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(VolatileDB m blk -&gt; m ())
-&gt; WithTempRegistry st m (VolatileDB m blk, st)
-&gt; WithTempRegistry (ChainDbEnv m blk) m (VolatileDB m blk)
forall (m :: * -&gt; *) innerDB st blk.
IOLike m =&gt;
(innerDB -&gt; m ())
-&gt; WithTempRegistry st m (innerDB, st)
-&gt; WithTempRegistry (ChainDbEnv m blk) m innerDB
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#innerOpenCont"><span class="hs-identifier hs-var">innerOpenCont</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk -&gt; m ()
VolatileDB m blk -&gt; HasCallStack =&gt; m ()
forall (m :: * -&gt; *) blk. VolatileDB m blk -&gt; HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#closeDB"><span class="hs-identifier hs-var">VolatileDB.closeDB</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679905352"><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679905352"><span class="hs-identifier hs-var">chainDB</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679905353"><span class="annot"><span class="annottext">Internal m blk
</span><a href="#local-6989586621679905353"><span class="hs-identifier hs-var">testing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679905354"><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679905354"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ChainDB m blk, Internal m blk, ChainDbEnv m blk)
-&gt; WithTempRegistry
     (ChainDbEnv m blk)
     m
     (ChainDB m blk, Internal m blk, ChainDbEnv m blk)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ChainDB m blk, Internal m blk, ChainDbEnv m blk)
 -&gt; WithTempRegistry
      (ChainDbEnv m blk)
      m
      (ChainDB m blk, Internal m blk, ChainDbEnv m blk))
-&gt; m (ChainDB m blk, Internal m blk, ChainDbEnv m blk)
-&gt; WithTempRegistry
     (ChainDbEnv m blk)
     m
     (ChainDB m blk, Internal m blk, ChainDbEnv m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk
forall blk. TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#OpenedVolatileDB"><span class="hs-identifier hs-var">OpenedVolatileDB</span></a></span><span>
</span><span id="line-133"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679905358"><span class="annot"><span class="annottext">lgrReplayTracer :: Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679905358"><span class="hs-identifier hs-var hs-var">lgrReplayTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-134"></span><span>            </span><span class="annot"><span class="annottext">Point blk
-&gt; Tracer m (TraceReplayEvent blk)
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
forall blk (m :: * -&gt; *).
Point blk
-&gt; Tracer m (TraceReplayEvent blk)
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="Ouroboros.Consensus.Storage.LedgerDB.Init.html#decorateReplayTracerWithGoal"><span class="hs-identifier hs-var">LgrDB.decorateReplayTracerWithGoal</span></a></span><span>
</span><span id="line-135"></span><span>              </span><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679905337"><span class="hs-identifier hs-var">immutableDbTipPoint</span></a></span><span>
</span><span id="line-136"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceReplayEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk) -&gt; Tracer m (TraceReplayEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceReplayEvent blk -&gt; TraceEvent blk
forall blk. TraceReplayEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceLedgerReplayEvent"><span class="hs-identifier hs-var">TraceLedgerReplayEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk
forall blk. TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#StartedOpeningLgrDB"><span class="hs-identifier hs-var">StartedOpeningLgrDB</span></a></span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679905363"><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679905363"><span class="hs-identifier hs-var">lgrDB</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679905364"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679905364"><span class="hs-identifier hs-var">replayed</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LgrDbArgs Identity m blk
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; ImmutableDB m blk
-&gt; (RealPoint blk -&gt; m blk)
-&gt; m (LgrDB m blk, Word64)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk,
 LgrDbSerialiseConstraints blk, InspectLedger blk, HasCallStack) =&gt;
LgrDbArgs Identity m blk
-&gt; Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
-&gt; ImmutableDB m blk
-&gt; (RealPoint blk -&gt; m blk)
-&gt; m (LgrDB m blk, Word64)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#openDB"><span class="hs-identifier hs-var">LgrDB.openDB</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDbArgs Identity m blk
</span><a href="#local-6989586621679905366"><span class="hs-identifier hs-var">argsLgrDb</span></a></span><span>
</span><span id="line-139"></span><span>                            </span><span class="annot"><span class="annottext">Tracer m (ReplayGoal blk -&gt; TraceReplayEvent blk)
</span><a href="#local-6989586621679905358"><span class="hs-identifier hs-var">lgrReplayTracer</span></a></span><span>
</span><span id="line-140"></span><span>                            </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679905329"><span class="hs-identifier hs-var">immutableDB</span></a></span><span>
</span><span id="line-141"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; VolatileDB m blk -&gt; RealPoint blk -&gt; m blk
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
ImmutableDB m blk -&gt; VolatileDB m blk -&gt; RealPoint blk -&gt; m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getAnyKnownBlock"><span class="hs-identifier hs-var">Query.getAnyKnownBlock</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679905329"><span class="hs-identifier hs-var">immutableDB</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679905345"><span class="hs-identifier hs-var">volatileDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk
forall blk. TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#OpenedLgrDB"><span class="hs-identifier hs-var">OpenedLgrDB</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>      </span><span id="local-6989586621679905369"><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
</span><a href="#local-6989586621679905369"><span class="hs-identifier hs-var">varInvalid</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
-&gt; m (StrictTVar
        m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
-&gt; Fingerprint
-&gt; WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk))
forall a. a -&gt; Fingerprint -&gt; WithFingerprint a
</span><a href="Ouroboros.Consensus.Util.STM.html#WithFingerprint"><span class="hs-identifier hs-var">WithFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (InvalidBlockInfo blk)
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Fingerprint
</span><a href="Ouroboros.Consensus.Util.STM.html#Fingerprint"><span class="hs-identifier hs-var">Fingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>      </span><span id="local-6989586621679905374"><span class="annot"><span class="annottext">StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
</span><a href="#local-6989586621679905374"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
-&gt; m (StrictTVar
        m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m)
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679905376"><span class="annot"><span class="annottext">initChainSelTracer :: Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621679905376"><span class="hs-identifier hs-var hs-var">initChainSelTracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TraceInitChainSelEvent blk -&gt; TraceEvent blk)
-&gt; Tracer m (TraceEvent blk)
-&gt; Tracer m (TraceInitChainSelEvent blk)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="annot"><span class="annottext">TraceInitChainSelEvent blk -&gt; TraceEvent blk
forall blk. TraceInitChainSelEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceInitChainSelEvent"><span class="hs-identifier hs-var">TraceInitChainSelEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
-&gt; TraceInitChainSelEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621679905376"><span class="hs-identifier hs-var">initChainSelTracer</span></a></span><span> </span><span class="annot"><span class="annottext">TraceInitChainSelEvent blk
forall blk. TraceInitChainSelEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#StartedInitChainSelection"><span class="hs-identifier hs-var">StartedInitChainSelection</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span id="local-6989586621679905379"><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679905379"><span class="hs-identifier hs-var">chainAndLedger</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
-&gt; VolatileDB m blk
-&gt; LgrDB m blk
-&gt; Tracer m (TraceInitChainSelEvent blk)
-&gt; TopLevelConfig blk
-&gt; StrictTVar
     m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
-&gt; StrictTVar
     m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
-&gt; CheckInFuture m blk
-&gt; m (ChainAndLedger blk)
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk) =&gt;
ImmutableDB m blk
-&gt; VolatileDB m blk
-&gt; LgrDB m blk
-&gt; Tracer m (TraceInitChainSelEvent blk)
-&gt; TopLevelConfig blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
-&gt; StrictTVar m (FutureBlocks m blk)
-&gt; CheckInFuture m blk
-&gt; m (ChainAndLedger blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#initialChainSelection"><span class="hs-identifier hs-var">ChainSel.initialChainSelection</span></a></span><span>
</span><span id="line-151"></span><span>                          </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679905329"><span class="hs-identifier hs-var">immutableDB</span></a></span><span>
</span><span id="line-152"></span><span>                          </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679905345"><span class="hs-identifier hs-var">volatileDB</span></a></span><span>
</span><span id="line-153"></span><span>                          </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679905363"><span class="hs-identifier hs-var">lgrDB</span></a></span><span>
</span><span id="line-154"></span><span>                          </span><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621679905376"><span class="hs-identifier hs-var">initChainSelTracer</span></a></span><span>
</span><span id="line-155"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity (TopLevelConfig blk)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f (TopLevelConfig blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbTopLevelConfig"><span class="hs-identifier hs-var">Args.cdbTopLevelConfig</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>                          </span><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
</span><a href="#local-6989586621679905369"><span class="hs-identifier hs-var">varInvalid</span></a></span><span>
</span><span id="line-157"></span><span>                          </span><span class="annot"><span class="annottext">StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
</span><a href="#local-6989586621679905374"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span>
</span><span id="line-158"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity (CheckInFuture m blk)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f (CheckInFuture m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbCheckInFuture"><span class="hs-identifier hs-var">Args.cdbCheckInFuture</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
-&gt; TraceInitChainSelEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceInitChainSelEvent blk)
</span><a href="#local-6989586621679905376"><span class="hs-identifier hs-var">initChainSelTracer</span></a></span><span> </span><span class="annot"><span class="annottext">TraceInitChainSelEvent blk
forall blk. TraceInitChainSelEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#InitalChainSelected"><span class="hs-identifier hs-var">InitalChainSelected</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679905384"><span class="annot"><span class="annottext">chain :: AnchoredFragment (Header blk)
</span><a href="#local-6989586621679905384"><span class="hs-identifier hs-var hs-var">chain</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; AnchoredFragment (Header blk)
forall b l. ValidatedFragment b l -&gt; AnchoredFragment b
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedFragment"><span class="hs-identifier hs-var">VF.validatedFragment</span></a></span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679905379"><span class="hs-identifier hs-var">chainAndLedger</span></a></span><span>
</span><span id="line-162"></span><span>          </span><span id="local-6989586621679905386"><span class="annot"><span class="annottext">ledger :: LedgerDB' blk
</span><a href="#local-6989586621679905386"><span class="hs-identifier hs-var hs-var">ledger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainAndLedger blk -&gt; LedgerDB' blk
forall b l. ValidatedFragment b l -&gt; l
</span><a href="Ouroboros.Consensus.Fragment.Validated.html#validatedLedger"><span class="hs-identifier hs-var">VF.validatedLedger</span></a></span><span>   </span><span class="annot"><span class="annottext">ChainAndLedger blk
</span><a href="#local-6989586621679905379"><span class="hs-identifier hs-var">chainAndLedger</span></a></span><span>
</span><span id="line-163"></span><span>          </span><span id="local-6989586621679905388"><span class="annot"><span class="annottext">cfg :: HKD Identity (TopLevelConfig blk)
</span><a href="#local-6989586621679905388"><span class="hs-identifier hs-var hs-var">cfg</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity (TopLevelConfig blk)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f (TopLevelConfig blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbTopLevelConfig"><span class="hs-identifier hs-var">Args.cdbTopLevelConfig</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span>      </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk -&gt; LedgerDB' blk -&gt; STM m ()
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
LgrDB m blk -&gt; LedgerDB' blk -&gt; STM m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.LgrDB.html#setCurrent"><span class="hs-identifier hs-var">LgrDB.setCurrent</span></a></span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679905363"><span class="hs-identifier hs-var">lgrDB</span></a></span><span> </span><span class="annot"><span class="annottext">LedgerDB' blk
</span><a href="#local-6989586621679905386"><span class="hs-identifier hs-var">ledger</span></a></span><span>
</span><span id="line-166"></span><span>      </span><span id="local-6989586621679905390"><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679905390"><span class="hs-identifier hs-var">varChain</span></a></span></span><span>           </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
-&gt; m (StrictTVar m (AnchoredFragment (Header blk)))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679905384"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-167"></span><span>      </span><span id="local-6989586621679905391"><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk)
</span><a href="#local-6989586621679905391"><span class="hs-identifier hs-var">varTentativeState</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TentativeState blk -&gt; m (StrictTVar m (TentativeState blk))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">TentativeState blk
forall blk. TentativeState blk
</span><a href="Ouroboros.Consensus.Util.TentativeState.html#NoLastInvalidTentative"><span class="hs-identifier hs-var">NoLastInvalidTentative</span></a></span><span>
</span><span id="line-168"></span><span>      </span><span id="local-6989586621679905392"><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679905392"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
-&gt; m (StrictTVar m (StrictMaybe (Header blk)))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">StrictMaybe (Header blk)
forall a. StrictMaybe a
</span><span class="hs-identifier hs-var">SNothing</span></span><span>
</span><span id="line-169"></span><span>      </span><span id="local-6989586621679905394"><span class="annot"><span class="annottext">StrictTVar m (Map IteratorKey (m ()))
</span><a href="#local-6989586621679905394"><span class="hs-identifier hs-var">varIterators</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map IteratorKey (m ()) -&gt; m (StrictTVar m (Map IteratorKey (m ())))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">Map IteratorKey (m ())
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-170"></span><span>      </span><span id="local-6989586621679905395"><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
</span><a href="#local-6989586621679905395"><span class="hs-identifier hs-var">varFollowers</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map FollowerKey (FollowerHandle m blk)
-&gt; m (StrictTVar m (Map FollowerKey (FollowerHandle m blk)))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">Map FollowerKey (FollowerHandle m blk)
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-171"></span><span>      </span><span id="local-6989586621679905396"><span class="annot"><span class="annottext">StrictTVar m IteratorKey
</span><a href="#local-6989586621679905396"><span class="hs-identifier hs-var">varNextIteratorKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IteratorKey -&gt; m (StrictTVar m IteratorKey)
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; IteratorKey
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#IteratorKey"><span class="hs-identifier hs-var">IteratorKey</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>      </span><span id="local-6989586621679905398"><span class="annot"><span class="annottext">StrictTVar m FollowerKey
</span><a href="#local-6989586621679905398"><span class="hs-identifier hs-var">varNextFollowerKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FollowerKey -&gt; m (StrictTVar m FollowerKey)
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; FollowerKey
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#FollowerKey"><span class="hs-identifier hs-var">FollowerKey</span></a></span><span>   </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>      </span><span id="local-6989586621679905400"><span class="annot"><span class="annottext">StrictMVar m ()
</span><a href="#local-6989586621679905400"><span class="hs-identifier hs-var">varCopyLock</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">() -&gt; m (StrictMVar m ())
forall (m :: * -&gt; *) a.
(HasCallStack, MonadMVar m, NoThunks a) =&gt;
a -&gt; m (StrictMVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictMVar.html#newMVar"><span class="hs-identifier hs-var">newMVar</span></a></span><span>  </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>      </span><span id="local-6989586621679905402"><span class="annot"><span class="annottext">StrictTVar m (m ())
</span><a href="#local-6989586621679905402"><span class="hs-identifier hs-var">varKillBgThreads</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (StrictTVar m (m ()))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m (StrictTVar m (m ())))
-&gt; m () -&gt; m (StrictTVar m (m ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>      </span><span id="local-6989586621679905403"><span class="annot"><span class="annottext">BlocksToAdd m blk
</span><a href="#local-6989586621679905403"><span class="hs-identifier hs-var">blocksToAdd</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; m (BlocksToAdd m blk)
forall (m :: * -&gt; *) blk. IOLike m =&gt; Word -&gt; m (BlocksToAdd m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#newBlocksToAdd"><span class="hs-identifier hs-var">newBlocksToAdd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; Word
forall (f :: * -&gt; *) (m :: * -&gt; *) blk. ChainDbArgs f m blk -&gt; Word
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbBlocksToAddSize"><span class="hs-identifier hs-var">Args.cdbBlocksToAddSize</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679905406"><span class="annot"><span class="annottext">env :: ChainDbEnv m blk
</span><a href="#local-6989586621679905406"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cdbImmutableDB :: ImmutableDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbImmutableDB"><span class="hs-identifier hs-var">cdbImmutableDB</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679905329"><span class="hs-identifier hs-var">immutableDB</span></a></span><span>
</span><span id="line-178"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbVolatileDB :: VolatileDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbVolatileDB"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679905345"><span class="hs-identifier hs-var">volatileDB</span></a></span><span>
</span><span id="line-179"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbLgrDB :: LgrDB m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbLgrDB"><span class="hs-identifier hs-var">cdbLgrDB</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LgrDB m blk
</span><a href="#local-6989586621679905363"><span class="hs-identifier hs-var">lgrDB</span></a></span><span>
</span><span id="line-180"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbChain"><span class="hs-identifier hs-var">cdbChain</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679905390"><span class="hs-identifier hs-var">varChain</span></a></span><span>
</span><span id="line-181"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTentativeState :: StrictTVar m (TentativeState blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbTentativeState"><span class="hs-identifier hs-var">cdbTentativeState</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (TentativeState blk)
</span><a href="#local-6989586621679905391"><span class="hs-identifier hs-var">varTentativeState</span></a></span><span>
</span><span id="line-182"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbTentativeHeader"><span class="hs-identifier hs-var">cdbTentativeHeader</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (StrictMaybe (Header blk))
</span><a href="#local-6989586621679905392"><span class="hs-identifier hs-var">varTentativeHeader</span></a></span><span>
</span><span id="line-183"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbIterators"><span class="hs-identifier hs-var">cdbIterators</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map IteratorKey (m ()))
</span><a href="#local-6989586621679905394"><span class="hs-identifier hs-var">varIterators</span></a></span><span>
</span><span id="line-184"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbFollowers"><span class="hs-identifier hs-var">cdbFollowers</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (Map FollowerKey (FollowerHandle m blk))
</span><a href="#local-6989586621679905395"><span class="hs-identifier hs-var">varFollowers</span></a></span><span>
</span><span id="line-185"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTopLevelConfig :: TopLevelConfig blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbTopLevelConfig"><span class="hs-identifier hs-var">cdbTopLevelConfig</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679905388"><span class="hs-identifier hs-var">cfg</span></a></span><span>
</span><span id="line-186"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbInvalid :: StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbInvalid"><span class="hs-identifier hs-var">cdbInvalid</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (WithFingerprint (Map (HeaderHash blk) (InvalidBlockInfo blk)))
</span><a href="#local-6989586621679905369"><span class="hs-identifier hs-var">varInvalid</span></a></span><span>
</span><span id="line-187"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbNextIteratorKey :: StrictTVar m IteratorKey
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbNextIteratorKey"><span class="hs-identifier hs-var">cdbNextIteratorKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m IteratorKey
</span><a href="#local-6989586621679905396"><span class="hs-identifier hs-var">varNextIteratorKey</span></a></span><span>
</span><span id="line-188"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbNextFollowerKey :: StrictTVar m FollowerKey
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbNextFollowerKey"><span class="hs-identifier hs-var">cdbNextFollowerKey</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m FollowerKey
</span><a href="#local-6989586621679905398"><span class="hs-identifier hs-var">varNextFollowerKey</span></a></span><span>
</span><span id="line-189"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbCopyLock :: StrictMVar m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbCopyLock"><span class="hs-identifier hs-var">cdbCopyLock</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictMVar m ()
</span><a href="#local-6989586621679905400"><span class="hs-identifier hs-var">varCopyLock</span></a></span><span>
</span><span id="line-190"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbTracer"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span>
</span><span id="line-191"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbTraceLedger :: Tracer m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbTraceLedger"><span class="hs-identifier hs-var">cdbTraceLedger</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; Tracer m (LedgerDB' blk)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; Tracer m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbTraceLedger"><span class="hs-identifier hs-var">Args.cdbTraceLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-192"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbRegistry :: ResourceRegistry m
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbRegistry"><span class="hs-identifier hs-var">cdbRegistry</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity (ResourceRegistry m)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f (ResourceRegistry m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbRegistry"><span class="hs-identifier hs-var">Args.cdbRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-193"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbGcDelay :: DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbGcDelay"><span class="hs-identifier hs-var">cdbGcDelay</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; DiffTime
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbGcDelay"><span class="hs-identifier hs-var">Args.cdbGcDelay</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-194"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbGcInterval :: DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbGcInterval"><span class="hs-identifier hs-var">cdbGcInterval</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; DiffTime
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; DiffTime
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbGcInterval"><span class="hs-identifier hs-var">Args.cdbGcInterval</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-195"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbKillBgThreads :: StrictTVar m (m ())
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbKillBgThreads"><span class="hs-identifier hs-var">cdbKillBgThreads</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (m ())
</span><a href="#local-6989586621679905402"><span class="hs-identifier hs-var">varKillBgThreads</span></a></span><span>
</span><span id="line-196"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbChunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbChunkInfo"><span class="hs-identifier hs-var">cdbChunkInfo</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity ChunkInfo
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbChunkInfo"><span class="hs-identifier hs-var">Args.cdbChunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-197"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbCheckIntegrity :: blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbCheckIntegrity"><span class="hs-identifier hs-var">cdbCheckIntegrity</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity (blk -&gt; Bool)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f (blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbCheckIntegrity"><span class="hs-identifier hs-var">Args.cdbCheckIntegrity</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-198"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbCheckInFuture :: CheckInFuture m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbCheckInFuture"><span class="hs-identifier hs-var">cdbCheckInFuture</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity (CheckInFuture m blk)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f (CheckInFuture m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbCheckInFuture"><span class="hs-identifier hs-var">Args.cdbCheckInFuture</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-199"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbBlocksToAdd :: BlocksToAdd m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbBlocksToAdd"><span class="hs-identifier hs-var">cdbBlocksToAdd</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlocksToAdd m blk
</span><a href="#local-6989586621679905403"><span class="hs-identifier hs-var">blocksToAdd</span></a></span><span>
</span><span id="line-200"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cdbFutureBlocks :: StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbFutureBlocks"><span class="hs-identifier hs-var">cdbFutureBlocks</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar
  m (Map (HeaderHash blk) (Header blk, InvalidBlockPunishment m))
</span><a href="#local-6989586621679905374"><span class="hs-identifier hs-var">varFutureBlocks</span></a></span><span>
</span><span id="line-201"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-202"></span><span>      </span><span id="local-6989586621679905437"><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(StrictTVar m (ChainDbState m blk) -&gt; ChainDbHandle m blk)
-&gt; m (StrictTVar m (ChainDbState m blk)) -&gt; m (ChainDbHandle m blk)
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk) -&gt; ChainDbHandle m blk
forall (m :: * -&gt; *) blk.
StrictTVar m (ChainDbState m blk) -&gt; ChainDbHandle m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDBHandle"><span class="hs-identifier hs-var">CDBHandle</span></a></span><span> </span><span class="annot"><span class="annottext">(m (StrictTVar m (ChainDbState m blk)) -&gt; m (ChainDbHandle m blk))
-&gt; m (StrictTVar m (ChainDbState m blk)) -&gt; m (ChainDbHandle m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbState m blk -&gt; m (StrictTVar m (ChainDbState m blk))
forall (m :: * -&gt; *) a.
(HasCallStack, MonadSTM m, NoThunks a) =&gt;
a -&gt; m (StrictTVar m a)
</span><a href="Ouroboros.Consensus.Util.NormalForm.StrictTVar.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDbState m blk -&gt; m (StrictTVar m (ChainDbState m blk)))
-&gt; ChainDbState m blk -&gt; m (StrictTVar m (ChainDbState m blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; ChainDbState m blk
forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChainDbState m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbOpen"><span class="hs-identifier hs-var">ChainDbOpen</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679905406"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679905635"><span class="annot"><span class="annottext">chainDB :: ChainDB m blk
</span><a href="#local-6989586621679905635"><span class="hs-identifier hs-var hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">API.ChainDB</span></a></span><span>
</span><span id="line-204"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">addBlockAsync :: InvalidBlockPunishment m -&gt; blk -&gt; m (AddBlockPromise m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#addBlockAsync"><span class="hs-identifier hs-var">addBlockAsync</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk
    -&gt; InvalidBlockPunishment m -&gt; blk -&gt; m (AddBlockPromise m blk))
-&gt; InvalidBlockPunishment m
-&gt; blk
-&gt; m (AddBlockPromise m blk)
forall (m :: * -&gt; *) blk a b r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; a -&gt; b -&gt; m r) -&gt; a -&gt; b -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv2"><span class="hs-identifier hs-var">getEnv2</span></a></span><span>    </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; InvalidBlockPunishment m -&gt; blk -&gt; m (AddBlockPromise m blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
ChainDbEnv m blk
-&gt; InvalidBlockPunishment m -&gt; blk -&gt; m (AddBlockPromise m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.ChainSel.html#addBlockAsync"><span class="hs-identifier hs-var">ChainSel.addBlockAsync</span></a></span><span>
</span><span id="line-205"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getCurrentChain :: STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getCurrentChain"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk)))
-&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; STM m r) -&gt; STM m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnvSTM"><span class="hs-identifier hs-var">getEnvSTM</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk),
 ConsensusProtocol (BlockProtocol blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getCurrentChain"><span class="hs-identifier hs-var">Query.getCurrentChain</span></a></span><span>
</span><span id="line-206"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getLedgerDB :: STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getLedgerDB"><span class="hs-identifier hs-var">getLedgerDB</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; STM m (LedgerDB' blk))
-&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; STM m r) -&gt; STM m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnvSTM"><span class="hs-identifier hs-var">getEnvSTM</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (LedgerDB' blk)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDbEnv m blk -&gt; STM m (LedgerDB' blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getLedgerDB"><span class="hs-identifier hs-var">Query.getLedgerDB</span></a></span><span>
</span><span id="line-207"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getTipBlock :: m (Maybe blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getTipBlock"><span class="hs-identifier hs-var">getTipBlock</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; m (Maybe blk)) -&gt; m (Maybe blk)
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a></span><span>     </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m (Maybe blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; m (Maybe blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getTipBlock"><span class="hs-identifier hs-var">Query.getTipBlock</span></a></span><span>
</span><span id="line-208"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getTipHeader :: m (Maybe (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getTipHeader"><span class="hs-identifier hs-var">getTipHeader</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; m (Maybe (Header blk)))
-&gt; m (Maybe (Header blk))
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a></span><span>     </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m (Maybe (Header blk))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; m (Maybe (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getTipHeader"><span class="hs-identifier hs-var">Query.getTipHeader</span></a></span><span>
</span><span id="line-209"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getTipPoint :: STM m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getTipPoint"><span class="hs-identifier hs-var">getTipPoint</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; STM m (Point blk)) -&gt; STM m (Point blk)
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; STM m r) -&gt; STM m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnvSTM"><span class="hs-identifier hs-var">getEnvSTM</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (Point blk)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; STM m (Point blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getTipPoint"><span class="hs-identifier hs-var">Query.getTipPoint</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getBlockComponent :: forall b. BlockComponent blk b -&gt; RealPoint blk -&gt; m (Maybe b)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getBlockComponent"><span class="hs-identifier hs-var">getBlockComponent</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk
    -&gt; BlockComponent blk b -&gt; RealPoint blk -&gt; m (Maybe b))
-&gt; BlockComponent blk b
-&gt; RealPoint blk
-&gt; m (Maybe b)
forall (m :: * -&gt; *) blk a b r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; a -&gt; b -&gt; m r) -&gt; a -&gt; b -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv2"><span class="hs-identifier hs-var">getEnv2</span></a></span><span>    </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; BlockComponent blk b -&gt; RealPoint blk -&gt; m (Maybe b)
forall (m :: * -&gt; *) blk b.
IOLike m =&gt;
ChainDbEnv m blk
-&gt; BlockComponent blk b -&gt; RealPoint blk -&gt; m (Maybe b)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getBlockComponent"><span class="hs-identifier hs-var">Query.getBlockComponent</span></a></span><span>
</span><span id="line-211"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getIsFetched :: STM m (Point blk -&gt; Bool)
</span><a href="#local-6989586621679905759"><span class="hs-identifier hs-var">getIsFetched</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; STM m (Point blk -&gt; Bool))
-&gt; STM m (Point blk -&gt; Bool)
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; STM m r) -&gt; STM m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnvSTM"><span class="hs-identifier hs-var">getEnvSTM</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (Point blk -&gt; Bool)
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDbEnv m blk -&gt; STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getIsFetched"><span class="hs-identifier hs-var">Query.getIsFetched</span></a></span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getIsValid :: STM m (RealPoint blk -&gt; Maybe Bool)
</span><a href="#local-6989586621679905761"><span class="hs-identifier hs-var">getIsValid</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; STM m (RealPoint blk -&gt; Maybe Bool))
-&gt; STM m (RealPoint blk -&gt; Maybe Bool)
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; STM m r) -&gt; STM m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnvSTM"><span class="hs-identifier hs-var">getEnvSTM</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m (RealPoint blk -&gt; Maybe Bool)
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
ChainDbEnv m blk -&gt; STM m (RealPoint blk -&gt; Maybe Bool)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getIsValid"><span class="hs-identifier hs-var">Query.getIsValid</span></a></span><span>
</span><span id="line-213"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getMaxSlotNo :: STM m MaxSlotNo
</span><a href="#local-6989586621679905763"><span class="hs-identifier hs-var">getMaxSlotNo</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; STM m MaxSlotNo) -&gt; STM m MaxSlotNo
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; STM m r) -&gt; STM m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnvSTM"><span class="hs-identifier hs-var">getEnvSTM</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; STM m MaxSlotNo
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk)) =&gt;
ChainDbEnv m blk -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getMaxSlotNo"><span class="hs-identifier hs-var">Query.getMaxSlotNo</span></a></span><span>
</span><span id="line-214"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stream :: forall b.
ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; StreamFrom blk
-&gt; StreamTo blk
-&gt; m (Either (UnknownRange blk) (Iterator m blk b))
</span><a href="#local-6989586621679905765"><span class="hs-identifier hs-var">stream</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; StreamFrom blk
-&gt; StreamTo blk
-&gt; m (Either (UnknownRange blk) (Iterator m blk b))
forall (m :: * -&gt; *) blk b.
(IOLike m, HasHeader blk, HasCallStack) =&gt;
ChainDbHandle m blk
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; StreamFrom blk
-&gt; StreamTo blk
-&gt; m (Either (UnknownRange blk) (Iterator m blk b))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html#stream"><span class="hs-identifier hs-var">Iterator.stream</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-215"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">newFollower :: forall b.
ResourceRegistry m
-&gt; ChainType -&gt; BlockComponent blk b -&gt; m (Follower m blk b)
</span><a href="#local-6989586621679905871"><span class="hs-identifier hs-var">newFollower</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; ResourceRegistry m
-&gt; ChainType
-&gt; BlockComponent blk b
-&gt; m (Follower m blk b)
forall (m :: * -&gt; *) blk b.
(IOLike m, HasHeader blk, GetHeader blk,
 HasNestedContent Header blk,
 EncodeDiskDep (NestedCtxt Header) blk) =&gt;
ChainDbHandle m blk
-&gt; ResourceRegistry m
-&gt; ChainType
-&gt; BlockComponent blk b
-&gt; m (Follower m blk b)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Follower.html#newFollower"><span class="hs-identifier hs-var">Follower.newFollower</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-216"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getIsInvalidBlock :: STM
  m
  (WithFingerprint
     (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="#local-6989586621679905996"><span class="hs-identifier hs-var">getIsInvalidBlock</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk
    -&gt; STM
         m
         (WithFingerprint
            (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk))))
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; STM m r) -&gt; STM m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnvSTM"><span class="hs-identifier hs-var">getEnvSTM</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader blk) =&gt;
ChainDbEnv m blk
-&gt; STM
     m
     (WithFingerprint
        (HeaderHash blk -&gt; Maybe (InvalidBlockReason blk)))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Query.html#getIsInvalidBlock"><span class="hs-identifier hs-var">Query.getIsInvalidBlock</span></a></span><span>
</span><span id="line-217"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">closeDB :: m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#closeDB"><span class="hs-identifier hs-var">closeDB</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk), HasCallStack) =&gt;
ChainDbHandle m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#closeDB"><span class="hs-identifier hs-var">closeDB</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-218"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">isOpen :: STM m Bool
</span><a href="#local-6989586621679905999"><span class="hs-identifier hs-var">isOpen</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk -&gt; STM m Bool
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDbHandle m blk -&gt; STM m Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#isOpen"><span class="hs-identifier hs-var">isOpen</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-219"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-220"></span><span>          </span><span id="local-6989586621679906310"><span class="annot"><span class="annottext">testing :: Internal m blk
</span><a href="#local-6989586621679906310"><span class="hs-identifier hs-var hs-var">testing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#Internal"><span class="hs-identifier hs-type">Internal</span></a></span><span>
</span><span id="line-221"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">intCopyToImmutableDB :: m (WithOrigin SlotNo)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#intCopyToImmutableDB"><span class="hs-identifier hs-var">intCopyToImmutableDB</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; m (WithOrigin SlotNo))
-&gt; m (WithOrigin SlotNo)
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m (WithOrigin SlotNo)
forall (m :: * -&gt; *) blk.
(IOLike m, ConsensusProtocol (BlockProtocol blk), HasHeader blk,
 GetHeader blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; m (WithOrigin SlotNo)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#copyToImmutableDB"><span class="hs-identifier hs-var">Background.copyToImmutableDB</span></a></span><span>
</span><span id="line-222"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">intGarbageCollect :: SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#intGarbageCollect"><span class="hs-identifier hs-var">intGarbageCollect</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
-&gt; (ChainDbEnv m blk -&gt; SlotNo -&gt; m ()) -&gt; SlotNo -&gt; m ()
forall (m :: * -&gt; *) blk a r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; a -&gt; m r) -&gt; a -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv1"><span class="hs-identifier hs-var">getEnv1</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; SlotNo -&gt; m ()
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDbEnv m blk -&gt; SlotNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#garbageCollect"><span class="hs-identifier hs-var">Background.garbageCollect</span></a></span><span>
</span><span id="line-223"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">intUpdateLedgerSnapshots :: m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#intUpdateLedgerSnapshots"><span class="hs-identifier hs-var">intUpdateLedgerSnapshots</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, LgrDbSerialiseConstraints blk, HasHeader blk,
 IsLedger (LedgerState blk)) =&gt;
ChainDbEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#updateLedgerSnapshots"><span class="hs-identifier hs-var">Background.updateLedgerSnapshots</span></a></span><span>
</span><span id="line-224"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">intAddBlockRunner :: m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#intAddBlockRunner"><span class="hs-identifier hs-var">intAddBlockRunner</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; m Void) -&gt; m Void
forall (m :: * -&gt; *) blk r.
(IOLike m, HasCallStack, HasHeader blk) =&gt;
ChainDbHandle m blk -&gt; (ChainDbEnv m blk -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#getEnv"><span class="hs-identifier hs-var">getEnv</span></a></span><span>  </span><span class="annot"><span class="annottext">ChainDbHandle m blk
</span><a href="#local-6989586621679905437"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m Void
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, HasCallStack) =&gt;
ChainDbEnv m blk -&gt; m Void
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#addBlockRunner"><span class="hs-identifier hs-var">Background.addBlockRunner</span></a></span><span>
</span><span id="line-225"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">intKillBgThreads :: StrictTVar m (m ())
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#intKillBgThreads"><span class="hs-identifier hs-var">intKillBgThreads</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (m ())
</span><a href="#local-6989586621679905402"><span class="hs-identifier hs-var">varKillBgThreads</span></a></span><span>
</span><span id="line-226"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceOpenEvent blk -&gt; TraceEvent blk)
-&gt; TraceOpenEvent blk -&gt; TraceEvent blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; TraceOpenEvent blk
forall blk. Point blk -&gt; Point blk -&gt; TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#OpenedDB"><span class="hs-identifier hs-var">OpenedDB</span></a></span><span>
</span><span id="line-229"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679905384"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span>   </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679905384"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679905323"><span class="hs-identifier hs-var">launchBgTasks</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; Word64 -&gt; m ()
forall (m :: * -&gt; *) blk.
(IOLike m, LedgerSupportsProtocol blk, InspectLedger blk,
 HasHardForkHistory blk, LgrDbSerialiseConstraints blk) =&gt;
ChainDbEnv m blk -&gt; Word64 -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Background.html#launchBgTasks"><span class="hs-identifier hs-var">Background.launchBgTasks</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679905406"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679905364"><span class="hs-identifier hs-var">replayed</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>      </span><span class="annot"><span class="annottext">(ChainDB m blk, Internal m blk, ChainDbEnv m blk)
-&gt; m (ChainDB m blk, Internal m blk, ChainDbEnv m blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679905635"><span class="hs-identifier hs-var">chainDB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Internal m blk
forall {blk}. Internal m blk
</span><a href="#local-6989586621679906310"><span class="hs-identifier hs-var">testing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679905406"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><span class="annottext">(ResourceKey m, ChainDB m blk)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ResourceKey m, ChainDB m blk)
-&gt; WithTempRegistry
     (ChainDbEnv m blk) m (ResourceKey m, ChainDB m blk)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ResourceKey m, ChainDB m blk)
 -&gt; WithTempRegistry
      (ChainDbEnv m blk) m (ResourceKey m, ChainDB m blk))
-&gt; m (ResourceKey m, ChainDB m blk)
-&gt; WithTempRegistry
     (ChainDbEnv m blk) m (ResourceKey m, ChainDB m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ResourceRegistry m
-&gt; (ResourceId -&gt; m (ChainDB m blk))
-&gt; (ChainDB m blk -&gt; m ())
-&gt; m (ResourceKey m, ChainDB m blk)
forall (m :: * -&gt; *) a.
(IOLike m, HasCallStack) =&gt;
ResourceRegistry m
-&gt; (ResourceId -&gt; m a) -&gt; (a -&gt; m ()) -&gt; m (ResourceKey m, a)
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#allocate"><span class="hs-identifier hs-var">allocate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; HKD Identity (ResourceRegistry m)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; HKD f (ResourceRegistry m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbRegistry"><span class="hs-identifier hs-var">Args.cdbRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ResourceId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; m (ChainDB m blk)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainDB m blk -&gt; m (ChainDB m blk))
-&gt; ChainDB m blk -&gt; m (ChainDB m blk)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679905352"><span class="hs-identifier hs-var">chainDB</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; m ()
forall (m :: * -&gt; *) blk. ChainDB m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#closeDB"><span class="hs-identifier hs-var">API.closeDB</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><span class="annottext">((ChainDB m blk, Internal m blk), ChainDbEnv m blk)
-&gt; WithTempRegistry
     (ChainDbEnv m blk)
     m
     ((ChainDB m blk, Internal m blk), ChainDbEnv m blk)
forall a. a -&gt; WithTempRegistry (ChainDbEnv m blk) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679905352"><span class="hs-identifier hs-var">chainDB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Internal m blk
</span><a href="#local-6989586621679905353"><span class="hs-identifier hs-var">testing</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679905354"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-240"></span><span>    </span><span id="local-6989586621679905325"><span class="annot"><span class="annottext">tracer :: Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679905325"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk -&gt; Tracer m (TraceEvent blk)
forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ChainDbArgs f m blk -&gt; Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#cdbTracer"><span class="hs-identifier hs-var">Args.cdbTracer</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679905331"><span class="annot"><span class="annottext">ImmutableDbArgs Identity m blk
</span><a href="#local-6989586621679905331"><span class="hs-identifier hs-var">argsImmutableDb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679905347"><span class="annot"><span class="annottext">VolatileDbArgs Identity m blk
</span><a href="#local-6989586621679905347"><span class="hs-identifier hs-var">argsVolatileDb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679905366"><span class="annot"><span class="annottext">LgrDbArgs Identity m blk
</span><a href="#local-6989586621679905366"><span class="hs-identifier hs-var">argsLgrDb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainDbSpecificArgs Identity m blk
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
-&gt; (ImmutableDbArgs Identity m blk, VolatileDbArgs Identity m blk,
    LgrDbArgs Identity m blk, ChainDbSpecificArgs Identity m blk)
forall (m :: * -&gt; *) blk (f :: * -&gt; *).
MapHKD f =&gt;
ChainDbArgs f m blk
-&gt; (ImmutableDbArgs f m blk, VolatileDbArgs f m blk,
    LgrDbArgs f m blk, ChainDbSpecificArgs f m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Args.html#fromChainDbArgs"><span class="hs-identifier hs-var">Args.fromChainDbArgs</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbArgs Identity m blk
</span><a href="#local-6989586621679905322"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="annot"><span class="hs-comment">-- | We use 'runInnerWithTempRegistry' for the component databases.</span></span><span>
</span><span id="line-244"></span><span id="local-6989586621679904594"><span id="local-6989586621679904595"><span id="local-6989586621679904596"><span id="local-6989586621679904597"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#innerOpenCont"><span class="hs-identifier hs-type">innerOpenCont</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-245"></span><span>     </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904594"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679904595"><span class="hs-identifier hs-type">innerDB</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679904594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904596"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679904595"><span class="hs-identifier hs-type">innerDB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679904596"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbEnv"><span class="hs-identifier hs-type">ChainDbEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904597"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679904594"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904595"><span class="hs-identifier hs-type">innerDB</span></a></span></span></span></span></span><span>
</span><span id="line-249"></span><span id="innerOpenCont"><span class="annot"><span class="annottext">innerOpenCont :: forall (m :: * -&gt; *) innerDB st blk.
IOLike m =&gt;
(innerDB -&gt; m ())
-&gt; WithTempRegistry st m (innerDB, st)
-&gt; WithTempRegistry (ChainDbEnv m blk) m innerDB
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#innerOpenCont"><span class="hs-identifier hs-var hs-var">innerOpenCont</span></a></span></span><span> </span><span id="local-6989586621679906340"><span class="annot"><span class="annottext">innerDB -&gt; m ()
</span><a href="#local-6989586621679906340"><span class="hs-identifier hs-var">closer</span></a></span></span><span> </span><span id="local-6989586621679906341"><span class="annot"><span class="annottext">WithTempRegistry st m (innerDB, st)
</span><a href="#local-6989586621679906341"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><span class="annottext">WithTempRegistry st m (innerDB, st, innerDB)
-&gt; (innerDB -&gt; m Bool)
-&gt; (ChainDbEnv m blk -&gt; innerDB -&gt; Bool)
-&gt; WithTempRegistry (ChainDbEnv m blk) m innerDB
forall innerSt st (m :: * -&gt; *) res a.
IOLike m =&gt;
WithTempRegistry innerSt m (a, innerSt, res)
-&gt; (res -&gt; m Bool)
-&gt; (st -&gt; res -&gt; Bool)
-&gt; WithTempRegistry st m a
</span><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#runInnerWithTempRegistry"><span class="hs-identifier hs-var">runInnerWithTempRegistry</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((innerDB, st) -&gt; (innerDB, st, innerDB))
-&gt; WithTempRegistry st m (innerDB, st)
-&gt; WithTempRegistry st m (innerDB, st, innerDB)
forall a b.
(a -&gt; b) -&gt; WithTempRegistry st m a -&gt; WithTempRegistry st m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679906342"><span class="annot"><span class="annottext">innerDB
</span><a href="#local-6989586621679906342"><span class="hs-identifier hs-var">innerDB</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679906343"><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679906343"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">innerDB
</span><a href="#local-6989586621679906342"><span class="hs-identifier hs-var">innerDB</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">st
</span><a href="#local-6989586621679906343"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">innerDB
</span><a href="#local-6989586621679906342"><span class="hs-identifier hs-var">innerDB</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry st m (innerDB, st)
</span><a href="#local-6989586621679906341"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m Bool
forall a b. a -&gt; m b -&gt; m a
forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%24"><span class="hs-operator hs-var">&lt;$</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m Bool) -&gt; (innerDB -&gt; m ()) -&gt; innerDB -&gt; m Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">innerDB -&gt; m ()
</span><a href="#local-6989586621679906340"><span class="hs-identifier hs-var">closer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679906346"><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679906346"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span id="local-6989586621679906347"><span class="annot"><span class="annottext">innerDB
</span><a href="#local-6989586621679906347"><span class="hs-identifier hs-var">_innerDB</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>      </span><span class="hs-comment">-- This check is degenerate because handles in @_env@ and the</span><span>
</span><span id="line-255"></span><span>      </span><span class="hs-comment">-- @_innerDB@ handle do not support an equality check; all of the</span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-comment">-- identifying data is only in the handle's closure, not</span><span>
</span><span id="line-257"></span><span>      </span><span class="hs-comment">-- accessible because of our intentional encapsulation choices.</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span id="local-6989586621679904758"><span id="local-6989586621679904759"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#isOpen"><span class="hs-identifier hs-type">isOpen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904758"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbHandle"><span class="hs-identifier hs-type">ChainDbHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904758"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904759"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679904758"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span></span><span>
</span><span id="line-260"></span><span id="isOpen"><span class="annot"><span class="annottext">isOpen :: forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDbHandle m blk -&gt; STM m Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#isOpen"><span class="hs-identifier hs-var hs-var">isOpen</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDBHandle"><span class="hs-identifier hs-type">CDBHandle</span></a></span><span> </span><span id="local-6989586621679906356"><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk)
</span><a href="#local-6989586621679906356"><span class="hs-identifier hs-var">varState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk) -&gt; STM m (ChainDbState m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk)
</span><a href="#local-6989586621679906356"><span class="hs-identifier hs-var">varState</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (ChainDbState m blk)
-&gt; (ChainDbState m blk -&gt; Bool) -&gt; STM m Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%26%3E"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">ChainDbState m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbClosed"><span class="hs-identifier hs-var">ChainDbClosed</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbOpen"><span class="hs-identifier hs-type">ChainDbOpen</span></a></span><span> </span><span id="local-6989586621679906359"><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679906359"><span class="hs-identifier hs-var">_env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#closeDB"><span class="hs-identifier hs-type">closeDB</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-265"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679904756"><span class="annot"><a href="#local-6989586621679904756"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679904757"><span class="annot"><a href="#local-6989586621679904757"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-266"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904756"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-267"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904757"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-269"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbHandle"><span class="hs-identifier hs-type">ChainDbHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904756"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679904757"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679904756"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span id="closeDB"><span class="annot"><span class="annottext">closeDB :: forall (m :: * -&gt; *) blk.
(IOLike m, HasHeader (Header blk), HasCallStack) =&gt;
ChainDbHandle m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#closeDB"><span class="hs-identifier hs-var hs-var">closeDB</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDBHandle"><span class="hs-identifier hs-type">CDBHandle</span></a></span><span> </span><span id="local-6989586621679906408"><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk)
</span><a href="#local-6989586621679906408"><span class="hs-identifier hs-var">varState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621679906409"><span class="annot"><span class="annottext">Maybe (ChainDbEnv m blk)
</span><a href="#local-6989586621679906409"><span class="hs-identifier hs-var">mbOpenEnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Maybe (ChainDbEnv m blk)) -&gt; m (Maybe (ChainDbEnv m blk))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (Maybe (ChainDbEnv m blk)) -&gt; m (Maybe (ChainDbEnv m blk)))
-&gt; STM m (Maybe (ChainDbEnv m blk)) -&gt; m (Maybe (ChainDbEnv m blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk) -&gt; STM m (ChainDbState m blk)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk)
</span><a href="#local-6989586621679906408"><span class="hs-identifier hs-var">varState</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (ChainDbState m blk)
-&gt; (ChainDbState m blk -&gt; STM m (Maybe (ChainDbEnv m blk)))
-&gt; STM m (Maybe (ChainDbEnv m blk))
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-comment">-- Idempotent</span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><span class="annottext">ChainDbState m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbClosed"><span class="hs-identifier hs-var">ChainDbClosed</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (ChainDbEnv m blk) -&gt; STM m (Maybe (ChainDbEnv m blk))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ChainDbEnv m blk)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbOpen"><span class="hs-identifier hs-type">ChainDbOpen</span></a></span><span> </span><span id="local-6989586621679906410"><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679906410"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>        </span><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk) -&gt; ChainDbState m blk -&gt; STM m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictTVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (ChainDbState m blk)
</span><a href="#local-6989586621679906408"><span class="hs-identifier hs-var">varState</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbState m blk
forall (m :: * -&gt; *) blk. ChainDbState m blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ChainDbClosed"><span class="hs-identifier hs-var">ChainDbClosed</span></a></span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ChainDbEnv m blk) -&gt; STM m (Maybe (ChainDbEnv m blk))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (ChainDbEnv m blk) -&gt; STM m (Maybe (ChainDbEnv m blk)))
-&gt; Maybe (ChainDbEnv m blk) -&gt; STM m (Maybe (ChainDbEnv m blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; Maybe (ChainDbEnv m blk)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679906410"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- Only when the ChainDB was open</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">Maybe (ChainDbEnv m blk) -&gt; (ChainDbEnv m blk -&gt; m ()) -&gt; m ()
forall (f :: * -&gt; *) a.
Applicative f =&gt;
Maybe a -&gt; (a -&gt; f ()) -&gt; f ()
</span><a href="Ouroboros.Consensus.Util.html#whenJust"><span class="hs-identifier hs-var">whenJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ChainDbEnv m blk)
</span><a href="#local-6989586621679906409"><span class="hs-identifier hs-var">mbOpenEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((ChainDbEnv m blk -&gt; m ()) -&gt; m ())
-&gt; (ChainDbEnv m blk -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679906412"><span class="annot"><span class="annottext">cdb :: ChainDbEnv m blk
</span><a href="#local-6989586621679906412"><span class="hs-identifier hs-var">cdb</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#CDB"><span class="hs-identifier hs-type">CDB</span></a></span><span class="hs-special">{</span><span id="local-6989586621679906413"><span id="local-6989586621679906414"><span id="local-6989586621679906415"><span id="local-6989586621679906416"><span id="local-6989586621679906417"><span id="local-6989586621679906418"><span id="local-6989586621679906419"><span id="local-6989586621679906420"><span id="local-6989586621679906421"><span id="local-6989586621679906422"><span id="local-6989586621679906423"><span id="local-6989586621679906424"><span id="local-6989586621679906425"><span id="local-6989586621679906426"><span id="local-6989586621679906427"><span id="local-6989586621679906428"><span id="local-6989586621679906429"><span id="local-6989586621679906430"><span id="local-6989586621679906431"><span id="local-6989586621679906432"><span id="local-6989586621679906433"><span id="local-6989586621679906434"><span id="local-6989586621679906435"><span id="local-6989586621679906436"><span class="annot"><span class="annottext">DiffTime
Tracer m (LedgerDB' blk)
Tracer m (TraceEvent blk)
TopLevelConfig blk
StrictTVar m (m ())
StrictTVar m (FutureBlocks m blk)
StrictTVar m (Map FollowerKey (FollowerHandle m blk))
StrictTVar m (Map IteratorKey (m ()))
StrictTVar m (AnchoredFragment (Header blk))
StrictTVar m (WithFingerprint (InvalidBlocks blk))
StrictTVar m (TentativeState blk)
StrictTVar m (StrictMaybe (Header blk))
StrictTVar m FollowerKey
StrictTVar m IteratorKey
StrictMVar m ()
VolatileDB m blk
ChunkInfo
ResourceRegistry m
ImmutableDB m blk
CheckInFuture m blk
LgrDB m blk
BlocksToAdd m blk
blk -&gt; Bool
cdbImmutableDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ImmutableDB m blk
cdbVolatileDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; VolatileDB m blk
cdbLgrDB :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; LgrDB m blk
cdbChain :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (TentativeState blk)
cdbTentativeHeader :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; TopLevelConfig blk
cdbInvalid :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk
-&gt; StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m IteratorKey
cdbNextFollowerKey :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m FollowerKey
cdbCopyLock :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictMVar m ()
cdbTracer :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (TraceEvent blk)
cdbTraceLedger :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; Tracer m (LedgerDB' blk)
cdbRegistry :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ResourceRegistry m
cdbGcDelay :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbGcInterval :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; DiffTime
cdbKillBgThreads :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; StrictTVar m (m ())
cdbChunkInfo :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; ChunkInfo
cdbCheckIntegrity :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; blk -&gt; Bool
cdbCheckInFuture :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; CheckInFuture m blk
cdbBlocksToAdd :: forall (m :: * -&gt; *) blk. ChainDbEnv m blk -&gt; BlocksToAdd m blk
cdbFutureBlocks :: forall (m :: * -&gt; *) blk.
ChainDbEnv m blk -&gt; StrictTVar m (FutureBlocks m blk)
cdbImmutableDB :: ImmutableDB m blk
cdbVolatileDB :: VolatileDB m blk
cdbLgrDB :: LgrDB m blk
cdbChain :: StrictTVar m (AnchoredFragment (Header blk))
cdbTentativeState :: StrictTVar m (TentativeState blk)
cdbTentativeHeader :: StrictTVar m (StrictMaybe (Header blk))
cdbIterators :: StrictTVar m (Map IteratorKey (m ()))
cdbFollowers :: StrictTVar m (Map FollowerKey (FollowerHandle m blk))
cdbTopLevelConfig :: TopLevelConfig blk
cdbInvalid :: StrictTVar m (WithFingerprint (InvalidBlocks blk))
cdbNextIteratorKey :: StrictTVar m IteratorKey
cdbNextFollowerKey :: StrictTVar m FollowerKey
cdbCopyLock :: StrictMVar m ()
cdbTracer :: Tracer m (TraceEvent blk)
cdbTraceLedger :: Tracer m (LedgerDB' blk)
cdbRegistry :: ResourceRegistry m
cdbGcDelay :: DiffTime
cdbGcInterval :: DiffTime
cdbKillBgThreads :: StrictTVar m (m ())
cdbChunkInfo :: ChunkInfo
cdbCheckIntegrity :: blk -&gt; Bool
cdbCheckInFuture :: CheckInFuture m blk
cdbBlocksToAdd :: BlocksToAdd m blk
cdbFutureBlocks :: StrictTVar m (FutureBlocks m blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#cdbImmutableDB"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m ()
forall (m :: * -&gt; *) blk. IOLike m =&gt; ChainDbEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Follower.html#closeAllFollowers"><span class="hs-identifier hs-var">Follower.closeAllFollowers</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679906412"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-283"></span><span>      </span><span class="annot"><span class="annottext">ChainDbEnv m blk -&gt; m ()
forall (m :: * -&gt; *) blk. IOLike m =&gt; ChainDbEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Iterator.html#closeAllIterators"><span class="hs-identifier hs-var">Iterator.closeAllIterators</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbEnv m blk
</span><a href="#local-6989586621679906412"><span class="hs-identifier hs-var">cdb</span></a></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span>      </span><span id="local-6989586621679906439"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679906439"><span class="hs-identifier hs-var">killBgThreads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (m ()) -&gt; m (m ())
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (m ()) -&gt; m (m ())) -&gt; STM m (m ()) -&gt; m (m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (m ()) -&gt; STM m (m ())
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (m ())
</span><a href="#local-6989586621679906431"><span class="hs-identifier hs-var">cdbKillBgThreads</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679906439"><span class="hs-identifier hs-var">killBgThreads</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">ImmutableDB m blk -&gt; m ()
forall (m :: * -&gt; *) blk. HasCallStack =&gt; ImmutableDB m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#closeDB"><span class="hs-identifier hs-var">ImmutableDB.closeDB</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679906413"><span class="hs-identifier hs-var">cdbImmutableDB</span></a></span><span>
</span><span id="line-289"></span><span>      </span><span class="annot"><span class="annottext">VolatileDB m blk -&gt; HasCallStack =&gt; m ()
forall (m :: * -&gt; *) blk. VolatileDB m blk -&gt; HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.VolatileDB.API.html#closeDB"><span class="hs-identifier hs-var">VolatileDB.closeDB</span></a></span><span> </span><span class="annot"><span class="annottext">VolatileDB m blk
</span><a href="#local-6989586621679906414"><span class="hs-identifier hs-var">cdbVolatileDB</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>      </span><span id="local-6989586621679906440"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679906440"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment (Header blk))
-&gt; m (AnchoredFragment (Header blk))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (AnchoredFragment (Header blk))
 -&gt; m (AnchoredFragment (Header blk)))
-&gt; STM m (AnchoredFragment (Header blk))
-&gt; m (AnchoredFragment (Header blk))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
-&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679906416"><span class="hs-identifier hs-var">cdbChain</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679906426"><span class="hs-identifier hs-var">cdbTracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceOpenEvent blk -&gt; TraceEvent blk
forall blk. TraceOpenEvent blk -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#TraceOpenEvent"><span class="hs-identifier hs-var">TraceOpenEvent</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceOpenEvent blk -&gt; TraceEvent blk)
-&gt; TraceOpenEvent blk -&gt; TraceEvent blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Point blk -&gt; Point blk -&gt; TraceOpenEvent blk
forall blk. Point blk -&gt; Point blk -&gt; TraceOpenEvent blk
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.Types.html#ClosedDB"><span class="hs-identifier hs-var">ClosedDB</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block. AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.anchorPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679906440"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point (Header blk) -&gt; Point blk
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point (Header blk) -&gt; Point blk)
-&gt; Point (Header blk) -&gt; Point blk
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Point (Header blk)
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679906440"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">{-------------------------------------------------------------------------------
  Auxiliary
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-comment">-- | Lift 'chunkIndexOfSlot' to 'Point'</span><span>
</span><span id="line-302"></span><span class="hs-comment">--</span><span>
</span><span id="line-303"></span><span class="hs-comment">-- Returns 'firstChunkNo' in case of 'GenesisPoint'.</span><span>
</span><span id="line-304"></span><span id="local-6989586621679904606"><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#chunkIndexOfPoint"><span class="hs-identifier hs-type">chunkIndexOfPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ImmutableDB.ChunkInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679904606"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ImmutableDB.ChunkNo</span></a></span></span><span>
</span><span id="line-305"></span><span id="chunkIndexOfPoint"><span class="annot"><span class="annottext">chunkIndexOfPoint :: forall blk. ChunkInfo -&gt; Point blk -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.Impl.html#chunkIndexOfPoint"><span class="hs-identifier hs-var hs-var">chunkIndexOfPoint</span></a></span></span><span> </span><span id="local-6989586621679906443"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679906443"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><span class="annottext">Point blk
</span><span class="hs-identifier hs-var">GenesisPoint</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">ImmutableDB.firstChunkNo</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">BlockPoint</span></span><span> </span><span id="local-6989586621679906446"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679906446"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="annot"><span class="annottext">HeaderHash blk
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; SlotNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkIndexOfSlot"><span class="hs-identifier hs-var">ImmutableDB.chunkIndexOfSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679906443"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679906446"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-308"></span></pre></body></html>
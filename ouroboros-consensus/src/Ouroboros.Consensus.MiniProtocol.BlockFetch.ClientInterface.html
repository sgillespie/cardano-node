<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="annot"><span class="hs-comment">-- | Initialization of the 'BlockFetchConsensusInterface'</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#ChainDbView"><span class="hs-identifier">ChainDbView</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#SlotForgeTimeOracle"><span class="hs-identifier">SlotForgeTimeOracle</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#defaultChainDbView"><span class="hs-identifier">defaultChainDbView</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#initSlotForgeTimeOracle"><span class="hs-identifier">initSlotForgeTimeOracle</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#mkBlockFetchConsensusInterface"><span class="hs-identifier">mkBlockFetchConsensusInterface</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#readFetchModeDefault"><span class="hs-identifier">readFetchModeDefault</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html"><span class="hs-identifier">Data.Proxy</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.html"><span class="hs-identifier">Data.Time.Clock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.UTCTime.html#UTCTime"><span class="hs-identifier">UTCTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#blockMatchesHeader"><span class="hs-identifier">blockMatchesHeader</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Block</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.BlockchainTime.html"><span class="hs-identifier">Ouroboros.Consensus.BlockchainTime</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Config.html"><span class="hs-identifier">Ouroboros.Consensus.Config</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.SupportsNode.html"><span class="hs-identifier">Ouroboros.Consensus.Config.SupportsNode</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SupportsNode</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.Abstract</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">History</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.html"><span class="hs-identifier">Ouroboros.Consensus.HardFork.History</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">History</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Abstract</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html"><span class="hs-identifier">Ouroboros.Consensus.Ledger.Extended</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html"><span class="hs-identifier">Ouroboros.Consensus.Protocol.Abstract</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier">ChainDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainDB</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment</span></a></span><span>
</span><span id="line-35"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier">InvalidBlockPunishment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">InvalidBlockPunishment</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.AnchoredFragment.html"><span class="hs-identifier">Ouroboros.Consensus.Util.AnchoredFragment</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Orphans.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AnchoredFragment</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MaxSlotNo</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ConsensusInterface</span></span><span>
</span><span id="line-44"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BlockFetchConsensusInterface</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">FetchMode</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>                     </span><span class="annot"><span class="hs-identifier">FromConsensus</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">WhetherReceivingTentativeBlocks</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.SizeInBytes</span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="annot"><span class="hs-comment">-- | Abstract over the ChainDB</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">data</span><span> </span><span id="ChainDbView"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#ChainDbView"><span class="hs-identifier hs-var">ChainDbView</span></a></span></span><span> </span><span id="local-6989586621679915374"><span class="annot"><a href="#local-6989586621679915374"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679915375"><span class="annot"><a href="#local-6989586621679915375"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ChainDbView"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#ChainDbView"><span class="hs-identifier hs-var">ChainDbView</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-50"></span><span>     </span><span id="getCurrentChain"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getCurrentChain"><span class="hs-identifier hs-var hs-var">getCurrentChain</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915374"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915375"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="getIsFetched"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getIsFetched"><span class="hs-identifier hs-var hs-var">getIsFetched</span></a></span></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915374"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679915375"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="getMaxSlotNo"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk. ChainDbView m blk -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getMaxSlotNo"><span class="hs-identifier hs-var hs-var">getMaxSlotNo</span></a></span></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915374"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-53"></span><span>   </span><span class="hs-special">,</span><span> </span><span id="addBlockWaitWrittenToDisk"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; InvalidBlockPunishment m -&gt; blk -&gt; m Bool
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#addBlockWaitWrittenToDisk"><span class="hs-identifier hs-var hs-var">addBlockWaitWrittenToDisk</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier hs-type">InvalidBlockPunishment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915374"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915375"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915374"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-54"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span id="local-6989586621679915391"><span id="local-6989586621679915393"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#defaultChainDbView"><span class="hs-identifier hs-type">defaultChainDbView</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915391"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">ChainDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915391"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915393"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915391"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915393"><span class="hs-identifier hs-type">blk</span></a></span></span></span><span>
</span><span id="line-57"></span><span id="defaultChainDbView"><span class="annot"><span class="annottext">defaultChainDbView :: forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDB m blk -&gt; ChainDbView m blk
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#defaultChainDbView"><span class="hs-identifier hs-var hs-var">defaultChainDbView</span></a></span></span><span> </span><span id="local-6989586621679915565"><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679915565"><span class="hs-identifier hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><span class="annottext">getCurrentChain :: STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getCurrentChain"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
ChainDB m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getCurrentChain"><span class="hs-identifier hs-var">ChainDB.getCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679915565"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getIsFetched :: STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getIsFetched"><span class="hs-identifier hs-var">getIsFetched</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (Point blk -&gt; Bool)
forall (m :: * -&gt; *) blk.
ChainDB m blk -&gt; STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getIsFetched"><span class="hs-identifier hs-var">ChainDB.getIsFetched</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679915565"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getMaxSlotNo :: STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getMaxSlotNo"><span class="hs-identifier hs-var">getMaxSlotNo</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m MaxSlotNo
forall (m :: * -&gt; *) blk. ChainDB m blk -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getMaxSlotNo"><span class="hs-identifier hs-var">ChainDB.getMaxSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679915565"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">addBlockWaitWrittenToDisk :: InvalidBlockPunishment m -&gt; blk -&gt; m Bool
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#addBlockWaitWrittenToDisk"><span class="hs-identifier hs-var">addBlockWaitWrittenToDisk</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; InvalidBlockPunishment m -&gt; blk -&gt; m Bool
forall (m :: * -&gt; *) blk.
IOLike m =&gt;
ChainDB m blk -&gt; InvalidBlockPunishment m -&gt; blk -&gt; m Bool
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#addBlockWaitWrittenToDisk"><span class="hs-identifier hs-var">ChainDB.addBlockWaitWrittenToDisk</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679915565"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- | How to get the wall-clock time of a slot. Note that this is a very</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- non-trivial operation in the context of the HFC, cf. 'headerForgeUTCTime'.</span><span>
</span><span id="line-66"></span><span class="hs-keyword">type</span><span> </span><span id="SlotForgeTimeOracle"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#SlotForgeTimeOracle"><span class="hs-identifier hs-var">SlotForgeTimeOracle</span></a></span></span><span> </span><span id="local-6989586621679915571"><span class="annot"><a href="#local-6989586621679915571"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679915572"><span class="annot"><a href="#local-6989586621679915572"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915572"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915571"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.UTCTime.html#UTCTime"><span class="hs-identifier hs-type">UTCTime</span></a></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">-- | Create a HFC-enabled 'SlotForgeTimeOracle'. Note that its semantics are</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- rather tricky, cf. 'headerForgeUTCTime'.</span><span>
</span><span id="line-70"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#initSlotForgeTimeOracle"><span class="hs-identifier hs-type">initSlotForgeTimeOracle</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-71"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679915405"><span class="annot"><a href="#local-6989586621679915405"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679915406"><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-72"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915405"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-73"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-74"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HasHardForkHistory"><span class="hs-identifier hs-type">History.HasHardForkHistory</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-75"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.SupportsNode.html#ConfigSupportsNode"><span class="hs-identifier hs-type">SupportsNode.ConfigSupportsNode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-76"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#IsLedger"><span class="hs-identifier hs-type">IsLedger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Basics.html#LedgerState"><span class="hs-identifier hs-type">LedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Config.html#TopLevelConfig"><span class="hs-identifier hs-type">TopLevelConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#ChainDB"><span class="hs-identifier hs-type">ChainDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915405"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915405"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#SlotForgeTimeOracle"><span class="hs-identifier hs-type">SlotForgeTimeOracle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915405"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span id="initSlotForgeTimeOracle"><span class="annot"><span class="annottext">initSlotForgeTimeOracle :: forall (m :: * -&gt; *) blk.
(IOLike m, BlockSupportsProtocol blk, HasHardForkHistory blk,
 ConfigSupportsNode blk, IsLedger (LedgerState blk)) =&gt;
TopLevelConfig blk
-&gt; ChainDB m blk -&gt; m (SlotForgeTimeOracle m blk)
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#initSlotForgeTimeOracle"><span class="hs-identifier hs-var hs-var">initSlotForgeTimeOracle</span></a></span></span><span> </span><span id="local-6989586621679915611"><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679915611"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621679915612"><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679915612"><span class="hs-identifier hs-var">chainDB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-82"></span><span>    </span><span id="local-6989586621679915613"><span class="annot"><span class="annottext">RunWithCachedSummary (HardForkIndices blk) m
</span><a href="#local-6989586621679915613"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-83"></span><span>      </span><span class="annot"><span class="annottext">STM m (Summary (HardForkIndices blk))
-&gt; m (RunWithCachedSummary (HardForkIndices blk) m)
forall (m :: * -&gt; *) (xs :: [*]).
MonadSTM m =&gt;
STM m (Summary xs) -&gt; m (RunWithCachedSummary xs m)
</span><a href="Ouroboros.Consensus.HardFork.History.Caching.html#runWithCachedSummary"><span class="hs-identifier hs-var">History.runWithCachedSummary</span></a></span><span>
</span><span id="line-84"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; Summary (HardForkIndices blk)
</span><a href="#local-6989586621679915615"><span class="hs-identifier hs-var">toSummary</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtLedgerState blk -&gt; Summary (HardForkIndices blk))
-&gt; STM m (ExtLedgerState blk)
-&gt; STM m (Summary (HardForkIndices blk))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk -&gt; STM m (ExtLedgerState blk)
forall (m :: * -&gt; *) blk.
(Monad (STM m), IsLedger (LedgerState blk)) =&gt;
ChainDB m blk -&gt; STM m (ExtLedgerState blk)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.html#getCurrentLedger"><span class="hs-identifier hs-var">ChainDB.getCurrentLedger</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDB m blk
</span><a href="#local-6989586621679915612"><span class="hs-identifier hs-var">chainDB</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679915634"><span class="annot"><span class="annottext">slotForgeTime :: RealPoint blk -&gt; STM m UTCTime
</span><a href="#local-6989586621679915634"><span class="hs-identifier hs-var hs-var">slotForgeTime</span></a></span></span><span> </span><span id="local-6989586621679915635"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679915635"><span class="hs-identifier hs-var">rp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-86"></span><span>              </span><span class="annot"><span class="annottext">(Either PastHorizonException RelativeTime -&gt; UTCTime)
-&gt; STM m (Either PastHorizonException RelativeTime)
-&gt; STM m UTCTime
forall a b. (a -&gt; b) -&gt; STM m a -&gt; STM m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span>
</span><span id="line-87"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PastHorizonException -&gt; UTCTime)
-&gt; (RelativeTime -&gt; UTCTime)
-&gt; Either PastHorizonException RelativeTime
-&gt; UTCTime
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#either"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="annot"><span class="annottext">PastHorizonException -&gt; UTCTime
forall {a} {a}. Show a =&gt; a -&gt; a
</span><a href="#local-6989586621679915637"><span class="hs-identifier hs-var">errMsg</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeTime -&gt; UTCTime
</span><a href="#local-6989586621679915638"><span class="hs-identifier hs-var">toAbsolute</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>            </span><span class="annot"><span class="annottext">(STM m (Either PastHorizonException RelativeTime) -&gt; STM m UTCTime)
-&gt; STM m (Either PastHorizonException RelativeTime)
-&gt; STM m UTCTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RunWithCachedSummary (HardForkIndices blk) m
-&gt; forall a. Qry a -&gt; STM m (Either PastHorizonException a)
forall (xs :: [*]) (m :: * -&gt; *).
RunWithCachedSummary xs m
-&gt; forall a. Qry a -&gt; STM m (Either PastHorizonException a)
</span><a href="Ouroboros.Consensus.HardFork.History.Caching.html#cachedRunQuery"><span class="hs-identifier hs-var">History.cachedRunQuery</span></a></span><span>
</span><span id="line-89"></span><span>                </span><span class="annot"><span class="annottext">RunWithCachedSummary (HardForkIndices blk) m
</span><a href="#local-6989586621679915613"><span class="hs-identifier hs-var">cache</span></a></span><span>
</span><span id="line-90"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RelativeTime, SlotLength) -&gt; RelativeTime
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span> </span><span class="annot"><span class="annottext">((RelativeTime, SlotLength) -&gt; RelativeTime)
-&gt; Qry (RelativeTime, SlotLength) -&gt; Qry RelativeTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Qry (RelativeTime, SlotLength)
</span><a href="Ouroboros.Consensus.HardFork.History.Qry.html#slotToWallclock"><span class="hs-identifier hs-var">History.slotToWallclock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RealPoint blk -&gt; SlotNo
forall blk. RealPoint blk -&gt; SlotNo
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#realPointSlot"><span class="hs-identifier hs-var">realPointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679915635"><span class="hs-identifier hs-var">rp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-92"></span><span>            </span><span class="hs-comment">-- This @cachedRunQuery@ fail for the following reasons.</span><span>
</span><span id="line-93"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-94"></span><span>            </span><span class="hs-comment">-- By the PRECONDITIONs documented in the 'headerForgeUTCTime', we</span><span>
</span><span id="line-95"></span><span>            </span><span class="hs-comment">-- can assume that the given header was validated by the ChainSync</span><span>
</span><span id="line-96"></span><span>            </span><span class="hs-comment">-- client. This means its slot was, at some point, within the ledger</span><span>
</span><span id="line-97"></span><span>            </span><span class="hs-comment">-- view forecast range of the ledger state of our contemporary</span><span>
</span><span id="line-98"></span><span>            </span><span class="hs-comment">-- intersection with the header itself (and that intersection</span><span>
</span><span id="line-99"></span><span>            </span><span class="hs-comment">-- extended our contemporary immutable tip). A few additional facts</span><span>
</span><span id="line-100"></span><span>            </span><span class="hs-comment">-- ensure that we will always be able to thereafter correctly</span><span>
</span><span id="line-101"></span><span>            </span><span class="hs-comment">-- convert that header's slot using our current chain's ledger</span><span>
</span><span id="line-102"></span><span>            </span><span class="hs-comment">-- state.</span><span>
</span><span id="line-103"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-104"></span><span>            </span><span class="hs-comment">--   o For under-developed reasons, the ledger view forecast range</span><span>
</span><span id="line-105"></span><span>            </span><span class="hs-comment">--     is equivalent to the time forecast range, ie &quot; Definition</span><span>
</span><span id="line-106"></span><span>            </span><span class="hs-comment">--     17.2 (Forecast range) &quot; from The Consensus Report.</span><span>
</span><span id="line-107"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span>            </span><span class="hs-comment">--   o Because rollback is bounded, our currently selected chain</span><span>
</span><span id="line-109"></span><span>            </span><span class="hs-comment">--     will always be an evolution (ie &quot; switch(n, bs) &quot;) of that</span><span>
</span><span id="line-110"></span><span>            </span><span class="hs-comment">--     intersection point. (This one is somewhat obvious in</span><span>
</span><span id="line-111"></span><span>            </span><span class="hs-comment">--     retrospect, but we're being explicit here in order to</span><span>
</span><span id="line-112"></span><span>            </span><span class="hs-comment">--     emphasize the relation to the &quot; chain evolution &quot; jargon.)</span><span>
</span><span id="line-113"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span>            </span><span class="hs-comment">--   o Because &quot; stability itself is stable &quot;, the HFC satisfies &quot;</span><span>
</span><span id="line-115"></span><span>            </span><span class="hs-comment">--     Property 17.3 (Time conversions stable under chain evolution)</span><span>
</span><span id="line-116"></span><span>            </span><span class="hs-comment">--     &quot; from The Consensus Report.</span><span>
</span><span id="line-117"></span><span>            </span><span id="local-6989586621679915637"><span class="annot"><span class="annottext">errMsg :: a -&gt; a
</span><a href="#local-6989586621679915637"><span class="hs-identifier hs-var hs-var">errMsg</span></a></span></span><span> </span><span id="local-6989586621679915661"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679915661"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-118"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; a
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; a) -&gt; [Char] -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-119"></span><span>                 </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Consensus could not determine forge UTCTime!&quot;</span></span><span>
</span><span id="line-120"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679915635"><span class="hs-identifier hs-var">rp</span></a></span><span>
</span><span id="line-121"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679915661"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="annottext">SlotForgeTimeOracle m blk -&gt; m (SlotForgeTimeOracle m blk)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">SlotForgeTimeOracle m blk
forall {blk}. StandardHash blk =&gt; RealPoint blk -&gt; STM m UTCTime
</span><a href="#local-6989586621679915634"><span class="hs-identifier hs-var">slotForgeTime</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="#local-6989586621679915615"><span class="hs-identifier hs-type">toSummary</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-125"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Ledger.Extended.html#ExtLedgerState"><span class="hs-identifier hs-type">ExtLedgerState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.HardFork.History.Summary.html#Summary"><span class="hs-identifier hs-type">History.Summary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.HardFork.Abstract.html#HardForkIndices"><span class="hs-identifier hs-type">History.HardForkIndices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915406"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621679915615"><span class="annot"><span class="annottext">toSummary :: ExtLedgerState blk -&gt; Summary (HardForkIndices blk)
</span><a href="#local-6989586621679915615"><span class="hs-identifier hs-var hs-var">toSummary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LedgerConfig blk
-&gt; LedgerState blk -&gt; Summary (HardForkIndices blk)
forall blk.
HasHardForkHistory blk =&gt;
LedgerConfig blk
-&gt; LedgerState blk -&gt; Summary (HardForkIndices blk)
</span><a href="Ouroboros.Consensus.HardFork.Abstract.html#hardForkSummary"><span class="hs-identifier hs-var">History.hardForkSummary</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; LedgerConfig blk
forall blk. TopLevelConfig blk -&gt; LedgerConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configLedger"><span class="hs-identifier hs-var">configLedger</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679915611"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LedgerState blk -&gt; Summary (HardForkIndices blk))
-&gt; (ExtLedgerState blk -&gt; LedgerState blk)
-&gt; ExtLedgerState blk
-&gt; Summary (HardForkIndices blk)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ExtLedgerState blk -&gt; LedgerState blk
forall blk. ExtLedgerState blk -&gt; LedgerState blk
</span><a href="Ouroboros.Consensus.Ledger.Extended.html#ledgerState"><span class="hs-identifier hs-var">ledgerState</span></a></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><a href="#local-6989586621679915638"><span class="hs-identifier hs-type">toAbsolute</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RelativeTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.UTCTime.html#UTCTime"><span class="hs-identifier hs-type">UTCTime</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span id="local-6989586621679915638"><span class="annot"><span class="annottext">toAbsolute :: RelativeTime -&gt; UTCTime
</span><a href="#local-6989586621679915638"><span class="hs-identifier hs-var hs-var">toAbsolute</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="annottext">SystemStart -&gt; RelativeTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">fromRelativeTime</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk -&gt; SystemStart
forall blk.
ConfigSupportsNode blk =&gt;
BlockConfig blk -&gt; SystemStart
</span><a href="Ouroboros.Consensus.Config.SupportsNode.html#getSystemStart"><span class="hs-identifier hs-var">SupportsNode.getSystemStart</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TopLevelConfig blk -&gt; BlockConfig blk
forall blk. TopLevelConfig blk -&gt; BlockConfig blk
</span><a href="Ouroboros.Consensus.Config.html#configBlock"><span class="hs-identifier hs-var">configBlock</span></a></span><span> </span><span class="annot"><span class="annottext">TopLevelConfig blk
</span><a href="#local-6989586621679915611"><span class="hs-identifier hs-var">cfg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span id="local-6989586621679915492"><span id="local-6989586621679915493"><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#readFetchModeDefault"><span class="hs-identifier hs-type">readFetchModeDefault</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-134"></span><span>     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915492"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679915493"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.BlockchainTime.API.html#BlockchainTime"><span class="hs-identifier hs-type">BlockchainTime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915492"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679915493"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915492"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span></span></span><span>
</span><span id="line-138"></span><span id="readFetchModeDefault"><span class="annot"><span class="annottext">readFetchModeDefault :: forall (m :: * -&gt; *) blk.
(MonadSTM m, HasHeader blk) =&gt;
BlockchainTime m -&gt; STM m (AnchoredFragment blk) -&gt; STM m FetchMode
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#readFetchModeDefault"><span class="hs-identifier hs-var hs-var">readFetchModeDefault</span></a></span></span><span> </span><span id="local-6989586621679915684"><span class="annot"><span class="annottext">BlockchainTime m
</span><a href="#local-6989586621679915684"><span class="hs-identifier hs-var">btime</span></a></span></span><span> </span><span id="local-6989586621679915685"><span class="annot"><span class="annottext">STM m (AnchoredFragment blk)
</span><a href="#local-6989586621679915685"><span class="hs-identifier hs-var">getCurrentChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-139"></span><span>    </span><span id="local-6989586621679915686"><span class="annot"><span class="annottext">CurrentSlot
</span><a href="#local-6989586621679915686"><span class="hs-identifier hs-var">mCurSlot</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockchainTime m -&gt; STM m CurrentSlot
forall (m :: * -&gt; *). BlockchainTime m -&gt; STM m CurrentSlot
</span><a href="Ouroboros.Consensus.BlockchainTime.API.html#getCurrentSlot"><span class="hs-identifier hs-var">getCurrentSlot</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainTime m
</span><a href="#local-6989586621679915684"><span class="hs-identifier hs-var">btime</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CurrentSlot
</span><a href="#local-6989586621679915686"><span class="hs-identifier hs-var">mCurSlot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-comment">-- The current chain's tip far away from &quot;now&quot;, so use bulk sync mode.</span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">CurrentSlot
</span><a href="Ouroboros.Consensus.BlockchainTime.API.html#CurrentSlotUnknown"><span class="hs-identifier hs-var">CurrentSlotUnknown</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FetchMode -&gt; STM m FetchMode
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.BlockchainTime.API.html#CurrentSlot"><span class="hs-identifier hs-type">CurrentSlot</span></a></span><span> </span><span id="local-6989586621679915691"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679915691"><span class="hs-identifier hs-var">curSlot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>        </span><span id="local-6989586621679915692"><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><a href="#local-6989586621679915692"><span class="hs-identifier hs-var">curChainSlot</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment blk -&gt; WithOrigin SlotNo
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; WithOrigin SlotNo
</span><span class="hs-identifier hs-var">AF.headSlot</span></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment blk -&gt; WithOrigin SlotNo)
-&gt; STM m (AnchoredFragment blk) -&gt; STM m (WithOrigin SlotNo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment blk)
</span><a href="#local-6989586621679915685"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679915698"><span class="annot"><span class="annottext">slotsBehind :: Word64
</span><a href="#local-6989586621679915698"><span class="hs-identifier hs-var hs-var">slotsBehind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><a href="#local-6989586621679915692"><span class="hs-identifier hs-var">curChainSlot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-146"></span><span>              </span><span class="hs-comment">-- There's nothing in the chain. If the current slot is 0, then</span><span>
</span><span id="line-147"></span><span>              </span><span class="hs-comment">-- we're 1 slot behind.</span><span>
</span><span id="line-148"></span><span>              </span><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><span class="hs-identifier hs-var">Origin</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Word64
</span><span class="hs-identifier hs-var">unSlotNo</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679915691"><span class="hs-identifier hs-var">curSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span>
</span><span id="line-149"></span><span>              </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621679915703"><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679915703"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Word64
</span><span class="hs-identifier hs-var">unSlotNo</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679915691"><span class="hs-identifier hs-var">curSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; Word64
</span><span class="hs-identifier hs-var">unSlotNo</span></span><span> </span><span class="annot"><span class="annottext">SlotNo
</span><a href="#local-6989586621679915703"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-150"></span><span>            </span><span id="local-6989586621679915705"><span class="annot"><span class="annottext">maxSlotsBehind :: Word64
</span><a href="#local-6989586621679915705"><span class="hs-identifier hs-var hs-var">maxSlotsBehind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1000</span></span><span>
</span><span id="line-151"></span><span>        </span><span class="annot"><span class="annottext">FetchMode -&gt; STM m FetchMode
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchMode -&gt; STM m FetchMode) -&gt; FetchMode -&gt; STM m FetchMode
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679915698"><span class="hs-identifier hs-var">slotsBehind</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679915705"><span class="hs-identifier hs-var">maxSlotsBehind</span></a></span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-comment">-- When the current chain is near to &quot;now&quot;, use deadline mode,</span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-comment">-- when it is far away, use bulk sync mode.</span><span>
</span><span id="line-154"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeDeadline</span></span><span>
</span><span id="line-155"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#mkBlockFetchConsensusInterface"><span class="hs-identifier hs-type">mkBlockFetchConsensusInterface</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-158"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679915505"><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679915507"><span class="annot"><a href="#local-6989586621679915507"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679915506"><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-159"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-160"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#BlockSupportsProtocol"><span class="hs-identifier hs-type">BlockSupportsProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-161"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockConfig"><span class="hs-identifier hs-type">BlockConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#ChainDbView"><span class="hs-identifier hs-type">ChainDbView</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915507"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#SlotForgeTimeOracle"><span class="hs-identifier hs-type">SlotForgeTimeOracle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-167"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ Slot forge time, see 'headerForgeUTCTime' and 'blockForgeUTCTime'.</span></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span>
</span><span id="line-169"></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ See 'readFetchMode'.</span></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></span><span> </span><span class="annot"><a href="#local-6989586621679915507"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-171"></span><span id="mkBlockFetchConsensusInterface"><span class="annot"><span class="annottext">mkBlockFetchConsensusInterface :: forall (m :: * -&gt; *) peer blk.
(IOLike m, BlockSupportsProtocol blk) =&gt;
BlockConfig blk
-&gt; ChainDbView m blk
-&gt; STM m (Map peer (AnchoredFragment (Header blk)))
-&gt; (Header blk -&gt; SizeInBytes)
-&gt; SlotForgeTimeOracle m blk
-&gt; STM m FetchMode
-&gt; BlockFetchConsensusInterface peer (Header blk) blk m
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#mkBlockFetchConsensusInterface"><span class="hs-identifier hs-var hs-var">mkBlockFetchConsensusInterface</span></a></span></span><span>
</span><span id="line-172"></span><span>  </span><span id="local-6989586621679915789"><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679915789"><span class="hs-identifier hs-var">bcfg</span></a></span></span><span> </span><span id="local-6989586621679915790"><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679915790"><span class="hs-identifier hs-var">chainDB</span></a></span></span><span> </span><span id="local-6989586621679915791"><span class="annot"><span class="annottext">STM m (Map peer (AnchoredFragment (Header blk)))
</span><a href="#local-6989586621679915791"><span class="hs-identifier hs-var">getCandidates</span></a></span></span><span> </span><span id="local-6989586621679915792"><span class="annot"><span class="annottext">Header blk -&gt; SizeInBytes
</span><a href="#local-6989586621679915792"><span class="hs-identifier hs-var">blockFetchSize</span></a></span></span><span> </span><span id="local-6989586621679915793"><span class="annot"><span class="annottext">SlotForgeTimeOracle m blk
</span><a href="#local-6989586621679915793"><span class="hs-identifier hs-var">slotForgeTime</span></a></span></span><span> </span><span id="local-6989586621679915794"><span class="annot"><span class="annottext">STM m FetchMode
</span><a href="#local-6989586621679915794"><span class="hs-identifier hs-var">readFetchMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">STM m (Map peer (AnchoredFragment (Header blk)))
STM m MaxSlotNo
STM m (AnchoredFragment (Header blk))
STM m FetchMode
STM m (Point blk -&gt; Bool)
HasCallStack =&gt;
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Bool
HasCallStack =&gt;
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Ordering
WhetherReceivingTentativeBlocks -&gt; STM m (Point blk -&gt; blk -&gt; m ())
Header blk -&gt; SizeInBytes
Header blk -&gt; blk -&gt; Bool
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Bool
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Ordering
FromConsensus blk -&gt; STM m UTCTime
FromConsensus (Header blk) -&gt; STM m UTCTime
headerForgeUTCTime :: FromConsensus (Header blk) -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus blk -&gt; STM m UTCTime
readFetchMode :: STM m FetchMode
blockFetchSize :: Header blk -&gt; SizeInBytes
readFetchMode :: STM m FetchMode
blockMatchesHeader :: Header blk -&gt; blk -&gt; Bool
readCandidateChains :: STM m (Map peer (AnchoredFragment (Header blk)))
readCurrentChain :: STM m (AnchoredFragment (Header blk))
readFetchedBlocks :: STM m (Point blk -&gt; Bool)
mkAddFetchedBlock :: WhetherReceivingTentativeBlocks -&gt; STM m (Point blk -&gt; blk -&gt; m ())
readFetchedMaxSlotNo :: STM m MaxSlotNo
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Bool
compareCandidateChains :: AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Ordering
headerForgeUTCTime :: FromConsensus (Header blk) -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus blk -&gt; STM m UTCTime
blockFetchSize :: Header blk -&gt; SizeInBytes
blockMatchesHeader :: Header blk -&gt; blk -&gt; Bool
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Ordering
mkAddFetchedBlock :: WhetherReceivingTentativeBlocks -&gt; STM m (Point blk -&gt; blk -&gt; m ())
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Bool
readCandidateChains :: STM m (Map peer (AnchoredFragment (Header blk)))
readCurrentChain :: STM m (AnchoredFragment (Header blk))
readFetchedBlocks :: STM m (Point blk -&gt; Bool)
readFetchedMaxSlotNo :: STM m MaxSlotNo
</span><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="#local-6989586621679915795"><span class="hs-identifier hs-type">blockMatchesHeader</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span id="local-6989586621679915795"><span class="annot"><span class="annottext">blockMatchesHeader :: Header blk -&gt; blk -&gt; Bool
</span><a href="#local-6989586621679915795"><span class="hs-identifier hs-var hs-var">blockMatchesHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; blk -&gt; Bool
forall blk. GetHeader blk =&gt; Header blk -&gt; blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Block.Abstract.html#blockMatchesHeader"><span class="hs-identifier hs-var">Block.blockMatchesHeader</span></a></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><a href="#local-6989586621679915796"><span class="hs-identifier hs-type">readCandidateChains</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915507"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621679915796"><span class="annot"><span class="annottext">readCandidateChains :: STM m (Map peer (AnchoredFragment (Header blk)))
</span><a href="#local-6989586621679915796"><span class="hs-identifier hs-var hs-var">readCandidateChains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (Map peer (AnchoredFragment (Header blk)))
</span><a href="#local-6989586621679915791"><span class="hs-identifier hs-var">getCandidates</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="#local-6989586621679915797"><span class="hs-identifier hs-type">readCurrentChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621679915797"><span class="annot"><span class="annottext">readCurrentChain :: STM m (AnchoredFragment (Header blk))
</span><a href="#local-6989586621679915797"><span class="hs-identifier hs-var hs-var">readCurrentChain</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (AnchoredFragment (Header blk))
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getCurrentChain"><span class="hs-identifier hs-var">getCurrentChain</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679915790"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><a href="#local-6989586621679915798"><span class="hs-identifier hs-type">readFetchedBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621679915798"><span class="annot"><span class="annottext">readFetchedBlocks :: STM m (Point blk -&gt; Bool)
</span><a href="#local-6989586621679915798"><span class="hs-identifier hs-var hs-var">readFetchedBlocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk -&gt; STM m (Point blk -&gt; Bool)
forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; STM m (Point blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getIsFetched"><span class="hs-identifier hs-var">getIsFetched</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679915790"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- See 'mkAddFetchedBlock_'</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="#local-6989586621679915799"><span class="hs-identifier hs-type">mkAddFetchedBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-189"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">WhetherReceivingTentativeBlocks</span></span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621679915799"><span class="annot"><span class="annottext">mkAddFetchedBlock :: WhetherReceivingTentativeBlocks -&gt; STM m (Point blk -&gt; blk -&gt; m ())
</span><a href="#local-6989586621679915799"><span class="hs-identifier hs-var hs-var">mkAddFetchedBlock</span></a></span></span><span> </span><span id="local-6989586621679915818"><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><a href="#local-6989586621679915818"><span class="hs-identifier hs-var">enabledPipelining</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>      </span><span id="local-6989586621679915819"><span class="annot"><span class="annottext">SelectView (BlockProtocol blk)
-&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m
</span><a href="#local-6989586621679915819"><span class="hs-identifier hs-var">unlessImproved</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Proxy blk
-&gt; STM
     m
     (SelectView (BlockProtocol blk)
      -&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m)
forall (proxy :: * -&gt; *) (m :: * -&gt; *) blk.
(IOLike m, NoThunks (SelectView (BlockProtocol blk)),
 Ord (SelectView (BlockProtocol blk))) =&gt;
proxy blk
-&gt; STM
     m
     (SelectView (BlockProtocol blk)
      -&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#mkUnlessImproved"><span class="hs-identifier hs-var">InvalidBlockPunishment.mkUnlessImproved</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">(Point blk -&gt; blk -&gt; m ()) -&gt; STM m (Point blk -&gt; blk -&gt; m ())
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">((Point blk -&gt; blk -&gt; m ()) -&gt; STM m (Point blk -&gt; blk -&gt; m ()))
-&gt; (Point blk -&gt; blk -&gt; m ()) -&gt; STM m (Point blk -&gt; blk -&gt; m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(SelectView (BlockProtocol blk)
 -&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m)
-&gt; WhetherReceivingTentativeBlocks -&gt; Point blk -&gt; blk -&gt; m ()
</span><a href="#local-6989586621679915822"><span class="hs-identifier hs-var">mkAddFetchedBlock_</span></a></span><span> </span><span class="annot"><span class="annottext">SelectView (BlockProtocol blk)
-&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m
</span><a href="#local-6989586621679915819"><span class="hs-identifier hs-var">unlessImproved</span></a></span><span> </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><a href="#local-6989586621679915818"><span class="hs-identifier hs-var">enabledPipelining</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-comment">-- Waits until the block has been written to disk, but not until chain</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">-- selection has processed the block.</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="#local-6989586621679915822"><span class="hs-identifier hs-type">mkAddFetchedBlock_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-198"></span><span>         </span><span class="hs-special">(</span><span>   </span><span class="annot"><a href="Ouroboros.Consensus.Protocol.Abstract.html#SelectView"><span class="hs-identifier hs-type">SelectView</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#BlockProtocol"><span class="hs-identifier hs-type">BlockProtocol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier hs-type">InvalidBlockPunishment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-200"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#InvalidBlockPunishment"><span class="hs-identifier hs-type">InvalidBlockPunishment</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-201"></span><span>         </span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WhetherReceivingTentativeBlocks</span></span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621679915822"><span class="annot"><span class="annottext">mkAddFetchedBlock_ :: (SelectView (BlockProtocol blk)
 -&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m)
-&gt; WhetherReceivingTentativeBlocks -&gt; Point blk -&gt; blk -&gt; m ()
</span><a href="#local-6989586621679915822"><span class="hs-identifier hs-var hs-var">mkAddFetchedBlock_</span></a></span></span><span> </span><span id="local-6989586621679915823"><span class="annot"><span class="annottext">SelectView (BlockProtocol blk)
-&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m
</span><a href="#local-6989586621679915823"><span class="hs-identifier hs-var">unlessImproved</span></a></span></span><span> </span><span id="local-6989586621679915824"><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><a href="#local-6989586621679915824"><span class="hs-identifier hs-var">enabledPipelining</span></a></span></span><span> </span><span id="local-6989586621679915825"><span class="annot"><span class="annottext">Point blk
</span><a href="#local-6989586621679915825"><span class="hs-identifier hs-var">_pt</span></a></span></span><span> </span><span id="local-6989586621679915826"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679915826"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; m ()) -&gt; m Bool -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>       </span><span id="local-6989586621679915828"><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679915828"><span class="hs-identifier hs-var">disconnect</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (InvalidBlockPunishment m)
forall (m :: * -&gt; *). IOLike m =&gt; m (InvalidBlockPunishment m)
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#mkPunishThisThread"><span class="hs-identifier hs-var">InvalidBlockPunishment.mkPunishThisThread</span></a></span><span>
</span><span id="line-208"></span><span>       </span><span class="hs-comment">-- A BlockFetch peer can either send an entire range or none of the</span><span>
</span><span id="line-209"></span><span>       </span><span class="hs-comment">-- range; anything else will incur a disconnect. And in 'FetchDeadline'</span><span>
</span><span id="line-210"></span><span>       </span><span class="hs-comment">-- mode, which is the relevant case for this kind of DoS attack (because</span><span>
</span><span id="line-211"></span><span>       </span><span class="hs-comment">-- in bulk sync, our honest peers will be streaming a very dense chain</span><span>
</span><span id="line-212"></span><span>       </span><span class="hs-comment">-- very quickly, meaning the adversary only has very small windows during</span><span>
</span><span id="line-213"></span><span>       </span><span class="hs-comment">-- which we're interested in its chains), the node only requests whole</span><span>
</span><span id="line-214"></span><span>       </span><span class="hs-comment">-- suffixes from peers: the BlockFetch decision logic does not avoid</span><span>
</span><span id="line-215"></span><span>       </span><span class="hs-comment">-- requesting a block that is already in-flight from other peers. Thus</span><span>
</span><span id="line-216"></span><span>       </span><span class="hs-comment">-- the adversary cannot send us blocks out-of-order (during</span><span>
</span><span id="line-217"></span><span>       </span><span class="hs-comment">-- 'FetchDeadline'), even if they control more than one of our peers.</span><span>
</span><span id="line-218"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span>       </span><span class="hs-comment">-- Therefore, the following punishment logic only needs to cover the</span><span>
</span><span id="line-220"></span><span>       </span><span class="hs-comment">-- &quot;whole chain received in-order from a single-peer&quot; case. Which it</span><span>
</span><span id="line-221"></span><span>       </span><span class="hs-comment">-- currently does.</span><span>
</span><span id="line-222"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-223"></span><span>       </span><span class="hs-comment">-- TODO maintain the context of which ChainSync candidate incurring this</span><span>
</span><span id="line-224"></span><span>       </span><span class="hs-comment">-- fetch request, and disconnect immediately if the invalid block is not</span><span>
</span><span id="line-225"></span><span>       </span><span class="hs-comment">-- the tip of that candidate. As-is, in 'FetchDeadline' they must also</span><span>
</span><span id="line-226"></span><span>       </span><span class="hs-comment">-- send the next block, but they might be able to wait long enough that</span><span>
</span><span id="line-227"></span><span>       </span><span class="hs-comment">-- it is not desirable when it arrives, and therefore not be disconnected</span><span>
</span><span id="line-228"></span><span>       </span><span class="hs-comment">-- from. So their choices are: cause a disconnect or else do nothing for</span><span>
</span><span id="line-229"></span><span>       </span><span class="hs-comment">-- long enough. Both are fine by us, from a DoS mitigation perspective.</span><span>
</span><span id="line-230"></span><span>       </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679915898"><span class="annot"><span class="annottext">punishment :: InvalidBlockPunishment m
</span><a href="#local-6989586621679915898"><span class="hs-identifier hs-var hs-var">punishment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Invalidity -&gt; InvalidBlockPunishment m)
-&gt; InvalidBlockPunishment m
forall (m :: * -&gt; *).
(Invalidity -&gt; InvalidBlockPunishment m)
-&gt; InvalidBlockPunishment m
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#branch"><span class="hs-identifier hs-var">InvalidBlockPunishment.branch</span></a></span><span> </span><span class="annot"><span class="annottext">((Invalidity -&gt; InvalidBlockPunishment m)
 -&gt; InvalidBlockPunishment m)
-&gt; (Invalidity -&gt; InvalidBlockPunishment m)
-&gt; InvalidBlockPunishment m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-231"></span><span>             </span><span class="hs-comment">-- invalid parents always cause a disconnect</span><span>
</span><span id="line-232"></span><span>             </span><span class="annot"><span class="annottext">Invalidity
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#BlockPrefix"><span class="hs-identifier hs-var">InvalidBlockPunishment.BlockPrefix</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679915828"><span class="hs-identifier hs-var">disconnect</span></a></span><span>
</span><span id="line-233"></span><span>             </span><span class="hs-comment">-- when pipelining, we forgive an invalid block itself if it's</span><span>
</span><span id="line-234"></span><span>             </span><span class="hs-comment">-- better than the previous invalid block this peer delivered</span><span>
</span><span id="line-235"></span><span>             </span><span class="annot"><span class="annottext">Invalidity
</span><a href="Ouroboros.Consensus.Storage.ChainDB.API.Types.InvalidBlockPunishment.html#BlockItself"><span class="hs-identifier hs-var">InvalidBlockPunishment.BlockItself</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><a href="#local-6989586621679915824"><span class="hs-identifier hs-var">enabledPipelining</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>               </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">NotReceivingTentativeBlocks</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679915828"><span class="hs-identifier hs-var">disconnect</span></a></span><span>
</span><span id="line-237"></span><span>               </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><span class="hs-identifier hs-var">ReceivingTentativeBlocks</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>                 </span><span class="annot"><span class="annottext">SelectView (BlockProtocol blk)
-&gt; InvalidBlockPunishment m -&gt; InvalidBlockPunishment m
</span><a href="#local-6989586621679915823"><span class="hs-identifier hs-var">unlessImproved</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
forall blk.
BlockSupportsProtocol blk =&gt;
BlockConfig blk -&gt; Header blk -&gt; SelectView (BlockProtocol blk)
</span><a href="Ouroboros.Consensus.Block.SupportsProtocol.html#selectView"><span class="hs-identifier hs-var">selectView</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679915789"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; Header blk
forall blk. GetHeader blk =&gt; blk -&gt; Header blk
</span><a href="Ouroboros.Consensus.Block.Abstract.html#getHeader"><span class="hs-identifier hs-var">getHeader</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679915826"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679915828"><span class="hs-identifier hs-var">disconnect</span></a></span><span>
</span><span id="line-239"></span><span>       </span><span class="annot"><span class="annottext">ChainDbView m blk -&gt; InvalidBlockPunishment m -&gt; blk -&gt; m Bool
forall (m :: * -&gt; *) blk.
ChainDbView m blk -&gt; InvalidBlockPunishment m -&gt; blk -&gt; m Bool
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#addBlockWaitWrittenToDisk"><span class="hs-identifier hs-var">addBlockWaitWrittenToDisk</span></a></span><span>
</span><span id="line-240"></span><span>         </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679915790"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-241"></span><span>         </span><span class="annot"><span class="annottext">InvalidBlockPunishment m
</span><a href="#local-6989586621679915898"><span class="hs-identifier hs-var">punishment</span></a></span><span>
</span><span id="line-242"></span><span>         </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679915826"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><a href="#local-6989586621679915800"><span class="hs-identifier hs-type">readFetchedMaxSlotNo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679915505"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-245"></span><span>    </span><span id="local-6989586621679915800"><span class="annot"><span class="annottext">readFetchedMaxSlotNo :: STM m MaxSlotNo
</span><a href="#local-6989586621679915800"><span class="hs-identifier hs-var hs-var">readFetchedMaxSlotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk -&gt; STM m MaxSlotNo
forall (m :: * -&gt; *) blk. ChainDbView m blk -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.html#getMaxSlotNo"><span class="hs-identifier hs-var">getMaxSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChainDbView m blk
</span><a href="#local-6989586621679915790"><span class="hs-identifier hs-var">chainDB</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-comment">-- Note that @ours@ comes from the ChainDB and @cand@ from the ChainSync</span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-comment">-- client.</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">-- Fragments are proxies for their corresponding chains; it is possible, in</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- principle, that an empty fragment corresponds to the chain we want to</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-comment">-- adopt, and should therefore be preferred over other fragments (whose</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- blocks we therefore do not want to download). The precondition to</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-comment">-- 'preferAnchoredCandidates' is designed precisely to rule out this</span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-comment">-- possibility (for details, see the Consensus Report), but unfortunately we</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-comment">-- cannot always satisfy this precondition: although the chain sync client</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-comment">-- preserves an invariant that relates our current chain to the candidate</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- fragment, by the time the block fetch download logic considers the</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-comment">-- fragment, our current chain might have changed.</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><a href="#local-6989586621679915801"><span class="hs-identifier hs-type">plausibleCandidateChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-261"></span><span>                            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span id="local-6989586621679915801"><span class="annot"><span class="annottext">plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Bool
</span><a href="#local-6989586621679915801"><span class="hs-identifier hs-var hs-var">plausibleCandidateChain</span></a></span></span><span> </span><span id="local-6989586621679915919"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915919"><span class="hs-identifier hs-var">ours</span></a></span></span><span> </span><span id="local-6989586621679915920"><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915920"><span class="hs-identifier hs-var">cand</span></a></span></span><span>
</span><span id="line-265"></span><span>      </span><span class="hs-comment">-- 1. The ChainDB maintains the invariant that the anchor of our fragment</span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-comment">--    corresponds to the immutable tip.</span><span>
</span><span id="line-267"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-268"></span><span>      </span><span class="hs-comment">-- 2. The ChainSync client locally maintains the invariant that our</span><span>
</span><span id="line-269"></span><span>      </span><span class="hs-comment">--    fragment and the candidate fragment have the same anchor point. This</span><span>
</span><span id="line-270"></span><span>      </span><span class="hs-comment">--    establishes the precondition required by @preferAnchoredCandidate@.</span><span>
</span><span id="line-271"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-comment">-- 3. However, by the time that the BlockFetch logic processes a fragment</span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-comment">--    presented to it by the ChainSync client, our current fragment might</span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-comment">--    have changed, and they might no longer be anchored at the same</span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-comment">--    point. This means that we are no longer guaranteed that the</span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-comment">--    precondition holds.</span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-comment">-- 4. Our chain's anchor can only move forward. We can detect this by</span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-comment">--    looking at the block numbers of the anchors.</span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-281"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block. AnchoredFragment block -&gt; WithOrigin BlockNo
</span><span class="hs-identifier hs-var">AF.anchorBlockNo</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915920"><span class="hs-identifier hs-var">cand</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin BlockNo -&gt; WithOrigin BlockNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; WithOrigin BlockNo
forall block. AnchoredFragment block -&gt; WithOrigin BlockNo
</span><span class="hs-identifier hs-var">AF.anchorBlockNo</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915919"><span class="hs-identifier hs-var">ours</span></a></span><span>  </span><span class="hs-comment">-- (4)</span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Bool
forall v a b. AnchoredSeq v a b -&gt; Bool
</span><span class="hs-identifier hs-var">AF.null</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915919"><span class="hs-identifier hs-var">ours</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk) -&gt; Bool
forall v a b. AnchoredSeq v a b -&gt; Bool
</span><span class="hs-identifier hs-var">AF.null</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915920"><span class="hs-identifier hs-var">cand</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-283"></span><span>          </span><span class="hs-comment">-- Both are non-empty, the precondition trivially holds.</span><span>
</span><span id="line-284"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679915789"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915919"><span class="hs-identifier hs-var">ours</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915920"><span class="hs-identifier hs-var">cand</span></a></span><span>
</span><span id="line-285"></span><span>          </span><span class="hs-comment">-- The candidate is shorter than our chain and, worse, we'd have to</span><span>
</span><span id="line-286"></span><span>          </span><span class="hs-comment">-- roll back past our immutable tip (the anchor of @cand@).</span><span>
</span><span id="line-287"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>     </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-288"></span><span>          </span><span class="hs-comment">-- As argued above we can only reach this case when our chain's anchor</span><span>
</span><span id="line-289"></span><span>          </span><span class="hs-comment">-- has changed (4).</span><span>
</span><span id="line-290"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-291"></span><span>          </span><span class="hs-comment">-- It is impossible for our chain to change /and/ still be empty: the</span><span>
</span><span id="line-292"></span><span>          </span><span class="hs-comment">-- anchor of our chain only changes when a new block becomes</span><span>
</span><span id="line-293"></span><span>          </span><span class="hs-comment">-- immutable. For a new block to become immutable, we must have</span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-comment">-- extended our chain with at least @k + 1@ blocks. Which means our</span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-comment">-- fragment can't be empty.</span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Bool
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;impossible&quot;</span></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>      </span><span class="hs-comment">-- The precondition of 'compareAnchoredFragments' is that both fragments</span><span>
</span><span id="line-299"></span><span>      </span><span class="hs-comment">-- are non-empty or they intersect. We are mostly satisfying that</span><span>
</span><span id="line-300"></span><span>      </span><span class="hs-comment">-- precondition, but there is a corner case when considering EBBs where we</span><span>
</span><span id="line-301"></span><span>      </span><span class="hs-comment">-- don't. Either our fragment or the candidate fragment could be anchored</span><span>
</span><span id="line-302"></span><span>      </span><span class="hs-comment">-- at an EBB that shares the block number with the anchor of the other, in</span><span>
</span><span id="line-303"></span><span>      </span><span class="hs-comment">-- which case the two fragments are not guaranteed to intersect. This can</span><span>
</span><span id="line-304"></span><span>      </span><span class="hs-comment">-- happen even if one of the two fragments is empty while the other is</span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-comment">-- non-empty.</span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-comment">-- For example, consider an EBB @B@ that shares the block number with its</span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-comment">-- predecessor @A. Consider two fragments @f1 = B ] C@ and @f2 = A ]@.</span><span>
</span><span id="line-309"></span><span>      </span><span class="hs-comment">-- @f1@ is anchored at @B@, @f2@ is anchored at @A@. @f1@ and @f2@ will</span><span>
</span><span id="line-310"></span><span>      </span><span class="hs-comment">-- share the same anchor block number, such that @AF.anchorBlockNo f1 ==</span><span>
</span><span id="line-311"></span><span>      </span><span class="hs-comment">-- AF.anchorBlockNo f2@. However, these fragments do not intersect, so</span><span>
</span><span id="line-312"></span><span>      </span><span class="hs-comment">-- @preferAnchoredCandidate _ ours cand@ will fail.</span><span>
</span><span id="line-313"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-comment">-- For this to be a problem in practice, assertions would have to be</span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-comment">-- enabled (which isn't the case for a running node) and the current</span><span>
</span><span id="line-316"></span><span>      </span><span class="hs-comment">-- evolving chain would have to be in the Byron era (which is not the</span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-comment">-- case). Since violation of the precondition is therefore highly</span><span>
</span><span id="line-318"></span><span>      </span><span class="hs-comment">-- unlikely, we chose no to include a case for EBBs here because it would</span><span>
</span><span id="line-319"></span><span>      </span><span class="hs-comment">-- complicate the code.</span><span>
</span><span id="line-320"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Bool
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#preferAnchoredCandidate"><span class="hs-identifier hs-var">preferAnchoredCandidate</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679915789"><span class="hs-identifier hs-var">bcfg</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915919"><span class="hs-identifier hs-var">ours</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment (Header blk)
</span><a href="#local-6989586621679915920"><span class="hs-identifier hs-var">cand</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>    </span><span class="annot"><a href="#local-6989586621679915802"><span class="hs-identifier hs-type">compareCandidateChains</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679915506"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Ordering"><span class="hs-identifier hs-type">Ordering</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621679915802"><span class="annot"><span class="annottext">compareCandidateChains :: AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk) -&gt; Ordering
</span><a href="#local-6989586621679915802"><span class="hs-identifier hs-var hs-var">compareCandidateChains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
forall blk.
(BlockSupportsProtocol blk, HasCallStack) =&gt;
BlockConfig blk
-&gt; AnchoredFragment (Header blk)
-&gt; AnchoredFragment (Header blk)
-&gt; Ordering
</span><a href="Ouroboros.Consensus.Util.AnchoredFragment.html#compareAnchoredFragments"><span class="hs-identifier hs-var">compareAnchoredFragments</span></a></span><span> </span><span class="annot"><span class="annottext">BlockConfig blk
</span><a href="#local-6989586621679915789"><span class="hs-identifier hs-var">bcfg</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>    </span><span id="local-6989586621679915803"><span class="annot"><span class="annottext">headerForgeUTCTime :: FromConsensus (Header blk) -&gt; STM m UTCTime
</span><a href="#local-6989586621679915803"><span class="hs-identifier hs-var hs-var">headerForgeUTCTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotForgeTimeOracle m blk
</span><a href="#local-6989586621679915793"><span class="hs-identifier hs-var">slotForgeTime</span></a></span><span> </span><span class="annot"><span class="annottext">SlotForgeTimeOracle m blk
-&gt; (FromConsensus (Header blk) -&gt; RealPoint blk)
-&gt; FromConsensus (Header blk)
-&gt; STM m UTCTime
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Header blk -&gt; RealPoint blk
forall blk.
(HasHeader blk, HasHeader (Header blk)) =&gt;
Header blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#headerRealPoint"><span class="hs-identifier hs-var">headerRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Header blk -&gt; RealPoint blk)
-&gt; (FromConsensus (Header blk) -&gt; Header blk)
-&gt; FromConsensus (Header blk)
-&gt; RealPoint blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FromConsensus (Header blk) -&gt; Header blk
forall a. FromConsensus a -&gt; a
</span><span class="hs-identifier hs-var">unFromConsensus</span></span><span>
</span><span id="line-329"></span><span>    </span><span id="local-6989586621679915804"><span class="annot"><span class="annottext">blockForgeUTCTime :: FromConsensus blk -&gt; STM m UTCTime
</span><a href="#local-6989586621679915804"><span class="hs-identifier hs-var hs-var">blockForgeUTCTime</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotForgeTimeOracle m blk
</span><a href="#local-6989586621679915793"><span class="hs-identifier hs-var">slotForgeTime</span></a></span><span> </span><span class="annot"><span class="annottext">SlotForgeTimeOracle m blk
-&gt; (FromConsensus blk -&gt; RealPoint blk)
-&gt; FromConsensus blk
-&gt; STM m UTCTime
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span>  </span><span class="annot"><span class="annottext">(blk -&gt; RealPoint blk)
-&gt; (FromConsensus blk -&gt; blk) -&gt; FromConsensus blk -&gt; RealPoint blk
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FromConsensus blk -&gt; blk
forall a. FromConsensus a -&gt; a
</span><span class="hs-identifier hs-var">unFromConsensus</span></span><span>
</span><span id="line-330"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds           #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase                #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns            #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes                #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards           #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables       #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TupleSections             #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications          #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-comment">-- | Immutable on-disk database of binary blobs</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- = Internal format</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- The API of the ImmutableDB uses 'SlotNo' to indicate a location in the</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- chain\/immutable database. To distinguish EBBs from regular blocks, the hash</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- is used (together they form a 'RealPoint'). The contents of the database are</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- not stored in one big file that is appended to in eternity, but a separate</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- file is created for each 'ChunkNo'.</span><span>
</span><span id="line-21"></span><span class="hs-comment">--</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- Within each 'ChunkNo', the entries are numbered by 'RelativeSlot's. Each</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- 'SlotNo' can be converted to a combination of an 'ChunkNo' and a</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- 'RelativeSlot' (= 'ChunkSlot') and vice versa. This conversion depends on the</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- size of the chunks: 'ChunkSize'. This size may not be the same for each</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- chunk. When opening the database, the user must give a 'ChunkInfo' that will</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- be used to find out the size of each chunk.</span><span>
</span><span id="line-28"></span><span class="hs-comment">--</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- For example:</span><span>
</span><span id="line-30"></span><span class="hs-comment">--</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- &gt; Chunks:         &lt;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; 0 &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&gt; &lt;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; 1 &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&gt;</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- &gt; chunk size:               4                   3</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- &gt;                 &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488; &#9484;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9488;</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- &gt;                 &#9474;   &#9474;   &#9474;   &#9474;   &#9474;   &#9474; &#9474;   &#9474;   &#9474;   &#9474;   &#9474;</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- &gt;                 &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496; &#9492;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9496;</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- &gt; 'RelativeSlot':   0   1   2   3   4     0   1   2   3</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- &gt; 'SlotNo':        EBB  0   1   2   3    EBB  4   5   6</span><span>
</span><span id="line-38"></span><span class="hs-comment">--</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- Not all chunks can contain EBBs; see 'ChunkInfo' for details.</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- = Errors</span><span>
</span><span id="line-42"></span><span class="hs-comment">--</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- Whenever an 'UnexpectedFailure' is thrown during an operation, e.g.,</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- 'appendBlock', the database will be automatically closed because we can not</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- guarantee a consistent state in the face of file system errors.</span><span>
</span><span id="line-46"></span><span class="hs-comment">--</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- = Opening the database</span><span>
</span><span id="line-48"></span><span class="hs-comment">--</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- The database can be closed and opened again. In case the database was closed</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- because of an unexpected error. When the database is opened again, invalid</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- data will be truncated from the database until a valid prefix is recovered.</span><span>
</span><span id="line-52"></span><span class="hs-comment">--</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- = Concurrency</span><span>
</span><span id="line-54"></span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- The same database should not be opened multiple times concurrently.</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- This is ensured by the file lock of the ChainDB.</span><span>
</span><span id="line-57"></span><span class="hs-comment">--</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- The database can have multiple readers, but should only have one writer.</span><span>
</span><span id="line-59"></span><span class="hs-comment">--</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- = Layout on disk</span><span>
</span><span id="line-62"></span><span class="hs-comment">--</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- The database is structured on disk as follows:</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- &gt; /</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- &gt;   00000.chunk</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- &gt;   00000.primary</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- &gt;   00000.secondary</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- &gt;   ..</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- &gt;   00008.chunk</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- &gt;   00008.primary</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- &gt;   00008.secondary</span><span>
</span><span id="line-73"></span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- For each chunk, there are three files on disk:</span><span>
</span><span id="line-75"></span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span class="hs-comment">--   * A \&quot;chunk file\&quot; that stores the actual blocks. But nothing more, so</span><span>
</span><span id="line-77"></span><span class="hs-comment">--     nothing is stored for empty slots.</span><span>
</span><span id="line-78"></span><span class="hs-comment">--</span><span>
</span><span id="line-79"></span><span class="hs-comment">--   * A \&quot;secondary index file\&quot; that stores information about each block: its</span><span>
</span><span id="line-80"></span><span class="hs-comment">--     hash, the slot number or epoch number in case of an EBB, a checksum of</span><span>
</span><span id="line-81"></span><span class="hs-comment">--     the block, the offset of the block in the chunk file, and more. This</span><span>
</span><span id="line-82"></span><span class="hs-comment">--     index is sparse to save space.</span><span>
</span><span id="line-83"></span><span class="hs-comment">--</span><span>
</span><span id="line-84"></span><span class="hs-comment">--   * A \&quot;primary index file\&quot; that maps slots to offsets in the secondary</span><span>
</span><span id="line-85"></span><span class="hs-comment">--     index file.</span><span>
</span><span id="line-86"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Opening the databse</span></span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier">ImmutableDbArgs</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbSerialiseConstraints"><span class="hs-identifier">ImmutableDbSerialiseConstraints</span></a></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#defaultArgs"><span class="hs-identifier">defaultArgs</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDB"><span class="hs-identifier">openDB</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-exported</span></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ChunkFileError"><span class="hs-identifier">ChunkFileError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier">Index.CacheConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceChunkValidation"><span class="hs-identifier">TraceChunkValidation</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceEvent"><span class="hs-identifier">TraceEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidationPolicy"><span class="hs-identifier">ValidationPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Internals for testing purposes</span></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#Internal"><span class="hs-identifier">Internal</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfter"><span class="hs-identifier">deleteAfter</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDBInternal"><span class="hs-identifier">openDBInternal</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Codec.CBOR.Write</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CBOR</span></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#replicateM_"><span class="hs-identifier">replicateM_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier">unless</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier">when</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier">runExceptT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Strict.html"><span class="hs-identifier">Control.Monad.State.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier">get</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier">lift</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier">modify</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#put"><span class="hs-identifier">put</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nullTracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lazy</span></span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Block.html"><span class="hs-identifier">Ouroboros.Consensus.Block</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#headerHash"><span class="hs-identifier">headerHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Common</span></a></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.API</span></a></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Chunks</span></a></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier">Index</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Index</span></span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Primary</span></span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a></span><span>
</span><span id="line-119"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockOffset"><span class="hs-identifier">BlockOffset</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#HeaderOffset"><span class="hs-identifier">HeaderOffset</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#HeaderSize"><span class="hs-identifier">HeaderSize</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Secondary</span></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator</span></a></span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Parser</span></a></span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.State</span></a></span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types</span></a></span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util</span></a></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation</span></a></span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html"><span class="hs-identifier">Ouroboros.Consensus.Storage.Serialisation</span></a></span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.html"><span class="hs-identifier">Ouroboros.Consensus.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.html#SomePair"><span class="hs-identifier">SomePair</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html"><span class="hs-identifier">Ouroboros.Consensus.Util.Args</span></a></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html"><span class="hs-identifier">Ouroboros.Consensus.Util.IOLike</span></a></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html"><span class="hs-identifier">Ouroboros.Consensus.Util.ResourceRegistry</span></a></span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.API.Lazy</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">allowExisting</span></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.FS.CRC</span></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="hs-comment">{------------------------------------------------------------------------------
  Opening the database
------------------------------------------------------------------------------}</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-keyword">data</span><span> </span><span id="ImmutableDbArgs"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier hs-var">ImmutableDbArgs</span></a></span></span><span> </span><span id="local-6989586621679868571"><span class="annot"><a href="#local-6989586621679868571"><span class="hs-identifier hs-type">f</span></a></span></span><span> </span><span id="local-6989586621679868572"><span class="annot"><a href="#local-6989586621679868572"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868573"><span class="annot"><a href="#local-6989586621679868573"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ImmutableDbArgs"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier hs-var">ImmutableDbArgs</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-140"></span><span>      </span><span id="immCacheConfig"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; CacheConfig
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immCacheConfig"><span class="hs-identifier hs-var hs-var">immCacheConfig</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier hs-type">Index.CacheConfig</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="immCheckIntegrity"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f (blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immCheckIntegrity"><span class="hs-identifier hs-var hs-var">immCheckIntegrity</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868571"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679868573"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="immChunkInfo"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immChunkInfo"><span class="hs-identifier hs-var hs-var">immChunkInfo</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868571"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="immCodecConfig"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f (CodecConfig blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immCodecConfig"><span class="hs-identifier hs-var hs-var">immCodecConfig</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868571"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#CodecConfig"><span class="hs-identifier hs-type">CodecConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868573"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="immHasFS"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; SomeHasFS m
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immHasFS"><span class="hs-identifier hs-var hs-var">immHasFS</span></a></span></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679868572"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="immRegistry"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f (ResourceRegistry m)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immRegistry"><span class="hs-identifier hs-var hs-var">immRegistry</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#HKD"><span class="hs-identifier hs-type">HKD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868571"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#ResourceRegistry"><span class="hs-identifier hs-type">ResourceRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868572"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="immTracer"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immTracer"><span class="hs-identifier hs-var hs-var">immTracer</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679868572"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#TraceEvent"><span class="hs-identifier hs-type">TraceEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868573"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="immValidationPolicy"><span class="annot"><span class="annottext">forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; ValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immValidationPolicy"><span class="hs-identifier hs-var hs-var">immValidationPolicy</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidationPolicy"><span class="hs-identifier hs-type">ValidationPolicy</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="annot"><span class="hs-comment">-- | Default arguments</span></span><span>
</span><span id="line-151"></span><span id="local-6989586621679868608"><span id="local-6989586621679868610"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#defaultArgs"><span class="hs-identifier hs-type">defaultArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Applicative"><span class="hs-identifier hs-type">Applicative</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679868608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier hs-type">ImmutableDbArgs</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.Args.html#Defaults"><span class="hs-identifier hs-type">Defaults</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868610"><span class="hs-identifier hs-type">blk</span></a></span></span></span><span>
</span><span id="line-152"></span><span id="defaultArgs"><span class="annot"><span class="annottext">defaultArgs :: forall (m :: * -&gt; *) blk.
Applicative m =&gt;
SomeHasFS m -&gt; ImmutableDbArgs Defaults m blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#defaultArgs"><span class="hs-identifier hs-var hs-var">defaultArgs</span></a></span></span><span> </span><span id="local-6989586621679869028"><span class="annot"><span class="annottext">SomeHasFS m
</span><a href="#local-6989586621679869028"><span class="hs-identifier hs-var">immHasFS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier hs-type">ImmutableDbArgs</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><span class="annottext">immCacheConfig :: CacheConfig
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immCacheConfig"><span class="hs-identifier hs-var">immCacheConfig</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheConfig
</span><a href="#local-6989586621679869029"><span class="hs-identifier hs-var">cacheConfig</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">immCheckIntegrity :: HKD Defaults (blk -&gt; Bool)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immCheckIntegrity"><span class="hs-identifier hs-var">immCheckIntegrity</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Defaults (blk -&gt; Bool)
Defaults (blk -&gt; Bool)
forall t. Defaults t
</span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">immChunkInfo :: HKD Defaults ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immChunkInfo"><span class="hs-identifier hs-var">immChunkInfo</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Defaults ChunkInfo
Defaults ChunkInfo
forall t. Defaults t
</span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">immCodecConfig :: HKD Defaults (CodecConfig blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immCodecConfig"><span class="hs-identifier hs-var">immCodecConfig</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Defaults (CodecConfig blk)
Defaults (CodecConfig blk)
forall t. Defaults t
</span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SomeHasFS m
immHasFS :: SomeHasFS m
immHasFS :: SomeHasFS m
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immHasFS"><span class="hs-identifier hs-var hs-var">immHasFS</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">immRegistry :: HKD Defaults (ResourceRegistry m)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immRegistry"><span class="hs-identifier hs-var">immRegistry</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Defaults (ResourceRegistry m)
Defaults (ResourceRegistry m)
forall t. Defaults t
</span><a href="Ouroboros.Consensus.Util.Args.html#NoDefault"><span class="hs-identifier hs-var">NoDefault</span></a></span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">immTracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immTracer"><span class="hs-identifier hs-var">immTracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">immValidationPolicy :: ValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immValidationPolicy"><span class="hs-identifier hs-var">immValidationPolicy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#ValidateMostRecentChunk"><span class="hs-identifier hs-var">ValidateMostRecentChunk</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- Cache 250 past chunks by default. This will take roughly 250 MB of RAM.</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-comment">-- At the time of writing (1/2020), there are 166 epochs, and we store one</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- epoch per chunk, so even one year from now, we will be able to cache all</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- chunks' indices in the chain.</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">-- If this number were too low, i.e., less than the number of chunks that</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">-- that clients are requesting blocks from, we would constantly evict and</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-comment">-- reparse indices, causing a much higher CPU load.</span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621679869029"><span class="annot"><span class="annottext">cacheConfig :: CacheConfig
</span><a href="#local-6989586621679869029"><span class="hs-identifier hs-var hs-var">cacheConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#CacheConfig"><span class="hs-identifier hs-type">Index.CacheConfig</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-172"></span><span>          </span><span class="annot"><span class="annottext">$sel:pastChunksToCache:CacheConfig :: Word32
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#%24sel%3ApastChunksToCache%3ACacheConfig"><span class="hs-identifier hs-var">pastChunksToCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">250</span></span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:expireUnusedAfter:CacheConfig :: DiffTime
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Cache.html#%24sel%3AexpireUnusedAfter%3ACacheConfig"><span class="hs-identifier hs-var">expireUnusedAfter</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">5</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">60</span></span><span> </span><span class="hs-comment">-- Expire after 1 minute</span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="annot"><span class="hs-comment">-- | 'EncodeDisk' and 'DecodeDisk' constraints needed for the ImmutableDB.</span></span><span>
</span><span id="line-177"></span><span class="hs-keyword">type</span><span> </span><span id="ImmutableDbSerialiseConstraints"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbSerialiseConstraints"><span class="hs-identifier hs-var">ImmutableDbSerialiseConstraints</span></a></span></span><span> </span><span id="local-6989586621679869042"><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#EncodeDisk"><span class="hs-identifier hs-type">EncodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#ReconstructNestedCtxt"><span class="hs-identifier hs-type">ReconstructNestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679869042"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">{------------------------------------------------------------------------------
  Exposed internals and/or extra functionality for testing purposes
------------------------------------------------------------------------------}</span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="hs-keyword">data</span><span> </span><span id="Internal"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#Internal"><span class="hs-identifier hs-var">Internal</span></a></span></span><span> </span><span id="local-6989586621679868618"><span class="annot"><a href="#local-6989586621679868618"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868619"><span class="annot"><a href="#local-6989586621679868619"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Internal"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#Internal"><span class="hs-identifier hs-var">Internal</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">-- | Delete everything in the database after the specified tip.</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-comment">-- PRECONDITION: The tip must correspond to an existing block or genesis.</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">-- The correctness of open iterators is not guaranteed, they should be</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-comment">-- closed before calling this operation.</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">-- Throws a 'ClosedDBError' if the database is closed.</span><span>
</span><span id="line-198"></span><span>    </span><span id="deleteAfter_"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) blk.
Internal m blk -&gt; HasCallStack =&gt; WithOrigin (Tip blk) -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfter_"><span class="hs-identifier hs-var hs-var">deleteAfter_</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868619"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868618"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span class="hs-comment">-- | Wrapper around 'deleteAfter_' to ensure 'HasCallStack' constraint</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- See documentation of 'deleteAfter_'.</span><span>
</span><span id="line-204"></span><span id="local-6989586621679868626"><span id="local-6989586621679868627"><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfter"><span class="hs-identifier hs-type">deleteAfter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#Internal"><span class="hs-identifier hs-type">Internal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868626"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868627"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868627"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868626"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-205"></span><span id="deleteAfter"><span class="annot"><span class="annottext">deleteAfter :: forall (m :: * -&gt; *) blk.
HasCallStack =&gt;
Internal m blk -&gt; WithOrigin (Tip blk) -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfter"><span class="hs-identifier hs-var hs-var">deleteAfter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Internal m blk -&gt; HasCallStack =&gt; WithOrigin (Tip blk) -&gt; m ()
Internal m blk -&gt; WithOrigin (Tip blk) -&gt; m ()
forall (m :: * -&gt; *) blk.
Internal m blk -&gt; HasCallStack =&gt; WithOrigin (Tip blk) -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfter_"><span class="hs-identifier hs-var">deleteAfter_</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span class="hs-comment">{------------------------------------------------------------------------------
  ImmutableDB Implementation
------------------------------------------------------------------------------}</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDB"><span class="hs-identifier hs-type">openDB</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868630"><span class="annot"><a href="#local-6989586621679868630"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868632"><span class="annot"><a href="#local-6989586621679868632"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679868640"><span class="annot"><a href="#local-6989586621679868640"><span class="hs-identifier hs-type">ans</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-213"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868630"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-214"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868632"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-215"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868632"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-216"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbSerialiseConstraints"><span class="hs-identifier hs-type">ImmutableDbSerialiseConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868632"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-217"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-218"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier hs-type">ImmutableDbArgs</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868630"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868632"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868637"><span class="annot"><a href="#local-6989586621679868637"><span class="hs-identifier hs-type">st</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868637"><span class="hs-identifier hs-type">st</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868630"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDB"><span class="hs-identifier hs-type">ImmutableDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868630"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868632"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679868637"><span class="hs-identifier hs-type">st</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868640"><span class="hs-identifier hs-type">ans</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868640"><span class="hs-identifier hs-type">ans</span></a></span><span>
</span><span id="line-222"></span><span id="openDB"><span class="annot"><span class="annottext">openDB :: forall (m :: * -&gt; *) blk ans.
(IOLike m, GetPrevHash blk, ConvertRawHash blk,
 ImmutableDbSerialiseConstraints blk, HasCallStack) =&gt;
ImmutableDbArgs Identity m blk
-&gt; (forall st.
    WithTempRegistry st m (ImmutableDB m blk, st) -&gt; ans)
-&gt; ans
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDB"><span class="hs-identifier hs-var hs-var">openDB</span></a></span></span><span> </span><span id="local-6989586621679869071"><span class="annot"><span class="annottext">ImmutableDbArgs Identity m blk
</span><a href="#local-6989586621679869071"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621679869072"><span class="annot"><span class="annottext">forall st. WithTempRegistry st m (ImmutableDB m blk, st) -&gt; ans
</span><a href="#local-6989586621679869072"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="annottext">ImmutableDbArgs Identity m blk
-&gt; (forall h.
    WithTempRegistry
      (OpenState m blk h)
      m
      ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
    -&gt; ans)
-&gt; ans
forall (m :: * -&gt; *) blk ans.
(IOLike m, GetPrevHash blk, ConvertRawHash blk,
 ImmutableDbSerialiseConstraints blk, HasCallStack) =&gt;
ImmutableDbArgs Identity m blk
-&gt; (forall h.
    WithTempRegistry
      (OpenState m blk h)
      m
      ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
    -&gt; ans)
-&gt; ans
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDBInternal"><span class="hs-identifier hs-var">openDBInternal</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDbArgs Identity m blk
</span><a href="#local-6989586621679869071"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithTempRegistry
  (OpenState m blk h) m (ImmutableDB m blk, OpenState m blk h)
-&gt; ans
forall st. WithTempRegistry st m (ImmutableDB m blk, st) -&gt; ans
</span><a href="#local-6989586621679869072"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry
   (OpenState m blk h) m (ImmutableDB m blk, OpenState m blk h)
 -&gt; ans)
-&gt; (WithTempRegistry
      (OpenState m blk h)
      m
      ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
    -&gt; WithTempRegistry
         (OpenState m blk h) m (ImmutableDB m blk, OpenState m blk h))
-&gt; WithTempRegistry
     (OpenState m blk h)
     m
     ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; ans
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(((ImmutableDB m blk, Internal m blk), OpenState m blk h)
 -&gt; (ImmutableDB m blk, OpenState m blk h))
-&gt; WithTempRegistry
     (OpenState m blk h)
     m
     ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; WithTempRegistry
     (OpenState m blk h) m (ImmutableDB m blk, OpenState m blk h)
forall a b.
(a -&gt; b)
-&gt; WithTempRegistry (OpenState m blk h) m a
-&gt; WithTempRegistry (OpenState m blk h) m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; (ImmutableDB m blk, OpenState m blk h)
forall {a} {b} {b}. ((a, b), b) -&gt; (a, b)
</span><a href="#local-6989586621679869076"><span class="hs-identifier hs-var">swizzle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621679869076"><span class="annot"><span class="annottext">swizzle :: ((a, b), b) -&gt; (a, b)
</span><a href="#local-6989586621679869076"><span class="hs-identifier hs-var hs-var">swizzle</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679869077"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679869077"><span class="hs-identifier hs-var">immdb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679869078"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679869078"><span class="hs-identifier hs-var">_internal</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679869079"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679869079"><span class="hs-identifier hs-var">ost</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679869077"><span class="hs-identifier hs-var">immdb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679869079"><span class="hs-identifier hs-var">ost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">-- | For testing purposes: exposes internals via 'Internal'</span><span>
</span><span id="line-228"></span><span class="hs-comment">--</span><span>
</span><span id="line-229"></span><span class="hs-comment">--</span><span>
</span><span id="line-230"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDBInternal"><span class="hs-identifier hs-type">openDBInternal</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-231"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868651"><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868652"><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679868653"><span class="annot"><a href="#local-6989586621679868653"><span class="hs-identifier hs-type">ans</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-232"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-233"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetPrevHash"><span class="hs-identifier hs-type">GetPrevHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-234"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-235"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbSerialiseConstraints"><span class="hs-identifier hs-type">ImmutableDbSerialiseConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-236"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-237"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier hs-type">ImmutableDbArgs</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Identity.html#Identity"><span class="hs-identifier hs-type">Identity</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868649"><span class="annot"><a href="#local-6989586621679868649"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-240"></span><span>         </span><span class="annot"><a href="Ouroboros.Consensus.Util.ResourceRegistry.html#WithTempRegistry"><span class="hs-identifier hs-type">WithTempRegistry</span></a></span><span>
</span><span id="line-241"></span><span>           </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868649"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>           </span><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-243"></span><span>           </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDB"><span class="hs-identifier hs-type">ImmutableDB</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#Internal"><span class="hs-identifier hs-type">Internal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868651"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868652"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868649"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868653"><span class="hs-identifier hs-type">ans</span></a></span><span>
</span><span id="line-245"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868653"><span class="hs-identifier hs-type">ans</span></a></span><span>
</span><span id="line-247"></span><span id="openDBInternal"><span class="annot"><span class="annottext">openDBInternal :: forall (m :: * -&gt; *) blk ans.
(IOLike m, GetPrevHash blk, ConvertRawHash blk,
 ImmutableDbSerialiseConstraints blk, HasCallStack) =&gt;
ImmutableDbArgs Identity m blk
-&gt; (forall h.
    WithTempRegistry
      (OpenState m blk h)
      m
      ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
    -&gt; ans)
-&gt; ans
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#openDBInternal"><span class="hs-identifier hs-var hs-var">openDBInternal</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#ImmutableDbArgs"><span class="hs-identifier hs-type">ImmutableDbArgs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">immHasFS :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; SomeHasFS m
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immHasFS"><span class="hs-identifier hs-var">immHasFS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeHasFS</span></span><span> </span><span id="local-6989586621679869200"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869200"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679869201"><span id="local-6989586621679869202"><span id="local-6989586621679869203"><span id="local-6989586621679869204"><span id="local-6989586621679869205"><span id="local-6989586621679869206"><span id="local-6989586621679869207"><span class="annot"><span class="annottext">HKD Identity (CodecConfig blk)
HKD Identity ChunkInfo
HKD Identity (ResourceRegistry m)
HKD Identity (blk -&gt; Bool)
Tracer m (TraceEvent blk)
ValidationPolicy
CacheConfig
immCacheConfig :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; CacheConfig
immCheckIntegrity :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f (blk -&gt; Bool)
immChunkInfo :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f ChunkInfo
immCodecConfig :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f (CodecConfig blk)
immRegistry :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; HKD f (ResourceRegistry m)
immTracer :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; Tracer m (TraceEvent blk)
immValidationPolicy :: forall (f :: * -&gt; *) (m :: * -&gt; *) blk.
ImmutableDbArgs f m blk -&gt; ValidationPolicy
immCacheConfig :: CacheConfig
immCheckIntegrity :: HKD Identity (blk -&gt; Bool)
immChunkInfo :: HKD Identity ChunkInfo
immCodecConfig :: HKD Identity (CodecConfig blk)
immRegistry :: HKD Identity (ResourceRegistry m)
immTracer :: Tracer m (TraceEvent blk)
immValidationPolicy :: ValidationPolicy
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#immCacheConfig"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679869208"><span class="annot"><span class="annottext">forall h.
WithTempRegistry
  (OpenState m blk h)
  m
  ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; ans
</span><a href="#local-6989586621679869208"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry
  (OpenState m blk h)
  m
  ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; ans
forall h.
WithTempRegistry
  (OpenState m blk h)
  m
  ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; ans
</span><a href="#local-6989586621679869208"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry
   (OpenState m blk h)
   m
   ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
 -&gt; ans)
-&gt; WithTempRegistry
     (OpenState m blk h)
     m
     ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; ans
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState m blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Bool -&gt; FsPath -&gt; m ()
</span><span class="hs-identifier hs-var">createDirectoryIfMissing</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869200"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; FsPath
</span><span class="hs-identifier hs-var">mkFsPath</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679869211"><span class="annot"><span class="annottext">validateEnv :: ValidateEnv m blk h
</span><a href="#local-6989586621679869211"><span class="hs-identifier hs-var hs-var">validateEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#ValidateEnv"><span class="hs-identifier hs-type">ValidateEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-250"></span><span>            </span><span class="annot"><span class="annottext">hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#hasFS"><span class="hs-identifier hs-var">hasFS</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869200"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-251"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#chunkInfo"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity ChunkInfo
ChunkInfo
</span><a href="#local-6989586621679869203"><span class="hs-identifier hs-var">immChunkInfo</span></a></span><span>
</span><span id="line-252"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#tracer"><span class="hs-identifier hs-var">tracer</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679869206"><span class="hs-identifier hs-var">immTracer</span></a></span><span>
</span><span id="line-253"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cacheConfig :: CacheConfig
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#cacheConfig"><span class="hs-identifier hs-var">cacheConfig</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheConfig
</span><a href="#local-6989586621679869201"><span class="hs-identifier hs-var">immCacheConfig</span></a></span><span>
</span><span id="line-254"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">codecConfig :: CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#codecConfig"><span class="hs-identifier hs-var">codecConfig</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity (CodecConfig blk)
CodecConfig blk
</span><a href="#local-6989586621679869204"><span class="hs-identifier hs-var">immCodecConfig</span></a></span><span>
</span><span id="line-255"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checkIntegrity :: blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#checkIntegrity"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity (blk -&gt; Bool)
blk -&gt; Bool
</span><a href="#local-6989586621679869202"><span class="hs-identifier hs-var">immCheckIntegrity</span></a></span><span>
</span><span id="line-256"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621679869219"><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679869219"><span class="hs-identifier hs-var">ost</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
-&gt; ResourceRegistry m
-&gt; ValidationPolicy
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall (m :: * -&gt; *) blk h.
(IOLike m, GetPrevHash blk, HasBinaryBlockInfo blk,
 DecodeDisk blk (ByteString -&gt; blk), ConvertRawHash blk, Eq h,
 HasCallStack) =&gt;
ValidateEnv m blk h
-&gt; ResourceRegistry m
-&gt; ValidationPolicy
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Validation.html#validateAndReopen"><span class="hs-identifier hs-var">validateAndReopen</span></a></span><span> </span><span class="annot"><span class="annottext">ValidateEnv m blk h
</span><a href="#local-6989586621679869211"><span class="hs-identifier hs-var">validateEnv</span></a></span><span> </span><span class="annot"><span class="annottext">HKD Identity (ResourceRegistry m)
ResourceRegistry m
</span><a href="#local-6989586621679869205"><span class="hs-identifier hs-var">immRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">ValidationPolicy
</span><a href="#local-6989586621679869207"><span class="hs-identifier hs-var">immValidationPolicy</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621679869221"><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
</span><a href="#local-6989586621679869221"><span class="hs-identifier hs-var">stVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (StrictSVar m (InternalState m blk h))
-&gt; WithTempRegistry
     (OpenState m blk h) m (StrictSVar m (InternalState m blk h))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (StrictSVar m (InternalState m blk h))
 -&gt; WithTempRegistry
      (OpenState m blk h) m (StrictSVar m (InternalState m blk h)))
-&gt; m (StrictSVar m (InternalState m blk h))
-&gt; WithTempRegistry
     (OpenState m blk h) m (StrictSVar m (InternalState m blk h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState m blk h -&gt; m (StrictSVar m (InternalState m blk h))
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack, NoThunks a) =&gt;
a -&gt; m (StrictSVar m a)
</span><a href="Ouroboros.Consensus.Util.MonadSTM.NormalForm.html#newSVar"><span class="hs-identifier hs-var">newSVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpenState m blk h -&gt; InternalState m blk h
forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; InternalState m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-var">DbOpen</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679869219"><span class="hs-identifier hs-var">ost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679869225"><span class="annot"><span class="annottext">dbEnv :: ImmutableDBEnv m blk
</span><a href="#local-6989586621679869225"><span class="hs-identifier hs-var hs-var">dbEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-262"></span><span>            </span><span class="annot"><span class="annottext">hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#hasFS"><span class="hs-identifier hs-var">hasFS</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869200"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-263"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">varInternalState :: StrictSVar m (InternalState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#varInternalState"><span class="hs-identifier hs-var">varInternalState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
</span><a href="#local-6989586621679869221"><span class="hs-identifier hs-var">stVar</span></a></span><span>
</span><span id="line-264"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checkIntegrity :: blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#checkIntegrity"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity (blk -&gt; Bool)
blk -&gt; Bool
</span><a href="#local-6989586621679869202"><span class="hs-identifier hs-var">immCheckIntegrity</span></a></span><span>
</span><span id="line-265"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkInfo"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity ChunkInfo
ChunkInfo
</span><a href="#local-6989586621679869203"><span class="hs-identifier hs-var">immChunkInfo</span></a></span><span>
</span><span id="line-266"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#tracer"><span class="hs-identifier hs-var">tracer</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679869206"><span class="hs-identifier hs-var">immTracer</span></a></span><span>
</span><span id="line-267"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cacheConfig :: CacheConfig
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cacheConfig"><span class="hs-identifier hs-var">cacheConfig</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheConfig
</span><a href="#local-6989586621679869201"><span class="hs-identifier hs-var">immCacheConfig</span></a></span><span>
</span><span id="line-268"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">codecConfig :: CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#codecConfig"><span class="hs-identifier hs-var">codecConfig</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HKD Identity (CodecConfig blk)
CodecConfig blk
</span><a href="#local-6989586621679869204"><span class="hs-identifier hs-var">immCodecConfig</span></a></span><span>
</span><span id="line-269"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-270"></span><span>        </span><span id="local-6989586621679869234"><span class="annot"><span class="annottext">db :: ImmutableDB m blk
</span><a href="#local-6989586621679869234"><span class="hs-identifier hs-var hs-var">db</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#ImmutableDB"><span class="hs-identifier hs-type">ImmutableDB</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-271"></span><span>            </span><span class="annot"><span class="annottext">closeDB_ :: HasCallStack =&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#closeDB_"><span class="hs-identifier hs-var">closeDB_</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(HasCallStack, IOLike m) =&gt;
ImmutableDBEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#closeDBImpl"><span class="hs-identifier hs-var">closeDBImpl</span></a></span><span>           </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679869225"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-272"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getTip_ :: HasCallStack =&gt; STM m (WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getTip_"><span class="hs-identifier hs-var">getTip_</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk -&gt; STM m (WithOrigin (Tip blk))
forall (m :: * -&gt; *) blk.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ImmutableDBEnv m blk -&gt; STM m (WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#getTipImpl"><span class="hs-identifier hs-var">getTipImpl</span></a></span><span>            </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679869225"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-273"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">getBlockComponent_ :: forall b.
HasCallStack =&gt;
BlockComponent blk b
-&gt; RealPoint blk -&gt; m (Either (MissingBlock blk) b)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#getBlockComponent_"><span class="hs-identifier hs-var">getBlockComponent_</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; BlockComponent blk b
-&gt; RealPoint blk
-&gt; m (Either (MissingBlock blk) b)
forall (m :: * -&gt; *) blk b.
(HasHeader blk, ReconstructNestedCtxt Header blk,
 DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk, IOLike m) =&gt;
ImmutableDBEnv m blk
-&gt; BlockComponent blk b
-&gt; RealPoint blk
-&gt; m (Either (MissingBlock blk) b)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier hs-var">getBlockComponentImpl</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679869225"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-274"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">appendBlock_ :: HasCallStack =&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#appendBlock_"><span class="hs-identifier hs-var">appendBlock_</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk -&gt; blk -&gt; m ()
forall (m :: * -&gt; *) blk.
(HasHeader blk, GetHeader blk, EncodeDisk blk blk,
 HasBinaryBlockInfo blk, IOLike m, HasCallStack) =&gt;
ImmutableDBEnv m blk -&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#appendBlockImpl"><span class="hs-identifier hs-var">appendBlockImpl</span></a></span><span>       </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679869225"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-275"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stream_ :: forall b.
HasCallStack =&gt;
ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; StreamFrom blk
-&gt; StreamTo blk
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
</span><a href="#local-6989586621679869679"><span class="hs-identifier hs-var">stream_</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; StreamFrom blk
-&gt; StreamTo blk
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
forall (m :: * -&gt; *) blk b.
(IOLike m, HasHeader blk, DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk,
 ReconstructNestedCtxt Header blk, HasCallStack) =&gt;
ImmutableDBEnv m blk
-&gt; ResourceRegistry m
-&gt; BlockComponent blk b
-&gt; StreamFrom blk
-&gt; StreamTo blk
-&gt; m (Either (MissingBlock blk) (Iterator m blk b))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#streamImpl"><span class="hs-identifier hs-var">streamImpl</span></a></span><span>            </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679869225"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-276"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-277"></span><span>        </span><span id="local-6989586621679869792"><span class="annot"><span class="annottext">internal :: Internal m blk
</span><a href="#local-6989586621679869792"><span class="hs-identifier hs-var hs-var">internal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#Internal"><span class="hs-identifier hs-type">Internal</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-278"></span><span>            </span><span class="annot"><span class="annottext">deleteAfter_ :: HasCallStack =&gt; WithOrigin (Tip blk) -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfter_"><span class="hs-identifier hs-var">deleteAfter_</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk -&gt; WithOrigin (Tip blk) -&gt; m ()
forall (m :: * -&gt; *) blk.
(HasCallStack, ConvertRawHash blk, IOLike m, HasHeader blk) =&gt;
ImmutableDBEnv m blk -&gt; WithOrigin (Tip blk) -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfterImpl"><span class="hs-identifier hs-var">deleteAfterImpl</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679869225"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-279"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>    </span><span class="annot"><span class="annottext">((ImmutableDB m blk, Internal m blk), OpenState m blk h)
-&gt; WithTempRegistry
     (OpenState m blk h)
     m
     ((ImmutableDB m blk, Internal m blk), OpenState m blk h)
forall a. a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ImmutableDB m blk
</span><a href="#local-6989586621679869234"><span class="hs-identifier hs-var">db</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Internal m blk
</span><a href="#local-6989586621679869792"><span class="hs-identifier hs-var">internal</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679869219"><span class="hs-identifier hs-var">ost</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#closeDBImpl"><span class="hs-identifier hs-type">closeDBImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-284"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868768"><span class="annot"><a href="#local-6989586621679868768"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868769"><span class="annot"><a href="#local-6989586621679868769"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868768"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868768"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868769"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868768"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span id="closeDBImpl"><span class="annot"><span class="annottext">closeDBImpl :: forall (m :: * -&gt; *) blk.
(HasCallStack, IOLike m) =&gt;
ImmutableDBEnv m blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#closeDBImpl"><span class="hs-identifier hs-var hs-var">closeDBImpl</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679869919"><span class="annot"><span class="annottext">HasFS m h
hasFS :: ()
hasFS :: HasFS m h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#hasFS"><span class="hs-identifier hs-var hs-var">hasFS</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679869920"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
tracer :: forall (m :: * -&gt; *) blk.
ImmutableDBEnv m blk -&gt; Tracer m (TraceEvent blk)
tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679869921"><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
varInternalState :: ()
varInternalState :: StrictSVar m (InternalState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#varInternalState"><span class="hs-identifier hs-var hs-var">varInternalState</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621679869922"><span class="annot"><span class="annottext">InternalState m blk h
</span><a href="#local-6989586621679869922"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h) -&gt; m (InternalState m blk h)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictSVar m a -&gt; m a
</span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictSVar.html#takeSVar"><span class="hs-identifier hs-var">takeSVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
</span><a href="#local-6989586621679869921"><span class="hs-identifier hs-var">varInternalState</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InternalState m blk h
</span><a href="#local-6989586621679869922"><span class="hs-identifier hs-var">internalState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-290"></span><span>      </span><span class="hs-comment">-- Already closed</span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><span class="annottext">InternalState m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
-&gt; InternalState m blk h -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictSVar m a -&gt; a -&gt; m ()
</span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictSVar.html#putSVar"><span class="hs-identifier hs-var">putSVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
</span><a href="#local-6989586621679869921"><span class="hs-identifier hs-var">varInternalState</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState m blk h
</span><a href="#local-6989586621679869922"><span class="hs-identifier hs-var">internalState</span></a></span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679869920"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TraceEvent blk
forall blk. TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#DBAlreadyClosed"><span class="hs-identifier hs-var">DBAlreadyClosed</span></a></span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbOpen"><span class="hs-identifier hs-type">DbOpen</span></a></span><span> </span><span id="local-6989586621679869927"><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679869927"><span class="hs-identifier hs-var">openState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>        </span><span class="hs-comment">-- Close the database before doing the file-system operations so that</span><span>
</span><span id="line-296"></span><span>        </span><span class="hs-comment">-- in case these fail, we don't leave the database open.</span><span>
</span><span id="line-297"></span><span>        </span><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
-&gt; InternalState m blk h -&gt; m ()
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
StrictSVar m a -&gt; a -&gt; m ()
</span><a href="Ouroboros.Consensus.Util.MonadSTM.StrictSVar.html#putSVar"><span class="hs-identifier hs-var">putSVar</span></a></span><span> </span><span class="annot"><span class="annottext">StrictSVar m (InternalState m blk h)
</span><a href="#local-6989586621679869921"><span class="hs-identifier hs-var">varInternalState</span></a></span><span> </span><span class="annot"><span class="annottext">InternalState m blk h
forall (m :: * -&gt; *) blk h. InternalState m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#DbClosed"><span class="hs-identifier hs-var">DbClosed</span></a></span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; OpenState m blk h -&gt; m ()
forall (m :: * -&gt; *) h blk.
Monad m =&gt;
HasFS m h -&gt; OpenState m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cleanUp"><span class="hs-identifier hs-var">cleanUp</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869919"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679869927"><span class="hs-identifier hs-var">openState</span></a></span><span>
</span><span id="line-299"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679869920"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">TraceEvent blk
forall blk. TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#DBClosed"><span class="hs-identifier hs-var">DBClosed</span></a></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfterImpl"><span class="hs-identifier hs-type">deleteAfterImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-302"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868784"><span class="annot"><a href="#local-6989586621679868784"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868783"><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#ConvertRawHash"><span class="hs-identifier hs-type">ConvertRawHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868784"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868784"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868784"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span id="deleteAfterImpl"><span class="annot"><span class="annottext">deleteAfterImpl :: forall (m :: * -&gt; *) blk.
(HasCallStack, ConvertRawHash blk, IOLike m, HasHeader blk) =&gt;
ImmutableDBEnv m blk -&gt; WithOrigin (Tip blk) -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#deleteAfterImpl"><span class="hs-identifier hs-var hs-var">deleteAfterImpl</span></a></span></span><span> </span><span id="local-6989586621679869941"><span class="annot"><span class="annottext">dbEnv :: ImmutableDBEnv m blk
</span><a href="#local-6989586621679869941"><span class="hs-identifier hs-var">dbEnv</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679869950"><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
tracer :: forall (m :: * -&gt; *) blk.
ImmutableDBEnv m blk -&gt; Tracer m (TraceEvent blk)
tracer :: Tracer m (TraceEvent blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#tracer"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679869951"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; ChunkInfo
chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621679869952"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679869952"><span class="hs-identifier hs-var">newTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-comment">-- We're not using 'Index' in this function but truncating the index files</span><span>
</span><span id="line-308"></span><span>  </span><span class="hs-comment">-- directly.</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall (m :: * -&gt; *) blk a.
(HasCallStack, IOLike m, StandardHash blk, Typeable blk) =&gt;
ImmutableDBEnv m blk
-&gt; (forall h. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h a)
-&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#modifyOpenState"><span class="hs-identifier hs-var">modifyOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679869941"><span class="hs-identifier hs-var">dbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
 -&gt; m ())
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679869989"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869989"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621679869990"><span class="annot"><span class="annottext">st :: OpenState m blk h
</span><a href="#local-6989586621679869990"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679869992"><span class="annot"><span class="annottext">Index m blk h
currentIndex :: Index m blk h
currentIndex :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Index m blk h
</span><a href="#local-6989586621679869992"><span class="hs-identifier hs-var hs-var">currentIndex</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679869994"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
currentTip :: WithOrigin (Tip blk)
currentTip :: forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; WithOrigin (Tip blk)
</span><a href="#local-6989586621679869994"><span class="hs-identifier hs-var hs-var">currentTip</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (OpenState m blk h)
  (WithTempRegistry (OpenState m blk h) m)
  (OpenState m blk h)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; CompareTip blk
forall blk. Tip blk -&gt; CompareTip blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#CompareTip"><span class="hs-identifier hs-var">CompareTip</span></a></span><span> </span><span class="annot"><span class="annottext">(Tip blk -&gt; CompareTip blk)
-&gt; WithOrigin (Tip blk) -&gt; WithOrigin (CompareTip blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679869952"><span class="hs-identifier hs-var">newTip</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WithOrigin (CompareTip blk) -&gt; WithOrigin (CompareTip blk) -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; CompareTip blk
forall blk. Tip blk -&gt; CompareTip blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#CompareTip"><span class="hs-identifier hs-var">CompareTip</span></a></span><span> </span><span class="annot"><span class="annottext">(Tip blk -&gt; CompareTip blk)
-&gt; WithOrigin (Tip blk) -&gt; WithOrigin (CompareTip blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679869994"><span class="hs-identifier hs-var">currentTip</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ())
-&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState m blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState m blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState m blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-314"></span><span>        </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk) -&gt; TraceEvent blk -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceEvent blk)
</span><a href="#local-6989586621679869950"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(TraceEvent blk -&gt; m ()) -&gt; TraceEvent blk -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk) -&gt; TraceEvent blk
forall blk. WithOrigin (Tip blk) -&gt; TraceEvent blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#DeletingAfter"><span class="hs-identifier hs-var">DeletingAfter</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679869952"><span class="hs-identifier hs-var">newTip</span></a></span><span>
</span><span id="line-315"></span><span>        </span><span class="hs-comment">-- Release the open handles, as we might have to remove files that are</span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-comment">-- currently opened.</span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; OpenState m blk h -&gt; m ()
forall (m :: * -&gt; *) h blk.
Monad m =&gt;
HasFS m h -&gt; OpenState m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#cleanUp"><span class="hs-identifier hs-var">cleanUp</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869989"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679869990"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; OpenState m blk h -&gt; WithOrigin ChunkSlot -&gt; m ()
forall h.
HasFS m h -&gt; OpenState m blk h -&gt; WithOrigin ChunkSlot -&gt; m ()
</span><a href="#local-6989586621679870000"><span class="hs-identifier hs-var">truncateTo</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869989"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679869990"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin ChunkSlot
</span><a href="#local-6989586621679870001"><span class="hs-identifier hs-var">newTipChunkSlot</span></a></span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-comment">-- Reset the index, as it can contain stale information. Also restarts</span><span>
</span><span id="line-320"></span><span>        </span><span class="hs-comment">-- the background thread expiring unused past chunks.</span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><span class="annottext">Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) blk h.
Index m blk h -&gt; HasCallStack =&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#restart"><span class="hs-identifier hs-var">Index.restart</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679869992"><span class="hs-identifier hs-var">currentIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870003"><span class="hs-identifier hs-var">newChunk</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>      </span><span id="local-6989586621679870004"><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679870004"><span class="hs-identifier hs-var">ost</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; StateT
     (OpenState m blk h)
     (WithTempRegistry (OpenState m blk h) m)
     (OpenState m blk h)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
 -&gt; StateT
      (OpenState m blk h)
      (WithTempRegistry (OpenState m blk h) m)
      (OpenState m blk h))
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; StateT
     (OpenState m blk h)
     (WithTempRegistry (OpenState m blk h) m)
     (OpenState m blk h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, Eq h) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#mkOpenState"><span class="hs-identifier hs-var">mkOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679869989"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679869992"><span class="hs-identifier hs-var">currentIndex</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870003"><span class="hs-identifier hs-var">newChunk</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679869952"><span class="hs-identifier hs-var">newTip</span></a></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><a href="#local-6989586621679870006"><span class="hs-identifier hs-var">allowExisting</span></a></span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><span class="annottext">OpenState m blk h -&gt; ModifyOpenState m blk h ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679870004"><span class="hs-identifier hs-var">ost</span></a></span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><a href="#local-6989586621679870001"><span class="hs-identifier hs-type">newTipChunkSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span id="local-6989586621679870001"><span class="annot"><span class="annottext">newTipChunkSlot :: WithOrigin ChunkSlot
</span><a href="#local-6989586621679870001"><span class="hs-identifier hs-var hs-var">newTipChunkSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; Tip blk -&gt; ChunkSlot
forall blk. ChunkInfo -&gt; Tip blk -&gt; ChunkSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkSlotForTip"><span class="hs-identifier hs-var">chunkSlotForTip</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679869951"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Tip blk -&gt; ChunkSlot)
-&gt; WithOrigin (Tip blk) -&gt; WithOrigin ChunkSlot
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679869952"><span class="hs-identifier hs-var">newTip</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><a href="#local-6989586621679870003"><span class="hs-identifier hs-type">newChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><a href="#local-6989586621679870006"><span class="hs-identifier hs-type">allowExisting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AllowExisting</span></span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679870003"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870003"><span class="hs-identifier hs-var">newChunk</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870006"><span class="annot"><span class="annottext">AllowExisting
</span><a href="#local-6989586621679870006"><span class="hs-identifier hs-var">allowExisting</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithOrigin ChunkSlot
</span><a href="#local-6989586621679870001"><span class="hs-identifier hs-var">newTipChunkSlot</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-332"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin ChunkSlot
</span><span class="hs-identifier hs-var">Origin</span></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">MustBeNew</span></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span> </span><span id="local-6989586621679870012"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870012"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870012"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">AllowExisting</span></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621679868841"><span class="annot"><a href="#local-6989586621679870000"><span class="hs-identifier hs-type">truncateTo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-336"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679868784"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868841"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-337"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868784"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868841"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-338"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span>
</span><span id="line-339"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868784"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-340"></span><span>    </span><span id="local-6989586621679870000"><span class="annot"><span class="annottext">truncateTo :: forall h.
HasFS m h -&gt; OpenState m blk h -&gt; WithOrigin ChunkSlot -&gt; m ()
</span><a href="#local-6989586621679870000"><span class="hs-identifier hs-var hs-var">truncateTo</span></a></span></span><span> </span><span id="local-6989586621679870049"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-341"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin ChunkSlot
</span><span class="hs-identifier hs-var">Origin</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-342"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#removeFilesStartingFrom"><span class="hs-identifier hs-var">removeFilesStartingFrom</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span> </span><span id="local-6989586621679870051"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870051"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679870052"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870052"><span class="hs-identifier hs-var">relSlot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#removeFilesStartingFrom"><span class="hs-identifier hs-var">removeFilesStartingFrom</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870051"><span class="hs-identifier hs-var">chunk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span>        </span><span class="hs-comment">-- Retrieve the needed info from the primary index file and then</span><span>
</span><span id="line-347"></span><span>        </span><span class="hs-comment">-- truncate it.</span><span>
</span><span id="line-348"></span><span>        </span><span id="local-6989586621679870054"><span class="annot"><span class="annottext">PrimaryIndex
</span><a href="#local-6989586621679870054"><span class="hs-identifier hs-var">primaryIndex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Proxy blk -&gt; HasFS m h -&gt; ChunkNo -&gt; m PrimaryIndex
forall blk (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m, StandardHash blk, Typeable blk) =&gt;
Proxy blk -&gt; HasFS m h -&gt; ChunkNo -&gt; m PrimaryIndex
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#load"><span class="hs-identifier hs-var">Primary.load</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870051"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; RelativeSlot -&gt; m ()
forall (m :: * -&gt; *) h.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; ChunkNo -&gt; RelativeSlot -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#truncateToSlotFS"><span class="hs-identifier hs-var">Primary.truncateToSlotFS</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870051"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870052"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-350"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679870060"><span class="annot"><span class="annottext">lastSecondaryOffset :: Word32
</span><a href="#local-6989586621679870060"><span class="hs-identifier hs-var hs-var">lastSecondaryOffset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; PrimaryIndex -&gt; RelativeSlot -&gt; Word32
PrimaryIndex -&gt; RelativeSlot -&gt; Word32
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#offsetOfSlot"><span class="hs-identifier hs-var">Primary.offsetOfSlot</span></a></span><span> </span><span class="annot"><span class="annottext">PrimaryIndex
</span><a href="#local-6989586621679870054"><span class="hs-identifier hs-var">primaryIndex</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870052"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-351"></span><span>            </span><span id="local-6989586621679870062"><span class="annot"><span class="annottext">isEBB :: IsEBB
</span><a href="#local-6989586621679870062"><span class="hs-identifier hs-var hs-var">isEBB</span></a></span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RelativeSlot -&gt; IsEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#relativeSlotIsEBB"><span class="hs-identifier hs-var">relativeSlotIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870052"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>        </span><span class="hs-comment">-- Retrieve the needed info from the secondary index file and then</span><span>
</span><span id="line-354"></span><span>        </span><span class="hs-comment">-- truncate it.</span><span>
</span><span id="line-355"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679870064"><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679870064"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870065"><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679870065"><span class="hs-identifier hs-var">blockSize</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-356"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h -&gt; ChunkNo -&gt; IsEBB -&gt; Word32 -&gt; m (Entry blk, BlockSize)
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, MonadThrow m, StandardHash blk,
 Typeable blk) =&gt;
HasFS m h -&gt; ChunkNo -&gt; IsEBB -&gt; Word32 -&gt; m (Entry blk, BlockSize)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#readEntry"><span class="hs-identifier hs-var">Secondary.readEntry</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870051"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">IsEBB
</span><a href="#local-6989586621679870062"><span class="hs-identifier hs-var">isEBB</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870060"><span class="hs-identifier hs-var">lastSecondaryOffset</span></a></span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><span class="annottext">Proxy blk -&gt; HasFS m h -&gt; ChunkNo -&gt; Word32 -&gt; m ()
forall (m :: * -&gt; *) blk h.
(HasCallStack, ConvertRawHash blk, MonadThrow m) =&gt;
Proxy blk -&gt; HasFS m h -&gt; ChunkNo -&gt; Word32 -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#truncateToEntry"><span class="hs-identifier hs-var">Secondary.truncateToEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Proxy t
forall {k} (t :: k). Proxy t
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Proxy.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679868783"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870051"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870060"><span class="hs-identifier hs-var">lastSecondaryOffset</span></a></span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span>        </span><span class="hs-comment">-- Truncate the chunk file.</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679870065"><span class="hs-identifier hs-var">blockSize</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-361"></span><span>          </span><span class="hs-comment">-- The block is the last block in the chunk file, so no need to</span><span>
</span><span id="line-362"></span><span>          </span><span class="hs-comment">-- truncate</span><span>
</span><span id="line-363"></span><span>          </span><span class="annot"><span class="annottext">BlockSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#LastEntry"><span class="hs-identifier hs-var">Secondary.LastEntry</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier hs-type">Secondary.BlockSize</span></a></span><span> </span><span id="local-6989586621679870070"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870070"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>              </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) h a.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679870072"><span class="hs-identifier hs-var">chunkFile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AllowExisting -&gt; OpenMode
</span><span class="hs-identifier hs-var">AppendMode</span></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">AllowExisting</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Handle h -&gt; m ()) -&gt; m ()) -&gt; (Handle h -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679870074"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870074"><span class="hs-identifier hs-var">eHnd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>                </span><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; Word64 -&gt; m ()
</span><span class="hs-identifier hs-var">hTruncate</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870049"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870074"><span class="hs-identifier hs-var">eHnd</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679870076"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-367"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-368"></span><span>              </span><span id="local-6989586621679870072"><span class="annot"><span class="annottext">chunkFile :: FsPath
</span><a href="#local-6989586621679870072"><span class="hs-identifier hs-var hs-var">chunkFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870051"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-369"></span><span>              </span><span id="local-6989586621679870076"><span class="annot"><span class="annottext">offset :: Word64
</span><a href="#local-6989586621679870076"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unBlockOffset"><span class="hs-identifier hs-var">unBlockOffset</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Entry blk -&gt; BlockOffset
forall blk. Entry blk -&gt; BlockOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOffset"><span class="hs-identifier hs-var">Secondary.blockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679870064"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>                        </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870070"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#getTipImpl"><span class="hs-identifier hs-type">getTipImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-373"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868770"><span class="annot"><a href="#local-6989586621679868770"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868771"><span class="annot"><a href="#local-6989586621679868771"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868770"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679868771"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868770"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868771"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679868770"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithOrigin</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868771"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span id="getTipImpl"><span class="annot"><span class="annottext">getTipImpl :: forall (m :: * -&gt; *) blk.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ImmutableDBEnv m blk -&gt; STM m (WithOrigin (Tip blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#getTipImpl"><span class="hs-identifier hs-var hs-var">getTipImpl</span></a></span></span><span> </span><span id="local-6989586621679870100"><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870100"><span class="hs-identifier hs-var">dbEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Util.html#SomePair"><span class="hs-identifier hs-type">SomePair</span></a></span><span> </span><span id="local-6989586621679870103"><span class="annot"><span class="annottext">HasFS m a
</span><a href="#local-6989586621679870103"><span class="hs-identifier hs-var">_hasFS</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679870104"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
currentTip :: forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; WithOrigin (Tip blk)
currentTip :: WithOrigin (Tip blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentTip"><span class="hs-identifier hs-var hs-var">currentTip</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; STM m (SomePair (HasFS m) (OpenState m blk))
forall (m :: * -&gt; *) blk.
(HasCallStack, IOLike m, StandardHash blk, Typeable blk) =&gt;
ImmutableDBEnv m blk
-&gt; STM m (SomePair (HasFS m) (OpenState m blk))
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#getOpenState"><span class="hs-identifier hs-var">getOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870100"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-378"></span><span>    </span><span class="annot"><span class="annottext">WithOrigin (Tip blk) -&gt; STM m (WithOrigin (Tip blk))
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870104"><span class="hs-identifier hs-var">currentTip</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier hs-type">getBlockComponentImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-381"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868774"><span class="annot"><a href="#local-6989586621679868774"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868773"><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span></span><span> </span><span id="local-6989586621679868775"><span class="annot"><a href="#local-6989586621679868775"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-382"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-383"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#ReconstructNestedCtxt"><span class="hs-identifier hs-type">ReconstructNestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-384"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDisk"><span class="hs-identifier hs-type">DecodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">Lazy.ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#DecodeDiskDep"><span class="hs-identifier hs-type">DecodeDiskDep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Block.NestedContent.html#NestedCtxt"><span class="hs-identifier hs-type">NestedCtxt</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#Header"><span class="hs-identifier hs-type">Header</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-386"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868774"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-387"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868774"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BlockComponent"><span class="hs-identifier hs-type">BlockComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868775"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.RealPoint.html#RealPoint"><span class="hs-identifier hs-type">RealPoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868774"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#MissingBlock"><span class="hs-identifier hs-type">MissingBlock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868773"><span class="hs-identifier hs-type">blk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679868775"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span id="getBlockComponentImpl"><span class="annot"><span class="annottext">getBlockComponentImpl :: forall (m :: * -&gt; *) blk b.
(HasHeader blk, ReconstructNestedCtxt Header blk,
 DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk, IOLike m) =&gt;
ImmutableDBEnv m blk
-&gt; BlockComponent blk b
-&gt; RealPoint blk
-&gt; m (Either (MissingBlock blk) b)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#getBlockComponentImpl"><span class="hs-identifier hs-var hs-var">getBlockComponentImpl</span></a></span></span><span> </span><span id="local-6989586621679870121"><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870121"><span class="hs-identifier hs-var">dbEnv</span></a></span></span><span> </span><span id="local-6989586621679870122"><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679870122"><span class="hs-identifier hs-var">blockComponent</span></a></span></span><span> </span><span id="local-6989586621679870123"><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679870123"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; (forall {h}.
    HasFS m h -&gt; OpenState m blk h -&gt; m (Either (MissingBlock blk) b))
-&gt; m (Either (MissingBlock blk) b)
forall (m :: * -&gt; *) blk r.
(HasCallStack, IOLike m, StandardHash blk, Typeable blk) =&gt;
ImmutableDBEnv m blk
-&gt; (forall h. HasFS m h -&gt; OpenState m blk h -&gt; m r) -&gt; m r
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#withOpenState"><span class="hs-identifier hs-var">withOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870121"><span class="hs-identifier hs-var">dbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}.
  HasFS m h -&gt; OpenState m blk h -&gt; m (Either (MissingBlock blk) b))
 -&gt; m (Either (MissingBlock blk) b))
-&gt; (forall {h}.
    HasFS m h -&gt; OpenState m blk h -&gt; m (Either (MissingBlock blk) b))
-&gt; m (Either (MissingBlock blk) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679870160"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870160"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span class="hs-special">{</span><span id="local-6989586621679870161"><span id="local-6989586621679870162"><span id="local-6989586621679870163"><span id="local-6989586621679870164"><span id="local-6989586621679870165"><span id="local-6989586621679870166"><span id="local-6989586621679870167"><span id="local-6989586621679870168"><span class="annot"><span class="annottext">Word32
WithOrigin (Tip blk)
Handle h
ChunkNo
BlockOffset
Index m blk h
currentIndex :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Index m blk h
currentTip :: forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; WithOrigin (Tip blk)
currentChunk :: ChunkNo
currentChunkOffset :: BlockOffset
currentSecondaryOffset :: Word32
currentChunkHandle :: Handle h
currentPrimaryHandle :: Handle h
currentSecondaryHandle :: Handle h
currentTip :: WithOrigin (Tip blk)
currentIndex :: Index m blk h
currentChunk :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; ChunkNo
currentChunkOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; BlockOffset
currentSecondaryOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Word32
currentChunkHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentPrimaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentSecondaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentIndex"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExceptT (MissingBlock blk) m b -&gt; m (Either (MissingBlock blk) b)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Except.html#runExceptT"><span class="hs-identifier hs-var">runExceptT</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT (MissingBlock blk) m b -&gt; m (Either (MissingBlock blk) b))
-&gt; ExceptT (MissingBlock blk) m b
-&gt; m (Either (MissingBlock blk) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>      </span><span id="local-6989586621679870175"><span class="annot"><span class="annottext">(ChunkSlot, (Entry blk, BlockSize), Word32)
</span><a href="#local-6989586621679870175"><span class="hs-identifier hs-var">slotInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk) m (ChunkSlot, (Entry blk, BlockSize), Word32)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, HasHeader blk) =&gt;
ChunkInfo
-&gt; Index m blk h
-&gt; WithOrigin (Tip blk)
-&gt; RealPoint blk
-&gt; ExceptT
     (MissingBlock blk) m (ChunkSlot, (Entry blk, BlockSize), Word32)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#getSlotInfo"><span class="hs-identifier hs-var">getSlotInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870177"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870168"><span class="hs-identifier hs-var">currentIndex</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870167"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">RealPoint blk
</span><a href="#local-6989586621679870123"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-395"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span> </span><span id="local-6989586621679870178"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870178"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679870179"><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679870179"><span class="hs-identifier hs-var">entry</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870180"><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679870180"><span class="hs-identifier hs-var">blockSize</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870181"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870181"><span class="hs-identifier hs-var">_secondaryOffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChunkSlot, (Entry blk, BlockSize), Word32)
</span><a href="#local-6989586621679870175"><span class="hs-identifier hs-var">slotInfo</span></a></span><span>
</span><span id="line-396"></span><span>          </span><span id="local-6989586621679870182"><span class="annot"><span class="annottext">chunkFile :: FsPath
</span><a href="#local-6989586621679870182"><span class="hs-identifier hs-var hs-var">chunkFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; FsPath
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Util.html#fsPathChunkFile"><span class="hs-identifier hs-var">fsPathChunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870178"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-397"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679870184"><span class="annot"><span class="annottext">BlockOffset
blockOffset :: forall blk. Entry blk -&gt; BlockOffset
blockOffset :: BlockOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOffset"><span class="hs-identifier hs-var hs-var">blockOffset</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679870179"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>      </span><span class="hs-comment">-- TODO don't open the 'chunkFile' unless we need to. In practice,</span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-comment">-- we only use this to read (raw) blocks or (raw) headers, which</span><span>
</span><span id="line-401"></span><span>      </span><span class="hs-comment">-- does require opening the 'chunkFile'. Related: #2227.</span><span>
</span><span id="line-402"></span><span>      </span><span class="annot"><span class="annottext">m b -&gt; ExceptT (MissingBlock blk) m b
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (MissingBlock blk) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; ExceptT (MissingBlock blk) m b)
-&gt; m b -&gt; ExceptT (MissingBlock blk) m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) h a.
(HasCallStack, MonadThrow m) =&gt;
HasFS m h -&gt; FsPath -&gt; OpenMode -&gt; (Handle h -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870160"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">FsPath
</span><a href="#local-6989586621679870182"><span class="hs-identifier hs-var">chunkFile</span></a></span><span> </span><span class="annot"><span class="annottext">OpenMode
</span><span class="hs-identifier hs-var">ReadMode</span></span><span> </span><span class="annot"><span class="annottext">((Handle h -&gt; m b) -&gt; m b) -&gt; (Handle h -&gt; m b) -&gt; m b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679870186"><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870186"><span class="hs-identifier hs-var">eHnd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>        </span><span id="local-6989586621679870187"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870187"><span class="hs-identifier hs-var">actualBlockSize</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BlockSize
</span><a href="#local-6989586621679870180"><span class="hs-identifier hs-var">blockSize</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-405"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#BlockSize"><span class="hs-identifier hs-type">Secondary.BlockSize</span></a></span><span> </span><span id="local-6989586621679870188"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870188"><span class="hs-identifier hs-var">size</span></a></span></span><span>
</span><span id="line-406"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; m Word32
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870188"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-407"></span><span>          </span><span class="hs-comment">-- See the 'GetBlock' case for more info about</span><span>
</span><span id="line-408"></span><span>          </span><span class="hs-comment">-- 'Secondary.LastEntry'.</span><span>
</span><span id="line-409"></span><span>          </span><span class="annot"><span class="annottext">BlockSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#LastEntry"><span class="hs-identifier hs-var">Secondary.LastEntry</span></a></span><span>
</span><span id="line-410"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870178"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870161"><span class="hs-identifier hs-var">currentChunk</span></a></span><span>
</span><span id="line-411"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; m Word32
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; m Word32) -&gt; Word32 -&gt; m Word32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockOffset -&gt; Word32) -&gt; BlockOffset -&gt; Word32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679870162"><span class="hs-identifier hs-var">currentChunkOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; BlockOffset -&gt; BlockOffset
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679870184"><span class="hs-identifier hs-var">blockOffset</span></a></span><span>
</span><span id="line-412"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-413"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-414"></span><span>              </span><span class="hs-comment">-- With cached indices, we'll never hit this case.</span><span>
</span><span id="line-415"></span><span>              </span><span id="local-6989586621679870189"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679870189"><span class="hs-identifier hs-var">offsetAfterLastBlock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
forall (m :: * -&gt; *) h.
HasFS m h -&gt; HasCallStack =&gt; Handle h -&gt; m Word64
</span><span class="hs-identifier hs-var">hGetSize</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870160"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870186"><span class="hs-identifier hs-var">eHnd</span></a></span><span>
</span><span id="line-416"></span><span>              </span><span class="annot"><span class="annottext">Word32 -&gt; m Word32
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Word32 -&gt; m Word32) -&gt; Word32 -&gt; m Word32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Word32) -&gt; Word64 -&gt; Word32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-417"></span><span>                </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679870189"><span class="hs-identifier hs-var">offsetAfterLastBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#unBlockOffset"><span class="hs-identifier hs-var">unBlockOffset</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679870184"><span class="hs-identifier hs-var">blockOffset</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span>        </span><span class="annot"><span class="annottext">HasFS m h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; CodecConfig blk
-&gt; (blk -&gt; Bool)
-&gt; Handle h
-&gt; WithBlockSize (Entry blk)
-&gt; BlockComponent blk b
-&gt; m b
forall (m :: * -&gt; *) blk b h.
(HasHeader blk, ReconstructNestedCtxt Header blk,
 DecodeDisk blk (ByteString -&gt; blk),
 DecodeDiskDep (NestedCtxt Header) blk, IOLike m) =&gt;
HasFS m h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; CodecConfig blk
-&gt; (blk -&gt; Bool)
-&gt; Handle h
-&gt; WithBlockSize (Entry blk)
-&gt; BlockComponent blk b
-&gt; m b
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Iterator.html#extractBlockComponent"><span class="hs-identifier hs-var">extractBlockComponent</span></a></span><span>
</span><span id="line-420"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870160"><span class="hs-identifier hs-var">hasFS</span></a></span><span>
</span><span id="line-421"></span><span>          </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870177"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-422"></span><span>          </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870178"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-423"></span><span>          </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679870192"><span class="hs-identifier hs-var">codecConfig</span></a></span><span>
</span><span id="line-424"></span><span>          </span><span class="annot"><span class="annottext">blk -&gt; Bool
</span><a href="#local-6989586621679870193"><span class="hs-identifier hs-var">checkIntegrity</span></a></span><span>
</span><span id="line-425"></span><span>          </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870186"><span class="hs-identifier hs-var">eHnd</span></a></span><span>
</span><span id="line-426"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Entry blk -&gt; WithBlockSize (Entry blk)
forall a. Word32 -&gt; a -&gt; WithBlockSize a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-var">WithBlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870187"><span class="hs-identifier hs-var">actualBlockSize</span></a></span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679870179"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>          </span><span class="annot"><span class="annottext">BlockComponent blk b
</span><a href="#local-6989586621679870122"><span class="hs-identifier hs-var">blockComponent</span></a></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-429"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679870177"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; ChunkInfo
chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870192"><span class="annot"><span class="annottext">CodecConfig blk
codecConfig :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; CodecConfig blk
codecConfig :: CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#codecConfig"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870193"><span class="annot"><span class="annottext">blk -&gt; Bool
checkIntegrity :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; blk -&gt; Bool
checkIntegrity :: blk -&gt; Bool
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#checkIntegrity"><span class="hs-identifier hs-var hs-var">checkIntegrity</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870121"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#appendBlockImpl"><span class="hs-identifier hs-type">appendBlockImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-432"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868778"><span class="annot"><a href="#local-6989586621679868778"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868777"><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-433"></span><span>     </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-434"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#GetHeader"><span class="hs-identifier hs-type">GetHeader</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-435"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#EncodeDisk"><span class="hs-identifier hs-type">EncodeDisk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-436"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Serialisation.html#HasBinaryBlockInfo"><span class="hs-identifier hs-type">HasBinaryBlockInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-437"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868778"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-438"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-439"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868778"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-442"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679868778"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span id="appendBlockImpl"><span class="annot"><span class="annottext">appendBlockImpl :: forall (m :: * -&gt; *) blk.
(HasHeader blk, GetHeader blk, EncodeDisk blk blk,
 HasBinaryBlockInfo blk, IOLike m, HasCallStack) =&gt;
ImmutableDBEnv m blk -&gt; blk -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#appendBlockImpl"><span class="hs-identifier hs-var hs-var">appendBlockImpl</span></a></span></span><span> </span><span id="local-6989586621679870218"><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870218"><span class="hs-identifier hs-var">dbEnv</span></a></span></span><span> </span><span id="local-6989586621679870219"><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679870219"><span class="hs-identifier hs-var">blk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-444"></span><span>    </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall (m :: * -&gt; *) blk a.
(HasCallStack, IOLike m, StandardHash blk, Typeable blk) =&gt;
ImmutableDBEnv m blk
-&gt; (forall h. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h a)
-&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#modifyOpenState"><span class="hs-identifier hs-var">modifyOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870218"><span class="hs-identifier hs-var">dbEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
 -&gt; m ())
-&gt; (forall {h}. Eq h =&gt; HasFS m h -&gt; ModifyOpenState m blk h ())
-&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679870281"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870281"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-445"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-446"></span><span>          </span><span class="annot"><span class="annottext">currentTip :: forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; WithOrigin (Tip blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentTip"><span class="hs-identifier hs-var">currentTip</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679870282"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870282"><span class="hs-identifier hs-var">initialTip</span></a></span></span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentIndex :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Index m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentIndex"><span class="hs-identifier hs-var">currentIndex</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679870283"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870283"><span class="hs-identifier hs-var">index</span></a></span></span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">currentChunk :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunk"><span class="hs-identifier hs-var">currentChunk</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679870284"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870284"><span class="hs-identifier hs-var">initialChunk</span></a></span></span><span>
</span><span id="line-449"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (OpenState m blk h)
  (WithTempRegistry (OpenState m blk h) m)
  (OpenState m blk h)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span>      </span><span class="hs-comment">-- Check that we're not appending to the past</span><span>
</span><span id="line-452"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679870288"><span class="annot"><span class="annottext">blockAfterTip :: Bool
</span><a href="#local-6989586621679870288"><span class="hs-identifier hs-var hs-var">blockAfterTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-453"></span><span>            </span><span class="annot"><span class="annottext">CompareTip blk -&gt; WithOrigin (CompareTip blk)
forall t. t -&gt; WithOrigin t
</span><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-var">NotOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; CompareTip blk
forall blk. Tip blk -&gt; CompareTip blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#CompareTip"><span class="hs-identifier hs-var">CompareTip</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679870289"><span class="hs-identifier hs-var">blockTip</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WithOrigin (CompareTip blk) -&gt; WithOrigin (CompareTip blk) -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tip blk -&gt; CompareTip blk
forall blk. Tip blk -&gt; CompareTip blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#CompareTip"><span class="hs-identifier hs-var">CompareTip</span></a></span><span> </span><span class="annot"><span class="annottext">(Tip blk -&gt; CompareTip blk)
-&gt; WithOrigin (Tip blk) -&gt; WithOrigin (CompareTip blk)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870282"><span class="hs-identifier hs-var">initialTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679870288"><span class="hs-identifier hs-var">blockAfterTip</span></a></span><span> </span><span class="annot"><span class="annottext">(ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ())
-&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState m blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState m blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-456"></span><span>        </span><span class="annot"><span class="annottext">ApiMisuse blk -&gt; WithTempRegistry (OpenState m blk h) m ()
forall (m :: * -&gt; *) blk a.
(MonadThrow m, HasCallStack, StandardHash blk, Typeable blk) =&gt;
ApiMisuse blk -&gt; m a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#throwApiMisuse"><span class="hs-identifier hs-var">throwApiMisuse</span></a></span><span> </span><span class="annot"><span class="annottext">(ApiMisuse blk -&gt; WithTempRegistry (OpenState m blk h) m ())
-&gt; ApiMisuse blk -&gt; WithTempRegistry (OpenState m blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-457"></span><span>          </span><span class="annot"><span class="annottext">RealPoint blk -&gt; Point blk -&gt; ApiMisuse blk
forall blk. RealPoint blk -&gt; Point blk -&gt; ApiMisuse blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#AppendBlockNotNewerThanTipError"><span class="hs-identifier hs-var">AppendBlockNotNewerThanTipError</span></a></span><span>
</span><span id="line-458"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; RealPoint blk
forall blk. HasHeader blk =&gt; blk -&gt; RealPoint blk
</span><a href="Ouroboros.Consensus.Block.RealPoint.html#blockRealPoint"><span class="hs-identifier hs-var">blockRealPoint</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679870219"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithOrigin (Tip blk) -&gt; Point blk
forall blk. WithOrigin (Tip blk) -&gt; Point blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipToPoint"><span class="hs-identifier hs-var">tipToPoint</span></a></span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870282"><span class="hs-identifier hs-var">initialTip</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span>      </span><span class="hs-comment">-- If the slot is in a chunk &gt; the current one, we have to finalise the</span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-comment">-- current one and start a new chunk file, possibly skipping some chunks.</span><span>
</span><span id="line-463"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870295"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870284"><span class="hs-identifier hs-var">initialChunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ())
-&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-464"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679870296"><span class="hs-identifier hs-type">newChunksToStart</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-465"></span><span>            </span><span id="local-6989586621679870296"><span class="annot"><span class="annottext">newChunksToStart :: Int
</span><a href="#local-6989586621679870296"><span class="hs-identifier hs-var hs-var">newChunksToStart</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Int) -&gt; Word64 -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#countChunks"><span class="hs-identifier hs-var">countChunks</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870295"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870284"><span class="hs-identifier hs-var">initialChunk</span></a></span><span>
</span><span id="line-466"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#replicateM_"><span class="hs-identifier hs-var">replicateM_</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679870296"><span class="hs-identifier hs-var">newChunksToStart</span></a></span><span> </span><span class="annot"><span class="annottext">(ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ())
-&gt; ModifyOpenState m blk h () -&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-467"></span><span>          </span><span class="annot"><span class="annottext">HasFS m h
-&gt; Index m blk h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) h blk.
(HasCallStack, IOLike m, Eq h) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; ModifyOpenState m blk h ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#startNewChunk"><span class="hs-identifier hs-var">startNewChunk</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870281"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870283"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870299"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870284"><span class="hs-identifier hs-var">initialChunk</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>      </span><span class="hs-comment">-- We may have updated the state with 'startNewChunk', so get the</span><span>
</span><span id="line-470"></span><span>      </span><span class="hs-comment">-- (possibly) updated state.</span><span>
</span><span id="line-471"></span><span>      </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-472"></span><span>          </span><span id="local-6989586621679870300"><span class="annot"><span class="annottext">WithOrigin (Tip blk)
currentTip :: forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; WithOrigin (Tip blk)
currentTip :: WithOrigin (Tip blk)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentTip"><span class="hs-identifier hs-var hs-var">currentTip</span></a></span></span><span>
</span><span id="line-473"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870301"><span class="annot"><span class="annottext">Handle h
currentChunkHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentChunkHandle :: Handle h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunkHandle"><span class="hs-identifier hs-var hs-var">currentChunkHandle</span></a></span></span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870302"><span class="annot"><span class="annottext">BlockOffset
currentChunkOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; BlockOffset
currentChunkOffset :: BlockOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunkOffset"><span class="hs-identifier hs-var hs-var">currentChunkOffset</span></a></span></span><span>
</span><span id="line-475"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870303"><span class="annot"><span class="annottext">Handle h
currentSecondaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentSecondaryHandle :: Handle h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentSecondaryHandle"><span class="hs-identifier hs-var hs-var">currentSecondaryHandle</span></a></span></span><span>
</span><span id="line-476"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870304"><span class="annot"><span class="annottext">Word32
currentSecondaryOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Word32
currentSecondaryOffset :: Word32
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentSecondaryOffset"><span class="hs-identifier hs-var hs-var">currentSecondaryOffset</span></a></span></span><span>
</span><span id="line-477"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870305"><span class="annot"><span class="annottext">Handle h
currentPrimaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentPrimaryHandle :: Handle h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentPrimaryHandle"><span class="hs-identifier hs-var hs-var">currentPrimaryHandle</span></a></span></span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (OpenState m blk h)
  (WithTempRegistry (OpenState m blk h) m)
  (OpenState m blk h)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>      </span><span class="hs-comment">-- Compute the next empty slot @m@, if we need to write to slot @n@, we</span><span>
</span><span id="line-481"></span><span>      </span><span class="hs-comment">-- will need to backfill @n - m@ slots.</span><span>
</span><span id="line-482"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679870306"><span class="hs-identifier hs-type">nextFreeRelSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#RelativeSlot"><span class="hs-identifier hs-type">RelativeSlot</span></a></span><span>
</span><span id="line-483"></span><span>          </span><span id="local-6989586621679870306"><span class="annot"><span class="annottext">nextFreeRelSlot :: RelativeSlot
</span><a href="#local-6989586621679870306"><span class="hs-identifier hs-var hs-var">nextFreeRelSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-484"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870295"><span class="hs-identifier hs-var">chunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870284"><span class="hs-identifier hs-var">initialChunk</span></a></span><span>
</span><span id="line-485"></span><span>              </span><span class="hs-comment">-- If we had to start a new chunk, we start with slot 0. Note that</span><span>
</span><span id="line-486"></span><span>              </span><span class="hs-comment">-- in this case the 'currentTip' will refer to something in a</span><span>
</span><span id="line-487"></span><span>              </span><span class="hs-comment">-- chunk before 'currentChunk'.</span><span>
</span><span id="line-488"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; ChunkNo -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#firstBlockOrEBB"><span class="hs-identifier hs-var">firstBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870299"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870295"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-489"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870300"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-490"></span><span>                </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; ChunkNo -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#firstBlockOrEBB"><span class="hs-identifier hs-var">firstBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870299"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span>
</span><span id="line-491"></span><span>                </span><span class="hs-comment">-- Invariant: the currently open chunk is never full</span><span>
</span><span id="line-492"></span><span>                </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621679870308"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679870308"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; RelativeSlot -&gt; RelativeSlot
RelativeSlot -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#unsafeNextRelativeSlot"><span class="hs-identifier hs-var">unsafeNextRelativeSlot</span></a></span><span> </span><span class="annot"><span class="annottext">(RelativeSlot -&gt; RelativeSlot)
-&gt; (ChunkSlot -&gt; RelativeSlot) -&gt; ChunkSlot -&gt; RelativeSlot
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkSlot -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkRelative"><span class="hs-identifier hs-var">chunkRelative</span></a></span><span> </span><span class="annot"><span class="annottext">(ChunkSlot -&gt; RelativeSlot) -&gt; ChunkSlot -&gt; RelativeSlot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-493"></span><span>                                   </span><span class="annot"><span class="annottext">ChunkInfo -&gt; Tip blk -&gt; ChunkSlot
forall blk. ChunkInfo -&gt; Tip blk -&gt; ChunkSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkSlotForTip"><span class="hs-identifier hs-var">chunkSlotForTip</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870299"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679870308"><span class="hs-identifier hs-var">tip</span></a></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span>      </span><span class="hs-comment">-- Append to the end of the chunk file.</span><span>
</span><span id="line-496"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679870311"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679870311"><span class="hs-identifier hs-var">blockSize</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870312"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870312"><span class="hs-identifier hs-var">entrySize</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState m blk h) m (Word64, Word32)
-&gt; StateT
     (OpenState m blk h)
     (WithTempRegistry (OpenState m blk h) m)
     (Word64, Word32)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m (Word64, Word32)
 -&gt; StateT
      (OpenState m blk h)
      (WithTempRegistry (OpenState m blk h) m)
      (Word64, Word32))
-&gt; WithTempRegistry (OpenState m blk h) m (Word64, Word32)
-&gt; StateT
     (OpenState m blk h)
     (WithTempRegistry (OpenState m blk h) m)
     (Word64, Word32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m (Word64, Word32)
-&gt; WithTempRegistry (OpenState m blk h) m (Word64, Word32)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Word64, Word32)
 -&gt; WithTempRegistry (OpenState m blk h) m (Word64, Word32))
-&gt; m (Word64, Word32)
-&gt; WithTempRegistry (OpenState m blk h) m (Word64, Word32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span>          </span><span class="hs-comment">-- Write to the chunk file</span><span>
</span><span id="line-499"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679870314"><span class="annot"><span class="annottext">bytes :: ByteString
</span><a href="#local-6989586621679870314"><span class="hs-identifier hs-var hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Encoding -&gt; ByteString
</span><span class="hs-identifier hs-var">CBOR.toLazyByteString</span></span><span> </span><span class="annot"><span class="annottext">(Encoding -&gt; ByteString) -&gt; Encoding -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk -&gt; blk -&gt; Encoding
forall blk a. EncodeDisk blk a =&gt; CodecConfig blk -&gt; a -&gt; Encoding
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#encodeDisk"><span class="hs-identifier hs-var">encodeDisk</span></a></span><span> </span><span class="annot"><span class="annottext">CodecConfig blk
</span><a href="#local-6989586621679870317"><span class="hs-identifier hs-var">codecConfig</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679870219"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-500"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679870318"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679870318"><span class="hs-identifier hs-var">blockSize</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870319"><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679870319"><span class="hs-identifier hs-var">crc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m (Word64, CRC)
forall (m :: * -&gt; *) h.
(HasCallStack, Monad m) =&gt;
HasFS m h -&gt; Handle h -&gt; ByteString -&gt; m (Word64, CRC)
</span><span class="hs-identifier hs-var">hPutAllCRC</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870281"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870301"><span class="hs-identifier hs-var">currentChunkHandle</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679870314"><span class="hs-identifier hs-var">bytes</span></a></span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span>          </span><span class="hs-comment">-- Write to the secondary index file</span><span>
</span><span id="line-503"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679870321"><span class="annot"><span class="annottext">entry :: Entry blk
</span><a href="#local-6989586621679870321"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#Entry"><span class="hs-identifier hs-type">Secondary.Entry</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-504"></span><span>                  </span><span class="annot"><span class="annottext">blockOffset :: BlockOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOffset"><span class="hs-identifier hs-var">blockOffset</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockOffset
</span><a href="#local-6989586621679870302"><span class="hs-identifier hs-var">currentChunkOffset</span></a></span><span>
</span><span id="line-505"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">headerOffset :: HeaderOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerOffset"><span class="hs-identifier hs-var">headerOffset</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; HeaderOffset
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#HeaderOffset"><span class="hs-identifier hs-var">HeaderOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679870324"><span class="hs-identifier hs-var">headerOffset</span></a></span><span>
</span><span id="line-506"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">headerSize :: HeaderSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerSize"><span class="hs-identifier hs-var">headerSize</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; HeaderSize
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#HeaderSize"><span class="hs-identifier hs-var">HeaderSize</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679870327"><span class="hs-identifier hs-var">headerSize</span></a></span><span>
</span><span id="line-507"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">checksum :: CRC
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#checksum"><span class="hs-identifier hs-var">checksum</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CRC
</span><a href="#local-6989586621679870319"><span class="hs-identifier hs-var">crc</span></a></span><span>
</span><span id="line-508"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">headerHash :: HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#headerHash"><span class="hs-identifier hs-var">headerHash</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tip blk -&gt; HeaderHash blk
forall blk. Tip blk -&gt; HeaderHash blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#tipHash"><span class="hs-identifier hs-var">tipHash</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679870289"><span class="hs-identifier hs-var">blockTip</span></a></span><span>
</span><span id="line-509"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">blockOrEBB :: BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Secondary.html#blockOrEBB"><span class="hs-identifier hs-var">blockOrEBB</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockOrEBB
</span><a href="#local-6989586621679870332"><span class="hs-identifier hs-var">blockOrEBB</span></a></span><span>
</span><span id="line-510"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-511"></span><span>          </span><span id="local-6989586621679870333"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870333"><span class="hs-identifier hs-var">entrySize</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-512"></span><span>            </span><span class="annot"><span class="annottext">Word64 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Word32) -&gt; m Word64 -&gt; m Word32
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-513"></span><span>              </span><span class="annot"><span class="annottext">Index m blk h
-&gt; HasCallStack =&gt;
   ChunkNo -&gt; Handle h -&gt; WithBlockSize (Entry blk) -&gt; m Word64
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; HasCallStack =&gt;
   ChunkNo -&gt; Handle h -&gt; WithBlockSize (Entry blk) -&gt; m Word64
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendEntry"><span class="hs-identifier hs-var">Index.appendEntry</span></a></span><span>
</span><span id="line-514"></span><span>                </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870283"><span class="hs-identifier hs-var">index</span></a></span><span>
</span><span id="line-515"></span><span>                </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870295"><span class="hs-identifier hs-var">chunk</span></a></span><span>
</span><span id="line-516"></span><span>                </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870303"><span class="hs-identifier hs-var">currentSecondaryHandle</span></a></span><span>
</span><span id="line-517"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Entry blk -&gt; WithBlockSize (Entry blk)
forall a. Word32 -&gt; a -&gt; WithBlockSize a
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#WithBlockSize"><span class="hs-identifier hs-var">WithBlockSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679870318"><span class="hs-identifier hs-var">blockSize</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Entry blk
</span><a href="#local-6989586621679870321"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>
</span><span id="line-519"></span><span>          </span><span class="hs-comment">-- Write to the primary index file</span><span>
</span><span id="line-520"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679870335"><span class="annot"><span class="annottext">backfillOffsets :: [Word32]
</span><a href="#local-6989586621679870335"><span class="hs-identifier hs-var hs-var">backfillOffsets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-521"></span><span>                </span><span class="annot"><span class="annottext">RelativeSlot -&gt; RelativeSlot -&gt; Word32 -&gt; [Word32]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#backfill"><span class="hs-identifier hs-var">Primary.backfill</span></a></span><span>
</span><span id="line-522"></span><span>                  </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870337"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-523"></span><span>                  </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870306"><span class="hs-identifier hs-var">nextFreeRelSlot</span></a></span><span>
</span><span id="line-524"></span><span>                  </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870304"><span class="hs-identifier hs-var">currentSecondaryOffset</span></a></span><span>
</span><span id="line-525"></span><span>              </span><span id="local-6989586621679870341"><span class="annot"><span class="annottext">offsets :: [Word32]
</span><a href="#local-6989586621679870341"><span class="hs-identifier hs-var hs-var">offsets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679870335"><span class="hs-identifier hs-var">backfillOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">[Word32] -&gt; [Word32] -&gt; [Word32]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870304"><span class="hs-identifier hs-var">currentSecondaryOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870333"><span class="hs-identifier hs-var">entrySize</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-526"></span><span>          </span><span class="annot"><span class="annottext">Index m blk h
-&gt; forall (f :: * -&gt; *).
   (HasCallStack, Foldable f) =&gt;
   Handle h -&gt; f Word32 -&gt; m ()
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (f :: * -&gt; *).
   (HasCallStack, Foldable f) =&gt;
   Handle h -&gt; f Word32 -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendOffsets"><span class="hs-identifier hs-var">Index.appendOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870283"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870305"><span class="hs-identifier hs-var">currentPrimaryHandle</span></a></span><span> </span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679870341"><span class="hs-identifier hs-var">offsets</span></a></span><span>
</span><span id="line-527"></span><span>
</span><span id="line-528"></span><span>          </span><span class="annot"><span class="annottext">(Word64, Word32) -&gt; m (Word64, Word32)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679870318"><span class="hs-identifier hs-var">blockSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870333"><span class="hs-identifier hs-var">entrySize</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span>      </span><span class="annot"><span class="annottext">(OpenState m blk h -&gt; OpenState m blk h)
-&gt; ModifyOpenState m blk h ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((OpenState m blk h -&gt; OpenState m blk h)
 -&gt; ModifyOpenState m blk h ())
-&gt; (OpenState m blk h -&gt; OpenState m blk h)
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679870343"><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679870343"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679870343"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-531"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentChunkOffset"><span class="hs-identifier hs-var">currentChunkOffset</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679870302"><span class="hs-identifier hs-type">currentChunkOffset</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-type">+</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-type">fromIntegral</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679870311"><span class="hs-identifier hs-type">blockSize</span></a></span><span>
</span><span id="line-532"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentSecondaryOffset"><span class="hs-identifier hs-var">currentSecondaryOffset</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679870304"><span class="hs-identifier hs-type">currentSecondaryOffset</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-type">+</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679870312"><span class="hs-identifier hs-type">entrySize</span></a></span><span>
</span><span id="line-533"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentTip"><span class="hs-identifier hs-var">currentTip</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679870289"><span class="hs-identifier hs-type">blockTip</span></a></span><span>
</span><span id="line-534"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-536"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ImmutableDBEnv"><span class="hs-identifier hs-type">ImmutableDBEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679870299"><span class="annot"><span class="annottext">ChunkInfo
chunkInfo :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; ChunkInfo
chunkInfo :: ChunkInfo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#chunkInfo"><span class="hs-identifier hs-var hs-var">chunkInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679870317"><span class="annot"><span class="annottext">CodecConfig blk
codecConfig :: forall (m :: * -&gt; *) blk. ImmutableDBEnv m blk -&gt; CodecConfig blk
codecConfig :: CodecConfig blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#codecConfig"><span class="hs-identifier hs-var hs-var">codecConfig</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImmutableDBEnv m blk
</span><a href="#local-6989586621679870218"><span class="hs-identifier hs-var">dbEnv</span></a></span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span>    </span><span class="annot"><a href="#local-6989586621679870345"><span class="hs-identifier hs-type">newBlockIsEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EpochNo</span></span><span>
</span><span id="line-539"></span><span>    </span><span id="local-6989586621679870345"><span class="annot"><span class="annottext">newBlockIsEBB :: Maybe EpochNo
</span><a href="#local-6989586621679870345"><span class="hs-identifier hs-var hs-var">newBlockIsEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; Maybe EpochNo
forall blk. GetHeader blk =&gt; blk -&gt; Maybe EpochNo
</span><a href="Ouroboros.Consensus.Block.Abstract.html#blockIsEBB"><span class="hs-identifier hs-var">blockIsEBB</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679870219"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span>    </span><span class="annot"><a href="#local-6989586621679870332"><span class="hs-identifier hs-type">blockOrEBB</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#BlockOrEBB"><span class="hs-identifier hs-type">BlockOrEBB</span></a></span><span>
</span><span id="line-542"></span><span>    </span><span id="local-6989586621679870332"><span class="annot"><span class="annottext">blockOrEBB :: BlockOrEBB
</span><a href="#local-6989586621679870332"><span class="hs-identifier hs-var hs-var">blockOrEBB</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="#local-6989586621679870345"><span class="hs-identifier hs-var">newBlockIsEBB</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-543"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679870347"><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679870347"><span class="hs-identifier hs-var">epochNo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EpochNo -&gt; BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#EBB"><span class="hs-identifier hs-var">EBB</span></a></span><span> </span><span class="annot"><span class="annottext">EpochNo
</span><a href="#local-6989586621679870347"><span class="hs-identifier hs-var">epochNo</span></a></span><span>
</span><span id="line-544"></span><span>        </span><span class="annot"><span class="annottext">Maybe EpochNo
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; BlockOrEBB
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Types.html#Block"><span class="hs-identifier hs-var">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">blk -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><span class="hs-identifier hs-var">blockSlot</span></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679870219"><span class="hs-identifier hs-var">blk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span> </span><span id="local-6989586621679870295"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870295"><span class="hs-identifier hs-var">chunk</span></a></span></span><span> </span><span id="local-6989586621679870337"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870337"><span class="hs-identifier hs-var">relSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; BlockOrEBB -&gt; ChunkSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkSlotForBlockOrEBB"><span class="hs-identifier hs-var">chunkSlotForBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870299"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">BlockOrEBB
</span><a href="#local-6989586621679870332"><span class="hs-identifier hs-var">blockOrEBB</span></a></span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><a href="#local-6989586621679870289"><span class="hs-identifier hs-type">blockTip</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#Tip"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868777"><span class="hs-identifier hs-type">blk</span></a></span><span>
</span><span id="line-549"></span><span>    </span><span id="local-6989586621679870289"><span class="annot"><span class="annottext">blockTip :: Tip blk
</span><a href="#local-6989586621679870289"><span class="hs-identifier hs-var hs-var">blockTip</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; Tip blk
forall blk. (HasHeader blk, GetHeader blk) =&gt; blk -&gt; Tip blk
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.API.html#blockToTip"><span class="hs-identifier hs-var">blockToTip</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679870219"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span>    </span><span class="annot"><a href="Ouroboros.Consensus.Storage.Common.html#BinaryBlockInfo"><span class="hs-identifier hs-type">BinaryBlockInfo</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679870324"><span id="local-6989586621679870327"><span class="annot"><span class="annottext">Word16
headerOffset :: Word16
headerSize :: Word16
headerOffset :: BinaryBlockInfo -&gt; Word16
headerSize :: BinaryBlockInfo -&gt; Word16
</span><a href="#local-6989586621679870324"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">blk -&gt; BinaryBlockInfo
forall blk. HasBinaryBlockInfo blk =&gt; blk -&gt; BinaryBlockInfo
</span><a href="Ouroboros.Consensus.Storage.Serialisation.html#getBinaryBlockInfo"><span class="hs-identifier hs-var">getBinaryBlockInfo</span></a></span><span> </span><span class="annot"><span class="annottext">blk
</span><a href="#local-6989586621679870219"><span class="hs-identifier hs-var">blk</span></a></span><span>
</span><span id="line-552"></span><span>
</span><span id="line-553"></span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#startNewChunk"><span class="hs-identifier hs-type">startNewChunk</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-554"></span><span>     </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679868952"><span class="annot"><a href="#local-6989586621679868952"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679868953"><span class="annot"><a href="#local-6989586621679868953"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span id="local-6989586621679868954"><span class="annot"><a href="#local-6989586621679868954"><span class="hs-identifier hs-type">blk</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Util.IOLike.html#IOLike"><span class="hs-identifier hs-type">IOLike</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868952"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868953"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasFS</span></span><span> </span><span class="annot"><a href="#local-6989586621679868952"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868953"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868952"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868954"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868953"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkInfo"><span class="hs-identifier hs-type">ChunkInfo</span></a></span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#ChunkNo"><span class="hs-identifier hs-type">ChunkNo</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Chunk containing the tip</span></span><span>
</span><span id="line-559"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#ModifyOpenState"><span class="hs-identifier hs-type">ModifyOpenState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868952"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868954"><span class="hs-identifier hs-type">blk</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679868953"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span id="startNewChunk"><span class="annot"><span class="annottext">startNewChunk :: forall (m :: * -&gt; *) h blk.
(HasCallStack, IOLike m, Eq h) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ChunkInfo
-&gt; ChunkNo
-&gt; ModifyOpenState m blk h ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.html#startNewChunk"><span class="hs-identifier hs-var hs-var">startNewChunk</span></a></span></span><span> </span><span id="local-6989586621679870388"><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870388"><span class="hs-identifier hs-var">hasFS</span></a></span></span><span> </span><span id="local-6989586621679870389"><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870389"><span class="hs-identifier hs-var">index</span></a></span></span><span> </span><span id="local-6989586621679870390"><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870390"><span class="hs-identifier hs-var">chunkInfo</span></a></span></span><span> </span><span id="local-6989586621679870391"><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870391"><span class="hs-identifier hs-var">tipChunk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621679870392"><span class="annot"><span class="annottext">st :: OpenState m blk h
</span><a href="#local-6989586621679870392"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#OpenState"><span class="hs-identifier hs-type">OpenState</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679870393"><span id="local-6989586621679870394"><span id="local-6989586621679870395"><span id="local-6989586621679870396"><span id="local-6989586621679870397"><span id="local-6989586621679870398"><span id="local-6989586621679870399"><span id="local-6989586621679870400"><span class="annot"><span class="annottext">Word32
WithOrigin (Tip blk)
Handle h
ChunkNo
BlockOffset
Index m blk h
currentIndex :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Index m blk h
currentTip :: forall (m :: * -&gt; *) blk h.
OpenState m blk h -&gt; WithOrigin (Tip blk)
currentChunk :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; ChunkNo
currentChunkOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; BlockOffset
currentSecondaryOffset :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Word32
currentChunkHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentPrimaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentSecondaryHandle :: forall (m :: * -&gt; *) blk h. OpenState m blk h -&gt; Handle h
currentChunk :: ChunkNo
currentChunkOffset :: BlockOffset
currentSecondaryOffset :: Word32
currentChunkHandle :: Handle h
currentPrimaryHandle :: Handle h
currentSecondaryHandle :: Handle h
currentTip :: WithOrigin (Tip blk)
currentIndex :: Index m blk h
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#currentIndex"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  (OpenState m blk h)
  (WithTempRegistry (OpenState m blk h) m)
  (OpenState m blk h)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#get"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span>    </span><span class="hs-comment">-- We have to take care when starting multiple new chunks in a row. In the</span><span>
</span><span id="line-564"></span><span>    </span><span class="hs-comment">-- first call the tip will be in the current chunk, but in subsequent</span><span>
</span><span id="line-565"></span><span>    </span><span class="hs-comment">-- calls, the tip will still be in an chunk in the past, not the</span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-comment">-- 'currentChunk'. In that case, we can't use the relative slot of the</span><span>
</span><span id="line-567"></span><span>    </span><span class="hs-comment">-- tip, since it will point to a relative slot in a past chunk. So when</span><span>
</span><span id="line-568"></span><span>    </span><span class="hs-comment">-- the current (empty) chunk is not the chunk containing the tip, we use</span><span>
</span><span id="line-569"></span><span>    </span><span class="hs-comment">-- relative slot 0 to calculate how much to pad.</span><span>
</span><span id="line-570"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679870401"><span class="hs-identifier hs-type">nextFreeRelSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#NextRelativeSlot"><span class="hs-identifier hs-type">NextRelativeSlot</span></a></span><span>
</span><span id="line-571"></span><span>        </span><span id="local-6989586621679870401"><span class="annot"><span class="annottext">nextFreeRelSlot :: NextRelativeSlot
</span><a href="#local-6989586621679870401"><span class="hs-identifier hs-var hs-var">nextFreeRelSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870399"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-572"></span><span>          </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><span class="hs-identifier hs-var">Origin</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-573"></span><span>            </span><span class="annot"><span class="annottext">RelativeSlot -&gt; NextRelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#NextRelativeSlot"><span class="hs-identifier hs-var">NextRelativeSlot</span></a></span><span> </span><span class="annot"><span class="annottext">(RelativeSlot -&gt; NextRelativeSlot)
-&gt; RelativeSlot -&gt; NextRelativeSlot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; ChunkNo -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#firstBlockOrEBB"><span class="hs-identifier hs-var">firstBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870390"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#firstChunkNo"><span class="hs-identifier hs-var">firstChunkNo</span></a></span><span>
</span><span id="line-574"></span><span>          </span><span class="annot"><a href="Ouroboros.Consensus.Block.Abstract.html#NotOrigin"><span class="hs-identifier hs-type">NotOrigin</span></a></span><span> </span><span id="local-6989586621679870403"><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679870403"><span class="hs-identifier hs-var">tip</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-575"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870391"><span class="hs-identifier hs-var">tipChunk</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870393"><span class="hs-identifier hs-var">currentChunk</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-576"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#ChunkSlot"><span class="hs-identifier hs-type">ChunkSlot</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679870404"><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870404"><span class="hs-identifier hs-var">relSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; Tip blk -&gt; ChunkSlot
forall blk. ChunkInfo -&gt; Tip blk -&gt; ChunkSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#chunkSlotForTip"><span class="hs-identifier hs-var">chunkSlotForTip</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870390"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Tip blk
</span><a href="#local-6989586621679870403"><span class="hs-identifier hs-var">tip</span></a></span><span>
</span><span id="line-577"></span><span>              </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; RelativeSlot -&gt; NextRelativeSlot
RelativeSlot -&gt; NextRelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#nextRelativeSlot"><span class="hs-identifier hs-var">nextRelativeSlot</span></a></span><span> </span><span class="annot"><span class="annottext">RelativeSlot
</span><a href="#local-6989586621679870404"><span class="hs-identifier hs-var">relSlot</span></a></span><span>
</span><span id="line-578"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-579"></span><span>              </span><span class="annot"><span class="annottext">RelativeSlot -&gt; NextRelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#NextRelativeSlot"><span class="hs-identifier hs-var">NextRelativeSlot</span></a></span><span> </span><span class="annot"><span class="annottext">(RelativeSlot -&gt; NextRelativeSlot)
-&gt; RelativeSlot -&gt; NextRelativeSlot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; ChunkNo -&gt; RelativeSlot
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Layout.html#firstBlockOrEBB"><span class="hs-identifier hs-var">firstBlockOrEBB</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870390"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870393"><span class="hs-identifier hs-var">currentChunk</span></a></span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679870406"><span class="annot"><span class="annottext">backfillOffsets :: [Word32]
</span><a href="#local-6989586621679870406"><span class="hs-identifier hs-var hs-var">backfillOffsets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkInfo -&gt; ChunkNo -&gt; NextRelativeSlot -&gt; Word32 -&gt; [Word32]
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.Primary.html#backfillChunk"><span class="hs-identifier hs-var">Primary.backfillChunk</span></a></span><span>
</span><span id="line-582"></span><span>                            </span><span class="annot"><span class="annottext">ChunkInfo
</span><a href="#local-6989586621679870390"><span class="hs-identifier hs-var">chunkInfo</span></a></span><span>
</span><span id="line-583"></span><span>                            </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870393"><span class="hs-identifier hs-var">currentChunk</span></a></span><span>
</span><span id="line-584"></span><span>                            </span><span class="annot"><span class="annottext">NextRelativeSlot
</span><a href="#local-6989586621679870401"><span class="hs-identifier hs-var">nextFreeRelSlot</span></a></span><span>
</span><span id="line-585"></span><span>                            </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679870395"><span class="hs-identifier hs-var">currentSecondaryOffset</span></a></span><span>
</span><span id="line-586"></span><span>
</span><span id="line-587"></span><span>    </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState m blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m ()
 -&gt; ModifyOpenState m blk h ())
-&gt; WithTempRegistry (OpenState m blk h) m ()
-&gt; ModifyOpenState m blk h ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; WithTempRegistry (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; WithTempRegistry (OpenState m blk h) m ())
-&gt; m () -&gt; WithTempRegistry (OpenState m blk h) m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-588"></span><span>      </span><span class="annot"><span class="annottext">Index m blk h
-&gt; forall (f :: * -&gt; *).
   (HasCallStack, Foldable f) =&gt;
   Handle h -&gt; f Word32 -&gt; m ()
forall (m :: * -&gt; *) blk h.
Index m blk h
-&gt; forall (f :: * -&gt; *).
   (HasCallStack, Foldable f) =&gt;
   Handle h -&gt; f Word32 -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.Index.html#appendOffsets"><span class="hs-identifier hs-var">Index.appendOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870389"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="annot"><span class="annottext">Handle h
</span><a href="#local-6989586621679870397"><span class="hs-identifier hs-var">currentPrimaryHandle</span></a></span><span> </span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679870406"><span class="hs-identifier hs-var">backfillOffsets</span></a></span><span>
</span><span id="line-589"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall a b. m a -&gt; m b -&gt; m a
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="annot"><span class="annottext">HasFS m h -&gt; OpenState m blk h -&gt; m ()
forall (m :: * -&gt; *) h blk.
Monad m =&gt;
HasFS m h -&gt; OpenState m blk h -&gt; m ()
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#closeOpenHandles"><span class="hs-identifier hs-var">closeOpenHandles</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870388"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679870392"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span>    </span><span id="local-6989586621679870410"><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679870410"><span class="hs-identifier hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; StateT
     (OpenState m blk h)
     (WithTempRegistry (OpenState m blk h) m)
     (OpenState m blk h)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; StateT (OpenState m blk h) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/transformers-0.6.1.0/src/Control.Monad.Trans.Class.html#lift"><span class="hs-identifier hs-var">lift</span></a></span><span> </span><span class="annot"><span class="annottext">(WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
 -&gt; StateT
      (OpenState m blk h)
      (WithTempRegistry (OpenState m blk h) m)
      (OpenState m blk h))
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
-&gt; StateT
     (OpenState m blk h)
     (WithTempRegistry (OpenState m blk h) m)
     (OpenState m blk h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-592"></span><span>      </span><span class="annot"><span class="annottext">HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
forall (m :: * -&gt; *) blk h.
(HasCallStack, IOLike m, Eq h) =&gt;
HasFS m h
-&gt; Index m blk h
-&gt; ChunkNo
-&gt; WithOrigin (Tip blk)
-&gt; AllowExisting
-&gt; WithTempRegistry (OpenState m blk h) m (OpenState m blk h)
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Impl.State.html#mkOpenState"><span class="hs-identifier hs-var">mkOpenState</span></a></span><span> </span><span class="annot"><span class="annottext">HasFS m h
</span><a href="#local-6989586621679870388"><span class="hs-identifier hs-var">hasFS</span></a></span><span> </span><span class="annot"><span class="annottext">Index m blk h
</span><a href="#local-6989586621679870389"><span class="hs-identifier hs-var">index</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkNo -&gt; ChunkNo
</span><a href="Ouroboros.Consensus.Storage.ImmutableDB.Chunks.Internal.html#nextChunkNo"><span class="hs-identifier hs-var">nextChunkNo</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkNo
</span><a href="#local-6989586621679870393"><span class="hs-identifier hs-var">currentChunk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WithOrigin (Tip blk)
</span><a href="#local-6989586621679870399"><span class="hs-identifier hs-var">currentTip</span></a></span><span> </span><span class="annot"><span class="annottext">AllowExisting
</span><span class="hs-identifier hs-var">MustBeNew</span></span><span>
</span><span id="line-593"></span><span>
</span><span id="line-594"></span><span>    </span><span class="annot"><span class="annottext">OpenState m blk h -&gt; ModifyOpenState m blk h ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/mtl-2.3.1/src/Control.Monad.State.Class.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">OpenState m blk h
</span><a href="#local-6989586621679870410"><span class="hs-identifier hs-var">st'</span></a></span><span>
</span><span id="line-595"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RecordWildCards, CPP, ExistentialQuantification #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE MagicHash, UnboxedTuples #-}</span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Foreign.RemotePtr</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Synopsis</span></span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><span class="hs-comment">-- | Toolbox for managing remote objects in Haskell.</span></span><span>
</span><span id="line-6"></span><span>    </span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><span class="hs-comment">-- * RemotePtr</span></span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier">RemotePtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Foreign.RemotePtr.html#withRemotePtr"><span class="hs-identifier">withRemotePtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#addFinalizer"><span class="hs-identifier">addFinalizer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#destroy"><span class="hs-identifier">destroy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#addReachable"><span class="hs-identifier">addReachable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#clearReachable"><span class="hs-identifier">clearReachable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Foreign.RemotePtr.html#unprotectedGetCoupon"><span class="hs-identifier">unprotectedGetCoupon</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Coupons and Vendors</span></span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier">Coupon</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#newCoupon"><span class="hs-identifier">newCoupon</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier">Vendor</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#newVendor"><span class="hs-identifier">newVendor</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#lookup"><span class="hs-identifier">lookup</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Foreign.RemotePtr.html#newRemotePtr"><span class="hs-identifier">newRemotePtr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Prelude.html"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#lookup"><span class="hs-identifier">lookup</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Concurrent.html"><span class="hs-identifier">Control.Concurrent</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/text-2.0.2/src/Data.Text.html"><span class="hs-identifier">Data.Text</span></a></span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html"><span class="hs-identifier">Data.Functor</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.IORef.html"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/System.IO.Unsafe.html"><span class="hs-identifier">System.IO.Unsafe</span></a></span><span>         </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Unsafe.html#unsafePerformIO"><span class="hs-identifier">unsafePerformIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/System.Mem.Weak.html"><span class="hs-identifier">System.Mem.Weak</span></a></span><span>          </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/System.Mem.Weak.html#addFinalizer"><span class="hs-identifier">addFinalizer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/System.Mem.Weak.html"><span class="hs-identifier">System.Mem.Weak</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Weak</span></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html"><span class="hs-identifier">GHC.Base</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html"><span class="hs-identifier">GHC.Weak</span></a></span><span>  </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html"><span class="hs-identifier">GHC.IORef</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.STRef.html"><span class="hs-identifier">GHC.STRef</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span class="hs-cpp">

#if CABAL
</span><span class="hs-cpp">#if MIN_VERSION_base(4,6,0)
</span><span class="hs-cpp">#else
</span><span class="hs-identifier">atomicModifyIORef'</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">atomicModifyIORef</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">#endif
</span><span>
</span><span id="line-42"></span><span id="local-6989586621679111925"><span id="local-6989586621679111927"><span class="annot"><a href="Foreign.RemotePtr.html#mkWeakIORefValue"><span class="hs-identifier hs-type">mkWeakIORefValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111925"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679111927"><span class="hs-identifier hs-type">value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#Weak"><span class="hs-identifier hs-type">Weak</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111927"><span class="hs-identifier hs-type">value</span></a></span><span class="hs-special">)</span></span></span><span class="hs-cpp">
#if CABAL
</span><span class="hs-cpp">#if MIN_VERSION_base(4,9,0)
</span><span id="mkWeakIORefValue"><span class="annot"><span class="annottext">mkWeakIORefValue :: forall a value. IORef a -&gt; value -&gt; IO () -&gt; IO (Weak value)
</span><a href="Foreign.RemotePtr.html#mkWeakIORefValue"><span class="hs-identifier hs-var hs-var">mkWeakIORefValue</span></a></span></span><span> </span><span id="local-6989586621679112037"><span class="annot"><span class="annottext">r :: IORef a
</span><a href="#local-6989586621679112037"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">GHC.IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.STRef.html#STRef"><span class="hs-identifier hs-type">GHC.STRef</span></a></span><span> </span><span id="local-6989586621679112040"><span class="annot"><span class="annottext">MutVar# RealWorld a
</span><a href="#local-6989586621679112040"><span class="hs-identifier hs-var">r#</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679112041"><span class="annot"><span class="annottext">value
</span><a href="#local-6989586621679112041"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">GHC.IO</span></a></span><span> </span><span id="local-6989586621679112042"><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, () #)
</span><a href="#local-6989586621679112042"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State# RealWorld -&gt; (# State# RealWorld, Weak value #))
-&gt; IO (Weak value)
forall a. (State# RealWorld -&gt; (# State# RealWorld, a #)) -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-var">GHC.IO</span></a></span><span> </span><span class="annot"><span class="annottext">((State# RealWorld -&gt; (# State# RealWorld, Weak value #))
 -&gt; IO (Weak value))
-&gt; (State# RealWorld -&gt; (# State# RealWorld, Weak value #))
-&gt; IO (Weak value)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679112043"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679112043"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld a
-&gt; value
-&gt; (State# RealWorld -&gt; (# State# RealWorld, () #))
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Weak# value #)
forall a b c.
a
-&gt; b
-&gt; (State# RealWorld -&gt; (# State# RealWorld, c #))
-&gt; State# RealWorld
-&gt; (# State# RealWorld, Weak# b #)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Prim.html#mkWeak%23"><span class="hs-identifier hs-var">GHC.mkWeak#</span></a></span><span> </span><span class="annot"><span class="annottext">MutVar# RealWorld a
</span><a href="#local-6989586621679112040"><span class="hs-identifier hs-var">r#</span></a></span><span> </span><span class="annot"><span class="annottext">value
</span><a href="#local-6989586621679112041"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld -&gt; (# State# RealWorld, () #)
</span><a href="#local-6989586621679112042"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679112043"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(#</span><span> </span><span id="local-6989586621679112044"><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679112044"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679112045"><span class="annot"><span class="annottext">Weak# value
</span><a href="#local-6989586621679112045"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">State# RealWorld
</span><a href="#local-6989586621679112044"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Weak# value -&gt; Weak value
forall v. Weak# v -&gt; Weak v
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#Weak"><span class="hs-identifier hs-var">GHC.Weak</span></a></span><span> </span><span class="annot"><span class="annottext">Weak# value
</span><a href="#local-6989586621679112045"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">#)</span><span class="hs-cpp">
#else
</span><span class="hs-identifier">mkWeakIORefValue</span><span> </span><span class="hs-identifier">r</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">GHC.IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">GHC.STRef</span><span> </span><span class="hs-identifier">r#</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">GHC.IO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">GHC.mkWeak#</span><span> </span><span class="hs-identifier">r#</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(#</span><span> </span><span class="hs-identifier">s1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="hs-identifier">s1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">GHC.Weak</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-special">#)</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">#else
</span><span class="hs-identifier">mkWeakIORefValue</span><span> </span><span class="hs-identifier">r</span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-identifier">GHC.IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">GHC.STRef</span><span> </span><span class="hs-identifier">r#</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">GHC.IO</span><span> </span><span class="hs-identifier">f</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">GHC.IO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">GHC.mkWeak#</span><span> </span><span class="hs-identifier">r#</span><span> </span><span class="hs-identifier">v</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">(#</span><span> </span><span class="hs-identifier">s1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-special">#)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="hs-identifier">s1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">GHC.Weak</span><span> </span><span class="hs-identifier">w</span><span> </span><span class="hs-special">#)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-56"></span><span class="hs-keyword">type</span><span> </span><span id="Map"><span class="annot"><a href="Foreign.RemotePtr.html#Map"><span class="hs-identifier hs-var">Map</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map.HashMap</span></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">{-----------------------------------------------------------------------------
    Types
------------------------------------------------------------------------------}</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | A 'Coupon' is a unique identifier.</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- </span><span>
</span><span id="line-63"></span><span class="hs-comment">-- It is a string of alphanumeric ASCII characters and it is intended to</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- be sent to or received from a remote program.</span><span>
</span><span id="line-65"></span><span class="hs-comment">--</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- The data structure 'Vendor' associates 'Coupon's to 'RemotPtr' objects.</span><span>
</span><span id="line-67"></span><span class="hs-keyword">type</span><span> </span><span id="Coupon"><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-var">Coupon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/text-2.0.2/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">T.Text</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">-- | A 'RemotePtr' is a pointer to a foreign object.</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- </span><span>
</span><span id="line-72"></span><span class="hs-comment">-- Like a 'ForeignPtr', it refers to an object managed by an environment</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- external to the Haskell runtime.</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- Likewise, you can assign finalizers to a 'RemotePtr'. The finalizers</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- will be run when the Haskell runtime garbage collects this value.</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- They can perform some cleanup operations, like freeing memory.</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- Unlike a 'ForeignPtr', the object referenced by a 'RemotePtr' is not</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- necessarily a block of RAM. Instead, it can refer to things like an object</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- managed by a remote program.</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-keyword">type</span><span> </span><span id="RemotePtr"><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-var">RemotePtr</span></a></span></span><span> </span><span id="local-6989586621679112049"><span class="annot"><a href="#local-6989586621679112049"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#RemoteData"><span class="hs-identifier hs-type">RemoteData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112049"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">data</span><span> </span><span id="RemoteData"><span class="annot"><a href="Foreign.RemotePtr.html#RemoteData"><span class="hs-identifier hs-var">RemoteData</span></a></span></span><span> </span><span id="local-6989586621679111942"><span class="annot"><a href="#local-6989586621679111942"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RemoteData"><span class="annot"><a href="Foreign.RemotePtr.html#RemoteData"><span class="hs-identifier hs-var">RemoteData</span></a></span></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="self"><span class="annot"><span class="annottext">forall a. RemoteData a -&gt; Weak (RemotePtr a)
</span><a href="Foreign.RemotePtr.html#self"><span class="hs-identifier hs-var hs-var">self</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#Weak"><span class="hs-identifier hs-type">Weak</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111942"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="coupon"><span class="annot"><span class="annottext">forall a. RemoteData a -&gt; Coupon
</span><a href="Foreign.RemotePtr.html#coupon"><span class="hs-identifier hs-var hs-var">coupon</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-type">Coupon</span></a></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="value"><span class="annot"><span class="annottext">forall a. RemoteData a -&gt; a
</span><a href="Foreign.RemotePtr.html#value"><span class="hs-identifier hs-var hs-var">value</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679111942"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="children"><span class="annot"><span class="annottext">forall a. RemoteData a -&gt; IORef [SomeWeak]
</span><a href="Foreign.RemotePtr.html#children"><span class="hs-identifier hs-var hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Foreign.RemotePtr.html#SomeWeak"><span class="hs-identifier hs-type">SomeWeak</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">-- Existentially quantified weak pointer. We only care about its finalizer.</span><span>
</span><span id="line-92"></span><span class="hs-keyword">data</span><span> </span><span id="SomeWeak"><span class="annot"><a href="Foreign.RemotePtr.html#SomeWeak"><span class="hs-identifier hs-var">SomeWeak</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679112055"><span class="annot"><a href="#local-6989586621679112055"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span id="SomeWeak"><span class="annot"><a href="Foreign.RemotePtr.html#SomeWeak"><span class="hs-identifier hs-var">SomeWeak</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#Weak"><span class="hs-identifier hs-type">Weak</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112055"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- | A 'Vendor' is a bijective mapping from 'Coupon' to 'RemotePtr'.</span><span>
</span><span id="line-95"></span><span class="hs-comment">--</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- Every 'Coupon' has at most one 'RemotePtr' associated to it.</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- A single 'RemotePtr' will always be associated with the same 'Coupon'.</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">data</span><span> </span><span id="Vendor"><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-var">Vendor</span></a></span></span><span> </span><span id="local-6989586621679111951"><span class="annot"><a href="#local-6989586621679111951"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Vendor"><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-var">Vendor</span></a></span></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="coupons"><span class="annot"><span class="annottext">forall a. Vendor a -&gt; IORef (Map Coupon (Weak (RemotePtr a)))
</span><a href="Foreign.RemotePtr.html#coupons"><span class="hs-identifier hs-var hs-var">coupons</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-type">Coupon</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#Weak"><span class="hs-identifier hs-type">Weak</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111951"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="counter"><span class="annot"><span class="annottext">forall a. Vendor a -&gt; IORef Integer
</span><a href="Foreign.RemotePtr.html#counter"><span class="hs-identifier hs-var hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#IORef"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">{-----------------------------------------------------------------------------
    Vendor and Coupons
------------------------------------------------------------------------------}</span><span>
</span><span id="line-107"></span><span class="annot"><span class="hs-comment">-- | Create a new 'Vendor' for trading 'Coupon's and 'RemotePtr's.</span></span><span>
</span><span id="line-108"></span><span id="local-6989586621679111956"><span class="annot"><a href="Foreign.RemotePtr.html#newVendor"><span class="hs-identifier hs-type">newVendor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111956"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-109"></span><span id="newVendor"><span class="annot"><span class="annottext">newVendor :: forall a. IO (Vendor a)
</span><a href="Foreign.RemotePtr.html#newVendor"><span class="hs-identifier hs-var hs-var">newVendor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621679112065"><span class="annot"><span class="annottext">IORef Integer
</span><a href="#local-6989586621679112065"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; IO (IORef Integer)
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-111"></span><span>    </span><span id="local-6989586621679112067"><span class="annot"><span class="annottext">IORef (HashMap Coupon (Weak (RemotePtr a)))
</span><a href="#local-6989586621679112067"><span class="hs-identifier hs-var">coupons</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashMap Coupon (Weak (RemotePtr a))
-&gt; IO (IORef (HashMap Coupon (Weak (RemotePtr a))))
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap Coupon (Weak (RemotePtr a))
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">Vendor a -&gt; IO (Vendor a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Vendor a -&gt; IO (Vendor a)) -&gt; Vendor a -&gt; IO (Vendor a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">IORef Integer
IORef (HashMap Coupon (Weak (RemotePtr a)))
coupons :: IORef (HashMap Coupon (Weak (RemotePtr a)))
counter :: IORef Integer
counter :: IORef Integer
coupons :: IORef (HashMap Coupon (Weak (RemotePtr a)))
</span><a href="Foreign.RemotePtr.html#coupons"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><span class="hs-comment">-- | Take a 'Coupon' to a 'Vendor' and maybe you'll get a 'RemotePtr' for it.</span></span><span>
</span><span id="line-115"></span><span id="local-6989586621679111964"><span class="annot"><a href="Foreign.RemotePtr.html#lookup"><span class="hs-identifier hs-type">lookup</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-type">Coupon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111964"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111964"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-116"></span><span id="lookup"><span class="annot"><span class="annottext">lookup :: forall a. Coupon -&gt; Vendor a -&gt; IO (Maybe (RemotePtr a))
</span><a href="Foreign.RemotePtr.html#lookup"><span class="hs-identifier hs-var hs-var">lookup</span></a></span></span><span> </span><span id="local-6989586621679112077"><span class="annot"><span class="annottext">Coupon
</span><a href="#local-6989586621679112077"><span class="hs-identifier hs-var">coupon</span></a></span></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span class="hs-special">{</span><span id="local-6989586621679112078"><span id="local-6989586621679112079"><span class="annot"><span class="annottext">IORef Integer
IORef (Map Coupon (Weak (RemotePtr a)))
coupons :: forall a. Vendor a -&gt; IORef (Map Coupon (Weak (RemotePtr a)))
counter :: forall a. Vendor a -&gt; IORef Integer
coupons :: IORef (Map Coupon (Weak (RemotePtr a)))
counter :: IORef Integer
</span><a href="Foreign.RemotePtr.html#coupons"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>    </span><span id="local-6989586621679112080"><span class="annot"><span class="annottext">Maybe (Weak (RemotePtr a))
</span><a href="#local-6989586621679112080"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coupon
-&gt; Map Coupon (Weak (RemotePtr a)) -&gt; Maybe (Weak (RemotePtr a))
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Coupon
</span><a href="#local-6989586621679112077"><span class="hs-identifier hs-var">coupon</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Coupon (Weak (RemotePtr a)) -&gt; Maybe (Weak (RemotePtr a)))
-&gt; IO (Map Coupon (Weak (RemotePtr a)))
-&gt; IO (Maybe (Weak (RemotePtr a)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map Coupon (Weak (RemotePtr a)))
-&gt; IO (Map Coupon (Weak (RemotePtr a)))
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map Coupon (Weak (RemotePtr a)))
</span><a href="#local-6989586621679112078"><span class="hs-identifier hs-var">coupons</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe (RemotePtr a))
-&gt; (Weak (RemotePtr a) -&gt; IO (Maybe (RemotePtr a)))
-&gt; Maybe (Weak (RemotePtr a))
-&gt; IO (Maybe (RemotePtr a))
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (RemotePtr a) -&gt; IO (Maybe (RemotePtr a))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (RemotePtr a)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Weak (RemotePtr a) -&gt; IO (Maybe (RemotePtr a))
forall v. Weak v -&gt; IO (Maybe v)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#deRefWeak"><span class="hs-identifier hs-var">deRefWeak</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Weak (RemotePtr a))
</span><a href="#local-6989586621679112080"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-comment">-- | Create a new 'Coupon'.</span><span>
</span><span id="line-121"></span><span class="hs-comment">--</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- WARNING: This coupon is only unique relative to this 'Vendor'.</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- There is no guarantee that this 'Coupon' is globally unique,</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- certainly not on a remote machine.</span><span>
</span><span id="line-125"></span><span id="local-6989586621679111976"><span class="annot"><a href="Foreign.RemotePtr.html#newCoupon"><span class="hs-identifier hs-type">newCoupon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111976"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-type">Coupon</span></a></span></span><span>
</span><span id="line-126"></span><span id="newCoupon"><span class="annot"><span class="annottext">newCoupon :: forall a. Vendor a -&gt; IO Coupon
</span><a href="Foreign.RemotePtr.html#newCoupon"><span class="hs-identifier hs-var hs-var">newCoupon</span></a></span></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span class="hs-special">{</span><span id="local-6989586621679112091"><span id="local-6989586621679112092"><span class="annot"><span class="annottext">IORef Integer
IORef (Map Coupon (Weak (RemotePtr a)))
coupons :: forall a. Vendor a -&gt; IORef (Map Coupon (Weak (RemotePtr a)))
counter :: forall a. Vendor a -&gt; IORef Integer
coupons :: IORef (Map Coupon (Weak (RemotePtr a)))
counter :: IORef Integer
</span><a href="Foreign.RemotePtr.html#coupons"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Coupon
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/text-2.0.2/src/Data.Text.Internal.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Coupon) -&gt; (Integer -&gt; String) -&gt; Integer -&gt; Coupon
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Coupon) -&gt; IO Integer -&gt; IO Coupon
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Integer -&gt; (Integer -&gt; (Integer, Integer)) -&gt; IO Integer
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Integer
</span><a href="#local-6989586621679112092"><span class="hs-identifier hs-var">counter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679112097"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679112097"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679112097"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679112097"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="annot"><span class="hs-comment">-- | Create a new 'RemotePtr' from a 'Coupon' and register it with a 'Vendor'.</span></span><span>
</span><span id="line-130"></span><span id="local-6989586621679111985"><span class="annot"><a href="Foreign.RemotePtr.html#newRemotePtr"><span class="hs-identifier hs-type">newRemotePtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-type">Coupon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679111985"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111985"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111985"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-131"></span><span id="newRemotePtr"><span class="annot"><span class="annottext">newRemotePtr :: forall a. Coupon -&gt; a -&gt; Vendor a -&gt; IO (RemotePtr a)
</span><a href="Foreign.RemotePtr.html#newRemotePtr"><span class="hs-identifier hs-var hs-var">newRemotePtr</span></a></span></span><span> </span><span id="local-6989586621679112107"><span class="annot"><span class="annottext">Coupon
</span><a href="#local-6989586621679112107"><span class="hs-identifier hs-var">coupon</span></a></span></span><span> </span><span id="local-6989586621679112108"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679112108"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Vendor"><span class="hs-identifier hs-type">Vendor</span></a></span><span class="hs-special">{</span><span id="local-6989586621679112109"><span id="local-6989586621679112110"><span class="annot"><span class="annottext">IORef Integer
IORef (Map Coupon (Weak (RemotePtr a)))
coupons :: forall a. Vendor a -&gt; IORef (Map Coupon (Weak (RemotePtr a)))
counter :: forall a. Vendor a -&gt; IORef Integer
coupons :: IORef (Map Coupon (Weak (RemotePtr a)))
counter :: IORef Integer
</span><a href="Foreign.RemotePtr.html#coupons"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621679112111"><span class="annot"><span class="annottext">IORef [SomeWeak]
</span><a href="#local-6989586621679112111"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SomeWeak] -&gt; IO (IORef [SomeWeak])
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679112114"><span class="annot"><span class="annottext">self :: a
</span><a href="#local-6989586621679112114"><span class="hs-identifier hs-var hs-var">self</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
forall a. HasCallStack =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Err.html#undefined"><span class="hs-identifier hs-var">undefined</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span id="local-6989586621679112116"><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112116"><span class="hs-identifier hs-var">ptr</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RemoteData a -&gt; IO (RemotePtr a)
forall a. a -&gt; IO (IORef a)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemoteData"><span class="hs-identifier hs-type">RemoteData</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">a
IORef [SomeWeak]
Weak (RemotePtr a)
Coupon
forall {a}. a
self :: Weak (RemotePtr a)
coupon :: Coupon
value :: a
children :: IORef [SomeWeak]
coupon :: Coupon
value :: a
children :: IORef [SomeWeak]
self :: forall {a}. a
</span><a href="Foreign.RemotePtr.html#self"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-135"></span><span>    </span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679112119"><span class="annot"><span class="annottext">finalize :: IO ()
</span><a href="#local-6989586621679112119"><span class="hs-identifier hs-var hs-var">finalize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map Coupon (Weak (RemotePtr a)))
-&gt; (Map Coupon (Weak (RemotePtr a))
    -&gt; (Map Coupon (Weak (RemotePtr a)), ()))
-&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map Coupon (Weak (RemotePtr a)))
</span><a href="#local-6989586621679112109"><span class="hs-identifier hs-var">coupons</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Coupon (Weak (RemotePtr a))
  -&gt; (Map Coupon (Weak (RemotePtr a)), ()))
 -&gt; IO ())
-&gt; (Map Coupon (Weak (RemotePtr a))
    -&gt; (Map Coupon (Weak (RemotePtr a)), ()))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679112120"><span class="annot"><span class="annottext">Map Coupon (Weak (RemotePtr a))
</span><a href="#local-6989586621679112120"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coupon
-&gt; Map Coupon (Weak (RemotePtr a))
-&gt; Map Coupon (Weak (RemotePtr a))
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.delete</span></span><span> </span><span class="annot"><span class="annottext">Coupon
</span><a href="#local-6989586621679112107"><span class="hs-identifier hs-var">coupon</span></a></span><span> </span><span class="annot"><span class="annottext">Map Coupon (Weak (RemotePtr a))
</span><a href="#local-6989586621679112120"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>    </span><span id="local-6989586621679112122"><span class="annot"><span class="annottext">Weak (RemotePtr a)
</span><a href="#local-6989586621679112122"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO () -&gt; IO (Weak (RemotePtr a))
forall a. IORef a -&gt; IO () -&gt; IO (Weak (IORef a))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.IORef.html#mkWeakIORef"><span class="hs-identifier hs-var">mkWeakIORef</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112116"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679112119"><span class="hs-identifier hs-var">finalize</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">IORef (Map Coupon (Weak (RemotePtr a)))
-&gt; (Map Coupon (Weak (RemotePtr a))
    -&gt; (Map Coupon (Weak (RemotePtr a)), ()))
-&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map Coupon (Weak (RemotePtr a)))
</span><a href="#local-6989586621679112109"><span class="hs-identifier hs-var">coupons</span></a></span><span> </span><span class="annot"><span class="annottext">((Map Coupon (Weak (RemotePtr a))
  -&gt; (Map Coupon (Weak (RemotePtr a)), ()))
 -&gt; IO ())
-&gt; (Map Coupon (Weak (RemotePtr a))
    -&gt; (Map Coupon (Weak (RemotePtr a)), ()))
-&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679112124"><span class="annot"><span class="annottext">Map Coupon (Weak (RemotePtr a))
</span><a href="#local-6989586621679112124"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Coupon
-&gt; Weak (RemotePtr a)
-&gt; Map Coupon (Weak (RemotePtr a))
-&gt; Map Coupon (Weak (RemotePtr a))
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Coupon
</span><a href="#local-6989586621679112107"><span class="hs-identifier hs-var">coupon</span></a></span><span> </span><span class="annot"><span class="annottext">Weak (RemotePtr a)
</span><a href="#local-6989586621679112122"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Map Coupon (Weak (RemotePtr a))
</span><a href="#local-6989586621679112124"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">RemotePtr a -&gt; (RemoteData a -&gt; (RemoteData a, ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112116"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">((RemoteData a -&gt; (RemoteData a, ())) -&gt; IO ())
-&gt; (RemoteData a -&gt; (RemoteData a, ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679112126"><span class="annot"><span class="annottext">RemoteData a
</span><a href="#local-6989586621679112126"><span class="hs-identifier hs-var">itemdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteData a
</span><a href="#local-6989586621679112126"><span class="hs-identifier hs-var">itemdata</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#self"><span class="hs-identifier hs-var">self</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679112122"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO (RemotePtr a)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112116"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-comment">{-----------------------------------------------------------------------------
    RemotePtr
------------------------------------------------------------------------------}</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | Access the data of the 'RemotePtr'.</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- </span><span>
</span><span id="line-147"></span><span class="hs-comment">-- While the action is being performed, it is ensured that the 'RemotePtr'</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- will not be garbage collected</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- and its 'Coupon' can be successfully redeemed at the 'Vendor'.</span><span>
</span><span id="line-150"></span><span id="local-6989586621679111996"><span id="local-6989586621679111997"><span class="annot"><a href="Foreign.RemotePtr.html#withRemotePtr"><span class="hs-identifier hs-type">withRemotePtr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111996"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-type">Coupon</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679111996"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111997"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679111997"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-151"></span><span id="withRemotePtr"><span class="annot"><span class="annottext">withRemotePtr :: forall a b. RemotePtr a -&gt; (Coupon -&gt; a -&gt; IO b) -&gt; IO b
</span><a href="Foreign.RemotePtr.html#withRemotePtr"><span class="hs-identifier hs-var hs-var">withRemotePtr</span></a></span></span><span> </span><span id="local-6989586621679112131"><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112131"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span id="local-6989586621679112132"><span class="annot"><span class="annottext">Coupon -&gt; a -&gt; IO b
</span><a href="#local-6989586621679112132"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><a href="Foreign.RemotePtr.html#RemoteData"><span class="hs-identifier hs-type">RemoteData</span></a></span><span class="hs-special">{</span><span id="local-6989586621679112133"><span id="local-6989586621679112134"><span id="local-6989586621679112135"><span id="local-6989586621679112136"><span class="annot"><span class="annottext">a
IORef [SomeWeak]
Weak (RemotePtr a)
Coupon
self :: forall a. RemoteData a -&gt; Weak (RemotePtr a)
coupon :: forall a. RemoteData a -&gt; Coupon
value :: forall a. RemoteData a -&gt; a
children :: forall a. RemoteData a -&gt; IORef [SomeWeak]
self :: Weak (RemotePtr a)
coupon :: Coupon
value :: a
children :: IORef [SomeWeak]
</span><a href="Foreign.RemotePtr.html#self"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO (RemoteData a)
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112131"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-153"></span><span>        </span><span id="local-6989586621679112137"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679112137"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Coupon -&gt; a -&gt; IO b
</span><a href="#local-6989586621679112132"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Coupon
</span><a href="#local-6989586621679112134"><span class="hs-identifier hs-var">coupon</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679112135"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO ()
forall {a}. IORef a -&gt; IO ()
</span><a href="#local-6989586621679112138"><span class="hs-identifier hs-var">touch</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112131"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><span class="annottext">b -&gt; IO b
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679112137"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- make sure that the pointer is alive at this point in the code</span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621679112138"><span class="annot"><span class="annottext">touch :: IORef a -&gt; IO ()
</span><a href="#local-6989586621679112138"><span class="hs-identifier hs-var hs-var">touch</span></a></span></span><span> </span><span id="local-6989586621679112140"><span class="annot"><span class="annottext">IORef a
</span><a href="#local-6989586621679112140"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO ()) -&gt; IO a -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IORef a -&gt; IO a
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef a
</span><a href="#local-6989586621679112140"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="hs-comment">-- | Unprotected access the 'Coupon' of a 'RemotePtr'.</span><span>
</span><span id="line-161"></span><span class="hs-comment">--</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- Note: There is no guarantee that the 'RemotePtr' is alive</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- after this operation and that the 'Coupon' can be redeemed at a 'Vendor'.</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- Most of the time, you should use 'withRemotePtr' instead.</span><span>
</span><span id="line-165"></span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- Note: In particular, if you use this with @unsafePerformIO@,</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- the risk is high that you only refer to the 'RemotePtr' argument via</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- the result just obtained, and the pointer will be garbage collected.</span><span>
</span><span id="line-169"></span><span id="local-6989586621679112003"><span class="annot"><a href="Foreign.RemotePtr.html#unprotectedGetCoupon"><span class="hs-identifier hs-type">unprotectedGetCoupon</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112003"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#Coupon"><span class="hs-identifier hs-type">Coupon</span></a></span></span><span>
</span><span id="line-170"></span><span id="unprotectedGetCoupon"><span class="annot"><span class="annottext">unprotectedGetCoupon :: forall a. RemotePtr a -&gt; IO Coupon
</span><a href="Foreign.RemotePtr.html#unprotectedGetCoupon"><span class="hs-identifier hs-var hs-var">unprotectedGetCoupon</span></a></span></span><span> </span><span id="local-6989586621679112143"><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112143"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RemoteData a -&gt; Coupon
forall a. RemoteData a -&gt; Coupon
</span><a href="Foreign.RemotePtr.html#coupon"><span class="hs-identifier hs-var">coupon</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteData a -&gt; Coupon) -&gt; IO (RemoteData a) -&gt; IO Coupon
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO (RemoteData a)
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112143"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">-- | Add a finalizer that is run when the 'RemotePtr' is garbage collected.</span><span>
</span><span id="line-174"></span><span class="hs-comment">--</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- The associated coupon cannot be redeemed anymore while the finalizer runs.</span><span>
</span><span id="line-176"></span><span id="local-6989586621679112005"><span class="annot"><a href="Foreign.RemotePtr.html#addFinalizer"><span class="hs-identifier hs-type">addFinalizer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112005"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-177"></span><span id="addFinalizer"><span class="annot"><span class="annottext">addFinalizer :: forall a. RemotePtr a -&gt; IO () -&gt; IO ()
</span><a href="Foreign.RemotePtr.html#addFinalizer"><span class="hs-identifier hs-var hs-var">addFinalizer</span></a></span></span><span> </span><span id="local-6989586621679112145"><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112145"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Weak (RemotePtr a)) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Weak (RemotePtr a)) -&gt; IO ())
-&gt; (IO () -&gt; IO (Weak (RemotePtr a))) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO () -&gt; IO (Weak (RemotePtr a))
forall a. IORef a -&gt; IO () -&gt; IO (Weak (IORef a))
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.IORef.html#mkWeakIORef"><span class="hs-identifier hs-var">mkWeakIORef</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112145"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-178"></span><span class="annot"><span class="hs-comment">-- | FIXME: Is this finalizer really run when 'destroy' is called?</span></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-comment">-- | Destroy a 'RemotePtr' and run all finalizers for it.</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- 'Coupon's for this pointer can no longer be redeemed.</span><span>
</span><span id="line-182"></span><span id="local-6989586621679112007"><span class="annot"><a href="Foreign.RemotePtr.html#destroy"><span class="hs-identifier hs-type">destroy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112007"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-183"></span><span id="destroy"><span class="annot"><span class="annottext">destroy :: forall a. RemotePtr a -&gt; IO ()
</span><a href="Foreign.RemotePtr.html#destroy"><span class="hs-identifier hs-var hs-var">destroy</span></a></span></span><span> </span><span id="local-6989586621679112148"><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112148"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Weak (RemotePtr a) -&gt; IO ()
forall v. Weak v -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#finalize"><span class="hs-identifier hs-var">finalize</span></a></span><span> </span><span class="annot"><span class="annottext">(Weak (RemotePtr a) -&gt; IO ()) -&gt; IO (Weak (RemotePtr a)) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteData a -&gt; Weak (RemotePtr a)
forall a. RemoteData a -&gt; Weak (RemotePtr a)
</span><a href="Foreign.RemotePtr.html#self"><span class="hs-identifier hs-var">self</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteData a -&gt; Weak (RemotePtr a))
-&gt; IO (RemoteData a) -&gt; IO (Weak (RemotePtr a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO (RemoteData a)
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112148"><span class="hs-identifier hs-var">ptr</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | When dealing with several foreign objects,</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- it is useful to model dependencies between them.</span><span>
</span><span id="line-188"></span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- After this operation, the second 'RemotePtr' will be reachable</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- whenever the first one is reachable.</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- For instance, you should call this function when the second foreign object</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- is actually a subobject of the first one.</span><span>
</span><span id="line-193"></span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- Note: It is possible to model dependencies in the @parent@ data,</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- but the 'addReachable' method is preferrable,</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- as it allows all child object to be garbage collected at once.</span><span>
</span><span id="line-197"></span><span id="local-6989586621679112013"><span id="local-6989586621679112014"><span class="annot"><a href="Foreign.RemotePtr.html#addReachable"><span class="hs-identifier hs-type">addReachable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112013"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112014"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-198"></span><span id="addReachable"><span class="annot"><span class="annottext">addReachable :: forall a b. RemotePtr a -&gt; RemotePtr b -&gt; IO ()
</span><a href="Foreign.RemotePtr.html#addReachable"><span class="hs-identifier hs-var hs-var">addReachable</span></a></span></span><span> </span><span id="local-6989586621679112155"><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112155"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span id="local-6989586621679112156"><span class="annot"><span class="annottext">RemotePtr b
</span><a href="#local-6989586621679112156"><span class="hs-identifier hs-var">child</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621679112157"><span class="annot"><span class="annottext">Weak (RemotePtr b)
</span><a href="#local-6989586621679112157"><span class="hs-identifier hs-var">w</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; RemotePtr b -&gt; IO () -&gt; IO (Weak (RemotePtr b))
forall a value. IORef a -&gt; value -&gt; IO () -&gt; IO (Weak value)
</span><a href="Foreign.RemotePtr.html#mkWeakIORefValue"><span class="hs-identifier hs-var">mkWeakIORefValue</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112155"><span class="hs-identifier hs-var">parent</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr b
</span><a href="#local-6989586621679112156"><span class="hs-identifier hs-var">child</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Weak (RemotePtr b)))
-&gt; IO () -&gt; IO (Weak (RemotePtr b))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621679112158"><span class="annot"><span class="annottext">IORef [SomeWeak]
</span><a href="#local-6989586621679112158"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RemoteData a -&gt; IORef [SomeWeak]
forall a. RemoteData a -&gt; IORef [SomeWeak]
</span><a href="Foreign.RemotePtr.html#children"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteData a -&gt; IORef [SomeWeak])
-&gt; IO (RemoteData a) -&gt; IO (IORef [SomeWeak])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO (RemoteData a)
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112155"><span class="hs-identifier hs-var">parent</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><span class="annottext">IORef [SomeWeak] -&gt; ([SomeWeak] -&gt; ([SomeWeak], ())) -&gt; IO ()
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef [SomeWeak]
</span><a href="#local-6989586621679112158"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">(([SomeWeak] -&gt; ([SomeWeak], ())) -&gt; IO ())
-&gt; ([SomeWeak] -&gt; ([SomeWeak], ())) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679112159"><span class="annot"><span class="annottext">[SomeWeak]
</span><a href="#local-6989586621679112159"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Weak (RemotePtr b) -&gt; SomeWeak
forall a. Weak a -&gt; SomeWeak
</span><a href="Foreign.RemotePtr.html#SomeWeak"><span class="hs-identifier hs-var">SomeWeak</span></a></span><span> </span><span class="annot"><span class="annottext">Weak (RemotePtr b)
</span><a href="#local-6989586621679112157"><span class="hs-identifier hs-var">w</span></a></span><span class="annot"><span class="annottext">SomeWeak -&gt; [SomeWeak] -&gt; [SomeWeak]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span class="annot"><span class="annottext">[SomeWeak]
</span><a href="#local-6989586621679112159"><span class="hs-identifier hs-var">ws</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- | Clear all dependencies.</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- </span><span>
</span><span id="line-205"></span><span class="hs-comment">-- Reachability of this 'RemotePtr' no longer implies reachability</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- of other items, as formerly implied by calls to 'addReachable'.</span><span>
</span><span id="line-207"></span><span id="local-6989586621679112160"><span class="annot"><a href="Foreign.RemotePtr.html#clearReachable"><span class="hs-identifier hs-type">clearReachable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679112160"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-208"></span><span id="clearReachable"><span class="annot"><span class="annottext">clearReachable :: forall a. RemotePtr a -&gt; IO ()
</span><a href="Foreign.RemotePtr.html#clearReachable"><span class="hs-identifier hs-var hs-var">clearReachable</span></a></span></span><span> </span><span id="local-6989586621679112167"><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112167"><span class="hs-identifier hs-var">parent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621679112168"><span class="annot"><span class="annottext">IORef [SomeWeak]
</span><a href="#local-6989586621679112168"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RemoteData a -&gt; IORef [SomeWeak]
forall a. RemoteData a -&gt; IORef [SomeWeak]
</span><a href="Foreign.RemotePtr.html#children"><span class="hs-identifier hs-var">children</span></a></span><span> </span><span class="annot"><span class="annottext">(RemoteData a -&gt; IORef [SomeWeak])
-&gt; IO (RemoteData a) -&gt; IO (IORef [SomeWeak])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a -&gt; IO (RemoteData a)
forall a. IORef a -&gt; IO a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr a
</span><a href="#local-6989586621679112167"><span class="hs-identifier hs-var">parent</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679112169"><span class="annot"><span class="annottext">[SomeWeak]
</span><a href="#local-6989586621679112169"><span class="hs-identifier hs-var">xs</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef [SomeWeak]
-&gt; ([SomeWeak] -&gt; ([SomeWeak], [SomeWeak])) -&gt; IO [SomeWeak]
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IORef.html#atomicModifyIORef%27"><span class="hs-identifier hs-var">atomicModifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef [SomeWeak]
</span><a href="#local-6989586621679112168"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">(([SomeWeak] -&gt; ([SomeWeak], [SomeWeak])) -&gt; IO [SomeWeak])
-&gt; ([SomeWeak] -&gt; ([SomeWeak], [SomeWeak])) -&gt; IO [SomeWeak]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679112170"><span class="annot"><span class="annottext">[SomeWeak]
</span><a href="#local-6989586621679112170"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SomeWeak]
</span><a href="#local-6989586621679112170"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="annottext">[IO ()] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#sequence_"><span class="hs-identifier hs-var">sequence_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Weak a -&gt; IO ()
forall v. Weak v -&gt; IO ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Weak.html#finalize"><span class="hs-identifier hs-var">finalize</span></a></span><span> </span><span class="annot"><span class="annottext">Weak a
</span><a href="#local-6989586621679112172"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Foreign.RemotePtr.html#SomeWeak"><span class="hs-identifier hs-type">SomeWeak</span></a></span><span> </span><span id="local-6989586621679112172"><span class="annot"><span class="annottext">Weak a
</span><a href="#local-6989586621679112172"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SomeWeak]
</span><a href="#local-6989586621679112169"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-212"></span></pre></body></html>
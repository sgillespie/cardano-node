<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns     #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns   #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards  #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies     #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators    #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.BlockFetch.State</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterations"><span class="hs-identifier">fetchLogicIterations</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier">FetchDecisionPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier">FetchTriggerVariables</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier">FetchNonTriggerVariables</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier">FetchDecision</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier">FetchDecline</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">FetchMode</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TraceLabelPeer</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier">TraceFetchClientState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html"><span class="hs-identifier">Data.Functor.Contravariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.html"><span class="hs-identifier">Data.Map.Strict</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Void.html"><span class="hs-identifier">Data.Void</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime.SI</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer.SI</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AnchoredFragment</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ClientState</span></a></span><span>
</span><span id="line-38"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientStateVars"><span class="hs-identifier">FetchClientStateVars</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier">FetchRequest</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier">PeerFetchInFlight</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier">PeerFetchStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier">TraceFetchClientState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TraceLabelPeer</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#addNewFetchRequest"><span class="hs-identifier">addNewFetchRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#readFetchClientState"><span class="hs-identifier">readFetchClientState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.Decision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier">FetchDecision</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier">FetchDecisionPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier">FetchDecline</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>                     </span><span class="annot"><span class="hs-identifier">FetchMode</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier">PeerInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchDecisions"><span class="hs-identifier">fetchDecisions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.DeltaQ</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier">PeerGSV</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span id="local-6989586621679211214"><span id="local-6989586621679211216"><span id="local-6989586621679211218"><span id="local-6989586621679211221"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterations"><span class="hs-identifier hs-type">fetchLogicIterations</span></a></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211214"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-50"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211216"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-51"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211214"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211216"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-52"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadDelay</span></span><span> </span><span class="annot"><a href="#local-6989586621679211218"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-53"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211218"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-54"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211221"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-55"></span><span>     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679211221"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-56"></span><span>     </span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211221"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679211214"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211221"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier hs-type">TraceFetchClientState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211214"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211214"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211221"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211214"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211218"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211221"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211214"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211216"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211218"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679211218"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span></span></span></span></span><span>
</span><span id="line-63"></span><span id="fetchLogicIterations"><span class="annot"><span class="annottext">fetchLogicIterations :: forall header block (m :: * -&gt; *) peer.
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block, MonadDelay m, MonadSTM m,
 Ord peer, Hashable peer) =&gt;
Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; m Void
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterations"><span class="hs-identifier hs-var hs-var">fetchLogicIterations</span></a></span></span><span> </span><span id="local-6989586621679211522"><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
</span><a href="#local-6989586621679211522"><span class="hs-identifier hs-var">decisionTracer</span></a></span></span><span> </span><span id="local-6989586621679211523"><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679211523"><span class="hs-identifier hs-var">clientStateTracer</span></a></span></span><span>
</span><span id="line-64"></span><span>                     </span><span id="local-6989586621679211524"><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211524"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span></span><span>
</span><span id="line-65"></span><span>                     </span><span id="local-6989586621679211525"><span class="annot"><span class="annottext">FetchTriggerVariables peer header m
</span><a href="#local-6989586621679211525"><span class="hs-identifier hs-var">fetchTriggerVariables</span></a></span></span><span>
</span><span id="line-66"></span><span>                     </span><span id="local-6989586621679211526"><span class="annot"><span class="annottext">FetchNonTriggerVariables peer header block m
</span><a href="#local-6989586621679211526"><span class="hs-identifier hs-var">fetchNonTriggerVariables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
-&gt; (FetchStateFingerprint peer header block
    -&gt; m (FetchStateFingerprint peer header block))
-&gt; m Void
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; (a -&gt; m a) -&gt; m Void
</span><a href="Ouroboros.Network.BlockFetch.State.html#iterateForever"><span class="hs-identifier hs-var">iterateForever</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
forall peer header block. FetchStateFingerprint peer header block
</span><a href="Ouroboros.Network.BlockFetch.State.html#initialFetchStateFingerprint"><span class="hs-identifier hs-var">initialFetchStateFingerprint</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchStateFingerprint peer header block
  -&gt; m (FetchStateFingerprint peer header block))
 -&gt; m Void)
-&gt; (FetchStateFingerprint peer header block
    -&gt; m (FetchStateFingerprint peer header block))
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679211529"><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211529"><span class="hs-identifier hs-var">stateFingerprint</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span>      </span><span class="hs-comment">-- Run a single iteration of the fetch logic:</span><span>
</span><span id="line-71"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-72"></span><span>      </span><span class="hs-comment">-- + wait for the state to change and make decisions for the new state</span><span>
</span><span id="line-73"></span><span>      </span><span class="hs-comment">-- + act on those decisions</span><span>
</span><span id="line-74"></span><span>      </span><span id="local-6989586621679211530"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679211530"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><span class="hs-identifier hs-var">getMonotonicTime</span></span><span>
</span><span id="line-75"></span><span>      </span><span id="local-6989586621679211532"><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211532"><span class="hs-identifier hs-var">stateFingerprint'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; FetchStateFingerprint peer header block
-&gt; m (FetchStateFingerprint peer header block)
forall peer (m :: * -&gt; *) header block.
(Hashable peer, MonadSTM m, Ord peer, HasHeader header,
 HasHeader block, HeaderHash header ~ HeaderHash block) =&gt;
Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; FetchStateFingerprint peer header block
-&gt; m (FetchStateFingerprint peer header block)
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIteration"><span class="hs-identifier hs-var">fetchLogicIteration</span></a></span><span>
</span><span id="line-76"></span><span>        </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
</span><a href="#local-6989586621679211522"><span class="hs-identifier hs-var">decisionTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679211523"><span class="hs-identifier hs-var">clientStateTracer</span></a></span><span>
</span><span id="line-77"></span><span>        </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211524"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-78"></span><span>        </span><span class="annot"><span class="annottext">FetchTriggerVariables peer header m
</span><a href="#local-6989586621679211525"><span class="hs-identifier hs-var">fetchTriggerVariables</span></a></span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><span class="annottext">FetchNonTriggerVariables peer header block m
</span><a href="#local-6989586621679211526"><span class="hs-identifier hs-var">fetchNonTriggerVariables</span></a></span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211529"><span class="hs-identifier hs-var">stateFingerprint</span></a></span><span>
</span><span id="line-81"></span><span>      </span><span id="local-6989586621679211534"><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679211534"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Time
forall (m :: * -&gt; *). MonadMonotonicTime m =&gt; m Time
</span><span class="hs-identifier hs-var">getMonotonicTime</span></span><span>
</span><span id="line-82"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679211535"><span class="annot"><span class="annottext">delta :: DiffTime
</span><a href="#local-6989586621679211535"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Time -&gt; Time -&gt; DiffTime
</span><span class="hs-identifier hs-var">diffTime</span></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679211534"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Time
</span><a href="#local-6989586621679211530"><span class="hs-identifier hs-var">start</span></a></span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-comment">-- Limit decision is made once every decisionLoopInterval.</span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="annottext">DiffTime -&gt; m ()
forall (m :: * -&gt; *). MonadDelay m =&gt; DiffTime -&gt; m ()
</span><span class="hs-identifier hs-var">threadDelay</span></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; m ()) -&gt; DiffTime -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecisionPolicy header -&gt; DiffTime
forall header. FetchDecisionPolicy header -&gt; DiffTime
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#decisionLoopInterval"><span class="hs-identifier hs-var">decisionLoopInterval</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211524"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime -&gt; DiffTime
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679211535"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-85"></span><span>      </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
-&gt; m (FetchStateFingerprint peer header block)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211532"><span class="hs-identifier hs-var">stateFingerprint'</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span id="local-6989586621679211243"><span id="local-6989586621679211244"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#iterateForever"><span class="hs-identifier hs-type">iterateForever</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Monad"><span class="hs-identifier hs-type">Monad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679211244"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679211244"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679211243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211244"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679211243"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span></span></span><span>
</span><span id="line-89"></span><span id="iterateForever"><span class="annot"><span class="annottext">iterateForever :: forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; (a -&gt; m a) -&gt; m Void
</span><a href="Ouroboros.Network.BlockFetch.State.html#iterateForever"><span class="hs-identifier hs-var hs-var">iterateForever</span></a></span></span><span> </span><span id="local-6989586621679211541"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211541"><span class="hs-identifier hs-var">x0</span></a></span></span><span> </span><span id="local-6989586621679211542"><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621679211542"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m Void
</span><a href="#local-6989586621679211543"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211541"><span class="hs-identifier hs-var">x0</span></a></span><span> </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679211543"><span class="annot"><span class="annottext">go :: a -&gt; m Void
</span><a href="#local-6989586621679211543"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679211544"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211544"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
</span><a href="#local-6989586621679211542"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211544"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; (a -&gt; m Void) -&gt; m Void
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m Void
</span><a href="#local-6989586621679211543"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-comment">-- | A single iteration of the fetch logic.</span><span>
</span><span id="line-93"></span><span class="hs-comment">--</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- This involves:</span><span>
</span><span id="line-95"></span><span class="hs-comment">--</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- * waiting for the state that the fetch decisions depend upon to change;</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- * taking a snapshot of the state;</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- * deciding for each peer if we will initiate a new fetch request</span><span>
</span><span id="line-99"></span><span class="hs-comment">--</span><span>
</span><span id="line-100"></span><span id="local-6989586621679211253"><span id="local-6989586621679211254"><span id="local-6989586621679211255"><span id="local-6989586621679211256"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIteration"><span class="hs-identifier hs-type">fetchLogicIteration</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211254"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211256"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211256"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211254"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211254"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier hs-type">TraceFetchClientState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211254"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211256"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211254"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211256"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679211254"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211253"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211255"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211256"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-111"></span><span id="fetchLogicIteration"><span class="annot"><span class="annottext">fetchLogicIteration :: forall peer (m :: * -&gt; *) header block.
(Hashable peer, MonadSTM m, Ord peer, HasHeader header,
 HasHeader block, HeaderHash header ~ HeaderHash block) =&gt;
Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; FetchStateFingerprint peer header block
-&gt; m (FetchStateFingerprint peer header block)
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIteration"><span class="hs-identifier hs-var hs-var">fetchLogicIteration</span></a></span></span><span> </span><span id="local-6989586621679211587"><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
</span><a href="#local-6989586621679211587"><span class="hs-identifier hs-var">decisionTracer</span></a></span></span><span> </span><span id="local-6989586621679211588"><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679211588"><span class="hs-identifier hs-var">clientStateTracer</span></a></span></span><span>
</span><span id="line-112"></span><span>                    </span><span id="local-6989586621679211589"><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211589"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span></span><span>
</span><span id="line-113"></span><span>                    </span><span id="local-6989586621679211590"><span class="annot"><span class="annottext">FetchTriggerVariables peer header m
</span><a href="#local-6989586621679211590"><span class="hs-identifier hs-var">fetchTriggerVariables</span></a></span></span><span>
</span><span id="line-114"></span><span>                    </span><span id="local-6989586621679211591"><span class="annot"><span class="annottext">FetchNonTriggerVariables peer header block m
</span><a href="#local-6989586621679211591"><span class="hs-identifier hs-var">fetchNonTriggerVariables</span></a></span></span><span>
</span><span id="line-115"></span><span>                    </span><span id="local-6989586621679211592"><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211592"><span class="hs-identifier hs-var">stateFingerprint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-comment">-- Gather a snapshot of all the state we need.</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679211593"><span class="annot"><span class="annottext">FetchStateSnapshot peer header block m
</span><a href="#local-6989586621679211593"><span class="hs-identifier hs-var">stateSnapshot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211594"><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211594"><span class="hs-identifier hs-var">stateFingerprint'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="annottext">STM
  m
  (FetchStateSnapshot peer header block m,
   FetchStateFingerprint peer header block)
-&gt; m (FetchStateSnapshot peer header block m,
      FetchStateFingerprint peer header block)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM
   m
   (FetchStateSnapshot peer header block m,
    FetchStateFingerprint peer header block)
 -&gt; m (FetchStateSnapshot peer header block m,
       FetchStateFingerprint peer header block))
-&gt; STM
     m
     (FetchStateSnapshot peer header block m,
      FetchStateFingerprint peer header block)
-&gt; m (FetchStateSnapshot peer header block m,
      FetchStateFingerprint peer header block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span class="annot"><span class="annottext">FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; FetchStateFingerprint peer header block
-&gt; STM
     m
     (FetchStateSnapshot peer header block m,
      FetchStateFingerprint peer header block)
forall (m :: * -&gt; *) peer header block.
(MonadSTM m, Eq peer, HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block) =&gt;
FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; FetchStateFingerprint peer header block
-&gt; STM
     m
     (FetchStateSnapshot peer header block m,
      FetchStateFingerprint peer header block)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateVariables"><span class="hs-identifier hs-var">readStateVariables</span></a></span><span>
</span><span id="line-121"></span><span>          </span><span class="annot"><span class="annottext">FetchTriggerVariables peer header m
</span><a href="#local-6989586621679211590"><span class="hs-identifier hs-var">fetchTriggerVariables</span></a></span><span>
</span><span id="line-122"></span><span>          </span><span class="annot"><span class="annottext">FetchNonTriggerVariables peer header block m
</span><a href="#local-6989586621679211591"><span class="hs-identifier hs-var">fetchNonTriggerVariables</span></a></span><span>
</span><span id="line-123"></span><span>          </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211592"><span class="hs-identifier hs-var">stateFingerprint</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">-- TODO: allow for boring PeerFetchStatusBusy transitions where we go round</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-comment">-- again rather than re-evaluating everything.</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211594"><span class="hs-identifier hs-var">stateFingerprint'</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211592"><span class="hs-identifier hs-var">stateFingerprint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">-- TODO: log the difference in the fingerprint that caused us to wake up</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- Make all the fetch decisions</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679211598"><span class="annot"><span class="annottext">decisions :: [(FetchDecision (FetchRequest header),
  PeerInfo header peer (FetchClientStateVars m header, peer))]
</span><a href="#local-6989586621679211598"><span class="hs-identifier hs-var hs-var">decisions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
-&gt; FetchStateSnapshot peer header block m
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall header block peer (m :: * -&gt; *).
(HasHeader header, HeaderHash header ~ HeaderHash block, Ord peer,
 Hashable peer) =&gt;
FetchDecisionPolicy header
-&gt; FetchStateSnapshot peer header block m
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchDecisionsForStateSnapshot"><span class="hs-identifier hs-var">fetchDecisionsForStateSnapshot</span></a></span><span>
</span><span id="line-133"></span><span>                      </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211589"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-134"></span><span>                      </span><span class="annot"><span class="annottext">FetchStateSnapshot peer header block m
</span><a href="#local-6989586621679211593"><span class="hs-identifier hs-var">stateSnapshot</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-comment">-- If we want to trace timings, we can do it here after forcing:</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">-- _ &lt;- evaluate (force decisions)</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- Trace the batch of fetch decisions</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; [TraceLabelPeer peer (FetchDecision [Point header])] -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
</span><a href="#local-6989586621679211587"><span class="hs-identifier hs-var">decisionTracer</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">peer
-&gt; FetchDecision [Point header]
-&gt; TraceLabelPeer peer (FetchDecision [Point header])
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211601"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FetchRequest header -&gt; [Point header])
-&gt; FetchDecision (FetchRequest header)
-&gt; FetchDecision [Point header]
forall a b.
(a -&gt; b) -&gt; Either FetchDecline a -&gt; Either FetchDecline b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">FetchRequest header -&gt; [Point header]
forall hdr. HasHeader hdr =&gt; FetchRequest hdr -&gt; [Point hdr]
</span><a href="#local-6989586621679211602"><span class="hs-identifier hs-var">fetchRequestPoints</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecision (FetchRequest header)
</span><a href="#local-6989586621679211603"><span class="hs-identifier hs-var">decision</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679211603"><span class="annot"><span class="annottext">FetchDecision (FetchRequest header)
</span><a href="#local-6989586621679211603"><span class="hs-identifier hs-var">decision</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerGSV
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211601"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211601"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(FetchClientStateVars m header, peer)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision (FetchRequest header),
  PeerInfo header peer (FetchClientStateVars m header, peer))]
</span><a href="#local-6989586621679211598"><span class="hs-identifier hs-var">decisions</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- Tell the fetch clients to act on our decisions</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621679211604"><span class="annot"><span class="annottext">[(peer, PeerFetchStatus header)]
</span><a href="#local-6989586621679211604"><span class="hs-identifier hs-var">statusUpdates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; [(FetchDecision (FetchRequest header), PeerGSV,
     FetchClientStateVars m header, peer)]
-&gt; m [(peer, PeerFetchStatus header)]
forall (m :: * -&gt; *) header peer.
(MonadSTM m, HasHeader header) =&gt;
Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; [(FetchDecision (FetchRequest header), PeerGSV,
     FetchClientStateVars m header, peer)]
-&gt; m [(peer, PeerFetchStatus header)]
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterationAct"><span class="hs-identifier hs-var">fetchLogicIterationAct</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679211588"><span class="hs-identifier hs-var">clientStateTracer</span></a></span><span>
</span><span id="line-146"></span><span>                                            </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211589"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-147"></span><span>                                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((FetchDecision (FetchRequest header),
  PeerInfo header peer (FetchClientStateVars m header, peer))
 -&gt; (FetchDecision (FetchRequest header), PeerGSV,
     FetchClientStateVars m header, peer))
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
-&gt; [(FetchDecision (FetchRequest header), PeerGSV,
     FetchClientStateVars m header, peer)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecision (FetchRequest header),
 PeerInfo header peer (FetchClientStateVars m header, peer))
-&gt; (FetchDecision (FetchRequest header), PeerGSV,
    FetchClientStateVars m header, peer)
forall {a} {a} {b} {b} {d} {c} {d}.
(a, (a, b, b, d, (c, d))) -&gt; (a, b, c, d)
</span><a href="#local-6989586621679211606"><span class="hs-identifier hs-var">swizzleReqVar</span></a></span><span> </span><span class="annot"><span class="annottext">[(FetchDecision (FetchRequest header),
  PeerInfo header peer (FetchClientStateVars m header, peer))]
</span><a href="#local-6989586621679211598"><span class="hs-identifier hs-var">decisions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679211607"><span class="annot"><span class="annottext">stateFingerprint'' :: FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211607"><span class="hs-identifier hs-var hs-var">stateFingerprint''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-149"></span><span>          </span><span class="annot"><span class="annottext">[(peer, PeerFetchStatus header)]
-&gt; FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block
forall peer header block.
Ord peer =&gt;
[(peer, PeerFetchStatus header)]
-&gt; FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block
</span><a href="Ouroboros.Network.BlockFetch.State.html#updateFetchStateFingerprintPeerStatus"><span class="hs-identifier hs-var">updateFetchStateFingerprintPeerStatus</span></a></span><span> </span><span class="annot"><span class="annottext">[(peer, PeerFetchStatus header)]
</span><a href="#local-6989586621679211604"><span class="hs-identifier hs-var">statusUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211594"><span class="hs-identifier hs-var">stateFingerprint'</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
-&gt; m (FetchStateFingerprint peer header block)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211607"><span class="hs-identifier hs-var">stateFingerprint''</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-153"></span><span>    </span><span id="local-6989586621679211606"><span class="annot"><span class="annottext">swizzleReqVar :: (a, (a, b, b, d, (c, d))) -&gt; (a, b, c, d)
</span><a href="#local-6989586621679211606"><span class="hs-identifier hs-var hs-var">swizzleReqVar</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679211609"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211609"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679211610"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679211610"><span class="hs-identifier hs-var">g</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="hs-special">(</span><span id="local-6989586621679211611"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679211611"><span class="hs-identifier hs-var">rq</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679211612"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621679211612"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211609"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679211610"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679211611"><span class="hs-identifier hs-var">rq</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621679211612"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>    </span><span id="local-6989586621679211301"><span class="annot"><a href="#local-6989586621679211602"><span class="hs-identifier hs-type">fetchRequestPoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211301"><span class="hs-identifier hs-type">hdr</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211301"><span class="hs-identifier hs-type">hdr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679211301"><span class="hs-identifier hs-type">hdr</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-156"></span><span>    </span><span id="local-6989586621679211602"><span class="annot"><span class="annottext">fetchRequestPoints :: forall hdr. HasHeader hdr =&gt; FetchRequest hdr -&gt; [Point hdr]
</span><a href="#local-6989586621679211602"><span class="hs-identifier hs-var hs-var">fetchRequestPoints</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span id="local-6989586621679211616"><span class="annot"><span class="annottext">[AnchoredFragment hdr]
</span><a href="#local-6989586621679211616"><span class="hs-identifier hs-var">headerss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-157"></span><span>      </span><span class="hs-comment">-- Flatten multiple fragments and trace points, not full headers</span><span>
</span><span id="line-158"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">hdr -&gt; Point hdr
forall block. HasHeader block =&gt; block -&gt; Point block
</span><span class="hs-identifier hs-var">blockPoint</span></span><span> </span><span class="annot"><span class="annottext">hdr
</span><a href="#local-6989586621679211618"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679211619"><span class="annot"><span class="annottext">AnchoredFragment hdr
</span><a href="#local-6989586621679211619"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment hdr]
</span><a href="#local-6989586621679211616"><span class="hs-identifier hs-var">headerss</span></a></span><span>
</span><span id="line-160"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211618"><span class="annot"><span class="annottext">hdr
</span><a href="#local-6989586621679211618"><span class="hs-identifier hs-var">header</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment hdr -&gt; [hdr]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AF.toOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment hdr
</span><a href="#local-6989586621679211619"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | Do a bit of rearranging of data before calling 'fetchDecisions' to do the</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- real work.</span><span>
</span><span id="line-164"></span><span class="hs-comment">--</span><span>
</span><span id="line-165"></span><span id="local-6989586621679211290"><span id="local-6989586621679211291"><span id="local-6989586621679211292"><span id="local-6989586621679211293"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#fetchDecisionsForStateSnapshot"><span class="hs-identifier hs-type">fetchDecisionsForStateSnapshot</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211290"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211290"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211291"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-168"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211292"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-169"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679211292"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211290"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateSnapshot"><span class="hs-identifier hs-type">FetchStateSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211292"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211290"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211291"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211293"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211290"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier hs-type">PeerInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211290"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211292"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientStateVars"><span class="hs-identifier hs-type">FetchClientStateVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211293"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211290"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679211292"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span id="fetchDecisionsForStateSnapshot"><span class="annot"><span class="annottext">fetchDecisionsForStateSnapshot :: forall header block peer (m :: * -&gt; *).
(HasHeader header, HeaderHash header ~ HeaderHash block, Ord peer,
 Hashable peer) =&gt;
FetchDecisionPolicy header
-&gt; FetchStateSnapshot peer header block m
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchDecisionsForStateSnapshot"><span class="hs-identifier hs-var hs-var">fetchDecisionsForStateSnapshot</span></a></span></span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621679211639"><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211639"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span></span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateSnapshot"><span class="hs-identifier hs-type">FetchStateSnapshot</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-179"></span><span>      </span><span id="local-6989586621679211641"><span class="annot"><span class="annottext">AnchoredFragment header
fetchStateCurrentChain :: AnchoredFragment header
fetchStateCurrentChain :: forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; AnchoredFragment header
</span><a href="#local-6989586621679211641"><span class="hs-identifier hs-var hs-var">fetchStateCurrentChain</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-180"></span><span>      </span><span id="local-6989586621679211643"><span class="annot"><span class="annottext">Map peer (AnchoredFragment header)
fetchStatePeerChains :: Map peer (AnchoredFragment header)
fetchStatePeerChains :: forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m
-&gt; Map peer (AnchoredFragment header)
</span><a href="#local-6989586621679211643"><span class="hs-identifier hs-var hs-var">fetchStatePeerChains</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-181"></span><span>      </span><span id="local-6989586621679211645"><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
fetchStatePeerStates :: Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
fetchStatePeerStates :: forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m
-&gt; Map
     peer
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)
</span><a href="#local-6989586621679211645"><span class="hs-identifier hs-var hs-var">fetchStatePeerStates</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-182"></span><span>      </span><span id="local-6989586621679211647"><span class="annot"><span class="annottext">Map peer PeerGSV
fetchStatePeerGSVs :: Map peer PeerGSV
fetchStatePeerGSVs :: forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; Map peer PeerGSV
</span><a href="#local-6989586621679211647"><span class="hs-identifier hs-var hs-var">fetchStatePeerGSVs</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-183"></span><span>      </span><span id="local-6989586621679211649"><span class="annot"><span class="annottext">Point block -&gt; Bool
fetchStateFetchedBlocks :: Point block -&gt; Bool
fetchStateFetchedBlocks :: forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; Point block -&gt; Bool
</span><a href="#local-6989586621679211649"><span class="hs-identifier hs-var hs-var">fetchStateFetchedBlocks</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-184"></span><span>      </span><span id="local-6989586621679211651"><span class="annot"><span class="annottext">MaxSlotNo
fetchStateFetchedMaxSlotNo :: MaxSlotNo
fetchStateFetchedMaxSlotNo :: forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; MaxSlotNo
</span><a href="#local-6989586621679211651"><span class="hs-identifier hs-var hs-var">fetchStateFetchedMaxSlotNo</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-185"></span><span>      </span><span id="local-6989586621679211653"><span class="annot"><span class="annottext">FetchMode
fetchStateFetchMode :: FetchMode
fetchStateFetchMode :: forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; FetchMode
</span><a href="#local-6989586621679211653"><span class="hs-identifier hs-var hs-var">fetchStateFetchMode</span></a></span></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span>                 </span><span class="annot"><span class="annottext">Map peer (AnchoredFragment header) -&gt; Set peer
forall k a. Map k a -&gt; Set k
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#keysSet"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map peer (AnchoredFragment header)
</span><a href="#local-6989586621679211643"><span class="hs-identifier hs-var">fetchStatePeerChains</span></a></span><span>
</span><span id="line-188"></span><span>            </span><span class="annot"><span class="annottext">Set peer -&gt; Set peer -&gt; Bool
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#isSubsetOf"><span class="hs-operator hs-var">`Set.isSubsetOf`</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
-&gt; Set peer
forall k a. Map k a -&gt; Set k
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#keysSet"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
</span><a href="#local-6989586621679211645"><span class="hs-identifier hs-var">fetchStatePeerStates</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(FetchDecision (FetchRequest header),
   PeerInfo header peer (FetchClientStateVars m header, peer))]
 -&gt; [(FetchDecision (FetchRequest header),
      PeerInfo header peer (FetchClientStateVars m header, peer))])
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span>                 </span><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
-&gt; Set peer
forall k a. Map k a -&gt; Set k
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#keysSet"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
</span><a href="#local-6989586621679211645"><span class="hs-identifier hs-var">fetchStatePeerStates</span></a></span><span>
</span><span id="line-191"></span><span>            </span><span class="annot"><span class="annottext">Set peer -&gt; Set peer -&gt; Bool
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#isSubsetOf"><span class="hs-operator hs-var">`Set.isSubsetOf`</span></a></span><span> </span><span class="annot"><span class="annottext">Map peer PeerGSV -&gt; Set peer
forall k a. Map k a -&gt; Set k
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#keysSet"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">Map peer PeerGSV
</span><a href="#local-6989586621679211647"><span class="hs-identifier hs-var">fetchStatePeerGSVs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(FetchDecision (FetchRequest header),
   PeerInfo header peer (FetchClientStateVars m header, peer))]
 -&gt; [(FetchDecision (FetchRequest header),
      PeerInfo header peer (FetchClientStateVars m header, peer))])
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
-&gt; FetchMode
-&gt; AnchoredFragment header
-&gt; (Point block -&gt; Bool)
-&gt; MaxSlotNo
-&gt; [(AnchoredFragment header,
     PeerInfo header peer (FetchClientStateVars m header, peer))]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall peer header block extra.
(Ord peer, Hashable peer, HasHeader header,
 HeaderHash header ~ HeaderHash block) =&gt;
FetchDecisionPolicy header
-&gt; FetchMode
-&gt; AnchoredFragment header
-&gt; (Point block -&gt; Bool)
-&gt; MaxSlotNo
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer extra)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchDecisions"><span class="hs-identifier hs-var">fetchDecisions</span></a></span><span>
</span><span id="line-194"></span><span>      </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211639"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-195"></span><span>      </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211653"><span class="hs-identifier hs-var">fetchStateFetchMode</span></a></span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211641"><span class="hs-identifier hs-var">fetchStateCurrentChain</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><span class="annottext">Point block -&gt; Bool
</span><a href="#local-6989586621679211649"><span class="hs-identifier hs-var">fetchStateFetchedBlocks</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211651"><span class="hs-identifier hs-var">fetchStateFetchedMaxSlotNo</span></a></span><span>
</span><span id="line-199"></span><span>      </span><span class="annot"><span class="annottext">[(AnchoredFragment header,
  PeerInfo header peer (FetchClientStateVars m header, peer))]
</span><a href="#local-6989586621679211657"><span class="hs-identifier hs-var">peerChainsAndPeerInfo</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621679211657"><span class="annot"><span class="annottext">peerChainsAndPeerInfo :: [(AnchoredFragment header,
  PeerInfo header peer (FetchClientStateVars m header, peer))]
</span><a href="#local-6989586621679211657"><span class="hs-identifier hs-var hs-var">peerChainsAndPeerInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-202"></span><span>      </span><span class="annot"><span class="annottext">((peer,
  ((AnchoredFragment header,
    (PeerFetchStatus header, PeerFetchInFlight header,
     FetchClientStateVars m header)),
   PeerGSV))
 -&gt; (AnchoredFragment header,
     PeerInfo header peer (FetchClientStateVars m header, peer)))
-&gt; [(peer,
     ((AnchoredFragment header,
       (PeerFetchStatus header, PeerFetchInFlight header,
        FetchClientStateVars m header)),
      PeerGSV))]
-&gt; [(AnchoredFragment header,
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(peer,
 ((AnchoredFragment header,
   (PeerFetchStatus header, PeerFetchInFlight header,
    FetchClientStateVars m header)),
  PeerGSV))
-&gt; (AnchoredFragment header,
    PeerInfo header peer (FetchClientStateVars m header, peer))
forall {b} {a} {a} {b} {a} {c}.
(b, ((a, (a, b, a)), c)) -&gt; (a, (a, b, c, b, (a, b)))
</span><a href="#local-6989586621679211658"><span class="hs-identifier hs-var">swizzle</span></a></span><span> </span><span class="annot"><span class="annottext">([(peer,
   ((AnchoredFragment header,
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)),
    PeerGSV))]
 -&gt; [(AnchoredFragment header,
      PeerInfo header peer (FetchClientStateVars m header, peer))])
-&gt; (Map
      peer
      ((AnchoredFragment header,
        (PeerFetchStatus header, PeerFetchInFlight header,
         FetchClientStateVars m header)),
       PeerGSV)
    -&gt; [(peer,
         ((AnchoredFragment header,
           (PeerFetchStatus header, PeerFetchInFlight header,
            FetchClientStateVars m header)),
          PeerGSV))])
-&gt; Map
     peer
     ((AnchoredFragment header,
       (PeerFetchStatus header, PeerFetchInFlight header,
        FetchClientStateVars m header)),
      PeerGSV)
-&gt; [(AnchoredFragment header,
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peer
  ((AnchoredFragment header,
    (PeerFetchStatus header, PeerFetchInFlight header,
     FetchClientStateVars m header)),
   PeerGSV)
-&gt; [(peer,
     ((AnchoredFragment header,
       (PeerFetchStatus header, PeerFetchInFlight header,
        FetchClientStateVars m header)),
      PeerGSV))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Map
   peer
   ((AnchoredFragment header,
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)),
    PeerGSV)
 -&gt; [(AnchoredFragment header,
      PeerInfo header peer (FetchClientStateVars m header, peer))])
-&gt; Map
     peer
     ((AnchoredFragment header,
       (PeerFetchStatus header, PeerFetchInFlight header,
        FetchClientStateVars m header)),
      PeerGSV)
-&gt; [(AnchoredFragment header,
     PeerInfo header peer (FetchClientStateVars m header, peer))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><span class="annottext">((AnchoredFragment header,
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header))
 -&gt; PeerGSV
 -&gt; ((AnchoredFragment header,
      (PeerFetchStatus header, PeerFetchInFlight header,
       FetchClientStateVars m header)),
     PeerGSV))
-&gt; Map
     peer
     (AnchoredFragment header,
      (PeerFetchStatus header, PeerFetchInFlight header,
       FetchClientStateVars m header))
-&gt; Map peer PeerGSV
-&gt; Map
     peer
     ((AnchoredFragment header,
       (PeerFetchStatus header, PeerFetchInFlight header,
        FetchClientStateVars m header)),
      PeerGSV)
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#intersectionWith"><span class="hs-identifier hs-var">Map.intersectionWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment header
 -&gt; (PeerFetchStatus header, PeerFetchInFlight header,
     FetchClientStateVars m header)
 -&gt; (AnchoredFragment header,
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)))
-&gt; Map peer (AnchoredFragment header)
-&gt; Map
     peer
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)
-&gt; Map
     peer
     (AnchoredFragment header,
      (PeerFetchStatus header, PeerFetchInFlight header,
       FetchClientStateVars m header))
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#intersectionWith"><span class="hs-identifier hs-var">Map.intersectionWith</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map peer (AnchoredFragment header)
</span><a href="#local-6989586621679211643"><span class="hs-identifier hs-var">fetchStatePeerChains</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
</span><a href="#local-6989586621679211645"><span class="hs-identifier hs-var">fetchStatePeerStates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>        </span><span class="annot"><span class="annottext">Map peer PeerGSV
</span><a href="#local-6989586621679211647"><span class="hs-identifier hs-var">fetchStatePeerGSVs</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>    </span><span id="local-6989586621679211658"><span class="annot"><span class="annottext">swizzle :: (b, ((a, (a, b, a)), c)) -&gt; (a, (a, b, c, b, (a, b)))
</span><a href="#local-6989586621679211658"><span class="hs-identifier hs-var hs-var">swizzle</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679211662"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679211662"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679211663"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211663"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679211664"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211664"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211665"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679211665"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211666"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211666"><span class="hs-identifier hs-var">vars</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211667"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679211667"><span class="hs-identifier hs-var">gsvs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211663"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211664"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679211665"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679211667"><span class="hs-identifier hs-var">gsvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679211662"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679211666"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679211662"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-comment">-- | Act on decisions to send new requests. In fact all we do here is update</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- request variables that are shared with the threads running the block fetch</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- protocol with each peer.</span><span>
</span><span id="line-214"></span><span class="hs-comment">--</span><span>
</span><span id="line-215"></span><span id="local-6989586621679211305"><span id="local-6989586621679211306"><span id="local-6989586621679211307"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterationAct"><span class="hs-identifier hs-type">fetchLogicIterationAct</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211305"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211306"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>                       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679211307"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier hs-type">TraceFetchClientState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211306"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211306"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-218"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211306"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-219"></span><span>                            </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-220"></span><span>                            </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientStateVars"><span class="hs-identifier hs-type">FetchClientStateVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211306"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-221"></span><span>                            </span><span class="annot"><a href="#local-6989586621679211307"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-222"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679211305"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679211307"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211306"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-223"></span><span id="fetchLogicIterationAct"><span class="annot"><span class="annottext">fetchLogicIterationAct :: forall (m :: * -&gt; *) header peer.
(MonadSTM m, HasHeader header) =&gt;
Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; [(FetchDecision (FetchRequest header), PeerGSV,
     FetchClientStateVars m header, peer)]
-&gt; m [(peer, PeerFetchStatus header)]
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterationAct"><span class="hs-identifier hs-var hs-var">fetchLogicIterationAct</span></a></span></span><span> </span><span id="local-6989586621679211683"><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679211683"><span class="hs-identifier hs-var">clientStateTracer</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span class="hs-special">{</span><span id="local-6989586621679211685"><span class="annot"><span class="annottext">header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
blockFetchSize :: forall header. FetchDecisionPolicy header -&gt; header -&gt; SizeInBytes
</span><a href="#local-6989586621679211685"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-224"></span><span>                       </span><span id="local-6989586621679211687"><span class="annot"><span class="annottext">[(FetchDecision (FetchRequest header), PeerGSV,
  FetchClientStateVars m header, peer)]
</span><a href="#local-6989586621679211687"><span class="hs-identifier hs-var">decisions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><span class="annottext">[m (peer, PeerFetchStatus header)]
-&gt; m [(peer, PeerFetchStatus header)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
forall (m :: * -&gt; *) a. Monad m =&gt; [m a] -&gt; m [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#sequence"><span class="hs-identifier hs-var">sequence</span></a></span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211689"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerFetchStatus header -&gt; (peer, PeerFetchStatus header))
-&gt; m (PeerFetchStatus header) -&gt; m (peer, PeerFetchStatus header)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceFetchClientState header)
-&gt; (header -&gt; SizeInBytes)
-&gt; FetchRequest header
-&gt; PeerGSV
-&gt; FetchClientStateVars m header
-&gt; m (PeerFetchStatus header)
forall (m :: * -&gt; *) header.
(MonadSTM m, HasHeader header) =&gt;
Tracer m (TraceFetchClientState header)
-&gt; (header -&gt; SizeInBytes)
-&gt; FetchRequest header
-&gt; PeerGSV
-&gt; FetchClientStateVars m header
-&gt; m (PeerFetchStatus header)
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#addNewFetchRequest"><span class="hs-identifier hs-var">addNewFetchRequest</span></a></span><span>
</span><span id="line-227"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TraceFetchClientState header
 -&gt; TraceLabelPeer peer (TraceFetchClientState header))
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; Tracer m (TraceFetchClientState header)
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier hs-var">contramap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">peer
-&gt; TraceFetchClientState header
-&gt; TraceLabelPeer peer (TraceFetchClientState header)
forall peerid a. peerid -&gt; a -&gt; TraceLabelPeer peerid a
</span><span class="hs-identifier hs-var">TraceLabelPeer</span></span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211689"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
</span><a href="#local-6989586621679211683"><span class="hs-identifier hs-var">clientStateTracer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>                       </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679211685"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span>
</span><span id="line-229"></span><span>                       </span><span class="annot"><span class="annottext">FetchRequest header
</span><a href="#local-6989586621679211691"><span class="hs-identifier hs-var">request</span></a></span><span> </span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679211692"><span class="hs-identifier hs-var">gsvs</span></a></span><span>
</span><span id="line-230"></span><span>                       </span><span class="annot"><span class="annottext">FetchClientStateVars m header
</span><a href="#local-6989586621679211693"><span class="hs-identifier hs-var">stateVars</span></a></span><span>
</span><span id="line-231"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679211691"><span class="annot"><span class="annottext">FetchRequest header
</span><a href="#local-6989586621679211691"><span class="hs-identifier hs-var">request</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211692"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679211692"><span class="hs-identifier hs-var">gsvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211693"><span class="annot"><span class="annottext">FetchClientStateVars m header
</span><a href="#local-6989586621679211693"><span class="hs-identifier hs-var">stateVars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211689"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211689"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision (FetchRequest header), PeerGSV,
  FetchClientStateVars m header, peer)]
</span><a href="#local-6989586621679211687"><span class="hs-identifier hs-var">decisions</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | STM actions to read various state variables that the fetch logic depends</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- upon. Any change in these variables is a trigger to re-evaluate the decision</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- on what blocks to fetch.</span><span>
</span><span id="line-237"></span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- Note that this is a \&quot;level trigger\&quot; not an \&quot;edge trigger\&quot;: we do not</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- have to re-evaluate on every change, it is sufficient to re-evaluate at some</span><span>
</span><span id="line-240"></span><span class="hs-comment">-- stage after one or more changes. This means it is ok to get somewhat behind,</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- and it is not necessary to determine exactly what changed, just that there</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- was some change.</span><span>
</span><span id="line-243"></span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span class="hs-keyword">data</span><span> </span><span id="FetchTriggerVariables"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-var">FetchTriggerVariables</span></a></span></span><span> </span><span id="local-6989586621679211380"><span class="annot"><a href="#local-6989586621679211380"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679211381"><span class="annot"><a href="#local-6989586621679211381"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679211382"><span class="annot"><a href="#local-6989586621679211382"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FetchTriggerVariables"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-var">FetchTriggerVariables</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-245"></span><span>       </span><span id="readStateCurrentChain"><span class="annot"><span class="annottext">forall peer header (m :: * -&gt; *).
FetchTriggerVariables peer header m
-&gt; STM m (AnchoredFragment header)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateCurrentChain"><span class="hs-identifier hs-var hs-var">readStateCurrentChain</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211382"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679211381"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-246"></span><span>       </span><span id="readStateCandidateChains"><span class="annot"><span class="annottext">forall peer header (m :: * -&gt; *).
FetchTriggerVariables peer header m
-&gt; STM m (Map peer (AnchoredFragment header))
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateCandidateChains"><span class="hs-identifier hs-var hs-var">readStateCandidateChains</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211382"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211380"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679211381"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-247"></span><span>       </span><span id="readStatePeerStatus"><span class="annot"><span class="annottext">forall peer header (m :: * -&gt; *).
FetchTriggerVariables peer header m
-&gt; STM m (Map peer (PeerFetchStatus header))
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStatePeerStatus"><span class="hs-identifier hs-var hs-var">readStatePeerStatus</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211382"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211380"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211381"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-comment">-- | STM actions to read various state variables that the fetch logic uses.</span><span>
</span><span id="line-251"></span><span class="hs-comment">-- While the decisions do make use of the values of these variables, it is not</span><span>
</span><span id="line-252"></span><span class="hs-comment">-- necessary to re-evaluate when these variables change.</span><span>
</span><span id="line-253"></span><span class="hs-comment">--</span><span>
</span><span id="line-254"></span><span class="hs-keyword">data</span><span> </span><span id="FetchNonTriggerVariables"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-var">FetchNonTriggerVariables</span></a></span></span><span> </span><span id="local-6989586621679211392"><span class="annot"><a href="#local-6989586621679211392"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679211393"><span class="annot"><a href="#local-6989586621679211393"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679211394"><span class="annot"><a href="#local-6989586621679211394"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679211395"><span class="annot"><a href="#local-6989586621679211395"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FetchNonTriggerVariables"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-var">FetchNonTriggerVariables</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-255"></span><span>       </span><span id="readStateFetchedBlocks"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m
-&gt; STM m (Point block -&gt; Bool)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateFetchedBlocks"><span class="hs-identifier hs-var hs-var">readStateFetchedBlocks</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679211394"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-256"></span><span>       </span><span id="readStatePeerStateVars"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m
-&gt; STM m (Map peer (FetchClientStateVars m header))
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStatePeerStateVars"><span class="hs-identifier hs-var hs-var">readStatePeerStateVars</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211392"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientStateVars"><span class="hs-identifier hs-type">FetchClientStateVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211393"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-257"></span><span>       </span><span id="readStatePeerGSVs"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m
-&gt; STM m (Map peer PeerGSV)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStatePeerGSVs"><span class="hs-identifier hs-var hs-var">readStatePeerGSVs</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211392"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-258"></span><span>       </span><span id="readStateFetchMode"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m -&gt; STM m FetchMode
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateFetchMode"><span class="hs-identifier hs-var hs-var">readStateFetchMode</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span class="hs-special">,</span><span>
</span><span id="line-259"></span><span>       </span><span id="readStateFetchedMaxSlotNo"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m -&gt; STM m MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateFetchedMaxSlotNo"><span class="hs-identifier hs-var hs-var">readStateFetchedMaxSlotNo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211395"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-260"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="hs-keyword">data</span><span> </span><span id="FetchStateFingerprint"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-var">FetchStateFingerprint</span></a></span></span><span> </span><span id="local-6989586621679211429"><span class="annot"><a href="#local-6989586621679211429"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679211430"><span class="annot"><a href="#local-6989586621679211430"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679211428"><span class="annot"><a href="#local-6989586621679211428"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-264"></span><span>     </span><span id="FetchStateFingerprint"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-var">FetchStateFingerprint</span></a></span></span><span>
</span><span id="line-265"></span><span>       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679211428"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211429"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679211430"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>       </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211429"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211430"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679211709"><span id="local-6989586621679211719"><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
(FetchStateFingerprint peer header block
 -&gt; FetchStateFingerprint peer header block -&gt; Bool)
-&gt; (FetchStateFingerprint peer header block
    -&gt; FetchStateFingerprint peer header block -&gt; Bool)
-&gt; Eq (FetchStateFingerprint peer header block)
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
forall peer header block.
(StandardHash block, StandardHash header, Eq peer) =&gt;
FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
$c== :: forall peer header block.
(StandardHash block, StandardHash header, Eq peer) =&gt;
FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
== :: FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
$c/= :: forall peer header block.
(StandardHash block, StandardHash header, Eq peer) =&gt;
FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
/= :: FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span id="local-6989586621679211245"><span id="local-6989586621679211246"><span id="local-6989586621679211247"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#initialFetchStateFingerprint"><span class="hs-identifier hs-type">initialFetchStateFingerprint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211245"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211246"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211247"><span class="hs-identifier hs-type">block</span></a></span></span></span></span><span>
</span><span id="line-271"></span><span id="initialFetchStateFingerprint"><span class="annot"><span class="annottext">initialFetchStateFingerprint :: forall peer header block. FetchStateFingerprint peer header block
</span><a href="Ouroboros.Network.BlockFetch.State.html#initialFetchStateFingerprint"><span class="hs-identifier hs-var hs-var">initialFetchStateFingerprint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Point block)
-&gt; Map peer (Point header)
-&gt; Map peer (PeerFetchStatus header)
-&gt; FetchStateFingerprint peer header block
forall peer header block.
Maybe (Point block)
-&gt; Map peer (Point header)
-&gt; Map peer (PeerFetchStatus header)
-&gt; FetchStateFingerprint peer header block
</span><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-var">FetchStateFingerprint</span></a></span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Point block)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><span class="annottext">Map peer (Point header)
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="annot"><span class="annottext">Map peer (PeerFetchStatus header)
forall k a. Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#empty"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span id="local-6989586621679211317"><span id="local-6989586621679211318"><span id="local-6989586621679211319"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#updateFetchStateFingerprintPeerStatus"><span class="hs-identifier hs-type">updateFetchStateFingerprintPeerStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211317"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-278"></span><span>                                      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679211317"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211318"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-279"></span><span>                                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211317"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211318"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211319"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-280"></span><span>                                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211317"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211318"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211319"><span class="hs-identifier hs-type">block</span></a></span></span></span></span><span>
</span><span id="line-281"></span><span id="updateFetchStateFingerprintPeerStatus"><span class="annot"><span class="annottext">updateFetchStateFingerprintPeerStatus :: forall peer header block.
Ord peer =&gt;
[(peer, PeerFetchStatus header)]
-&gt; FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block
</span><a href="Ouroboros.Network.BlockFetch.State.html#updateFetchStateFingerprintPeerStatus"><span class="hs-identifier hs-var hs-var">updateFetchStateFingerprintPeerStatus</span></a></span></span><span> </span><span id="local-6989586621679211728"><span class="annot"><span class="annottext">[(peer, PeerFetchStatus header)]
</span><a href="#local-6989586621679211728"><span class="hs-identifier hs-var">statuses'</span></a></span></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span id="local-6989586621679211729"><span class="annot"><span class="annottext">Maybe (Point block)
</span><a href="#local-6989586621679211729"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span id="local-6989586621679211730"><span class="annot"><span class="annottext">Map peer (Point header)
</span><a href="#local-6989586621679211730"><span class="hs-identifier hs-var">candidates</span></a></span></span><span> </span><span id="local-6989586621679211731"><span class="annot"><span class="annottext">Map peer (PeerFetchStatus header)
</span><a href="#local-6989586621679211731"><span class="hs-identifier hs-var">statuses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-283"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Point block)
-&gt; Map peer (Point header)
-&gt; Map peer (PeerFetchStatus header)
-&gt; FetchStateFingerprint peer header block
forall peer header block.
Maybe (Point block)
-&gt; Map peer (Point header)
-&gt; Map peer (PeerFetchStatus header)
-&gt; FetchStateFingerprint peer header block
</span><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-var">FetchStateFingerprint</span></a></span><span>
</span><span id="line-284"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Point block)
</span><a href="#local-6989586621679211729"><span class="hs-identifier hs-var">current</span></a></span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">Map peer (Point header)
</span><a href="#local-6989586621679211730"><span class="hs-identifier hs-var">candidates</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map peer (PeerFetchStatus header)
-&gt; Map peer (PeerFetchStatus header)
-&gt; Map peer (PeerFetchStatus header)
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#union"><span class="hs-identifier hs-var">Map.union</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(peer, PeerFetchStatus header)]
-&gt; Map peer (PeerFetchStatus header)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#fromList"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">[(peer, PeerFetchStatus header)]
</span><a href="#local-6989586621679211728"><span class="hs-identifier hs-var">statuses'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map peer (PeerFetchStatus header)
</span><a href="#local-6989586621679211731"><span class="hs-identifier hs-var">statuses</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- left overrides right</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-289"></span><span class="hs-comment">--</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- Note that the domain of 'fetchStatePeerChains' is a subset of the domain</span><span>
</span><span id="line-291"></span><span class="hs-comment">-- of 'fetchStatePeerStates' and 'fetchStatePeerReqVars'.</span><span>
</span><span id="line-292"></span><span class="hs-comment">--</span><span>
</span><span id="line-293"></span><span class="hs-keyword">data</span><span> </span><span id="FetchStateSnapshot"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateSnapshot"><span class="hs-identifier hs-var">FetchStateSnapshot</span></a></span></span><span> </span><span id="local-6989586621679211331"><span class="annot"><a href="#local-6989586621679211331"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679211332"><span class="annot"><a href="#local-6989586621679211332"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679211333"><span class="annot"><a href="#local-6989586621679211333"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679211334"><span class="annot"><a href="#local-6989586621679211334"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FetchStateSnapshot"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateSnapshot"><span class="hs-identifier hs-var">FetchStateSnapshot</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-294"></span><span>       </span><span id="fetchStateCurrentChain"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; AnchoredFragment header
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateCurrentChain"><span class="hs-identifier hs-var hs-var">fetchStateCurrentChain</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679211332"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-295"></span><span>       </span><span id="fetchStatePeerChains"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m
-&gt; Map peer (AnchoredFragment header)
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStatePeerChains"><span class="hs-identifier hs-var hs-var">fetchStatePeerChains</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211331"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679211332"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-296"></span><span>       </span><span id="fetchStatePeerStates"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m
-&gt; Map
     peer
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStatePeerStates"><span class="hs-identifier hs-var hs-var">fetchStatePeerStates</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211331"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span>   </span><span class="annot"><a href="#local-6989586621679211332"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-297"></span><span>                                               </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211332"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-298"></span><span>                                               </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientStateVars"><span class="hs-identifier hs-type">FetchClientStateVars</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211334"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211332"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-299"></span><span>       </span><span id="fetchStatePeerGSVs"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; Map peer PeerGSV
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStatePeerGSVs"><span class="hs-identifier hs-var hs-var">fetchStatePeerGSVs</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211331"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-300"></span><span>       </span><span id="fetchStateFetchedBlocks"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; Point block -&gt; Bool
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateFetchedBlocks"><span class="hs-identifier hs-var hs-var">fetchStateFetchedBlocks</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679211333"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>       </span><span id="fetchStateFetchMode"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; FetchMode
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateFetchMode"><span class="hs-identifier hs-var hs-var">fetchStateFetchMode</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>       </span><span id="fetchStateFetchedMaxSlotNo"><span class="annot"><span class="annottext">forall peer header block (m :: * -&gt; *).
FetchStateSnapshot peer header block m -&gt; MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateFetchedMaxSlotNo"><span class="hs-identifier hs-var hs-var">fetchStateFetchedMaxSlotNo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-303"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span id="local-6989586621679211281"><span id="local-6989586621679211282"><span id="local-6989586621679211283"><span id="local-6989586621679211284"><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#readStateVariables"><span class="hs-identifier hs-type">readStateVariables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211281"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211282"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>                       </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211283"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679211284"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-307"></span><span>                       </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211283"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679211284"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>                   </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211282"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211283"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211281"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-309"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211282"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211283"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211284"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211281"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-310"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211282"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211283"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211284"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-311"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679211281"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateSnapshot"><span class="hs-identifier hs-type">FetchStateSnapshot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211282"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211283"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211284"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211281"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-312"></span><span>                             </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-type">FetchStateFingerprint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211282"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211283"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679211284"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-313"></span><span id="readStateVariables"><span class="annot"><span class="annottext">readStateVariables :: forall (m :: * -&gt; *) peer header block.
(MonadSTM m, Eq peer, HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block) =&gt;
FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; FetchStateFingerprint peer header block
-&gt; STM
     m
     (FetchStateSnapshot peer header block m,
      FetchStateFingerprint peer header block)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateVariables"><span class="hs-identifier hs-var hs-var">readStateVariables</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span class="hs-special">{</span><span id="local-6989586621679211766"><span id="local-6989586621679211767"><span id="local-6989586621679211768"><span class="annot"><span class="annottext">STM m (Map peer (AnchoredFragment header))
STM m (Map peer (PeerFetchStatus header))
STM m (AnchoredFragment header)
readStateCurrentChain :: forall peer header (m :: * -&gt; *).
FetchTriggerVariables peer header m
-&gt; STM m (AnchoredFragment header)
readStateCandidateChains :: forall peer header (m :: * -&gt; *).
FetchTriggerVariables peer header m
-&gt; STM m (Map peer (AnchoredFragment header))
readStatePeerStatus :: forall peer header (m :: * -&gt; *).
FetchTriggerVariables peer header m
-&gt; STM m (Map peer (PeerFetchStatus header))
readStateCurrentChain :: STM m (AnchoredFragment header)
readStateCandidateChains :: STM m (Map peer (AnchoredFragment header))
readStatePeerStatus :: STM m (Map peer (PeerFetchStatus header))
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateCurrentChain"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-314"></span><span>                   </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span class="hs-special">{</span><span id="local-6989586621679211769"><span id="local-6989586621679211770"><span id="local-6989586621679211771"><span id="local-6989586621679211772"><span id="local-6989586621679211773"><span class="annot"><span class="annottext">STM m (Map peer PeerGSV)
STM m (Map peer (FetchClientStateVars m header))
STM m MaxSlotNo
STM m FetchMode
STM m (Point block -&gt; Bool)
readStateFetchedBlocks :: forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m
-&gt; STM m (Point block -&gt; Bool)
readStatePeerStateVars :: forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m
-&gt; STM m (Map peer (FetchClientStateVars m header))
readStatePeerGSVs :: forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m
-&gt; STM m (Map peer PeerGSV)
readStateFetchMode :: forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m -&gt; STM m FetchMode
readStateFetchedMaxSlotNo :: forall peer header block (m :: * -&gt; *).
FetchNonTriggerVariables peer header block m -&gt; STM m MaxSlotNo
readStateFetchedBlocks :: STM m (Point block -&gt; Bool)
readStatePeerStateVars :: STM m (Map peer (FetchClientStateVars m header))
readStatePeerGSVs :: STM m (Map peer PeerGSV)
readStateFetchMode :: STM m FetchMode
readStateFetchedMaxSlotNo :: STM m MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateFetchedBlocks"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-315"></span><span>                   </span><span id="local-6989586621679211774"><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211774"><span class="hs-identifier hs-var">fetchStateFingerprint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">-- Read all the trigger state variables</span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621679211775"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211775"><span class="hs-identifier hs-var">fetchStateCurrentChain</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment header)
</span><a href="#local-6989586621679211766"><span class="hs-identifier hs-var">readStateCurrentChain</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621679211776"><span class="annot"><span class="annottext">Map peer (AnchoredFragment header)
</span><a href="#local-6989586621679211776"><span class="hs-identifier hs-var">fetchStatePeerChains</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Map peer (AnchoredFragment header))
</span><a href="#local-6989586621679211767"><span class="hs-identifier hs-var">readStateCandidateChains</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span id="local-6989586621679211777"><span class="annot"><span class="annottext">Map peer (PeerFetchStatus header)
</span><a href="#local-6989586621679211777"><span class="hs-identifier hs-var">fetchStatePeerStatus</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Map peer (PeerFetchStatus header))
</span><a href="#local-6989586621679211768"><span class="hs-identifier hs-var">readStatePeerStatus</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-comment">-- Construct the change detection fingerprint</span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679211778"><span class="annot"><span class="annottext">fetchStateFingerprint' :: FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211778"><span class="hs-identifier hs-var hs-var">fetchStateFingerprint'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Point block)
-&gt; Map peer (Point header)
-&gt; Map peer (PeerFetchStatus header)
-&gt; FetchStateFingerprint peer header block
forall peer header block.
Maybe (Point block)
-&gt; Map peer (Point header)
-&gt; Map peer (PeerFetchStatus header)
-&gt; FetchStateFingerprint peer header block
</span><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateFingerprint"><span class="hs-identifier hs-var">FetchStateFingerprint</span></a></span><span>
</span><span id="line-325"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point block -&gt; Maybe (Point block)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point header -&gt; Point block
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; Point header
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211775"><span class="hs-identifier hs-var">fetchStateCurrentChain</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; Point header)
-&gt; Map peer (AnchoredFragment header) -&gt; Map peer (Point header)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Strict.Internal.html#map"><span class="hs-identifier hs-var">Map.map</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; Point header
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">Map peer (AnchoredFragment header)
</span><a href="#local-6989586621679211776"><span class="hs-identifier hs-var">fetchStatePeerChains</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>            </span><span class="annot"><span class="annottext">Map peer (PeerFetchStatus header)
</span><a href="#local-6989586621679211777"><span class="hs-identifier hs-var">fetchStatePeerStatus</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-comment">-- Check the fingerprint changed, or block and wait until it does</span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; STM m ()
forall (m :: * -&gt; *). MonadSTM m =&gt; Bool -&gt; STM m ()
</span><span class="hs-identifier hs-var">check</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211778"><span class="hs-identifier hs-var">fetchStateFingerprint'</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
-&gt; FetchStateFingerprint peer header block -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211774"><span class="hs-identifier hs-var">fetchStateFingerprint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-comment">-- Now read all the non-trigger state variables</span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621679211783"><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
</span><a href="#local-6989586621679211783"><span class="hs-identifier hs-var">fetchStatePeerStates</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Map peer (FetchClientStateVars m header))
</span><a href="#local-6989586621679211770"><span class="hs-identifier hs-var">readStatePeerStateVars</span></a></span><span>
</span><span id="line-334"></span><span>                              </span><span class="annot"><span class="annottext">STM m (Map peer (FetchClientStateVars m header))
-&gt; (Map peer (FetchClientStateVars m header)
    -&gt; STM
         m
         (Map
            peer
            (PeerFetchStatus header, PeerFetchInFlight header,
             FetchClientStateVars m header)))
-&gt; STM
     m
     (Map
        peer
        (PeerFetchStatus header, PeerFetchInFlight header,
         FetchClientStateVars m header))
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchClientStateVars m header
 -&gt; STM
      m
      (PeerFetchStatus header, PeerFetchInFlight header,
       FetchClientStateVars m header))
-&gt; Map peer (FetchClientStateVars m header)
-&gt; STM
     m
     (Map
        peer
        (PeerFetchStatus header, PeerFetchInFlight header,
         FetchClientStateVars m header))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; Map peer a -&gt; f (Map peer b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientStateVars m header
-&gt; STM
     m
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)
forall (m :: * -&gt; *) header.
MonadSTM m =&gt;
FetchClientStateVars m header
-&gt; STM
     m
     (PeerFetchStatus header, PeerFetchInFlight header,
      FetchClientStateVars m header)
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#readFetchClientState"><span class="hs-identifier hs-var">readFetchClientState</span></a></span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621679211785"><span class="annot"><span class="annottext">Map peer PeerGSV
</span><a href="#local-6989586621679211785"><span class="hs-identifier hs-var">fetchStatePeerGSVs</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Map peer PeerGSV)
</span><a href="#local-6989586621679211771"><span class="hs-identifier hs-var">readStatePeerGSVs</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621679211786"><span class="annot"><span class="annottext">Point block -&gt; Bool
</span><a href="#local-6989586621679211786"><span class="hs-identifier hs-var">fetchStateFetchedBlocks</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (Point block -&gt; Bool)
</span><a href="#local-6989586621679211769"><span class="hs-identifier hs-var">readStateFetchedBlocks</span></a></span><span>
</span><span id="line-337"></span><span>    </span><span id="local-6989586621679211787"><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211787"><span class="hs-identifier hs-var">fetchStateFetchMode</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m FetchMode
</span><a href="#local-6989586621679211772"><span class="hs-identifier hs-var">readStateFetchMode</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621679211788"><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211788"><span class="hs-identifier hs-var">fetchStateFetchedMaxSlotNo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m MaxSlotNo
</span><a href="#local-6989586621679211773"><span class="hs-identifier hs-var">readStateFetchedMaxSlotNo</span></a></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>    </span><span class="hs-comment">-- Construct the overall snapshot of the state</span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679211789"><span class="annot"><span class="annottext">fetchStateSnapshot :: FetchStateSnapshot peer header block m
</span><a href="#local-6989586621679211789"><span class="hs-identifier hs-var hs-var">fetchStateSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-343"></span><span>          </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchStateSnapshot"><span class="hs-identifier hs-type">FetchStateSnapshot</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-344"></span><span>            </span><span class="annot"><span class="annottext">AnchoredFragment header
fetchStateCurrentChain :: AnchoredFragment header
fetchStateCurrentChain :: AnchoredFragment header
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateCurrentChain"><span class="hs-identifier hs-var hs-var">fetchStateCurrentChain</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-345"></span><span>            </span><span class="annot"><span class="annottext">Map peer (AnchoredFragment header)
fetchStatePeerChains :: Map peer (AnchoredFragment header)
fetchStatePeerChains :: Map peer (AnchoredFragment header)
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStatePeerChains"><span class="hs-identifier hs-var hs-var">fetchStatePeerChains</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
fetchStatePeerStates :: Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
fetchStatePeerStates :: Map
  peer
  (PeerFetchStatus header, PeerFetchInFlight header,
   FetchClientStateVars m header)
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStatePeerStates"><span class="hs-identifier hs-var hs-var">fetchStatePeerStates</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-347"></span><span>            </span><span class="annot"><span class="annottext">Map peer PeerGSV
fetchStatePeerGSVs :: Map peer PeerGSV
fetchStatePeerGSVs :: Map peer PeerGSV
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStatePeerGSVs"><span class="hs-identifier hs-var hs-var">fetchStatePeerGSVs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-348"></span><span>            </span><span class="annot"><span class="annottext">Point block -&gt; Bool
fetchStateFetchedBlocks :: Point block -&gt; Bool
fetchStateFetchedBlocks :: Point block -&gt; Bool
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateFetchedBlocks"><span class="hs-identifier hs-var hs-var">fetchStateFetchedBlocks</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-349"></span><span>            </span><span class="annot"><span class="annottext">FetchMode
fetchStateFetchMode :: FetchMode
fetchStateFetchMode :: FetchMode
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateFetchMode"><span class="hs-identifier hs-var hs-var">fetchStateFetchMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-350"></span><span>            </span><span class="annot"><span class="annottext">MaxSlotNo
fetchStateFetchedMaxSlotNo :: MaxSlotNo
fetchStateFetchedMaxSlotNo :: MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchStateFetchedMaxSlotNo"><span class="hs-identifier hs-var hs-var">fetchStateFetchedMaxSlotNo</span></a></span><span>
</span><span id="line-351"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="annottext">(FetchStateSnapshot peer header block m,
 FetchStateFingerprint peer header block)
-&gt; STM
     m
     (FetchStateSnapshot peer header block m,
      FetchStateFingerprint peer header block)
forall a. a -&gt; STM m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchStateSnapshot peer header block m
</span><a href="#local-6989586621679211789"><span class="hs-identifier hs-var">fetchStateSnapshot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FetchStateFingerprint peer header block
</span><a href="#local-6989586621679211778"><span class="hs-identifier hs-var">fetchStateFingerprint'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span></pre></body></html>
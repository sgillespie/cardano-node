<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures      #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span class="hs-cpp">

#if !defined(mingw32_HOST_OS)
</span><span class="hs-cpp">#define POSIX
</span><span class="hs-cpp">#endif
</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- | This module is expected to be imported qualified (it will clash</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- with the &quot;Ouroboros.Network.Diffusion.NonP2P&quot;).</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.Diffusion.P2P</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier">TracersExtra</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#nullTracers"><span class="hs-identifier">nullTracers</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ArgumentsExtra"><span class="hs-identifier">ArgumentsExtra</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AcceptedConnectionsLimit</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ApplicationsExtra"><span class="hs-identifier">ApplicationsExtra</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#run"><span class="hs-identifier">run</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#Interfaces"><span class="hs-identifier">Interfaces</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#runM"><span class="hs-identifier">runM</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodePeerConnectionHandle"><span class="hs-identifier">NodeToNodePeerConnectionHandle</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">AbstractTransitionTrace</span></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">RemoteTransitionTrace</span></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Applicative.html"><span class="hs-identifier">Control.Applicative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Alternative"><span class="hs-identifier">Alternative</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM.Strict</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#IOException"><span class="hs-identifier">IOException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Async</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadAsync</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadAsync</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Async</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadFork</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime.SI</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer.SI</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.Fix.html"><span class="hs-identifier">Control.Monad.Fix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.Fix.html#MonadFix"><span class="hs-identifier">MonadFix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-identifier">contramap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">nullTracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#asum"><span class="hs-identifier">asum</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.IP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IP</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IP</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IP</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.NonEmpty.html"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#NonEmpty"><span class="hs-identifier">NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#catMaybes"><span class="hs-identifier">catMaybes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybeToList"><span class="hs-identifier">maybeToList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#elemAt"><span class="hs-identifier">elemAt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.html"><span class="hs-identifier">Data.Typeable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier">Typeable</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Void.html"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/System.Exit.html"><span class="hs-identifier">System.Exit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#ExitCode"><span class="hs-identifier">ExitCode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Random</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">StdGen</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newStdGen</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">randomRs</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">split</span></span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef POSIX
</span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/unix-2.8.1.0/src/System.Posix.Signals.html"><span class="hs-identifier">System.Posix.Signals</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Signals</span></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Socket</span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Socket</span></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Network.Mux</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Mx</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MakeBearer</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Snocket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FileDescriptor</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">LocalAddress</span></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>                     </span><span class="annot"><span class="hs-identifier">LocalSocket</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Snocket</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">localSocketFileDescriptor</span></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>                     </span><span class="annot"><span class="hs-identifier">makeLocalBearer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">makeSocketBearer</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Snocket</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Snocket</span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.ConnectionId</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Context</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ExpandedInitiatorContext</span></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>                     </span><span class="annot"><span class="hs-identifier">ResponderContext</span></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Codec</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Version</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Socket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">configureSocket</span></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>                     </span><span class="annot"><span class="hs-identifier">configureSystemdSocket</span></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#nub"><span class="hs-identifier">nub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.ConnectionHandler</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.ConnectionManager.Core</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.ConnectionManager.InformationChannel</span></span><span>
</span><span id="line-85"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">InformationChannel</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newInformationChannel</span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.ConnectionManager.Types</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html"><span class="hs-identifier">Ouroboros.Network.Diffusion.Common</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#nullTracers"><span class="hs-identifier">nullTracers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Policies.html"><span class="hs-identifier">Ouroboros.Network.Diffusion.Policies</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Diffusion.Policies</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Utils.html"><span class="hs-identifier">Ouroboros.Network.Diffusion.Utils</span></a></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.ExitPolicy.html"><span class="hs-identifier">Ouroboros.Network.ExitPolicy</span></a></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.InboundGovernor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">InboundGovernorTrace</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>                     </span><span class="annot"><span class="hs-identifier">RemoteTransitionTrace</span></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.IOManager</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Mux</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MiniProtocol</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.MuxMode</span></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.NodeToClient.html"><span class="hs-identifier">Ouroboros.Network.NodeToClient</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NodeToClientVersion</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>                     </span><span class="annot"><span class="hs-identifier">NodeToClientVersionData</span></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToClient.html"><span class="hs-identifier">Ouroboros.Network.NodeToClient</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NodeToClient</span></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html"><span class="hs-identifier">Ouroboros.Network.NodeToNode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AcceptedConnectionsLimit</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>                     </span><span class="annot"><span class="hs-identifier">DiffusionMode</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">NodeToNodeVersion</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-101"></span><span>                     </span><span class="annot"><span class="hs-identifier">NodeToNodeVersionData</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html#RemoteAddress"><span class="hs-identifier">RemoteAddress</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html"><span class="hs-identifier">Ouroboros.Network.NodeToNode</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NodeToNode</span></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.Governor</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Governor</span></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.Governor.Types</span></a></span><span>
</span><span id="line-105"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#ChurnMode"><span class="hs-identifier">ChurnMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#ChurnModeNormal"><span class="hs-identifier">ChurnModeNormal</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#DebugPeerSelection"><span class="hs-identifier">DebugPeerSelection</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerSelectionActions"><span class="hs-identifier">PeerSelectionActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerSelectionCounters"><span class="hs-identifier">PeerSelectionCounters</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-107"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerSelectionPolicy"><span class="hs-identifier">PeerSelectionPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerStateActions"><span class="hs-identifier">PeerStateActions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PublicPeerSelectionState"><span class="hs-identifier">PublicPeerSelectionState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#TracePeerSelection"><span class="hs-identifier">TracePeerSelection</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#emptyPublicPeerSelectionState"><span class="hs-identifier">emptyPublicPeerSelectionState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.LedgerPeers</span></a></span><span>
</span><span id="line-111"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.html#LedgerPeersConsensusInterface"><span class="hs-identifier">LedgerPeersConsensusInterface</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.Common.html#TraceLedgerPeers"><span class="hs-identifier">TraceLedgerPeers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.Common.html#UseLedgerAfter"><span class="hs-identifier">UseLedgerAfter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerMetric</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier">PeerMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerSelectionActions.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerSelectionActions</span></a></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerSharing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PeerSharing</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.PeerStateActions</span></a></span><span>
</span><span id="line-117"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerConnectionHandle"><span class="hs-identifier">PeerConnectionHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerSelectionActionsTrace"><span class="hs-identifier">PeerSelectionActionsTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerStateActionsArguments"><span class="hs-identifier">PeerStateActionsArguments</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#pchPeerSharing"><span class="hs-identifier">pchPeerSharing</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#withPeerStateActions"><span class="hs-identifier">withPeerStateActions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.PeerSelection.RelayAccessPoint</span></span><span>
</span><span id="line-121"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">RelayAccessPoint</span></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions</span></a></span><span>
</span><span id="line-123"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#DNSActions"><span class="hs-identifier">DNSActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#DNSLookupType"><span class="hs-identifier">DNSLookupType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#ioDNSActions"><span class="hs-identifier">ioDNSActions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.LocalRootPeers.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.RootPeersDNS.LocalRootPeers</span></a></span><span>
</span><span id="line-125"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.LocalRootPeers.html#TraceLocalRootPeers"><span class="hs-identifier">TraceLocalRootPeers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.PublicRootPeers.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.RootPeersDNS.PublicRootPeers</span></a></span><span>
</span><span id="line-127"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.PublicRootPeers.html#TracePublicRootPeers"><span class="hs-identifier">TracePublicRootPeers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.State.LocalRootPeers.html"><span class="hs-identifier">Ouroboros.Network.PeerSelection.State.LocalRootPeers</span></a></span><span>
</span><span id="line-129"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.State.LocalRootPeers.html#HotValency"><span class="hs-identifier">HotValency</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.State.LocalRootPeers.html#WarmValency"><span class="hs-identifier">WarmValency</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.PeerSharing.html"><span class="hs-identifier">Ouroboros.Network.PeerSharing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSharing.html#PeerSharingRegistry"><span class="hs-identifier">PeerSharingRegistry</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Protocol.PeerSharing.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PeerSharingAmount</span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.RethrowPolicy</span></span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Server2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ServerArguments</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>                     </span><span class="annot"><span class="hs-identifier">ServerTrace</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Server2</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Server</span></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">-- | P2P DiffusionTracers Extras</span><span>
</span><span id="line-138"></span><span class="hs-comment">--</span><span>
</span><span id="line-139"></span><span class="hs-keyword">data</span><span> </span><span id="TracersExtra"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier hs-var">TracersExtra</span></a></span></span><span> </span><span id="local-6989586621679230061"><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679230062"><span class="annot"><a href="#local-6989586621679230062"><span class="hs-identifier hs-type">ntnVersion</span></a></span></span><span> </span><span id="local-6989586621679230063"><span class="annot"><a href="#local-6989586621679230063"><span class="hs-identifier hs-type">ntnVersionData</span></a></span></span><span>
</span><span id="line-140"></span><span>                  </span><span id="local-6989586621679230064"><span class="annot"><a href="#local-6989586621679230064"><span class="hs-identifier hs-type">ntcAddr</span></a></span></span><span> </span><span id="local-6989586621679230065"><span class="annot"><a href="#local-6989586621679230065"><span class="hs-identifier hs-type">ntcVersion</span></a></span></span><span> </span><span id="local-6989586621679230066"><span class="annot"><a href="#local-6989586621679230066"><span class="hs-identifier hs-type">ntcVersionData</span></a></span></span><span>
</span><span id="line-141"></span><span>                  </span><span id="local-6989586621679230067"><span class="annot"><a href="#local-6989586621679230067"><span class="hs-identifier hs-type">resolverError</span></a></span></span><span> </span><span id="local-6989586621679230068"><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>    </span><span id="TracersExtra"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier hs-var">TracersExtra</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-143"></span><span>      </span><span id="dtTraceLocalRootPeersTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (TraceLocalRootPeers ntnAddr resolverError)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTraceLocalRootPeersTracer"><span class="hs-identifier hs-var hs-var">dtTraceLocalRootPeersTracer</span></a></span></span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.LocalRootPeers.html#TraceLocalRootPeers"><span class="hs-identifier hs-type">TraceLocalRootPeers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230067"><span class="hs-identifier hs-type">resolverError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtTracePublicRootPeersTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m TracePublicRootPeers
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePublicRootPeersTracer"><span class="hs-identifier hs-var hs-var">dtTracePublicRootPeersTracer</span></a></span></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.PublicRootPeers.html#TracePublicRootPeers"><span class="hs-identifier hs-type">TracePublicRootPeers</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Ledger Peers tracer</span></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtTraceLedgerPeersTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m TraceLedgerPeers
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTraceLedgerPeersTracer"><span class="hs-identifier hs-var hs-var">dtTraceLedgerPeersTracer</span></a></span></span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.Common.html#TraceLedgerPeers"><span class="hs-identifier hs-type">TraceLedgerPeers</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtTracePeerSelectionTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (TracePeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePeerSelectionTracer"><span class="hs-identifier hs-var hs-var">dtTracePeerSelectionTracer</span></a></span></span><span>
</span><span id="line-154"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#TracePeerSelection"><span class="hs-identifier hs-type">TracePeerSelection</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtDebugPeerSelectionInitiatorTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (DebugPeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtDebugPeerSelectionInitiatorTracer"><span class="hs-identifier hs-var hs-var">dtDebugPeerSelectionInitiatorTracer</span></a></span></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#DebugPeerSelection"><span class="hs-identifier hs-type">DebugPeerSelection</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-comment">-- TODO: can be unified with the previous one</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtDebugPeerSelectionInitiatorResponderTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (DebugPeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtDebugPeerSelectionInitiatorResponderTracer"><span class="hs-identifier hs-var hs-var">dtDebugPeerSelectionInitiatorResponderTracer</span></a></span></span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#DebugPeerSelection"><span class="hs-identifier hs-type">DebugPeerSelection</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtTracePeerSelectionCounters"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m PeerSelectionCounters
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePeerSelectionCounters"><span class="hs-identifier hs-var hs-var">dtTracePeerSelectionCounters</span></a></span></span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerSelectionCounters"><span class="hs-identifier hs-type">PeerSelectionCounters</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtPeerSelectionActionsTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtPeerSelectionActionsTracer"><span class="hs-identifier hs-var hs-var">dtPeerSelectionActionsTracer</span></a></span></span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerSelectionActionsTrace"><span class="hs-identifier hs-type">PeerSelectionActionsTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230062"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtConnectionManagerTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer
     m
     (ConnectionManagerTrace
        ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtConnectionManagerTracer"><span class="hs-identifier hs-var hs-var">dtConnectionManagerTracer</span></a></span></span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionManagerTrace</span></span><span>
</span><span id="line-171"></span><span>                      </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-172"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></span><span>
</span><span id="line-173"></span><span>                         </span><span class="annot"><a href="#local-6989586621679230062"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span>
</span><span id="line-174"></span><span>                         </span><span class="annot"><a href="#local-6989586621679230063"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtConnectionManagerTransitionTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (AbstractTransitionTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtConnectionManagerTransitionTracer"><span class="hs-identifier hs-var hs-var">dtConnectionManagerTransitionTracer</span></a></span></span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AbstractTransitionTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtServerTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (ServerTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtServerTracer"><span class="hs-identifier hs-var hs-var">dtServerTracer</span></a></span></span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtInboundGovernorTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (InboundGovernorTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtInboundGovernorTracer"><span class="hs-identifier hs-var hs-var">dtInboundGovernorTracer</span></a></span></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">InboundGovernorTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtInboundGovernorTransitionTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (RemoteTransitionTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtInboundGovernorTransitionTracer"><span class="hs-identifier hs-var hs-var">dtInboundGovernorTransitionTracer</span></a></span></span><span>
</span><span id="line-186"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RemoteTransitionTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679230061"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-comment">-- NodeToClient tracers</span><span>
</span><span id="line-190"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Connection manager tracer for local clients</span></span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtLocalConnectionManagerTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer
     m
     (ConnectionManagerTrace
        ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalConnectionManagerTracer"><span class="hs-identifier hs-var hs-var">dtLocalConnectionManagerTracer</span></a></span></span><span>
</span><span id="line-194"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionManagerTrace</span></span><span>
</span><span id="line-195"></span><span>                       </span><span class="annot"><a href="#local-6989586621679230064"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span>
</span><span id="line-196"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></span><span>
</span><span id="line-197"></span><span>                          </span><span class="annot"><a href="#local-6989586621679230065"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span>
</span><span id="line-198"></span><span>                          </span><span class="annot"><a href="#local-6989586621679230066"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Server tracer for local clients</span></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtLocalServerTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (ServerTrace ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalServerTracer"><span class="hs-identifier hs-var hs-var">dtLocalServerTracer</span></a></span></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ServerTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679230064"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Inbound protocol governor tracer for local clients</span></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="dtLocalInboundGovernorTracer"><span class="annot"><span class="annottext">forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (InboundGovernorTrace ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalInboundGovernorTracer"><span class="hs-identifier hs-var hs-var">dtLocalInboundGovernorTracer</span></a></span></span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230068"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">InboundGovernorTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679230064"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span id="local-6989586621679230212"><span id="local-6989586621679230213"><span id="local-6989586621679230214"><span id="local-6989586621679230215"><span id="local-6989586621679230216"><span id="local-6989586621679230217"><span id="local-6989586621679230218"><span id="local-6989586621679230219"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#nullTracers"><span class="hs-identifier hs-type">nullTracers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Applicative"><span class="hs-identifier hs-type">Applicative</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230212"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-210"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier hs-type">TracersExtra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230213"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230214"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230215"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span>
</span><span id="line-211"></span><span>                            </span><span class="annot"><a href="#local-6989586621679230216"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230217"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230218"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span>
</span><span id="line-212"></span><span>                            </span><span class="annot"><a href="#local-6989586621679230219"><span class="hs-identifier hs-type">resolverError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230212"><span class="hs-identifier hs-type">m</span></a></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-213"></span><span id="nullTracers"><span class="annot"><span class="annottext">nullTracers :: forall (m :: * -&gt; *) ntnAddr ntnVersion ntnVersionData ntcAddr
       ntcVersion ntcVersionData resolverError.
Applicative m =&gt;
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#nullTracers"><span class="hs-identifier hs-var hs-var">nullTracers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-214"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier hs-type">TracersExtra</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-215"></span><span>        </span><span class="annot"><span class="annottext">dtTraceLocalRootPeersTracer :: Tracer m (TraceLocalRootPeers ntnAddr resolverError)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTraceLocalRootPeersTracer"><span class="hs-identifier hs-var">dtTraceLocalRootPeersTracer</span></a></span><span>                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLocalRootPeers ntnAddr resolverError)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-216"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtTracePublicRootPeersTracer :: Tracer m TracePublicRootPeers
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePublicRootPeersTracer"><span class="hs-identifier hs-var">dtTracePublicRootPeersTracer</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m TracePublicRootPeers
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-217"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtTraceLedgerPeersTracer :: Tracer m TraceLedgerPeers
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTraceLedgerPeersTracer"><span class="hs-identifier hs-var">dtTraceLedgerPeersTracer</span></a></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m TraceLedgerPeers
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-218"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtTracePeerSelectionTracer :: Tracer m (TracePeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePeerSelectionTracer"><span class="hs-identifier hs-var">dtTracePeerSelectionTracer</span></a></span><span>                   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TracePeerSelection ntnAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-219"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtDebugPeerSelectionInitiatorTracer :: Tracer m (DebugPeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtDebugPeerSelectionInitiatorTracer"><span class="hs-identifier hs-var">dtDebugPeerSelectionInitiatorTracer</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtDebugPeerSelectionInitiatorResponderTracer :: Tracer m (DebugPeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtDebugPeerSelectionInitiatorResponderTracer"><span class="hs-identifier hs-var">dtDebugPeerSelectionInitiatorResponderTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-221"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtTracePeerSelectionCounters :: Tracer m PeerSelectionCounters
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePeerSelectionCounters"><span class="hs-identifier hs-var">dtTracePeerSelectionCounters</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m PeerSelectionCounters
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtPeerSelectionActionsTracer :: Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtPeerSelectionActionsTracer"><span class="hs-identifier hs-var">dtPeerSelectionActionsTracer</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-223"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtConnectionManagerTracer :: Tracer
  m
  (ConnectionManagerTrace
     ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtConnectionManagerTracer"><span class="hs-identifier hs-var">dtConnectionManagerTracer</span></a></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (ConnectionManagerTrace
     ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-224"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtConnectionManagerTransitionTracer :: Tracer m (AbstractTransitionTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtConnectionManagerTransitionTracer"><span class="hs-identifier hs-var">dtConnectionManagerTransitionTracer</span></a></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (AbstractTransitionTrace ntnAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-225"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtServerTracer :: Tracer m (ServerTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtServerTracer"><span class="hs-identifier hs-var">dtServerTracer</span></a></span><span>                               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace ntnAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtInboundGovernorTracer :: Tracer m (InboundGovernorTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtInboundGovernorTracer"><span class="hs-identifier hs-var">dtInboundGovernorTracer</span></a></span><span>                      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace ntnAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-227"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtInboundGovernorTransitionTracer :: Tracer m (RemoteTransitionTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtInboundGovernorTransitionTracer"><span class="hs-identifier hs-var">dtInboundGovernorTransitionTracer</span></a></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (RemoteTransitionTrace ntnAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-228"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtLocalConnectionManagerTracer :: Tracer
  m
  (ConnectionManagerTrace
     ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalConnectionManagerTracer"><span class="hs-identifier hs-var">dtLocalConnectionManagerTracer</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (ConnectionManagerTrace
     ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-229"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtLocalServerTracer :: Tracer m (ServerTrace ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalServerTracer"><span class="hs-identifier hs-var">dtLocalServerTracer</span></a></span><span>                          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace ntcAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtLocalInboundGovernorTracer :: Tracer m (InboundGovernorTrace ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalInboundGovernorTracer"><span class="hs-identifier hs-var">dtLocalInboundGovernorTracer</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace ntcAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-comment">-- | P2P Arguments Extras</span><span>
</span><span id="line-234"></span><span class="hs-comment">--</span><span>
</span><span id="line-235"></span><span class="hs-keyword">data</span><span> </span><span id="ArgumentsExtra"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ArgumentsExtra"><span class="hs-identifier hs-var">ArgumentsExtra</span></a></span></span><span> </span><span id="local-6989586621679230230"><span class="annot"><a href="#local-6989586621679230230"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ArgumentsExtra"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ArgumentsExtra"><span class="hs-identifier hs-var">ArgumentsExtra</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-comment">-- | selection targets for the peer governor</span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-238"></span><span>      </span><span id="daPeerSelectionTargets"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ArgumentsExtra m -&gt; PeerSelectionTargets
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daPeerSelectionTargets"><span class="hs-identifier hs-var hs-var">daPeerSelectionTargets</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerSelectionTargets"><span class="hs-identifier hs-type">PeerSelectionTargets</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daReadLocalRootPeers"><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ArgumentsExtra m
-&gt; STM
     m [(HotValency, WarmValency, Map RelayAccessPoint PeerAdvertise)]
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReadLocalRootPeers"><span class="hs-identifier hs-var hs-var">daReadLocalRootPeers</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.State.LocalRootPeers.html#HotValency"><span class="hs-identifier hs-type">HotValency</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.State.LocalRootPeers.html#WarmValency"><span class="hs-identifier hs-type">WarmValency</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RelayAccessPoint</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerAdvertise</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daReadPublicRootPeers"><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
ArgumentsExtra m -&gt; STM m (Map RelayAccessPoint PeerAdvertise)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReadPublicRootPeers"><span class="hs-identifier hs-var hs-var">daReadPublicRootPeers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Map.Internal.html#Map"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RelayAccessPoint</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerAdvertise</span></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-comment">-- | Peer's own PeerSharing value.</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-comment">-- This value comes from the node's configuration file and is static.</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daOwnPeerSharing"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ArgumentsExtra m -&gt; PeerSharing
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daOwnPeerSharing"><span class="hs-identifier hs-var hs-var">daOwnPeerSharing</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerSharing</span></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daReadUseLedgerAfter"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ArgumentsExtra m -&gt; STM m UseLedgerAfter
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReadUseLedgerAfter"><span class="hs-identifier hs-var hs-var">daReadUseLedgerAfter</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.Common.html#UseLedgerAfter"><span class="hs-identifier hs-type">UseLedgerAfter</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-comment">-- | Timeout which starts once all responder protocols are idle. If the</span><span>
</span><span id="line-249"></span><span>      </span><span class="hs-comment">-- responders stay idle for duration of the timeout, the connection will</span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-comment">-- be demoted, if it wasn't used by the p2p-governor it will be closed.</span><span>
</span><span id="line-251"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-252"></span><span>      </span><span class="hs-comment">-- Applies to 'Unidirectional' as well as 'Duplex' /node-to-node/</span><span>
</span><span id="line-253"></span><span>      </span><span class="hs-comment">-- connections.</span><span>
</span><span id="line-254"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-255"></span><span>      </span><span class="hs-comment">-- See 'serverProtocolIdleTimeout'.</span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daProtocolIdleTimeout"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daProtocolIdleTimeout"><span class="hs-identifier hs-var hs-var">daProtocolIdleTimeout</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-comment">-- | Time for which /node-to-node/ connections are kept in</span><span>
</span><span id="line-260"></span><span>      </span><span class="hs-comment">-- 'TerminatingState', it should correspond to the OS configured @TCP@</span><span>
</span><span id="line-261"></span><span>      </span><span class="hs-comment">-- @TIME_WAIT@ timeout.</span><span>
</span><span id="line-262"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-263"></span><span>      </span><span class="hs-comment">-- This timeout will apply to after a connection has been closed, its</span><span>
</span><span id="line-264"></span><span>      </span><span class="hs-comment">-- purpose is to be resilient for delayed packets in the same way @TCP@</span><span>
</span><span id="line-265"></span><span>      </span><span class="hs-comment">-- is using @TIME_WAIT@.</span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daTimeWaitTimeout"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daTimeWaitTimeout"><span class="hs-identifier hs-var hs-var">daTimeWaitTimeout</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span>      </span><span class="hs-comment">-- | Churn interval between churn events in deadline mode.  A small fuzz</span><span>
</span><span id="line-270"></span><span>      </span><span class="hs-comment">-- is added (max 10 minutes) so that not all nodes churn at the same time.</span><span>
</span><span id="line-271"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-272"></span><span>      </span><span class="hs-comment">-- By default it is set to 3300 seconds.</span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daDeadlineChurnInterval"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daDeadlineChurnInterval"><span class="hs-identifier hs-var hs-var">daDeadlineChurnInterval</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-comment">-- | Churn interval between churn events in bulk sync mode.  A small fuzz</span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-comment">-- is added (max 1 minute) so that not all nodes churn at the same time.</span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-comment">-- By default it is set to 300 seconds.</span><span>
</span><span id="line-280"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daBulkChurnInterval"><span class="annot"><span class="annottext">forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daBulkChurnInterval"><span class="hs-identifier hs-var hs-var">daBulkChurnInterval</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">--</span><span>
</span><span id="line-285"></span><span class="hs-comment">-- Constants</span><span>
</span><span id="line-286"></span><span class="hs-comment">--</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | Protocol inactivity timeout for local (e.g. /node-to-client/) connections.</span><span>
</span><span id="line-289"></span><span class="hs-comment">--</span><span>
</span><span id="line-290"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#local_PROTOCOL_IDLE_TIMEOUT"><span class="hs-identifier hs-type">local_PROTOCOL_IDLE_TIMEOUT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-291"></span><span id="local_PROTOCOL_IDLE_TIMEOUT"><span class="annot"><span class="annottext">local_PROTOCOL_IDLE_TIMEOUT :: DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#local_PROTOCOL_IDLE_TIMEOUT"><span class="hs-identifier hs-var hs-var">local_PROTOCOL_IDLE_TIMEOUT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">2</span></span><span> </span><span class="hs-comment">-- 2 seconds</span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-comment">-- | Used to set 'cmWaitTimeout' for local (e.g. /node-to-client/) connections.</span><span>
</span><span id="line-294"></span><span class="hs-comment">--</span><span>
</span><span id="line-295"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#local_TIME_WAIT_TIMEOUT"><span class="hs-identifier hs-type">local_TIME_WAIT_TIMEOUT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span>
</span><span id="line-296"></span><span id="local_TIME_WAIT_TIMEOUT"><span class="annot"><span class="annottext">local_TIME_WAIT_TIMEOUT :: DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#local_TIME_WAIT_TIMEOUT"><span class="hs-identifier hs-var hs-var">local_TIME_WAIT_TIMEOUT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#socketAddressType"><span class="hs-identifier hs-type">socketAddressType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddr</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">AddressType</span></span><span>
</span><span id="line-300"></span><span id="socketAddressType"><span class="annot"><span class="annottext">socketAddressType :: SockAddr -&gt; Maybe AddressType
</span><a href="Ouroboros.Network.Diffusion.P2P.html#socketAddressType"><span class="hs-identifier hs-var hs-var">socketAddressType</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddrInet</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddressType -&gt; Maybe AddressType
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><span class="hs-identifier hs-var">IPv4Address</span></span><span>
</span><span id="line-301"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#socketAddressType"><span class="hs-identifier hs-var">socketAddressType</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddrInet6</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AddressType -&gt; Maybe AddressType
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><span class="hs-identifier hs-var">IPv6Address</span></span><span>
</span><span id="line-302"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#socketAddressType"><span class="hs-identifier hs-var">socketAddressType</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.SockAddrUnix</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe AddressType
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-comment">-- | P2P Applications Extras</span><span>
</span><span id="line-306"></span><span class="hs-comment">--</span><span>
</span><span id="line-307"></span><span class="hs-comment">-- TODO: we need initiator only mode for Daedalus, there's no reason why it</span><span>
</span><span id="line-308"></span><span class="hs-comment">-- should run a node-to-node server side.</span><span>
</span><span id="line-309"></span><span class="hs-comment">--</span><span>
</span><span id="line-310"></span><span class="hs-keyword">data</span><span> </span><span id="ApplicationsExtra"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ApplicationsExtra"><span class="hs-identifier hs-var">ApplicationsExtra</span></a></span></span><span> </span><span id="local-6989586621679230253"><span class="annot"><a href="#local-6989586621679230253"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679230254"><span class="annot"><a href="#local-6989586621679230254"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679230255"><span class="annot"><a href="#local-6989586621679230255"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>    </span><span id="ApplicationsExtra"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ApplicationsExtra"><span class="hs-identifier hs-var">ApplicationsExtra</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-comment">-- | /node-to-node/ rethrow policy</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-314"></span><span>      </span><span id="daRethrowPolicy"><span class="annot"><span class="annottext">forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; RethrowPolicy
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daRethrowPolicy"><span class="hs-identifier hs-var hs-var">daRethrowPolicy</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RethrowPolicy</span></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- | /node-to-node/ return policy</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-318"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daReturnPolicy"><span class="annot"><span class="annottext">forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; ReturnPolicy a
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReturnPolicy"><span class="hs-identifier hs-var hs-var">daReturnPolicy</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ExitPolicy.html#ReturnPolicy"><span class="hs-identifier hs-type">ReturnPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230255"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-comment">-- | /node-to-client/ rethrow policy</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daLocalRethrowPolicy"><span class="annot"><span class="annottext">forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; RethrowPolicy
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daLocalRethrowPolicy"><span class="hs-identifier hs-var hs-var">daLocalRethrowPolicy</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RethrowPolicy</span></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">-- | 'PeerMetrics' used by peer selection policy (see</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-comment">-- 'simplePeerSelectionPolicy')</span><span>
</span><span id="line-326"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daPeerMetrics"><span class="annot"><span class="annottext">forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; PeerMetrics m ntnAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daPeerMetrics"><span class="hs-identifier hs-var hs-var">daPeerMetrics</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerMetric.html#PeerMetrics"><span class="hs-identifier hs-type">PeerMetrics</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230254"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230253"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-comment">-- | Used by churn-governor</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daBlockFetchMode"><span class="annot"><span class="annottext">forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; STM m FetchMode
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daBlockFetchMode"><span class="hs-identifier hs-var hs-var">daBlockFetchMode</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230254"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-comment">-- | Used for peer sharing protocol</span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="daPeerSharingRegistry"><span class="annot"><span class="annottext">forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; PeerSharingRegistry ntnAddr m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daPeerSharingRegistry"><span class="hs-identifier hs-var hs-var">daPeerSharingRegistry</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSharing.html#PeerSharingRegistry"><span class="hs-identifier hs-type">PeerSharingRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230253"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230254"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span class="hs-comment">--</span><span>
</span><span id="line-340"></span><span class="hs-comment">-- Node-To-Client type aliases</span><span>
</span><span id="line-341"></span><span class="hs-comment">--</span><span>
</span><span id="line-342"></span><span class="hs-comment">-- Node-To-Client diffusion is only used in 'ResponderMode'.</span><span>
</span><span id="line-343"></span><span class="hs-comment">--</span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToClientHandle"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientHandle"><span class="hs-identifier hs-var">NodeToClientHandle</span></a></span></span><span> </span><span id="local-6989586621679231103"><span class="annot"><a href="#local-6989586621679231103"><span class="hs-identifier hs-type">ntcAddr</span></a></span></span><span> </span><span id="local-6989586621679231104"><span class="annot"><a href="#local-6989586621679231104"><span class="hs-identifier hs-type">versionData</span></a></span></span><span> </span><span id="local-6989586621679231105"><span class="annot"><a href="#local-6989586621679231105"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-346"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">HandleWithMinimalCtx</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderMode</span></span><span> </span><span class="annot"><a href="#local-6989586621679231103"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231104"><span class="hs-identifier hs-type">versionData</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231105"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToClientHandleError"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientHandleError"><span class="hs-identifier hs-var">NodeToClientHandleError</span></a></span></span><span> </span><span id="local-6989586621679231107"><span class="annot"><a href="#local-6989586621679231107"><span class="hs-identifier hs-type">ntcVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">HandleError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponderMode</span></span><span> </span><span class="annot"><a href="#local-6989586621679231107"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToClientConnectionHandler"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientConnectionHandler"><span class="hs-identifier hs-var">NodeToClientConnectionHandler</span></a></span></span><span>
</span><span id="line-352"></span><span>      </span><span id="local-6989586621679231108"><span class="annot"><a href="#local-6989586621679231108"><span class="hs-identifier hs-type">ntcFd</span></a></span></span><span> </span><span id="local-6989586621679231109"><span class="annot"><a href="#local-6989586621679231109"><span class="hs-identifier hs-type">ntcAddr</span></a></span></span><span> </span><span id="local-6989586621679231110"><span class="annot"><a href="#local-6989586621679231110"><span class="hs-identifier hs-type">ntcVersion</span></a></span></span><span> </span><span id="local-6989586621679231111"><span class="annot"><a href="#local-6989586621679231111"><span class="hs-identifier hs-type">ntcVersionData</span></a></span></span><span> </span><span id="local-6989586621679231112"><span class="annot"><a href="#local-6989586621679231112"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ConnectionHandler</span></span><span>
</span><span id="line-354"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ResponderMode</span></span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679231110"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231111"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>      </span><span class="annot"><a href="#local-6989586621679231108"><span class="hs-identifier hs-type">ntcFd</span></a></span><span>
</span><span id="line-357"></span><span>      </span><span class="annot"><a href="#local-6989586621679231109"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientHandle"><span class="hs-identifier hs-type">NodeToClientHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231109"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231111"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231112"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientHandleError"><span class="hs-identifier hs-type">NodeToClientHandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231110"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679231110"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679231111"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>      </span><span class="annot"><a href="#local-6989586621679231112"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToClientConnectionManagerArguments"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientConnectionManagerArguments"><span class="hs-identifier hs-var">NodeToClientConnectionManagerArguments</span></a></span></span><span>
</span><span id="line-364"></span><span>      </span><span id="local-6989586621679231113"><span class="annot"><a href="#local-6989586621679231113"><span class="hs-identifier hs-type">ntcFd</span></a></span></span><span> </span><span id="local-6989586621679231114"><span class="annot"><a href="#local-6989586621679231114"><span class="hs-identifier hs-type">ntcAddr</span></a></span></span><span> </span><span id="local-6989586621679231115"><span class="annot"><a href="#local-6989586621679231115"><span class="hs-identifier hs-type">ntcVersion</span></a></span></span><span> </span><span id="local-6989586621679231116"><span class="annot"><a href="#local-6989586621679231116"><span class="hs-identifier hs-type">ntcVersionData</span></a></span></span><span> </span><span id="local-6989586621679231117"><span class="annot"><a href="#local-6989586621679231117"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ConnectionManagerArguments</span></span><span>
</span><span id="line-366"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679231115"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231116"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>      </span><span class="annot"><a href="#local-6989586621679231113"><span class="hs-identifier hs-type">ntcFd</span></a></span><span>
</span><span id="line-368"></span><span>      </span><span class="annot"><a href="#local-6989586621679231114"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span>
</span><span id="line-369"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientHandle"><span class="hs-identifier hs-type">NodeToClientHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231114"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231116"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231117"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientHandleError"><span class="hs-identifier hs-type">NodeToClientHandleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231115"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>      </span><span class="annot"><a href="#local-6989586621679231115"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span>
</span><span id="line-372"></span><span>      </span><span class="annot"><a href="#local-6989586621679231116"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span>
</span><span id="line-373"></span><span>      </span><span class="annot"><a href="#local-6989586621679231117"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">--</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- Node-To-Node type aliases</span><span>
</span><span id="line-378"></span><span class="hs-comment">--</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- Node-To-Node diffusion runs in either 'InitiatorMode' or 'InitiatorResponderMode'.</span><span>
</span><span id="line-380"></span><span class="hs-comment">--</span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToNodeHandle"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodeHandle"><span class="hs-identifier hs-var">NodeToNodeHandle</span></a></span></span><span>
</span><span id="line-383"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621679231119"><span class="annot"><a href="#local-6989586621679231119"><span class="hs-identifier hs-type">mode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxMode</span></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>       </span><span id="local-6989586621679231120"><span class="annot"><a href="#local-6989586621679231120"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679231121"><span class="annot"><a href="#local-6989586621679231121"><span class="hs-identifier hs-type">ntnVersionData</span></a></span></span><span> </span><span id="local-6989586621679231122"><span class="annot"><a href="#local-6989586621679231122"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679231123"><span class="annot"><a href="#local-6989586621679231123"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679231124"><span class="annot"><a href="#local-6989586621679231124"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">HandleWithExpandedCtx</span></span><span> </span><span class="annot"><a href="#local-6989586621679231119"><span class="hs-identifier hs-type">mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231120"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231121"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231123"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231124"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToNodeConnectionManager"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodeConnectionManager"><span class="hs-identifier hs-var">NodeToNodeConnectionManager</span></a></span></span><span>
</span><span id="line-388"></span><span>       </span><span class="hs-special">(</span><span id="local-6989586621679231126"><span class="annot"><a href="#local-6989586621679231126"><span class="hs-identifier hs-type">mode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxMode</span></span><span class="hs-special">)</span><span>
</span><span id="line-389"></span><span>       </span><span id="local-6989586621679231127"><span class="annot"><a href="#local-6989586621679231127"><span class="hs-identifier hs-type">ntnFd</span></a></span></span><span> </span><span id="local-6989586621679231128"><span class="annot"><a href="#local-6989586621679231128"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679231129"><span class="annot"><a href="#local-6989586621679231129"><span class="hs-identifier hs-type">ntnVersionData</span></a></span></span><span> </span><span id="local-6989586621679231130"><span class="annot"><a href="#local-6989586621679231130"><span class="hs-identifier hs-type">ntnVersion</span></a></span></span><span> </span><span id="local-6989586621679231131"><span class="annot"><a href="#local-6989586621679231131"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679231132"><span class="annot"><a href="#local-6989586621679231132"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679231133"><span class="annot"><a href="#local-6989586621679231133"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-390"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">ConnectionManager</span></span><span>
</span><span id="line-391"></span><span>      </span><span class="annot"><a href="#local-6989586621679231126"><span class="hs-identifier hs-type">mode</span></a></span><span>
</span><span id="line-392"></span><span>      </span><span class="annot"><a href="#local-6989586621679231127"><span class="hs-identifier hs-type">ntnFd</span></a></span><span>
</span><span id="line-393"></span><span>      </span><span class="annot"><a href="#local-6989586621679231128"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-394"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodeHandle"><span class="hs-identifier hs-type">NodeToNodeHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231126"><span class="hs-identifier hs-type">mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231128"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231129"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231131"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231132"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231133"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HandleError</span></span><span> </span><span class="annot"><a href="#local-6989586621679231126"><span class="hs-identifier hs-type">mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231130"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span>      </span><span class="annot"><a href="#local-6989586621679231131"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="hs-comment">--</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- Governor type aliases</span><span>
</span><span id="line-400"></span><span class="hs-comment">--</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToNodePeerConnectionHandle"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodePeerConnectionHandle"><span class="hs-identifier hs-var">NodeToNodePeerConnectionHandle</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679231134"><span class="annot"><a href="#local-6989586621679231134"><span class="hs-identifier hs-type">mode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxMode</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679231135"><span class="annot"><a href="#local-6989586621679231135"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679231136"><span class="annot"><a href="#local-6989586621679231136"><span class="hs-identifier hs-type">ntnVersionData</span></a></span></span><span> </span><span id="local-6989586621679231137"><span class="annot"><a href="#local-6989586621679231137"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679231138"><span class="annot"><a href="#local-6989586621679231138"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679231139"><span class="annot"><a href="#local-6989586621679231139"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerConnectionHandle"><span class="hs-identifier hs-type">PeerConnectionHandle</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span class="annot"><a href="#local-6989586621679231134"><span class="hs-identifier hs-type">mode</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ResponderContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679231135"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>      </span><span class="annot"><a href="#local-6989586621679231135"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-407"></span><span>      </span><span class="annot"><a href="#local-6989586621679231136"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span>
</span><span id="line-408"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><a href="#local-6989586621679231137"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231138"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231139"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-keyword">type</span><span> </span><span id="NodeToNodePeerSelectionActions"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodePeerSelectionActions"><span class="hs-identifier hs-var">NodeToNodePeerSelectionActions</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679231140"><span class="annot"><a href="#local-6989586621679231140"><span class="hs-identifier hs-type">mode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxMode</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679231141"><span class="annot"><a href="#local-6989586621679231141"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679231142"><span class="annot"><a href="#local-6989586621679231142"><span class="hs-identifier hs-type">ntnVersionData</span></a></span></span><span> </span><span id="local-6989586621679231143"><span class="annot"><a href="#local-6989586621679231143"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679231144"><span class="annot"><a href="#local-6989586621679231144"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679231145"><span class="annot"><a href="#local-6989586621679231145"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerSelectionActions"><span class="hs-identifier hs-type">Governor.PeerSelectionActions</span></a></span><span>
</span><span id="line-413"></span><span>      </span><span class="annot"><a href="#local-6989586621679231141"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodePeerConnectionHandle"><span class="hs-identifier hs-type">NodeToNodePeerConnectionHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231140"><span class="hs-identifier hs-type">mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231141"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231142"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231143"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231144"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231145"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>      </span><span class="annot"><a href="#local-6989586621679231143"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span class="hs-keyword">data</span><span> </span><span id="Interfaces"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#Interfaces"><span class="hs-identifier hs-var">Interfaces</span></a></span></span><span> </span><span id="local-6989586621679230280"><span class="annot"><a href="#local-6989586621679230280"><span class="hs-identifier hs-type">ntnFd</span></a></span></span><span> </span><span id="local-6989586621679230281"><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679230282"><span class="annot"><a href="#local-6989586621679230282"><span class="hs-identifier hs-type">ntnVersion</span></a></span></span><span> </span><span id="local-6989586621679230283"><span class="annot"><a href="#local-6989586621679230283"><span class="hs-identifier hs-type">ntnVersionData</span></a></span></span><span>
</span><span id="line-418"></span><span>                </span><span id="local-6989586621679230284"><span class="annot"><a href="#local-6989586621679230284"><span class="hs-identifier hs-type">ntcFd</span></a></span></span><span> </span><span id="local-6989586621679230285"><span class="annot"><a href="#local-6989586621679230285"><span class="hs-identifier hs-type">ntcAddr</span></a></span></span><span> </span><span id="local-6989586621679230286"><span class="annot"><a href="#local-6989586621679230286"><span class="hs-identifier hs-type">ntcVersion</span></a></span></span><span> </span><span id="local-6989586621679230287"><span class="annot"><a href="#local-6989586621679230287"><span class="hs-identifier hs-type">ntcVersionData</span></a></span></span><span>
</span><span id="line-419"></span><span>                </span><span id="local-6989586621679230288"><span class="annot"><a href="#local-6989586621679230288"><span class="hs-identifier hs-type">resolver</span></a></span></span><span> </span><span id="local-6989586621679230289"><span class="annot"><a href="#local-6989586621679230289"><span class="hs-identifier hs-type">resolverError</span></a></span></span><span>
</span><span id="line-420"></span><span>                </span><span id="local-6989586621679230290"><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-421"></span><span>    </span><span id="Interfaces"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#Interfaces"><span class="hs-identifier hs-var">Interfaces</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-comment">-- | node-to-node snocket</span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-424"></span><span>        </span><span id="diNtnSnocket"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; Snocket m ntnFd ntnAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnSnocket"><span class="hs-identifier hs-var hs-var">diNtnSnocket</span></a></span></span><span>
</span><span id="line-425"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Snocket</span></span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230280"><span class="hs-identifier hs-type">ntnFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-426"></span><span>
</span><span id="line-427"></span><span>        </span><span class="hs-comment">-- | node-to-node 'Mx.MakeBearer' callback</span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-429"></span><span>        </span><span id="diNtnBearer"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; MakeBearer m ntnFd
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnBearer"><span class="hs-identifier hs-var hs-var">diNtnBearer</span></a></span></span><span>
</span><span id="line-430"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Mx.MakeBearer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230280"><span class="hs-identifier hs-type">ntnFd</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span>        </span><span class="hs-comment">-- | node-to-node socket configuration</span><span>
</span><span id="line-433"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-434"></span><span>        </span><span id="diNtnConfigureSocket"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnFd -&gt; Maybe ntnAddr -&gt; m ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnConfigureSocket"><span class="hs-identifier hs-var hs-var">diNtnConfigureSocket</span></a></span></span><span>
</span><span id="line-435"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679230280"><span class="hs-identifier hs-type">ntnFd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-436"></span><span>
</span><span id="line-437"></span><span>        </span><span class="hs-comment">-- | node-to-node systemd socket configuration</span><span>
</span><span id="line-438"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-439"></span><span>        </span><span id="diNtnConfigureSystemdSocket"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnFd -&gt; ntnAddr -&gt; m ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnConfigureSystemdSocket"><span class="hs-identifier hs-var hs-var">diNtnConfigureSystemdSocket</span></a></span></span><span>
</span><span id="line-440"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679230280"><span class="hs-identifier hs-type">ntnFd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-comment">-- | node-to-node handshake configuration</span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-444"></span><span>        </span><span id="diNtnHandshakeArguments"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; HandshakeArguments
     (ConnectionId ntnAddr) ntnVersion ntnVersionData m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnHandshakeArguments"><span class="hs-identifier hs-var hs-var">diNtnHandshakeArguments</span></a></span></span><span>
</span><span id="line-445"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HandshakeArguments</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679230282"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230283"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-comment">-- | node-to-node address type</span><span>
</span><span id="line-448"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-449"></span><span>        </span><span id="diNtnAddressType"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnAddr -&gt; Maybe AddressType
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnAddressType"><span class="hs-identifier hs-var hs-var">diNtnAddressType</span></a></span></span><span>
</span><span id="line-450"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">AddressType</span></span><span class="hs-special">,</span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span>        </span><span class="hs-comment">-- | node-to-node data flow used by connection manager to classify</span><span>
</span><span id="line-453"></span><span>        </span><span class="hs-comment">-- negotiated connections</span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-455"></span><span>        </span><span id="diNtnDataFlow"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnVersion -&gt; ntnVersionData -&gt; DataFlow
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnDataFlow"><span class="hs-identifier hs-var hs-var">diNtnDataFlow</span></a></span></span><span>
</span><span id="line-456"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679230282"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230283"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DataFlow</span></span><span class="hs-special">,</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>        </span><span class="hs-comment">-- | remote side peer sharing information used by peer selection governor</span><span>
</span><span id="line-459"></span><span>        </span><span class="hs-comment">-- to decide which peers are available for performing peer sharing</span><span>
</span><span id="line-460"></span><span>        </span><span id="diNtnPeerSharing"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnVersionData -&gt; PeerSharing
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnPeerSharing"><span class="hs-identifier hs-var hs-var">diNtnPeerSharing</span></a></span></span><span>
</span><span id="line-461"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679230283"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerSharing</span></span><span class="hs-special">,</span><span>
</span><span id="line-462"></span><span>
</span><span id="line-463"></span><span>        </span><span class="hs-comment">-- | node-to-node peer address</span><span>
</span><span id="line-464"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-465"></span><span>        </span><span id="diNtnToPeerAddr"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; IP -&gt; PortNumber -&gt; ntnAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnToPeerAddr"><span class="hs-identifier hs-var hs-var">diNtnToPeerAddr</span></a></span></span><span>
</span><span id="line-466"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket.PortNumber</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>        </span><span class="hs-comment">-- | node-to-client snocket</span><span>
</span><span id="line-469"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-470"></span><span>        </span><span id="diNtcSnocket"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; Snocket m ntcFd ntcAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcSnocket"><span class="hs-identifier hs-var hs-var">diNtcSnocket</span></a></span></span><span>
</span><span id="line-471"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Snocket</span></span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230284"><span class="hs-identifier hs-type">ntcFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230285"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>        </span><span class="hs-comment">-- | node-to-client 'Mx.MakeBearer' callback</span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-475"></span><span>        </span><span id="diNtcBearer"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; MakeBearer m ntcFd
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcBearer"><span class="hs-identifier hs-var hs-var">diNtcBearer</span></a></span></span><span>
</span><span id="line-476"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Mx.MakeBearer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230284"><span class="hs-identifier hs-type">ntcFd</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>        </span><span class="hs-comment">-- | node-to-client handshake configuration</span><span>
</span><span id="line-479"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-480"></span><span>        </span><span id="diNtcHandshakeArguments"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; HandshakeArguments
     (ConnectionId ntcAddr) ntcVersion ntcVersionData m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcHandshakeArguments"><span class="hs-identifier hs-var hs-var">diNtcHandshakeArguments</span></a></span></span><span>
</span><span id="line-481"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HandshakeArguments</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionId</span></span><span> </span><span class="annot"><a href="#local-6989586621679230285"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679230286"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230287"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span>        </span><span class="hs-comment">-- | node-to-client file descriptor</span><span>
</span><span id="line-484"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-485"></span><span>        </span><span id="diNtcGetFileDescriptor"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntcFd -&gt; m FileDescriptor
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcGetFileDescriptor"><span class="hs-identifier hs-var hs-var">diNtcGetFileDescriptor</span></a></span></span><span>
</span><span id="line-486"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679230284"><span class="hs-identifier hs-type">ntcFd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FileDescriptor</span></span><span class="hs-special">,</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>        </span><span class="hs-comment">-- | diffusion pseudo random generator. It is split between various</span><span>
</span><span id="line-489"></span><span>        </span><span class="hs-comment">-- components that need randomness, e.g. inbound governor, peer</span><span>
</span><span id="line-490"></span><span>        </span><span class="hs-comment">-- selection, policies, etc.</span><span>
</span><span id="line-491"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-492"></span><span>        </span><span id="diRng"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; StdGen
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diRng"><span class="hs-identifier hs-var hs-var">diRng</span></a></span></span><span>
</span><span id="line-493"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StdGen</span></span><span class="hs-special">,</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span>        </span><span class="annot"><span class="hs-comment">-- | callback which is used to register @SIGUSR1@ signal handler.</span></span><span>
</span><span id="line-496"></span><span>        </span><span id="diInstallSigUSR1Handler"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; forall (mode :: MuxMode) x y.
   NodeToNodeConnectionManager
     mode ntnFd ntnAddr ntnVersionData ntnVersion m x y
   -&gt; m ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diInstallSigUSR1Handler"><span class="hs-identifier hs-var hs-var">diInstallSigUSR1Handler</span></a></span></span><span>
</span><span id="line-497"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679230456"><span class="annot"><a href="#local-6989586621679230456"><span class="hs-identifier hs-type">mode</span></a></span></span><span> </span><span id="local-6989586621679230457"><span class="annot"><a href="#local-6989586621679230457"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679230458"><span class="annot"><a href="#local-6989586621679230458"><span class="hs-identifier hs-type">y</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-498"></span><span>             </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodeConnectionManager"><span class="hs-identifier hs-type">NodeToNodeConnectionManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230456"><span class="hs-identifier hs-type">mode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230280"><span class="hs-identifier hs-type">ntnFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230281"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230283"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230282"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230457"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230458"><span class="hs-identifier hs-type">y</span></a></span><span>
</span><span id="line-499"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>        </span><span class="hs-comment">-- | diffusion dns actions</span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-503"></span><span>        </span><span id="diDnsActions"><span class="annot"><span class="annottext">forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; DNSLookupType -&gt; DNSActions resolver resolverError m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diDnsActions"><span class="hs-identifier hs-var hs-var">diDnsActions</span></a></span></span><span>
</span><span id="line-504"></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#DNSLookupType"><span class="hs-identifier hs-type">DNSLookupType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#DNSActions"><span class="hs-identifier hs-type">DNSActions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230288"><span class="hs-identifier hs-type">resolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230289"><span class="hs-identifier hs-type">resolverError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230290"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-505"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#runM"><span class="hs-identifier hs-type">runM</span></a></span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679230487"><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679230507"><span class="annot"><a href="#local-6989586621679230507"><span class="hs-identifier hs-type">ntnFd</span></a></span></span><span> </span><span id="local-6989586621679230500"><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span></span><span> </span><span id="local-6989586621679230501"><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span></span><span> </span><span id="local-6989586621679230502"><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span></span><span>
</span><span id="line-509"></span><span>                </span><span id="local-6989586621679230508"><span class="annot"><a href="#local-6989586621679230508"><span class="hs-identifier hs-type">ntcFd</span></a></span></span><span> </span><span id="local-6989586621679230503"><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span></span><span> </span><span id="local-6989586621679230504"><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span></span><span> </span><span id="local-6989586621679230509"><span class="annot"><a href="#local-6989586621679230509"><span class="hs-identifier hs-type">ntcVersionData</span></a></span></span><span>
</span><span id="line-510"></span><span>                </span><span id="local-6989586621679230510"><span class="annot"><a href="#local-6989586621679230510"><span class="hs-identifier hs-type">resolver</span></a></span></span><span> </span><span id="local-6989586621679230505"><span class="annot"><a href="#local-6989586621679230505"><span class="hs-identifier hs-type">resolverError</span></a></span></span><span> </span><span id="local-6989586621679230513"><span class="annot"><a href="#local-6989586621679230513"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-511"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Alternative"><span class="hs-identifier hs-type">Alternative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadAsync</span></span><span>       </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-513"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadDelay</span></span><span>       </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-514"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadEvaluate</span></span><span>    </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-515"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.Fix.html#MonadFix"><span class="hs-identifier hs-type">MonadFix</span></a></span><span>         </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-516"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFork</span></span><span>        </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-517"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadLabelledSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-518"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTraceSTM</span></span><span>    </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-519"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span>        </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-520"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTime</span></span><span>        </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-522"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTimer</span></span><span>       </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-523"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMVar</span></span><span>        </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-524"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-525"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span>       </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-526"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-527"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span>
</span><span id="line-528"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span>       </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span>
</span><span id="line-529"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span>
</span><span id="line-530"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span>
</span><span id="line-531"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Typeable.Internal.html#Typeable"><span class="hs-identifier hs-type">Typeable</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span>
</span><span id="line-532"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span>       </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span>
</span><span id="line-533"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-type">Show</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span>
</span><span id="line-534"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span>       </span><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span>
</span><span id="line-535"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230505"><span class="hs-identifier hs-type">resolverError</span></a></span><span>
</span><span id="line-536"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-comment">-- | interfaces</span></span><span>
</span><span id="line-538"></span><span>       </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#Interfaces"><span class="hs-identifier hs-type">Interfaces</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230507"><span class="hs-identifier hs-type">ntnFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span>
</span><span id="line-539"></span><span>                  </span><span class="annot"><a href="#local-6989586621679230508"><span class="hs-identifier hs-type">ntcFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230509"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span>
</span><span id="line-540"></span><span>                  </span><span class="annot"><a href="#local-6989586621679230510"><span class="hs-identifier hs-type">resolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230505"><span class="hs-identifier hs-type">resolverError</span></a></span><span>
</span><span id="line-541"></span><span>                  </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-542"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-comment">-- | tracers</span></span><span>
</span><span id="line-543"></span><span>       </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span>
</span><span id="line-544"></span><span>               </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span>
</span><span id="line-545"></span><span>               </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-comment">-- | p2p tracers</span></span><span>
</span><span id="line-547"></span><span>       </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier hs-type">TracersExtra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span>
</span><span id="line-548"></span><span>                    </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230509"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span>
</span><span id="line-549"></span><span>                    </span><span class="annot"><a href="#local-6989586621679230505"><span class="hs-identifier hs-type">resolverError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-comment">-- | configuration</span></span><span>
</span><span id="line-551"></span><span>       </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Arguments"><span class="hs-identifier hs-type">Arguments</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230507"><span class="hs-identifier hs-type">ntnFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-552"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230508"><span class="hs-identifier hs-type">ntcFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-comment">-- | p2p configuration</span></span><span>
</span><span id="line-554"></span><span>       </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ArgumentsExtra"><span class="hs-identifier hs-type">ArgumentsExtra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-comment">-- | protocol handlers</span></span><span>
</span><span id="line-557"></span><span>       </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Applications"><span class="hs-identifier hs-type">Applications</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span>
</span><span id="line-558"></span><span>                    </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230509"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span>
</span><span id="line-559"></span><span>                    </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230513"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-560"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-comment">-- | p2p protocol handlers</span></span><span>
</span><span id="line-561"></span><span>       </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ApplicationsExtra"><span class="hs-identifier hs-type">ApplicationsExtra</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230513"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-562"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-563"></span><span id="runM"><span class="annot"><span class="annottext">runM :: forall (m :: * -&gt; *) ntnFd ntnAddr ntnVersion ntnVersionData ntcFd
       ntcAddr ntcVersion ntcVersionData resolver resolverError a.
(Alternative (STM m), MonadAsync m, MonadDelay m, MonadEvaluate m,
 MonadFix m, MonadFork m, MonadLabelledSTM m, MonadTraceSTM m,
 MonadMask m, MonadThrow (STM m), MonadTime m, MonadTimer m,
 MonadMVar m, Typeable ntnAddr, Ord ntnAddr, Show ntnAddr,
 Typeable ntnVersion, Ord ntnVersion, Show ntnVersion,
 Show ntnVersionData, Typeable ntcAddr, Ord ntcAddr, Show ntcAddr,
 Ord ntcVersion, Exception resolverError) =&gt;
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; TracersExtra
     ntnAddr
     ntnVersion
     ntnVersionData
     ntcAddr
     ntcVersion
     ntcVersionData
     resolverError
     m
-&gt; Arguments ntnFd ntnAddr ntcFd ntcAddr
-&gt; ArgumentsExtra m
-&gt; Applications
     ntnAddr
     ntnVersion
     ntnVersionData
     ntcAddr
     ntcVersion
     ntcVersionData
     m
     a
-&gt; ApplicationsExtra ntnAddr m a
-&gt; m Void
</span><a href="Ouroboros.Network.Diffusion.P2P.html#runM"><span class="hs-identifier hs-var hs-var">runM</span></a></span></span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#Interfaces"><span class="hs-identifier hs-type">Interfaces</span></a></span><span>
</span><span id="line-564"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679231418"><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr
diNtnSnocket :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; Snocket m ntnFd ntnAddr
diNtnSnocket :: Snocket m ntnFd ntnAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnSnocket"><span class="hs-identifier hs-var hs-var">diNtnSnocket</span></a></span></span><span>
</span><span id="line-565"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231419"><span class="annot"><span class="annottext">MakeBearer m ntnFd
diNtnBearer :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; MakeBearer m ntnFd
diNtnBearer :: MakeBearer m ntnFd
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnBearer"><span class="hs-identifier hs-var hs-var">diNtnBearer</span></a></span></span><span>
</span><span id="line-566"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231420"><span class="annot"><span class="annottext">ntnFd -&gt; Maybe ntnAddr -&gt; m ()
diNtnConfigureSocket :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnFd -&gt; Maybe ntnAddr -&gt; m ()
diNtnConfigureSocket :: ntnFd -&gt; Maybe ntnAddr -&gt; m ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnConfigureSocket"><span class="hs-identifier hs-var hs-var">diNtnConfigureSocket</span></a></span></span><span>
</span><span id="line-567"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231421"><span class="annot"><span class="annottext">ntnFd -&gt; ntnAddr -&gt; m ()
diNtnConfigureSystemdSocket :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnFd -&gt; ntnAddr -&gt; m ()
diNtnConfigureSystemdSocket :: ntnFd -&gt; ntnAddr -&gt; m ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnConfigureSystemdSocket"><span class="hs-identifier hs-var hs-var">diNtnConfigureSystemdSocket</span></a></span></span><span>
</span><span id="line-568"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231422"><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId ntnAddr) ntnVersion ntnVersionData m
diNtnHandshakeArguments :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; HandshakeArguments
     (ConnectionId ntnAddr) ntnVersion ntnVersionData m
diNtnHandshakeArguments :: HandshakeArguments
  (ConnectionId ntnAddr) ntnVersion ntnVersionData m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnHandshakeArguments"><span class="hs-identifier hs-var hs-var">diNtnHandshakeArguments</span></a></span></span><span>
</span><span id="line-569"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231423"><span class="annot"><span class="annottext">ntnAddr -&gt; Maybe AddressType
diNtnAddressType :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnAddr -&gt; Maybe AddressType
diNtnAddressType :: ntnAddr -&gt; Maybe AddressType
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnAddressType"><span class="hs-identifier hs-var hs-var">diNtnAddressType</span></a></span></span><span>
</span><span id="line-570"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231424"><span class="annot"><span class="annottext">ntnVersion -&gt; ntnVersionData -&gt; DataFlow
diNtnDataFlow :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnVersion -&gt; ntnVersionData -&gt; DataFlow
diNtnDataFlow :: ntnVersion -&gt; ntnVersionData -&gt; DataFlow
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnDataFlow"><span class="hs-identifier hs-var hs-var">diNtnDataFlow</span></a></span></span><span>
</span><span id="line-571"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231425"><span class="annot"><span class="annottext">ntnVersionData -&gt; PeerSharing
diNtnPeerSharing :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntnVersionData -&gt; PeerSharing
diNtnPeerSharing :: ntnVersionData -&gt; PeerSharing
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnPeerSharing"><span class="hs-identifier hs-var hs-var">diNtnPeerSharing</span></a></span></span><span>
</span><span id="line-572"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231426"><span class="annot"><span class="annottext">IP -&gt; PortNumber -&gt; ntnAddr
diNtnToPeerAddr :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; IP -&gt; PortNumber -&gt; ntnAddr
diNtnToPeerAddr :: IP -&gt; PortNumber -&gt; ntnAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnToPeerAddr"><span class="hs-identifier hs-var hs-var">diNtnToPeerAddr</span></a></span></span><span>
</span><span id="line-573"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231427"><span class="annot"><span class="annottext">Snocket m ntcFd ntcAddr
diNtcSnocket :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; Snocket m ntcFd ntcAddr
diNtcSnocket :: Snocket m ntcFd ntcAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcSnocket"><span class="hs-identifier hs-var hs-var">diNtcSnocket</span></a></span></span><span>
</span><span id="line-574"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231428"><span class="annot"><span class="annottext">MakeBearer m ntcFd
diNtcBearer :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; MakeBearer m ntcFd
diNtcBearer :: MakeBearer m ntcFd
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcBearer"><span class="hs-identifier hs-var hs-var">diNtcBearer</span></a></span></span><span>
</span><span id="line-575"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231429"><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId ntcAddr) ntcVersion ntcVersionData m
diNtcHandshakeArguments :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; HandshakeArguments
     (ConnectionId ntcAddr) ntcVersion ntcVersionData m
diNtcHandshakeArguments :: HandshakeArguments
  (ConnectionId ntcAddr) ntcVersion ntcVersionData m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcHandshakeArguments"><span class="hs-identifier hs-var hs-var">diNtcHandshakeArguments</span></a></span></span><span>
</span><span id="line-576"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231430"><span class="annot"><span class="annottext">ntcFd -&gt; m FileDescriptor
diNtcGetFileDescriptor :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; ntcFd -&gt; m FileDescriptor
diNtcGetFileDescriptor :: ntcFd -&gt; m FileDescriptor
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcGetFileDescriptor"><span class="hs-identifier hs-var hs-var">diNtcGetFileDescriptor</span></a></span></span><span>
</span><span id="line-577"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231431"><span class="annot"><span class="annottext">StdGen
diRng :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; StdGen
diRng :: StdGen
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diRng"><span class="hs-identifier hs-var hs-var">diRng</span></a></span></span><span>
</span><span id="line-578"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231432"><span class="annot"><span class="annottext">forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode ntnFd ntnAddr ntnVersionData ntnVersion m x y
-&gt; m ()
diInstallSigUSR1Handler :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; forall (mode :: MuxMode) x y.
   NodeToNodeConnectionManager
     mode ntnFd ntnAddr ntnVersionData ntnVersion m x y
   -&gt; m ()
diInstallSigUSR1Handler :: forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode ntnFd ntnAddr ntnVersionData ntnVersion m x y
-&gt; m ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diInstallSigUSR1Handler"><span class="hs-identifier hs-var hs-var">diInstallSigUSR1Handler</span></a></span></span><span>
</span><span id="line-579"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231433"><span class="annot"><span class="annottext">DNSLookupType -&gt; DNSActions resolver resolverError m
diDnsActions :: forall ntnFd ntnAddr ntnVersion ntnVersionData ntcFd ntcAddr
       ntcVersion ntcVersionData resolver resolverError (m :: * -&gt; *).
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; DNSLookupType -&gt; DNSActions resolver resolverError m
diDnsActions :: DNSLookupType -&gt; DNSActions resolver resolverError m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diDnsActions"><span class="hs-identifier hs-var hs-var">diDnsActions</span></a></span></span><span>
</span><span id="line-580"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-581"></span><span>     </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span>
</span><span id="line-582"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679231435"><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntnAddr) MuxTrace)
dtMuxTracer :: Tracer m (WithMuxBearer (ConnectionId ntnAddr) MuxTrace)
dtMuxTracer :: forall ntnAddr ntnVersion ntcAddr ntcVersion (m :: * -&gt; *).
Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; Tracer m (WithMuxBearer (ConnectionId ntnAddr) MuxTrace)
</span><a href="#local-6989586621679231435"><span class="hs-identifier hs-var hs-var">dtMuxTracer</span></a></span></span><span>
</span><span id="line-583"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231437"><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntcAddr) MuxTrace)
dtLocalMuxTracer :: Tracer m (WithMuxBearer (ConnectionId ntcAddr) MuxTrace)
dtLocalMuxTracer :: forall ntnAddr ntnVersion ntcAddr ntcVersion (m :: * -&gt; *).
Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; Tracer m (WithMuxBearer (ConnectionId ntcAddr) MuxTrace)
</span><a href="#local-6989586621679231437"><span class="hs-identifier hs-var hs-var">dtLocalMuxTracer</span></a></span></span><span>
</span><span id="line-584"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">dtDiffusionTracer :: forall ntnAddr ntnVersion ntcAddr ntcVersion (m :: * -&gt; *).
Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; Tracer m (DiffusionTracer ntnAddr ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.Common.html#dtDiffusionTracer"><span class="hs-identifier hs-var">dtDiffusionTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679231440"><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
</span><a href="#local-6989586621679231440"><span class="hs-identifier hs-var">tracer</span></a></span></span><span>
</span><span id="line-585"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-586"></span><span>     </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier hs-type">TracersExtra</span></a></span><span>
</span><span id="line-587"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679231441"><span class="annot"><span class="annottext">Tracer m (TracePeerSelection ntnAddr)
dtTracePeerSelectionTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (TracePeerSelection ntnAddr)
dtTracePeerSelectionTracer :: Tracer m (TracePeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePeerSelectionTracer"><span class="hs-identifier hs-var hs-var">dtTracePeerSelectionTracer</span></a></span></span><span>
</span><span id="line-588"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231442"><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
dtDebugPeerSelectionInitiatorTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (DebugPeerSelection ntnAddr)
dtDebugPeerSelectionInitiatorTracer :: Tracer m (DebugPeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtDebugPeerSelectionInitiatorTracer"><span class="hs-identifier hs-var hs-var">dtDebugPeerSelectionInitiatorTracer</span></a></span></span><span>
</span><span id="line-589"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231443"><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
dtDebugPeerSelectionInitiatorResponderTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (DebugPeerSelection ntnAddr)
dtDebugPeerSelectionInitiatorResponderTracer :: Tracer m (DebugPeerSelection ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtDebugPeerSelectionInitiatorResponderTracer"><span class="hs-identifier hs-var hs-var">dtDebugPeerSelectionInitiatorResponderTracer</span></a></span></span><span>
</span><span id="line-590"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231444"><span class="annot"><span class="annottext">Tracer m PeerSelectionCounters
dtTracePeerSelectionCounters :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m PeerSelectionCounters
dtTracePeerSelectionCounters :: Tracer m PeerSelectionCounters
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePeerSelectionCounters"><span class="hs-identifier hs-var hs-var">dtTracePeerSelectionCounters</span></a></span></span><span>
</span><span id="line-591"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231445"><span class="annot"><span class="annottext">Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
dtPeerSelectionActionsTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
dtPeerSelectionActionsTracer :: Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtPeerSelectionActionsTracer"><span class="hs-identifier hs-var hs-var">dtPeerSelectionActionsTracer</span></a></span></span><span>
</span><span id="line-592"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231446"><span class="annot"><span class="annottext">Tracer m (TraceLocalRootPeers ntnAddr resolverError)
dtTraceLocalRootPeersTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (TraceLocalRootPeers ntnAddr resolverError)
dtTraceLocalRootPeersTracer :: Tracer m (TraceLocalRootPeers ntnAddr resolverError)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTraceLocalRootPeersTracer"><span class="hs-identifier hs-var hs-var">dtTraceLocalRootPeersTracer</span></a></span></span><span>
</span><span id="line-593"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231447"><span class="annot"><span class="annottext">Tracer m TracePublicRootPeers
dtTracePublicRootPeersTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m TracePublicRootPeers
dtTracePublicRootPeersTracer :: Tracer m TracePublicRootPeers
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTracePublicRootPeersTracer"><span class="hs-identifier hs-var hs-var">dtTracePublicRootPeersTracer</span></a></span></span><span>
</span><span id="line-594"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231448"><span class="annot"><span class="annottext">Tracer m TraceLedgerPeers
dtTraceLedgerPeersTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m TraceLedgerPeers
dtTraceLedgerPeersTracer :: Tracer m TraceLedgerPeers
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtTraceLedgerPeersTracer"><span class="hs-identifier hs-var hs-var">dtTraceLedgerPeersTracer</span></a></span></span><span>
</span><span id="line-595"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231449"><span class="annot"><span class="annottext">Tracer
  m
  (ConnectionManagerTrace
     ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
dtConnectionManagerTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer
     m
     (ConnectionManagerTrace
        ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
dtConnectionManagerTracer :: Tracer
  m
  (ConnectionManagerTrace
     ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtConnectionManagerTracer"><span class="hs-identifier hs-var hs-var">dtConnectionManagerTracer</span></a></span></span><span>
</span><span id="line-596"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231450"><span class="annot"><span class="annottext">Tracer m (AbstractTransitionTrace ntnAddr)
dtConnectionManagerTransitionTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (AbstractTransitionTrace ntnAddr)
dtConnectionManagerTransitionTracer :: Tracer m (AbstractTransitionTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtConnectionManagerTransitionTracer"><span class="hs-identifier hs-var hs-var">dtConnectionManagerTransitionTracer</span></a></span></span><span>
</span><span id="line-597"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231451"><span class="annot"><span class="annottext">Tracer m (ServerTrace ntnAddr)
dtServerTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (ServerTrace ntnAddr)
dtServerTracer :: Tracer m (ServerTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtServerTracer"><span class="hs-identifier hs-var hs-var">dtServerTracer</span></a></span></span><span>
</span><span id="line-598"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231452"><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace ntnAddr)
dtInboundGovernorTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (InboundGovernorTrace ntnAddr)
dtInboundGovernorTracer :: Tracer m (InboundGovernorTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtInboundGovernorTracer"><span class="hs-identifier hs-var hs-var">dtInboundGovernorTracer</span></a></span></span><span>
</span><span id="line-599"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231453"><span class="annot"><span class="annottext">Tracer m (RemoteTransitionTrace ntnAddr)
dtInboundGovernorTransitionTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (RemoteTransitionTrace ntnAddr)
dtInboundGovernorTransitionTracer :: Tracer m (RemoteTransitionTrace ntnAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtInboundGovernorTransitionTracer"><span class="hs-identifier hs-var hs-var">dtInboundGovernorTransitionTracer</span></a></span></span><span>
</span><span id="line-600"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231454"><span class="annot"><span class="annottext">Tracer
  m
  (ConnectionManagerTrace
     ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
dtLocalConnectionManagerTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer
     m
     (ConnectionManagerTrace
        ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
dtLocalConnectionManagerTracer :: Tracer
  m
  (ConnectionManagerTrace
     ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalConnectionManagerTracer"><span class="hs-identifier hs-var hs-var">dtLocalConnectionManagerTracer</span></a></span></span><span>
</span><span id="line-601"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231455"><span class="annot"><span class="annottext">Tracer m (ServerTrace ntcAddr)
dtLocalServerTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (ServerTrace ntcAddr)
dtLocalServerTracer :: Tracer m (ServerTrace ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalServerTracer"><span class="hs-identifier hs-var hs-var">dtLocalServerTracer</span></a></span></span><span>
</span><span id="line-602"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231456"><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace ntcAddr)
dtLocalInboundGovernorTracer :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer m (InboundGovernorTrace ntcAddr)
dtLocalInboundGovernorTracer :: Tracer m (InboundGovernorTrace ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtLocalInboundGovernorTracer"><span class="hs-identifier hs-var hs-var">dtLocalInboundGovernorTracer</span></a></span></span><span>
</span><span id="line-603"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-604"></span><span>     </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Arguments"><span class="hs-identifier hs-type">Arguments</span></a></span><span>
</span><span id="line-605"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679231458"><span class="annot"><span class="annottext">Maybe (Either ntnFd ntnAddr)
daIPv4Address :: Maybe (Either ntnFd ntnAddr)
daIPv4Address :: forall ntnFd ntnAddr ntcFd ntcAddr.
Arguments ntnFd ntnAddr ntcFd ntcAddr
-&gt; Maybe (Either ntnFd ntnAddr)
</span><a href="#local-6989586621679231458"><span class="hs-identifier hs-var hs-var">daIPv4Address</span></a></span></span><span>
</span><span id="line-606"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231460"><span class="annot"><span class="annottext">Maybe (Either ntnFd ntnAddr)
daIPv6Address :: Maybe (Either ntnFd ntnAddr)
daIPv6Address :: forall ntnFd ntnAddr ntcFd ntcAddr.
Arguments ntnFd ntnAddr ntcFd ntcAddr
-&gt; Maybe (Either ntnFd ntnAddr)
</span><a href="#local-6989586621679231460"><span class="hs-identifier hs-var hs-var">daIPv6Address</span></a></span></span><span>
</span><span id="line-607"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231462"><span class="annot"><span class="annottext">Maybe (Either ntcFd ntcAddr)
daLocalAddress :: Maybe (Either ntcFd ntcAddr)
daLocalAddress :: forall ntnFd ntnAddr ntcFd ntcAddr.
Arguments ntnFd ntnAddr ntcFd ntcAddr
-&gt; Maybe (Either ntcFd ntcAddr)
</span><a href="#local-6989586621679231462"><span class="hs-identifier hs-var hs-var">daLocalAddress</span></a></span></span><span>
</span><span id="line-608"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231464"><span class="annot"><span class="annottext">AcceptedConnectionsLimit
daAcceptedConnectionsLimit :: AcceptedConnectionsLimit
daAcceptedConnectionsLimit :: forall ntnFd ntnAddr ntcFd ntcAddr.
Arguments ntnFd ntnAddr ntcFd ntcAddr -&gt; AcceptedConnectionsLimit
</span><a href="#local-6989586621679231464"><span class="hs-identifier hs-var hs-var">daAcceptedConnectionsLimit</span></a></span></span><span>
</span><span id="line-609"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">daMode :: forall ntnFd ntnAddr ntcFd ntcAddr.
Arguments ntnFd ntnAddr ntcFd ntcAddr -&gt; DiffusionMode
</span><a href="Ouroboros.Network.Diffusion.Common.html#daMode"><span class="hs-identifier hs-var">daMode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679231467"><span class="annot"><span class="annottext">DiffusionMode
</span><a href="#local-6989586621679231467"><span class="hs-identifier hs-var">diffusionMode</span></a></span></span><span>
</span><span id="line-610"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-611"></span><span>     </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ArgumentsExtra"><span class="hs-identifier hs-type">ArgumentsExtra</span></a></span><span>
</span><span id="line-612"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679231468"><span class="annot"><span class="annottext">PeerSelectionTargets
daPeerSelectionTargets :: forall (m :: * -&gt; *). ArgumentsExtra m -&gt; PeerSelectionTargets
daPeerSelectionTargets :: PeerSelectionTargets
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daPeerSelectionTargets"><span class="hs-identifier hs-var hs-var">daPeerSelectionTargets</span></a></span></span><span>
</span><span id="line-613"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231469"><span class="annot"><span class="annottext">STM
  m [(HotValency, WarmValency, Map RelayAccessPoint PeerAdvertise)]
daReadLocalRootPeers :: forall (m :: * -&gt; *).
ArgumentsExtra m
-&gt; STM
     m [(HotValency, WarmValency, Map RelayAccessPoint PeerAdvertise)]
daReadLocalRootPeers :: STM
  m [(HotValency, WarmValency, Map RelayAccessPoint PeerAdvertise)]
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReadLocalRootPeers"><span class="hs-identifier hs-var hs-var">daReadLocalRootPeers</span></a></span></span><span>
</span><span id="line-614"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231470"><span class="annot"><span class="annottext">STM m (Map RelayAccessPoint PeerAdvertise)
daReadPublicRootPeers :: forall (m :: * -&gt; *).
ArgumentsExtra m -&gt; STM m (Map RelayAccessPoint PeerAdvertise)
daReadPublicRootPeers :: STM m (Map RelayAccessPoint PeerAdvertise)
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReadPublicRootPeers"><span class="hs-identifier hs-var hs-var">daReadPublicRootPeers</span></a></span></span><span>
</span><span id="line-615"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231471"><span class="annot"><span class="annottext">PeerSharing
daOwnPeerSharing :: forall (m :: * -&gt; *). ArgumentsExtra m -&gt; PeerSharing
daOwnPeerSharing :: PeerSharing
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daOwnPeerSharing"><span class="hs-identifier hs-var hs-var">daOwnPeerSharing</span></a></span></span><span>
</span><span id="line-616"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231472"><span class="annot"><span class="annottext">STM m UseLedgerAfter
daReadUseLedgerAfter :: forall (m :: * -&gt; *). ArgumentsExtra m -&gt; STM m UseLedgerAfter
daReadUseLedgerAfter :: STM m UseLedgerAfter
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReadUseLedgerAfter"><span class="hs-identifier hs-var hs-var">daReadUseLedgerAfter</span></a></span></span><span>
</span><span id="line-617"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231473"><span class="annot"><span class="annottext">DiffTime
daProtocolIdleTimeout :: forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
daProtocolIdleTimeout :: DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daProtocolIdleTimeout"><span class="hs-identifier hs-var hs-var">daProtocolIdleTimeout</span></a></span></span><span>
</span><span id="line-618"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231474"><span class="annot"><span class="annottext">DiffTime
daTimeWaitTimeout :: forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
daTimeWaitTimeout :: DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daTimeWaitTimeout"><span class="hs-identifier hs-var hs-var">daTimeWaitTimeout</span></a></span></span><span>
</span><span id="line-619"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231475"><span class="annot"><span class="annottext">DiffTime
daDeadlineChurnInterval :: forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
daDeadlineChurnInterval :: DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daDeadlineChurnInterval"><span class="hs-identifier hs-var hs-var">daDeadlineChurnInterval</span></a></span></span><span>
</span><span id="line-620"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231476"><span class="annot"><span class="annottext">DiffTime
daBulkChurnInterval :: forall (m :: * -&gt; *). ArgumentsExtra m -&gt; DiffTime
daBulkChurnInterval :: DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daBulkChurnInterval"><span class="hs-identifier hs-var hs-var">daBulkChurnInterval</span></a></span></span><span>
</span><span id="line-621"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-622"></span><span>     </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Applications"><span class="hs-identifier hs-type">Applications</span></a></span><span>
</span><span id="line-623"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679231478"><span class="annot"><span class="annottext">Versions
  ntnVersion
  ntnVersionData
  (OuroborosBundleWithExpandedCtx
     'InitiatorMode ntnAddr ByteString m a Void)
daApplicationInitiatorMode :: Versions
  ntnVersion
  ntnVersionData
  (OuroborosBundleWithExpandedCtx
     'InitiatorMode ntnAddr ByteString m a Void)
daApplicationInitiatorMode :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData (m :: * -&gt; *) a.
Applications
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  m
  a
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundleWithExpandedCtx
        'InitiatorMode ntnAddr ByteString m a Void)
</span><a href="#local-6989586621679231478"><span class="hs-identifier hs-var hs-var">daApplicationInitiatorMode</span></a></span></span><span>
</span><span id="line-624"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231480"><span class="annot"><span class="annottext">(PeerSharingAmount -&gt; m [ntnAddr])
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundleWithExpandedCtx
        'InitiatorResponderMode ntnAddr ByteString m a ())
daApplicationInitiatorResponderMode :: (PeerSharingAmount -&gt; m [ntnAddr])
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundleWithExpandedCtx
        'InitiatorResponderMode ntnAddr ByteString m a ())
daApplicationInitiatorResponderMode :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData (m :: * -&gt; *) a.
Applications
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  m
  a
-&gt; (PeerSharingAmount -&gt; m [ntnAddr])
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundleWithExpandedCtx
        'InitiatorResponderMode ntnAddr ByteString m a ())
</span><a href="#local-6989586621679231480"><span class="hs-identifier hs-var hs-var">daApplicationInitiatorResponderMode</span></a></span></span><span>
</span><span id="line-625"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231482"><span class="annot"><span class="annottext">Versions
  ntcVersion
  ntcVersionData
  (OuroborosApplicationWithMinimalCtx
     'ResponderMode ntcAddr ByteString m Void ())
daLocalResponderApplication :: Versions
  ntcVersion
  ntcVersionData
  (OuroborosApplicationWithMinimalCtx
     'ResponderMode ntcAddr ByteString m Void ())
daLocalResponderApplication :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData (m :: * -&gt; *) a.
Applications
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  m
  a
-&gt; Versions
     ntcVersion
     ntcVersionData
     (OuroborosApplicationWithMinimalCtx
        'ResponderMode ntcAddr ByteString m Void ())
</span><a href="#local-6989586621679231482"><span class="hs-identifier hs-var hs-var">daLocalResponderApplication</span></a></span></span><span>
</span><span id="line-626"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231484"><span class="annot"><span class="annottext">LedgerPeersConsensusInterface m
daLedgerPeersCtx :: LedgerPeersConsensusInterface m
daLedgerPeersCtx :: forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData (m :: * -&gt; *) a.
Applications
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  m
  a
-&gt; LedgerPeersConsensusInterface m
</span><a href="#local-6989586621679231484"><span class="hs-identifier hs-var hs-var">daLedgerPeersCtx</span></a></span></span><span>
</span><span id="line-627"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-628"></span><span>     </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ApplicationsExtra"><span class="hs-identifier hs-type">ApplicationsExtra</span></a></span><span>
</span><span id="line-629"></span><span>       </span><span class="hs-special">{</span><span> </span><span id="local-6989586621679231486"><span class="annot"><span class="annottext">RethrowPolicy
daRethrowPolicy :: forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; RethrowPolicy
daRethrowPolicy :: RethrowPolicy
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daRethrowPolicy"><span class="hs-identifier hs-var hs-var">daRethrowPolicy</span></a></span></span><span>
</span><span id="line-630"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231487"><span class="annot"><span class="annottext">RethrowPolicy
daLocalRethrowPolicy :: forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; RethrowPolicy
daLocalRethrowPolicy :: RethrowPolicy
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daLocalRethrowPolicy"><span class="hs-identifier hs-var hs-var">daLocalRethrowPolicy</span></a></span></span><span>
</span><span id="line-631"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231488"><span class="annot"><span class="annottext">ReturnPolicy a
daReturnPolicy :: forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; ReturnPolicy a
daReturnPolicy :: ReturnPolicy a
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daReturnPolicy"><span class="hs-identifier hs-var hs-var">daReturnPolicy</span></a></span></span><span>
</span><span id="line-632"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231489"><span class="annot"><span class="annottext">PeerMetrics m ntnAddr
daPeerMetrics :: forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; PeerMetrics m ntnAddr
daPeerMetrics :: PeerMetrics m ntnAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daPeerMetrics"><span class="hs-identifier hs-var hs-var">daPeerMetrics</span></a></span></span><span>
</span><span id="line-633"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231490"><span class="annot"><span class="annottext">STM m FetchMode
daBlockFetchMode :: forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; STM m FetchMode
daBlockFetchMode :: STM m FetchMode
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daBlockFetchMode"><span class="hs-identifier hs-var hs-var">daBlockFetchMode</span></a></span></span><span>
</span><span id="line-634"></span><span>       </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231491"><span class="annot"><span class="annottext">PeerSharingRegistry ntnAddr m
daPeerSharingRegistry :: forall ntnAddr (m :: * -&gt; *) a.
ApplicationsExtra ntnAddr m a -&gt; PeerSharingRegistry ntnAddr m
daPeerSharingRegistry :: PeerSharingRegistry ntnAddr m
</span><a href="Ouroboros.Network.Diffusion.P2P.html#daPeerSharingRegistry"><span class="hs-identifier hs-var hs-var">daPeerSharingRegistry</span></a></span></span><span>
</span><span id="line-635"></span><span>       </span><span class="hs-special">}</span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-comment">-- Thread to which 'RethrowPolicy' will throw fatal exceptions.</span><span>
</span><span id="line-638"></span><span>    </span><span id="local-6989586621679231492"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679231492"><span class="hs-identifier hs-var">mainThreadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ThreadId m)
forall (m :: * -&gt; *). MonadThread m =&gt; m (ThreadId m)
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span>    </span><span class="annot"><span class="annottext">Concurrently m Void -&gt; m Void
forall (m :: * -&gt; *) a. Concurrently m a -&gt; m a
</span><span class="hs-identifier hs-var">Async.runConcurrently</span></span><span>
</span><span id="line-641"></span><span>      </span><span class="annot"><span class="annottext">(Concurrently m Void -&gt; m Void) -&gt; Concurrently m Void -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Concurrently m Void] -&gt; Concurrently m Void
forall (t :: * -&gt; *) (f :: * -&gt; *) a.
(Foldable t, Alternative f) =&gt;
t (f a) -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#asum"><span class="hs-identifier hs-var">asum</span></a></span><span>
</span><span id="line-642"></span><span>      </span><span class="annot"><span class="annottext">([Concurrently m Void] -&gt; Concurrently m Void)
-&gt; [Concurrently m Void] -&gt; Concurrently m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">m Void -&gt; Concurrently m Void
forall (m :: * -&gt; *) a. m a -&gt; Concurrently m a
</span><span class="hs-identifier hs-var">Async.Concurrently</span></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; Concurrently m Void)
-&gt; [m Void] -&gt; [Concurrently m Void]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-643"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ThreadId m -&gt; m Void
</span><a href="#local-6989586621679231497"><span class="hs-identifier hs-var">mkRemoteThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679231492"><span class="hs-identifier hs-var">mainThreadId</span></a></span><span>
</span><span id="line-644"></span><span>          </span><span class="annot"><span class="annottext">m Void -&gt; [m Void] -&gt; [m Void]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (m Void) -&gt; [m Void]
forall a. Maybe a -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#maybeToList"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId m -&gt; Either ntcFd ntcAddr -&gt; m Void
</span><a href="#local-6989586621679231498"><span class="hs-identifier hs-var">mkLocalThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679231492"><span class="hs-identifier hs-var">mainThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ntcFd ntcAddr -&gt; m Void)
-&gt; Maybe (Either ntcFd ntcAddr) -&gt; Maybe (m Void)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Either ntcFd ntcAddr)
</span><a href="#local-6989586621679231462"><span class="hs-identifier hs-var">daLocalAddress</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-645"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-646"></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-648"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679231499"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231499"><span class="hs-identifier hs-var">ledgerPeersRng</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231500"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231500"><span class="hs-identifier hs-var">rng1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; (StdGen, StdGen)
forall g. RandomGen g =&gt; g -&gt; (g, g)
</span><span class="hs-identifier hs-var">split</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231431"><span class="hs-identifier hs-var">diRng</span></a></span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679231501"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231501"><span class="hs-identifier hs-var">policyRng</span></a></span></span><span class="hs-special">,</span><span>      </span><span id="local-6989586621679231502"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231502"><span class="hs-identifier hs-var">rng2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; (StdGen, StdGen)
forall g. RandomGen g =&gt; g -&gt; (g, g)
</span><span class="hs-identifier hs-var">split</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231500"><span class="hs-identifier hs-var">rng1</span></a></span><span>
</span><span id="line-650"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679231503"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231503"><span class="hs-identifier hs-var">churnRng</span></a></span></span><span class="hs-special">,</span><span>       </span><span id="local-6989586621679231504"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231504"><span class="hs-identifier hs-var">rng3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; (StdGen, StdGen)
forall g. RandomGen g =&gt; g -&gt; (g, g)
</span><span class="hs-identifier hs-var">split</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231502"><span class="hs-identifier hs-var">rng2</span></a></span><span>
</span><span id="line-651"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679231505"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231505"><span class="hs-identifier hs-var">fuzzRng</span></a></span></span><span class="hs-special">,</span><span>        </span><span id="local-6989586621679231506"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231506"><span class="hs-identifier hs-var">rng4</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; (StdGen, StdGen)
forall g. RandomGen g =&gt; g -&gt; (g, g)
</span><span class="hs-identifier hs-var">split</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231504"><span class="hs-identifier hs-var">rng3</span></a></span><span>
</span><span id="line-652"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679231507"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231507"><span class="hs-identifier hs-var">ntnInbgovRng</span></a></span></span><span class="hs-special">,</span><span>   </span><span id="local-6989586621679231508"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231508"><span class="hs-identifier hs-var">rng5</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; (StdGen, StdGen)
forall g. RandomGen g =&gt; g -&gt; (g, g)
</span><span class="hs-identifier hs-var">split</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231506"><span class="hs-identifier hs-var">rng4</span></a></span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679231509"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231509"><span class="hs-identifier hs-var">ntcInbgovRng</span></a></span></span><span class="hs-special">,</span><span>   </span><span id="local-6989586621679231510"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231510"><span class="hs-identifier hs-var">peerSharingRng</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; (StdGen, StdGen)
forall g. RandomGen g =&gt; g -&gt; (g, g)
</span><span class="hs-identifier hs-var">split</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231508"><span class="hs-identifier hs-var">rng5</span></a></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span>    </span><span class="hs-comment">-- Only the 'IOManagerError's are fatal, all the other exceptions in the</span><span>
</span><span id="line-656"></span><span>    </span><span class="hs-comment">-- networking code will only shutdown the bearer (see 'ShutdownPeer' why</span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-comment">-- this is so).</span><span>
</span><span id="line-658"></span><span>    </span><span id="local-6989586621679231515"><span class="annot"><span class="annottext">rethrowPolicy :: RethrowPolicy
</span><a href="#local-6989586621679231515"><span class="hs-identifier hs-var hs-var">rethrowPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-659"></span><span>      </span><span class="annot"><span class="annottext">RethrowPolicy_ -&gt; RethrowPolicy
</span><span class="hs-identifier hs-var">RethrowPolicy</span></span><span> </span><span class="annot"><span class="annottext">(RethrowPolicy_ -&gt; RethrowPolicy)
-&gt; RethrowPolicy_ -&gt; RethrowPolicy
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231517"><span class="annot"><span class="annottext">ErrorContext
</span><a href="#local-6989586621679231517"><span class="hs-identifier hs-var">_ctx</span></a></span></span><span> </span><span id="local-6989586621679231518"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231518"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-660"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe Void
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#fromException"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231518"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-661"></span><span>          </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Void
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOManagerError</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrorCommand
</span><span class="hs-identifier hs-var">ShutdownNode</span></span><span>
</span><span id="line-662"></span><span>          </span><span class="annot"><span class="annottext">Maybe Void
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrorCommand
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-663"></span><span>
</span><span id="line-664"></span><span>
</span><span id="line-665"></span><span>    </span><span class="hs-comment">-- | mkLocalThread - create local connection manager</span><span>
</span><span id="line-666"></span><span>
</span><span id="line-667"></span><span>    </span><span class="annot"><a href="#local-6989586621679231498"><span class="hs-identifier hs-type">mkLocalThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230508"><span class="hs-identifier hs-type">ntcFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-668"></span><span>    </span><span id="local-6989586621679231498"><span class="annot"><span class="annottext">mkLocalThread :: ThreadId m -&gt; Either ntcFd ntcAddr -&gt; m Void
</span><a href="#local-6989586621679231498"><span class="hs-identifier hs-var hs-var">mkLocalThread</span></a></span></span><span> </span><span id="local-6989586621679231522"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679231522"><span class="hs-identifier hs-var">mainThreadId</span></a></span></span><span> </span><span id="local-6989586621679231523"><span class="annot"><span class="annottext">Either ntcFd ntcAddr
</span><a href="#local-6989586621679231523"><span class="hs-identifier hs-var">localAddr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-669"></span><span>      </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
-&gt; (ntcFd -&gt; m FileDescriptor)
-&gt; Snocket m ntcFd ntcAddr
-&gt; Either ntcFd ntcAddr
-&gt; (ntcFd -&gt; m Void)
-&gt; m Void
forall ntnAddr ntcFd ntcAddr (m :: * -&gt; *) a.
(MonadThrow m, Typeable ntnAddr, Show ntnAddr) =&gt;
Tracer m (DiffusionTracer ntnAddr ntcAddr)
-&gt; (ntcFd -&gt; m FileDescriptor)
-&gt; Snocket m ntcFd ntcAddr
-&gt; Either ntcFd ntcAddr
-&gt; (ntcFd -&gt; m a)
-&gt; m a
</span><a href="Ouroboros.Network.Diffusion.Utils.html#withLocalSocket"><span class="hs-identifier hs-var">withLocalSocket</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
</span><a href="#local-6989586621679231440"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">ntcFd -&gt; m FileDescriptor
</span><a href="#local-6989586621679231430"><span class="hs-identifier hs-var">diNtcGetFileDescriptor</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m ntcFd ntcAddr
</span><a href="#local-6989586621679231427"><span class="hs-identifier hs-var">diNtcSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">Either ntcFd ntcAddr
</span><a href="#local-6989586621679231523"><span class="hs-identifier hs-var">localAddr</span></a></span><span>
</span><span id="line-670"></span><span>      </span><span class="annot"><span class="annottext">((ntcFd -&gt; m Void) -&gt; m Void) -&gt; (ntcFd -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231525"><span class="annot"><span class="annottext">ntcFd
</span><a href="#local-6989586621679231525"><span class="hs-identifier hs-var">localSocket</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-671"></span><span>        </span><span id="local-6989586621679231526"><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
  m
</span><a href="#local-6989586621679231526"><span class="hs-identifier hs-var">localInbInfoChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (InformationChannel
     (NewConnectionInfo
        ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
     m)
forall a (m :: * -&gt; *).
MonadLabelledSTM m =&gt;
m (InformationChannel a m)
</span><span class="hs-identifier hs-var">newInformationChannel</span></span><span>
</span><span id="line-672"></span><span>        </span><span id="local-6989586621679231527"><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231527"><span class="hs-identifier hs-var">localServerStateVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; m (StrictTVar m InboundGovernorObservableState)
forall (m :: * -&gt; *).
MonadLabelledSTM m =&gt;
StdGen -&gt; m (StrictTVar m InboundGovernorObservableState)
</span><span class="hs-identifier hs-var">Server.newObservableStateVar</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231509"><span class="hs-identifier hs-var">ntcInbgovRng</span></a></span><span>
</span><span id="line-673"></span><span>
</span><span id="line-674"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679231533"><span class="annot"><span class="annottext">localConnectionLimits :: AcceptedConnectionsLimit
</span><a href="#local-6989586621679231533"><span class="hs-identifier hs-var hs-var">localConnectionLimits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; DiffTime -&gt; AcceptedConnectionsLimit
</span><span class="hs-identifier hs-var">AcceptedConnectionsLimit</span></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Bounded a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Bounded a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Enum.html#maxBound"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span>            </span><span class="annot"><a href="#local-6989586621679231536"><span class="hs-identifier hs-type">localConnectionHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientConnectionHandler"><span class="hs-identifier hs-type">NodeToClientConnectionHandler</span></a></span><span>
</span><span id="line-677"></span><span>                                        </span><span class="annot"><a href="#local-6989586621679230508"><span class="hs-identifier hs-type">ntcFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230509"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-678"></span><span>            </span><span id="local-6989586621679231536"><span class="annot"><span class="annottext">localConnectionHandler :: NodeToClientConnectionHandler
  ntcFd ntcAddr ntcVersion ntcVersionData m
</span><a href="#local-6989586621679231536"><span class="hs-identifier hs-var hs-var">localConnectionHandler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-679"></span><span>              </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntcAddr) MuxTrace)
-&gt; SingMuxMode 'ResponderMode
-&gt; HandshakeArguments
     (ConnectionId ntcAddr) ntcVersion ntcVersionData m
-&gt; Versions
     ntcVersion
     ntcVersionData
     (OuroborosBundle
        'ResponderMode
        (MinimalInitiatorContext ntcAddr)
        (ResponderContext ntcAddr)
        ByteString
        m
        Void
        ())
-&gt; (ThreadId m, RethrowPolicy)
-&gt; NodeToClientConnectionHandler
     ntcFd ntcAddr ntcVersion ntcVersionData m
forall initiatorCtx responderCtx peerAddr (muxMode :: MuxMode)
       socket versionNumber versionData (m :: * -&gt; *) a b.
(Alternative (STM m), MonadAsync m, MonadDelay m, MonadFork m,
 MonadLabelledSTM m, MonadThrow (STM m), MonadTimer m, MonadMask m,
 Ord versionNumber, Show peerAddr, Typeable peerAddr) =&gt;
Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; SingMuxMode muxMode
-&gt; HandshakeArguments
     (ConnectionId peerAddr) versionNumber versionData m
-&gt; Versions
     versionNumber
     versionData
     (OuroborosBundle
        muxMode initiatorCtx responderCtx ByteString m a b)
-&gt; (ThreadId m, RethrowPolicy)
-&gt; MuxConnectionHandler
     muxMode
     socket
     initiatorCtx
     responderCtx
     peerAddr
     versionNumber
     versionData
     ByteString
     m
     a
     b
</span><span class="hs-identifier hs-var">makeConnectionHandler</span></span><span>
</span><span id="line-680"></span><span>                </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntcAddr) MuxTrace)
</span><a href="#local-6989586621679231437"><span class="hs-identifier hs-var">dtLocalMuxTracer</span></a></span><span>
</span><span id="line-681"></span><span>                </span><span class="annot"><span class="annottext">SingMuxMode 'ResponderMode
</span><span class="hs-identifier hs-var">SingResponderMode</span></span><span>
</span><span id="line-682"></span><span>                </span><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId ntcAddr) ntcVersion ntcVersionData m
</span><a href="#local-6989586621679231429"><span class="hs-identifier hs-var">diNtcHandshakeArguments</span></a></span><span>
</span><span id="line-683"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OuroborosApplication</span></span><span> </span><span id="local-6989586621679231540"><span class="annot"><span class="annottext">[MiniProtocol
   'ResponderMode
   (MinimalInitiatorContext ntcAddr)
   (ResponderContext ntcAddr)
   ByteString
   m
   Void
   ()]
</span><a href="#local-6989586621679231540"><span class="hs-identifier hs-var">apps</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WithProtocolTemperature
  'Hot
  [MiniProtocol
     'ResponderMode
     (MinimalInitiatorContext ntcAddr)
     (ResponderContext ntcAddr)
     ByteString
     m
     Void
     ()]
-&gt; WithProtocolTemperature
     'Warm
     [MiniProtocol
        'ResponderMode
        (MinimalInitiatorContext ntcAddr)
        (ResponderContext ntcAddr)
        ByteString
        m
        Void
        ()]
-&gt; WithProtocolTemperature
     'Established
     [MiniProtocol
        'ResponderMode
        (MinimalInitiatorContext ntcAddr)
        (ResponderContext ntcAddr)
        ByteString
        m
        Void
        ()]
-&gt; OuroborosBundle
     'ResponderMode
     (MinimalInitiatorContext ntcAddr)
     (ResponderContext ntcAddr)
     ByteString
     m
     Void
     ()
forall a.
WithProtocolTemperature 'Hot a
-&gt; WithProtocolTemperature 'Warm a
-&gt; WithProtocolTemperature 'Established a
-&gt; TemperatureBundle a
</span><span class="hs-identifier hs-var">TemperatureBundle</span></span><span>
</span><span id="line-685"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MiniProtocol
   'ResponderMode
   (MinimalInitiatorContext ntcAddr)
   (ResponderContext ntcAddr)
   ByteString
   m
   Void
   ()]
-&gt; WithProtocolTemperature
     'Hot
     [MiniProtocol
        'ResponderMode
        (MinimalInitiatorContext ntcAddr)
        (ResponderContext ntcAddr)
        ByteString
        m
        Void
        ()]
forall a. a -&gt; WithProtocolTemperature 'Hot a
</span><span class="hs-identifier hs-var">WithHot</span></span><span> </span><span class="annot"><span class="annottext">[MiniProtocol
   'ResponderMode
   (MinimalInitiatorContext ntcAddr)
   (ResponderContext ntcAddr)
   ByteString
   m
   Void
   ()]
</span><a href="#local-6989586621679231540"><span class="hs-identifier hs-var">apps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MiniProtocol
   'ResponderMode
   (MinimalInitiatorContext ntcAddr)
   (ResponderContext ntcAddr)
   ByteString
   m
   Void
   ()]
-&gt; WithProtocolTemperature
     'Warm
     [MiniProtocol
        'ResponderMode
        (MinimalInitiatorContext ntcAddr)
        (ResponderContext ntcAddr)
        ByteString
        m
        Void
        ()]
forall a. a -&gt; WithProtocolTemperature 'Warm a
</span><span class="hs-identifier hs-var">WithWarm</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-687"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MiniProtocol
   'ResponderMode
   (MinimalInitiatorContext ntcAddr)
   (ResponderContext ntcAddr)
   ByteString
   m
   Void
   ()]
-&gt; WithProtocolTemperature
     'Established
     [MiniProtocol
        'ResponderMode
        (MinimalInitiatorContext ntcAddr)
        (ResponderContext ntcAddr)
        ByteString
        m
        Void
        ()]
forall a. a -&gt; WithProtocolTemperature 'Established a
</span><span class="hs-identifier hs-var">WithEstablished</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-688"></span><span>                  </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OuroborosApplicationWithMinimalCtx
   'ResponderMode ntcAddr ByteString m Void ()
 -&gt; OuroborosBundle
      'ResponderMode
      (MinimalInitiatorContext ntcAddr)
      (ResponderContext ntcAddr)
      ByteString
      m
      Void
      ())
-&gt; Versions
     ntcVersion
     ntcVersionData
     (OuroborosApplicationWithMinimalCtx
        'ResponderMode ntcAddr ByteString m Void ())
-&gt; Versions
     ntcVersion
     ntcVersionData
     (OuroborosBundle
        'ResponderMode
        (MinimalInitiatorContext ntcAddr)
        (ResponderContext ntcAddr)
        ByteString
        m
        Void
        ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Versions
  ntcVersion
  ntcVersionData
  (OuroborosApplicationWithMinimalCtx
     'ResponderMode ntcAddr ByteString m Void ())
</span><a href="#local-6989586621679231482"><span class="hs-identifier hs-var">daLocalResponderApplication</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679231522"><span class="hs-identifier hs-var">mainThreadId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RethrowPolicy
</span><a href="#local-6989586621679231515"><span class="hs-identifier hs-var">rethrowPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">RethrowPolicy -&gt; RethrowPolicy -&gt; RethrowPolicy
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RethrowPolicy
</span><a href="#local-6989586621679231487"><span class="hs-identifier hs-var">daLocalRethrowPolicy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>
</span><span id="line-691"></span><span>            </span><span class="annot"><a href="#local-6989586621679231545"><span class="hs-identifier hs-type">localConnectionManagerArguments</span></a></span><span>
</span><span id="line-692"></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToClientConnectionManagerArguments"><span class="hs-identifier hs-type">NodeToClientConnectionManagerArguments</span></a></span><span>
</span><span id="line-693"></span><span>                   </span><span class="annot"><a href="#local-6989586621679230508"><span class="hs-identifier hs-type">ntcFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230503"><span class="hs-identifier hs-type">ntcAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230504"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230509"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-694"></span><span>            </span><span id="local-6989586621679231545"><span class="annot"><span class="annottext">localConnectionManagerArguments :: NodeToClientConnectionManagerArguments
  ntcFd ntcAddr ntcVersion ntcVersionData m
</span><a href="#local-6989586621679231545"><span class="hs-identifier hs-var hs-var">localConnectionManagerArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-695"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">ConnectionManagerArguments</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-696"></span><span>                  </span><span class="annot"><span class="annottext">cmTracer :: Tracer
  m
  (ConnectionManagerTrace
     ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
</span><span class="hs-identifier hs-var">cmTracer</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (ConnectionManagerTrace
     ntcAddr (ConnectionHandlerTrace ntcVersion ntcVersionData))
</span><a href="#local-6989586621679231454"><span class="hs-identifier hs-var">dtLocalConnectionManagerTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-697"></span><span>                  </span><span class="annot"><span class="annottext">cmTrTracer :: Tracer
  m
  (TransitionTrace
     ntcAddr
     (ConnectionState
        ntcAddr
        (NodeToClientHandle ntcAddr ntcVersionData m)
        (NodeToClientHandleError ntcVersion)
        ntcVersion
        m))
</span><span class="hs-identifier hs-var">cmTrTracer</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (TransitionTrace
     ntcAddr
     (ConnectionState
        ntcAddr
        (NodeToClientHandle ntcAddr ntcVersionData m)
        (NodeToClientHandleError ntcVersion)
        ntcVersion
        m))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- TODO: issue #3320</span><span>
</span><span id="line-698"></span><span>                  </span><span class="annot"><span class="annottext">cmMuxTracer :: Tracer m (WithMuxBearer (ConnectionId ntcAddr) MuxTrace)
</span><span class="hs-identifier hs-var">cmMuxTracer</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntcAddr) MuxTrace)
</span><a href="#local-6989586621679231437"><span class="hs-identifier hs-var">dtLocalMuxTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-699"></span><span>                  </span><span class="annot"><span class="annottext">cmIPv4Address :: Maybe ntcAddr
</span><span class="hs-identifier hs-var">cmIPv4Address</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ntcAddr
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-700"></span><span>                  </span><span class="annot"><span class="annottext">cmIPv6Address :: Maybe ntcAddr
</span><span class="hs-identifier hs-var">cmIPv6Address</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ntcAddr
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-701"></span><span>                  </span><span class="annot"><span class="annottext">cmAddressType :: ntcAddr -&gt; Maybe AddressType
</span><span class="hs-identifier hs-var">cmAddressType</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe AddressType -&gt; ntcAddr -&gt; Maybe AddressType
forall a b. a -&gt; b -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#const"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe AddressType
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-702"></span><span>                  </span><span class="annot"><span class="annottext">cmSnocket :: Snocket m ntcFd ntcAddr
</span><span class="hs-identifier hs-var">cmSnocket</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Snocket m ntcFd ntcAddr
</span><a href="#local-6989586621679231427"><span class="hs-identifier hs-var">diNtcSnocket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-703"></span><span>                  </span><span class="annot"><span class="annottext">cmMakeBearer :: MakeBearer m ntcFd
</span><span class="hs-identifier hs-var">cmMakeBearer</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MakeBearer m ntcFd
</span><a href="#local-6989586621679231428"><span class="hs-identifier hs-var">diNtcBearer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-704"></span><span>                  </span><span class="annot"><span class="annottext">cmConfigureSocket :: ntcFd -&gt; Maybe ntcAddr -&gt; m ()
</span><span class="hs-identifier hs-var">cmConfigureSocket</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ntcFd
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe ntcAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-705"></span><span>                  </span><span class="annot"><span class="annottext">cmTimeWaitTimeout :: DiffTime
</span><span class="hs-identifier hs-var">cmTimeWaitTimeout</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#local_TIME_WAIT_TIMEOUT"><span class="hs-identifier hs-var">local_TIME_WAIT_TIMEOUT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-706"></span><span>                  </span><span class="annot"><span class="annottext">cmOutboundIdleTimeout :: DiffTime
</span><span class="hs-identifier hs-var">cmOutboundIdleTimeout</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.Diffusion.P2P.html#local_PROTOCOL_IDLE_TIMEOUT"><span class="hs-identifier hs-var">local_PROTOCOL_IDLE_TIMEOUT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-707"></span><span>                  </span><span class="annot"><span class="annottext">connectionDataFlow :: ntcVersion -&gt; ntcVersionData -&gt; DataFlow
</span><span class="hs-identifier hs-var">connectionDataFlow</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ntcVersion -&gt; ntcVersionData -&gt; DataFlow
forall ntcVersion ntcVersionData.
ntcVersion -&gt; ntcVersionData -&gt; DataFlow
</span><a href="Ouroboros.Network.Diffusion.P2P.html#localDataFlow"><span class="hs-identifier hs-var">localDataFlow</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-708"></span><span>                  </span><span class="annot"><span class="annottext">cmPrunePolicy :: PrunePolicy ntcAddr (STM m)
</span><span class="hs-identifier hs-var">cmPrunePolicy</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
-&gt; PrunePolicy ntcAddr (STM m)
forall (m :: * -&gt; *) peerAddr.
(MonadSTM m, Ord peerAddr) =&gt;
StrictTVar m InboundGovernorObservableState
-&gt; PrunePolicy peerAddr (STM m)
</span><a href="Ouroboros.Network.Diffusion.Policies.html#prunePolicy"><span class="hs-identifier hs-var">Diffusion.Policies.prunePolicy</span></a></span><span>
</span><span id="line-709"></span><span>                                            </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231527"><span class="hs-identifier hs-var">localServerStateVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-710"></span><span>                  </span><span class="annot"><span class="annottext">cmConnectionsLimits :: AcceptedConnectionsLimit
</span><span class="hs-identifier hs-var">cmConnectionsLimits</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679231533"><span class="hs-identifier hs-var">localConnectionLimits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span>                  </span><span class="hs-comment">-- local thread does not start a Outbound Governor</span><span>
</span><span id="line-713"></span><span>                  </span><span class="hs-comment">-- so it doesn't matter what we put here.</span><span>
</span><span id="line-714"></span><span>                  </span><span class="hs-comment">-- 'NoPeerSharing' is set for all connections.</span><span>
</span><span id="line-715"></span><span>                  </span><span class="annot"><span class="annottext">cmGetPeerSharing :: ntcVersionData -&gt; PeerSharing
</span><span class="hs-identifier hs-var">cmGetPeerSharing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ntcVersionData
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeerSharing
</span><span class="hs-identifier hs-var">PeerSharingDisabled</span></span><span>
</span><span id="line-716"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span>        </span><span class="annot"><span class="annottext">NodeToClientConnectionManagerArguments
  ntcFd ntcAddr ntcVersion ntcVersionData m
-&gt; NodeToClientConnectionHandler
     ntcFd ntcAddr ntcVersion ntcVersionData m
-&gt; (NodeToClientHandleError ntcVersion -&gt; HandleErrorType)
-&gt; InResponderMode
     'ResponderMode
     (InformationChannel
        (NewConnectionInfo
           ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
        m)
-&gt; InResponderMode
     'ResponderMode
     (Maybe (InformationChannel (ntcAddr, PeerSharing) m))
-&gt; (ConnectionManager
      'ResponderMode
      ntcFd
      ntcAddr
      (NodeToClientHandle ntcAddr ntcVersionData m)
      (NodeToClientHandleError ntcVersion)
      m
    -&gt; m Void)
-&gt; m Void
forall (muxMode :: MuxMode) peerAddr socket handlerTrace handle
       handleError version versionData (m :: * -&gt; *) a.
(Alternative (STM m), MonadLabelledSTM m, MonadTraceSTM m,
 MonadFork m, MonadAsync m, MonadDelay m, MonadEvaluate m,
 MonadFix m, MonadMask m, MonadThrow (STM m), MonadTimer m,
 Ord peerAddr, Show peerAddr, Typeable peerAddr) =&gt;
ConnectionManagerArguments
  handlerTrace
  socket
  peerAddr
  handle
  handleError
  version
  versionData
  m
-&gt; ConnectionHandler
     muxMode
     handlerTrace
     socket
     peerAddr
     handle
     handleError
     (version, versionData)
     m
-&gt; (handleError -&gt; HandleErrorType)
-&gt; InResponderMode
     muxMode (InformationChannel (NewConnectionInfo peerAddr handle) m)
-&gt; InResponderMode
     muxMode (Maybe (InformationChannel (peerAddr, PeerSharing) m))
-&gt; (ConnectionManager muxMode socket peerAddr handle handleError m
    -&gt; m a)
-&gt; m a
</span><span class="hs-identifier hs-var">withConnectionManager</span></span><span>
</span><span id="line-719"></span><span>          </span><span class="annot"><span class="annottext">NodeToClientConnectionManagerArguments
  ntcFd ntcAddr ntcVersion ntcVersionData m
</span><a href="#local-6989586621679231545"><span class="hs-identifier hs-var">localConnectionManagerArguments</span></a></span><span>
</span><span id="line-720"></span><span>          </span><span class="annot"><span class="annottext">NodeToClientConnectionHandler
  ntcFd ntcAddr ntcVersion ntcVersionData m
</span><a href="#local-6989586621679231536"><span class="hs-identifier hs-var">localConnectionHandler</span></a></span><span>
</span><span id="line-721"></span><span>          </span><span class="annot"><span class="annottext">NodeToClientHandleError ntcVersion -&gt; HandleErrorType
forall (muxMode :: MuxMode) versionNumber.
HandleError muxMode versionNumber -&gt; HandleErrorType
</span><span class="hs-identifier hs-var">classifyHandleError</span></span><span>
</span><span id="line-722"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
  m
-&gt; InResponderMode
     'ResponderMode
     (InformationChannel
        (NewConnectionInfo
           ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
        m)
forall (mode :: MuxMode) a.
(HasResponder mode ~ 'True) =&gt;
a -&gt; InResponderMode mode a
</span><span class="hs-identifier hs-var">InResponderMode</span></span><span> </span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
  m
</span><a href="#local-6989586621679231526"><span class="hs-identifier hs-var">localInbInfoChannel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-723"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (InformationChannel (ntcAddr, PeerSharing) m)
-&gt; InResponderMode
     'ResponderMode
     (Maybe (InformationChannel (ntcAddr, PeerSharing) m))
forall (mode :: MuxMode) a.
(HasResponder mode ~ 'True) =&gt;
a -&gt; InResponderMode mode a
</span><span class="hs-identifier hs-var">InResponderMode</span></span><span> </span><span class="annot"><span class="annottext">Maybe (InformationChannel (ntcAddr, PeerSharing) m)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>          </span><span class="annot"><span class="annottext">((ConnectionManager
    'ResponderMode
    ntcFd
    ntcAddr
    (NodeToClientHandle ntcAddr ntcVersionData m)
    (NodeToClientHandleError ntcVersion)
    m
  -&gt; m Void)
 -&gt; m Void)
-&gt; (ConnectionManager
      'ResponderMode
      ntcFd
      ntcAddr
      (NodeToClientHandle ntcAddr ntcVersionData m)
      (NodeToClientHandleError ntcVersion)
      m
    -&gt; m Void)
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231569"><span class="annot"><span class="annottext">ConnectionManager
  'ResponderMode
  ntcFd
  ntcAddr
  (NodeToClientHandle ntcAddr ntcVersionData m)
  (NodeToClientHandleError ntcVersion)
  m
</span><a href="#local-6989586621679231569"><span class="hs-identifier hs-var">localConnectionManager</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-725"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-726"></span><span>            </span><span class="hs-comment">-- run local server</span><span>
</span><span id="line-727"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-728"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
-&gt; DiffusionTracer ntnAddr ntcAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
</span><a href="#local-6989586621679231440"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffusionTracer ntnAddr ntcAddr -&gt; m ())
-&gt; (ntcAddr -&gt; DiffusionTracer ntnAddr ntcAddr) -&gt; ntcAddr -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ntcAddr -&gt; DiffusionTracer ntnAddr ntcAddr
forall ntnAddr ntcAddr. ntcAddr -&gt; DiffusionTracer ntnAddr ntcAddr
</span><a href="Ouroboros.Network.Diffusion.Common.html#RunLocalServer"><span class="hs-identifier hs-var">RunLocalServer</span></a></span><span>
</span><span id="line-729"></span><span>              </span><span class="annot"><span class="annottext">(ntcAddr -&gt; m ()) -&gt; m ntcAddr -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3D%3C%3C"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m ntcFd ntcAddr -&gt; ntcFd -&gt; m ntcAddr
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m addr
</span><span class="hs-identifier hs-var">Snocket.getLocalAddr</span></span><span> </span><span class="annot"><span class="annottext">Snocket m ntcFd ntcAddr
</span><a href="#local-6989586621679231427"><span class="hs-identifier hs-var">diNtcSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">ntcFd
</span><a href="#local-6989586621679231525"><span class="hs-identifier hs-var">localSocket</span></a></span><span>
</span><span id="line-730"></span><span>
</span><span id="line-731"></span><span>            </span><span class="annot"><span class="annottext">m Void -&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. m a -&gt; (Async m a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">Async.withAsync</span></span><span>
</span><span id="line-732"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerArguments
  'ResponderMode
  ntcFd
  (MinimalInitiatorContext ntcAddr)
  ntcAddr
  ntcVersionData
  ntcVersion
  ByteString
  m
  Void
  ()
-&gt; m Void
forall (muxMode :: MuxMode) socket initiatorCtx peerAddr
       versionData versionNumber (m :: * -&gt; *) a b.
(Alternative (STM m), MonadAsync m, MonadDelay m, MonadCatch m,
 MonadEvaluate m, MonadLabelledSTM m, MonadMask m,
 MonadThrow (STM m), MonadTime m, MonadTimer m,
 HasResponder muxMode ~ 'True, Ord peerAddr, Show peerAddr) =&gt;
ServerArguments
  muxMode
  socket
  initiatorCtx
  peerAddr
  versionData
  versionNumber
  ByteString
  m
  a
  b
-&gt; m Void
</span><span class="hs-identifier hs-var">Server.run</span></span><span>
</span><span id="line-733"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">ServerArguments</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-734"></span><span>                    </span><span class="annot"><span class="annottext">serverSockets :: NonEmpty ntcFd
</span><span class="hs-identifier hs-var">serverSockets</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ntcFd
</span><a href="#local-6989586621679231525"><span class="hs-identifier hs-var">localSocket</span></a></span><span> </span><span class="annot"><span class="annottext">ntcFd -&gt; [ntcFd] -&gt; NonEmpty ntcFd
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3A%7C"><span class="hs-operator hs-var">:|</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-735"></span><span>                    </span><span class="annot"><span class="annottext">serverSnocket :: Snocket m ntcFd ntcAddr
</span><span class="hs-identifier hs-var">serverSnocket</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Snocket m ntcFd ntcAddr
</span><a href="#local-6989586621679231427"><span class="hs-identifier hs-var">diNtcSnocket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-736"></span><span>                    </span><span class="annot"><span class="annottext">serverTracer :: Tracer m (ServerTrace ntcAddr)
</span><span class="hs-identifier hs-var">serverTracer</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace ntcAddr)
</span><a href="#local-6989586621679231455"><span class="hs-identifier hs-var">dtLocalServerTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-737"></span><span>                    </span><span class="annot"><span class="annottext">serverTrTracer :: Tracer m (RemoteTransitionTrace ntcAddr)
</span><span class="hs-identifier hs-var">serverTrTracer</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (RemoteTransitionTrace ntcAddr)
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><span class="hs-identifier hs-var">nullTracer</span></span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- TODO: issue #3320</span><span>
</span><span id="line-738"></span><span>                    </span><span class="annot"><span class="annottext">serverInboundGovernorTracer :: Tracer m (InboundGovernorTrace ntcAddr)
</span><span class="hs-identifier hs-var">serverInboundGovernorTracer</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace ntcAddr)
</span><a href="#local-6989586621679231456"><span class="hs-identifier hs-var">dtLocalInboundGovernorTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-739"></span><span>                    </span><span class="annot"><span class="annottext">serverInboundIdleTimeout :: Maybe DiffTime
</span><span class="hs-identifier hs-var">serverInboundIdleTimeout</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DiffTime
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-740"></span><span>                    </span><span class="annot"><span class="annottext">serverConnectionLimits :: AcceptedConnectionsLimit
</span><span class="hs-identifier hs-var">serverConnectionLimits</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679231533"><span class="hs-identifier hs-var">localConnectionLimits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-741"></span><span>                    </span><span class="annot"><span class="annottext">serverConnectionManager :: ConnectionManager
  'ResponderMode
  ntcFd
  ntcAddr
  (NodeToClientHandle ntcAddr ntcVersionData m)
  (NodeToClientHandleError ntcVersion)
  m
</span><span class="hs-identifier hs-var">serverConnectionManager</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionManager
  'ResponderMode
  ntcFd
  ntcAddr
  (NodeToClientHandle ntcAddr ntcVersionData m)
  (NodeToClientHandleError ntcVersion)
  m
</span><a href="#local-6989586621679231569"><span class="hs-identifier hs-var">localConnectionManager</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-742"></span><span>                    </span><span class="annot"><span class="annottext">serverInboundInfoChannel :: InformationChannel
  (NewConnectionInfo
     ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
  m
</span><span class="hs-identifier hs-var">serverInboundInfoChannel</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntcAddr (NodeToClientHandle ntcAddr ntcVersionData m))
  m
</span><a href="#local-6989586621679231526"><span class="hs-identifier hs-var">localInbInfoChannel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-743"></span><span>                    </span><span class="annot"><span class="annottext">serverObservableStateVar :: StrictTVar m InboundGovernorObservableState
</span><span class="hs-identifier hs-var">serverObservableStateVar</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231527"><span class="hs-identifier hs-var">localServerStateVar</span></a></span><span>
</span><span id="line-744"></span><span>                  </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Async m Void -&gt; m Void
forall a. Async m a -&gt; m a
forall (m :: * -&gt; *) a. MonadAsync m =&gt; Async m a -&gt; m a
</span><span class="hs-identifier hs-var">Async.wait</span></span><span>
</span><span id="line-745"></span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span>    </span><span class="hs-comment">-- | mkRemoteThread - create remote connection manager</span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span>    </span><span class="annot"><a href="#local-6989586621679231497"><span class="hs-identifier hs-type">mkRemoteThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-750"></span><span>    </span><span id="local-6989586621679231497"><span class="annot"><span class="annottext">mkRemoteThread :: ThreadId m -&gt; m Void
</span><a href="#local-6989586621679231497"><span class="hs-identifier hs-var hs-var">mkRemoteThread</span></a></span></span><span> </span><span id="local-6989586621679231589"><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679231589"><span class="hs-identifier hs-var">mainThreadId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-751"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-752"></span><span>        </span><span class="annot"><a href="#local-6989586621679231590"><span class="hs-identifier hs-type">exitPolicy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.ExitPolicy.html#ExitPolicy"><span class="hs-identifier hs-type">ExitPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230513"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-753"></span><span>        </span><span id="local-6989586621679231590"><span class="annot"><span class="annottext">exitPolicy :: ExitPolicy a
</span><a href="#local-6989586621679231590"><span class="hs-identifier hs-var hs-var">exitPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReturnPolicy a -&gt; ExitPolicy a
forall a. ReturnPolicy a -&gt; ExitPolicy a
</span><a href="Ouroboros.Network.ExitPolicy.html#stdExitPolicy"><span class="hs-identifier hs-var">stdExitPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">ReturnPolicy a
</span><a href="#local-6989586621679231488"><span class="hs-identifier hs-var">daReturnPolicy</span></a></span><span>
</span><span id="line-754"></span><span>
</span><span id="line-755"></span><span>      </span><span id="local-6989586621679231592"><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="#local-6989586621679231592"><span class="hs-identifier hs-var">cmIPv4Address</span></a></span></span><span>
</span><span id="line-756"></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Either ntnFd ntnAddr -&gt; m ntnAddr)
-&gt; Maybe (Either ntnFd ntnAddr) -&gt; m (Maybe ntnAddr)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; Maybe a -&gt; f (Maybe b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ntnFd -&gt; m ntnAddr)
-&gt; (ntnAddr -&gt; m ntnAddr) -&gt; Either ntnFd ntnAddr -&gt; m ntnAddr
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#either"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr -&gt; ntnFd -&gt; m ntnAddr
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m addr
</span><span class="hs-identifier hs-var">Snocket.getLocalAddr</span></span><span> </span><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr
</span><a href="#local-6989586621679231418"><span class="hs-identifier hs-var">diNtnSnocket</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ntnAddr -&gt; m ntnAddr
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (Either ntnFd ntnAddr)
</span><a href="#local-6989586621679231458"><span class="hs-identifier hs-var">daIPv4Address</span></a></span><span>
</span><span id="line-758"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="#local-6989586621679231592"><span class="hs-identifier hs-var">cmIPv4Address</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-759"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679231595"><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231595"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><span class="hs-identifier hs-var">IPv4Address</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ntnAddr -&gt; Maybe AddressType
</span><a href="#local-6989586621679231423"><span class="hs-identifier hs-var">diNtnAddressType</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231595"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-760"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-761"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-762"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Failure -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ntnAddr -&gt; Failure
forall ntnAddr.
(Show ntnAddr, Typeable ntnAddr) =&gt;
ntnAddr -&gt; Failure
</span><a href="Ouroboros.Network.Diffusion.Common.html#UnexpectedIPv4Address"><span class="hs-identifier hs-var">UnexpectedIPv4Address</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231595"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span>        </span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>
</span><span id="line-765"></span><span>      </span><span id="local-6989586621679231598"><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="#local-6989586621679231598"><span class="hs-identifier hs-var">cmIPv6Address</span></a></span></span><span>
</span><span id="line-766"></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Either ntnFd ntnAddr -&gt; m ntnAddr)
-&gt; Maybe (Either ntnFd ntnAddr) -&gt; m (Maybe ntnAddr)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; Maybe a -&gt; f (Maybe b)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Traversable.html#traverse"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ntnFd -&gt; m ntnAddr)
-&gt; (ntnAddr -&gt; m ntnAddr) -&gt; Either ntnFd ntnAddr -&gt; m ntnAddr
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#either"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr -&gt; ntnFd -&gt; m ntnAddr
forall (m :: * -&gt; *) fd addr. Snocket m fd addr -&gt; fd -&gt; m addr
</span><span class="hs-identifier hs-var">Snocket.getLocalAddr</span></span><span> </span><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr
</span><a href="#local-6989586621679231418"><span class="hs-identifier hs-var">diNtnSnocket</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ntnAddr -&gt; m ntnAddr
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (Either ntnFd ntnAddr)
</span><a href="#local-6989586621679231460"><span class="hs-identifier hs-var">daIPv6Address</span></a></span><span>
</span><span id="line-768"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="#local-6989586621679231598"><span class="hs-identifier hs-var">cmIPv6Address</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-769"></span><span>        </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679231599"><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231599"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AddressType
</span><span class="hs-identifier hs-var">IPv6Address</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ntnAddr -&gt; Maybe AddressType
</span><a href="#local-6989586621679231423"><span class="hs-identifier hs-var">diNtnAddressType</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231599"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-770"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-771"></span><span>                  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-772"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Failure -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ntnAddr -&gt; Failure
forall ntnAddr.
(Show ntnAddr, Typeable ntnAddr) =&gt;
ntnAddr -&gt; Failure
</span><a href="Ouroboros.Network.Diffusion.Common.html#UnexpectedIPv6Address"><span class="hs-identifier hs-var">UnexpectedIPv6Address</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231599"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>        </span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span>      </span><span id="local-6989586621679231601"><span class="annot"><span class="annottext">DNSLookupType
</span><a href="#local-6989586621679231601"><span class="hs-identifier hs-var">lookupReqs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="#local-6989586621679231592"><span class="hs-identifier hs-var">cmIPv4Address</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="#local-6989586621679231598"><span class="hs-identifier hs-var">cmIPv6Address</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-776"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DNSLookupType -&gt; m DNSLookupType
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">DNSLookupType
</span><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#LookupReqAOnly"><span class="hs-identifier hs-var">LookupReqAOnly</span></a></span><span>
</span><span id="line-777"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DNSLookupType -&gt; m DNSLookupType
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">DNSLookupType
</span><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#LookupReqAAAAOnly"><span class="hs-identifier hs-var">LookupReqAAAAOnly</span></a></span><span>
</span><span id="line-778"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DNSLookupType -&gt; m DNSLookupType
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">DNSLookupType
</span><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#LookupReqAAndAAAA"><span class="hs-identifier hs-var">LookupReqAAndAAAA</span></a></span><span>
</span><span id="line-779"></span><span>                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ntnAddr
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Failure -&gt; m DNSLookupType
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">Failure
</span><a href="Ouroboros.Network.Diffusion.Common.html#NoSocket"><span class="hs-identifier hs-var">NoSocket</span></a></span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span>      </span><span class="hs-comment">-- RNGs used for picking random peers from the ledger and for</span><span>
</span><span id="line-782"></span><span>      </span><span class="hs-comment">-- demoting/promoting peers.</span><span>
</span><span id="line-783"></span><span>      </span><span id="local-6989586621679231606"><span class="annot"><span class="annottext">StrictTVar m StdGen
</span><a href="#local-6989586621679231606"><span class="hs-identifier hs-var">policyRngVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; m (StrictTVar m StdGen)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231501"><span class="hs-identifier hs-var">policyRng</span></a></span><span>
</span><span id="line-784"></span><span>
</span><span id="line-785"></span><span>      </span><span id="local-6989586621679231608"><span class="annot"><span class="annottext">StrictTVar m StdGen
</span><a href="#local-6989586621679231608"><span class="hs-identifier hs-var">peerSharingRngVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; m (StrictTVar m StdGen)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231510"><span class="hs-identifier hs-var">peerSharingRng</span></a></span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span>      </span><span id="local-6989586621679231609"><span class="annot"><span class="annottext">StrictTVar m ChurnMode
</span><a href="#local-6989586621679231609"><span class="hs-identifier hs-var">churnModeVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChurnMode -&gt; m (StrictTVar m ChurnMode)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">ChurnMode
</span><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#ChurnModeNormal"><span class="hs-identifier hs-var">ChurnModeNormal</span></a></span><span>
</span><span id="line-788"></span><span>
</span><span id="line-789"></span><span>      </span><span id="local-6989586621679231610"><span class="annot"><span class="annottext">StrictTVar m PeerSelectionTargets
</span><a href="#local-6989586621679231610"><span class="hs-identifier hs-var">peerSelectionTargetsVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PeerSelectionTargets -&gt; m (StrictTVar m PeerSelectionTargets)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">(PeerSelectionTargets -&gt; m (StrictTVar m PeerSelectionTargets))
-&gt; PeerSelectionTargets -&gt; m (StrictTVar m PeerSelectionTargets)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSelectionTargets
</span><a href="#local-6989586621679231468"><span class="hs-identifier hs-var">daPeerSelectionTargets</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-790"></span><span>          </span><span class="hs-comment">-- Start with a smaller number of active peers, the churn governor</span><span>
</span><span id="line-791"></span><span>          </span><span class="hs-comment">-- will increase it to the configured value after a delay.</span><span>
</span><span id="line-792"></span><span>          </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#targetNumberOfActivePeers"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-793"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#min"><span class="hs-identifier hs-type">min</span></a></span><span> </span><span class="annot"><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#targetNumberOfActivePeers"><span class="hs-identifier hs-var">targetNumberOfActivePeers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679231468"><span class="hs-identifier hs-type">daPeerSelectionTargets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-795"></span><span>
</span><span id="line-796"></span><span>      </span><span id="local-6989586621679231613"><span class="annot"><span class="annottext">StrictTVar m (PublicPeerSelectionState ntnAddr)
</span><a href="#local-6989586621679231613"><span class="hs-identifier hs-var">publicStateVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PublicPeerSelectionState ntnAddr
-&gt; m (StrictTVar m (PublicPeerSelectionState ntnAddr))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (StrictTVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">PublicPeerSelectionState ntnAddr
forall peeraddr. Ord peeraddr =&gt; PublicPeerSelectionState peeraddr
</span><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#emptyPublicPeerSelectionState"><span class="hs-identifier hs-var">emptyPublicPeerSelectionState</span></a></span><span>
</span><span id="line-797"></span><span>
</span><span id="line-798"></span><span>      </span><span class="hs-comment">-- Design notes:</span><span>
</span><span id="line-799"></span><span>      </span><span class="hs-comment">--  - We split the following code into two parts:</span><span>
</span><span id="line-800"></span><span>      </span><span class="hs-comment">--    - Part (a): plumb data flow (in particular arguments and tracersr)</span><span>
</span><span id="line-801"></span><span>      </span><span class="hs-comment">--      and define common functions as a sequence of 'let's in which we</span><span>
</span><span id="line-802"></span><span>      </span><span class="hs-comment">--      define needed 'withXXX' functions (and similar) which</span><span>
</span><span id="line-803"></span><span>      </span><span class="hs-comment">--       - are used in Part (b),</span><span>
</span><span id="line-804"></span><span>      </span><span class="hs-comment">--       - handle the plumbing of tracers, and</span><span>
</span><span id="line-805"></span><span>      </span><span class="hs-comment">--       - capture commonalities between the two cases.</span><span>
</span><span id="line-806"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-807"></span><span>      </span><span class="hs-comment">--    - Part (b): capturing the major control-flow of runM:</span><span>
</span><span id="line-808"></span><span>      </span><span class="hs-comment">--      in particular, two different case alternatives in which is captured</span><span>
</span><span id="line-809"></span><span>      </span><span class="hs-comment">--      the monadic flow of the program stripped down to its essence:</span><span>
</span><span id="line-810"></span><span>      </span><span class="hs-comment">---     ```</span><span>
</span><span id="line-811"></span><span>      </span><span class="hs-comment">--       &lt;setup...&gt;</span><span>
</span><span id="line-812"></span><span>      </span><span class="hs-comment">--       case diffusionMode of</span><span>
</span><span id="line-813"></span><span>      </span><span class="hs-comment">--         InitiatorOnlyDiffusionMode -&gt; ...</span><span>
</span><span id="line-814"></span><span>      </span><span class="hs-comment">--         InitiatorAndResponderDiffusionMode -&gt; ...</span><span>
</span><span id="line-815"></span><span>      </span><span class="hs-comment">--      ```</span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-818"></span><span>      </span><span class="hs-comment">-- Part (a): plumb data flow and define common functions</span><span>
</span><span id="line-819"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-820"></span><span>
</span><span id="line-821"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679231614"><span class="hs-identifier hs-type">connectionManagerArguments'</span></a></span><span>
</span><span id="line-822"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679230768"><span class="annot"><a href="#local-6989586621679230768"><span class="hs-identifier hs-type">handle</span></a></span></span><span> </span><span id="local-6989586621679230769"><span class="annot"><a href="#local-6989586621679230769"><span class="hs-identifier hs-type">handleError</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-823"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">PrunePolicy</span></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConnectionManagerArguments</span></span><span>
</span><span id="line-825"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConnectionHandlerTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230507"><span class="hs-identifier hs-type">ntnFd</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230768"><span class="hs-identifier hs-type">handle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230769"><span class="hs-identifier hs-type">handleError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-827"></span><span>          </span><span id="local-6989586621679231614"><span class="annot"><span class="annottext">connectionManagerArguments' :: forall handle handleError.
PrunePolicy ntnAddr (STM m)
-&gt; ConnectionManagerArguments
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     handle
     handleError
     ntnVersion
     ntnVersionData
     m
</span><a href="#local-6989586621679231614"><span class="hs-identifier hs-var hs-var">connectionManagerArguments'</span></a></span></span><span> </span><span id="local-6989586621679231619"><span class="annot"><span class="annottext">PrunePolicy ntnAddr (STM m)
</span><a href="#local-6989586621679231619"><span class="hs-identifier hs-var">prunePolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-828"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">ConnectionManagerArguments</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-829"></span><span>                </span><span class="annot"><span class="annottext">cmTracer :: Tracer
  m
  (ConnectionManagerTrace
     ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
</span><span class="hs-identifier hs-var">cmTracer</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer
  m
  (ConnectionManagerTrace
     ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
</span><a href="#local-6989586621679231449"><span class="hs-identifier hs-var">dtConnectionManagerTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-830"></span><span>                </span><span class="annot"><span class="annottext">cmTrTracer :: Tracer
  m
  (TransitionTrace
     ntnAddr (ConnectionState ntnAddr handle handleError ntnVersion m))
</span><span class="hs-identifier hs-var">cmTrTracer</span></span><span>            </span><span class="hs-glyph">=</span><span>
</span><span id="line-831"></span><span>                  </span><span class="annot"><span class="annottext">(MaybeUnknown
   (ConnectionState ntnAddr handle handleError ntnVersion m)
 -&gt; AbstractState)
-&gt; TransitionTrace
     ntnAddr (ConnectionState ntnAddr handle handleError ntnVersion m)
-&gt; AbstractTransitionTrace ntnAddr
forall a b.
(a -&gt; b)
-&gt; TransitionTrace' ntnAddr a -&gt; TransitionTrace' ntnAddr b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">MaybeUnknown
  (ConnectionState ntnAddr handle handleError ntnVersion m)
-&gt; AbstractState
forall muxMode peerAddr m a (b :: * -&gt; *).
MaybeUnknown (ConnectionState muxMode peerAddr m a b)
-&gt; AbstractState
</span><span class="hs-identifier hs-var">abstractState</span></span><span>
</span><span id="line-832"></span><span>                  </span><span class="annot"><span class="annottext">(TransitionTrace
   ntnAddr (ConnectionState ntnAddr handle handleError ntnVersion m)
 -&gt; AbstractTransitionTrace ntnAddr)
-&gt; Tracer m (AbstractTransitionTrace ntnAddr)
-&gt; Tracer
     m
     (TransitionTrace
        ntnAddr (ConnectionState ntnAddr handle handleError ntnVersion m))
forall a' a. (a' -&gt; a) -&gt; Tracer m a -&gt; Tracer m a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (AbstractTransitionTrace ntnAddr)
</span><a href="#local-6989586621679231450"><span class="hs-identifier hs-var">dtConnectionManagerTransitionTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-833"></span><span>                </span><span class="annot"><span class="annottext">cmMuxTracer :: Tracer m (WithMuxBearer (ConnectionId ntnAddr) MuxTrace)
</span><span class="hs-identifier hs-var">cmMuxTracer</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntnAddr) MuxTrace)
</span><a href="#local-6989586621679231435"><span class="hs-identifier hs-var">dtMuxTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-834"></span><span>                </span><span class="annot"><span class="annottext">Maybe ntnAddr
cmIPv4Address :: Maybe ntnAddr
cmIPv4Address :: Maybe ntnAddr
</span><span class="hs-identifier hs-var hs-var">cmIPv4Address</span></span><span class="hs-special">,</span><span>
</span><span id="line-835"></span><span>                </span><span class="annot"><span class="annottext">Maybe ntnAddr
cmIPv6Address :: Maybe ntnAddr
cmIPv6Address :: Maybe ntnAddr
</span><span class="hs-identifier hs-var hs-var">cmIPv6Address</span></span><span class="hs-special">,</span><span>
</span><span id="line-836"></span><span>                </span><span class="annot"><span class="annottext">cmAddressType :: ntnAddr -&gt; Maybe AddressType
</span><span class="hs-identifier hs-var">cmAddressType</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ntnAddr -&gt; Maybe AddressType
</span><a href="#local-6989586621679231423"><span class="hs-identifier hs-var">diNtnAddressType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-837"></span><span>                </span><span class="annot"><span class="annottext">cmSnocket :: Snocket m ntnFd ntnAddr
</span><span class="hs-identifier hs-var">cmSnocket</span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr
</span><a href="#local-6989586621679231418"><span class="hs-identifier hs-var">diNtnSnocket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-838"></span><span>                </span><span class="annot"><span class="annottext">cmMakeBearer :: MakeBearer m ntnFd
</span><span class="hs-identifier hs-var">cmMakeBearer</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MakeBearer m ntnFd
</span><a href="#local-6989586621679231419"><span class="hs-identifier hs-var">diNtnBearer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-839"></span><span>                </span><span class="annot"><span class="annottext">cmConfigureSocket :: ntnFd -&gt; Maybe ntnAddr -&gt; m ()
</span><span class="hs-identifier hs-var">cmConfigureSocket</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ntnFd -&gt; Maybe ntnAddr -&gt; m ()
</span><a href="#local-6989586621679231420"><span class="hs-identifier hs-var">diNtnConfigureSocket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-840"></span><span>                </span><span class="annot"><span class="annottext">connectionDataFlow :: ntnVersion -&gt; ntnVersionData -&gt; DataFlow
</span><span class="hs-identifier hs-var">connectionDataFlow</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ntnVersion -&gt; ntnVersionData -&gt; DataFlow
</span><a href="#local-6989586621679231424"><span class="hs-identifier hs-var">diNtnDataFlow</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-841"></span><span>                </span><span class="annot"><span class="annottext">cmPrunePolicy :: PrunePolicy ntnAddr (STM m)
</span><span class="hs-identifier hs-var">cmPrunePolicy</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrunePolicy ntnAddr (STM m)
</span><a href="#local-6989586621679231619"><span class="hs-identifier hs-var">prunePolicy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-842"></span><span>                </span><span class="annot"><span class="annottext">cmConnectionsLimits :: AcceptedConnectionsLimit
</span><span class="hs-identifier hs-var">cmConnectionsLimits</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679231464"><span class="hs-identifier hs-var">daAcceptedConnectionsLimit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-843"></span><span>                </span><span class="annot"><span class="annottext">cmTimeWaitTimeout :: DiffTime
</span><span class="hs-identifier hs-var">cmTimeWaitTimeout</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679231474"><span class="hs-identifier hs-var">daTimeWaitTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-844"></span><span>                </span><span class="annot"><span class="annottext">cmOutboundIdleTimeout :: DiffTime
</span><span class="hs-identifier hs-var">cmOutboundIdleTimeout</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679231473"><span class="hs-identifier hs-var">daProtocolIdleTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-845"></span><span>                </span><span class="annot"><span class="annottext">cmGetPeerSharing :: ntnVersionData -&gt; PeerSharing
</span><span class="hs-identifier hs-var">cmGetPeerSharing</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ntnVersionData -&gt; PeerSharing
</span><a href="#local-6989586621679231425"><span class="hs-identifier hs-var">diNtnPeerSharing</span></a></span><span>
</span><span id="line-846"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-847"></span><span>
</span><span id="line-848"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679231621"><span class="annot"><span class="annottext">peerSelectionPolicy :: PeerSelectionPolicy ntnAddr m
</span><a href="#local-6989586621679231621"><span class="hs-identifier hs-var hs-var">peerSelectionPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m StdGen
-&gt; STM m ChurnMode
-&gt; PeerMetrics m ntnAddr
-&gt; RepromoteDelay
-&gt; PeerSelectionPolicy ntnAddr m
forall (m :: * -&gt; *) peerAddr.
(MonadSTM m, Ord peerAddr) =&gt;
StrictTVar m StdGen
-&gt; STM m ChurnMode
-&gt; PeerMetrics m peerAddr
-&gt; RepromoteDelay
-&gt; PeerSelectionPolicy peerAddr m
</span><a href="Ouroboros.Network.Diffusion.Policies.html#simplePeerSelectionPolicy"><span class="hs-identifier hs-var">Diffusion.Policies.simplePeerSelectionPolicy</span></a></span><span>
</span><span id="line-849"></span><span>                                  </span><span class="annot"><span class="annottext">StrictTVar m StdGen
</span><a href="#local-6989586621679231606"><span class="hs-identifier hs-var">policyRngVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m ChurnMode -&gt; STM m ChurnMode
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m ChurnMode
</span><a href="#local-6989586621679231609"><span class="hs-identifier hs-var">churnModeVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>                                  </span><span class="annot"><span class="annottext">PeerMetrics m ntnAddr
</span><a href="#local-6989586621679231489"><span class="hs-identifier hs-var">daPeerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExitPolicy a -&gt; RepromoteDelay
forall a. ExitPolicy a -&gt; RepromoteDelay
</span><a href="Ouroboros.Network.ExitPolicy.html#epErrorDelay"><span class="hs-identifier hs-var">epErrorDelay</span></a></span><span> </span><span class="annot"><span class="annottext">ExitPolicy a
</span><a href="#local-6989586621679231590"><span class="hs-identifier hs-var">exitPolicy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679231625"><span class="hs-identifier hs-type">makeConnectionHandler'</span></a></span><span>
</span><span id="line-853"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679230796"><span class="annot"><a href="#local-6989586621679230796"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span id="local-6989586621679230801"><span class="annot"><a href="#local-6989586621679230801"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679230797"><span class="annot"><a href="#local-6989586621679230797"><span class="hs-identifier hs-type">initiatorCtx</span></a></span></span><span> </span><span id="local-6989586621679230798"><span class="annot"><a href="#local-6989586621679230798"><span class="hs-identifier hs-type">responderCtx</span></a></span></span><span> </span><span id="local-6989586621679230799"><span class="annot"><a href="#local-6989586621679230799"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621679230800"><span class="annot"><a href="#local-6989586621679230800"><span class="hs-identifier hs-type">c</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-854"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">SingMuxMode</span></span><span> </span><span class="annot"><a href="#local-6989586621679230796"><span class="hs-identifier hs-type">muxMode</span></a></span><span>
</span><span id="line-855"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Versions</span></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span>
</span><span id="line-856"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OuroborosBundle</span></span><span> </span><span class="annot"><a href="#local-6989586621679230796"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230797"><span class="hs-identifier hs-type">initiatorCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230798"><span class="hs-identifier hs-type">responderCtx</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230799"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230800"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-857"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxConnectionHandler</span></span><span>
</span><span id="line-858"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230796"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230801"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230797"><span class="hs-identifier hs-type">initiatorCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230798"><span class="hs-identifier hs-type">responderCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-859"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230799"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230800"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-860"></span><span>          </span><span id="local-6989586621679231625"><span class="annot"><span class="annottext">makeConnectionHandler' :: forall (muxMode :: MuxMode) socket initiatorCtx responderCtx b c.
SingMuxMode muxMode
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundle
        muxMode initiatorCtx responderCtx ByteString m b c)
-&gt; MuxConnectionHandler
     muxMode
     socket
     initiatorCtx
     responderCtx
     ntnAddr
     ntnVersion
     ntnVersionData
     ByteString
     m
     b
     c
</span><a href="#local-6989586621679231625"><span class="hs-identifier hs-var hs-var">makeConnectionHandler'</span></a></span></span><span> </span><span id="local-6989586621679231638"><span class="annot"><span class="annottext">SingMuxMode muxMode
</span><a href="#local-6989586621679231638"><span class="hs-identifier hs-var">muxMode</span></a></span></span><span> </span><span id="local-6989586621679231639"><span class="annot"><span class="annottext">Versions
  ntnVersion
  ntnVersionData
  (OuroborosBundle
     muxMode initiatorCtx responderCtx ByteString m b c)
</span><a href="#local-6989586621679231639"><span class="hs-identifier hs-var">versions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-861"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntnAddr) MuxTrace)
-&gt; SingMuxMode muxMode
-&gt; HandshakeArguments
     (ConnectionId ntnAddr) ntnVersion ntnVersionData m
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundle
        muxMode initiatorCtx responderCtx ByteString m b c)
-&gt; (ThreadId m, RethrowPolicy)
-&gt; MuxConnectionHandler
     muxMode
     socket
     initiatorCtx
     responderCtx
     ntnAddr
     ntnVersion
     ntnVersionData
     ByteString
     m
     b
     c
forall initiatorCtx responderCtx peerAddr (muxMode :: MuxMode)
       socket versionNumber versionData (m :: * -&gt; *) a b.
(Alternative (STM m), MonadAsync m, MonadDelay m, MonadFork m,
 MonadLabelledSTM m, MonadThrow (STM m), MonadTimer m, MonadMask m,
 Ord versionNumber, Show peerAddr, Typeable peerAddr) =&gt;
Tracer m (WithMuxBearer (ConnectionId peerAddr) MuxTrace)
-&gt; SingMuxMode muxMode
-&gt; HandshakeArguments
     (ConnectionId peerAddr) versionNumber versionData m
-&gt; Versions
     versionNumber
     versionData
     (OuroborosBundle
        muxMode initiatorCtx responderCtx ByteString m a b)
-&gt; (ThreadId m, RethrowPolicy)
-&gt; MuxConnectionHandler
     muxMode
     socket
     initiatorCtx
     responderCtx
     peerAddr
     versionNumber
     versionData
     ByteString
     m
     a
     b
</span><span class="hs-identifier hs-var">makeConnectionHandler</span></span><span>
</span><span id="line-862"></span><span>              </span><span class="annot"><span class="annottext">Tracer m (WithMuxBearer (ConnectionId ntnAddr) MuxTrace)
</span><a href="#local-6989586621679231435"><span class="hs-identifier hs-var">dtMuxTracer</span></a></span><span>
</span><span id="line-863"></span><span>              </span><span class="annot"><span class="annottext">SingMuxMode muxMode
</span><a href="#local-6989586621679231638"><span class="hs-identifier hs-var">muxMode</span></a></span><span>
</span><span id="line-864"></span><span>              </span><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId ntnAddr) ntnVersion ntnVersionData m
</span><a href="#local-6989586621679231422"><span class="hs-identifier hs-var">diNtnHandshakeArguments</span></a></span><span>
</span><span id="line-865"></span><span>              </span><span class="annot"><span class="annottext">Versions
  ntnVersion
  ntnVersionData
  (OuroborosBundle
     muxMode initiatorCtx responderCtx ByteString m b c)
</span><a href="#local-6989586621679231639"><span class="hs-identifier hs-var">versions</span></a></span><span>
</span><span id="line-866"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId m
</span><a href="#local-6989586621679231589"><span class="hs-identifier hs-var">mainThreadId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RethrowPolicy
</span><a href="#local-6989586621679231515"><span class="hs-identifier hs-var">rethrowPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">RethrowPolicy -&gt; RethrowPolicy -&gt; RethrowPolicy
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">RethrowPolicy
</span><a href="#local-6989586621679231486"><span class="hs-identifier hs-var">daRethrowPolicy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-867"></span><span>
</span><span id="line-868"></span><span>          </span><span class="hs-comment">-- | Capture the two variations (InitiatorMode,InitiatorResponderMode) of</span><span>
</span><span id="line-869"></span><span>          </span><span class="hs-comment">--   withConnectionManager:</span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span>          </span><span id="local-6989586621679231640"><span class="annot"><span class="annottext">withConnectionManagerInitiatorOnlyMode :: (ConnectionManager
   'InitiatorMode
   ntnFd
   ntnAddr
   (Handle
      'InitiatorMode
      (ExpandedInitiatorContext ntnAddr m)
      (ResponderContext ntnAddr)
      ntnVersionData
      ByteString
      m
      a
      Void)
   (HandleError 'InitiatorMode ntnVersion)
   m
 -&gt; m Void)
-&gt; m Void
</span><a href="#local-6989586621679231640"><span class="hs-identifier hs-var hs-var">withConnectionManagerInitiatorOnlyMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-872"></span><span>            </span><span class="annot"><span class="annottext">ConnectionManagerArguments
  (ConnectionHandlerTrace ntnVersion ntnVersionData)
  ntnFd
  ntnAddr
  (Handle
     'InitiatorMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     Void)
  (HandleError 'InitiatorMode ntnVersion)
  ntnVersion
  ntnVersionData
  m
-&gt; ConnectionHandler
     'InitiatorMode
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     (Handle
        'InitiatorMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        Void)
     (HandleError 'InitiatorMode ntnVersion)
     (ntnVersion, ntnVersionData)
     m
-&gt; (HandleError 'InitiatorMode ntnVersion -&gt; HandleErrorType)
-&gt; InResponderMode
     'InitiatorMode
     (InformationChannel
        (NewConnectionInfo
           ntnAddr
           (Handle
              'InitiatorMode
              (ExpandedInitiatorContext ntnAddr m)
              (ResponderContext ntnAddr)
              ntnVersionData
              ByteString
              m
              a
              Void))
        m)
-&gt; InResponderMode
     'InitiatorMode
     (Maybe (InformationChannel (ntnAddr, PeerSharing) m))
-&gt; (ConnectionManager
      'InitiatorMode
      ntnFd
      ntnAddr
      (Handle
         'InitiatorMode
         (ExpandedInitiatorContext ntnAddr m)
         (ResponderContext ntnAddr)
         ntnVersionData
         ByteString
         m
         a
         Void)
      (HandleError 'InitiatorMode ntnVersion)
      m
    -&gt; m Void)
-&gt; m Void
forall (muxMode :: MuxMode) peerAddr socket handlerTrace handle
       handleError version versionData (m :: * -&gt; *) a.
(Alternative (STM m), MonadLabelledSTM m, MonadTraceSTM m,
 MonadFork m, MonadAsync m, MonadDelay m, MonadEvaluate m,
 MonadFix m, MonadMask m, MonadThrow (STM m), MonadTimer m,
 Ord peerAddr, Show peerAddr, Typeable peerAddr) =&gt;
ConnectionManagerArguments
  handlerTrace
  socket
  peerAddr
  handle
  handleError
  version
  versionData
  m
-&gt; ConnectionHandler
     muxMode
     handlerTrace
     socket
     peerAddr
     handle
     handleError
     (version, versionData)
     m
-&gt; (handleError -&gt; HandleErrorType)
-&gt; InResponderMode
     muxMode (InformationChannel (NewConnectionInfo peerAddr handle) m)
-&gt; InResponderMode
     muxMode (Maybe (InformationChannel (peerAddr, PeerSharing) m))
-&gt; (ConnectionManager muxMode socket peerAddr handle handleError m
    -&gt; m a)
-&gt; m a
</span><span class="hs-identifier hs-var">withConnectionManager</span></span><span>
</span><span id="line-873"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrunePolicy ntnAddr (STM m)
-&gt; ConnectionManagerArguments
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     (Handle
        'InitiatorMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        Void)
     (HandleError 'InitiatorMode ntnVersion)
     ntnVersion
     ntnVersionData
     m
forall handle handleError.
PrunePolicy ntnAddr (STM m)
-&gt; ConnectionManagerArguments
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     handle
     handleError
     ntnVersion
     ntnVersionData
     m
</span><a href="#local-6989586621679231614"><span class="hs-identifier hs-var">connectionManagerArguments'</span></a></span><span> </span><span class="annot"><span class="annottext">PrunePolicy ntnAddr (STM m)
forall (stm :: * -&gt; *) peerAddr.
(Applicative stm, Ord peerAddr) =&gt;
PrunePolicy peerAddr stm
</span><span class="hs-identifier hs-var">simplePrunePolicy</span></span><span class="hs-special">)</span><span>
</span><span id="line-874"></span><span>                 </span><span class="hs-comment">-- Server is not running, it will not be able to</span><span>
</span><span id="line-875"></span><span>                 </span><span class="hs-comment">-- advise which connections to prune.  It's also not</span><span>
</span><span id="line-876"></span><span>                 </span><span class="hs-comment">-- expected that the governor targets will be larger</span><span>
</span><span id="line-877"></span><span>                 </span><span class="hs-comment">-- than limits imposed by 'cmConnectionsLimits'.</span><span>
</span><span id="line-878"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SingMuxMode 'InitiatorMode
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundleWithExpandedCtx
        'InitiatorMode ntnAddr ByteString m a Void)
-&gt; ConnectionHandler
     'InitiatorMode
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     (Handle
        'InitiatorMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        Void)
     (HandleError 'InitiatorMode ntnVersion)
     (ntnVersion, ntnVersionData)
     m
forall (muxMode :: MuxMode) socket initiatorCtx responderCtx b c.
SingMuxMode muxMode
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundle
        muxMode initiatorCtx responderCtx ByteString m b c)
-&gt; MuxConnectionHandler
     muxMode
     socket
     initiatorCtx
     responderCtx
     ntnAddr
     ntnVersion
     ntnVersionData
     ByteString
     m
     b
     c
</span><a href="#local-6989586621679231625"><span class="hs-identifier hs-var">makeConnectionHandler'</span></a></span><span>
</span><span id="line-879"></span><span>                </span><span class="annot"><span class="annottext">SingMuxMode 'InitiatorMode
</span><span class="hs-identifier hs-var">SingInitiatorMode</span></span><span>
</span><span id="line-880"></span><span>                </span><span class="annot"><span class="annottext">Versions
  ntnVersion
  ntnVersionData
  (OuroborosBundleWithExpandedCtx
     'InitiatorMode ntnAddr ByteString m a Void)
</span><a href="#local-6989586621679231478"><span class="hs-identifier hs-var">daApplicationInitiatorMode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-881"></span><span>              </span><span class="annot"><span class="annottext">HandleError 'InitiatorMode ntnVersion -&gt; HandleErrorType
forall (muxMode :: MuxMode) versionNumber.
HandleError muxMode versionNumber -&gt; HandleErrorType
</span><span class="hs-identifier hs-var">classifyHandleError</span></span><span>
</span><span id="line-882"></span><span>              </span><span class="annot"><span class="annottext">InResponderMode
  'InitiatorMode
  (InformationChannel
     (NewConnectionInfo
        ntnAddr
        (Handle
           'InitiatorMode
           (ExpandedInitiatorContext ntnAddr m)
           (ResponderContext ntnAddr)
           ntnVersionData
           ByteString
           m
           a
           Void))
     m)
forall (mode :: MuxMode) a. InResponderMode mode a
</span><span class="hs-identifier hs-var">NotInResponderMode</span></span><span>
</span><span id="line-883"></span><span>              </span><span class="annot"><span class="annottext">InResponderMode
  'InitiatorMode
  (Maybe (InformationChannel (ntnAddr, PeerSharing) m))
forall (mode :: MuxMode) a. InResponderMode mode a
</span><span class="hs-identifier hs-var">NotInResponderMode</span></span><span>
</span><span id="line-884"></span><span>
</span><span id="line-885"></span><span>          </span><span id="local-6989586621679231644"><span class="annot"><span class="annottext">withConnectionManagerInitiatorAndResponderMode :: InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
-&gt; InformationChannel (ntnAddr, PeerSharing) m
-&gt; StrictTVar m InboundGovernorObservableState
-&gt; (ConnectionManager
      'InitiatorResponderMode
      ntnFd
      ntnAddr
      (Handle
         'InitiatorResponderMode
         (ExpandedInitiatorContext ntnAddr m)
         (ResponderContext ntnAddr)
         ntnVersionData
         ByteString
         m
         a
         ())
      (HandleError 'InitiatorResponderMode ntnVersion)
      m
    -&gt; m Void)
-&gt; m Void
</span><a href="#local-6989586621679231644"><span class="hs-identifier hs-var hs-var">withConnectionManagerInitiatorAndResponderMode</span></a></span></span><span>
</span><span id="line-886"></span><span>            </span><span id="local-6989586621679231645"><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><a href="#local-6989586621679231645"><span class="hs-identifier hs-var">inbndInfoChannel</span></a></span></span><span> </span><span id="local-6989586621679231646"><span class="annot"><span class="annottext">InformationChannel (ntnAddr, PeerSharing) m
</span><a href="#local-6989586621679231646"><span class="hs-identifier hs-var">outbndInfoChannel</span></a></span></span><span> </span><span id="local-6989586621679231647"><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231647"><span class="hs-identifier hs-var">observableStateVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-887"></span><span>              </span><span class="annot"><span class="annottext">ConnectionManagerArguments
  (ConnectionHandlerTrace ntnVersion ntnVersionData)
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  ntnVersion
  ntnVersionData
  m
-&gt; ConnectionHandler
     'InitiatorResponderMode
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ())
     (HandleError 'InitiatorResponderMode ntnVersion)
     (ntnVersion, ntnVersionData)
     m
-&gt; (HandleError 'InitiatorResponderMode ntnVersion
    -&gt; HandleErrorType)
-&gt; InResponderMode
     'InitiatorResponderMode
     (InformationChannel
        (NewConnectionInfo
           ntnAddr
           (Handle
              'InitiatorResponderMode
              (ExpandedInitiatorContext ntnAddr m)
              (ResponderContext ntnAddr)
              ntnVersionData
              ByteString
              m
              a
              ()))
        m)
-&gt; InResponderMode
     'InitiatorResponderMode
     (Maybe (InformationChannel (ntnAddr, PeerSharing) m))
-&gt; (ConnectionManager
      'InitiatorResponderMode
      ntnFd
      ntnAddr
      (Handle
         'InitiatorResponderMode
         (ExpandedInitiatorContext ntnAddr m)
         (ResponderContext ntnAddr)
         ntnVersionData
         ByteString
         m
         a
         ())
      (HandleError 'InitiatorResponderMode ntnVersion)
      m
    -&gt; m Void)
-&gt; m Void
forall (muxMode :: MuxMode) peerAddr socket handlerTrace handle
       handleError version versionData (m :: * -&gt; *) a.
(Alternative (STM m), MonadLabelledSTM m, MonadTraceSTM m,
 MonadFork m, MonadAsync m, MonadDelay m, MonadEvaluate m,
 MonadFix m, MonadMask m, MonadThrow (STM m), MonadTimer m,
 Ord peerAddr, Show peerAddr, Typeable peerAddr) =&gt;
ConnectionManagerArguments
  handlerTrace
  socket
  peerAddr
  handle
  handleError
  version
  versionData
  m
-&gt; ConnectionHandler
     muxMode
     handlerTrace
     socket
     peerAddr
     handle
     handleError
     (version, versionData)
     m
-&gt; (handleError -&gt; HandleErrorType)
-&gt; InResponderMode
     muxMode (InformationChannel (NewConnectionInfo peerAddr handle) m)
-&gt; InResponderMode
     muxMode (Maybe (InformationChannel (peerAddr, PeerSharing) m))
-&gt; (ConnectionManager muxMode socket peerAddr handle handleError m
    -&gt; m a)
-&gt; m a
</span><span class="hs-identifier hs-var">withConnectionManager</span></span><span>
</span><span id="line-888"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrunePolicy ntnAddr (STM m)
-&gt; ConnectionManagerArguments
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ())
     (HandleError 'InitiatorResponderMode ntnVersion)
     ntnVersion
     ntnVersionData
     m
forall handle handleError.
PrunePolicy ntnAddr (STM m)
-&gt; ConnectionManagerArguments
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     handle
     handleError
     ntnVersion
     ntnVersionData
     m
</span><a href="#local-6989586621679231614"><span class="hs-identifier hs-var">connectionManagerArguments'</span></a></span><span>
</span><span id="line-889"></span><span>                   </span><span class="annot"><span class="annottext">(PrunePolicy ntnAddr (STM m)
 -&gt; ConnectionManagerArguments
      (ConnectionHandlerTrace ntnVersion ntnVersionData)
      ntnFd
      ntnAddr
      (Handle
         'InitiatorResponderMode
         (ExpandedInitiatorContext ntnAddr m)
         (ResponderContext ntnAddr)
         ntnVersionData
         ByteString
         m
         a
         ())
      (HandleError 'InitiatorResponderMode ntnVersion)
      ntnVersion
      ntnVersionData
      m)
-&gt; PrunePolicy ntnAddr (STM m)
-&gt; ConnectionManagerArguments
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ())
     (HandleError 'InitiatorResponderMode ntnVersion)
     ntnVersion
     ntnVersionData
     m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
-&gt; PrunePolicy ntnAddr (STM m)
forall (m :: * -&gt; *) peerAddr.
(MonadSTM m, Ord peerAddr) =&gt;
StrictTVar m InboundGovernorObservableState
-&gt; PrunePolicy peerAddr (STM m)
</span><a href="Ouroboros.Network.Diffusion.Policies.html#prunePolicy"><span class="hs-identifier hs-var">Diffusion.Policies.prunePolicy</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231647"><span class="hs-identifier hs-var">observableStateVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-890"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SingMuxMode 'InitiatorResponderMode
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundleWithExpandedCtx
        'InitiatorResponderMode ntnAddr ByteString m a ())
-&gt; ConnectionHandler
     'InitiatorResponderMode
     (ConnectionHandlerTrace ntnVersion ntnVersionData)
     ntnFd
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ())
     (HandleError 'InitiatorResponderMode ntnVersion)
     (ntnVersion, ntnVersionData)
     m
forall (muxMode :: MuxMode) socket initiatorCtx responderCtx b c.
SingMuxMode muxMode
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundle
        muxMode initiatorCtx responderCtx ByteString m b c)
-&gt; MuxConnectionHandler
     muxMode
     socket
     initiatorCtx
     responderCtx
     ntnAddr
     ntnVersion
     ntnVersionData
     ByteString
     m
     b
     c
</span><a href="#local-6989586621679231625"><span class="hs-identifier hs-var">makeConnectionHandler'</span></a></span><span>
</span><span id="line-891"></span><span>                   </span><span class="annot"><span class="annottext">SingMuxMode 'InitiatorResponderMode
</span><span class="hs-identifier hs-var">SingInitiatorResponderMode</span></span><span>
</span><span id="line-892"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PeerSharingAmount -&gt; m [ntnAddr])
-&gt; Versions
     ntnVersion
     ntnVersionData
     (OuroborosBundleWithExpandedCtx
        'InitiatorResponderMode ntnAddr ByteString m a ())
</span><a href="#local-6989586621679231480"><span class="hs-identifier hs-var">daApplicationInitiatorResponderMode</span></a></span><span>
</span><span id="line-893"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM m (PublicPeerSelectionState ntnAddr)
-&gt; StrictTVar m StdGen -&gt; PeerSharingAmount -&gt; m [ntnAddr]
forall (m :: * -&gt; *) ntnAddr.
MonadSTM m =&gt;
STM m (PublicPeerSelectionState ntnAddr)
-&gt; StrictTVar m StdGen -&gt; PeerSharingAmount -&gt; m [ntnAddr]
</span><a href="Ouroboros.Network.Diffusion.P2P.html#computePeerSharingPeers"><span class="hs-identifier hs-var">computePeerSharingPeers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m (PublicPeerSelectionState ntnAddr)
-&gt; STM m (PublicPeerSelectionState ntnAddr)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m (PublicPeerSelectionState ntnAddr)
</span><a href="#local-6989586621679231613"><span class="hs-identifier hs-var">publicStateVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-894"></span><span>                       </span><span class="annot"><span class="annottext">StrictTVar m StdGen
</span><a href="#local-6989586621679231608"><span class="hs-identifier hs-var">peerSharingRngVar</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-895"></span><span>                </span><span class="annot"><span class="annottext">HandleError 'InitiatorResponderMode ntnVersion -&gt; HandleErrorType
forall (muxMode :: MuxMode) versionNumber.
HandleError muxMode versionNumber -&gt; HandleErrorType
</span><span class="hs-identifier hs-var">classifyHandleError</span></span><span>
</span><span id="line-896"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
-&gt; InResponderMode
     'InitiatorResponderMode
     (InformationChannel
        (NewConnectionInfo
           ntnAddr
           (Handle
              'InitiatorResponderMode
              (ExpandedInitiatorContext ntnAddr m)
              (ResponderContext ntnAddr)
              ntnVersionData
              ByteString
              m
              a
              ()))
        m)
forall (mode :: MuxMode) a.
(HasResponder mode ~ 'True) =&gt;
a -&gt; InResponderMode mode a
</span><span class="hs-identifier hs-var">InResponderMode</span></span><span> </span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><a href="#local-6989586621679231645"><span class="hs-identifier hs-var">inbndInfoChannel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-897"></span><span>                </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">PeerSharing
</span><a href="#local-6989586621679231471"><span class="hs-identifier hs-var">daOwnPeerSharing</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSharing -&gt; PeerSharing -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSharing
</span><span class="hs-identifier hs-var">PeerSharingDisabled</span></span><span>
</span><span id="line-898"></span><span>                   </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (InformationChannel (ntnAddr, PeerSharing) m)
-&gt; InResponderMode
     'InitiatorResponderMode
     (Maybe (InformationChannel (ntnAddr, PeerSharing) m))
forall (mode :: MuxMode) a.
(HasResponder mode ~ 'True) =&gt;
a -&gt; InResponderMode mode a
</span><span class="hs-identifier hs-var">InResponderMode</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InformationChannel (ntnAddr, PeerSharing) m
-&gt; Maybe (InformationChannel (ntnAddr, PeerSharing) m)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">InformationChannel (ntnAddr, PeerSharing) m
</span><a href="#local-6989586621679231646"><span class="hs-identifier hs-var">outbndInfoChannel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-899"></span><span>                   </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (InformationChannel (ntnAddr, PeerSharing) m)
-&gt; InResponderMode
     'InitiatorResponderMode
     (Maybe (InformationChannel (ntnAddr, PeerSharing) m))
forall (mode :: MuxMode) a.
(HasResponder mode ~ 'True) =&gt;
a -&gt; InResponderMode mode a
</span><span class="hs-identifier hs-var">InResponderMode</span></span><span> </span><span class="annot"><span class="annottext">Maybe (InformationChannel (ntnAddr, PeerSharing) m)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-902"></span><span>      </span><span class="hs-comment">-- peer state actions</span><span>
</span><span id="line-903"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-904"></span><span>      </span><span class="hs-comment">-- Peer state actions run a job pool in the background which</span><span>
</span><span id="line-905"></span><span>      </span><span class="hs-comment">-- tracks threads forked by 'PeerStateActions'</span><span>
</span><span id="line-906"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-907"></span><span>
</span><span id="line-908"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- | parameterized version of 'withPeerStateActions'</span><span>
</span><span id="line-909"></span><span>          </span><span class="annot"><a href="#local-6989586621679231651"><span class="hs-identifier hs-type">withPeerStateActions'</span></a></span><span>
</span><span id="line-910"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679230815"><span class="annot"><a href="#local-6989586621679230815"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxMode</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679230817"><span class="annot"><a href="#local-6989586621679230817"><span class="hs-identifier hs-type">responderCtx</span></a></span></span><span> </span><span id="local-6989586621679230816"><span class="annot"><a href="#local-6989586621679230816"><span class="hs-identifier hs-type">socket</span></a></span></span><span> </span><span id="local-6989586621679230818"><span class="annot"><a href="#local-6989586621679230818"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621679230822"><span class="annot"><a href="#local-6989586621679230822"><span class="hs-identifier hs-type">c</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-911"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">HasInitiator</span></span><span> </span><span class="annot"><a href="#local-6989586621679230815"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-type">True</span></a></span><span>
</span><span id="line-912"></span><span>            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxConnectionManager</span></span><span>
</span><span id="line-913"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230815"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230816"><span class="hs-identifier hs-type">socket</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ExpandedInitiatorContext</span></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230817"><span class="hs-identifier hs-type">responderCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230501"><span class="hs-identifier hs-type">ntnVersion</span></a></span><span>
</span><span id="line-915"></span><span>                 </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230513"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230818"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-916"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerStateActions"><span class="hs-identifier hs-type">Governor.PeerStateActions</span></a></span><span>
</span><span id="line-917"></span><span>                  </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-918"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerConnectionHandle"><span class="hs-identifier hs-type">PeerConnectionHandle</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230815"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230817"><span class="hs-identifier hs-type">responderCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-919"></span><span>                     </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/bytestring-0.11.5.2/src/Data.ByteString.Lazy.Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230513"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230818"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>                  </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-921"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230822"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230822"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-923"></span><span>          </span><span id="local-6989586621679231651"><span class="annot"><span class="annottext">withPeerStateActions' :: forall (muxMode :: MuxMode) responderCtx socket b c.
(HasInitiator muxMode ~ 'True) =&gt;
MuxConnectionManager
  muxMode
  socket
  (ExpandedInitiatorContext ntnAddr m)
  responderCtx
  ntnAddr
  ntnVersionData
  ntnVersion
  ByteString
  m
  a
  b
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         muxMode responderCtx ntnAddr ntnVersionData ByteString m a b)
      m
    -&gt; m c)
-&gt; m c
</span><a href="#local-6989586621679231651"><span class="hs-identifier hs-var hs-var">withPeerStateActions'</span></a></span></span><span> </span><span id="local-6989586621679231668"><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode
  socket
  (ExpandedInitiatorContext ntnAddr m)
  responderCtx
  ntnAddr
  ntnVersionData
  ntnVersion
  ByteString
  m
  a
  b
</span><a href="#local-6989586621679231668"><span class="hs-identifier hs-var">connectionManager</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-924"></span><span>            </span><span class="annot"><span class="annottext">PeerStateActionsArguments
  muxMode socket responderCtx ntnAddr ntnVersionData ntnVersion m a b
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         muxMode responderCtx ntnAddr ntnVersionData ByteString m a b)
      m
    -&gt; m c)
-&gt; m c
forall (muxMode :: MuxMode) socket responderCtx peerAddr
       versionData versionNumber (m :: * -&gt; *) a b x.
(Alternative (STM m), MonadAsync m, MonadCatch m,
 MonadLabelledSTM m, MonadMask m, MonadTimer m, MonadThrow (STM m),
 HasInitiator muxMode ~ 'True, Typeable versionNumber,
 Show versionNumber, Ord peerAddr, Typeable peerAddr,
 Show peerAddr) =&gt;
PeerStateActionsArguments
  muxMode
  socket
  responderCtx
  peerAddr
  versionData
  versionNumber
  m
  a
  b
-&gt; (PeerStateActions
      peerAddr
      (PeerConnectionHandle
         muxMode responderCtx peerAddr versionData ByteString m a b)
      m
    -&gt; m x)
-&gt; m x
</span><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#withPeerStateActions"><span class="hs-identifier hs-var">withPeerStateActions</span></a></span><span>
</span><span id="line-925"></span><span>              </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerStateActionsArguments"><span class="hs-identifier hs-type">PeerStateActionsArguments</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-926"></span><span>                    </span><span class="annot"><span class="annottext">spsTracer :: Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
</span><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#spsTracer"><span class="hs-identifier hs-var">spsTracer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (PeerSelectionActionsTrace ntnAddr ntnVersion)
</span><a href="#local-6989586621679231445"><span class="hs-identifier hs-var">dtPeerSelectionActionsTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-927"></span><span>                    </span><span class="annot"><span class="annottext">spsDeactivateTimeout :: DiffTime
</span><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#spsDeactivateTimeout"><span class="hs-identifier hs-var">spsDeactivateTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.Diffusion.Policies.html#deactivateTimeout"><span class="hs-identifier hs-var">Diffusion.Policies.deactivateTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-928"></span><span>                    </span><span class="annot"><span class="annottext">spsCloseConnectionTimeout :: DiffTime
</span><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#spsCloseConnectionTimeout"><span class="hs-identifier hs-var">spsCloseConnectionTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-929"></span><span>                      </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Ouroboros.Network.Diffusion.Policies.html#closeConnectionTimeout"><span class="hs-identifier hs-var">Diffusion.Policies.closeConnectionTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-930"></span><span>                    </span><span class="annot"><span class="annottext">spsConnectionManager :: MuxConnectionManager
  muxMode
  socket
  (ExpandedInitiatorContext ntnAddr m)
  responderCtx
  ntnAddr
  ntnVersionData
  ntnVersion
  ByteString
  m
  a
  b
</span><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#spsConnectionManager"><span class="hs-identifier hs-var">spsConnectionManager</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MuxConnectionManager
  muxMode
  socket
  (ExpandedInitiatorContext ntnAddr m)
  responderCtx
  ntnAddr
  ntnVersionData
  ntnVersion
  ByteString
  m
  a
  b
</span><a href="#local-6989586621679231668"><span class="hs-identifier hs-var">connectionManager</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-931"></span><span>                    </span><span class="annot"><span class="annottext">spsExitPolicy :: ExitPolicy a
</span><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#spsExitPolicy"><span class="hs-identifier hs-var">spsExitPolicy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExitPolicy a
</span><a href="#local-6989586621679231590"><span class="hs-identifier hs-var">exitPolicy</span></a></span><span>
</span><span id="line-932"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-933"></span><span>
</span><span id="line-934"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-935"></span><span>      </span><span class="hs-comment">-- Run peer selection (p2p governor)</span><span>
</span><span id="line-936"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-937"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679231677"><span class="hs-identifier hs-type">withPeerSelectionActions'</span></a></span><span>
</span><span id="line-938"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679230839"><span class="annot"><a href="#local-6989586621679230839"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span id="local-6989586621679230840"><span class="annot"><a href="#local-6989586621679230840"><span class="hs-identifier hs-type">responderCtx</span></a></span></span><span> </span><span id="local-6989586621679230841"><span class="annot"><a href="#local-6989586621679230841"><span class="hs-identifier hs-type">peerAddr</span></a></span></span><span> </span><span id="local-6989586621679230842"><span class="annot"><a href="#local-6989586621679230842"><span class="hs-identifier hs-type">bytes</span></a></span></span><span> </span><span id="local-6989586621679230843"><span class="annot"><a href="#local-6989586621679230843"><span class="hs-identifier hs-type">a1</span></a></span></span><span> </span><span id="local-6989586621679230844"><span class="annot"><a href="#local-6989586621679230844"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span id="local-6989586621679230846"><span class="annot"><a href="#local-6989586621679230846"><span class="hs-identifier hs-type">c</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-939"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerSharing</span></span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>            </span><span class="hs-comment">-- ^ Read New Inbound Connections</span><span>
</span><span id="line-941"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerStateActions"><span class="hs-identifier hs-type">PeerStateActions</span></a></span><span>
</span><span id="line-942"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-943"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerConnectionHandle"><span class="hs-identifier hs-type">PeerConnectionHandle</span></a></span><span>
</span><span id="line-944"></span><span>                    </span><span class="annot"><a href="#local-6989586621679230839"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230840"><span class="hs-identifier hs-type">responderCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230841"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230842"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230843"><span class="hs-identifier hs-type">a1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230844"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-945"></span><span>                 </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-946"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StdGen</span></span><span>
</span><span id="line-947"></span><span>            </span><span class="hs-comment">-- ^ Random generator for picking ledger peers</span><span>
</span><span id="line-948"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.html#LedgerPeersConsensusInterface"><span class="hs-identifier hs-type">LedgerPeersConsensusInterface</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-949"></span><span>            </span><span class="hs-comment">-- ^ Get Ledger Peers comes from here</span><span>
</span><span id="line-950"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.LedgerPeers.Common.html#UseLedgerAfter"><span class="hs-identifier hs-type">UseLedgerAfter</span></a></span><span>
</span><span id="line-951"></span><span>            </span><span class="hs-comment">-- ^ Get Use Ledger After value</span><span>
</span><span id="line-952"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-953"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PeerSelectionActions"><span class="hs-identifier hs-type">PeerSelectionActions</span></a></span><span>
</span><span id="line-954"></span><span>                     </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span>
</span><span id="line-955"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#PeerConnectionHandle"><span class="hs-identifier hs-type">PeerConnectionHandle</span></a></span><span>
</span><span id="line-956"></span><span>                        </span><span class="annot"><a href="#local-6989586621679230839"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230840"><span class="hs-identifier hs-type">responderCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230841"><span class="hs-identifier hs-type">peerAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230842"><span class="hs-identifier hs-type">bytes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230843"><span class="hs-identifier hs-type">a1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230844"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-957"></span><span>                      </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-958"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230846"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-959"></span><span>            </span><span class="hs-comment">-- ^ continuation, receives a handle to the local roots peer provider thread</span><span>
</span><span id="line-960"></span><span>            </span><span class="hs-comment">-- (only if local root peers were non-empty).</span><span>
</span><span id="line-961"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230846"><span class="hs-identifier hs-type">c</span></a></span><span>
</span><span id="line-962"></span><span>          </span><span id="local-6989586621679231677"><span class="annot"><span class="annottext">withPeerSelectionActions' :: forall (muxMode :: MuxMode) responderCtx peerAddr bytes a1 b c.
STM m (ntnAddr, PeerSharing)
-&gt; PeerStateActions
     ntnAddr
     (PeerConnectionHandle
        muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
     m
-&gt; StdGen
-&gt; LedgerPeersConsensusInterface m
-&gt; STM m UseLedgerAfter
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
         m
    -&gt; m c)
-&gt; m c
</span><a href="#local-6989586621679231677"><span class="hs-identifier hs-var hs-var">withPeerSelectionActions'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-963"></span><span>              </span><span class="annot"><span class="annottext">Tracer m (TraceLocalRootPeers ntnAddr resolverError)
-&gt; Tracer m TracePublicRootPeers
-&gt; Tracer m TraceLedgerPeers
-&gt; (IP -&gt; PortNumber -&gt; ntnAddr)
-&gt; DNSActions resolver resolverError m
-&gt; STM m PeerSelectionTargets
-&gt; STM
     m [(HotValency, WarmValency, Map RelayAccessPoint PeerAdvertise)]
-&gt; STM m (Map RelayAccessPoint PeerAdvertise)
-&gt; PeerSharing
-&gt; (PeerConnectionHandle
      muxMode responderCtx peerAddr ntnVersionData bytes m a1 b
    -&gt; PeerSharing)
-&gt; STM m (Map ntnAddr (PeerSharingController ntnAddr m))
-&gt; STM m (ntnAddr, PeerSharing)
-&gt; PeerStateActions
     ntnAddr
     (PeerConnectionHandle
        muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
     m
-&gt; StdGen
-&gt; LedgerPeersConsensusInterface m
-&gt; STM m UseLedgerAfter
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
         m
    -&gt; m c)
-&gt; m c
forall peeraddr peerconn resolver exception (m :: * -&gt; *) a.
(Alternative (STM m), MonadAsync m, MonadDelay m, MonadThrow m,
 MonadMVar m, Ord peeraddr, Exception exception) =&gt;
Tracer m (TraceLocalRootPeers peeraddr exception)
-&gt; Tracer m TracePublicRootPeers
-&gt; Tracer m TraceLedgerPeers
-&gt; (IP -&gt; PortNumber -&gt; peeraddr)
-&gt; DNSActions resolver exception m
-&gt; STM m PeerSelectionTargets
-&gt; STM
     m [(HotValency, WarmValency, Map RelayAccessPoint PeerAdvertise)]
-&gt; STM m (Map RelayAccessPoint PeerAdvertise)
-&gt; PeerSharing
-&gt; (peerconn -&gt; PeerSharing)
-&gt; STM m (Map peeraddr (PeerSharingController peeraddr m))
-&gt; STM m (peeraddr, PeerSharing)
-&gt; PeerStateActions peeraddr peerconn m
-&gt; StdGen
-&gt; LedgerPeersConsensusInterface m
-&gt; STM m UseLedgerAfter
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions peeraddr peerconn m -&gt; m a)
-&gt; m a
</span><a href="Ouroboros.Network.PeerSelection.PeerSelectionActions.html#withPeerSelectionActions"><span class="hs-identifier hs-var">withPeerSelectionActions</span></a></span><span>
</span><span id="line-964"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m (TraceLocalRootPeers ntnAddr resolverError)
</span><a href="#local-6989586621679231446"><span class="hs-identifier hs-var">dtTraceLocalRootPeersTracer</span></a></span><span>
</span><span id="line-965"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m TracePublicRootPeers
</span><a href="#local-6989586621679231447"><span class="hs-identifier hs-var">dtTracePublicRootPeersTracer</span></a></span><span>
</span><span id="line-966"></span><span>                  </span><span class="annot"><span class="annottext">Tracer m TraceLedgerPeers
</span><a href="#local-6989586621679231448"><span class="hs-identifier hs-var">dtTraceLedgerPeersTracer</span></a></span><span>
</span><span id="line-967"></span><span>                  </span><span class="annot"><span class="annottext">IP -&gt; PortNumber -&gt; ntnAddr
</span><a href="#local-6989586621679231426"><span class="hs-identifier hs-var">diNtnToPeerAddr</span></a></span><span>
</span><span id="line-968"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DNSLookupType -&gt; DNSActions resolver resolverError m
</span><a href="#local-6989586621679231433"><span class="hs-identifier hs-var">diDnsActions</span></a></span><span> </span><span class="annot"><span class="annottext">DNSLookupType
</span><a href="#local-6989586621679231601"><span class="hs-identifier hs-var">lookupReqs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-969"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m PeerSelectionTargets -&gt; STM m PeerSelectionTargets
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m PeerSelectionTargets
</span><a href="#local-6989586621679231610"><span class="hs-identifier hs-var">peerSelectionTargetsVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-970"></span><span>                  </span><span class="annot"><span class="annottext">STM
  m [(HotValency, WarmValency, Map RelayAccessPoint PeerAdvertise)]
</span><a href="#local-6989586621679231469"><span class="hs-identifier hs-var">daReadLocalRootPeers</span></a></span><span>
</span><span id="line-971"></span><span>                  </span><span class="annot"><span class="annottext">STM m (Map RelayAccessPoint PeerAdvertise)
</span><a href="#local-6989586621679231470"><span class="hs-identifier hs-var">daReadPublicRootPeers</span></a></span><span>
</span><span id="line-972"></span><span>                  </span><span class="annot"><span class="annottext">PeerSharing
</span><a href="#local-6989586621679231471"><span class="hs-identifier hs-var">daOwnPeerSharing</span></a></span><span>
</span><span id="line-973"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ntnVersionData -&gt; PeerSharing)
-&gt; PeerConnectionHandle
     muxMode responderCtx peerAddr ntnVersionData bytes m a1 b
-&gt; PeerSharing
forall versionData (muxMode :: MuxMode) responderCtx peerAddr bytes
       (m :: * -&gt; *) a b.
(versionData -&gt; PeerSharing)
-&gt; PeerConnectionHandle
     muxMode responderCtx peerAddr versionData bytes m a b
-&gt; PeerSharing
</span><a href="Ouroboros.Network.PeerSelection.PeerStateActions.html#pchPeerSharing"><span class="hs-identifier hs-var">pchPeerSharing</span></a></span><span> </span><span class="annot"><span class="annottext">ntnVersionData -&gt; PeerSharing
</span><a href="#local-6989586621679231425"><span class="hs-identifier hs-var">diNtnPeerSharing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-974"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StrictTVar m (Map ntnAddr (PeerSharingController ntnAddr m))
-&gt; STM m (Map ntnAddr (PeerSharingController ntnAddr m))
forall (m :: * -&gt; *) a. MonadSTM m =&gt; StrictTVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerSharingRegistry ntnAddr m
-&gt; StrictTVar m (Map ntnAddr (PeerSharingController ntnAddr m))
forall peer (m :: * -&gt; *).
PeerSharingRegistry peer m
-&gt; StrictTVar m (Map peer (PeerSharingController peer m))
</span><a href="Ouroboros.Network.PeerSharing.html#getPeerSharingRegistry"><span class="hs-identifier hs-var">getPeerSharingRegistry</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSharingRegistry ntnAddr m
</span><a href="#local-6989586621679231491"><span class="hs-identifier hs-var">daPeerSharingRegistry</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-975"></span><span>
</span><span id="line-976"></span><span>          </span><span class="annot"><a href="#local-6989586621679231689"><span class="hs-identifier hs-type">peerSelectionGovernor'</span></a></span><span>
</span><span id="line-977"></span><span>            </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679230871"><span class="annot"><a href="#local-6989586621679230871"><span class="hs-identifier hs-type">muxMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MuxMode</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679230872"><span class="annot"><a href="#local-6989586621679230872"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-978"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#DebugPeerSelection"><span class="hs-identifier hs-type">DebugPeerSelection</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-979"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodePeerSelectionActions"><span class="hs-identifier hs-type">NodeToNodePeerSelectionActions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230871"><span class="hs-identifier hs-type">muxMode</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230500"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230502"><span class="hs-identifier hs-type">ntnVersionData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230513"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230872"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-980"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230487"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-981"></span><span>          </span><span id="local-6989586621679231689"><span class="annot"><span class="annottext">peerSelectionGovernor' :: forall (muxMode :: MuxMode) b.
Tracer m (DebugPeerSelection ntnAddr)
-&gt; NodeToNodePeerSelectionActions
     muxMode ntnAddr ntnVersionData m a b
-&gt; m Void
</span><a href="#local-6989586621679231689"><span class="hs-identifier hs-var hs-var">peerSelectionGovernor'</span></a></span></span><span> </span><span id="local-6989586621679231699"><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
</span><a href="#local-6989586621679231699"><span class="hs-identifier hs-var">peerSelectionTracer</span></a></span></span><span> </span><span id="local-6989586621679231700"><span class="annot"><span class="annottext">NodeToNodePeerSelectionActions muxMode ntnAddr ntnVersionData m a b
</span><a href="#local-6989586621679231700"><span class="hs-identifier hs-var">peerSelectionActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-982"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (TracePeerSelection ntnAddr)
-&gt; Tracer m (DebugPeerSelection ntnAddr)
-&gt; Tracer m PeerSelectionCounters
-&gt; StdGen
-&gt; StrictTVar m (PublicPeerSelectionState ntnAddr)
-&gt; NodeToNodePeerSelectionActions
     muxMode ntnAddr ntnVersionData m a b
-&gt; PeerSelectionPolicy ntnAddr m
-&gt; m Void
forall (m :: * -&gt; *) peeraddr peerconn.
(Alternative (STM m), MonadAsync m, MonadDelay m,
 MonadLabelledSTM m, MonadMask m, MonadTimer m, Ord peeraddr,
 Show peerconn) =&gt;
Tracer m (TracePeerSelection peeraddr)
-&gt; Tracer m (DebugPeerSelection peeraddr)
-&gt; Tracer m PeerSelectionCounters
-&gt; StdGen
-&gt; StrictTVar m (PublicPeerSelectionState peeraddr)
-&gt; PeerSelectionActions peeraddr peerconn m
-&gt; PeerSelectionPolicy peeraddr m
-&gt; m Void
</span><a href="Ouroboros.Network.PeerSelection.Governor.html#peerSelectionGovernor"><span class="hs-identifier hs-var">Governor.peerSelectionGovernor</span></a></span><span>
</span><span id="line-983"></span><span>                </span><span class="annot"><span class="annottext">Tracer m (TracePeerSelection ntnAddr)
</span><a href="#local-6989586621679231441"><span class="hs-identifier hs-var">dtTracePeerSelectionTracer</span></a></span><span>
</span><span id="line-984"></span><span>                </span><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
</span><a href="#local-6989586621679231699"><span class="hs-identifier hs-var">peerSelectionTracer</span></a></span><span>
</span><span id="line-985"></span><span>                </span><span class="annot"><span class="annottext">Tracer m PeerSelectionCounters
</span><a href="#local-6989586621679231444"><span class="hs-identifier hs-var">dtTracePeerSelectionCounters</span></a></span><span>
</span><span id="line-986"></span><span>                </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231505"><span class="hs-identifier hs-var">fuzzRng</span></a></span><span>
</span><span id="line-987"></span><span>                </span><span class="annot"><span class="annottext">StrictTVar m (PublicPeerSelectionState ntnAddr)
</span><a href="#local-6989586621679231613"><span class="hs-identifier hs-var">publicStateVar</span></a></span><span>
</span><span id="line-988"></span><span>                </span><span class="annot"><span class="annottext">NodeToNodePeerSelectionActions muxMode ntnAddr ntnVersionData m a b
</span><a href="#local-6989586621679231700"><span class="hs-identifier hs-var">peerSelectionActions</span></a></span><span>
</span><span id="line-989"></span><span>                </span><span class="annot"><span class="annottext">PeerSelectionPolicy ntnAddr m
</span><a href="#local-6989586621679231621"><span class="hs-identifier hs-var">peerSelectionPolicy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-992"></span><span>      </span><span class="hs-comment">-- The peer churn governor:</span><span>
</span><span id="line-993"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-994"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679231702"><span class="annot"><span class="annottext">peerChurnGovernor' :: m Void
</span><a href="#local-6989586621679231702"><span class="hs-identifier hs-var hs-var">peerChurnGovernor'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (TracePeerSelection ntnAddr)
-&gt; DiffTime
-&gt; DiffTime
-&gt; DiffTime
-&gt; PeerMetrics m ntnAddr
-&gt; StrictTVar m ChurnMode
-&gt; StdGen
-&gt; STM m FetchMode
-&gt; PeerSelectionTargets
-&gt; StrictTVar m PeerSelectionTargets
-&gt; m Void
forall (m :: * -&gt; *) peeraddr.
(MonadSTM m, MonadDelay m) =&gt;
Tracer m (TracePeerSelection peeraddr)
-&gt; DiffTime
-&gt; DiffTime
-&gt; DiffTime
-&gt; PeerMetrics m peeraddr
-&gt; StrictTVar m ChurnMode
-&gt; StdGen
-&gt; STM m FetchMode
-&gt; PeerSelectionTargets
-&gt; StrictTVar m PeerSelectionTargets
-&gt; m Void
</span><a href="Ouroboros.Network.PeerSelection.Churn.html#peerChurnGovernor"><span class="hs-identifier hs-var">Governor.peerChurnGovernor</span></a></span><span>
</span><span id="line-995"></span><span>                                 </span><span class="annot"><span class="annottext">Tracer m (TracePeerSelection ntnAddr)
</span><a href="#local-6989586621679231441"><span class="hs-identifier hs-var">dtTracePeerSelectionTracer</span></a></span><span>
</span><span id="line-996"></span><span>                                 </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679231475"><span class="hs-identifier hs-var">daDeadlineChurnInterval</span></a></span><span>
</span><span id="line-997"></span><span>                                 </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679231476"><span class="hs-identifier hs-var">daBulkChurnInterval</span></a></span><span>
</span><span id="line-998"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerSelectionPolicy ntnAddr m -&gt; DiffTime
forall peeraddr (m :: * -&gt; *).
PeerSelectionPolicy peeraddr m -&gt; DiffTime
</span><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#policyPeerShareOverallTimeout"><span class="hs-identifier hs-var">policyPeerShareOverallTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSelectionPolicy ntnAddr m
</span><a href="#local-6989586621679231621"><span class="hs-identifier hs-var">peerSelectionPolicy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-999"></span><span>                                 </span><span class="annot"><span class="annottext">PeerMetrics m ntnAddr
</span><a href="#local-6989586621679231489"><span class="hs-identifier hs-var">daPeerMetrics</span></a></span><span>
</span><span id="line-1000"></span><span>                                 </span><span class="annot"><span class="annottext">StrictTVar m ChurnMode
</span><a href="#local-6989586621679231609"><span class="hs-identifier hs-var">churnModeVar</span></a></span><span>
</span><span id="line-1001"></span><span>                                 </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231503"><span class="hs-identifier hs-var">churnRng</span></a></span><span>
</span><span id="line-1002"></span><span>                                 </span><span class="annot"><span class="annottext">STM m FetchMode
</span><a href="#local-6989586621679231490"><span class="hs-identifier hs-var">daBlockFetchMode</span></a></span><span>
</span><span id="line-1003"></span><span>                                 </span><span class="annot"><span class="annottext">PeerSelectionTargets
</span><a href="#local-6989586621679231468"><span class="hs-identifier hs-var">daPeerSelectionTargets</span></a></span><span>
</span><span id="line-1004"></span><span>                                 </span><span class="annot"><span class="annottext">StrictTVar m PeerSelectionTargets
</span><a href="#local-6989586621679231610"><span class="hs-identifier hs-var">peerSelectionTargetsVar</span></a></span><span>
</span><span id="line-1005"></span><span>
</span><span id="line-1006"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1007"></span><span>      </span><span class="hs-comment">-- Two functions only used in InitiatorAndResponder mode</span><span>
</span><span id="line-1008"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1009"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-1010"></span><span>          </span><span class="hs-comment">-- create sockets</span><span>
</span><span id="line-1011"></span><span>          </span><span id="local-6989586621679231705"><span class="annot"><span class="annottext">withSockets' :: (NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m Void) -&gt; m Void
</span><a href="#local-6989586621679231705"><span class="hs-identifier hs-var hs-var">withSockets'</span></a></span></span><span> </span><span id="local-6989586621679231706"><span class="annot"><span class="annottext">NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m Void
</span><a href="#local-6989586621679231706"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1012"></span><span>            </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
-&gt; Snocket m ntnFd ntnAddr
-&gt; (ntnFd -&gt; ntnAddr -&gt; m ())
-&gt; (ntnFd -&gt; ntnAddr -&gt; m ())
-&gt; [Either ntnFd ntnAddr]
-&gt; (NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m Void)
-&gt; m Void
forall (m :: * -&gt; *) ntnFd ntnAddr ntcAddr a.
(MonadCatch m, Typeable ntnAddr, Show ntnAddr) =&gt;
Tracer m (DiffusionTracer ntnAddr ntcAddr)
-&gt; Snocket m ntnFd ntnAddr
-&gt; (ntnFd -&gt; ntnAddr -&gt; m ())
-&gt; (ntnFd -&gt; ntnAddr -&gt; m ())
-&gt; [Either ntnFd ntnAddr]
-&gt; (NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m a)
-&gt; m a
</span><a href="Ouroboros.Network.Diffusion.Utils.html#withSockets"><span class="hs-identifier hs-var">withSockets</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
</span><a href="#local-6989586621679231440"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr
</span><a href="#local-6989586621679231418"><span class="hs-identifier hs-var">diNtnSnocket</span></a></span><span>
</span><span id="line-1013"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679231708"><span class="annot"><span class="annottext">ntnFd
</span><a href="#local-6989586621679231708"><span class="hs-identifier hs-var">sock</span></a></span></span><span> </span><span id="local-6989586621679231709"><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231709"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ntnFd -&gt; Maybe ntnAddr -&gt; m ()
</span><a href="#local-6989586621679231420"><span class="hs-identifier hs-var">diNtnConfigureSocket</span></a></span><span> </span><span class="annot"><span class="annottext">ntnFd
</span><a href="#local-6989586621679231708"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ntnAddr -&gt; Maybe ntnAddr
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231709"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1014"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679231710"><span class="annot"><span class="annottext">ntnFd
</span><a href="#local-6989586621679231710"><span class="hs-identifier hs-var">sock</span></a></span></span><span> </span><span id="local-6989586621679231711"><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231711"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ntnFd -&gt; ntnAddr -&gt; m ()
</span><a href="#local-6989586621679231421"><span class="hs-identifier hs-var">diNtnConfigureSystemdSocket</span></a></span><span> </span><span class="annot"><span class="annottext">ntnFd
</span><a href="#local-6989586621679231710"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">ntnAddr
</span><a href="#local-6989586621679231711"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1015"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Maybe (Either ntnFd ntnAddr)] -&gt; [Either ntnFd ntnAddr]
forall a. [Maybe a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a></span><span>
</span><span id="line-1016"></span><span>                </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Maybe (Either ntnFd ntnAddr)
</span><a href="#local-6989586621679231458"><span class="hs-identifier hs-var">daIPv4Address</span></a></span><span>
</span><span id="line-1017"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Either ntnFd ntnAddr)
</span><a href="#local-6989586621679231460"><span class="hs-identifier hs-var">daIPv6Address</span></a></span><span>
</span><span id="line-1018"></span><span>                </span><span class="hs-special">]</span><span>
</span><span id="line-1019"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-1020"></span><span>              </span><span class="annot"><span class="annottext">NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m Void
</span><a href="#local-6989586621679231706"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1021"></span><span>
</span><span id="line-1022"></span><span>          </span><span class="hs-comment">-- run server</span><span>
</span><span id="line-1023"></span><span>          </span><span id="local-6989586621679231712"><span class="annot"><span class="annottext">serverRun' :: NonEmpty ntnFd
-&gt; ConnectionManager
     'InitiatorResponderMode
     ntnFd
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ())
     (HandleError 'InitiatorResponderMode ntnVersion)
     m
-&gt; InformationChannel
     (NewConnectionInfo
        ntnAddr
        (Handle
           'InitiatorResponderMode
           (ExpandedInitiatorContext ntnAddr m)
           (ResponderContext ntnAddr)
           ntnVersionData
           ByteString
           m
           a
           ()))
     m
-&gt; StrictTVar m InboundGovernorObservableState
-&gt; m Void
</span><a href="#local-6989586621679231712"><span class="hs-identifier hs-var hs-var">serverRun'</span></a></span></span><span> </span><span id="local-6989586621679231713"><span class="annot"><span class="annottext">NonEmpty ntnFd
</span><a href="#local-6989586621679231713"><span class="hs-identifier hs-var">sockets</span></a></span></span><span> </span><span id="local-6989586621679231714"><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
</span><a href="#local-6989586621679231714"><span class="hs-identifier hs-var">connectionManager</span></a></span></span><span> </span><span id="local-6989586621679231715"><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><a href="#local-6989586621679231715"><span class="hs-identifier hs-var">inboundInfoChannel</span></a></span></span><span> </span><span id="local-6989586621679231716"><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231716"><span class="hs-identifier hs-var">observableStateVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1024"></span><span>            </span><span class="annot"><span class="annottext">ServerArguments
  'InitiatorResponderMode
  ntnFd
  (ExpandedInitiatorContext ntnAddr m)
  ntnAddr
  ntnVersionData
  ntnVersion
  ByteString
  m
  a
  ()
-&gt; m Void
forall (muxMode :: MuxMode) socket initiatorCtx peerAddr
       versionData versionNumber (m :: * -&gt; *) a b.
(Alternative (STM m), MonadAsync m, MonadDelay m, MonadCatch m,
 MonadEvaluate m, MonadLabelledSTM m, MonadMask m,
 MonadThrow (STM m), MonadTime m, MonadTimer m,
 HasResponder muxMode ~ 'True, Ord peerAddr, Show peerAddr) =&gt;
ServerArguments
  muxMode
  socket
  initiatorCtx
  peerAddr
  versionData
  versionNumber
  ByteString
  m
  a
  b
-&gt; m Void
</span><span class="hs-identifier hs-var">Server.run</span></span><span>
</span><span id="line-1025"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">ServerArguments</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1026"></span><span>                  </span><span class="annot"><span class="annottext">serverSockets :: NonEmpty ntnFd
</span><span class="hs-identifier hs-var">serverSockets</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty ntnFd
</span><a href="#local-6989586621679231713"><span class="hs-identifier hs-var">sockets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1027"></span><span>                  </span><span class="annot"><span class="annottext">serverSnocket :: Snocket m ntnFd ntnAddr
</span><span class="hs-identifier hs-var">serverSnocket</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Snocket m ntnFd ntnAddr
</span><a href="#local-6989586621679231418"><span class="hs-identifier hs-var">diNtnSnocket</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1028"></span><span>                  </span><span class="annot"><span class="annottext">serverTracer :: Tracer m (ServerTrace ntnAddr)
</span><span class="hs-identifier hs-var">serverTracer</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (ServerTrace ntnAddr)
</span><a href="#local-6989586621679231451"><span class="hs-identifier hs-var">dtServerTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1029"></span><span>                  </span><span class="annot"><span class="annottext">serverTrTracer :: Tracer m (RemoteTransitionTrace ntnAddr)
</span><span class="hs-identifier hs-var">serverTrTracer</span></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (RemoteTransitionTrace ntnAddr)
</span><a href="#local-6989586621679231453"><span class="hs-identifier hs-var">dtInboundGovernorTransitionTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1030"></span><span>                  </span><span class="annot"><span class="annottext">serverInboundGovernorTracer :: Tracer m (InboundGovernorTrace ntnAddr)
</span><span class="hs-identifier hs-var">serverInboundGovernorTracer</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracer m (InboundGovernorTrace ntnAddr)
</span><a href="#local-6989586621679231452"><span class="hs-identifier hs-var">dtInboundGovernorTracer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1031"></span><span>                  </span><span class="annot"><span class="annottext">serverConnectionLimits :: AcceptedConnectionsLimit
</span><span class="hs-identifier hs-var">serverConnectionLimits</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AcceptedConnectionsLimit
</span><a href="#local-6989586621679231464"><span class="hs-identifier hs-var">daAcceptedConnectionsLimit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1032"></span><span>                  </span><span class="annot"><span class="annottext">serverConnectionManager :: ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
</span><span class="hs-identifier hs-var">serverConnectionManager</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
</span><a href="#local-6989586621679231714"><span class="hs-identifier hs-var">connectionManager</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1033"></span><span>                  </span><span class="annot"><span class="annottext">serverInboundIdleTimeout :: Maybe DiffTime
</span><span class="hs-identifier hs-var">serverInboundIdleTimeout</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; Maybe DiffTime
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679231473"><span class="hs-identifier hs-var">daProtocolIdleTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1034"></span><span>                  </span><span class="annot"><span class="annottext">serverInboundInfoChannel :: InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><span class="hs-identifier hs-var">serverInboundInfoChannel</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><a href="#local-6989586621679231715"><span class="hs-identifier hs-var">inboundInfoChannel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1035"></span><span>                  </span><span class="annot"><span class="annottext">serverObservableStateVar :: StrictTVar m InboundGovernorObservableState
</span><span class="hs-identifier hs-var">serverObservableStateVar</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231716"><span class="hs-identifier hs-var">observableStateVar</span></a></span><span>
</span><span id="line-1036"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-1037"></span><span>
</span><span id="line-1038"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1039"></span><span>      </span><span class="hs-comment">-- Part (b): capturing the major control-flow of runM:</span><span>
</span><span id="line-1040"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-1041"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DiffusionMode
</span><a href="#local-6989586621679231467"><span class="hs-identifier hs-var">diffusionMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1042"></span><span>
</span><span id="line-1043"></span><span>        </span><span class="hs-comment">-- InitiatorOnly mode, run peer selection only:</span><span>
</span><span id="line-1044"></span><span>        </span><span class="annot"><span class="annottext">DiffusionMode
</span><span class="hs-identifier hs-var">InitiatorOnlyDiffusionMode</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1045"></span><span>          </span><span class="annot"><span class="annottext">(ConnectionManager
   'InitiatorMode
   ntnFd
   ntnAddr
   (Handle
      'InitiatorMode
      (ExpandedInitiatorContext ntnAddr m)
      (ResponderContext ntnAddr)
      ntnVersionData
      ByteString
      m
      a
      Void)
   (HandleError 'InitiatorMode ntnVersion)
   m
 -&gt; m Void)
-&gt; m Void
</span><a href="#local-6989586621679231640"><span class="hs-identifier hs-var">withConnectionManagerInitiatorOnlyMode</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManager
    'InitiatorMode
    ntnFd
    ntnAddr
    (Handle
       'InitiatorMode
       (ExpandedInitiatorContext ntnAddr m)
       (ResponderContext ntnAddr)
       ntnVersionData
       ByteString
       m
       a
       Void)
    (HandleError 'InitiatorMode ntnVersion)
    m
  -&gt; m Void)
 -&gt; m Void)
-&gt; (ConnectionManager
      'InitiatorMode
      ntnFd
      ntnAddr
      (Handle
         'InitiatorMode
         (ExpandedInitiatorContext ntnAddr m)
         (ResponderContext ntnAddr)
         ntnVersionData
         ByteString
         m
         a
         Void)
      (HandleError 'InitiatorMode ntnVersion)
      m
    -&gt; m Void)
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231718"><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     Void)
  (HandleError 'InitiatorMode ntnVersion)
  m
</span><a href="#local-6989586621679231718"><span class="hs-identifier hs-var">connectionManager</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1046"></span><span>          </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     Void)
  (HandleError 'InitiatorMode ntnVersion)
  m
-&gt; m ()
forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode ntnFd ntnAddr ntnVersionData ntnVersion m x y
-&gt; m ()
</span><a href="#local-6989586621679231432"><span class="hs-identifier hs-var">diInstallSigUSR1Handler</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     Void)
  (HandleError 'InitiatorMode ntnVersion)
  m
</span><a href="#local-6989586621679231718"><span class="hs-identifier hs-var">connectionManager</span></a></span><span>
</span><span id="line-1047"></span><span>          </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     Void)
  (HandleError 'InitiatorMode ntnVersion)
  m
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         'InitiatorMode
         (ResponderContext ntnAddr)
         ntnAddr
         ntnVersionData
         ByteString
         m
         a
         Void)
      m
    -&gt; m Void)
-&gt; m Void
forall (muxMode :: MuxMode) responderCtx socket b c.
(HasInitiator muxMode ~ 'True) =&gt;
MuxConnectionManager
  muxMode
  socket
  (ExpandedInitiatorContext ntnAddr m)
  responderCtx
  ntnAddr
  ntnVersionData
  ntnVersion
  ByteString
  m
  a
  b
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         muxMode responderCtx ntnAddr ntnVersionData ByteString m a b)
      m
    -&gt; m c)
-&gt; m c
</span><a href="#local-6989586621679231651"><span class="hs-identifier hs-var">withPeerStateActions'</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     Void)
  (HandleError 'InitiatorMode ntnVersion)
  m
</span><a href="#local-6989586621679231718"><span class="hs-identifier hs-var">connectionManager</span></a></span><span> </span><span class="annot"><span class="annottext">((PeerStateActions
    ntnAddr
    (PeerConnectionHandle
       'InitiatorMode
       (ResponderContext ntnAddr)
       ntnAddr
       ntnVersionData
       ByteString
       m
       a
       Void)
    m
  -&gt; m Void)
 -&gt; m Void)
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         'InitiatorMode
         (ResponderContext ntnAddr)
         ntnAddr
         ntnVersionData
         ByteString
         m
         a
         Void)
      m
    -&gt; m Void)
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231719"><span class="annot"><span class="annottext">PeerStateActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     Void)
  m
</span><a href="#local-6989586621679231719"><span class="hs-identifier hs-var">peerStateActions</span></a></span></span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1048"></span><span>            </span><span class="annot"><span class="annottext">STM m (ntnAddr, PeerSharing)
-&gt; PeerStateActions
     ntnAddr
     (PeerConnectionHandle
        'InitiatorMode
        (ResponderContext ntnAddr)
        ntnAddr
        ntnVersionData
        ByteString
        m
        a
        Void)
     m
-&gt; StdGen
-&gt; LedgerPeersConsensusInterface m
-&gt; STM m UseLedgerAfter
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            'InitiatorMode
            (ResponderContext ntnAddr)
            ntnAddr
            ntnVersionData
            ByteString
            m
            a
            Void)
         m
    -&gt; m Void)
-&gt; m Void
forall (muxMode :: MuxMode) responderCtx peerAddr bytes a1 b c.
STM m (ntnAddr, PeerSharing)
-&gt; PeerStateActions
     ntnAddr
     (PeerConnectionHandle
        muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
     m
-&gt; StdGen
-&gt; LedgerPeersConsensusInterface m
-&gt; STM m UseLedgerAfter
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
         m
    -&gt; m c)
-&gt; m c
</span><a href="#local-6989586621679231677"><span class="hs-identifier hs-var">withPeerSelectionActions'</span></a></span><span>
</span><span id="line-1049"></span><span>              </span><span class="annot"><span class="annottext">STM m (ntnAddr, PeerSharing)
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-1050"></span><span>              </span><span class="annot"><span class="annottext">PeerStateActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     Void)
  m
</span><a href="#local-6989586621679231719"><span class="hs-identifier hs-var">peerStateActions</span></a></span><span>
</span><span id="line-1051"></span><span>              </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231499"><span class="hs-identifier hs-var">ledgerPeersRng</span></a></span><span>
</span><span id="line-1052"></span><span>              </span><span class="annot"><span class="annottext">LedgerPeersConsensusInterface m
</span><a href="#local-6989586621679231484"><span class="hs-identifier hs-var">daLedgerPeersCtx</span></a></span><span>
</span><span id="line-1053"></span><span>              </span><span class="annot"><span class="annottext">STM m UseLedgerAfter
</span><a href="#local-6989586621679231472"><span class="hs-identifier hs-var">daReadUseLedgerAfter</span></a></span><span>
</span><span id="line-1054"></span><span>                </span><span class="annot"><span class="annottext">(((Async m Void, Async m Void)
  -&gt; PeerSelectionActions
       ntnAddr
       (PeerConnectionHandle
          'InitiatorMode
          (ResponderContext ntnAddr)
          ntnAddr
          ntnVersionData
          ByteString
          m
          a
          Void)
       m
  -&gt; m Void)
 -&gt; m Void)
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            'InitiatorMode
            (ResponderContext ntnAddr)
            ntnAddr
            ntnVersionData
            ByteString
            m
            a
            Void)
         m
    -&gt; m Void)
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679231721"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231721"><span class="hs-identifier hs-var">ledgerPeersThread</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231722"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231722"><span class="hs-identifier hs-var">localRootPeersProvider</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679231723"><span class="annot"><span class="annottext">PeerSelectionActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     Void)
  m
</span><a href="#local-6989586621679231723"><span class="hs-identifier hs-var">peerSelectionActions</span></a></span></span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1055"></span><span>
</span><span id="line-1056"></span><span>               </span><span class="annot"><span class="annottext">m Void -&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. m a -&gt; (Async m a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">Async.withAsync</span></span><span>
</span><span id="line-1057"></span><span>                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
-&gt; PeerSelectionActions
     ntnAddr
     (PeerConnectionHandle
        'InitiatorMode
        (ResponderContext ntnAddr)
        ntnAddr
        ntnVersionData
        ByteString
        m
        a
        Void)
     m
-&gt; m Void
forall (muxMode :: MuxMode) b.
Tracer m (DebugPeerSelection ntnAddr)
-&gt; NodeToNodePeerSelectionActions
     muxMode ntnAddr ntnVersionData m a b
-&gt; m Void
</span><a href="#local-6989586621679231689"><span class="hs-identifier hs-var">peerSelectionGovernor'</span></a></span><span>
</span><span id="line-1058"></span><span>                    </span><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
</span><a href="#local-6989586621679231442"><span class="hs-identifier hs-var">dtDebugPeerSelectionInitiatorTracer</span></a></span><span>
</span><span id="line-1059"></span><span>                    </span><span class="annot"><span class="annottext">PeerSelectionActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     Void)
  m
</span><a href="#local-6989586621679231723"><span class="hs-identifier hs-var">peerSelectionActions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1060"></span><span>               </span><span class="annot"><span class="annottext">((Async m Void -&gt; m Void) -&gt; m Void)
-&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231724"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231724"><span class="hs-identifier hs-var">governorThread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1061"></span><span>               </span><span class="annot"><span class="annottext">m Void -&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. m a -&gt; (Async m a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">Async.withAsync</span></span><span> </span><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621679231702"><span class="hs-identifier hs-var">peerChurnGovernor'</span></a></span><span> </span><span class="annot"><span class="annottext">((Async m Void -&gt; m Void) -&gt; m Void)
-&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231725"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231725"><span class="hs-identifier hs-var">churnGovernorThread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1062"></span><span>            </span><span class="hs-comment">-- wait for any thread to fail:</span><span>
</span><span id="line-1063"></span><span>            </span><span class="annot"><span class="annottext">(Async m Void, Void) -&gt; Void
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((Async m Void, Void) -&gt; Void) -&gt; m (Async m Void, Void) -&gt; m Void
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Async m Void] -&gt; m (Async m Void, Void)
forall a. [Async m a] -&gt; m (Async m a, a)
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
[Async m a] -&gt; m (Async m a, a)
</span><span class="hs-identifier hs-var">Async.waitAny</span></span><span>
</span><span id="line-1064"></span><span>               </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231721"><span class="hs-identifier hs-var">ledgerPeersThread</span></a></span><span>
</span><span id="line-1065"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231722"><span class="hs-identifier hs-var">localRootPeersProvider</span></a></span><span>
</span><span id="line-1066"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231724"><span class="hs-identifier hs-var">governorThread</span></a></span><span>
</span><span id="line-1067"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231725"><span class="hs-identifier hs-var">churnGovernorThread</span></a></span><span>
</span><span id="line-1068"></span><span>               </span><span class="hs-special">]</span><span>
</span><span id="line-1069"></span><span>
</span><span id="line-1070"></span><span>        </span><span class="hs-comment">-- InitiatorAndResponder mode, run peer selection and the server:</span><span>
</span><span id="line-1071"></span><span>        </span><span class="annot"><span class="annottext">DiffusionMode
</span><span class="hs-identifier hs-var">InitiatorAndResponderDiffusionMode</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1072"></span><span>          </span><span id="local-6989586621679231729"><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><a href="#local-6989586621679231729"><span class="hs-identifier hs-var">inboundInfoChannel</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (InformationChannel
     (NewConnectionInfo
        ntnAddr
        (Handle
           'InitiatorResponderMode
           (ExpandedInitiatorContext ntnAddr m)
           (ResponderContext ntnAddr)
           ntnVersionData
           ByteString
           m
           a
           ()))
     m)
forall a (m :: * -&gt; *).
MonadLabelledSTM m =&gt;
m (InformationChannel a m)
</span><span class="hs-identifier hs-var">newInformationChannel</span></span><span>
</span><span id="line-1073"></span><span>          </span><span id="local-6989586621679231730"><span class="annot"><span class="annottext">InformationChannel (ntnAddr, PeerSharing) m
</span><a href="#local-6989586621679231730"><span class="hs-identifier hs-var">outboundInfoChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (InformationChannel (ntnAddr, PeerSharing) m)
forall a (m :: * -&gt; *).
MonadLabelledSTM m =&gt;
m (InformationChannel a m)
</span><span class="hs-identifier hs-var">newInformationChannel</span></span><span>
</span><span id="line-1074"></span><span>          </span><span id="local-6989586621679231731"><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231731"><span class="hs-identifier hs-var">observableStateVar</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; m (StrictTVar m InboundGovernorObservableState)
forall (m :: * -&gt; *).
MonadLabelledSTM m =&gt;
StdGen -&gt; m (StrictTVar m InboundGovernorObservableState)
</span><span class="hs-identifier hs-var">Server.newObservableStateVar</span></span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231507"><span class="hs-identifier hs-var">ntnInbgovRng</span></a></span><span>
</span><span id="line-1075"></span><span>          </span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
-&gt; InformationChannel (ntnAddr, PeerSharing) m
-&gt; StrictTVar m InboundGovernorObservableState
-&gt; (ConnectionManager
      'InitiatorResponderMode
      ntnFd
      ntnAddr
      (Handle
         'InitiatorResponderMode
         (ExpandedInitiatorContext ntnAddr m)
         (ResponderContext ntnAddr)
         ntnVersionData
         ByteString
         m
         a
         ())
      (HandleError 'InitiatorResponderMode ntnVersion)
      m
    -&gt; m Void)
-&gt; m Void
</span><a href="#local-6989586621679231644"><span class="hs-identifier hs-var">withConnectionManagerInitiatorAndResponderMode</span></a></span><span>
</span><span id="line-1076"></span><span>            </span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><a href="#local-6989586621679231729"><span class="hs-identifier hs-var">inboundInfoChannel</span></a></span><span> </span><span class="annot"><span class="annottext">InformationChannel (ntnAddr, PeerSharing) m
</span><a href="#local-6989586621679231730"><span class="hs-identifier hs-var">outboundInfoChannel</span></a></span><span>
</span><span id="line-1077"></span><span>            </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231731"><span class="hs-identifier hs-var">observableStateVar</span></a></span><span> </span><span class="annot"><span class="annottext">((ConnectionManager
    'InitiatorResponderMode
    ntnFd
    ntnAddr
    (Handle
       'InitiatorResponderMode
       (ExpandedInitiatorContext ntnAddr m)
       (ResponderContext ntnAddr)
       ntnVersionData
       ByteString
       m
       a
       ())
    (HandleError 'InitiatorResponderMode ntnVersion)
    m
  -&gt; m Void)
 -&gt; m Void)
-&gt; (ConnectionManager
      'InitiatorResponderMode
      ntnFd
      ntnAddr
      (Handle
         'InitiatorResponderMode
         (ExpandedInitiatorContext ntnAddr m)
         (ResponderContext ntnAddr)
         ntnVersionData
         ByteString
         m
         a
         ())
      (HandleError 'InitiatorResponderMode ntnVersion)
      m
    -&gt; m Void)
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231732"><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
</span><a href="#local-6989586621679231732"><span class="hs-identifier hs-var">connectionManager</span></a></span></span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1078"></span><span>            </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
-&gt; m ()
forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode ntnFd ntnAddr ntnVersionData ntnVersion m x y
-&gt; m ()
</span><a href="#local-6989586621679231432"><span class="hs-identifier hs-var">diInstallSigUSR1Handler</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
</span><a href="#local-6989586621679231732"><span class="hs-identifier hs-var">connectionManager</span></a></span><span>
</span><span id="line-1079"></span><span>            </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         'InitiatorResponderMode
         (ResponderContext ntnAddr)
         ntnAddr
         ntnVersionData
         ByteString
         m
         a
         ())
      m
    -&gt; m Void)
-&gt; m Void
forall (muxMode :: MuxMode) responderCtx socket b c.
(HasInitiator muxMode ~ 'True) =&gt;
MuxConnectionManager
  muxMode
  socket
  (ExpandedInitiatorContext ntnAddr m)
  responderCtx
  ntnAddr
  ntnVersionData
  ntnVersion
  ByteString
  m
  a
  b
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         muxMode responderCtx ntnAddr ntnVersionData ByteString m a b)
      m
    -&gt; m c)
-&gt; m c
</span><a href="#local-6989586621679231651"><span class="hs-identifier hs-var">withPeerStateActions'</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
</span><a href="#local-6989586621679231732"><span class="hs-identifier hs-var">connectionManager</span></a></span><span> </span><span class="annot"><span class="annottext">((PeerStateActions
    ntnAddr
    (PeerConnectionHandle
       'InitiatorResponderMode
       (ResponderContext ntnAddr)
       ntnAddr
       ntnVersionData
       ByteString
       m
       a
       ())
    m
  -&gt; m Void)
 -&gt; m Void)
-&gt; (PeerStateActions
      ntnAddr
      (PeerConnectionHandle
         'InitiatorResponderMode
         (ResponderContext ntnAddr)
         ntnAddr
         ntnVersionData
         ByteString
         m
         a
         ())
      m
    -&gt; m Void)
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231733"><span class="annot"><span class="annottext">PeerStateActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorResponderMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     ())
  m
</span><a href="#local-6989586621679231733"><span class="hs-identifier hs-var">peerStateActions</span></a></span></span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1080"></span><span>              </span><span class="annot"><span class="annottext">STM m (ntnAddr, PeerSharing)
-&gt; PeerStateActions
     ntnAddr
     (PeerConnectionHandle
        'InitiatorResponderMode
        (ResponderContext ntnAddr)
        ntnAddr
        ntnVersionData
        ByteString
        m
        a
        ())
     m
-&gt; StdGen
-&gt; LedgerPeersConsensusInterface m
-&gt; STM m UseLedgerAfter
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            'InitiatorResponderMode
            (ResponderContext ntnAddr)
            ntnAddr
            ntnVersionData
            ByteString
            m
            a
            ())
         m
    -&gt; m Void)
-&gt; m Void
forall (muxMode :: MuxMode) responderCtx peerAddr bytes a1 b c.
STM m (ntnAddr, PeerSharing)
-&gt; PeerStateActions
     ntnAddr
     (PeerConnectionHandle
        muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
     m
-&gt; StdGen
-&gt; LedgerPeersConsensusInterface m
-&gt; STM m UseLedgerAfter
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            muxMode responderCtx peerAddr ntnVersionData bytes m a1 b)
         m
    -&gt; m c)
-&gt; m c
</span><a href="#local-6989586621679231677"><span class="hs-identifier hs-var">withPeerSelectionActions'</span></a></span><span>
</span><span id="line-1081"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InformationChannel (ntnAddr, PeerSharing) m
-&gt; STM m (ntnAddr, PeerSharing)
forall a (m :: * -&gt; *). InformationChannel a m -&gt; STM m a
</span><span class="hs-identifier hs-var">readMessage</span></span><span> </span><span class="annot"><span class="annottext">InformationChannel (ntnAddr, PeerSharing) m
</span><a href="#local-6989586621679231730"><span class="hs-identifier hs-var">outboundInfoChannel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1082"></span><span>                </span><span class="annot"><span class="annottext">PeerStateActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorResponderMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     ())
  m
</span><a href="#local-6989586621679231733"><span class="hs-identifier hs-var">peerStateActions</span></a></span><span>
</span><span id="line-1083"></span><span>                </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231499"><span class="hs-identifier hs-var">ledgerPeersRng</span></a></span><span>
</span><span id="line-1084"></span><span>                </span><span class="annot"><span class="annottext">LedgerPeersConsensusInterface m
</span><a href="#local-6989586621679231484"><span class="hs-identifier hs-var">daLedgerPeersCtx</span></a></span><span>
</span><span id="line-1085"></span><span>                </span><span class="annot"><span class="annottext">STM m UseLedgerAfter
</span><a href="#local-6989586621679231472"><span class="hs-identifier hs-var">daReadUseLedgerAfter</span></a></span><span>
</span><span id="line-1086"></span><span>                  </span><span class="annot"><span class="annottext">(((Async m Void, Async m Void)
  -&gt; PeerSelectionActions
       ntnAddr
       (PeerConnectionHandle
          'InitiatorResponderMode
          (ResponderContext ntnAddr)
          ntnAddr
          ntnVersionData
          ByteString
          m
          a
          ())
       m
  -&gt; m Void)
 -&gt; m Void)
-&gt; ((Async m Void, Async m Void)
    -&gt; PeerSelectionActions
         ntnAddr
         (PeerConnectionHandle
            'InitiatorResponderMode
            (ResponderContext ntnAddr)
            ntnAddr
            ntnVersionData
            ByteString
            m
            a
            ())
         m
    -&gt; m Void)
-&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679231735"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231735"><span class="hs-identifier hs-var">ledgerPeersThread</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679231736"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231736"><span class="hs-identifier hs-var">localRootPeersProvider</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679231737"><span class="annot"><span class="annottext">PeerSelectionActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorResponderMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     ())
  m
</span><a href="#local-6989586621679231737"><span class="hs-identifier hs-var">peerSelectionActions</span></a></span></span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1087"></span><span>              </span><span class="annot"><span class="annottext">m Void -&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. m a -&gt; (Async m a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">Async.withAsync</span></span><span>
</span><span id="line-1088"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
-&gt; PeerSelectionActions
     ntnAddr
     (PeerConnectionHandle
        'InitiatorResponderMode
        (ResponderContext ntnAddr)
        ntnAddr
        ntnVersionData
        ByteString
        m
        a
        ())
     m
-&gt; m Void
forall (muxMode :: MuxMode) b.
Tracer m (DebugPeerSelection ntnAddr)
-&gt; NodeToNodePeerSelectionActions
     muxMode ntnAddr ntnVersionData m a b
-&gt; m Void
</span><a href="#local-6989586621679231689"><span class="hs-identifier hs-var">peerSelectionGovernor'</span></a></span><span>
</span><span id="line-1089"></span><span>                   </span><span class="annot"><span class="annottext">Tracer m (DebugPeerSelection ntnAddr)
</span><a href="#local-6989586621679231443"><span class="hs-identifier hs-var">dtDebugPeerSelectionInitiatorResponderTracer</span></a></span><span>
</span><span id="line-1090"></span><span>                   </span><span class="annot"><span class="annottext">PeerSelectionActions
  ntnAddr
  (PeerConnectionHandle
     'InitiatorResponderMode
     (ResponderContext ntnAddr)
     ntnAddr
     ntnVersionData
     ByteString
     m
     a
     ())
  m
</span><a href="#local-6989586621679231737"><span class="hs-identifier hs-var">peerSelectionActions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Async m Void -&gt; m Void) -&gt; m Void)
-&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231738"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231738"><span class="hs-identifier hs-var">governorThread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1091"></span><span>              </span><span class="hs-comment">-- begin, unique to InitiatorAndResponder mode:</span><span>
</span><span id="line-1092"></span><span>              </span><span class="annot"><span class="annottext">(NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m Void) -&gt; m Void
</span><a href="#local-6989586621679231705"><span class="hs-identifier hs-var">withSockets'</span></a></span><span> </span><span class="annot"><span class="annottext">((NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m Void) -&gt; m Void)
-&gt; (NonEmpty ntnFd -&gt; NonEmpty ntnAddr -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231739"><span class="annot"><span class="annottext">NonEmpty ntnFd
</span><a href="#local-6989586621679231739"><span class="hs-identifier hs-var">sockets</span></a></span></span><span> </span><span id="local-6989586621679231740"><span class="annot"><span class="annottext">NonEmpty ntnAddr
</span><a href="#local-6989586621679231740"><span class="hs-identifier hs-var">addresses</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1093"></span><span>              </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
-&gt; DiffusionTracer ntnAddr ntcAddr -&gt; m ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer m (DiffusionTracer ntnAddr ntcAddr)
</span><a href="#local-6989586621679231440"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty ntnAddr -&gt; DiffusionTracer ntnAddr ntcAddr
forall ntnAddr ntcAddr.
NonEmpty ntnAddr -&gt; DiffusionTracer ntnAddr ntcAddr
</span><a href="Ouroboros.Network.Diffusion.Common.html#RunServer"><span class="hs-identifier hs-var">RunServer</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ntnAddr
</span><a href="#local-6989586621679231740"><span class="hs-identifier hs-var">addresses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1094"></span><span>              </span><span class="annot"><span class="annottext">m Void -&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. m a -&gt; (Async m a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">Async.withAsync</span></span><span>
</span><span id="line-1095"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty ntnFd
-&gt; ConnectionManager
     'InitiatorResponderMode
     ntnFd
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ())
     (HandleError 'InitiatorResponderMode ntnVersion)
     m
-&gt; InformationChannel
     (NewConnectionInfo
        ntnAddr
        (Handle
           'InitiatorResponderMode
           (ExpandedInitiatorContext ntnAddr m)
           (ResponderContext ntnAddr)
           ntnVersionData
           ByteString
           m
           a
           ()))
     m
-&gt; StrictTVar m InboundGovernorObservableState
-&gt; m Void
</span><a href="#local-6989586621679231712"><span class="hs-identifier hs-var">serverRun'</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ntnFd
</span><a href="#local-6989586621679231739"><span class="hs-identifier hs-var">sockets</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionManager
  'InitiatorResponderMode
  ntnFd
  ntnAddr
  (Handle
     'InitiatorResponderMode
     (ExpandedInitiatorContext ntnAddr m)
     (ResponderContext ntnAddr)
     ntnVersionData
     ByteString
     m
     a
     ())
  (HandleError 'InitiatorResponderMode ntnVersion)
  m
</span><a href="#local-6989586621679231732"><span class="hs-identifier hs-var">connectionManager</span></a></span><span> </span><span class="annot"><span class="annottext">InformationChannel
  (NewConnectionInfo
     ntnAddr
     (Handle
        'InitiatorResponderMode
        (ExpandedInitiatorContext ntnAddr m)
        (ResponderContext ntnAddr)
        ntnVersionData
        ByteString
        m
        a
        ()))
  m
</span><a href="#local-6989586621679231729"><span class="hs-identifier hs-var">inboundInfoChannel</span></a></span><span>
</span><span id="line-1096"></span><span>                 </span><span class="annot"><span class="annottext">StrictTVar m InboundGovernorObservableState
</span><a href="#local-6989586621679231731"><span class="hs-identifier hs-var">observableStateVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Async m Void -&gt; m Void) -&gt; m Void)
-&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231742"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231742"><span class="hs-identifier hs-var">serverThread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1097"></span><span>              </span><span class="hs-comment">-- end, unique to ...</span><span>
</span><span id="line-1098"></span><span>                </span><span class="annot"><span class="annottext">m Void -&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. m a -&gt; (Async m a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b.
MonadAsync m =&gt;
m a -&gt; (Async m a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">Async.withAsync</span></span><span> </span><span class="annot"><span class="annottext">m Void
</span><a href="#local-6989586621679231702"><span class="hs-identifier hs-var">peerChurnGovernor'</span></a></span><span> </span><span class="annot"><span class="annottext">((Async m Void -&gt; m Void) -&gt; m Void)
-&gt; (Async m Void -&gt; m Void) -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231743"><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231743"><span class="hs-identifier hs-var">churnGovernorThread</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1099"></span><span>                </span><span class="hs-comment">-- wait for any thread to fail:</span><span>
</span><span id="line-1100"></span><span>                </span><span class="annot"><span class="annottext">(Async m Void, Void) -&gt; Void
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((Async m Void, Void) -&gt; Void) -&gt; m (Async m Void, Void) -&gt; m Void
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[Async m Void] -&gt; m (Async m Void, Void)
forall a. [Async m a] -&gt; m (Async m a, a)
forall (m :: * -&gt; *) a.
MonadAsync m =&gt;
[Async m a] -&gt; m (Async m a, a)
</span><span class="hs-identifier hs-var">Async.waitAny</span></span><span>
</span><span id="line-1101"></span><span>                     </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231735"><span class="hs-identifier hs-var">ledgerPeersThread</span></a></span><span>
</span><span id="line-1102"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231736"><span class="hs-identifier hs-var">localRootPeersProvider</span></a></span><span>
</span><span id="line-1103"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231738"><span class="hs-identifier hs-var">governorThread</span></a></span><span>
</span><span id="line-1104"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231743"><span class="hs-identifier hs-var">churnGovernorThread</span></a></span><span>
</span><span id="line-1105"></span><span>                     </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async m Void
</span><a href="#local-6989586621679231742"><span class="hs-identifier hs-var">serverThread</span></a></span><span>
</span><span id="line-1106"></span><span>                     </span><span class="hs-special">]</span><span>
</span><span id="line-1107"></span><span>
</span><span id="line-1108"></span><span class="hs-comment">-- | Main entry point for data diffusion service.  It allows to:</span><span>
</span><span id="line-1109"></span><span class="hs-comment">--</span><span>
</span><span id="line-1110"></span><span class="hs-comment">-- * connect to upstream peers;</span><span>
</span><span id="line-1111"></span><span class="hs-comment">-- * accept connection from downstream peers, if run in</span><span>
</span><span id="line-1112"></span><span class="hs-comment">--  'InitiatorAndResponderDiffusionMode'.</span><span>
</span><span id="line-1113"></span><span class="hs-comment">-- * runs a local service which allows to use node-to-client protocol to obtain</span><span>
</span><span id="line-1114"></span><span class="hs-comment">--   information from the running system.  This is used by 'cardano-cli' or</span><span>
</span><span id="line-1115"></span><span class="hs-comment">--   a wallet and a like local services.</span><span>
</span><span id="line-1116"></span><span class="hs-comment">--</span><span>
</span><span id="line-1117"></span><span id="local-6989586621679230912"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#run"><span class="hs-identifier hs-type">run</span></a></span><span>
</span><span id="line-1118"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Tracers"><span class="hs-identifier hs-type">Tracers</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html#RemoteAddress"><span class="hs-identifier hs-type">RemoteAddress</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-1119"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">LocalAddress</span></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NodeToClientVersion</span></span><span>
</span><span id="line-1120"></span><span>               </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-1121"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#TracersExtra"><span class="hs-identifier hs-type">TracersExtra</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html#RemoteAddress"><span class="hs-identifier hs-type">RemoteAddress</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>   </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersionData</span></span><span>
</span><span id="line-1122"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">LocalAddress</span></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NodeToClientVersion</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToClientVersionData</span></span><span>
</span><span id="line-1123"></span><span>                    </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#IOException"><span class="hs-identifier hs-type">IOException</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-1124"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Arguments"><span class="hs-identifier hs-type">Arguments</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket</span></span><span>      </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html#RemoteAddress"><span class="hs-identifier hs-type">RemoteAddress</span></a></span><span>
</span><span id="line-1125"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">LocalSocket</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LocalAddress</span></span><span>
</span><span id="line-1126"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ArgumentsExtra"><span class="hs-identifier hs-type">ArgumentsExtra</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-1127"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.Common.html#Applications"><span class="hs-identifier hs-type">Applications</span></a></span><span>
</span><span id="line-1128"></span><span>         </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html#RemoteAddress"><span class="hs-identifier hs-type">RemoteAddress</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>   </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersionData</span></span><span>
</span><span id="line-1129"></span><span>         </span><span class="annot"><span class="hs-identifier hs-type">LocalAddress</span></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NodeToClientVersion</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToClientVersionData</span></span><span>
</span><span id="line-1130"></span><span>         </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230912"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1131"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#ApplicationsExtra"><span class="hs-identifier hs-type">ApplicationsExtra</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html#RemoteAddress"><span class="hs-identifier hs-type">RemoteAddress</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230912"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-1132"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span></span><span>
</span><span id="line-1133"></span><span id="run"><span class="annot"><span class="annottext">run :: forall a.
Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
-&gt; TracersExtra
     SockAddr
     NodeToNodeVersion
     NodeToNodeVersionData
     LocalAddress
     NodeToClientVersion
     NodeToClientVersionData
     IOException
     IO
-&gt; Arguments Socket SockAddr LocalSocket LocalAddress
-&gt; ArgumentsExtra IO
-&gt; Applications
     SockAddr
     NodeToNodeVersion
     NodeToNodeVersionData
     LocalAddress
     NodeToClientVersion
     NodeToClientVersionData
     IO
     a
-&gt; ApplicationsExtra SockAddr IO a
-&gt; IO Void
</span><a href="Ouroboros.Network.Diffusion.P2P.html#run"><span class="hs-identifier hs-var hs-var">run</span></a></span></span><span> </span><span id="local-6989586621679231818"><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
</span><a href="#local-6989586621679231818"><span class="hs-identifier hs-var">tracers</span></a></span></span><span> </span><span id="local-6989586621679231819"><span class="annot"><span class="annottext">TracersExtra
  SockAddr
  NodeToNodeVersion
  NodeToNodeVersionData
  LocalAddress
  NodeToClientVersion
  NodeToClientVersionData
  IOException
  IO
</span><a href="#local-6989586621679231819"><span class="hs-identifier hs-var">tracersExtra</span></a></span></span><span> </span><span id="local-6989586621679231820"><span class="annot"><span class="annottext">Arguments Socket SockAddr LocalSocket LocalAddress
</span><a href="#local-6989586621679231820"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621679231821"><span class="annot"><span class="annottext">ArgumentsExtra IO
</span><a href="#local-6989586621679231821"><span class="hs-identifier hs-var">argsExtra</span></a></span></span><span> </span><span id="local-6989586621679231822"><span class="annot"><span class="annottext">Applications
  SockAddr
  NodeToNodeVersion
  NodeToNodeVersionData
  LocalAddress
  NodeToClientVersion
  NodeToClientVersionData
  IO
  a
</span><a href="#local-6989586621679231822"><span class="hs-identifier hs-var">apps</span></a></span></span><span> </span><span id="local-6989586621679231823"><span class="annot"><span class="annottext">ApplicationsExtra SockAddr IO a
</span><a href="#local-6989586621679231823"><span class="hs-identifier hs-var">appsExtra</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1134"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679231824"><span class="annot"><span class="annottext">tracer :: Tracer IO (DiffusionTracer SockAddr LocalAddress)
</span><a href="#local-6989586621679231824"><span class="hs-identifier hs-var hs-var">tracer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
-&gt; Tracer IO (DiffusionTracer SockAddr LocalAddress)
forall ntnAddr ntnVersion ntcAddr ntcVersion (m :: * -&gt; *).
Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; Tracer m (DiffusionTracer ntnAddr ntcAddr)
</span><a href="Ouroboros.Network.Diffusion.Common.html#dtDiffusionTracer"><span class="hs-identifier hs-var">dtDiffusionTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
</span><a href="#local-6989586621679231818"><span class="hs-identifier hs-var">tracers</span></a></span><span>
</span><span id="line-1135"></span><span>    </span><span class="hs-comment">-- We run two services: for /node-to-node/ and /node-to-client/.  The</span><span>
</span><span id="line-1136"></span><span>    </span><span class="hs-comment">-- naming convention is that we use /local/ prefix for /node-to-client/</span><span>
</span><span id="line-1137"></span><span>    </span><span class="hs-comment">-- related terms, as this is a local only service running over a unix</span><span>
</span><span id="line-1138"></span><span>    </span><span class="hs-comment">-- socket / windows named pipe.</span><span>
</span><span id="line-1139"></span><span>    </span><span class="annot"><span class="annottext">(SomeException -&gt; Maybe SomeException)
-&gt; (SomeException -&gt; IO Void) -&gt; IO Void -&gt; IO Void
forall e b a.
Exception e =&gt;
(e -&gt; Maybe b) -&gt; (b -&gt; IO a) -&gt; IO a -&gt; IO a
forall (m :: * -&gt; *) e b a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; Maybe b) -&gt; (b -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handleJust</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679231826"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231826"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe ExitCode
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#fromException"><span class="hs-identifier hs-var">fromException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231826"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#ExitCode"><span class="hs-identifier hs-type">ExitCode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1140"></span><span>                  </span><span class="annot"><span class="annottext">Maybe ExitCode
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe SomeException
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231826"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1141"></span><span>                  </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe SomeException
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1142"></span><span>               </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679231827"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231827"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer IO (DiffusionTracer SockAddr LocalAddress)
-&gt; DiffusionTracer SockAddr LocalAddress -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO (DiffusionTracer SockAddr LocalAddress)
</span><a href="#local-6989586621679231824"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; DiffusionTracer SockAddr LocalAddress
forall ntnAddr ntcAddr.
SomeException -&gt; DiffusionTracer ntnAddr ntcAddr
</span><a href="Ouroboros.Network.Diffusion.Common.html#DiffusionErrored"><span class="hs-identifier hs-var">DiffusionErrored</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231827"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1143"></span><span>                   </span><span class="annot"><span class="annottext">IO () -&gt; IO Void -&gt; IO Void
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Failure -&gt; IO Void
forall e a. Exception e =&gt; e -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Failure
</span><a href="Ouroboros.Network.Diffusion.Common.html#DiffusionError"><span class="hs-identifier hs-var">DiffusionError</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679231827"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1144"></span><span>         </span><span class="annot"><span class="annottext">(IO Void -&gt; IO Void) -&gt; IO Void -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(IOManager -&gt; IO Void) -&gt; IO Void
WithIOManager
</span><span class="hs-identifier hs-var">withIOManager</span></span><span> </span><span class="annot"><span class="annottext">((IOManager -&gt; IO Void) -&gt; IO Void)
-&gt; (IOManager -&gt; IO Void) -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231831"><span class="annot"><span class="annottext">IOManager
</span><a href="#local-6989586621679231831"><span class="hs-identifier hs-var">iocp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1145"></span><span>             </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679231832"><span class="annot"><span class="annottext">diNtnHandshakeArguments :: HandshakeArguments
  (ConnectionId SockAddr) NodeToNodeVersion NodeToNodeVersionData IO
</span><a href="#local-6989586621679231832"><span class="hs-identifier hs-var hs-var">diNtnHandshakeArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1146"></span><span>                   </span><span class="annot"><span class="hs-identifier hs-type">HandshakeArguments</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1147"></span><span>                       </span><span class="annot"><span class="annottext">haHandshakeTracer :: Tracer
  IO
  (WithMuxBearer
     (ConnectionId SockAddr)
     (TraceSendRecv (Handshake NodeToNodeVersion Term)))
</span><span class="hs-identifier hs-var">haHandshakeTracer</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
-&gt; Tracer
     IO
     (WithMuxBearer
        (ConnectionId SockAddr)
        (TraceSendRecv (Handshake NodeToNodeVersion Term)))
forall ntnAddr ntnVersion ntcAddr ntcVersion (m :: * -&gt; *).
Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; Tracer m (HandshakeTr ntnAddr ntnVersion)
</span><a href="Ouroboros.Network.Diffusion.Common.html#dtHandshakeTracer"><span class="hs-identifier hs-var">dtHandshakeTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
</span><a href="#local-6989586621679231818"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1148"></span><span>                       </span><span class="annot"><span class="annottext">haHandshakeCodec :: Codec
  (Handshake NodeToNodeVersion Term) DeserialiseFailure IO ByteString
</span><span class="hs-identifier hs-var">haHandshakeCodec</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (Handshake NodeToNodeVersion Term) DeserialiseFailure IO ByteString
forall (m :: * -&gt; *).
MonadST m =&gt;
Codec
  (Handshake NodeToNodeVersion Term) DeserialiseFailure m ByteString
</span><span class="hs-identifier hs-var">NodeToNode.nodeToNodeHandshakeCodec</span></span><span class="hs-special">,</span><span>
</span><span id="line-1149"></span><span>                       </span><span class="annot"><span class="annottext">haVersionDataCodec :: VersionDataCodec Term NodeToNodeVersion NodeToNodeVersionData
</span><span class="hs-identifier hs-var">haVersionDataCodec</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1150"></span><span>                         </span><span class="annot"><span class="annottext">(NodeToNodeVersion -&gt; CodecCBORTerm Text NodeToNodeVersionData)
-&gt; VersionDataCodec Term NodeToNodeVersion NodeToNodeVersionData
forall vNumber vData.
(vNumber -&gt; CodecCBORTerm Text vData)
-&gt; VersionDataCodec Term vNumber vData
</span><span class="hs-identifier hs-var">cborTermVersionDataCodec</span></span><span>
</span><span id="line-1151"></span><span>                           </span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; CodecCBORTerm Text NodeToNodeVersionData
</span><span class="hs-identifier hs-var">NodeToNode.nodeToNodeCodecCBORTerm</span></span><span class="hs-special">,</span><span>
</span><span id="line-1152"></span><span>                       </span><span class="annot"><span class="annottext">haAcceptVersion :: NodeToNodeVersionData
-&gt; NodeToNodeVersionData -&gt; Accept NodeToNodeVersionData
</span><span class="hs-identifier hs-var">haAcceptVersion</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersionData
-&gt; NodeToNodeVersionData -&gt; Accept NodeToNodeVersionData
forall v. Acceptable v =&gt; v -&gt; v -&gt; Accept v
</span><span class="hs-identifier hs-var">acceptableVersion</span></span><span class="hs-special">,</span><span>
</span><span id="line-1153"></span><span>                       </span><span class="annot"><span class="annottext">haQueryVersion :: NodeToNodeVersionData -&gt; Bool
</span><span class="hs-identifier hs-var">haQueryVersion</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersionData -&gt; Bool
forall v. Queryable v =&gt; v -&gt; Bool
</span><span class="hs-identifier hs-var">queryVersion</span></span><span class="hs-special">,</span><span>
</span><span id="line-1154"></span><span>                       </span><span class="annot"><span class="annottext">haTimeLimits :: ProtocolTimeLimits (Handshake NodeToNodeVersion Term)
</span><span class="hs-identifier hs-var">haTimeLimits</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolTimeLimits (Handshake NodeToNodeVersion Term)
forall {k} (vNumber :: k).
ProtocolTimeLimits (Handshake vNumber Term)
</span><span class="hs-identifier hs-var">timeLimitsHandshake</span></span><span>
</span><span id="line-1155"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-1156"></span><span>                 </span><span id="local-6989586621679231847"><span class="annot"><span class="annottext">diNtcHandshakeArguments :: HandshakeArguments
  (ConnectionId LocalAddress)
  NodeToClientVersion
  NodeToClientVersionData
  IO
</span><a href="#local-6989586621679231847"><span class="hs-identifier hs-var hs-var">diNtcHandshakeArguments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1157"></span><span>                   </span><span class="annot"><span class="hs-identifier hs-type">HandshakeArguments</span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1158"></span><span>                       </span><span class="annot"><span class="annottext">haHandshakeTracer :: Tracer
  IO
  (WithMuxBearer
     (ConnectionId LocalAddress)
     (TraceSendRecv (Handshake NodeToClientVersion Term)))
</span><span class="hs-identifier hs-var">haHandshakeTracer</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
-&gt; Tracer
     IO
     (WithMuxBearer
        (ConnectionId LocalAddress)
        (TraceSendRecv (Handshake NodeToClientVersion Term)))
forall ntnAddr ntnVersion ntcAddr ntcVersion (m :: * -&gt; *).
Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; Tracer m (HandshakeTr ntcAddr ntcVersion)
</span><a href="Ouroboros.Network.Diffusion.Common.html#dtLocalHandshakeTracer"><span class="hs-identifier hs-var">dtLocalHandshakeTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
</span><a href="#local-6989586621679231818"><span class="hs-identifier hs-var">tracers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1159"></span><span>                       </span><span class="annot"><span class="annottext">haHandshakeCodec :: Codec
  (Handshake NodeToClientVersion Term)
  DeserialiseFailure
  IO
  ByteString
</span><span class="hs-identifier hs-var">haHandshakeCodec</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Codec
  (Handshake NodeToClientVersion Term)
  DeserialiseFailure
  IO
  ByteString
forall (m :: * -&gt; *).
MonadST m =&gt;
Codec
  (Handshake NodeToClientVersion Term)
  DeserialiseFailure
  m
  ByteString
</span><span class="hs-identifier hs-var">NodeToClient.nodeToClientHandshakeCodec</span></span><span class="hs-special">,</span><span>
</span><span id="line-1160"></span><span>                       </span><span class="annot"><span class="annottext">haVersionDataCodec :: VersionDataCodec Term NodeToClientVersion NodeToClientVersionData
</span><span class="hs-identifier hs-var">haVersionDataCodec</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1161"></span><span>                         </span><span class="annot"><span class="annottext">(NodeToClientVersion -&gt; CodecCBORTerm Text NodeToClientVersionData)
-&gt; VersionDataCodec
     Term NodeToClientVersion NodeToClientVersionData
forall vNumber vData.
(vNumber -&gt; CodecCBORTerm Text vData)
-&gt; VersionDataCodec Term vNumber vData
</span><span class="hs-identifier hs-var">cborTermVersionDataCodec</span></span><span>
</span><span id="line-1162"></span><span>                           </span><span class="annot"><span class="annottext">NodeToClientVersion -&gt; CodecCBORTerm Text NodeToClientVersionData
</span><span class="hs-identifier hs-var">NodeToClient.nodeToClientCodecCBORTerm</span></span><span class="hs-special">,</span><span>
</span><span id="line-1163"></span><span>                       </span><span class="annot"><span class="annottext">haAcceptVersion :: NodeToClientVersionData
-&gt; NodeToClientVersionData -&gt; Accept NodeToClientVersionData
</span><span class="hs-identifier hs-var">haAcceptVersion</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeToClientVersionData
-&gt; NodeToClientVersionData -&gt; Accept NodeToClientVersionData
forall v. Acceptable v =&gt; v -&gt; v -&gt; Accept v
</span><span class="hs-identifier hs-var">acceptableVersion</span></span><span class="hs-special">,</span><span>
</span><span id="line-1164"></span><span>                       </span><span class="annot"><span class="annottext">haQueryVersion :: NodeToClientVersionData -&gt; Bool
</span><span class="hs-identifier hs-var">haQueryVersion</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeToClientVersionData -&gt; Bool
forall v. Queryable v =&gt; v -&gt; Bool
</span><span class="hs-identifier hs-var">queryVersion</span></span><span class="hs-special">,</span><span>
</span><span id="line-1165"></span><span>                       </span><span class="annot"><span class="annottext">haTimeLimits :: ProtocolTimeLimits (Handshake NodeToClientVersion Term)
</span><span class="hs-identifier hs-var">haTimeLimits</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProtocolTimeLimits (Handshake NodeToClientVersion Term)
forall {k} (vNumber :: k).
ProtocolTimeLimits (Handshake vNumber Term)
</span><span class="hs-identifier hs-var">noTimeLimitsHandshake</span></span><span>
</span><span id="line-1166"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span>                 </span><span class="annot"><a href="#local-6989586621679231852"><span class="hs-identifier hs-type">diInstallSigUSR1Handler</span></a></span><span>
</span><span id="line-1169"></span><span>                   </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679230958"><span class="annot"><a href="#local-6989586621679230958"><span class="hs-identifier hs-type">mode</span></a></span></span><span> </span><span id="local-6989586621679230959"><span class="annot"><a href="#local-6989586621679230959"><span class="hs-identifier hs-type">x</span></a></span></span><span> </span><span id="local-6989586621679230960"><span class="annot"><a href="#local-6989586621679230960"><span class="hs-identifier hs-type">y</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-1170"></span><span>                      </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#NodeToNodeConnectionManager"><span class="hs-identifier hs-type">NodeToNodeConnectionManager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230958"><span class="hs-identifier hs-type">mode</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Socket</span></span><span> </span><span class="annot"><a href="Ouroboros.Network.NodeToNode.html#RemoteAddress"><span class="hs-identifier hs-type">RemoteAddress</span></a></span><span>
</span><span id="line-1171"></span><span>                                                  </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersionData</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230959"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230960"><span class="hs-identifier hs-type">y</span></a></span><span>
</span><span id="line-1172"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#ifdef POSIX
</span><span>                 </span><span id="local-6989586621679231852"><span class="annot"><span class="annottext">diInstallSigUSR1Handler :: forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
-&gt; IO ()
</span><a href="#local-6989586621679231852"><span class="hs-identifier hs-var hs-var">diInstallSigUSR1Handler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679231860"><span class="annot"><span class="annottext">NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
</span><a href="#local-6989586621679231860"><span class="hs-identifier hs-var">connectionManager</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1175"></span><span>                   </span><span class="annot"><span class="annottext">Handler
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Signal -&gt; Handler -&gt; Maybe SignalSet -&gt; IO Handler
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/unix-2.8.1.0/src/System.Posix.Signals.html#installHandler"><span class="hs-identifier hs-var">Signals.installHandler</span></a></span><span>
</span><span id="line-1176"></span><span>                     </span><span class="annot"><span class="annottext">Signal
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/unix-2.8.1.0/src/System.Posix.Signals.html#sigUSR1"><span class="hs-identifier hs-var">Signals.sigUSR1</span></a></span><span>
</span><span id="line-1177"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; Handler
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/unix-2.8.1.0/src/System.Posix.Signals.html#Catch"><span class="hs-identifier hs-var">Signals.Catch</span></a></span><span>
</span><span id="line-1178"></span><span>                       </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679231864"><span class="annot"><span class="annottext">Map SockAddr AbstractState
</span><a href="#local-6989586621679231864"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM IO (Map SockAddr AbstractState)
-&gt; IO (Map SockAddr AbstractState)
forall a. HasCallStack =&gt; STM IO a -&gt; IO a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM IO (Map SockAddr AbstractState)
 -&gt; IO (Map SockAddr AbstractState))
-&gt; STM IO (Map SockAddr AbstractState)
-&gt; IO (Map SockAddr AbstractState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
-&gt; STM IO (Map SockAddr AbstractState)
forall (muxMode :: MuxMode) socket peerAddr handle handleError
       (m :: * -&gt; *).
ConnectionManager muxMode socket peerAddr handle handleError m
-&gt; STM m (Map peerAddr AbstractState)
</span><span class="hs-identifier hs-var">readState</span></span><span> </span><span class="annot"><span class="annottext">NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
</span><a href="#local-6989586621679231860"><span class="hs-identifier hs-var">connectionManager</span></a></span><span>
</span><span id="line-1179"></span><span>                           </span><span class="annot"><span class="annottext">Tracer
  IO
  (ConnectionManagerTrace
     SockAddr
     (ConnectionHandlerTrace NodeToNodeVersion NodeToNodeVersionData))
-&gt; ConnectionManagerTrace
     SockAddr
     (ConnectionHandlerTrace NodeToNodeVersion NodeToNodeVersionData)
-&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TracersExtra
  SockAddr
  NodeToNodeVersion
  NodeToNodeVersionData
  LocalAddress
  NodeToClientVersion
  NodeToClientVersionData
  IOException
  IO
-&gt; Tracer
     IO
     (ConnectionManagerTrace
        SockAddr
        (ConnectionHandlerTrace NodeToNodeVersion NodeToNodeVersionData))
forall ntnAddr ntnVersion ntnVersionData ntcAddr ntcVersion
       ntcVersionData resolverError (m :: * -&gt; *).
TracersExtra
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcAddr
  ntcVersion
  ntcVersionData
  resolverError
  m
-&gt; Tracer
     m
     (ConnectionManagerTrace
        ntnAddr (ConnectionHandlerTrace ntnVersion ntnVersionData))
</span><a href="Ouroboros.Network.Diffusion.P2P.html#dtConnectionManagerTracer"><span class="hs-identifier hs-var">dtConnectionManagerTracer</span></a></span><span> </span><span class="annot"><span class="annottext">TracersExtra
  SockAddr
  NodeToNodeVersion
  NodeToNodeVersionData
  LocalAddress
  NodeToClientVersion
  NodeToClientVersionData
  IOException
  IO
</span><a href="#local-6989586621679231819"><span class="hs-identifier hs-var">tracersExtra</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1180"></span><span>                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map SockAddr AbstractState
-&gt; ConnectionManagerTrace
     SockAddr
     (ConnectionHandlerTrace NodeToNodeVersion NodeToNodeVersionData)
forall peerAddr handlerTrace.
Map peerAddr AbstractState
-&gt; ConnectionManagerTrace peerAddr handlerTrace
</span><span class="hs-identifier hs-var">TrState</span></span><span> </span><span class="annot"><span class="annottext">Map SockAddr AbstractState
</span><a href="#local-6989586621679231864"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1181"></span><span>                       </span><span class="hs-special">)</span><span>
</span><span id="line-1182"></span><span>                     </span><span class="hs-special">)</span><span>
</span><span id="line-1183"></span><span>                     </span><span class="annot"><span class="annottext">Maybe SignalSet
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-1184"></span><span>                   </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span>                 </span><span class="hs-identifier">diInstallSigUSR1Handler</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-1189"></span><span>             </span><span id="local-6989586621679231868"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231868"><span class="hs-identifier hs-var">diRng</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO StdGen
forall (m :: * -&gt; *). MonadIO m =&gt; m StdGen
</span><span class="hs-identifier hs-var">newStdGen</span></span><span>
</span><span id="line-1190"></span><span>             </span><span class="annot"><span class="annottext">Interfaces
  Socket
  SockAddr
  NodeToNodeVersion
  NodeToNodeVersionData
  LocalSocket
  LocalAddress
  NodeToClientVersion
  NodeToClientVersionData
  Resolver
  IOException
  IO
-&gt; Tracers
     SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
-&gt; TracersExtra
     SockAddr
     NodeToNodeVersion
     NodeToNodeVersionData
     LocalAddress
     NodeToClientVersion
     NodeToClientVersionData
     IOException
     IO
-&gt; Arguments Socket SockAddr LocalSocket LocalAddress
-&gt; ArgumentsExtra IO
-&gt; Applications
     SockAddr
     NodeToNodeVersion
     NodeToNodeVersionData
     LocalAddress
     NodeToClientVersion
     NodeToClientVersionData
     IO
     a
-&gt; ApplicationsExtra SockAddr IO a
-&gt; IO Void
forall (m :: * -&gt; *) ntnFd ntnAddr ntnVersion ntnVersionData ntcFd
       ntcAddr ntcVersion ntcVersionData resolver resolverError a.
(Alternative (STM m), MonadAsync m, MonadDelay m, MonadEvaluate m,
 MonadFix m, MonadFork m, MonadLabelledSTM m, MonadTraceSTM m,
 MonadMask m, MonadThrow (STM m), MonadTime m, MonadTimer m,
 MonadMVar m, Typeable ntnAddr, Ord ntnAddr, Show ntnAddr,
 Typeable ntnVersion, Ord ntnVersion, Show ntnVersion,
 Show ntnVersionData, Typeable ntcAddr, Ord ntcAddr, Show ntcAddr,
 Ord ntcVersion, Exception resolverError) =&gt;
Interfaces
  ntnFd
  ntnAddr
  ntnVersion
  ntnVersionData
  ntcFd
  ntcAddr
  ntcVersion
  ntcVersionData
  resolver
  resolverError
  m
-&gt; Tracers ntnAddr ntnVersion ntcAddr ntcVersion m
-&gt; TracersExtra
     ntnAddr
     ntnVersion
     ntnVersionData
     ntcAddr
     ntcVersion
     ntcVersionData
     resolverError
     m
-&gt; Arguments ntnFd ntnAddr ntcFd ntcAddr
-&gt; ArgumentsExtra m
-&gt; Applications
     ntnAddr
     ntnVersion
     ntnVersionData
     ntcAddr
     ntcVersion
     ntcVersionData
     m
     a
-&gt; ApplicationsExtra ntnAddr m a
-&gt; m Void
</span><a href="Ouroboros.Network.Diffusion.P2P.html#runM"><span class="hs-identifier hs-var">runM</span></a></span><span>
</span><span id="line-1191"></span><span>               </span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#Interfaces"><span class="hs-identifier hs-type">Interfaces</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1192"></span><span>                 </span><span class="annot"><span class="annottext">diNtnSnocket :: Snocket IO Socket SockAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnSnocket"><span class="hs-identifier hs-var">diNtnSnocket</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IOManager -&gt; Snocket IO Socket SockAddr
</span><span class="hs-identifier hs-var">Snocket.socketSnocket</span></span><span> </span><span class="annot"><span class="annottext">IOManager
</span><a href="#local-6989586621679231831"><span class="hs-identifier hs-var">iocp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1193"></span><span>                 </span><span class="annot"><span class="annottext">diNtnBearer :: MakeBearer IO Socket
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnBearer"><span class="hs-identifier hs-var">diNtnBearer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MakeBearer IO Socket
</span><span class="hs-identifier hs-var">makeSocketBearer</span></span><span class="hs-special">,</span><span>
</span><span id="line-1194"></span><span>                 </span><span class="annot"><span class="annottext">diNtnConfigureSocket :: Socket -&gt; Maybe SockAddr -&gt; IO ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnConfigureSocket"><span class="hs-identifier hs-var">diNtnConfigureSocket</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Socket -&gt; Maybe SockAddr -&gt; IO ()
</span><span class="hs-identifier hs-var">configureSocket</span></span><span class="hs-special">,</span><span>
</span><span id="line-1195"></span><span>                 </span><span class="annot"><span class="annottext">diNtnConfigureSystemdSocket :: Socket -&gt; SockAddr -&gt; IO ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnConfigureSystemdSocket"><span class="hs-identifier hs-var">diNtnConfigureSystemdSocket</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1196"></span><span>                   </span><span class="annot"><span class="annottext">Tracer IO SystemdSocketTracer -&gt; Socket -&gt; SockAddr -&gt; IO ()
</span><span class="hs-identifier hs-var">configureSystemdSocket</span></span><span>
</span><span id="line-1197"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SystemdSocketTracer -&gt; DiffusionTracer SockAddr LocalAddress
forall ntnAddr ntcAddr.
SystemdSocketTracer -&gt; DiffusionTracer ntnAddr ntcAddr
</span><a href="Ouroboros.Network.Diffusion.Common.html#SystemdSocketConfiguration"><span class="hs-identifier hs-var">SystemdSocketConfiguration</span></a></span><span> </span><span class="annot"><span class="annottext">(SystemdSocketTracer -&gt; DiffusionTracer SockAddr LocalAddress)
-&gt; Tracer IO (DiffusionTracer SockAddr LocalAddress)
-&gt; Tracer IO SystemdSocketTracer
forall a' a. (a' -&gt; a) -&gt; Tracer IO a -&gt; Tracer IO a'
forall (f :: * -&gt; *) a' a.
Contravariant f =&gt;
(a' -&gt; a) -&gt; f a -&gt; f a'
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.Contravariant.html#contramap"><span class="hs-operator hs-var">`contramap`</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO (DiffusionTracer SockAddr LocalAddress)
</span><a href="#local-6989586621679231824"><span class="hs-identifier hs-var">tracer</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1198"></span><span>                 </span><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId SockAddr) NodeToNodeVersion NodeToNodeVersionData IO
diNtnHandshakeArguments :: HandshakeArguments
  (ConnectionId SockAddr) NodeToNodeVersion NodeToNodeVersionData IO
diNtnHandshakeArguments :: HandshakeArguments
  (ConnectionId SockAddr) NodeToNodeVersion NodeToNodeVersionData IO
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnHandshakeArguments"><span class="hs-identifier hs-var hs-var">diNtnHandshakeArguments</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1199"></span><span>                 </span><span class="annot"><span class="annottext">diNtnAddressType :: SockAddr -&gt; Maybe AddressType
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnAddressType"><span class="hs-identifier hs-var">diNtnAddressType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SockAddr -&gt; Maybe AddressType
</span><a href="Ouroboros.Network.Diffusion.P2P.html#socketAddressType"><span class="hs-identifier hs-var">socketAddressType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1200"></span><span>                 </span><span class="annot"><span class="annottext">diNtnDataFlow :: NodeToNodeVersion -&gt; NodeToNodeVersionData -&gt; DataFlow
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnDataFlow"><span class="hs-identifier hs-var">diNtnDataFlow</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; NodeToNodeVersionData -&gt; DataFlow
</span><a href="Ouroboros.Network.Diffusion.P2P.html#nodeDataFlow"><span class="hs-identifier hs-var">nodeDataFlow</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1201"></span><span>                 </span><span class="annot"><span class="annottext">diNtnPeerSharing :: NodeToNodeVersionData -&gt; PeerSharing
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnPeerSharing"><span class="hs-identifier hs-var">diNtnPeerSharing</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersionData -&gt; PeerSharing
</span><span class="hs-identifier hs-var">peerSharing</span></span><span class="hs-special">,</span><span>
</span><span id="line-1202"></span><span>                 </span><span class="annot"><span class="annottext">diNtnToPeerAddr :: IP -&gt; PortNumber -&gt; SockAddr
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtnToPeerAddr"><span class="hs-identifier hs-var">diNtnToPeerAddr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((IP, PortNumber) -&gt; SockAddr) -&gt; IP -&gt; PortNumber -&gt; SockAddr
forall a b c. ((a, b) -&gt; c) -&gt; a -&gt; b -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#curry"><span class="hs-identifier hs-var">curry</span></a></span><span> </span><span class="annot"><span class="annottext">(IP, PortNumber) -&gt; SockAddr
</span><span class="hs-identifier hs-var">IP.toSockAddr</span></span><span class="hs-special">,</span><span>
</span><span id="line-1203"></span><span>
</span><span id="line-1204"></span><span>                 </span><span class="annot"><span class="annottext">diNtcSnocket :: Snocket IO LocalSocket LocalAddress
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcSnocket"><span class="hs-identifier hs-var">diNtcSnocket</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IOManager -&gt; Snocket IO LocalSocket LocalAddress
</span><span class="hs-identifier hs-var">Snocket.localSnocket</span></span><span> </span><span class="annot"><span class="annottext">IOManager
</span><a href="#local-6989586621679231831"><span class="hs-identifier hs-var">iocp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1205"></span><span>                 </span><span class="annot"><span class="annottext">diNtcBearer :: MakeBearer IO LocalSocket
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcBearer"><span class="hs-identifier hs-var">diNtcBearer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MakeBearer IO LocalSocket
</span><span class="hs-identifier hs-var">makeLocalBearer</span></span><span class="hs-special">,</span><span>
</span><span id="line-1206"></span><span>                 </span><span class="annot"><span class="annottext">HandshakeArguments
  (ConnectionId LocalAddress)
  NodeToClientVersion
  NodeToClientVersionData
  IO
diNtcHandshakeArguments :: HandshakeArguments
  (ConnectionId LocalAddress)
  NodeToClientVersion
  NodeToClientVersionData
  IO
diNtcHandshakeArguments :: HandshakeArguments
  (ConnectionId LocalAddress)
  NodeToClientVersion
  NodeToClientVersionData
  IO
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcHandshakeArguments"><span class="hs-identifier hs-var hs-var">diNtcHandshakeArguments</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1207"></span><span>                 </span><span class="annot"><span class="annottext">diNtcGetFileDescriptor :: LocalSocket -&gt; IO FileDescriptor
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diNtcGetFileDescriptor"><span class="hs-identifier hs-var">diNtcGetFileDescriptor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalSocket -&gt; IO FileDescriptor
</span><span class="hs-identifier hs-var">localSocketFileDescriptor</span></span><span class="hs-special">,</span><span>
</span><span id="line-1208"></span><span>
</span><span id="line-1209"></span><span>                 </span><span class="annot"><span class="annottext">StdGen
diRng :: StdGen
diRng :: StdGen
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diRng"><span class="hs-identifier hs-var hs-var">diRng</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1210"></span><span>                 </span><span class="annot"><span class="annottext">NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
-&gt; IO ()
forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
-&gt; IO ()
diInstallSigUSR1Handler :: forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
-&gt; IO ()
diInstallSigUSR1Handler :: forall (mode :: MuxMode) x y.
NodeToNodeConnectionManager
  mode Socket SockAddr NodeToNodeVersionData NodeToNodeVersion IO x y
-&gt; IO ()
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diInstallSigUSR1Handler"><span class="hs-identifier hs-var hs-var">diInstallSigUSR1Handler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1211"></span><span>                 </span><span class="annot"><span class="annottext">diDnsActions :: DNSLookupType -&gt; DNSActions Resolver IOException IO
</span><a href="Ouroboros.Network.Diffusion.P2P.html#diDnsActions"><span class="hs-identifier hs-var">diDnsActions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DNSLookupType -&gt; DNSActions Resolver IOException IO
</span><a href="Ouroboros.Network.PeerSelection.RootPeersDNS.DNSActions.html#ioDNSActions"><span class="hs-identifier hs-var">ioDNSActions</span></a></span><span>
</span><span id="line-1212"></span><span>               </span><span class="hs-special">}</span><span>
</span><span id="line-1213"></span><span>               </span><span class="annot"><span class="annottext">Tracers
  SockAddr NodeToNodeVersion LocalAddress NodeToClientVersion IO
</span><a href="#local-6989586621679231818"><span class="hs-identifier hs-var">tracers</span></a></span><span> </span><span class="annot"><span class="annottext">TracersExtra
  SockAddr
  NodeToNodeVersion
  NodeToNodeVersionData
  LocalAddress
  NodeToClientVersion
  NodeToClientVersionData
  IOException
  IO
</span><a href="#local-6989586621679231819"><span class="hs-identifier hs-var">tracersExtra</span></a></span><span> </span><span class="annot"><span class="annottext">Arguments Socket SockAddr LocalSocket LocalAddress
</span><a href="#local-6989586621679231820"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">ArgumentsExtra IO
</span><a href="#local-6989586621679231821"><span class="hs-identifier hs-var">argsExtra</span></a></span><span> </span><span class="annot"><span class="annottext">Applications
  SockAddr
  NodeToNodeVersion
  NodeToNodeVersionData
  LocalAddress
  NodeToClientVersion
  NodeToClientVersionData
  IO
  a
</span><a href="#local-6989586621679231822"><span class="hs-identifier hs-var">apps</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationsExtra SockAddr IO a
</span><a href="#local-6989586621679231823"><span class="hs-identifier hs-var">appsExtra</span></a></span><span>
</span><span id="line-1214"></span><span>
</span><span id="line-1215"></span><span>
</span><span id="line-1216"></span><span class="hs-comment">--</span><span>
</span><span id="line-1217"></span><span class="hs-comment">-- Utility Function</span><span>
</span><span id="line-1218"></span><span class="hs-comment">--</span><span>
</span><span id="line-1219"></span><span>
</span><span id="line-1220"></span><span id="local-6989586621679230812"><span id="local-6989586621679230813"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#computePeerSharingPeers"><span class="hs-identifier hs-type">computePeerSharingPeers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230812"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1221"></span><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679230812"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#PublicPeerSelectionState"><span class="hs-identifier hs-type">PublicPeerSelectionState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679230813"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1222"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StrictTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679230812"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">StdGen</span></span><span>
</span><span id="line-1223"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PeerSharingAmount</span></span><span>
</span><span id="line-1224"></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230812"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679230813"><span class="hs-identifier hs-type">ntnAddr</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1225"></span><span id="computePeerSharingPeers"><span class="annot"><span class="annottext">computePeerSharingPeers :: forall (m :: * -&gt; *) ntnAddr.
MonadSTM m =&gt;
STM m (PublicPeerSelectionState ntnAddr)
-&gt; StrictTVar m StdGen -&gt; PeerSharingAmount -&gt; m [ntnAddr]
</span><a href="Ouroboros.Network.Diffusion.P2P.html#computePeerSharingPeers"><span class="hs-identifier hs-var hs-var">computePeerSharingPeers</span></a></span></span><span> </span><span id="local-6989586621679231905"><span class="annot"><span class="annottext">STM m (PublicPeerSelectionState ntnAddr)
</span><a href="#local-6989586621679231905"><span class="hs-identifier hs-var">readPublicState</span></a></span></span><span> </span><span id="local-6989586621679231906"><span class="annot"><span class="annottext">StrictTVar m StdGen
</span><a href="#local-6989586621679231906"><span class="hs-identifier hs-var">genVar</span></a></span></span><span> </span><span id="local-6989586621679231907"><span class="annot"><span class="annottext">PeerSharingAmount
</span><a href="#local-6989586621679231907"><span class="hs-identifier hs-var">amount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1226"></span><span>  </span><span id="local-6989586621679231908"><span class="annot"><span class="annottext">PublicPeerSelectionState ntnAddr
</span><a href="#local-6989586621679231908"><span class="hs-identifier hs-var">publicState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m (PublicPeerSelectionState ntnAddr)
-&gt; m (PublicPeerSelectionState ntnAddr)
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM m (PublicPeerSelectionState ntnAddr)
</span><a href="#local-6989586621679231905"><span class="hs-identifier hs-var">readPublicState</span></a></span><span>
</span><span id="line-1227"></span><span>  </span><span id="local-6989586621679231909"><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231909"><span class="hs-identifier hs-var">gen</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM m StdGen -&gt; m StdGen
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m StdGen -&gt; m StdGen) -&gt; STM m StdGen -&gt; m StdGen
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StrictTVar m StdGen -&gt; (StdGen -&gt; (StdGen, StdGen)) -&gt; STM m StdGen
forall (m :: * -&gt; *) s a.
MonadSTM m =&gt;
StrictTVar m s -&gt; (s -&gt; (a, s)) -&gt; STM m a
</span><span class="hs-identifier hs-var">stateTVar</span></span><span> </span><span class="annot"><span class="annottext">StrictTVar m StdGen
</span><a href="#local-6989586621679231906"><span class="hs-identifier hs-var">genVar</span></a></span><span> </span><span class="annot"><span class="annottext">StdGen -&gt; (StdGen, StdGen)
forall g. RandomGen g =&gt; g -&gt; (g, g)
</span><span class="hs-identifier hs-var">split</span></span><span>
</span><span id="line-1228"></span><span>
</span><span id="line-1229"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679231911"><span class="annot"><span class="annottext">availableToShareSet :: Set ntnAddr
</span><a href="#local-6989586621679231911"><span class="hs-identifier hs-var hs-var">availableToShareSet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PublicPeerSelectionState ntnAddr -&gt; Set ntnAddr
forall peeraddr. PublicPeerSelectionState peeraddr -&gt; Set peeraddr
</span><a href="Ouroboros.Network.PeerSelection.Governor.Types.html#availableToShare"><span class="hs-identifier hs-var">availableToShare</span></a></span><span> </span><span class="annot"><span class="annottext">PublicPeerSelectionState ntnAddr
</span><a href="#local-6989586621679231908"><span class="hs-identifier hs-var">publicState</span></a></span><span>
</span><span id="line-1230"></span><span>      </span><span id="local-6989586621679231913"><span class="annot"><span class="annottext">is :: [Int]
</span><a href="#local-6989586621679231913"><span class="hs-identifier hs-var hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#nub"><span class="hs-identifier hs-var">nub</span></a></span><span>
</span><span id="line-1231"></span><span>         </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Int] -&gt; [Int]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerSharingAmount -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">PeerSharingAmount
</span><a href="#local-6989586621679231907"><span class="hs-identifier hs-var">amount</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1232"></span><span>         </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; StdGen -&gt; [Int]
forall g. RandomGen g =&gt; (Int, Int) -&gt; g -&gt; [Int]
forall a g. (Random a, RandomGen g) =&gt; (a, a) -&gt; g -&gt; [a]
</span><span class="hs-identifier hs-var">randomRs</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set ntnAddr -&gt; Int
forall a. Set a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">Set ntnAddr
</span><a href="#local-6989586621679231911"><span class="hs-identifier hs-var">availableToShareSet</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StdGen
</span><a href="#local-6989586621679231909"><span class="hs-identifier hs-var">gen</span></a></span><span>
</span><span id="line-1233"></span><span>      </span><span id="local-6989586621679231916"><span class="annot"><span class="annottext">randomList :: [ntnAddr]
</span><a href="#local-6989586621679231916"><span class="hs-identifier hs-var hs-var">randomList</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; ntnAddr) -&gt; [Int] -&gt; [ntnAddr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Set ntnAddr -&gt; ntnAddr
forall a. Int -&gt; Set a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#elemAt"><span class="hs-operator hs-var">`elemAt`</span></a></span><span> </span><span class="annot"><span class="annottext">Set ntnAddr
</span><a href="#local-6989586621679231911"><span class="hs-identifier hs-var">availableToShareSet</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621679231913"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-1234"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set ntnAddr -&gt; Bool
forall a. Set a -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">Set ntnAddr
</span><a href="#local-6989586621679231911"><span class="hs-identifier hs-var">availableToShareSet</span></a></span><span>
</span><span id="line-1235"></span><span>     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[ntnAddr] -&gt; m [ntnAddr]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1236"></span><span>     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[ntnAddr] -&gt; m [ntnAddr]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[ntnAddr]
</span><a href="#local-6989586621679231916"><span class="hs-identifier hs-var">randomList</span></a></span><span>
</span><span id="line-1237"></span><span>
</span><span id="line-1238"></span><span>
</span><span id="line-1239"></span><span class="hs-comment">--</span><span>
</span><span id="line-1240"></span><span class="hs-comment">-- Data flow</span><span>
</span><span id="line-1241"></span><span class="hs-comment">--</span><span>
</span><span id="line-1242"></span><span>
</span><span id="line-1243"></span><span class="hs-comment">-- | For Node-To-Node protocol, any connection which negotiated at least</span><span>
</span><span id="line-1244"></span><span class="hs-comment">-- 'NodeToNodeV_9' version and did not declare 'InitiatorOnlyDiffusionMode'</span><span>
</span><span id="line-1245"></span><span class="hs-comment">-- will run in 'Duplex' mode.   All connections from lower versions or one that</span><span>
</span><span id="line-1246"></span><span class="hs-comment">-- declared themselves as 'InitiatorOnly' will run in 'UnidirectionalMode'</span><span>
</span><span id="line-1247"></span><span class="hs-comment">--</span><span>
</span><span id="line-1248"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#nodeDataFlow"><span class="hs-identifier hs-type">nodeDataFlow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersion</span></span><span>
</span><span id="line-1249"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersionData</span></span><span>
</span><span id="line-1250"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DataFlow</span></span><span>
</span><span id="line-1251"></span><span id="nodeDataFlow"><span class="annot"><span class="annottext">nodeDataFlow :: NodeToNodeVersion -&gt; NodeToNodeVersionData -&gt; DataFlow
</span><a href="Ouroboros.Network.Diffusion.P2P.html#nodeDataFlow"><span class="hs-identifier hs-var hs-var">nodeDataFlow</span></a></span></span><span> </span><span id="local-6989586621679231919"><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679231919"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NodeToNodeVersionData</span></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">diffusionMode :: NodeToNodeVersionData -&gt; DiffusionMode
</span><span class="hs-identifier hs-var">diffusionMode</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffusionMode
</span><span class="hs-identifier hs-var">InitiatorAndResponderDiffusionMode</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-1252"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><a href="#local-6989586621679231919"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion -&gt; NodeToNodeVersion -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><span class="hs-identifier hs-var">NodeToNodeV_10</span></span><span>
</span><span id="line-1253"></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><span class="hs-identifier hs-var">Duplex</span></span><span>
</span><span id="line-1254"></span><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#nodeDataFlow"><span class="hs-identifier hs-var">nodeDataFlow</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersion
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NodeToNodeVersionData
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><span class="hs-identifier hs-var">Unidirectional</span></span><span>
</span><span id="line-1255"></span><span>
</span><span id="line-1256"></span><span>
</span><span id="line-1257"></span><span class="hs-comment">-- | For Node-To-Client protocol all connection are considered 'Unidirectional'.</span><span>
</span><span id="line-1258"></span><span class="hs-comment">--</span><span>
</span><span id="line-1259"></span><span id="local-6989586621679230696"><span id="local-6989586621679230697"><span class="annot"><a href="Ouroboros.Network.Diffusion.P2P.html#localDataFlow"><span class="hs-identifier hs-type">localDataFlow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679230696"><span class="hs-identifier hs-type">ntcVersion</span></a></span><span>
</span><span id="line-1260"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679230697"><span class="hs-identifier hs-type">ntcVersionData</span></a></span><span>
</span><span id="line-1261"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DataFlow</span></span></span></span><span>
</span><span id="line-1262"></span><span id="localDataFlow"><span class="annot"><span class="annottext">localDataFlow :: forall ntcVersion ntcVersionData.
ntcVersion -&gt; ntcVersionData -&gt; DataFlow
</span><a href="Ouroboros.Network.Diffusion.P2P.html#localDataFlow"><span class="hs-identifier hs-var hs-var">localDataFlow</span></a></span></span><span> </span><span class="annot"><span class="annottext">ntcVersion
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ntcVersionData
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DataFlow
</span><span class="hs-identifier hs-var">Unidirectional</span></span><span>
</span><span id="line-1263"></span></pre></body></html>
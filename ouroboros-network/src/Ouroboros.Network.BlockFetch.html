<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DeriveFunctor       #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards     #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="annot"><span class="hs-comment">{-| Let's start with the big picture...

@
Key:  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;   &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
      &#9475; STM-based  &#9475;  &#9553;active thread&#9553;  &#9475;state instance&#9475;&#9491;  &#9553; one thread &#9553;&#9559;
      &#9475;shared state&#9475;  &#9553;             &#9553;  &#9475;   per peer   &#9475;&#9475;  &#9553;  per peer  &#9553;&#9553;
      &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;  &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9475;  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
                                        &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;   &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
@

@
  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;     &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;
  &#9553; Chain sync  &#9553;&#9559;    &#9475;   Ledger    &#9475;
  &#9553;  protocol   &#9553;&#9553;&#9664;&#9472;&#9472;&#9472;&#9512;   state     &#9475;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9582;
  &#9553;(client side)&#9553;&#9553;    &#9475;             &#9475;            &#9474;
  &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;    &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;            &#9474;
   &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9578;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;                               &#9474;
         &#9660;                                       &#9474;
  &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
  &#9475;  Candidate  &#9475;     &#9475;   Set of    &#9475;     &#9553;  Chain and  &#9553;
  &#9475;  chains     &#9475;     &#9475;  downloaded &#9504;&#9472;&#9472;&#9472;&#9472;&#9654;&#9553;   ledger    &#9553;
  &#9475;  (headers)  &#9475;     &#9475;   blocks    &#9475;     &#9553;  validation &#9553;
  &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9519;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;     &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9519;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;     &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9572;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
        &#9474;                   &#9474; &#9650;                  &#9474;
        &#9474; &#9581;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9583; &#9474;                  &#9474;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9660;&#9617;&#9660;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;           &#9474;                  &#9660;
&#9617;&#9617;&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;&#9617;&#9617;           &#9474;           &#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;     &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
&#9617;&#9617;&#9553;    Block    &#9553;&#9617;&#9617;           &#9474;           &#9475;   Current   &#9475;     &#9553; Block fetch &#9553;&#9559;
&#9617;&#9617;&#9570;    fetch    &#9553;&#9664;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9512;    chain    &#9504;&#9472;&#9472;&#9472;&#9472;&#9654;&#9553; protocol    &#9553;&#9553;
&#9617;&#9617;&#9553;    logic    &#9553;&#9617;&#9617;           &#9474;           &#9475;  (blocks)   &#9475;     &#9553;(server side)&#9553;&#9553;
&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9617;&#9617;           &#9474;           &#9504;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9512;     &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9650;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;           &#9474;           &#9475;  Tentative  &#9475;      &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9660;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9474;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;   &#9475;    chain    &#9504;&#9472;&#9472;&#9582;
&#9617;&#9617;&#9487;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;&#9617;&#9617;&#9617;&#9617;&#9617;&#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9575;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;&#9617;&#9617;   &#9475;  (headers)  &#9475;  &#9474;  &#9556;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9559;
&#9617;&#9617;&#9475; Block fetch &#9475;&#9491;&#9617;&#9617;&#9617;&#9617;&#9553; block fetch &#9553;&#9559;&#9617;   &#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;  &#9474;  &#9553; Chain sync  &#9553;&#9559;
&#9617;&#9617;&#9475;  state and  &#9475;&#9475;&#9664;&#9472;&#9472;&#9654;&#9553;  protocol   &#9553;&#9553;&#9617;                    &#9584;&#9472;&#9654;&#9553; protocol    &#9553;&#9553;
&#9617;&#9617;&#9475;  requests   &#9475;&#9475;&#9617;&#9617;&#9617;&#9617;&#9553;(client side)&#9553;&#9553;&#9617;                       &#9553;(server side)&#9553;&#9553;
&#9617;&#9617;&#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9475;&#9617;&#9617;&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;&#9617;                       &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9553;
&#9617;&#9617;&#9617;&#9495;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9499;&#9617;&#9617;&#9617;&#9617;&#9617;&#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;&#9617;                        &#9562;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9552;&#9565;
&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;&#9617;
@
Notes:

 * Thread communication is via STM based state.
 * Outbound: threads update STM state.
 * Inbound: threads wait on STM state changing (using retry).
 * These are no queues: there is only the current state, not all change events.

We consider the block fetch logic and the policy for the block fetch protocol
client together as one unit of functionality. This is the shaded area in the
diagram.

Looking at the diagram we see that these two threads interact with each other
and other threads via the following shared state

+-----------------------------+----------------+--------------------+
|  State                      |  Interactions  | Internal\/External |
+=============================+================+====================+
|  Candidate chains (headers) |  Read          |  External          |
+-----------------------------+----------------+--------------------+
|  Current chain (blocks)     |  Read          |  External          |
+-----------------------------+----------------+--------------------+
|  Set of downloaded blocks   |  Read &amp; Write  |  External          |
+-----------------------------+----------------+--------------------+
|  Block fetch requests       |  Read &amp; Write  |  Internal          |
+-----------------------------+----------------+--------------------+

The block fetch requests state is private between the block fetch logic
and the block fetch protocol client, so it is implemented here.

The other state is managed by the consensus layer and is considered external
here. So here we define interfaces for interacting with the external state.
These have to be provided when instantiating the block fetch logic.

-}</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.BlockFetch</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier">blockFetchLogic</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier">BlockFetchConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">BlockFetchConsensusInterface</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Tracer types</span></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier">FetchDecision</span></a></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier">TraceFetchClientState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TraceLabelPeer</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="hs-comment">-- * The 'FetchClientRegistry'</span></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier">FetchClientRegistry</span></a></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#newFetchClientRegistry"><span class="hs-identifier">newFetchClientRegistry</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketFetchClient"><span class="hs-identifier">bracketFetchClient</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketSyncWithFetchClient"><span class="hs-identifier">bracketSyncWithFetchClient</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketKeepAliveClient"><span class="hs-identifier">bracketKeepAliveClient</span></a></span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-export types used by 'BlockFetchConsensusInterface'</span></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">FetchMode</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">FromConsensus</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SizeInBytes</span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">WhetherReceivingTentativeBlocks</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hashable</span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Void.html"><span class="hs-identifier">Data.Void</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadSTM</span></span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime.SI</span></span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTimer.SI</span></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Tracer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.SizeInBytes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ClientRegistry</span></a></span><span>
</span><span id="line-117"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier">FetchClientPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier">FetchClientRegistry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketFetchClient"><span class="hs-identifier">bracketFetchClient</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketKeepAliveClient"><span class="hs-identifier">bracketKeepAliveClient</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#bracketSyncWithFetchClient"><span class="hs-identifier">bracketSyncWithFetchClient</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#newFetchClientRegistry"><span class="hs-identifier">newFetchClientRegistry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStateVars"><span class="hs-identifier">readFetchClientsStateVars</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStatus"><span class="hs-identifier">readFetchClientsStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readPeerGSVs"><span class="hs-identifier">readPeerGSVs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#setFetchClientContext"><span class="hs-identifier">setFetchClientContext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ConsensusInterface</span></span><span>
</span><span id="line-123"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BlockFetchConsensusInterface</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">FromConsensus</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>                     </span><span class="annot"><span class="hs-identifier">WhetherReceivingTentativeBlocks</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.State</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- | Configuration for FetchDecisionPolicy.</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- Should be determined by external local node config.</span><span>
</span><span id="line-131"></span><span class="hs-keyword">data</span><span> </span><span id="BlockFetchConfiguration"><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-var">BlockFetchConfiguration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-132"></span><span>     </span><span id="BlockFetchConfiguration"><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-var">BlockFetchConfiguration</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-133"></span><span>         </span><span class="annot"><span class="hs-comment">-- | Maximum concurrent downloads during bulk syncing.</span></span><span>
</span><span id="line-134"></span><span>         </span><span id="bfcMaxConcurrencyBulkSync"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.html#bfcMaxConcurrencyBulkSync"><span class="hs-identifier hs-var hs-var">bfcMaxConcurrencyBulkSync</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>         </span><span class="annot"><span class="hs-comment">-- | Maximum concurrent downloads during deadline syncing.</span></span><span>
</span><span id="line-137"></span><span>         </span><span id="bfcMaxConcurrencyDeadline"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.html#bfcMaxConcurrencyDeadline"><span class="hs-identifier hs-var hs-var">bfcMaxConcurrencyDeadline</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span>         </span><span class="annot"><span class="hs-comment">-- | Maximum requests in flight per each peer.</span></span><span>
</span><span id="line-140"></span><span>         </span><span id="bfcMaxRequestsInflight"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.html#bfcMaxRequestsInflight"><span class="hs-identifier hs-var hs-var">bfcMaxRequestsInflight</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span>         </span><span class="annot"><span class="hs-comment">-- | Desired interval between calls to fetchLogicIteration</span></span><span>
</span><span id="line-143"></span><span>         </span><span id="bfcDecisionLoopInterval"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; DiffTime
</span><a href="Ouroboros.Network.BlockFetch.html#bfcDecisionLoopInterval"><span class="hs-identifier hs-var hs-var">bfcDecisionLoopInterval</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span>         </span><span class="annot"><span class="hs-comment">-- | Salt used when comparing peers</span></span><span>
</span><span id="line-146"></span><span>         </span><span id="bfcSalt"><span class="annot"><span class="annottext">BlockFetchConfiguration -&gt; Int
</span><a href="Ouroboros.Network.BlockFetch.html#bfcSalt"><span class="hs-identifier hs-var hs-var">bfcSalt</span></a></span></span><span>                   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-147"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-148"></span><span>     </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679213129"><span id="local-6989586621679213141"><span id="local-6989586621679213145"><span class="annot"><span class="annottext">Int -&gt; BlockFetchConfiguration -&gt; ShowS
[BlockFetchConfiguration] -&gt; ShowS
BlockFetchConfiguration -&gt; String
(Int -&gt; BlockFetchConfiguration -&gt; ShowS)
-&gt; (BlockFetchConfiguration -&gt; String)
-&gt; ([BlockFetchConfiguration] -&gt; ShowS)
-&gt; Show BlockFetchConfiguration
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; BlockFetchConfiguration -&gt; ShowS
showsPrec :: Int -&gt; BlockFetchConfiguration -&gt; ShowS
$cshow :: BlockFetchConfiguration -&gt; String
show :: BlockFetchConfiguration -&gt; String
$cshowList :: [BlockFetchConfiguration] -&gt; ShowS
showList :: [BlockFetchConfiguration] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span class="hs-comment">-- | Execute the block fetch logic. It monitors the current chain and candidate</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- chains. It decided which block bodies to fetch and manages the process of</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- fetching them, including making alternative decisions based on timeouts and</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- failures.</span><span>
</span><span id="line-154"></span><span class="hs-comment">--</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- This runs forever and should be shut down using mechanisms such as async.</span><span>
</span><span id="line-156"></span><span class="hs-comment">--</span><span>
</span><span id="line-157"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier hs-type">blockFetchLogic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679213007"><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span></span><span> </span><span id="local-6989586621679213000"><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679213002"><span class="annot"><a href="#local-6989586621679213002"><span class="hs-identifier hs-type">block</span></a></span></span><span> </span><span id="local-6989586621679213004"><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-158"></span><span>                   </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-159"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679213002"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-160"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679213002"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-161"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadDelay</span></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-162"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-163"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-164"></span><span>                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span>
</span><span id="line-165"></span><span>                   </span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-167"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TraceLabelPeer</span></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#TraceFetchClientState"><span class="hs-identifier hs-type">TraceFetchClientState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213002"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-169"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#FetchClientRegistry"><span class="hs-identifier hs-type">FetchClientRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213002"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-170"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-type">BlockFetchConfiguration</span></a></span><span>
</span><span id="line-171"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#Void"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-172"></span><span id="blockFetchLogic"><span class="annot"><span class="annottext">blockFetchLogic :: forall addr header block (m :: * -&gt; *).
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block, MonadDelay m, MonadSTM m,
 Ord addr, Hashable addr) =&gt;
Tracer m [TraceLabelPeer addr (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer addr (TraceFetchClientState header))
-&gt; BlockFetchConsensusInterface addr header block m
-&gt; FetchClientRegistry addr header block m
-&gt; BlockFetchConfiguration
-&gt; m Void
</span><a href="Ouroboros.Network.BlockFetch.html#blockFetchLogic"><span class="hs-identifier hs-var hs-var">blockFetchLogic</span></a></span></span><span> </span><span id="local-6989586621679213178"><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer addr (FetchDecision [Point header])]
</span><a href="#local-6989586621679213178"><span class="hs-identifier hs-var">decisionTracer</span></a></span></span><span> </span><span id="local-6989586621679213179"><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer addr (TraceFetchClientState header))
</span><a href="#local-6989586621679213179"><span class="hs-identifier hs-var">clientStateTracer</span></a></span></span><span>
</span><span id="line-173"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">BlockFetchConsensusInterface</span></span><span class="hs-special">{</span><span id="local-6989586621679213180"><span id="local-6989586621679213181"><span id="local-6989586621679213182"><span id="local-6989586621679213183"><span id="local-6989586621679213184"><span id="local-6989586621679213185"><span id="local-6989586621679213186"><span id="local-6989586621679213187"><span id="local-6989586621679213188"><span id="local-6989586621679213189"><span id="local-6989586621679213190"><span id="local-6989586621679213191"><span class="annot"><span class="annottext">STM m (Map addr (AnchoredFragment header))
STM m (AnchoredFragment header)
STM m MaxSlotNo
STM m FetchMode
STM m (Point block -&gt; Bool)
header -&gt; SizeInBytes
header -&gt; block -&gt; Bool
HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
FromConsensus header -&gt; STM m UTCTime
FromConsensus block -&gt; STM m UTCTime
WhetherReceivingTentativeBlocks
-&gt; STM m (Point block -&gt; block -&gt; m ())
readCandidateChains :: STM m (Map addr (AnchoredFragment header))
readCurrentChain :: STM m (AnchoredFragment header)
readFetchMode :: STM m FetchMode
readFetchedBlocks :: STM m (Point block -&gt; Bool)
mkAddFetchedBlock :: WhetherReceivingTentativeBlocks
-&gt; STM m (Point block -&gt; block -&gt; m ())
readFetchedMaxSlotNo :: STM m MaxSlotNo
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
blockFetchSize :: header -&gt; SizeInBytes
blockMatchesHeader :: header -&gt; block -&gt; Bool
headerForgeUTCTime :: FromConsensus header -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus block -&gt; STM m UTCTime
blockFetchSize :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; header -&gt; SizeInBytes
blockForgeUTCTime :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; FromConsensus block -&gt; STM m UTCTime
blockMatchesHeader :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; header -&gt; block -&gt; Bool
compareCandidateChains :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
headerForgeUTCTime :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; FromConsensus header -&gt; STM m UTCTime
mkAddFetchedBlock :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; WhetherReceivingTentativeBlocks
-&gt; STM m (Point block -&gt; block -&gt; m ())
plausibleCandidateChain :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
readCandidateChains :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; STM m (Map peer (AnchoredFragment header))
readCurrentChain :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; STM m (AnchoredFragment header)
readFetchMode :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m -&gt; STM m FetchMode
readFetchedBlocks :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m
-&gt; STM m (Point block -&gt; Bool)
readFetchedMaxSlotNo :: forall peer header block (m :: * -&gt; *).
BlockFetchConsensusInterface peer header block m -&gt; STM m MaxSlotNo
</span><a href="#local-6989586621679213180"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>                </span><span id="local-6989586621679213204"><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
</span><a href="#local-6989586621679213204"><span class="hs-identifier hs-var">registry</span></a></span></span><span>
</span><span id="line-175"></span><span>                </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.html#BlockFetchConfiguration"><span class="hs-identifier hs-type">BlockFetchConfiguration</span></a></span><span class="hs-special">{</span><span id="local-6989586621679213205"><span id="local-6989586621679213206"><span id="local-6989586621679213207"><span id="local-6989586621679213208"><span id="local-6989586621679213209"><span class="annot"><span class="annottext">Int
Word
DiffTime
bfcMaxConcurrencyBulkSync :: BlockFetchConfiguration -&gt; Word
bfcMaxConcurrencyDeadline :: BlockFetchConfiguration -&gt; Word
bfcMaxRequestsInflight :: BlockFetchConfiguration -&gt; Word
bfcDecisionLoopInterval :: BlockFetchConfiguration -&gt; DiffTime
bfcSalt :: BlockFetchConfiguration -&gt; Int
bfcMaxConcurrencyBulkSync :: Word
bfcMaxConcurrencyDeadline :: Word
bfcMaxRequestsInflight :: Word
bfcDecisionLoopInterval :: DiffTime
bfcSalt :: Int
</span><a href="Ouroboros.Network.BlockFetch.html#bfcMaxConcurrencyBulkSync"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
-&gt; Tracer m (TraceLabelPeer addr (TraceFetchClientState header))
-&gt; (WhetherReceivingTentativeBlocks
    -&gt; STM m (FetchClientPolicy header block m))
-&gt; m ()
forall (m :: * -&gt; *) peer header block.
MonadSTM m =&gt;
FetchClientRegistry peer header block m
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; (WhetherReceivingTentativeBlocks
    -&gt; STM m (FetchClientPolicy header block m))
-&gt; m ()
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#setFetchClientContext"><span class="hs-identifier hs-var">setFetchClientContext</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
</span><a href="#local-6989586621679213204"><span class="hs-identifier hs-var">registry</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer addr (TraceFetchClientState header))
</span><a href="#local-6989586621679213179"><span class="hs-identifier hs-var">clientStateTracer</span></a></span><span> </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
-&gt; STM m (FetchClientPolicy header block m)
</span><a href="#local-6989586621679213210"><span class="hs-identifier hs-var">mkFetchClientPolicy</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer addr (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer addr (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables addr header m
-&gt; FetchNonTriggerVariables addr header block m
-&gt; m Void
forall header block (m :: * -&gt; *) peer.
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block, MonadDelay m, MonadSTM m,
 Ord peer, Hashable peer) =&gt;
Tracer m [TraceLabelPeer peer (FetchDecision [Point header])]
-&gt; Tracer m (TraceLabelPeer peer (TraceFetchClientState header))
-&gt; FetchDecisionPolicy header
-&gt; FetchTriggerVariables peer header m
-&gt; FetchNonTriggerVariables peer header block m
-&gt; m Void
</span><a href="Ouroboros.Network.BlockFetch.State.html#fetchLogicIterations"><span class="hs-identifier hs-var">fetchLogicIterations</span></a></span><span>
</span><span id="line-180"></span><span>      </span><span class="annot"><span class="annottext">Tracer m [TraceLabelPeer addr (FetchDecision [Point header])]
</span><a href="#local-6989586621679213178"><span class="hs-identifier hs-var">decisionTracer</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer m (TraceLabelPeer addr (TraceFetchClientState header))
</span><a href="#local-6989586621679213179"><span class="hs-identifier hs-var">clientStateTracer</span></a></span><span>
</span><span id="line-181"></span><span>      </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679213212"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><span class="annottext">FetchTriggerVariables addr header m
</span><a href="#local-6989586621679213213"><span class="hs-identifier hs-var">fetchTriggerVariables</span></a></span><span>
</span><span id="line-183"></span><span>      </span><span class="annot"><span class="annottext">FetchNonTriggerVariables addr header block m
</span><a href="#local-6989586621679213214"><span class="hs-identifier hs-var">fetchNonTriggerVariables</span></a></span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><a href="#local-6989586621679213210"><span class="hs-identifier hs-type">mkFetchClientPolicy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WhetherReceivingTentativeBlocks</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier hs-type">FetchClientPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213002"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>    </span><span id="local-6989586621679213210"><span class="annot"><span class="annottext">mkFetchClientPolicy :: WhetherReceivingTentativeBlocks
-&gt; STM m (FetchClientPolicy header block m)
</span><a href="#local-6989586621679213210"><span class="hs-identifier hs-var hs-var">mkFetchClientPolicy</span></a></span></span><span> </span><span id="local-6989586621679213215"><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><a href="#local-6989586621679213215"><span class="hs-identifier hs-var">receivingTentativeBlocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>      </span><span id="local-6989586621679213216"><span class="annot"><span class="annottext">Point block -&gt; block -&gt; m ()
</span><a href="#local-6989586621679213216"><span class="hs-identifier hs-var">addFetchedBlock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
-&gt; STM m (Point block -&gt; block -&gt; m ())
</span><a href="#local-6989586621679213184"><span class="hs-identifier hs-var">mkAddFetchedBlock</span></a></span><span> </span><span class="annot"><span class="annottext">WhetherReceivingTentativeBlocks
</span><a href="#local-6989586621679213215"><span class="hs-identifier hs-var">receivingTentativeBlocks</span></a></span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="annottext">FetchClientPolicy header block m
-&gt; STM m (FetchClientPolicy header block m)
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchClientPolicy"><span class="hs-identifier hs-type">FetchClientPolicy</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-189"></span><span>          </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
</span><a href="#local-6989586621679213188"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-190"></span><span>          </span><span class="annot"><span class="annottext">header -&gt; block -&gt; Bool
blockMatchesHeader :: header -&gt; block -&gt; Bool
blockMatchesHeader :: header -&gt; block -&gt; Bool
</span><a href="#local-6989586621679213189"><span class="hs-identifier hs-var hs-var">blockMatchesHeader</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-191"></span><span>          </span><span class="annot"><span class="annottext">Point block -&gt; block -&gt; m ()
addFetchedBlock :: Point block -&gt; block -&gt; m ()
addFetchedBlock :: Point block -&gt; block -&gt; m ()
</span><a href="#local-6989586621679213216"><span class="hs-identifier hs-var hs-var">addFetchedBlock</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>          </span><span class="annot"><span class="annottext">FromConsensus block -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus block -&gt; STM m UTCTime
blockForgeUTCTime :: FromConsensus block -&gt; STM m UTCTime
</span><a href="#local-6989586621679213191"><span class="hs-identifier hs-var hs-var">blockForgeUTCTime</span></a></span><span>
</span><span id="line-193"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><a href="#local-6989586621679213212"><span class="hs-identifier hs-type">fetchDecisionPolicy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621679213212"><span class="annot"><span class="annottext">fetchDecisionPolicy :: FetchDecisionPolicy header
</span><a href="#local-6989586621679213212"><span class="hs-identifier hs-var hs-var">fetchDecisionPolicy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="annottext">maxInFlightReqsPerPeer :: Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxInFlightReqsPerPeer"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679213207"><span class="hs-identifier hs-var">bfcMaxRequestsInflight</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="annottext">maxConcurrencyBulkSync :: Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyBulkSync"><span class="hs-identifier hs-var">maxConcurrencyBulkSync</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679213205"><span class="hs-identifier hs-var">bfcMaxConcurrencyBulkSync</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><span class="annottext">maxConcurrencyDeadline :: Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyDeadline"><span class="hs-identifier hs-var">maxConcurrencyDeadline</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679213206"><span class="hs-identifier hs-var">bfcMaxConcurrencyDeadline</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-201"></span><span>        </span><span class="annot"><span class="annottext">decisionLoopInterval :: DiffTime
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#decisionLoopInterval"><span class="hs-identifier hs-var">decisionLoopInterval</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679213208"><span class="hs-identifier hs-var">bfcDecisionLoopInterval</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><span class="annottext">peerSalt :: Int
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#peerSalt"><span class="hs-identifier hs-var">peerSalt</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679213209"><span class="hs-identifier hs-var">bfcSalt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="#local-6989586621679213186"><span class="hs-identifier hs-var hs-var">plausibleCandidateChain</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-205"></span><span>        </span><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679213187"><span class="hs-identifier hs-var hs-var">compareCandidateChains</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-206"></span><span>        </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
</span><a href="#local-6989586621679213188"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span><span>
</span><span id="line-207"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><a href="#local-6989586621679213213"><span class="hs-identifier hs-type">fetchTriggerVariables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621679213213"><span class="annot"><span class="annottext">fetchTriggerVariables :: FetchTriggerVariables addr header m
</span><a href="#local-6989586621679213213"><span class="hs-identifier hs-var hs-var">fetchTriggerVariables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchTriggerVariables"><span class="hs-identifier hs-type">FetchTriggerVariables</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-212"></span><span>        </span><span class="annot"><span class="annottext">readStateCurrentChain :: STM m (AnchoredFragment header)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateCurrentChain"><span class="hs-identifier hs-var">readStateCurrentChain</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (AnchoredFragment header)
</span><a href="#local-6989586621679213181"><span class="hs-identifier hs-var">readCurrentChain</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-213"></span><span>        </span><span class="annot"><span class="annottext">readStateCandidateChains :: STM m (Map addr (AnchoredFragment header))
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateCandidateChains"><span class="hs-identifier hs-var">readStateCandidateChains</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (Map addr (AnchoredFragment header))
</span><a href="#local-6989586621679213180"><span class="hs-identifier hs-var">readCandidateChains</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-214"></span><span>        </span><span class="annot"><span class="annottext">readStatePeerStatus :: STM m (Map addr (PeerFetchStatus header))
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStatePeerStatus"><span class="hs-identifier hs-var">readStatePeerStatus</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
-&gt; STM m (Map addr (PeerFetchStatus header))
forall (m :: * -&gt; *) peer header block.
MonadSTM m =&gt;
FetchClientRegistry peer header block m
-&gt; STM m (Map peer (PeerFetchStatus header))
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStatus"><span class="hs-identifier hs-var">readFetchClientsStatus</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
</span><a href="#local-6989586621679213204"><span class="hs-identifier hs-var">registry</span></a></span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><a href="#local-6989586621679213214"><span class="hs-identifier hs-type">fetchNonTriggerVariables</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213007"><span class="hs-identifier hs-type">addr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213000"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213002"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679213004"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621679213214"><span class="annot"><span class="annottext">fetchNonTriggerVariables :: FetchNonTriggerVariables addr header block m
</span><a href="#local-6989586621679213214"><span class="hs-identifier hs-var hs-var">fetchNonTriggerVariables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.State.html#FetchNonTriggerVariables"><span class="hs-identifier hs-type">FetchNonTriggerVariables</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="annottext">readStateFetchedBlocks :: STM m (Point block -&gt; Bool)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateFetchedBlocks"><span class="hs-identifier hs-var">readStateFetchedBlocks</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (Point block -&gt; Bool)
</span><a href="#local-6989586621679213183"><span class="hs-identifier hs-var">readFetchedBlocks</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><span class="annottext">readStatePeerStateVars :: STM m (Map addr (FetchClientStateVars m header))
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStatePeerStateVars"><span class="hs-identifier hs-var">readStatePeerStateVars</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
-&gt; STM m (Map addr (FetchClientStateVars m header))
forall (m :: * -&gt; *) peer header block.
MonadSTM m =&gt;
FetchClientRegistry peer header block m
-&gt; STM m (Map peer (FetchClientStateVars m header))
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readFetchClientsStateVars"><span class="hs-identifier hs-var">readFetchClientsStateVars</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
</span><a href="#local-6989586621679213204"><span class="hs-identifier hs-var">registry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">readStatePeerGSVs :: STM m (Map addr PeerGSV)
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStatePeerGSVs"><span class="hs-identifier hs-var">readStatePeerGSVs</span></a></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m -&gt; STM m (Map addr PeerGSV)
forall block header (m :: * -&gt; *) peer.
(MonadSTM m, Ord peer) =&gt;
FetchClientRegistry peer header block m -&gt; STM m (Map peer PeerGSV)
</span><a href="Ouroboros.Network.BlockFetch.ClientRegistry.html#readPeerGSVs"><span class="hs-identifier hs-var">readPeerGSVs</span></a></span><span> </span><span class="annot"><span class="annottext">FetchClientRegistry addr header block m
</span><a href="#local-6989586621679213204"><span class="hs-identifier hs-var">registry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="annottext">readStateFetchMode :: STM m FetchMode
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateFetchMode"><span class="hs-identifier hs-var">readStateFetchMode</span></a></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m FetchMode
</span><a href="#local-6989586621679213182"><span class="hs-identifier hs-var">readFetchMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">readStateFetchedMaxSlotNo :: STM m MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.State.html#readStateFetchedMaxSlotNo"><span class="hs-identifier hs-var">readStateFetchedMaxSlotNo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m MaxSlotNo
</span><a href="#local-6989586621679213185"><span class="hs-identifier hs-var">readFetchedMaxSlotNo</span></a></span><span>
</span><span id="line-225"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-226"></span></pre></body></html>
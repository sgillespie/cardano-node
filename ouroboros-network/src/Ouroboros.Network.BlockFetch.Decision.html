<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns        #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns      #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies        #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ouroboros.Network.BlockFetch.Decision</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Deciding what to fetch</span></span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchDecisions"><span class="hs-identifier">fetchDecisions</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier">FetchDecisionPolicy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">FetchMode</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier">PeerInfo</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier">FetchDecision</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier">FetchDecline</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Components of the decision-making process</span></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterPlausibleCandidates"><span class="hs-identifier">filterPlausibleCandidates</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#selectForkSuffixes"><span class="hs-identifier">selectForkSuffixes</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyFetched"><span class="hs-identifier">filterNotAlreadyFetched</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithPeer"><span class="hs-identifier">filterNotAlreadyInFlightWithPeer</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier">prioritisePeerChains</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier">filterNotAlreadyInFlightWithOtherPeers</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecisions"><span class="hs-identifier">fetchRequestDecisions</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html"><span class="hs-identifier">Data.Function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-identifier">on</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#foldl%27"><span class="hs-identifier">foldl'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#groupBy"><span class="hs-identifier">groupBy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier">sortBy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#transpose"><span class="hs-identifier">transpose</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#mapMaybe"><span class="hs-identifier">mapMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.html"><span class="hs-identifier">GHC.Stack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier">HasCallStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier">assert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#guard"><span class="hs-identifier">guard</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadTime.SI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier">DiffTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">AnchoredFragment</span></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>                     </span><span class="annot"><span class="hs-identifier">AnchoredSeq</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.AnchoredFragment</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AF</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Block</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.Point</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">withOriginToMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ClientState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier">FetchRequest</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier">PeerFetchInFlight</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier">PeerFetchStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Ouroboros.Network.BlockFetch.ConsensusInterface</span></span><span>
</span><span id="line-48"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FetchMode</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html"><span class="hs-identifier">Ouroboros.Network.BlockFetch.DeltaQ</span></a></span><span>
</span><span id="line-50"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#PeerFetchInFlightLimits"><span class="hs-identifier">PeerFetchInFlightLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier">PeerGSV</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SizeInBytes</span></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#calculatePeerFetchInFlightLimits"><span class="hs-identifier">calculatePeerFetchInFlightLimits</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#comparePeerGSV"><span class="hs-identifier">comparePeerGSV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#comparePeerGSV%27"><span class="hs-identifier">comparePeerGSV'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateExpectedResponseDuration"><span class="hs-identifier">estimateExpectedResponseDuration</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateResponseDeadlineProbability"><span class="hs-identifier">estimateResponseDeadlineProbability</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">data</span><span> </span><span id="FetchDecisionPolicy"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-var">FetchDecisionPolicy</span></a></span></span><span> </span><span id="local-6989586621679210203"><span class="annot"><a href="#local-6989586621679210203"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FetchDecisionPolicy"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-var">FetchDecisionPolicy</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-57"></span><span>       </span><span id="maxInFlightReqsPerPeer"><span class="annot"><span class="annottext">forall header. FetchDecisionPolicy header -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxInFlightReqsPerPeer"><span class="hs-identifier hs-var hs-var">maxInFlightReqsPerPeer</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>  </span><span class="hs-comment">-- A protocol constant.</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span>       </span><span id="maxConcurrencyBulkSync"><span class="annot"><span class="annottext">forall header. FetchDecisionPolicy header -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyBulkSync"><span class="hs-identifier hs-var hs-var">maxConcurrencyBulkSync</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>       </span><span id="maxConcurrencyDeadline"><span class="annot"><span class="annottext">forall header. FetchDecisionPolicy header -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyDeadline"><span class="hs-identifier hs-var hs-var">maxConcurrencyDeadline</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>       </span><span id="decisionLoopInterval"><span class="annot"><span class="annottext">forall header. FetchDecisionPolicy header -&gt; DiffTime
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#decisionLoopInterval"><span class="hs-identifier hs-var hs-var">decisionLoopInterval</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/time-1.12.2/src/Data.Time.Clock.Internal.DiffTime.html#DiffTime"><span class="hs-identifier hs-type">DiffTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>       </span><span id="peerSalt"><span class="annot"><span class="annottext">forall header. FetchDecisionPolicy header -&gt; Int
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#peerSalt"><span class="hs-identifier hs-var hs-var">peerSalt</span></a></span></span><span>                </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span>       </span><span id="plausibleCandidateChain"><span class="annot"><span class="annottext">forall header.
FetchDecisionPolicy header
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#plausibleCandidateChain"><span class="hs-identifier hs-var hs-var">plausibleCandidateChain</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-65"></span><span>                               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210203"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-66"></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210203"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span>       </span><span id="compareCandidateChains"><span class="annot"><span class="annottext">forall header.
FetchDecisionPolicy header
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#compareCandidateChains"><span class="hs-identifier hs-var hs-var">compareCandidateChains</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Stack.Types.html#HasCallStack"><span class="hs-identifier hs-type">HasCallStack</span></a></span><span>
</span><span id="line-69"></span><span>                               </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210203"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-70"></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210203"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-71"></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Ordering"><span class="hs-identifier hs-type">Ordering</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span>       </span><span id="blockFetchSize"><span class="annot"><span class="annottext">forall header. FetchDecisionPolicy header -&gt; header -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#blockFetchSize"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679210203"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span>
</span><span id="line-74"></span><span>     </span><span class="hs-special">}</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">type</span><span> </span><span id="PeerInfo"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier hs-var">PeerInfo</span></a></span></span><span> </span><span id="local-6989586621679210529"><span class="annot"><a href="#local-6989586621679210529"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679210530"><span class="annot"><a href="#local-6989586621679210530"><span class="hs-identifier hs-type">peer</span></a></span></span><span> </span><span id="local-6989586621679210531"><span class="annot"><a href="#local-6989586621679210531"><span class="hs-identifier hs-type">extra</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>       </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210529"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>         </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210529"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>         </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>         </span><span class="annot"><a href="#local-6989586621679210530"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>         </span><span class="annot"><a href="#local-6989586621679210531"><span class="hs-identifier hs-type">extra</span></a></span><span>
</span><span id="line-83"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | Throughout the decision making process we accumulate reasons to decline</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- to fetch any blocks. This type is used to wrap intermediate and final</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- results.</span><span>
</span><span id="line-88"></span><span class="hs-comment">--</span><span>
</span><span id="line-89"></span><span class="hs-keyword">type</span><span> </span><span id="FetchDecision"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-var">FetchDecision</span></a></span></span><span> </span><span id="local-6989586621679210532"><span class="annot"><a href="#local-6989586621679210532"><span class="hs-identifier hs-type">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier hs-type">FetchDecline</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210532"><span class="hs-identifier hs-type">result</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-comment">-- | All the various reasons we can decide not to fetch blocks from a peer.</span><span>
</span><span id="line-92"></span><span class="hs-comment">--</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- It is worth highlighting which of these reasons result from competition</span><span>
</span><span id="line-94"></span><span class="hs-comment">-- among upstream peers.</span><span>
</span><span id="line-95"></span><span class="hs-comment">--</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- * 'FetchDeclineInFlightOtherPeer': decline this peer because all the</span><span>
</span><span id="line-97"></span><span class="hs-comment">--   unfetched blocks of its candidate chain have already been requested from</span><span>
</span><span id="line-98"></span><span class="hs-comment">--   other peers. This reason reflects the least-consequential competition</span><span>
</span><span id="line-99"></span><span class="hs-comment">--   among peers: the competition that determines merely which upstream peer to</span><span>
</span><span id="line-100"></span><span class="hs-comment">--   burden with the request (eg the one with the best</span><span>
</span><span id="line-101"></span><span class="hs-comment">--   'Ouroboros.Network.BlockFetch.DeltaQ.DeltaQ' metrics). The consequences</span><span>
</span><span id="line-102"></span><span class="hs-comment">--   are relatively minor because the unfetched blocks on this peer's candidate</span><span>
</span><span id="line-103"></span><span class="hs-comment">--   chain will be requested regardless; it's merely a question of &quot;From who?&quot;.</span><span>
</span><span id="line-104"></span><span class="hs-comment">--   (One exception: if an adversarial peer wins this competition such that the</span><span>
</span><span id="line-105"></span><span class="hs-comment">--   blocks are only requested from them, then it may be possible that this</span><span>
</span><span id="line-106"></span><span class="hs-comment">--   decision determines whether the blocks are ever /received/. But that</span><span>
</span><span id="line-107"></span><span class="hs-comment">--   depends on details of timeouts, a longer competing chain being soon</span><span>
</span><span id="line-108"></span><span class="hs-comment">--   received within those timeouts, and so on.)</span><span>
</span><span id="line-109"></span><span class="hs-comment">--</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- * 'FetchDeclineChainNotPlausible': decline this peer because the node has</span><span>
</span><span id="line-111"></span><span class="hs-comment">--   already fetched, validated, and selected a chain better than its candidate</span><span>
</span><span id="line-112"></span><span class="hs-comment">--   chain from other peers (or from the node's own block forge). Because the</span><span>
</span><span id="line-113"></span><span class="hs-comment">--   node's current selection is influenced by what blocks other peers have</span><span>
</span><span id="line-114"></span><span class="hs-comment">--   recently served (or it recently minted), this reason reflects that peers</span><span>
</span><span id="line-115"></span><span class="hs-comment">--   /indirectly/ compete by serving as long of a chain as possible and as</span><span>
</span><span id="line-116"></span><span class="hs-comment">--   promptly as possible. When the tips of the peers' selections are all</span><span>
</span><span id="line-117"></span><span class="hs-comment">--   within their respective forecast horizons (see</span><span>
</span><span id="line-118"></span><span class="hs-comment">--   'Ouroboros.Consensus.Ledger.SupportsProtocol.ledgerViewForecastAt'), then</span><span>
</span><span id="line-119"></span><span class="hs-comment">--   the length of their candidate chains will typically be the length of their</span><span>
</span><span id="line-120"></span><span class="hs-comment">--   selections, since the ChainSync is free to race ahead (in contrast, the</span><span>
</span><span id="line-121"></span><span class="hs-comment">--   BlockFetch pipeline depth is bounded such that it will, for a syncing</span><span>
</span><span id="line-122"></span><span class="hs-comment">--   node, not be able to request all blocks between the selection and the end</span><span>
</span><span id="line-123"></span><span class="hs-comment">--   of the forecast window). But if one or more of their tips is beyond the</span><span>
</span><span id="line-124"></span><span class="hs-comment">--   horizon, then the relative length of the candidate chains is more</span><span>
</span><span id="line-125"></span><span class="hs-comment">--   complicated, influenced by both the relative density of the chains'</span><span>
</span><span id="line-126"></span><span class="hs-comment">--   suffixes and the relative age of the chains' intersection with the node's</span><span>
</span><span id="line-127"></span><span class="hs-comment">--   selection (since each peer's forecast horizon is a fixed number of slots</span><span>
</span><span id="line-128"></span><span class="hs-comment">--   after the candidate's successor of that intersection).</span><span>
</span><span id="line-129"></span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- * 'FetchDeclineConcurrencyLimit': decline this peer while the node has</span><span>
</span><span id="line-131"></span><span class="hs-comment">--   already fully allocated the artificially scarce 'maxConcurrentFetchPeers'</span><span>
</span><span id="line-132"></span><span class="hs-comment">--   resource amongst its other peers. This reason reflects the</span><span>
</span><span id="line-133"></span><span class="hs-comment">--   least-fundamental competition: it's the only way a node would decline a</span><span>
</span><span id="line-134"></span><span class="hs-comment">--   candidate chain C that it would immediately switch to if C had somehow</span><span>
</span><span id="line-135"></span><span class="hs-comment">--   already been fetched (and any better current candidates hadn't). It is</span><span>
</span><span id="line-136"></span><span class="hs-comment">--   possible that this peer's candidate fragment is better than the candidate</span><span>
</span><span id="line-137"></span><span class="hs-comment">--   fragments of other peers, but that should only happen ephemerally (eg for</span><span>
</span><span id="line-138"></span><span class="hs-comment">--   a brief while immediately after first connecting to this peer).</span><span>
</span><span id="line-139"></span><span class="hs-comment">--</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- * 'FetchDeclineChainIntersectionTooDeep': decline this peer because the node's</span><span>
</span><span id="line-141"></span><span class="hs-comment">--   selection has more than @K@ blocks that are not on this peer's candidate</span><span>
</span><span id="line-142"></span><span class="hs-comment">--   chain. Typically, this reason occurs after the node has been declined---ie</span><span>
</span><span id="line-143"></span><span class="hs-comment">--   lost the above competitions---for a long enough duration. This decision</span><span>
</span><span id="line-144"></span><span class="hs-comment">--   only arises if the BlockFetch decision logic wins a harmless race against</span><span>
</span><span id="line-145"></span><span class="hs-comment">--   the ChainSync client once the node's selection gets longer, since</span><span>
</span><span id="line-146"></span><span class="hs-comment">--   'Ouroboros.Consensus.MiniProtocol.ChainSync.Client.ForkTooDeep'</span><span>
</span><span id="line-147"></span><span class="hs-comment">--   disconnects from such a peer.</span><span>
</span><span id="line-148"></span><span class="hs-comment">--</span><span>
</span><span id="line-149"></span><span class="hs-keyword">data</span><span> </span><span id="FetchDecline"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier hs-var">FetchDecline</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-150"></span><span>     </span><span class="hs-comment">-- | This peer's candidate chain is not longer than our chain. For more</span><span>
</span><span id="line-151"></span><span>     </span><span class="hs-comment">-- details see</span><span>
</span><span id="line-152"></span><span>     </span><span class="hs-comment">-- 'Ouroboros.Consensus.MiniProtocol.BlockFetch.ClientInterface.mkBlockFetchConsensusInterface'</span><span>
</span><span id="line-153"></span><span>     </span><span class="hs-comment">-- which implements 'plausibleCandidateChain'.</span><span>
</span><span id="line-154"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-155"></span><span>     </span><span id="FetchDeclineChainNotPlausible"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainNotPlausible"><span class="hs-identifier hs-var">FetchDeclineChainNotPlausible</span></a></span></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>     </span><span class="hs-comment">-- | Switching to this peer's candidate chain would require rolling back</span><span>
</span><span id="line-158"></span><span>     </span><span class="hs-comment">-- more than @K@ blocks.</span><span>
</span><span id="line-159"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-160"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclineChainIntersectionTooDeep"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainIntersectionTooDeep"><span class="hs-identifier hs-var">FetchDeclineChainIntersectionTooDeep</span></a></span></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>     </span><span class="hs-comment">-- | Every block on this peer's candidate chain has already been fetched.</span><span>
</span><span id="line-163"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-164"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclineAlreadyFetched"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineAlreadyFetched"><span class="hs-identifier hs-var">FetchDeclineAlreadyFetched</span></a></span></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>     </span><span class="hs-comment">-- | This peer's candidate chain has already been requested from this</span><span>
</span><span id="line-167"></span><span>     </span><span class="hs-comment">-- peer.</span><span>
</span><span id="line-168"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-169"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclineInFlightThisPeer"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightThisPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightThisPeer</span></a></span></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>     </span><span class="hs-comment">-- | Some blocks on this peer's candidate chain have not yet been fetched,</span><span>
</span><span id="line-172"></span><span>     </span><span class="hs-comment">-- but all of those have already been requested from other peers.</span><span>
</span><span id="line-173"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-174"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclineInFlightOtherPeer"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightOtherPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightOtherPeer</span></a></span></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span>     </span><span class="hs-comment">-- | This peer's BlockFetch client is shutting down, see</span><span>
</span><span id="line-177"></span><span>     </span><span class="hs-comment">-- 'PeerFetchStatusShutdown'.</span><span>
</span><span id="line-178"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-179"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclinePeerShutdown"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerShutdown"><span class="hs-identifier hs-var">FetchDeclinePeerShutdown</span></a></span></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>     </span><span class="annot"><span class="hs-comment">-- | Blockfetch is starting up and waiting on corresponding Chainsync.</span></span><span>
</span><span id="line-182"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclinePeerStarting"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerStarting"><span class="hs-identifier hs-var">FetchDeclinePeerStarting</span></a></span></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>   </span><span class="hs-comment">-- The reasons above this comment are fundamental and/or obvious. On the</span><span>
</span><span id="line-186"></span><span>   </span><span class="hs-comment">-- other hand, the reasons below are heuristic.</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>     </span><span class="hs-comment">-- | This peer is in a potentially-temporary state in which it has not</span><span>
</span><span id="line-190"></span><span>     </span><span class="hs-comment">-- responded to us within a certain expected time limit, see</span><span>
</span><span id="line-191"></span><span>     </span><span class="hs-comment">-- 'PeerFetchStatusAberrant'.</span><span>
</span><span id="line-192"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-193"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclinePeerSlow"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerSlow"><span class="hs-identifier hs-var">FetchDeclinePeerSlow</span></a></span></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>     </span><span class="hs-comment">-- | This peer is not under the 'maxInFlightReqsPerPeer' limit.</span><span>
</span><span id="line-196"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-197"></span><span>     </span><span class="hs-comment">-- The argument is the 'maxInFlightReqsPerPeer' constant.</span><span>
</span><span id="line-198"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclineReqsInFlightLimit"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineReqsInFlightLimit"><span class="hs-identifier hs-var">FetchDeclineReqsInFlightLimit</span></a></span></span><span>  </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>     </span><span class="hs-comment">-- | This peer is not under the 'inFlightBytesHighWatermark' bytes limit.</span><span>
</span><span id="line-202"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span>     </span><span class="hs-comment">-- The arguments are:</span><span>
</span><span id="line-204"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-205"></span><span>     </span><span class="hs-comment">-- * number of bytes currently in flight for that peer</span><span>
</span><span id="line-206"></span><span>     </span><span class="hs-comment">-- * the configured 'inFlightBytesLowWatermark' constant</span><span>
</span><span id="line-207"></span><span>     </span><span class="hs-comment">-- * the configured 'inFlightBytesHighWatermark' constant</span><span>
</span><span id="line-208"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-209"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclineBytesInFlightLimit"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineBytesInFlightLimit"><span class="hs-identifier hs-var">FetchDeclineBytesInFlightLimit</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>     </span><span class="hs-comment">-- | This peer is not under the 'inFlightBytesLowWatermark'.</span><span>
</span><span id="line-212"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-213"></span><span>     </span><span class="hs-comment">-- The arguments are:</span><span>
</span><span id="line-214"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-215"></span><span>     </span><span class="hs-comment">-- * number of bytes currently in flight for that peer</span><span>
</span><span id="line-216"></span><span>     </span><span class="hs-comment">-- * the configured 'inFlightBytesLowWatermark' constant</span><span>
</span><span id="line-217"></span><span>     </span><span class="hs-comment">-- * the configured 'inFlightBytesHighWatermark' constant</span><span>
</span><span id="line-218"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-219"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclinePeerBusy"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerBusy"><span class="hs-identifier hs-var">FetchDeclinePeerBusy</span></a></span></span><span>           </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span>     </span><span class="hs-comment">-- | The node is not under the 'maxConcurrentFetchPeers' limit.</span><span>
</span><span id="line-222"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-223"></span><span>     </span><span class="hs-comment">-- The arguments are:</span><span>
</span><span id="line-224"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-225"></span><span>     </span><span class="hs-comment">-- * the current 'FetchMode'</span><span>
</span><span id="line-226"></span><span>     </span><span class="hs-comment">-- * the corresponding configured limit constant, either</span><span>
</span><span id="line-227"></span><span>     </span><span class="hs-comment">--   'maxConcurrencyBulkSync' or 'maxConcurrencyDeadline'</span><span>
</span><span id="line-228"></span><span>     </span><span class="hs-comment">--</span><span>
</span><span id="line-229"></span><span>   </span><span class="hs-glyph">|</span><span> </span><span id="FetchDeclineConcurrencyLimit"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineConcurrencyLimit"><span class="hs-identifier hs-var">FetchDeclineConcurrencyLimit</span></a></span></span><span>   </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210550"><span id="local-6989586621679210564"><span class="annot"><span class="annottext">FetchDecline -&gt; FetchDecline -&gt; Bool
(FetchDecline -&gt; FetchDecline -&gt; Bool)
-&gt; (FetchDecline -&gt; FetchDecline -&gt; Bool) -&gt; Eq FetchDecline
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: FetchDecline -&gt; FetchDecline -&gt; Bool
== :: FetchDecline -&gt; FetchDecline -&gt; Bool
$c/= :: FetchDecline -&gt; FetchDecline -&gt; Bool
/= :: FetchDecline -&gt; FetchDecline -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210569"><span id="local-6989586621679210588"><span id="local-6989586621679210592"><span class="annot"><span class="annottext">Int -&gt; FetchDecline -&gt; ShowS
[FetchDecline] -&gt; ShowS
FetchDecline -&gt; String
(Int -&gt; FetchDecline -&gt; ShowS)
-&gt; (FetchDecline -&gt; String)
-&gt; ([FetchDecline] -&gt; ShowS)
-&gt; Show FetchDecline
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; FetchDecline -&gt; ShowS
showsPrec :: Int -&gt; FetchDecline -&gt; ShowS
$cshow :: FetchDecline -&gt; String
show :: FetchDecline -&gt; String
$cshowList :: [FetchDecline] -&gt; ShowS
showList :: [FetchDecline] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-comment">-- | The \&quot;oh noes?!\&quot; operator.</span><span>
</span><span id="line-234"></span><span class="hs-comment">--</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- In the case of an error, the operator provides a specific error value.</span><span>
</span><span id="line-236"></span><span class="hs-comment">--</span><span>
</span><span id="line-237"></span><span id="local-6989586621679210222"><span id="local-6989586621679210223"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-type">(?!)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210222"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210223"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210223"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210222"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-238"></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679210596"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210596"><span class="hs-identifier hs-var">x</span></a></span></span><span>  </span><span id="%3F%21"><span class="annot"><span class="annottext">?! :: forall a e. Maybe a -&gt; e -&gt; Either e a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var hs-var">?!</span></a></span></span><span> </span><span class="annot"><span class="annottext">e
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Either e a
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210596"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-239"></span><span class="annot"><span class="annottext">Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a></span><span> </span><span id="local-6989586621679210597"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679210597"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">e -&gt; Either e a
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span>  </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679210597"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="hs-comment">-- | The combination of a 'ChainSuffix' and a list of discontiguous</span><span>
</span><span id="line-242"></span><span class="hs-comment">-- 'AnchoredFragment's:</span><span>
</span><span id="line-243"></span><span class="hs-comment">--</span><span>
</span><span id="line-244"></span><span class="hs-comment">-- * When comparing two 'CandidateFragments' as candidate chains, we use the</span><span>
</span><span id="line-245"></span><span class="hs-comment">--   'ChainSuffix'.</span><span>
</span><span id="line-246"></span><span class="hs-comment">--</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- * To track which blocks of that candidate still have to be downloaded, we</span><span>
</span><span id="line-248"></span><span class="hs-comment">--   use a list of discontiguous 'AnchoredFragment's.</span><span>
</span><span id="line-249"></span><span class="hs-comment">--</span><span>
</span><span id="line-250"></span><span class="hs-keyword">type</span><span> </span><span id="CandidateFragments"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-var">CandidateFragments</span></a></span></span><span> </span><span id="local-6989586621679210599"><span class="annot"><a href="#local-6989586621679210599"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210599"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210599"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span id="local-6989586621679210228"><span id="local-6989586621679210230"><span id="local-6989586621679210233"><span id="local-6989586621679210236"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchDecisions"><span class="hs-identifier hs-type">fetchDecisions</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210228"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-255"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679210228"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-256"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210233"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679210233"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier hs-type">PeerInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210228"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210236"><span class="hs-identifier hs-type">extra</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#PeerInfo"><span class="hs-identifier hs-type">PeerInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210230"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210228"><span class="hs-identifier hs-type">peer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210236"><span class="hs-identifier hs-type">extra</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-265"></span><span id="fetchDecisions"><span class="annot"><span class="annottext">fetchDecisions :: forall peer header block extra.
(Ord peer, Hashable peer, HasHeader header,
 HeaderHash header ~ HeaderHash block) =&gt;
FetchDecisionPolicy header
-&gt; FetchMode
-&gt; AnchoredFragment header
-&gt; (Point block -&gt; Bool)
-&gt; MaxSlotNo
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer extra)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchDecisions"><span class="hs-identifier hs-var hs-var">fetchDecisions</span></a></span></span><span> </span><span id="local-6989586621679210623"><span class="annot"><span class="annottext">fetchDecisionPolicy :: FetchDecisionPolicy header
</span><a href="#local-6989586621679210623"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-266"></span><span>                 </span><span id="local-6989586621679210624"><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
plausibleCandidateChain :: forall header.
FetchDecisionPolicy header
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
plausibleCandidateChain :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#plausibleCandidateChain"><span class="hs-identifier hs-var hs-var">plausibleCandidateChain</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-267"></span><span>                 </span><span id="local-6989586621679210625"><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
compareCandidateChains :: forall header.
FetchDecisionPolicy header
-&gt; HasCallStack =&gt;
   AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
compareCandidateChains :: HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#compareCandidateChains"><span class="hs-identifier hs-var hs-var">compareCandidateChains</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-268"></span><span>                 </span><span id="local-6989586621679210626"><span class="annot"><span class="annottext">header -&gt; SizeInBytes
blockFetchSize :: forall header. FetchDecisionPolicy header -&gt; header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#blockFetchSize"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-269"></span><span>                 </span><span id="local-6989586621679210627"><span class="annot"><span class="annottext">Int
peerSalt :: forall header. FetchDecisionPolicy header -&gt; Int
peerSalt :: Int
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#peerSalt"><span class="hs-identifier hs-var hs-var">peerSalt</span></a></span></span><span>
</span><span id="line-270"></span><span>               </span><span class="hs-special">}</span><span>
</span><span id="line-271"></span><span>               </span><span id="local-6989586621679210628"><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679210628"><span class="hs-identifier hs-var">fetchMode</span></a></span></span><span>
</span><span id="line-272"></span><span>               </span><span id="local-6989586621679210629"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210629"><span class="hs-identifier hs-var">currentChain</span></a></span></span><span>
</span><span id="line-273"></span><span>               </span><span id="local-6989586621679210630"><span class="annot"><span class="annottext">Point block -&gt; Bool
</span><a href="#local-6989586621679210630"><span class="hs-identifier hs-var">fetchedBlocks</span></a></span></span><span>
</span><span id="line-274"></span><span>               </span><span id="local-6989586621679210631"><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679210631"><span class="hs-identifier hs-var">fetchedMaxSlotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-comment">-- Finally, make a decision for each (chain, peer) pair.</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
-&gt; FetchMode
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra)]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer extra)]
forall extra header peer.
(Hashable peer, HasHeader header, Ord peer) =&gt;
FetchDecisionPolicy header
-&gt; FetchMode
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(FetchDecision (FetchRequest header), extra)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecisions"><span class="hs-identifier hs-var">fetchRequestDecisions</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679210623"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679210628"><span class="hs-identifier hs-var">fetchMode</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
   PeerFetchInFlight header, PeerGSV, peer,
   PeerInfo header peer extra)]
 -&gt; [(FetchDecision (FetchRequest header),
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision [AnchoredFragment header],
         PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (FetchRequest header),
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision [AnchoredFragment header],
  PeerInfo header peer extra)
 -&gt; (FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra))
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecision [AnchoredFragment header],
 PeerInfo header peer extra)
-&gt; (FetchDecision [AnchoredFragment header],
    PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
    PeerInfo header peer extra)
forall {a} {b} {c} {d} {e} {e}.
(a, (b, c, d, e, e)) -&gt; (a, b, c, d, e, (b, c, d, e, e))
</span><a href="#local-6989586621679210633"><span class="hs-identifier hs-var">swizzleSIG</span></a></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- Filter to keep blocks that are not already in-flight with other peers.</span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision [AnchoredFragment header],
   PeerInfo header peer extra)]
 -&gt; [(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision [AnchoredFragment header],
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FetchMode
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header,
     PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerInfo header peer extra)]
forall header peerinfo.
HasHeader header =&gt;
FetchMode
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, peerinfo)]
-&gt; [(FetchDecision [AnchoredFragment header], peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier hs-var">filterNotAlreadyInFlightWithOtherPeers</span></a></span><span>
</span><span id="line-284"></span><span>      </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679210628"><span class="hs-identifier hs-var">fetchMode</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
   PeerFetchInFlight header, PeerInfo header peer extra)]
 -&gt; [(FetchDecision [AnchoredFragment header],
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision [AnchoredFragment header],
         PeerFetchStatus header, PeerFetchInFlight header,
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision [AnchoredFragment header],
  PeerInfo header peer extra)
 -&gt; (FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header,
     PeerInfo header peer extra))
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header,
     PeerInfo header peer extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecision [AnchoredFragment header],
 PeerInfo header peer extra)
-&gt; (FetchDecision [AnchoredFragment header],
    PeerFetchStatus header, PeerFetchInFlight header,
    PeerInfo header peer extra)
forall {a} {b} {c} {c} {d} {e}.
(a, (b, c, c, d, e)) -&gt; (a, b, c, (b, c, c, d, e))
</span><a href="#local-6989586621679210634"><span class="hs-identifier hs-var">swizzleSI</span></a></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-comment">-- Reorder chains based on consensus policy and network timing data.</span><span>
</span><span id="line-288"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision [AnchoredFragment header],
   PeerInfo header peer extra)]
 -&gt; [(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header,
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision [AnchoredFragment header],
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header,
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">FetchMode
-&gt; Int
-&gt; (AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering)
-&gt; (header -&gt; SizeInBytes)
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerInfo header peer extra)]
forall extra header peer.
(HasHeader header, Hashable peer, Ord peer) =&gt;
FetchMode
-&gt; Int
-&gt; (AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering)
-&gt; (header -&gt; SizeInBytes)
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(FetchDecision [AnchoredFragment header], extra)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier hs-var">prioritisePeerChains</span></a></span><span>
</span><span id="line-289"></span><span>      </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679210628"><span class="hs-identifier hs-var">fetchMode</span></a></span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679210627"><span class="hs-identifier hs-var">peerSalt</span></a></span><span>
</span><span id="line-291"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679210625"><span class="hs-identifier hs-var">compareCandidateChains</span></a></span><span>
</span><span id="line-292"></span><span>      </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679210626"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (CandidateFragments header),
   PeerFetchInFlight header, PeerGSV, peer,
   PeerInfo header peer extra)]
 -&gt; [(FetchDecision [AnchoredFragment header],
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision (CandidateFragments header),
         PeerFetchInFlight header, PeerGSV, peer,
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision (CandidateFragments header),
  PeerInfo header peer extra)
 -&gt; (FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra))
-&gt; [(FetchDecision (CandidateFragments header),
     PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecision (CandidateFragments header),
 PeerInfo header peer extra)
-&gt; (FetchDecision (CandidateFragments header),
    PeerFetchInFlight header, PeerGSV, peer,
    PeerInfo header peer extra)
forall {a} {a} {b} {c} {d} {e}.
(a, (a, b, c, d, e)) -&gt; (a, b, c, d, (a, b, c, d, e))
</span><a href="#local-6989586621679210635"><span class="hs-identifier hs-var">swizzleIG</span></a></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-comment">-- Filter to keep blocks that are not already in-flight for this peer.</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (CandidateFragments header),
   PeerInfo header peer extra)]
 -&gt; [(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer,
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision (CandidateFragments header),
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer,
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[(FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerInfo header peer extra)]
forall header peerinfo.
HasHeader header =&gt;
[(FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, peerinfo)]
-&gt; [(FetchDecision (CandidateFragments header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithPeer"><span class="hs-identifier hs-var">filterNotAlreadyInFlightWithPeer</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (CandidateFragments header),
   PeerFetchInFlight header, PeerInfo header peer extra)]
 -&gt; [(FetchDecision (CandidateFragments header),
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision (CandidateFragments header),
         PeerFetchInFlight header, PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision (CandidateFragments header),
  PeerInfo header peer extra)
 -&gt; (FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerInfo header peer extra))
-&gt; [(FetchDecision (CandidateFragments header),
     PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerInfo header peer extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecision (CandidateFragments header),
 PeerInfo header peer extra)
-&gt; (FetchDecision (CandidateFragments header),
    PeerFetchInFlight header, PeerInfo header peer extra)
forall {a} {a} {b} {c} {d} {e}.
(a, (a, b, c, d, e)) -&gt; (a, b, (a, b, c, d, e))
</span><a href="#local-6989586621679210636"><span class="hs-identifier hs-var">swizzleI</span></a></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-comment">-- Filter to keep blocks that have not already been downloaded.</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (CandidateFragments header),
   PeerInfo header peer extra)]
 -&gt; [(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision (CandidateFragments header),
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Point block -&gt; Bool)
-&gt; MaxSlotNo
-&gt; [(FetchDecision (ChainSuffix header),
     PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerInfo header peer extra)]
forall header block peerinfo.
(HasHeader header, HeaderHash header ~ HeaderHash block) =&gt;
(Point block -&gt; Bool)
-&gt; MaxSlotNo
-&gt; [(FetchDecision (ChainSuffix header), peerinfo)]
-&gt; [(FetchDecision (CandidateFragments header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyFetched"><span class="hs-identifier hs-var">filterNotAlreadyFetched</span></a></span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><span class="annottext">Point block -&gt; Bool
</span><a href="#local-6989586621679210630"><span class="hs-identifier hs-var">fetchedBlocks</span></a></span><span>
</span><span id="line-302"></span><span>      </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679210631"><span class="hs-identifier hs-var">fetchedMaxSlotNo</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-comment">-- Select the suffix up to the intersection with the current chain.</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (ChainSuffix header), PeerInfo header peer extra)]
 -&gt; [(FetchDecision (CandidateFragments header),
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision (ChainSuffix header),
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
-&gt; [(FetchDecision (AnchoredFragment header),
     PeerInfo header peer extra)]
-&gt; [(FetchDecision (ChainSuffix header),
     PeerInfo header peer extra)]
forall header block peerinfo.
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block) =&gt;
AnchoredFragment block
-&gt; [(FetchDecision (AnchoredFragment header), peerinfo)]
-&gt; [(FetchDecision (ChainSuffix header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#selectForkSuffixes"><span class="hs-identifier hs-var">selectForkSuffixes</span></a></span><span>
</span><span id="line-306"></span><span>      </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210629"><span class="hs-identifier hs-var">currentChain</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-comment">-- First, filter to keep chains the consensus layer tells us are plausible.</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (AnchoredFragment header),
   PeerInfo header peer extra)]
 -&gt; [(FetchDecision (ChainSuffix header),
      PeerInfo header peer extra)])
-&gt; ([(AnchoredFragment header, PeerInfo header peer extra)]
    -&gt; [(FetchDecision (AnchoredFragment header),
         PeerInfo header peer extra)])
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (ChainSuffix header),
     PeerInfo header peer extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool)
-&gt; AnchoredFragment header
-&gt; [(AnchoredFragment header, PeerInfo header peer extra)]
-&gt; [(FetchDecision (AnchoredFragment header),
     PeerInfo header peer extra)]
forall block header peerinfo.
(AnchoredFragment block -&gt; AnchoredFragment header -&gt; Bool)
-&gt; AnchoredFragment block
-&gt; [(AnchoredFragment header, peerinfo)]
-&gt; [(FetchDecision (AnchoredFragment header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterPlausibleCandidates"><span class="hs-identifier hs-var">filterPlausibleCandidates</span></a></span><span>
</span><span id="line-310"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt;
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="#local-6989586621679210624"><span class="hs-identifier hs-var">plausibleCandidateChain</span></a></span><span>
</span><span id="line-311"></span><span>      </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210629"><span class="hs-identifier hs-var">currentChain</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-comment">-- Data swizzling functions to get the right info into each stage.</span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621679210636"><span class="annot"><span class="annottext">swizzleI :: (a, (a, b, c, d, e)) -&gt; (a, b, (a, b, c, d, e))
</span><a href="#local-6989586621679210636"><span class="hs-identifier hs-var hs-var">swizzleI</span></a></span></span><span>   </span><span class="hs-special">(</span><span id="local-6989586621679210637"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210637"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210638"><span class="annot"><span class="annottext">p :: (a, b, c, d, e)
</span><a href="#local-6989586621679210638"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>     </span><span id="local-6989586621679210639"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210639"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>      </span><span class="annot"><span class="annottext">e
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210637"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span>         </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210639"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">,</span><span>       </span><span class="annot"><span class="annottext">(a, b, c, d, e)
</span><a href="#local-6989586621679210638"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621679210635"><span class="annot"><span class="annottext">swizzleIG :: (a, (a, b, c, d, e)) -&gt; (a, b, c, d, (a, b, c, d, e))
</span><a href="#local-6989586621679210635"><span class="hs-identifier hs-var hs-var">swizzleIG</span></a></span></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679210640"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210640"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210641"><span class="annot"><span class="annottext">p :: (a, b, c, d, e)
</span><a href="#local-6989586621679210641"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>     </span><span id="local-6989586621679210642"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210642"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210643"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679210643"><span class="hs-identifier hs-var">gsvs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210644"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621679210644"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">e
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210640"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span>         </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210642"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679210643"><span class="hs-identifier hs-var">gsvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621679210644"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(a, b, c, d, e)
</span><a href="#local-6989586621679210641"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621679210634"><span class="annot"><span class="annottext">swizzleSI :: (a, (b, c, c, d, e)) -&gt; (a, b, c, (b, c, c, d, e))
</span><a href="#local-6989586621679210634"><span class="hs-identifier hs-var hs-var">swizzleSI</span></a></span></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679210645"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210645"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210646"><span class="annot"><span class="annottext">p :: (b, c, c, d, e)
</span><a href="#local-6989586621679210646"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679210647"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210647"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210648"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679210648"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span>      </span><span class="annot"><span class="annottext">e
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210645"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210647"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679210648"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">,</span><span>       </span><span class="annot"><span class="annottext">(b, c, c, d, e)
</span><a href="#local-6989586621679210646"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>    </span><span id="local-6989586621679210633"><span class="annot"><span class="annottext">swizzleSIG :: (a, (b, c, d, e, e)) -&gt; (a, b, c, d, e, (b, c, d, e, e))
</span><a href="#local-6989586621679210633"><span class="hs-identifier hs-var hs-var">swizzleSIG</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210649"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210649"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210650"><span class="annot"><span class="annottext">p :: (b, c, d, e, e)
</span><a href="#local-6989586621679210650"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679210651"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210651"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210652"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679210652"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210653"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621679210653"><span class="hs-identifier hs-var">gsvs</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210654"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679210654"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">e
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210649"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210651"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621679210652"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621679210653"><span class="hs-identifier hs-var">gsvs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679210654"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(b, c, d, e, e)
</span><a href="#local-6989586621679210650"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="hs-comment">{-
We have the node's /current/ or /adopted/ chain. This is the node's chain in
the sense specified by the Ouroboros algorithm. It is a fully verified chain
with block bodies and a ledger state.

    &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472; current chain length (block number)

With chain selection we are interested in /candidate/ chains. We have these
candidate chains in the form of chains of verified headers, but without bodies.

The consensus layer gives us the current set of candidate chains from our peers
and we have the task of selecting which block bodies to download, and then
passing those block bodes back to the consensus layer. The consensus layer will
try to validate them and decide if it wants to update its current chain.

    &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9492;&#9472;&#9472;&#9472;&#9496;
    &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; current chain length
              &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
  current     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9492;&#9472;&#9472;&#9472;&#9496;
  (blocks)    &#9474;   &#9474;     &#9474;   &#9474;
              &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;
                A         B         C         D
             candidates
             (headers)

In this example we have four candidate chains, with all but chain D strictly
longer than our current chain.

In general there are many candidate chains. We make a distinction between a
candidate chain and the peer from which it is available. It is often the
case that the same chain is available from multiple peers. We will try to be
clear about when we are referring to chains or the combination of a chain and
the peer from which it is available.

For the sake of the example let us assume we have the four chains above
available from the following peers.

peer    1         2         3         4         5         6         7
      &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
    &#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
      &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
                &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
                &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;               &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;
chain   C         A         B         A         D         B         A

This is the form in which we are informed about candidate chains from the
consensus layer, the combination of a chain and the peer it is from. This
makes sense, since these things change independently.

We will process the chains in this form, keeping the peer/chain combination all
the way through. Although there could in principle be some opportunistic saving
by sharing when multiple peers provide the same chain, taking advantage of this
adds complexity and does nothing to improve our worst case costs.

We are only interested in candidate chains that are strictly longer than our
current chain. So our first task is to filter down to this set.
-}</span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-comment">-- | Keep only those candidate chains that are preferred over the current</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- chain. Typically, this means that their length is longer than the length of</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- the current chain.</span><span>
</span><span id="line-403"></span><span class="hs-comment">--</span><span>
</span><span id="line-404"></span><span id="local-6989586621679210297"><span id="local-6989586621679210298"><span id="local-6989586621679210299"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterPlausibleCandidates"><span class="hs-identifier hs-type">filterPlausibleCandidates</span></a></span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210297"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210298"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210297"><span class="hs-identifier hs-type">block</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The current chain</span></span><span>
</span><span id="line-407"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210298"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210299"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-408"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210298"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210299"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-409"></span><span id="filterPlausibleCandidates"><span class="annot"><span class="annottext">filterPlausibleCandidates :: forall block header peerinfo.
(AnchoredFragment block -&gt; AnchoredFragment header -&gt; Bool)
-&gt; AnchoredFragment block
-&gt; [(AnchoredFragment header, peerinfo)]
-&gt; [(FetchDecision (AnchoredFragment header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterPlausibleCandidates"><span class="hs-identifier hs-var hs-var">filterPlausibleCandidates</span></a></span></span><span> </span><span id="local-6989586621679210660"><span class="annot"><span class="annottext">AnchoredFragment block -&gt; AnchoredFragment header -&gt; Bool
</span><a href="#local-6989586621679210660"><span class="hs-identifier hs-var">plausibleCandidateChain</span></a></span></span><span> </span><span id="local-6989586621679210661"><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210661"><span class="hs-identifier hs-var">currentChain</span></a></span></span><span> </span><span id="local-6989586621679210662"><span class="annot"><span class="annottext">[(AnchoredFragment header, peerinfo)]
</span><a href="#local-6989586621679210662"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (AnchoredFragment header)
</span><a href="#local-6989586621679210663"><span class="hs-identifier hs-var">chain'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210664"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210665"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210665"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621679210664"><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210664"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(AnchoredFragment header, peerinfo)]
</span><a href="#local-6989586621679210662"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210663"><span class="annot"><span class="annottext">chain' :: FetchDecision (AnchoredFragment header)
</span><a href="#local-6989586621679210663"><span class="hs-identifier hs-var hs-var">chain'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-413"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment block -&gt; AnchoredFragment header -&gt; Bool
</span><a href="#local-6989586621679210660"><span class="hs-identifier hs-var">plausibleCandidateChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210661"><span class="hs-identifier hs-var">currentChain</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210665"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>              </span><span class="annot"><span class="annottext">Maybe () -&gt; FetchDecline -&gt; Either FetchDecline ()
forall a e. Maybe a -&gt; e -&gt; Either e a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainNotPlausible"><span class="hs-identifier hs-var">FetchDeclineChainNotPlausible</span></a></span><span>
</span><span id="line-415"></span><span>            </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; FetchDecision (AnchoredFragment header)
forall a. a -&gt; Either FetchDecline a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210665"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span class="hs-comment">{-
In the example, this leaves us with only the candidate chains: A, B and C, but
still paired up with the various peers.


peer    1         2         3         4                   6         7
      &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;     &#9478;   &#9478;               &#9478;   &#9478;     &#9478;   &#9478;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
      &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
    &#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;
      &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
      &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;     &#9500;&#9472;&#9472;&#9472;&#9508;
                &#9474;   &#9474;     &#9474;   &#9474;     &#9474;   &#9474;               &#9474;   &#9474;     &#9474;   &#9474;
                &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;               &#9492;&#9472;&#9472;&#9472;&#9496;     &#9492;&#9472;&#9472;&#9472;&#9496;
chain   C         A         B         A                   B         A
-}</span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span class="hs-comment">{-
Of course we would at most need to download the blocks in a candidate chain
that are not already in the current chain. So we must find those intersections.

Before we do that, lets define how we represent a suffix of a chain. We do this
very simply as a chain fragment: exactly those blocks contained in the suffix.
A chain fragment is of course not a chain, but has many similar invariants.

We will later also need to represent chain ranges when we send block fetch
requests. We do this using a pair of points: the first and last blocks in the
range.  While we can represent an empty chain fragment, we cannot represent an
empty fetch range, but this is ok since we never request empty ranges.

 Chain fragment
    &#9484;&#9472;&#9472;&#9472;&#9488;
    &#9474; &#9673; &#9474; Start of range, inclusive
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474; &#9673; &#9474; End of range, inclusive.
    &#9492;&#9472;&#9472;&#9472;&#9496;
-}</span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span class="hs-comment">-- | A chain suffix, obtained by intersecting a candidate chain with the</span><span>
</span><span id="line-467"></span><span class="hs-comment">-- current chain.</span><span>
</span><span id="line-468"></span><span class="hs-comment">--</span><span>
</span><span id="line-469"></span><span class="hs-comment">-- The anchor point of a 'ChainSuffix' will be a point within the bounds of</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- the current chain ('AF.withinFragmentBounds'), indicating that it forks off</span><span>
</span><span id="line-471"></span><span class="hs-comment">-- in the last @K@ blocks.</span><span>
</span><span id="line-472"></span><span class="hs-comment">--</span><span>
</span><span id="line-473"></span><span class="hs-comment">-- A 'ChainSuffix' must be non-empty, as an empty suffix, i.e. the candidate</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- chain is equal to the current chain, would not be a plausible candidate.</span><span>
</span><span id="line-475"></span><span class="hs-keyword">newtype</span><span> </span><span id="ChainSuffix"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-var">ChainSuffix</span></a></span></span><span> </span><span id="local-6989586621679210308"><span class="annot"><a href="#local-6989586621679210308"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-476"></span><span>    </span><span id="ChainSuffix"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-var">ChainSuffix</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="getChainSuffix"><span class="annot"><span class="annottext">forall header. ChainSuffix header -&gt; AnchoredFragment header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#getChainSuffix"><span class="hs-identifier hs-var hs-var">getChainSuffix</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210308"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span class="hs-comment">{-
We define the /chain suffix/ as the suffix of the candidate chain up until (but
not including) where it intersects the current chain.


   current    peer 1    peer 2

    &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;  &#9664;&#9535;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9484;&#9472;&#9538;&#9472;&#9488;
    &#9474;   &#9474;               &#9474; &#9673; &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;               &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;  &#9664;&#9535;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9473;&#9491;       &#9474;   &#9474;
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9472;&#9472;&#9516;&#9472;&#9538;&#9472;&#9516;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;
              &#9474; &#9673; &#9474;     &#9474;   &#9474;
              &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;
                        &#9474; &#9673; &#9474;
                        &#9492;&#9472;&#9472;&#9472;&#9496;
                C         A

In this example we found that C was a strict extension of the current chain
and chain A was a short fork.

Note that it's possible that we don't find any intersection within the last K
blocks. This means the candidate forks by more than K and so we are not
interested in this candidate at all.
-}</span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="hs-comment">-- | Find the chain suffix for a candidate chain, with respect to the</span><span>
</span><span id="line-510"></span><span class="hs-comment">-- current chain.</span><span>
</span><span id="line-511"></span><span class="hs-comment">--</span><span>
</span><span id="line-512"></span><span id="local-6989586621679210310"><span id="local-6989586621679210311"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#chainForkSuffix"><span class="hs-identifier hs-type">chainForkSuffix</span></a></span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210310"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210311"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-514"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210310"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210311"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210311"><span class="hs-identifier hs-type">block</span></a></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Current chain.</span></span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210310"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Candidate chain</span></span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210310"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-518"></span><span id="chainForkSuffix"><span class="annot"><span class="annottext">chainForkSuffix :: forall header block.
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block) =&gt;
AnchoredFragment block
-&gt; AnchoredFragment header -&gt; Maybe (ChainSuffix header)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#chainForkSuffix"><span class="hs-identifier hs-var hs-var">chainForkSuffix</span></a></span></span><span> </span><span id="local-6989586621679210679"><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210679"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span id="local-6989586621679210680"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210680"><span class="hs-identifier hs-var">candidate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block
-&gt; AnchoredFragment header
-&gt; Maybe
     (AnchoredFragment block, AnchoredFragment header,
      AnchoredFragment block, AnchoredFragment header)
forall block1 block2.
(HasHeader block1, HasHeader block2,
 HeaderHash block1 ~ HeaderHash block2) =&gt;
AnchoredFragment block1
-&gt; AnchoredFragment block2
-&gt; Maybe
     (AnchoredFragment block1, AnchoredFragment block2,
      AnchoredFragment block1, AnchoredFragment block2)
</span><span class="hs-identifier hs-var">AF.intersect</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210679"><span class="hs-identifier hs-var">current</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210680"><span class="hs-identifier hs-var">candidate</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-520"></span><span>      </span><span class="annot"><span class="annottext">Maybe
  (AnchoredFragment block, AnchoredFragment header,
   AnchoredFragment block, AnchoredFragment header)
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (ChainSuffix header)
forall a. Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-521"></span><span>      </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment block
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210682"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210682"><span class="hs-identifier hs-var">candidateSuffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-522"></span><span>        </span><span class="hs-comment">-- If the suffix is empty, it means the candidate chain was equal to</span><span>
</span><span id="line-523"></span><span>        </span><span class="hs-comment">-- the current chain and didn't fork off. Such a candidate chain is</span><span>
</span><span id="line-524"></span><span>        </span><span class="hs-comment">-- not a plausible candidate, so it must have been filtered out.</span><span>
</span><span id="line-525"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Maybe (ChainSuffix header) -&gt; Maybe (ChainSuffix header)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; Bool
forall v a b. AnchoredSeq v a b -&gt; Bool
</span><span class="hs-identifier hs-var">AF.null</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210682"><span class="hs-identifier hs-var">candidateSuffix</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (ChainSuffix header) -&gt; Maybe (ChainSuffix header))
-&gt; Maybe (ChainSuffix header) -&gt; Maybe (ChainSuffix header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-526"></span><span>        </span><span class="annot"><span class="annottext">ChainSuffix header -&gt; Maybe (ChainSuffix header)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; ChainSuffix header
forall header. AnchoredFragment header -&gt; ChainSuffix header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-var">ChainSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210682"><span class="hs-identifier hs-var">candidateSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span>
</span><span id="line-528"></span><span id="local-6989586621679210294"><span id="local-6989586621679210295"><span id="local-6989586621679210296"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#selectForkSuffixes"><span class="hs-identifier hs-type">selectForkSuffixes</span></a></span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210294"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210295"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-530"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210294"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210295"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210295"><span class="hs-identifier hs-type">block</span></a></span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210294"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210296"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-533"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a></span><span>      </span><span class="annot"><a href="#local-6989586621679210294"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210296"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-534"></span><span id="selectForkSuffixes"><span class="annot"><span class="annottext">selectForkSuffixes :: forall header block peerinfo.
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block) =&gt;
AnchoredFragment block
-&gt; [(FetchDecision (AnchoredFragment header), peerinfo)]
-&gt; [(FetchDecision (ChainSuffix header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#selectForkSuffixes"><span class="hs-identifier hs-var hs-var">selectForkSuffixes</span></a></span></span><span> </span><span id="local-6989586621679210694"><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210694"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span id="local-6989586621679210695"><span class="annot"><span class="annottext">[(FetchDecision (AnchoredFragment header), peerinfo)]
</span><a href="#local-6989586621679210695"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-535"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (ChainSuffix header)
</span><a href="#local-6989586621679210696"><span class="hs-identifier hs-var">mchain'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210697"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210698"><span class="annot"><span class="annottext">FetchDecision (AnchoredFragment header)
</span><a href="#local-6989586621679210698"><span class="hs-identifier hs-var">mchain</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621679210697"><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210697"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision (AnchoredFragment header), peerinfo)]
</span><a href="#local-6989586621679210695"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-537"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210696"><span class="annot"><span class="annottext">mchain' :: FetchDecision (ChainSuffix header)
</span><a href="#local-6989586621679210696"><span class="hs-identifier hs-var hs-var">mchain'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-538"></span><span>            </span><span id="local-6989586621679210699"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210699"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FetchDecision (AnchoredFragment header)
</span><a href="#local-6989586621679210698"><span class="hs-identifier hs-var">mchain</span></a></span><span>
</span><span id="line-539"></span><span>            </span><span class="annot"><span class="annottext">AnchoredFragment block
-&gt; AnchoredFragment header -&gt; Maybe (ChainSuffix header)
forall header block.
(HasHeader header, HasHeader block,
 HeaderHash header ~ HeaderHash block) =&gt;
AnchoredFragment block
-&gt; AnchoredFragment header -&gt; Maybe (ChainSuffix header)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#chainForkSuffix"><span class="hs-identifier hs-var">chainForkSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210694"><span class="hs-identifier hs-var">current</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210699"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ChainSuffix header)
-&gt; FetchDecline -&gt; FetchDecision (ChainSuffix header)
forall a e. Maybe a -&gt; e -&gt; Either e a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineChainIntersectionTooDeep"><span class="hs-identifier hs-var">FetchDeclineChainIntersectionTooDeep</span></a></span><span>
</span><span id="line-540"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span class="hs-comment">{-
We define the /fetch range/ as the suffix of the fork range that has not yet
had its blocks downloaded and block content checked against the headers.

    &#9478;   &#9478;
    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9484;&#9472;&#9472;&#9472;&#9488;
    &#9474;   &#9474;    already    &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;    fetched    &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;    blocks     &#9474;   &#9474;
    &#9500;&#9472;&#9472;&#9472;&#9508;               &#9500;&#9472;&#9472;&#9472;&#9508;
    &#9474;   &#9474;               &#9474;&#9617;&#9673;&#9617;&#9474;  &#9668;  fetch range
 &#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9524;&#9472;&#9472;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9516;&#9472;&#9472;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;&#9532;&#9472;&#9472;&#9472;
              &#9474;&#9617;&#9673;&#9617;&#9474; &#9668;   &#9474;&#9617;&#9617;&#9617;&#9474;
              &#9492;&#9472;&#9472;&#9472;&#9496;     &#9500;&#9472;&#9472;&#9472;&#9508;
                        &#9474;&#9617;&#9673;&#9617;&#9474;  &#9668;
                        &#9492;&#9472;&#9472;&#9472;&#9496;

In earlier versions of this scheme we maintained and relied on the invariant
that the ranges of fetched blocks are backwards closed. This meant we never had
discontinuous ranges of fetched or not-yet-fetched blocks. This invariant does
simplify things somewhat by keeping the ranges continuous however it precludes
fetching ranges of blocks from different peers in parallel.

We do not maintain any such invariant and so we have to deal with there being
gaps in the ranges we have already fetched or are yet to fetch. To keep the
tracking simple we do not track the ranges themselves, rather we track the set
of individual blocks without their relationship to each other.

-}</span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span class="hs-comment">-- | Find the fragments of the chain suffix that we still need to fetch, these</span><span>
</span><span id="line-575"></span><span class="hs-comment">-- are the fragments covering blocks that have not yet been fetched and are</span><span>
</span><span id="line-576"></span><span class="hs-comment">-- not currently in the process of being fetched from this peer.</span><span>
</span><span id="line-577"></span><span class="hs-comment">--</span><span>
</span><span id="line-578"></span><span class="hs-comment">-- Typically this is a single fragment forming a suffix of the chain, but in</span><span>
</span><span id="line-579"></span><span class="hs-comment">-- the general case we can get a bunch of discontiguous chain fragments.</span><span>
</span><span id="line-580"></span><span class="hs-comment">--</span><span>
</span><span id="line-581"></span><span id="local-6989586621679210291"><span id="local-6989586621679210292"><span id="local-6989586621679210293"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyFetched"><span class="hs-identifier hs-type">filterNotAlreadyFetched</span></a></span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210291"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210291"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#~"><span class="hs-operator hs-type">~</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HeaderHash</span></span><span> </span><span class="annot"><a href="#local-6989586621679210292"><span class="hs-identifier hs-type">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679210292"><span class="hs-identifier hs-type">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-585"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a></span><span>        </span><span class="annot"><a href="#local-6989586621679210291"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210293"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-586"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210291"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210293"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-587"></span><span id="filterNotAlreadyFetched"><span class="annot"><span class="annottext">filterNotAlreadyFetched :: forall header block peerinfo.
(HasHeader header, HeaderHash header ~ HeaderHash block) =&gt;
(Point block -&gt; Bool)
-&gt; MaxSlotNo
-&gt; [(FetchDecision (ChainSuffix header), peerinfo)]
-&gt; [(FetchDecision (CandidateFragments header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyFetched"><span class="hs-identifier hs-var hs-var">filterNotAlreadyFetched</span></a></span></span><span> </span><span id="local-6989586621679210713"><span class="annot"><span class="annottext">Point block -&gt; Bool
</span><a href="#local-6989586621679210713"><span class="hs-identifier hs-var">alreadyDownloaded</span></a></span></span><span> </span><span id="local-6989586621679210714"><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679210714"><span class="hs-identifier hs-var">fetchedMaxSlotNo</span></a></span></span><span> </span><span id="local-6989586621679210715"><span class="annot"><span class="annottext">[(FetchDecision (ChainSuffix header), peerinfo)]
</span><a href="#local-6989586621679210715"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-588"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><a href="#local-6989586621679210716"><span class="hs-identifier hs-var">mcandidates</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210717"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210718"><span class="annot"><span class="annottext">FetchDecision (ChainSuffix header)
</span><a href="#local-6989586621679210718"><span class="hs-identifier hs-var">mcandidate</span></a></span></span><span class="hs-special">,</span><span>  </span><span id="local-6989586621679210717"><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210717"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision (ChainSuffix header), peerinfo)]
</span><a href="#local-6989586621679210715"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210716"><span class="annot"><span class="annottext">mcandidates :: FetchDecision (CandidateFragments header)
</span><a href="#local-6989586621679210716"><span class="hs-identifier hs-var hs-var">mcandidates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>            </span><span id="local-6989586621679210719"><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210719"><span class="hs-identifier hs-var">candidate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FetchDecision (ChainSuffix header)
</span><a href="#local-6989586621679210718"><span class="hs-identifier hs-var">mcandidate</span></a></span><span>
</span><span id="line-592"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210720"><span class="annot"><span class="annottext">fragments :: [AnchoredFragment header]
</span><a href="#local-6989586621679210720"><span class="hs-identifier hs-var hs-var">fragments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
forall header.
HasHeader header =&gt;
(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a></span><span>
</span><span id="line-593"></span><span>                              </span><span class="annot"><span class="annottext">header -&gt; Bool
</span><a href="#local-6989586621679210722"><span class="hs-identifier hs-var">notAlreadyFetched</span></a></span><span>
</span><span id="line-594"></span><span>                              </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679210714"><span class="hs-identifier hs-var">fetchedMaxSlotNo</span></a></span><span>
</span><span id="line-595"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSuffix header -&gt; AnchoredFragment header
forall header. ChainSuffix header -&gt; AnchoredFragment header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#getChainSuffix"><span class="hs-identifier hs-var">getChainSuffix</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210719"><span class="hs-identifier hs-var">candidate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AnchoredFragment header] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210720"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; FetchDecline -&gt; Either FetchDecline ()
forall a e. Maybe a -&gt; e -&gt; Either e a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineAlreadyFetched"><span class="hs-identifier hs-var">FetchDeclineAlreadyFetched</span></a></span><span>
</span><span id="line-597"></span><span>            </span><span class="annot"><span class="annottext">CandidateFragments header
-&gt; FetchDecision (CandidateFragments header)
forall a. a -&gt; Either FetchDecline a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210719"><span class="hs-identifier hs-var">candidate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210720"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-599"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-600"></span><span>    </span><span id="local-6989586621679210722"><span class="annot"><span class="annottext">notAlreadyFetched :: header -&gt; Bool
</span><a href="#local-6989586621679210722"><span class="hs-identifier hs-var hs-var">notAlreadyFetched</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (header -&gt; Bool) -&gt; header -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Point block -&gt; Bool
</span><a href="#local-6989586621679210713"><span class="hs-identifier hs-var">alreadyDownloaded</span></a></span><span> </span><span class="annot"><span class="annottext">(Point block -&gt; Bool) -&gt; (header -&gt; Point block) -&gt; header -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Point header -&gt; Point block
forall {k1} {k2} (b :: k1) (b' :: k2).
Coercible (HeaderHash b) (HeaderHash b') =&gt;
Point b -&gt; Point b'
</span><span class="hs-identifier hs-var">castPoint</span></span><span> </span><span class="annot"><span class="annottext">(Point header -&gt; Point block)
-&gt; (header -&gt; Point header) -&gt; header -&gt; Point block
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">header -&gt; Point header
forall block. HasHeader block =&gt; block -&gt; Point block
</span><span class="hs-identifier hs-var">blockPoint</span></span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span id="local-6989586621679210282"><span id="local-6989586621679210283"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithPeer"><span class="hs-identifier hs-type">filterNotAlreadyInFlightWithPeer</span></a></span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210282"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-605"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210282"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210282"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-606"></span><span>                                                  </span><span class="annot"><a href="#local-6989586621679210283"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210282"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210283"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-608"></span><span id="filterNotAlreadyInFlightWithPeer"><span class="annot"><span class="annottext">filterNotAlreadyInFlightWithPeer :: forall header peerinfo.
HasHeader header =&gt;
[(FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, peerinfo)]
-&gt; [(FetchDecision (CandidateFragments header), peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithPeer"><span class="hs-identifier hs-var hs-var">filterNotAlreadyInFlightWithPeer</span></a></span></span><span> </span><span id="local-6989586621679210735"><span class="annot"><span class="annottext">[(FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210735"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-609"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><a href="#local-6989586621679210736"><span class="hs-identifier hs-var">mcandidatefragments'</span></a></span><span class="hs-special">,</span><span>          </span><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210737"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210738"><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><a href="#local-6989586621679210738"><span class="hs-identifier hs-var">mcandidatefragments</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210739"><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210739"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210737"><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210737"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210735"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-611"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210736"><span class="annot"><span class="annottext">mcandidatefragments' :: FetchDecision (CandidateFragments header)
</span><a href="#local-6989586621679210736"><span class="hs-identifier hs-var hs-var">mcandidatefragments'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-612"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679210740"><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210740"><span class="hs-identifier hs-var">candidate</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210741"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210741"><span class="hs-identifier hs-var">chainfragments</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><a href="#local-6989586621679210738"><span class="hs-identifier hs-var">mcandidatefragments</span></a></span><span>
</span><span id="line-613"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210742"><span class="annot"><span class="annottext">fragments :: [AnchoredFragment header]
</span><a href="#local-6989586621679210742"><span class="hs-identifier hs-var hs-var">fragments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; [AnchoredFragment header])
-&gt; [AnchoredFragment header] -&gt; [AnchoredFragment header]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
forall header.
HasHeader header =&gt;
(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a></span><span>
</span><span id="line-614"></span><span>                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerFetchInFlight header -&gt; header -&gt; Bool
forall {block}.
HasHeader block =&gt;
PeerFetchInFlight block -&gt; block -&gt; Bool
</span><a href="#local-6989586621679210744"><span class="hs-identifier hs-var">notAlreadyInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210739"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>                                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerFetchInFlight header -&gt; MaxSlotNo
forall header. PeerFetchInFlight header -&gt; MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchMaxSlotNo"><span class="hs-identifier hs-var">peerFetchMaxSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210739"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>                                      </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210741"><span class="hs-identifier hs-var">chainfragments</span></a></span><span>
</span><span id="line-617"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AnchoredFragment header] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210742"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; FetchDecline -&gt; Either FetchDecline ()
forall a e. Maybe a -&gt; e -&gt; Either e a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightThisPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightThisPeer</span></a></span><span>
</span><span id="line-618"></span><span>            </span><span class="annot"><span class="annottext">CandidateFragments header
-&gt; FetchDecision (CandidateFragments header)
forall a. a -&gt; Either FetchDecline a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210740"><span class="hs-identifier hs-var">candidate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210742"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-620"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-621"></span><span>    </span><span id="local-6989586621679210744"><span class="annot"><span class="annottext">notAlreadyInFlight :: PeerFetchInFlight block -&gt; block -&gt; Bool
</span><a href="#local-6989586621679210744"><span class="hs-identifier hs-var hs-var">notAlreadyInFlight</span></a></span></span><span> </span><span id="local-6989586621679210779"><span class="annot"><span class="annottext">PeerFetchInFlight block
</span><a href="#local-6989586621679210779"><span class="hs-identifier hs-var">inflight</span></a></span></span><span> </span><span id="local-6989586621679210780"><span class="annot"><span class="annottext">block
</span><a href="#local-6989586621679210780"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-622"></span><span>      </span><span class="annot"><span class="annottext">block -&gt; Point block
forall block. HasHeader block =&gt; block -&gt; Point block
</span><span class="hs-identifier hs-var">blockPoint</span></span><span> </span><span class="annot"><span class="annottext">block
</span><a href="#local-6989586621679210780"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Point block -&gt; Set (Point block) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#notMember"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight block -&gt; Set (Point block)
forall header. PeerFetchInFlight header -&gt; Set (Point header)
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchBlocksInFlight"><span class="hs-identifier hs-var">peerFetchBlocksInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight block
</span><a href="#local-6989586621679210779"><span class="hs-identifier hs-var">inflight</span></a></span><span>
</span><span id="line-623"></span><span>
</span><span id="line-624"></span><span>
</span><span id="line-625"></span><span class="hs-comment">-- | A penultimate step of filtering, but this time across peers, rather than</span><span>
</span><span id="line-626"></span><span class="hs-comment">-- individually for each peer. If we're following the parallel fetch</span><span>
</span><span id="line-627"></span><span class="hs-comment">-- mode then we filter out blocks that are already in-flight with other</span><span>
</span><span id="line-628"></span><span class="hs-comment">-- peers.</span><span>
</span><span id="line-629"></span><span class="hs-comment">--</span><span>
</span><span id="line-630"></span><span class="hs-comment">-- Note that this does /not/ cover blocks that are proposed to be fetched in</span><span>
</span><span id="line-631"></span><span class="hs-comment">-- this round of decisions. That step is covered  in 'fetchRequestDecisions'.</span><span>
</span><span id="line-632"></span><span class="hs-comment">--</span><span>
</span><span id="line-633"></span><span id="local-6989586621679210264"><span id="local-6989586621679210265"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier hs-type">filterNotAlreadyInFlightWithOtherPeers</span></a></span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210264"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span>
</span><span id="line-636"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210264"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-637"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210264"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-638"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210264"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-639"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210265"><span class="hs-identifier hs-type">peerinfo</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-640"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210264"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210265"><span class="hs-identifier hs-type">peerinfo</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span id="filterNotAlreadyInFlightWithOtherPeers"><span class="annot"><span class="annottext">filterNotAlreadyInFlightWithOtherPeers :: forall header peerinfo.
HasHeader header =&gt;
FetchMode
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, peerinfo)]
-&gt; [(FetchDecision [AnchoredFragment header], peerinfo)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier hs-var hs-var">filterNotAlreadyInFlightWithOtherPeers</span></a></span></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeDeadline</span></span><span> </span><span id="local-6989586621679210800"><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210800"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-643"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679210801"><span class="hs-identifier hs-var">mchainfragments</span></a></span><span class="hs-special">,</span><span>       </span><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210802"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-644"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210801"><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679210801"><span class="hs-identifier hs-var">mchainfragments</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210802"><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210802"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210800"><span class="hs-identifier hs-var">chains</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-645"></span><span>
</span><span id="line-646"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterNotAlreadyInFlightWithOtherPeers"><span class="hs-identifier hs-var">filterNotAlreadyInFlightWithOtherPeers</span></a></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span> </span><span id="local-6989586621679210804"><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210804"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-647"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679210805"><span class="hs-identifier hs-var">mcandidatefragments'</span></a></span><span class="hs-special">,</span><span>      </span><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210806"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-648"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210807"><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679210807"><span class="hs-identifier hs-var">mcandidatefragments</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210806"><span class="annot"><span class="annottext">peerinfo
</span><a href="#local-6989586621679210806"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210804"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210805"><span class="annot"><span class="annottext">mcandidatefragments' :: FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679210805"><span class="hs-identifier hs-var hs-var">mcandidatefragments'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-650"></span><span>            </span><span id="local-6989586621679210808"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210808"><span class="hs-identifier hs-var">chainfragments</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679210807"><span class="hs-identifier hs-var">mcandidatefragments</span></a></span><span>
</span><span id="line-651"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679210809"><span class="annot"><span class="annottext">fragments :: [AnchoredFragment header]
</span><a href="#local-6989586621679210809"><span class="hs-identifier hs-var hs-var">fragments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; [AnchoredFragment header])
-&gt; [AnchoredFragment header] -&gt; [AnchoredFragment header]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
forall header.
HasHeader header =&gt;
(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a></span><span>
</span><span id="line-652"></span><span>                                        </span><span class="annot"><span class="annottext">header -&gt; Bool
</span><a href="#local-6989586621679210810"><span class="hs-identifier hs-var">notAlreadyInFlight</span></a></span><span>
</span><span id="line-653"></span><span>                                        </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679210811"><span class="hs-identifier hs-var">maxSlotNoInFlightWithOtherPeers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-654"></span><span>                                      </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210808"><span class="hs-identifier hs-var">chainfragments</span></a></span><span>
</span><span id="line-655"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AnchoredFragment header] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210809"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; FetchDecline -&gt; Either FetchDecline ()
forall a e. Maybe a -&gt; e -&gt; Either e a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightOtherPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightOtherPeer</span></a></span><span>
</span><span id="line-656"></span><span>            </span><span class="annot"><span class="annottext">[AnchoredFragment header]
-&gt; FetchDecision [AnchoredFragment header]
forall a. a -&gt; Either FetchDecline a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210809"><span class="hs-identifier hs-var">fragments</span></a></span><span>
</span><span id="line-657"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-658"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-659"></span><span>    </span><span id="local-6989586621679210810"><span class="annot"><span class="annottext">notAlreadyInFlight :: header -&gt; Bool
</span><a href="#local-6989586621679210810"><span class="hs-identifier hs-var hs-var">notAlreadyInFlight</span></a></span></span><span> </span><span id="local-6989586621679210812"><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679210812"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-660"></span><span>      </span><span class="annot"><span class="annottext">header -&gt; Point header
forall block. HasHeader block =&gt; block -&gt; Point block
</span><span class="hs-identifier hs-var">blockPoint</span></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679210812"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Point header -&gt; Set (Point header) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#notMember"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679210813"><span class="hs-identifier hs-var">blocksInFlightWithOtherPeers</span></a></span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span>   </span><span class="hs-comment">-- All the blocks that are already in-flight with all peers</span><span>
</span><span id="line-663"></span><span>    </span><span id="local-6989586621679210813"><span class="annot"><span class="annottext">blocksInFlightWithOtherPeers :: Set (Point header)
</span><a href="#local-6989586621679210813"><span class="hs-identifier hs-var hs-var">blocksInFlightWithOtherPeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-664"></span><span>      </span><span class="annot"><span class="annottext">[Set (Point header)] -&gt; Set (Point header)
forall (f :: * -&gt; *) a. (Foldable f, Ord a) =&gt; f (Set a) -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#unions"><span class="hs-identifier hs-var">Set.unions</span></a></span><span>
</span><span id="line-665"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="#local-6989586621679210815"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-666"></span><span>            </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusShutdown"><span class="hs-identifier hs-var">PeerFetchStatusShutdown</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set (Point header)
forall a. Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-667"></span><span>            </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusStarting"><span class="hs-identifier hs-var">PeerFetchStatusStarting</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set (Point header)
forall a. Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-668"></span><span>            </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusAberrant"><span class="hs-identifier hs-var">PeerFetchStatusAberrant</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set (Point header)
forall a. Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span>
</span><span id="line-669"></span><span>            </span><span id="local-6989586621679210818"><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="#local-6989586621679210818"><span class="hs-identifier hs-var">_other</span></a></span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header -&gt; Set (Point header)
forall header. PeerFetchInFlight header -&gt; Set (Point header)
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchBlocksInFlight"><span class="hs-identifier hs-var">peerFetchBlocksInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210819"><span class="hs-identifier hs-var">inflight</span></a></span><span>
</span><span id="line-670"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210815"><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="#local-6989586621679210815"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210819"><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210819"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerinfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210804"><span class="hs-identifier hs-var">chains</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span>    </span><span class="hs-comment">-- The highest slot number that is or has been in flight for any peer.</span><span>
</span><span id="line-673"></span><span>    </span><span id="local-6989586621679210811"><span class="annot"><span class="annottext">maxSlotNoInFlightWithOtherPeers :: MaxSlotNo
</span><a href="#local-6989586621679210811"><span class="hs-identifier hs-var hs-var">maxSlotNoInFlightWithOtherPeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MaxSlotNo -&gt; MaxSlotNo -&gt; MaxSlotNo)
-&gt; MaxSlotNo -&gt; [MaxSlotNo] -&gt; MaxSlotNo
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo -&gt; MaxSlotNo -&gt; MaxSlotNo
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#max"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo
</span><span class="hs-identifier hs-var">NoMaxSlotNo</span></span><span>
</span><span id="line-674"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header -&gt; MaxSlotNo
forall header. PeerFetchInFlight header -&gt; MaxSlotNo
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchMaxSlotNo"><span class="hs-identifier hs-var">peerFetchMaxSlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210822"><span class="hs-identifier hs-var">inflight</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210822"><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210822"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peerinfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, peerinfo)]
</span><a href="#local-6989586621679210804"><span class="hs-identifier hs-var">chains</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span class="hs-comment">-- | Filter a fragment. This is an optimised variant that will behave the same</span><span>
</span><span id="line-677"></span><span class="hs-comment">-- as 'AnchoredFragment.filter' if the following precondition is satisfied:</span><span>
</span><span id="line-678"></span><span class="hs-comment">--</span><span>
</span><span id="line-679"></span><span class="hs-comment">-- PRECONDITION: for all @hdr@ in the chain fragment: if @blockSlot hdr &gt;</span><span>
</span><span id="line-680"></span><span class="hs-comment">-- maxSlotNo@ then the predicate should not hold for any header after @hdr@ in</span><span>
</span><span id="line-681"></span><span class="hs-comment">-- the chain fragment.</span><span>
</span><span id="line-682"></span><span class="hs-comment">--</span><span>
</span><span id="line-683"></span><span class="hs-comment">-- For example, when filtering out already downloaded blocks from the</span><span>
</span><span id="line-684"></span><span class="hs-comment">-- fragment, it does not make sense to keep filtering after having encountered</span><span>
</span><span id="line-685"></span><span class="hs-comment">-- the highest slot number the ChainDB has seen so far: blocks with a greater</span><span>
</span><span id="line-686"></span><span class="hs-comment">-- slot number cannot have been downloaded yet. When the candidate fragments</span><span>
</span><span id="line-687"></span><span class="hs-comment">-- get far ahead of the current chain, e.g., @2k@ headers, this optimisation</span><span>
</span><span id="line-688"></span><span class="hs-comment">-- avoids the linear cost of filtering these headers when we know in advance</span><span>
</span><span id="line-689"></span><span class="hs-comment">-- they will all remain in the final fragment. In case the given slot number</span><span>
</span><span id="line-690"></span><span class="hs-comment">-- is 'NoSlotNo', no filtering takes place, as there should be no matches</span><span>
</span><span id="line-691"></span><span class="hs-comment">-- because we haven't downloaded any blocks yet.</span><span>
</span><span id="line-692"></span><span class="hs-comment">--</span><span>
</span><span id="line-693"></span><span class="hs-comment">-- For example, when filtering out blocks already in-flight for the given</span><span>
</span><span id="line-694"></span><span class="hs-comment">-- peer, the given @maxSlotNo@ can correspond to the block with the highest</span><span>
</span><span id="line-695"></span><span class="hs-comment">-- slot number that so far has been in-flight for the given peer. When no</span><span>
</span><span id="line-696"></span><span class="hs-comment">-- blocks have been in-flight yet, @maxSlotNo@ can be 'NoSlotNo', in which</span><span>
</span><span id="line-697"></span><span class="hs-comment">-- case no filtering needs to take place, which makes sense, as there are no</span><span>
</span><span id="line-698"></span><span class="hs-comment">-- blocks to filter out. Note that this is conservative: if a block is for</span><span>
</span><span id="line-699"></span><span class="hs-comment">-- some reason multiple times in-flight (maybe it has to be redownloaded) and</span><span>
</span><span id="line-700"></span><span class="hs-comment">-- the block's slot number matches the @maxSlotNo@, it will now be filtered</span><span>
</span><span id="line-701"></span><span class="hs-comment">-- (while the filtering might previously have stopped before encountering the</span><span>
</span><span id="line-702"></span><span class="hs-comment">-- block in question). This is fine, as the filter will now include the block,</span><span>
</span><span id="line-703"></span><span class="hs-comment">-- because according to the filtering predicate, the block is not in-flight.</span><span>
</span><span id="line-704"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-type">filterWithMaxSlotNo</span></a></span><span>
</span><span id="line-705"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679210330"><span class="annot"><a href="#local-6989586621679210330"><span class="hs-identifier hs-type">header</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210330"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-706"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210330"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-707"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ @maxSlotNo@</span></span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210330"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-709"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210330"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-710"></span><span id="filterWithMaxSlotNo"><span class="annot"><span class="annottext">filterWithMaxSlotNo :: forall header.
HasHeader header =&gt;
(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var hs-var">filterWithMaxSlotNo</span></a></span></span><span> </span><span id="local-6989586621679210828"><span class="annot"><span class="annottext">header -&gt; Bool
</span><a href="#local-6989586621679210828"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679210829"><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679210829"><span class="hs-identifier hs-var">maxSlotNo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-711"></span><span>    </span><span class="annot"><span class="annottext">(header -&gt; Bool)
-&gt; (header -&gt; Bool)
-&gt; AnchoredSeq (WithOrigin SlotNo) (Anchor header) header
-&gt; [AnchoredSeq (WithOrigin SlotNo) (Anchor header) header]
forall v a b.
Anchorable v a b =&gt;
(b -&gt; Bool)
-&gt; (b -&gt; Bool) -&gt; AnchoredSeq v a b -&gt; [AnchoredSeq v a b]
</span><span class="hs-identifier hs-var">AF.filterWithStop</span></span><span> </span><span class="annot"><span class="annottext">header -&gt; Bool
</span><a href="#local-6989586621679210828"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">MaxSlotNo -&gt; MaxSlotNo -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679210829"><span class="hs-identifier hs-var">maxSlotNo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MaxSlotNo -&gt; Bool) -&gt; (header -&gt; MaxSlotNo) -&gt; header -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; MaxSlotNo
</span><span class="hs-identifier hs-var">MaxSlotNo</span></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; MaxSlotNo) -&gt; (header -&gt; SlotNo) -&gt; header -&gt; MaxSlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">header -&gt; SlotNo
forall b. HasHeader b =&gt; b -&gt; SlotNo
</span><span class="hs-identifier hs-var">blockSlot</span></span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier hs-type">prioritisePeerChains</span></a></span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679210275"><span class="annot"><a href="#local-6989586621679210275"><span class="hs-identifier hs-type">extra</span></a></span></span><span> </span><span id="local-6989586621679210273"><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679210274"><span class="annot"><a href="#local-6989586621679210274"><span class="hs-identifier hs-type">peer</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-715"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-716"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679210274"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-717"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210274"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-718"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Ordering"><span class="hs-identifier hs-type">Ordering</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-722"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-723"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#CandidateFragments"><span class="hs-identifier hs-type">CandidateFragments</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-724"></span><span>                                                  </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-725"></span><span>                                                  </span><span class="annot"><a href="#local-6989586621679210274"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-726"></span><span>                                                  </span><span class="annot"><a href="#local-6989586621679210275"><span class="hs-identifier hs-type">extra</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-727"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210273"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>   </span><span class="annot"><a href="#local-6989586621679210275"><span class="hs-identifier hs-type">extra</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-728"></span><span id="prioritisePeerChains"><span class="annot"><span class="annottext">prioritisePeerChains :: forall extra header peer.
(HasHeader header, Hashable peer, Ord peer) =&gt;
FetchMode
-&gt; Int
-&gt; (AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering)
-&gt; (header -&gt; SizeInBytes)
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(FetchDecision [AnchoredFragment header], extra)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier hs-var hs-var">prioritisePeerChains</span></a></span></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeDeadline</span></span><span> </span><span id="local-6989586621679210858"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679210858"><span class="hs-identifier hs-var">salt</span></a></span></span><span> </span><span id="local-6989586621679210859"><span class="annot"><span class="annottext">AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679210859"><span class="hs-identifier hs-var">compareCandidateChains</span></a></span></span><span> </span><span id="local-6989586621679210860"><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679210860"><span class="hs-identifier hs-var">blockFetchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-729"></span><span>    </span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (FetchDecision [AnchoredFragment header], extra))
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [(FetchDecision [AnchoredFragment header], extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679210861"><span class="annot"><span class="annottext">Either
  FetchDecline
  (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
</span><a href="#local-6989586621679210861"><span class="hs-identifier hs-var">decision</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210862"><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210862"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-730"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
 -&gt; [AnchoredFragment header])
-&gt; Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; FetchDecision [AnchoredFragment header]
forall a b.
(a -&gt; b) -&gt; Either FetchDecline a -&gt; Either FetchDecline b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProbabilityBand
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">ChainSuffix header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679210863"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210863"><span class="hs-identifier hs-var">fragment</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210863"><span class="hs-identifier hs-var">fragment</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either
  FetchDecline
  (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
</span><a href="#local-6989586621679210861"><span class="hs-identifier hs-var">decision</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210862"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>  </span><span class="annot"><span class="annottext">([(Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
   extra)]
 -&gt; [(FetchDecision [AnchoredFragment header], extra)])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [(Either
           FetchDecline
           (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
         extra)])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(FetchDecision [AnchoredFragment header], extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">([(Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
   extra)]
 -&gt; [(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)])
-&gt; [[(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[[(Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
   extra)]]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span>
</span><span id="line-732"></span><span>              </span><span class="annot"><span class="annottext">([[(Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)]]
 -&gt; [(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)])
-&gt; ([(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]
    -&gt; [[(Either
            FetchDecline
            (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
          extra)]])
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[[(Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
   extra)]]
-&gt; [[(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]]
forall a. [[a]] -&gt; [[a]]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#transpose"><span class="hs-identifier hs-var">transpose</span></a></span><span>
</span><span id="line-733"></span><span>              </span><span class="annot"><span class="annottext">([[(Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)]]
 -&gt; [[(Either
         FetchDecline
         (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
       extra)]])
-&gt; ([(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]
    -&gt; [[(Either
            FetchDecline
            (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
          extra)]])
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [[(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)
 -&gt; Bool)
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [[(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]]
forall a. (a -&gt; a -&gt; Bool) -&gt; [a] -&gt; [[a]]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#groupBy"><span class="hs-identifier hs-var">groupBy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Equating
  (Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; Bool
forall a b. Equating a -&gt; Equating (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingFst"><span class="hs-identifier hs-var">equatingFst</span></a></span><span>
</span><span id="line-734"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Equating
  (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; Equating
     (Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
forall b a. Equating b -&gt; Equating (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingRight"><span class="hs-identifier hs-var">equatingRight</span></a></span><span>
</span><span id="line-735"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point header -&gt; Point header -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span> </span><span class="annot"><span class="annottext">(Point header -&gt; Point header -&gt; Bool)
-&gt; ((ProbabilityBand, ChainSuffix header,
     [AnchoredFragment header])
    -&gt; Point header)
-&gt; Equating
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">(ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; Point header
forall {block} {a} {c}.
HasHeader block =&gt;
(a, ChainSuffix block, c) -&gt; Point block
</span><a href="#local-6989586621679210867"><span class="hs-identifier hs-var">chainHeadPoint</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-736"></span><span>              </span><span class="annot"><span class="annottext">([(Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
   extra)]
 -&gt; [[(Either
         FetchDecline
         (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
       extra)]])
-&gt; ([(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]
    -&gt; [(Either
           FetchDecline
           (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
         extra)])
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [[(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)
 -&gt; Ordering)
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing
  (Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; Ordering
forall a b. Comparing a -&gt; Comparing (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-var">comparingFst</span></a></span><span>
</span><span id="line-737"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing
  (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; Comparing
     (Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
forall b a. Comparing b -&gt; Comparing (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-var">comparingRight</span></a></span><span>
</span><span id="line-738"></span><span>                            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point header -&gt; Point header -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#compare"><span class="hs-identifier hs-var">compare</span></a></span><span> </span><span class="annot"><span class="annottext">(Point header -&gt; Point header -&gt; Ordering)
-&gt; ((ProbabilityBand, ChainSuffix header,
     [AnchoredFragment header])
    -&gt; Point header)
-&gt; Comparing
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">(ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; Point header
forall {block} {a} {c}.
HasHeader block =&gt;
(a, ChainSuffix block, c) -&gt; Point block
</span><a href="#local-6989586621679210867"><span class="hs-identifier hs-var">chainHeadPoint</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span>  </span><span class="annot"><span class="annottext">([[(Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)]]
 -&gt; [(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [[(Either
            FetchDecline
            (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
          extra)]])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)
 -&gt; Bool)
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [[(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]]
forall a. (a -&gt; a -&gt; Bool) -&gt; [a] -&gt; [[a]]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#groupBy"><span class="hs-identifier hs-var">groupBy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Equating
  (Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; Bool
forall a b. Equating a -&gt; Equating (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingFst"><span class="hs-identifier hs-var">equatingFst</span></a></span><span>
</span><span id="line-741"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Equating
  (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; Equating
     (Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
forall b a. Equating b -&gt; Equating (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingRight"><span class="hs-identifier hs-var">equatingRight</span></a></span><span>
</span><span id="line-742"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Equating ProbabilityBand
-&gt; Equating (ChainSuffix header)
-&gt; Equating (ProbabilityBand, ChainSuffix header)
forall a b. Equating a -&gt; Equating b -&gt; Equating (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingPair"><span class="hs-identifier hs-var">equatingPair</span></a></span><span>
</span><span id="line-743"></span><span>                   </span><span class="hs-comment">-- compare on probability band first, then preferred chain</span><span>
</span><span id="line-744"></span><span>                   </span><span class="annot"><span class="annottext">Equating ProbabilityBand
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">(==)</span></a></span><span>
</span><span id="line-745"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="#local-6989586621679210872"><span class="hs-identifier hs-var">equateCandidateChains</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool)
-&gt; (ChainSuffix header -&gt; AnchoredFragment header)
-&gt; Equating (ChainSuffix header)
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSuffix header -&gt; AnchoredFragment header
forall header. ChainSuffix header -&gt; AnchoredFragment header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#getChainSuffix"><span class="hs-identifier hs-var">getChainSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-746"></span><span>                 </span><span class="annot"><span class="annottext">Equating (ProbabilityBand, ChainSuffix header)
-&gt; ((ProbabilityBand, ChainSuffix header,
     [AnchoredFragment header])
    -&gt; (ProbabilityBand, ChainSuffix header))
-&gt; Equating
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span>
</span><span id="line-747"></span><span>                   </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679210873"><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="#local-6989586621679210873"><span class="hs-identifier hs-var">band</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210874"><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210874"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210875"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210875"><span class="hs-identifier hs-var">_fragments</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="#local-6989586621679210873"><span class="hs-identifier hs-var">band</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210874"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>  </span><span class="annot"><span class="annottext">([(Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
   extra)]
 -&gt; [[(Either
         FetchDecline
         (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
       extra)]])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [(Either
           FetchDecline
           (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
         extra)])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [[(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)]]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)
 -&gt; Ordering)
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)
 -&gt; Ordering)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; Ordering
forall a. Comparing a -&gt; Comparing a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#descendingOrder"><span class="hs-identifier hs-var">descendingOrder</span></a></span><span>
</span><span id="line-749"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing
  (Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; Ordering
forall a b. Comparing a -&gt; Comparing (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-var">comparingFst</span></a></span><span>
</span><span id="line-750"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing
  (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; Comparing
     (Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]))
forall b a. Comparing b -&gt; Comparing (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-var">comparingRight</span></a></span><span>
</span><span id="line-751"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing ProbabilityBand
-&gt; Comparing (ChainSuffix header)
-&gt; Comparing (ProbabilityBand, ChainSuffix header)
forall a b. Comparing a -&gt; Comparing b -&gt; Comparing (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingPair"><span class="hs-identifier hs-var">comparingPair</span></a></span><span>
</span><span id="line-752"></span><span>                     </span><span class="hs-comment">-- compare on probability band first, then preferred chain</span><span>
</span><span id="line-753"></span><span>                     </span><span class="annot"><span class="annottext">Comparing ProbabilityBand
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#compare"><span class="hs-identifier hs-var">compare</span></a></span><span>
</span><span id="line-754"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679210859"><span class="hs-identifier hs-var">compareCandidateChains</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering)
-&gt; (ChainSuffix header -&gt; AnchoredFragment header)
-&gt; Comparing (ChainSuffix header)
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSuffix header -&gt; AnchoredFragment header
forall header. ChainSuffix header -&gt; AnchoredFragment header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#getChainSuffix"><span class="hs-identifier hs-var">getChainSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-755"></span><span>                   </span><span class="annot"><span class="annottext">Comparing (ProbabilityBand, ChainSuffix header)
-&gt; ((ProbabilityBand, ChainSuffix header,
     [AnchoredFragment header])
    -&gt; (ProbabilityBand, ChainSuffix header))
-&gt; Comparing
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span>
</span><span id="line-756"></span><span>                      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679210878"><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="#local-6989586621679210878"><span class="hs-identifier hs-var">band</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210879"><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210879"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210880"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210880"><span class="hs-identifier hs-var">_fragments</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="#local-6989586621679210878"><span class="hs-identifier hs-var">band</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210879"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-757"></span><span>  </span><span class="annot"><span class="annottext">([(Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
   extra)]
 -&gt; [(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [(Either
           FetchDecline
           (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
         extra)])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; (Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra))
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecision (CandidateFragments header),
 PeerFetchInFlight header, PeerGSV, peer, extra)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
</span><a href="#local-6989586621679210881"><span class="hs-identifier hs-var">annotateProbabilityBand</span></a></span><span>
</span><span id="line-758"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (CandidateFragments header),
   PeerFetchInFlight header, PeerGSV, peer, extra)]
 -&gt; [(Either
        FetchDecline
        (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
      extra)])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [(FetchDecision (CandidateFragments header),
         PeerFetchInFlight header, PeerGSV, peer, extra)])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(Either
       FetchDecline
       (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; (FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; Ordering)
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679210882"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210882"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210883"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210883"><span class="hs-identifier hs-var">ap</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">extra
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679210884"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210884"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210885"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210885"><span class="hs-identifier hs-var">bp</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">extra
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-759"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; (PeerGSV, peer) -&gt; (PeerGSV, peer) -&gt; Ordering
forall peer.
(Hashable peer, Ord peer) =&gt;
Int -&gt; (PeerGSV, peer) -&gt; (PeerGSV, peer) -&gt; Ordering
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#comparePeerGSV%27"><span class="hs-identifier hs-var">comparePeerGSV'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679210858"><span class="hs-identifier hs-var">salt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210882"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210883"><span class="hs-identifier hs-var">ap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210884"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210885"><span class="hs-identifier hs-var">bp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-760"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-761"></span><span>    </span><span id="local-6989586621679210881"><span class="annot"><span class="annottext">annotateProbabilityBand :: (FetchDecision (CandidateFragments header),
 PeerFetchInFlight header, PeerGSV, peer, extra)
-&gt; (Either
      FetchDecline
      (ProbabilityBand, ChainSuffix header, [AnchoredFragment header]),
    extra)
</span><a href="#local-6989586621679210881"><span class="hs-identifier hs-var hs-var">annotateProbabilityBand</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679210886"><span class="annot"><span class="annottext">FetchDecline
</span><a href="#local-6989586621679210886"><span class="hs-identifier hs-var">decline</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerGSV
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peer
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210887"><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210887"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecline
-&gt; Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="#local-6989586621679210886"><span class="hs-identifier hs-var">decline</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210887"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>    </span><span class="annot"><a href="#local-6989586621679210881"><span class="hs-identifier hs-var">annotateProbabilityBand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210888"><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210888"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210889"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210889"><span class="hs-identifier hs-var">fragments</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210890"><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210890"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210891"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210891"><span class="hs-identifier hs-var">gsvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peer
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210892"><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210892"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-763"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
-&gt; Either
     FetchDecline
     (ProbabilityBand, ChainSuffix header, [AnchoredFragment header])
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="#local-6989586621679210893"><span class="hs-identifier hs-var">band</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210888"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210889"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210892"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-765"></span><span>        </span><span id="local-6989586621679210893"><span class="annot"><span class="annottext">band :: ProbabilityBand
</span><a href="#local-6989586621679210893"><span class="hs-identifier hs-var hs-var">band</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Double -&gt; ProbabilityBand
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#probabilityBand"><span class="hs-identifier hs-var">probabilityBand</span></a></span><span> </span><span class="annot"><span class="annottext">(Double -&gt; ProbabilityBand) -&gt; Double -&gt; ProbabilityBand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-766"></span><span>                 </span><span class="annot"><span class="annottext">PeerGSV -&gt; SizeInBytes -&gt; SizeInBytes -&gt; DiffTime -&gt; Double
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateResponseDeadlineProbability"><span class="hs-identifier hs-var">estimateResponseDeadlineProbability</span></a></span><span>
</span><span id="line-767"></span><span>                   </span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210891"><span class="hs-identifier hs-var">gsvs</span></a></span><span>
</span><span id="line-768"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerFetchInFlight header -&gt; SizeInBytes
forall header. PeerFetchInFlight header -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchBytesInFlight"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210890"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-769"></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(header -&gt; SizeInBytes) -&gt; [AnchoredFragment header] -&gt; SizeInBytes
forall header.
(header -&gt; SizeInBytes) -&gt; [AnchoredFragment header] -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#totalFetchSize"><span class="hs-identifier hs-var">totalFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679210860"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210889"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>                   </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679210897"><span class="hs-identifier hs-var">deadline</span></a></span><span>
</span><span id="line-771"></span><span>
</span><span id="line-772"></span><span>    </span><span id="local-6989586621679210897"><span class="annot"><span class="annottext">deadline :: DiffTime
</span><a href="#local-6989586621679210897"><span class="hs-identifier hs-var hs-var">deadline</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">2</span></span><span> </span><span class="hs-comment">-- seconds -- TODO: get this from external info</span><span>
</span><span id="line-773"></span><span>
</span><span id="line-774"></span><span>    </span><span id="local-6989586621679210872"><span class="annot"><span class="annottext">equateCandidateChains :: AnchoredFragment header -&gt; AnchoredFragment header -&gt; Bool
</span><a href="#local-6989586621679210872"><span class="hs-identifier hs-var hs-var">equateCandidateChains</span></a></span></span><span> </span><span id="local-6989586621679210900"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210900"><span class="hs-identifier hs-var">chain1</span></a></span></span><span> </span><span id="local-6989586621679210901"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210901"><span class="hs-identifier hs-var">chain2</span></a></span></span><span>
</span><span id="line-775"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#EQ"><span class="hs-identifier hs-var">EQ</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679210859"><span class="hs-identifier hs-var">compareCandidateChains</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210900"><span class="hs-identifier hs-var">chain1</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210901"><span class="hs-identifier hs-var">chain2</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-776"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                                  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-777"></span><span>
</span><span id="line-778"></span><span>    </span><span id="local-6989586621679210867"><span class="annot"><span class="annottext">chainHeadPoint :: (a, ChainSuffix block, c) -&gt; Point block
</span><a href="#local-6989586621679210867"><span class="hs-identifier hs-var hs-var">chainHeadPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ChainSuffix"><span class="hs-identifier hs-type">ChainSuffix</span></a></span><span> </span><span id="local-6989586621679210919"><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210919"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block -&gt; Point block
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; Point block
</span><span class="hs-identifier hs-var">AF.headPoint</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment block
</span><a href="#local-6989586621679210919"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-779"></span><span>
</span><span id="line-780"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#prioritisePeerChains"><span class="hs-identifier hs-var">prioritisePeerChains</span></a></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span> </span><span id="local-6989586621679210921"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679210921"><span class="hs-identifier hs-var">salt</span></a></span></span><span> </span><span id="local-6989586621679210922"><span class="annot"><span class="annottext">AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679210922"><span class="hs-identifier hs-var">compareCandidateChains</span></a></span></span><span> </span><span id="local-6989586621679210923"><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679210923"><span class="hs-identifier hs-var">blockFetchSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-781"></span><span>    </span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (DiffTime, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (FetchDecision [AnchoredFragment header], extra))
-&gt; [(Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [(FetchDecision [AnchoredFragment header], extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679210924"><span class="annot"><span class="annottext">Either
  FetchDecline
  (DiffTime, ChainSuffix header, [AnchoredFragment header])
</span><a href="#local-6989586621679210924"><span class="hs-identifier hs-var">decision</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210925"><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210925"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-782"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((DiffTime, ChainSuffix header, [AnchoredFragment header])
 -&gt; [AnchoredFragment header])
-&gt; Either
     FetchDecline
     (DiffTime, ChainSuffix header, [AnchoredFragment header])
-&gt; FetchDecision [AnchoredFragment header]
forall a b.
(a -&gt; b) -&gt; Either FetchDecline a -&gt; Either FetchDecline b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainSuffix header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210926"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210926"><span class="hs-identifier hs-var">fragment</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210926"><span class="hs-identifier hs-var">fragment</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either
  FetchDecline
  (DiffTime, ChainSuffix header, [AnchoredFragment header])
</span><a href="#local-6989586621679210924"><span class="hs-identifier hs-var">decision</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210925"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>  </span><span class="annot"><span class="annottext">([(Either
     FetchDecline
     (DiffTime, ChainSuffix header, [AnchoredFragment header]),
   extra)]
 -&gt; [(FetchDecision [AnchoredFragment header], extra)])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [(Either
           FetchDecline
           (DiffTime, ChainSuffix header, [AnchoredFragment header]),
         extra)])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(FetchDecision [AnchoredFragment header], extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Either
    FetchDecline
    (DiffTime, ChainSuffix header, [AnchoredFragment header]),
  extra)
 -&gt; (Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra)
 -&gt; Ordering)
-&gt; [(Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra)]
-&gt; [(Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing
  (Either
     FetchDecline
     (DiffTime, ChainSuffix header, [AnchoredFragment header]))
-&gt; (Either
      FetchDecline
      (DiffTime, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; (Either
      FetchDecline
      (DiffTime, ChainSuffix header, [AnchoredFragment header]),
    extra)
-&gt; Ordering
forall a b. Comparing a -&gt; Comparing (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-var">comparingFst</span></a></span><span>
</span><span id="line-784"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing (DiffTime, ChainSuffix header, [AnchoredFragment header])
-&gt; Comparing
     (Either
        FetchDecline
        (DiffTime, ChainSuffix header, [AnchoredFragment header]))
forall b a. Comparing b -&gt; Comparing (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-var">comparingRight</span></a></span><span>
</span><span id="line-785"></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Comparing (ChainSuffix header)
-&gt; Comparing DiffTime -&gt; Comparing (ChainSuffix header, DiffTime)
forall a b. Comparing a -&gt; Comparing b -&gt; Comparing (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingPair"><span class="hs-identifier hs-var">comparingPair</span></a></span><span>
</span><span id="line-786"></span><span>                  </span><span class="hs-comment">-- compare on preferred chain first, then duration</span><span>
</span><span id="line-787"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering
</span><a href="#local-6989586621679210922"><span class="hs-identifier hs-var">compareCandidateChains</span></a></span><span> </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; AnchoredFragment header -&gt; Ordering)
-&gt; (ChainSuffix header -&gt; AnchoredFragment header)
-&gt; Comparing (ChainSuffix header)
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSuffix header -&gt; AnchoredFragment header
forall header. ChainSuffix header -&gt; AnchoredFragment header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#getChainSuffix"><span class="hs-identifier hs-var">getChainSuffix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-788"></span><span>                  </span><span class="annot"><span class="annottext">Comparing DiffTime
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#compare"><span class="hs-identifier hs-var">compare</span></a></span><span>
</span><span id="line-789"></span><span>                </span><span class="annot"><span class="annottext">Comparing (ChainSuffix header, DiffTime)
-&gt; ((DiffTime, ChainSuffix header, [AnchoredFragment header])
    -&gt; (ChainSuffix header, DiffTime))
-&gt; Comparing
     (DiffTime, ChainSuffix header, [AnchoredFragment header])
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span>
</span><span id="line-790"></span><span>                  </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679210927"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679210927"><span class="hs-identifier hs-var">duration</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210928"><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210928"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210929"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210929"><span class="hs-identifier hs-var">_fragments</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210928"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679210927"><span class="hs-identifier hs-var">duration</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>  </span><span class="annot"><span class="annottext">([(Either
     FetchDecline
     (DiffTime, ChainSuffix header, [AnchoredFragment header]),
   extra)]
 -&gt; [(Either
        FetchDecline
        (DiffTime, ChainSuffix header, [AnchoredFragment header]),
      extra)])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [(Either
           FetchDecline
           (DiffTime, ChainSuffix header, [AnchoredFragment header]),
         extra)])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; (Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra))
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecision (CandidateFragments header),
 PeerFetchInFlight header, PeerGSV, peer, extra)
-&gt; (Either
      FetchDecline
      (DiffTime, ChainSuffix header, [AnchoredFragment header]),
    extra)
</span><a href="#local-6989586621679210930"><span class="hs-identifier hs-var">annotateDuration</span></a></span><span>
</span><span id="line-792"></span><span>  </span><span class="annot"><span class="annottext">([(FetchDecision (CandidateFragments header),
   PeerFetchInFlight header, PeerGSV, peer, extra)]
 -&gt; [(Either
        FetchDecline
        (DiffTime, ChainSuffix header, [AnchoredFragment header]),
      extra)])
-&gt; ([(FetchDecision (CandidateFragments header),
      PeerFetchInFlight header, PeerGSV, peer, extra)]
    -&gt; [(FetchDecision (CandidateFragments header),
         PeerFetchInFlight header, PeerGSV, peer, extra)])
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(Either
       FetchDecline
       (DiffTime, ChainSuffix header, [AnchoredFragment header]),
     extra)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision (CandidateFragments header),
  PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; (FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; Ordering)
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
-&gt; [(FetchDecision (CandidateFragments header),
     PeerFetchInFlight header, PeerGSV, peer, extra)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679210931"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210931"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210932"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210932"><span class="hs-identifier hs-var">ap</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">extra
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (CandidateFragments header)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679210933"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210933"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210934"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210934"><span class="hs-identifier hs-var">bp</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">extra
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-793"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; (PeerGSV, peer) -&gt; (PeerGSV, peer) -&gt; Ordering
forall peer.
(Hashable peer, Ord peer) =&gt;
Int -&gt; (PeerGSV, peer) -&gt; (PeerGSV, peer) -&gt; Ordering
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#comparePeerGSV%27"><span class="hs-identifier hs-var">comparePeerGSV'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679210921"><span class="hs-identifier hs-var">salt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210931"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210932"><span class="hs-identifier hs-var">ap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210933"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679210934"><span class="hs-identifier hs-var">bp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-794"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-795"></span><span>    </span><span id="local-6989586621679210930"><span class="annot"><span class="annottext">annotateDuration :: (FetchDecision (CandidateFragments header),
 PeerFetchInFlight header, PeerGSV, peer, extra)
-&gt; (Either
      FetchDecline
      (DiffTime, ChainSuffix header, [AnchoredFragment header]),
    extra)
</span><a href="#local-6989586621679210930"><span class="hs-identifier hs-var hs-var">annotateDuration</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679210935"><span class="annot"><span class="annottext">FetchDecline
</span><a href="#local-6989586621679210935"><span class="hs-identifier hs-var">decline</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerGSV
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peer
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210936"><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210936"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecline
-&gt; Either
     FetchDecline
     (DiffTime, ChainSuffix header, [AnchoredFragment header])
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="#local-6989586621679210935"><span class="hs-identifier hs-var">decline</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210936"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>    </span><span class="annot"><a href="#local-6989586621679210930"><span class="hs-identifier hs-var">annotateDuration</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210937"><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210937"><span class="hs-identifier hs-var">chain</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679210938"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210938"><span class="hs-identifier hs-var">fragments</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210939"><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210939"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210940"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210940"><span class="hs-identifier hs-var">gsvs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peer
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210941"><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210941"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-797"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DiffTime, ChainSuffix header, [AnchoredFragment header])
-&gt; Either
     FetchDecline
     (DiffTime, ChainSuffix header, [AnchoredFragment header])
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621679210942"><span class="hs-identifier hs-var">duration</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ChainSuffix header
</span><a href="#local-6989586621679210937"><span class="hs-identifier hs-var">chain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210938"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679210941"><span class="hs-identifier hs-var">peer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-798"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-799"></span><span>        </span><span class="hs-comment">-- TODO: consider if we should put this into bands rather than just</span><span>
</span><span id="line-800"></span><span>        </span><span class="hs-comment">-- taking the full value.</span><span>
</span><span id="line-801"></span><span>        </span><span id="local-6989586621679210942"><span class="annot"><span class="annottext">duration :: DiffTime
</span><a href="#local-6989586621679210942"><span class="hs-identifier hs-var hs-var">duration</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PeerGSV -&gt; SizeInBytes -&gt; SizeInBytes -&gt; DiffTime
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#estimateExpectedResponseDuration"><span class="hs-identifier hs-var">estimateExpectedResponseDuration</span></a></span><span>
</span><span id="line-802"></span><span>                     </span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679210940"><span class="hs-identifier hs-var">gsvs</span></a></span><span>
</span><span id="line-803"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerFetchInFlight header -&gt; SizeInBytes
forall header. PeerFetchInFlight header -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchBytesInFlight"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679210939"><span class="hs-identifier hs-var">inflight</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(header -&gt; SizeInBytes) -&gt; [AnchoredFragment header] -&gt; SizeInBytes
forall header.
(header -&gt; SizeInBytes) -&gt; [AnchoredFragment header] -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#totalFetchSize"><span class="hs-identifier hs-var">totalFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679210923"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210938"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span id="local-6989586621679210411"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#totalFetchSize"><span class="hs-identifier hs-type">totalFetchSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210411"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210411"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-808"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span></span><span>
</span><span id="line-809"></span><span id="totalFetchSize"><span class="annot"><span class="annottext">totalFetchSize :: forall header.
(header -&gt; SizeInBytes) -&gt; [AnchoredFragment header] -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#totalFetchSize"><span class="hs-identifier hs-var hs-var">totalFetchSize</span></a></span></span><span> </span><span id="local-6989586621679210946"><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679210946"><span class="hs-identifier hs-var">blockFetchSize</span></a></span></span><span> </span><span id="local-6989586621679210947"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210947"><span class="hs-identifier hs-var">fragments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-810"></span><span>  </span><span class="annot"><span class="annottext">[SizeInBytes] -&gt; SizeInBytes
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#sum"><span class="hs-identifier hs-var">sum</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679210946"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679210949"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-811"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679210950"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210950"><span class="hs-identifier hs-var">fragment</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679210947"><span class="hs-identifier hs-var">fragments</span></a></span><span>
</span><span id="line-812"></span><span>      </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210949"><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679210949"><span class="hs-identifier hs-var">header</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; [header]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AF.toOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679210950"><span class="hs-identifier hs-var">fragment</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span class="hs-keyword">type</span><span> </span><span id="Comparing"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-var">Comparing</span></a></span></span><span> </span><span id="local-6989586621679210952"><span class="annot"><a href="#local-6989586621679210952"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679210952"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210952"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Ordering"><span class="hs-identifier hs-type">Ordering</span></a></span><span>
</span><span id="line-815"></span><span class="hs-keyword">type</span><span> </span><span id="Equating"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-var">Equating</span></a></span></span><span>  </span><span id="local-6989586621679210953"><span class="annot"><a href="#local-6989586621679210953"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679210953"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679210953"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-816"></span><span>
</span><span id="line-817"></span><span id="local-6989586621679210406"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#descendingOrder"><span class="hs-identifier hs-type">descendingOrder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210406"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210406"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-818"></span><span id="descendingOrder"><span class="annot"><span class="annottext">descendingOrder :: forall a. Comparing a -&gt; Comparing a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#descendingOrder"><span class="hs-identifier hs-var hs-var">descendingOrder</span></a></span></span><span> </span><span id="local-6989586621679210954"><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210954"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Comparing a -&gt; Comparing a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210954"><span class="hs-identifier hs-var">cmp</span></a></span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span id="local-6989586621679210407"><span id="local-6989586621679210408"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingPair"><span class="hs-identifier hs-type">comparingPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210407"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210408"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210407"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210408"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-821"></span><span id="comparingPair"><span class="annot"><span class="annottext">comparingPair :: forall a b. Comparing a -&gt; Comparing b -&gt; Comparing (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingPair"><span class="hs-identifier hs-var hs-var">comparingPair</span></a></span></span><span> </span><span id="local-6989586621679210958"><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210958"><span class="hs-identifier hs-var">cmpA</span></a></span></span><span> </span><span id="local-6989586621679210959"><span class="annot"><span class="annottext">Comparing b
</span><a href="#local-6989586621679210959"><span class="hs-identifier hs-var">cmpB</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210960"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210960"><span class="hs-identifier hs-var">a1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210961"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210961"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210962"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210962"><span class="hs-identifier hs-var">a2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210963"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210963"><span class="hs-identifier hs-var">b2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210958"><span class="hs-identifier hs-var">cmpA</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210960"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210962"><span class="hs-identifier hs-var">a2</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Ordering
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Comparing b
</span><a href="#local-6989586621679210959"><span class="hs-identifier hs-var">cmpB</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210961"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210963"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span id="local-6989586621679210404"><span id="local-6989586621679210405"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingPair"><span class="hs-identifier hs-type">equatingPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210404"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210405"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210404"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210405"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-824"></span><span id="equatingPair"><span class="annot"><span class="annottext">equatingPair :: forall a b. Equating a -&gt; Equating b -&gt; Equating (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingPair"><span class="hs-identifier hs-var hs-var">equatingPair</span></a></span></span><span> </span><span id="local-6989586621679210964"><span class="annot"><span class="annottext">Equating a
</span><a href="#local-6989586621679210964"><span class="hs-identifier hs-var">eqA</span></a></span></span><span> </span><span id="local-6989586621679210965"><span class="annot"><span class="annottext">Equating b
</span><a href="#local-6989586621679210965"><span class="hs-identifier hs-var">eqB</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210966"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210966"><span class="hs-identifier hs-var">a1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210967"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210967"><span class="hs-identifier hs-var">b1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210968"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210968"><span class="hs-identifier hs-var">a2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679210969"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210969"><span class="hs-identifier hs-var">b2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Equating a
</span><a href="#local-6989586621679210964"><span class="hs-identifier hs-var">eqA</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210966"><span class="hs-identifier hs-var">a1</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210968"><span class="hs-identifier hs-var">a2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Equating b
</span><a href="#local-6989586621679210965"><span class="hs-identifier hs-var">eqB</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210967"><span class="hs-identifier hs-var">b1</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210969"><span class="hs-identifier hs-var">b2</span></a></span><span>
</span><span id="line-825"></span><span>
</span><span id="line-826"></span><span id="local-6989586621679210427"><span id="local-6989586621679210428"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier hs-type">comparingEither</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210427"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210428"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210427"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210428"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-827"></span><span id="comparingEither"><span class="annot"><span class="annottext">comparingEither :: forall a b. Comparing a -&gt; Comparing b -&gt; Comparing (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier hs-var hs-var">comparingEither</span></a></span></span><span> </span><span class="annot"><span class="annottext">Comparing a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Comparing b
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#LT"><span class="hs-identifier hs-var">LT</span></a></span><span>
</span><span id="line-828"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier hs-var">comparingEither</span></a></span><span> </span><span id="local-6989586621679210972"><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210972"><span class="hs-identifier hs-var">cmpA</span></a></span></span><span> </span><span class="annot"><span class="annottext">Comparing b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679210973"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210973"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679210974"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210974"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210972"><span class="hs-identifier hs-var">cmpA</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210973"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210974"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-829"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier hs-var">comparingEither</span></a></span><span> </span><span class="annot"><span class="annottext">Comparing a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679210975"><span class="annot"><span class="annottext">Comparing b
</span><a href="#local-6989586621679210975"><span class="hs-identifier hs-var">cmpB</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679210976"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210976"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679210977"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210977"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Comparing b
</span><a href="#local-6989586621679210975"><span class="hs-identifier hs-var">cmpB</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210976"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210977"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-830"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier hs-var">comparingEither</span></a></span><span> </span><span class="annot"><span class="annottext">Comparing a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Comparing b
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ordering
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#GT"><span class="hs-identifier hs-var">GT</span></a></span><span>
</span><span id="line-831"></span><span>
</span><span id="line-832"></span><span id="local-6989586621679210431"><span id="local-6989586621679210432"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier hs-type">equatingEither</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210431"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210432"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210431"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210432"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-833"></span><span id="equatingEither"><span class="annot"><span class="annottext">equatingEither :: forall a b. Equating a -&gt; Equating b -&gt; Equating (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier hs-var hs-var">equatingEither</span></a></span></span><span> </span><span class="annot"><span class="annottext">Equating a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Equating b
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-834"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier hs-var">equatingEither</span></a></span><span> </span><span id="local-6989586621679210979"><span class="annot"><span class="annottext">Equating a
</span><a href="#local-6989586621679210979"><span class="hs-identifier hs-var">eqA</span></a></span></span><span> </span><span class="annot"><span class="annottext">Equating b
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679210980"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210980"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span id="local-6989586621679210981"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210981"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Equating a
</span><a href="#local-6989586621679210979"><span class="hs-identifier hs-var">eqA</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210980"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679210981"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-835"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier hs-var">equatingEither</span></a></span><span> </span><span class="annot"><span class="annottext">Equating a
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679210982"><span class="annot"><span class="annottext">Equating b
</span><a href="#local-6989586621679210982"><span class="hs-identifier hs-var">eqB</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679210983"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210983"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679210984"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210984"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Equating b
</span><a href="#local-6989586621679210982"><span class="hs-identifier hs-var">eqB</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210983"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679210984"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-836"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier hs-var">equatingEither</span></a></span><span> </span><span class="annot"><span class="annottext">Equating a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Equating b
</span><span class="hs-identifier">_</span></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-837"></span><span>
</span><span id="line-838"></span><span id="local-6989586621679210400"><span id="local-6989586621679210401"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-type">comparingFst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210400"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210400"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210401"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-839"></span><span id="comparingFst"><span class="annot"><span class="annottext">comparingFst :: forall a b. Comparing a -&gt; Comparing (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingFst"><span class="hs-identifier hs-var hs-var">comparingFst</span></a></span></span><span> </span><span id="local-6989586621679210985"><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210985"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Comparing a
</span><a href="#local-6989586621679210985"><span class="hs-identifier hs-var">cmp</span></a></span><span> </span><span class="annot"><span class="annottext">Comparing a -&gt; ((a, b) -&gt; a) -&gt; (a, b) -&gt; (a, b) -&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">(a, b) -&gt; a
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span>
</span><span id="line-840"></span><span>
</span><span id="line-841"></span><span id="local-6989586621679210388"><span id="local-6989586621679210389"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingFst"><span class="hs-identifier hs-type">equatingFst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210388"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210388"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210389"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-842"></span><span id="equatingFst"><span class="annot"><span class="annottext">equatingFst :: forall a b. Equating a -&gt; Equating (a, b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingFst"><span class="hs-identifier hs-var hs-var">equatingFst</span></a></span></span><span> </span><span id="local-6989586621679210987"><span class="annot"><span class="annottext">Equating a
</span><a href="#local-6989586621679210987"><span class="hs-identifier hs-var">eq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Equating a
</span><a href="#local-6989586621679210987"><span class="hs-identifier hs-var">eq</span></a></span><span> </span><span class="annot"><span class="annottext">Equating a -&gt; ((a, b) -&gt; a) -&gt; (a, b) -&gt; (a, b) -&gt; Bool
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#on"><span class="hs-operator hs-var">`on`</span></a></span><span> </span><span class="annot"><span class="annottext">(a, b) -&gt; a
forall a b. (a, b) -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#fst"><span class="hs-identifier hs-var">fst</span></a></span><span>
</span><span id="line-843"></span><span>
</span><span id="line-844"></span><span id="local-6989586621679210402"><span id="local-6989586621679210403"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-type">comparingRight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210402"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Comparing"><span class="hs-identifier hs-type">Comparing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210403"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210402"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-845"></span><span id="comparingRight"><span class="annot"><span class="annottext">comparingRight :: forall b a. Comparing b -&gt; Comparing (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingRight"><span class="hs-identifier hs-var hs-var">comparingRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Comparing a -&gt; Comparing b -&gt; Comparing (Either a b)
forall a b. Comparing a -&gt; Comparing b -&gt; Comparing (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#comparingEither"><span class="hs-identifier hs-var">comparingEither</span></a></span><span> </span><span class="annot"><span class="annottext">Comparing a
forall a. Monoid a =&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#mempty"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span id="local-6989586621679210390"><span id="local-6989586621679210391"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingRight"><span class="hs-identifier hs-type">equatingRight</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210390"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#Equating"><span class="hs-identifier hs-type">Equating</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210391"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210390"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-848"></span><span id="equatingRight"><span class="annot"><span class="annottext">equatingRight :: forall b a. Equating b -&gt; Equating (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingRight"><span class="hs-identifier hs-var hs-var">equatingRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Equating a -&gt; Equating b -&gt; Equating (Either a b)
forall a b. Equating a -&gt; Equating b -&gt; Equating (Either a b)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#equatingEither"><span class="hs-identifier hs-var">equatingEither</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span class="hs-comment">-- | Given the probability of the download completing within the deadline,</span><span>
</span><span id="line-851"></span><span class="hs-comment">-- classify that into one of three broad bands: high, medium and low.</span><span>
</span><span id="line-852"></span><span class="hs-comment">--</span><span>
</span><span id="line-853"></span><span class="hs-comment">-- The bands are</span><span>
</span><span id="line-854"></span><span class="hs-comment">--</span><span>
</span><span id="line-855"></span><span class="hs-comment">-- * high:    98% -- 100%</span><span>
</span><span id="line-856"></span><span class="hs-comment">-- * medium:  75% --  98%</span><span>
</span><span id="line-857"></span><span class="hs-comment">-- * low:      0% --  75%</span><span>
</span><span id="line-858"></span><span class="hs-comment">--</span><span>
</span><span id="line-859"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#probabilityBand"><span class="hs-identifier hs-type">probabilityBand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Double"><span class="hs-identifier hs-type">Double</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityBand"><span class="hs-identifier hs-type">ProbabilityBand</span></a></span><span>
</span><span id="line-860"></span><span id="probabilityBand"><span class="annot"><span class="annottext">probabilityBand :: Double -&gt; ProbabilityBand
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#probabilityBand"><span class="hs-identifier hs-var hs-var">probabilityBand</span></a></span></span><span> </span><span id="local-6989586621679210993"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679210993"><span class="hs-identifier hs-var">p</span></a></span></span><span>
</span><span id="line-861"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679210993"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.98</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityHigh"><span class="hs-identifier hs-var">ProbabilityHigh</span></a></span><span>
</span><span id="line-862"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679210993"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.75</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityModerate"><span class="hs-identifier hs-var">ProbabilityModerate</span></a></span><span>
</span><span id="line-863"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProbabilityBand
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityLow"><span class="hs-identifier hs-var">ProbabilityLow</span></a></span><span>
</span><span id="line-864"></span><span> </span><span class="hs-comment">-- TODO: for hysteresis, increase probability if we're already using this peer</span><span>
</span><span id="line-865"></span><span>
</span><span id="line-866"></span><span class="hs-keyword">data</span><span> </span><span id="ProbabilityBand"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityBand"><span class="hs-identifier hs-var">ProbabilityBand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ProbabilityLow"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityLow"><span class="hs-identifier hs-var">ProbabilityLow</span></a></span></span><span>
</span><span id="line-867"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span id="ProbabilityModerate"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityModerate"><span class="hs-identifier hs-var">ProbabilityModerate</span></a></span></span><span>
</span><span id="line-868"></span><span>                     </span><span class="hs-glyph">|</span><span> </span><span id="ProbabilityHigh"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#ProbabilityHigh"><span class="hs-identifier hs-var">ProbabilityHigh</span></a></span></span><span>
</span><span id="line-869"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679210998"><span id="local-6989586621679211000"><span class="annot"><span class="annottext">Equating ProbabilityBand
Equating ProbabilityBand
-&gt; Equating ProbabilityBand -&gt; Eq ProbabilityBand
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: Equating ProbabilityBand
== :: Equating ProbabilityBand
$c/= :: Equating ProbabilityBand
/= :: Equating ProbabilityBand
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211005"><span id="local-6989586621679211007"><span id="local-6989586621679211009"><span id="local-6989586621679211012"><span id="local-6989586621679211015"><span id="local-6989586621679211018"><span id="local-6989586621679211021"><span class="annot"><span class="annottext">Eq ProbabilityBand
Eq ProbabilityBand =&gt;
Comparing ProbabilityBand
-&gt; Equating ProbabilityBand
-&gt; Equating ProbabilityBand
-&gt; Equating ProbabilityBand
-&gt; Equating ProbabilityBand
-&gt; (ProbabilityBand -&gt; ProbabilityBand -&gt; ProbabilityBand)
-&gt; (ProbabilityBand -&gt; ProbabilityBand -&gt; ProbabilityBand)
-&gt; Ord ProbabilityBand
Equating ProbabilityBand
Comparing ProbabilityBand
ProbabilityBand -&gt; ProbabilityBand -&gt; ProbabilityBand
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: Comparing ProbabilityBand
compare :: Comparing ProbabilityBand
$c&lt; :: Equating ProbabilityBand
&lt; :: Equating ProbabilityBand
$c&lt;= :: Equating ProbabilityBand
&lt;= :: Equating ProbabilityBand
$c&gt; :: Equating ProbabilityBand
&gt; :: Equating ProbabilityBand
$c&gt;= :: Equating ProbabilityBand
&gt;= :: Equating ProbabilityBand
$cmax :: ProbabilityBand -&gt; ProbabilityBand -&gt; ProbabilityBand
max :: ProbabilityBand -&gt; ProbabilityBand -&gt; ProbabilityBand
$cmin :: ProbabilityBand -&gt; ProbabilityBand -&gt; ProbabilityBand
min :: ProbabilityBand -&gt; ProbabilityBand -&gt; ProbabilityBand
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></a></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211025"><span id="local-6989586621679211027"><span id="local-6989586621679211031"><span class="annot"><span class="annottext">Int -&gt; ProbabilityBand -&gt; ShowS
[ProbabilityBand] -&gt; ShowS
ProbabilityBand -&gt; String
(Int -&gt; ProbabilityBand -&gt; ShowS)
-&gt; (ProbabilityBand -&gt; String)
-&gt; ([ProbabilityBand] -&gt; ShowS)
-&gt; Show ProbabilityBand
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ProbabilityBand -&gt; ShowS
showsPrec :: Int -&gt; ProbabilityBand -&gt; ShowS
$cshow :: ProbabilityBand -&gt; String
show :: ProbabilityBand -&gt; String
$cshowList :: [ProbabilityBand] -&gt; ShowS
showList :: [ProbabilityBand] -&gt; ShowS
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span class="hs-comment">{-
In the second phase we walk over the prioritised fetch suffixes for each peer
and make a decision about whether we should initiate any new fetch requests.

This decision is based on a number of factors:

 * Is the fetch suffix empty? If so, there's nothing to do.
 * Do we already have block fetch requests in flight with this peer?
 * If so are we under the maximum number of in-flight blocks for this peer?
 * Is this peer still performing within expectations or has it missed any soft
   time outs?
 * Has the peer missed any hard timeouts or otherwise been disconnected.
 * Are we at our soft or hard limit of the number of peers we are prepared to
   fetch blocks from concurrently?

We look at each peer chain fetch suffix one by one. Of course decisions we
make earlier can affect decisions later, in particular the number of peers we
fetch from concurrently can increase if we fetch from a new peer, and we must
obviously take that into account when considering later peer chains.
-}</span><span>
</span><span id="line-892"></span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecisions"><span class="hs-identifier hs-type">fetchRequestDecisions</span></a></span><span>
</span><span id="line-895"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679210252"><span class="annot"><a href="#local-6989586621679210252"><span class="hs-identifier hs-type">extra</span></a></span></span><span> </span><span id="local-6989586621679210251"><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span></span><span> </span><span id="local-6989586621679210250"><span class="annot"><a href="#local-6989586621679210250"><span class="hs-identifier hs-type">peer</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-896"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="#local-6989586621679210250"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-897"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-898"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Ord"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210250"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-899"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-901"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span>
</span><span id="line-902"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-903"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-904"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-905"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a></span><span>
</span><span id="line-906"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210250"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-907"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210252"><span class="hs-identifier hs-type">extra</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-908"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210252"><span class="hs-identifier hs-type">extra</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-909"></span><span id="fetchRequestDecisions"><span class="annot"><span class="annottext">fetchRequestDecisions :: forall extra header peer.
(Hashable peer, HasHeader header, Ord peer) =&gt;
FetchDecisionPolicy header
-&gt; FetchMode
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(FetchDecision (FetchRequest header), extra)]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecisions"><span class="hs-identifier hs-var hs-var">fetchRequestDecisions</span></a></span></span><span> </span><span id="local-6989586621679211076"><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211076"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span></span><span> </span><span id="local-6989586621679211077"><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211077"><span class="hs-identifier hs-var">fetchMode</span></a></span></span><span> </span><span id="local-6989586621679211078"><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)]
</span><a href="#local-6989586621679211078"><span class="hs-identifier hs-var">chains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-910"></span><span>    </span><span class="annot"><span class="annottext">Word
-&gt; Set (Point header)
-&gt; MaxSlotNo
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(FetchDecision (FetchRequest header), extra)]
</span><a href="#local-6989586621679211079"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211080"><span class="hs-identifier hs-var">nConcurrentFetchPeers0</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point header)
forall a. Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#empty"><span class="hs-identifier hs-var">Set.empty</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo
</span><span class="hs-identifier hs-var">NoMaxSlotNo</span></span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)]
</span><a href="#local-6989586621679211078"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-911"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-912"></span><span>    </span><span class="annot"><a href="#local-6989586621679211079"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-913"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Point</span></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaxSlotNo</span></span><span>
</span><span id="line-915"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecline"><span class="hs-identifier hs-type">FetchDecline</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-916"></span><span>            </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.DeltaQ.html#PeerGSV"><span class="hs-identifier hs-type">PeerGSV</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210250"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210252"><span class="hs-identifier hs-type">extra</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-917"></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210251"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679210252"><span class="hs-identifier hs-type">extra</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-918"></span><span>    </span><span id="local-6989586621679211079"><span class="annot"><span class="annottext">go :: Word
-&gt; Set (Point header)
-&gt; MaxSlotNo
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(FetchDecision (FetchRequest header), extra)]
</span><a href="#local-6989586621679211079"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">Set (Point header)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="annottext">MaxSlotNo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-919"></span><span>    </span><span class="annot"><a href="#local-6989586621679211079"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679211081"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211081"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679211082"><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679211082"><span class="hs-identifier hs-var">blocksFetchedThisRound</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679211083"><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211083"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound</span></a></span></span><span>
</span><span id="line-920"></span><span>       </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679211084"><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679211084"><span class="hs-identifier hs-var">mchainfragments</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211085"><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="#local-6989586621679211085"><span class="hs-identifier hs-var">status</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211086"><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679211086"><span class="hs-identifier hs-var">inflight</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211087"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679211087"><span class="hs-identifier hs-var">gsvs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211088"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211088"><span class="hs-identifier hs-var">peer</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211089"><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679211089"><span class="hs-identifier hs-var">extra</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span id="local-6989586621679211090"><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)]
</span><a href="#local-6989586621679211090"><span class="hs-identifier hs-var">cps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-921"></span><span>
</span><span id="line-922"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision (FetchRequest header)
</span><a href="#local-6989586621679211091"><span class="hs-identifier hs-var">decision</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><a href="#local-6989586621679211089"><span class="hs-identifier hs-var">extra</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-923"></span><span>      </span><span class="annot"><span class="annottext">(FetchDecision (FetchRequest header), extra)
-&gt; [(FetchDecision (FetchRequest header), extra)]
-&gt; [(FetchDecision (FetchRequest header), extra)]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">Word
-&gt; Set (Point header)
-&gt; MaxSlotNo
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(FetchDecision (FetchRequest header), extra)]
</span><a href="#local-6989586621679211079"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211092"><span class="hs-identifier hs-var">nConcurrentFetchPeers'</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679211093"><span class="hs-identifier hs-var">blocksFetchedThisRound'</span></a></span><span>
</span><span id="line-924"></span><span>           </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211094"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound'</span></a></span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)]
</span><a href="#local-6989586621679211090"><span class="hs-identifier hs-var">cps</span></a></span><span>
</span><span id="line-925"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-926"></span><span>        </span><span id="local-6989586621679211091"><span class="annot"><span class="annottext">decision :: FetchDecision (FetchRequest header)
</span><a href="#local-6989586621679211091"><span class="hs-identifier hs-var hs-var">decision</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
-&gt; FetchMode
-&gt; Word
-&gt; PeerFetchInFlightLimits
-&gt; PeerFetchInFlight header
-&gt; PeerFetchStatus header
-&gt; FetchDecision [AnchoredFragment header]
-&gt; FetchDecision (FetchRequest header)
forall header.
HasHeader header =&gt;
FetchDecisionPolicy header
-&gt; FetchMode
-&gt; Word
-&gt; PeerFetchInFlightLimits
-&gt; PeerFetchInFlight header
-&gt; PeerFetchStatus header
-&gt; FetchDecision [AnchoredFragment header]
-&gt; FetchDecision (FetchRequest header)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-var">fetchRequestDecision</span></a></span><span>
</span><span id="line-927"></span><span>                     </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211076"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-928"></span><span>                     </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211077"><span class="hs-identifier hs-var">fetchMode</span></a></span><span>
</span><span id="line-929"></span><span>                     </span><span class="hs-comment">-- Permit the preferred peers to by pass any concurrency limits.</span><span>
</span><span id="line-930"></span><span>                     </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">peer -&gt; [peer] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#elem"><span class="hs-identifier hs-var">elem</span></a></span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211088"><span class="hs-identifier hs-var">peer</span></a></span><span> </span><span class="annot"><span class="annottext">[peer]
</span><a href="#local-6989586621679211097"><span class="hs-identifier hs-var">nPreferedPeers</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span>
</span><span id="line-931"></span><span>                                                  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211081"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerGSV -&gt; PeerFetchInFlightLimits
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#calculatePeerFetchInFlightLimits"><span class="hs-identifier hs-var">calculatePeerFetchInFlightLimits</span></a></span><span> </span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679211087"><span class="hs-identifier hs-var">gsvs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-933"></span><span>                     </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679211086"><span class="hs-identifier hs-var">inflight</span></a></span><span>
</span><span id="line-934"></span><span>                     </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="#local-6989586621679211085"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-935"></span><span>                     </span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679211098"><span class="hs-identifier hs-var">mchainfragments'</span></a></span><span>
</span><span id="line-936"></span><span>
</span><span id="line-937"></span><span>        </span><span id="local-6989586621679211098"><span class="annot"><span class="annottext">mchainfragments' :: FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679211098"><span class="hs-identifier hs-var hs-var">mchainfragments'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-938"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211077"><span class="hs-identifier hs-var">fetchMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-939"></span><span>            </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeDeadline</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679211084"><span class="hs-identifier hs-var">mchainfragments</span></a></span><span>
</span><span id="line-940"></span><span>            </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-941"></span><span>                </span><span id="local-6989586621679211099"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211099"><span class="hs-identifier hs-var">chainfragments</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><a href="#local-6989586621679211084"><span class="hs-identifier hs-var">mchainfragments</span></a></span><span>
</span><span id="line-942"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679211100"><span class="annot"><span class="annottext">fragments :: [AnchoredFragment header]
</span><a href="#local-6989586621679211100"><span class="hs-identifier hs-var hs-var">fragments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-943"></span><span>                      </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; [AnchoredFragment header])
-&gt; [AnchoredFragment header] -&gt; [AnchoredFragment header]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
forall header.
HasHeader header =&gt;
(header -&gt; Bool)
-&gt; MaxSlotNo
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#filterWithMaxSlotNo"><span class="hs-identifier hs-var">filterWithMaxSlotNo</span></a></span><span>
</span><span id="line-944"></span><span>                                   </span><span class="annot"><span class="annottext">header -&gt; Bool
</span><a href="#local-6989586621679211101"><span class="hs-identifier hs-var">notFetchedThisRound</span></a></span><span>
</span><span id="line-945"></span><span>                                   </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211083"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>                                </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211099"><span class="hs-identifier hs-var">chainfragments</span></a></span><span>
</span><span id="line-947"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AnchoredFragment header] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211100"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; FetchDecline -&gt; Either FetchDecline ()
forall a e. Maybe a -&gt; e -&gt; Either e a
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#%3F%21"><span class="hs-operator hs-var">?!</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineInFlightOtherPeer"><span class="hs-identifier hs-var">FetchDeclineInFlightOtherPeer</span></a></span><span>
</span><span id="line-948"></span><span>                </span><span class="annot"><span class="annottext">[AnchoredFragment header]
-&gt; FetchDecision [AnchoredFragment header]
forall a. a -&gt; Either FetchDecline a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211100"><span class="hs-identifier hs-var">fragments</span></a></span><span>
</span><span id="line-949"></span><span>              </span><span class="hs-keyword">where</span><span>
</span><span id="line-950"></span><span>                </span><span id="local-6989586621679211101"><span class="annot"><span class="annottext">notFetchedThisRound :: header -&gt; Bool
</span><a href="#local-6989586621679211101"><span class="hs-identifier hs-var hs-var">notFetchedThisRound</span></a></span></span><span> </span><span id="local-6989586621679211102"><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211102"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-951"></span><span>                  </span><span class="annot"><span class="annottext">header -&gt; Point header
forall block. HasHeader block =&gt; block -&gt; Point block
</span><span class="hs-identifier hs-var">blockPoint</span></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211102"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Point header -&gt; Set (Point header) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#notMember"><span class="hs-operator hs-var">`Set.notMember`</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679211082"><span class="hs-identifier hs-var">blocksFetchedThisRound</span></a></span><span>
</span><span id="line-952"></span><span>
</span><span id="line-953"></span><span>        </span><span id="local-6989586621679211092"><span class="annot"><span class="annottext">nConcurrentFetchPeers' :: Word
</span><a href="#local-6989586621679211092"><span class="hs-identifier hs-var hs-var">nConcurrentFetchPeers'</span></a></span></span><span>
</span><span id="line-954"></span><span>          </span><span class="hs-comment">-- increment if it was idle, and now will not be</span><span>
</span><span id="line-955"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header -&gt; Word
forall header. PeerFetchInFlight header -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchReqsInFlight"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><a href="#local-6989586621679211086"><span class="hs-identifier hs-var">inflight</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span>
</span><span id="line-956"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FetchDecision (FetchRequest header)
</span><a href="#local-6989586621679211091"><span class="hs-identifier hs-var">decision</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211081"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span>
</span><span id="line-957"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211081"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a></span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span>        </span><span class="hs-comment">-- This is only for avoiding duplication between fetch requests in this</span><span>
</span><span id="line-960"></span><span>        </span><span class="hs-comment">-- round of decisions. Avoiding duplication with blocks that are already</span><span>
</span><span id="line-961"></span><span>        </span><span class="hs-comment">-- in flight is handled by filterNotAlreadyInFlightWithOtherPeers</span><span>
</span><span id="line-962"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679211093"><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679211093"><span class="hs-identifier hs-var">blocksFetchedThisRound'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211094"><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211094"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-963"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FetchDecision (FetchRequest header)
</span><a href="#local-6989586621679211091"><span class="hs-identifier hs-var">decision</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-964"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><span class="hs-identifier">_</span></span><span>                         </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-965"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679211082"><span class="hs-identifier hs-var">blocksFetchedThisRound</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211083"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-966"></span><span>            </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span id="local-6989586621679211106"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211106"><span class="hs-identifier hs-var">fragments</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-967"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679211082"><span class="hs-identifier hs-var">blocksFetchedThisRound</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point header) -&gt; Set (Point header) -&gt; Set (Point header)
forall a. Ord a =&gt; Set a -&gt; Set a -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#union"><span class="hs-operator hs-var">`Set.union`</span></a></span><span> </span><span class="annot"><span class="annottext">Set (Point header)
</span><a href="#local-6989586621679211108"><span class="hs-identifier hs-var">blocksFetchedThisDecision</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-968"></span><span>               </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211083"><span class="hs-identifier hs-var">maxSlotNoFetchedThisRound</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo -&gt; MaxSlotNo -&gt; MaxSlotNo
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#max"><span class="hs-operator hs-var">`max`</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo
</span><a href="#local-6989586621679211109"><span class="hs-identifier hs-var">maxSlotNoFetchedThisDecision</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-969"></span><span>              </span><span class="hs-keyword">where</span><span>
</span><span id="line-970"></span><span>                </span><span id="local-6989586621679211109"><span class="annot"><span class="annottext">maxSlotNoFetchedThisDecision :: MaxSlotNo
</span><a href="#local-6989586621679211109"><span class="hs-identifier hs-var hs-var">maxSlotNoFetchedThisDecision</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-971"></span><span>                  </span><span class="annot"><span class="annottext">(MaxSlotNo -&gt; MaxSlotNo -&gt; MaxSlotNo)
-&gt; MaxSlotNo -&gt; [MaxSlotNo] -&gt; MaxSlotNo
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#foldl%27"><span class="hs-identifier hs-var">foldl'</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo -&gt; MaxSlotNo -&gt; MaxSlotNo
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#max"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="annot"><span class="annottext">MaxSlotNo
</span><span class="hs-identifier hs-var">NoMaxSlotNo</span></span><span> </span><span class="annot"><span class="annottext">([MaxSlotNo] -&gt; MaxSlotNo) -&gt; [MaxSlotNo] -&gt; MaxSlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(SlotNo -&gt; MaxSlotNo) -&gt; [SlotNo] -&gt; [MaxSlotNo]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">SlotNo -&gt; MaxSlotNo
</span><span class="hs-identifier hs-var">MaxSlotNo</span></span><span> </span><span class="annot"><span class="annottext">([SlotNo] -&gt; [MaxSlotNo]) -&gt; [SlotNo] -&gt; [MaxSlotNo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-972"></span><span>                  </span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; Maybe SlotNo)
-&gt; [AnchoredFragment header] -&gt; [SlotNo]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WithOrigin SlotNo -&gt; Maybe SlotNo
forall t. WithOrigin t -&gt; Maybe t
</span><span class="hs-identifier hs-var">withOriginToMaybe</span></span><span> </span><span class="annot"><span class="annottext">(WithOrigin SlotNo -&gt; Maybe SlotNo)
-&gt; (AnchoredFragment header -&gt; WithOrigin SlotNo)
-&gt; AnchoredFragment header
-&gt; Maybe SlotNo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; WithOrigin SlotNo
forall block.
HasHeader block =&gt;
AnchoredFragment block -&gt; WithOrigin SlotNo
</span><span class="hs-identifier hs-var">AF.headSlot</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211106"><span class="hs-identifier hs-var">fragments</span></a></span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span>                </span><span id="local-6989586621679211108"><span class="annot"><span class="annottext">blocksFetchedThisDecision :: Set (Point header)
</span><a href="#local-6989586621679211108"><span class="hs-identifier hs-var hs-var">blocksFetchedThisDecision</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-975"></span><span>                  </span><span class="annot"><span class="annottext">[Point header] -&gt; Set (Point header)
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span>
</span><span id="line-976"></span><span>                    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">header -&gt; Point header
forall block. HasHeader block =&gt; block -&gt; Point block
</span><span class="hs-identifier hs-var">blockPoint</span></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211112"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-977"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679211113"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211113"><span class="hs-identifier hs-var">fragment</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211106"><span class="hs-identifier hs-var">fragments</span></a></span><span>
</span><span id="line-978"></span><span>                    </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211112"><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211112"><span class="hs-identifier hs-var">header</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; [header]
forall v a b. AnchoredSeq v a b -&gt; [b]
</span><span class="hs-identifier hs-var">AF.toOldestFirst</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211113"><span class="hs-identifier hs-var">fragment</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-979"></span><span>
</span><span id="line-980"></span><span>    </span><span id="local-6989586621679211080"><span class="annot"><span class="annottext">nConcurrentFetchPeers0 :: Word
</span><a href="#local-6989586621679211080"><span class="hs-identifier hs-var hs-var">nConcurrentFetchPeers0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word) -&gt; Int -&gt; Word
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Set peer -&gt; Int
forall a. Set a -&gt; Int
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#size"><span class="hs-identifier hs-var">Set.size</span></a></span><span> </span><span class="annot"><span class="annottext">Set peer
</span><a href="#local-6989586621679211115"><span class="hs-identifier hs-var">nActivePeers</span></a></span><span>
</span><span id="line-981"></span><span>
</span><span id="line-982"></span><span>    </span><span class="hs-comment">-- Set of peers with outstanding bytes.</span><span>
</span><span id="line-983"></span><span>    </span><span class="annot"><a href="#local-6989586621679211115"><span class="hs-identifier hs-type">nActivePeers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#Set"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210250"><span class="hs-identifier hs-type">peer</span></a></span><span>
</span><span id="line-984"></span><span>    </span><span id="local-6989586621679211115"><span class="annot"><span class="annottext">nActivePeers :: Set peer
</span><a href="#local-6989586621679211115"><span class="hs-identifier hs-var hs-var">nActivePeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-985"></span><span>        </span><span class="annot"><span class="annottext">[peer] -&gt; Set peer
forall a. Ord a =&gt; [a] -&gt; Set a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/containers-0.6.7/src/Data.Set.Internal.html#fromList"><span class="hs-identifier hs-var">Set.fromList</span></a></span><span>
</span><span id="line-986"></span><span>      </span><span class="annot"><span class="annottext">([peer] -&gt; Set peer)
-&gt; ([(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
      extra)]
    -&gt; [peer])
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; Set peer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Word, peer) -&gt; peer) -&gt; [(Word, peer)] -&gt; [peer]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(Word, peer) -&gt; peer
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span>
</span><span id="line-987"></span><span>      </span><span class="annot"><span class="annottext">([(Word, peer)] -&gt; [peer])
-&gt; ([(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
      extra)]
    -&gt; [(Word, peer)])
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [peer]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((Word, peer) -&gt; Bool) -&gt; [(Word, peer)] -&gt; [(Word, peer)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#filter"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679211117"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211117"><span class="hs-identifier hs-var">inFlight</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peer
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211117"><span class="hs-identifier hs-var">inFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-988"></span><span>      </span><span class="annot"><span class="annottext">([(Word, peer)] -&gt; [(Word, peer)])
-&gt; ([(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
      extra)]
    -&gt; [(Word, peer)])
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(Word, peer)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; (Word, peer))
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(Word, peer)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span class="hs-special">{</span><span id="local-6989586621679211119"><span class="annot"><span class="annottext">Word
peerFetchReqsInFlight :: forall header. PeerFetchInFlight header -&gt; Word
peerFetchReqsInFlight :: Word
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchReqsInFlight"><span class="hs-identifier hs-var hs-var">peerFetchReqsInFlight</span></a></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerGSV
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211120"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211120"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-989"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211119"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211120"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>      </span><span class="annot"><span class="annottext">([(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
   PeerFetchInFlight header, PeerGSV, peer, extra)]
 -&gt; Set peer)
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; Set peer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)]
</span><a href="#local-6989586621679211078"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-991"></span><span>
</span><span id="line-992"></span><span>    </span><span class="hs-comment">-- Order the peers based on current PeerGSV. The top performing peers will be</span><span>
</span><span id="line-993"></span><span>    </span><span class="hs-comment">-- permitted to go active even if we're above the desired maxConcurrentFetchPeers</span><span>
</span><span id="line-994"></span><span>    </span><span class="hs-comment">-- which will cause us to switch smoothly from a slower to faster peers.</span><span>
</span><span id="line-995"></span><span>    </span><span class="hs-comment">-- When switching from slow to faster peers we will be over the configured limit, but</span><span>
</span><span id="line-996"></span><span>    </span><span class="hs-comment">-- PeerGSV is expected to be updated rather infrequently so the set of preferred peers should</span><span>
</span><span id="line-997"></span><span>    </span><span class="hs-comment">-- be stable during 10s of seconds.</span><span>
</span><span id="line-998"></span><span>    </span><span class="annot"><a href="#local-6989586621679211097"><span class="hs-identifier hs-type">nPreferedPeers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679210250"><span class="hs-identifier hs-type">peer</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-999"></span><span>    </span><span id="local-6989586621679211097"><span class="annot"><span class="annottext">nPreferedPeers :: [peer]
</span><a href="#local-6989586621679211097"><span class="hs-identifier hs-var hs-var">nPreferedPeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1000"></span><span>        </span><span class="annot"><span class="annottext">((PeerGSV, peer) -&gt; peer) -&gt; [(PeerGSV, peer)] -&gt; [peer]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerGSV, peer) -&gt; peer
forall a b. (a, b) -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Tuple.html#snd"><span class="hs-identifier hs-var">snd</span></a></span><span>
</span><span id="line-1001"></span><span>      </span><span class="annot"><span class="annottext">([(PeerGSV, peer)] -&gt; [peer])
-&gt; ([(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
      extra)]
    -&gt; [(PeerGSV, peer)])
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [peer]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [(PeerGSV, peer)] -&gt; [(PeerGSV, peer)]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#take"><span class="hs-identifier hs-var">take</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211122"><span class="hs-identifier hs-var">maxConcurrentFetchPeers</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>      </span><span class="annot"><span class="annottext">([(PeerGSV, peer)] -&gt; [(PeerGSV, peer)])
-&gt; ([(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
      extra)]
    -&gt; [(PeerGSV, peer)])
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(PeerGSV, peer)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((PeerGSV, peer) -&gt; (PeerGSV, peer) -&gt; Ordering)
-&gt; [(PeerGSV, peer)] -&gt; [(PeerGSV, peer)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.OldList.html#sortBy"><span class="hs-identifier hs-var">sortBy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679211123"><span class="annot"><span class="annottext">(PeerGSV, peer)
</span><a href="#local-6989586621679211123"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679211124"><span class="annot"><span class="annottext">(PeerGSV, peer)
</span><a href="#local-6989586621679211124"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set peer -&gt; Int -&gt; (PeerGSV, peer) -&gt; (PeerGSV, peer) -&gt; Ordering
forall peer.
(Hashable peer, Ord peer) =&gt;
Set peer -&gt; Int -&gt; (PeerGSV, peer) -&gt; (PeerGSV, peer) -&gt; Ordering
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#comparePeerGSV"><span class="hs-identifier hs-var">comparePeerGSV</span></a></span><span> </span><span class="annot"><span class="annottext">Set peer
</span><a href="#local-6989586621679211115"><span class="hs-identifier hs-var">nActivePeers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecisionPolicy header -&gt; Int
forall header. FetchDecisionPolicy header -&gt; Int
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#peerSalt"><span class="hs-identifier hs-var">peerSalt</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211076"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PeerGSV, peer)
</span><a href="#local-6989586621679211123"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">(PeerGSV, peer)
</span><a href="#local-6989586621679211124"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1003"></span><span>      </span><span class="annot"><span class="annottext">([(PeerGSV, peer)] -&gt; [(PeerGSV, peer)])
-&gt; ([(FetchDecision [AnchoredFragment header],
      PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
      extra)]
    -&gt; [(PeerGSV, peer)])
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(PeerGSV, peer)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)
 -&gt; (PeerGSV, peer))
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [(PeerGSV, peer)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">FetchDecision [AnchoredFragment header]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211125"><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679211125"><span class="hs-identifier hs-var">gsv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679211126"><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211126"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">extra
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PeerGSV
</span><a href="#local-6989586621679211125"><span class="hs-identifier hs-var">gsv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">peer
</span><a href="#local-6989586621679211126"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1004"></span><span>      </span><span class="annot"><span class="annottext">([(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
   PeerFetchInFlight header, PeerGSV, peer, extra)]
 -&gt; [peer])
-&gt; [(FetchDecision [AnchoredFragment header],
     PeerFetchStatus header, PeerFetchInFlight header, PeerGSV, peer,
     extra)]
-&gt; [peer]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[(FetchDecision [AnchoredFragment header], PeerFetchStatus header,
  PeerFetchInFlight header, PeerGSV, peer, extra)]
</span><a href="#local-6989586621679211078"><span class="hs-identifier hs-var">chains</span></a></span><span>
</span><span id="line-1005"></span><span>
</span><span id="line-1006"></span><span>    </span><span class="annot"><a href="#local-6989586621679211122"><span class="hs-identifier hs-type">maxConcurrentFetchPeers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-1007"></span><span>    </span><span id="local-6989586621679211122"><span class="annot"><span class="annottext">maxConcurrentFetchPeers :: Word
</span><a href="#local-6989586621679211122"><span class="hs-identifier hs-var hs-var">maxConcurrentFetchPeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1008"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211077"><span class="hs-identifier hs-var">fetchMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1009"></span><span>           </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header -&gt; Word
forall header. FetchDecisionPolicy header -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyBulkSync"><span class="hs-identifier hs-var">maxConcurrencyBulkSync</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211076"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-1010"></span><span>           </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeDeadline</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header -&gt; Word
forall header. FetchDecisionPolicy header -&gt; Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyDeadline"><span class="hs-identifier hs-var">maxConcurrencyDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><a href="#local-6989586621679211076"><span class="hs-identifier hs-var">fetchDecisionPolicy</span></a></span><span>
</span><span id="line-1011"></span><span>
</span><span id="line-1012"></span><span>
</span><span id="line-1013"></span><span id="local-6989586621679210453"><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-type">fetchRequestDecision</span></a></span><span>
</span><span id="line-1014"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210453"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1015"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210453"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1016"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FetchMode</span></span><span>
</span><span id="line-1017"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#PeerFetchInFlightLimits"><span class="hs-identifier hs-type">PeerFetchInFlightLimits</span></a></span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210453"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1020"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatus"><span class="hs-identifier hs-type">PeerFetchStatus</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210453"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1021"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210453"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1022"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecision"><span class="hs-identifier hs-type">FetchDecision</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span>  </span><span class="annot"><a href="#local-6989586621679210453"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1023"></span><span>
</span><span id="line-1024"></span><span id="fetchRequestDecision"><span class="annot"><span class="annottext">fetchRequestDecision :: forall header.
HasHeader header =&gt;
FetchDecisionPolicy header
-&gt; FetchMode
-&gt; Word
-&gt; PeerFetchInFlightLimits
-&gt; PeerFetchInFlight header
-&gt; PeerFetchStatus header
-&gt; FetchDecision [AnchoredFragment header]
-&gt; FetchDecision (FetchRequest header)
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-var hs-var">fetchRequestDecision</span></a></span></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlightLimits
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679211145"><span class="annot"><span class="annottext">FetchDecline
</span><a href="#local-6989586621679211145"><span class="hs-identifier hs-var">decline</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1025"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="#local-6989586621679211145"><span class="hs-identifier hs-var">decline</span></a></span><span>
</span><span id="line-1026"></span><span>
</span><span id="line-1027"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-var">fetchRequestDecision</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlightLimits
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusShutdown"><span class="hs-identifier hs-var">PeerFetchStatusShutdown</span></a></span><span> </span><span class="annot"><span class="annottext">Either FetchDecline [AnchoredFragment header]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1028"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerShutdown"><span class="hs-identifier hs-var">FetchDeclinePeerShutdown</span></a></span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-var">fetchRequestDecision</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlightLimits
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusStarting"><span class="hs-identifier hs-var">PeerFetchStatusStarting</span></a></span><span> </span><span class="annot"><span class="annottext">Either FetchDecline [AnchoredFragment header]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1031"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerStarting"><span class="hs-identifier hs-var">FetchDeclinePeerStarting</span></a></span><span>
</span><span id="line-1032"></span><span>
</span><span id="line-1033"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-var">fetchRequestDecision</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecisionPolicy header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlightLimits
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchInFlight header
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusAberrant"><span class="hs-identifier hs-var">PeerFetchStatusAberrant</span></a></span><span> </span><span class="annot"><span class="annottext">Either FetchDecline [AnchoredFragment header]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-1034"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerSlow"><span class="hs-identifier hs-var">FetchDeclinePeerSlow</span></a></span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#fetchRequestDecision"><span class="hs-identifier hs-var">fetchRequestDecision</span></a></span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDecisionPolicy"><span class="hs-identifier hs-type">FetchDecisionPolicy</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1037"></span><span>                       </span><span id="local-6989586621679211146"><span class="annot"><span class="annottext">Word
maxConcurrencyBulkSync :: forall header. FetchDecisionPolicy header -&gt; Word
maxConcurrencyBulkSync :: Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyBulkSync"><span class="hs-identifier hs-var hs-var">maxConcurrencyBulkSync</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1038"></span><span>                       </span><span id="local-6989586621679211147"><span class="annot"><span class="annottext">Word
maxConcurrencyDeadline :: forall header. FetchDecisionPolicy header -&gt; Word
maxConcurrencyDeadline :: Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxConcurrencyDeadline"><span class="hs-identifier hs-var hs-var">maxConcurrencyDeadline</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1039"></span><span>                       </span><span id="local-6989586621679211148"><span class="annot"><span class="annottext">Word
maxInFlightReqsPerPeer :: forall header. FetchDecisionPolicy header -&gt; Word
maxInFlightReqsPerPeer :: Word
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#maxInFlightReqsPerPeer"><span class="hs-identifier hs-var hs-var">maxInFlightReqsPerPeer</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1040"></span><span>                       </span><span id="local-6989586621679211149"><span class="annot"><span class="annottext">header -&gt; SizeInBytes
blockFetchSize :: forall header. FetchDecisionPolicy header -&gt; header -&gt; SizeInBytes
blockFetchSize :: header -&gt; SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#blockFetchSize"><span class="hs-identifier hs-var hs-var">blockFetchSize</span></a></span></span><span>
</span><span id="line-1041"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-1042"></span><span>                     </span><span id="local-6989586621679211150"><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211150"><span class="hs-identifier hs-var">fetchMode</span></a></span></span><span>
</span><span id="line-1043"></span><span>                     </span><span id="local-6989586621679211151"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211151"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a></span></span><span>
</span><span id="line-1044"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#PeerFetchInFlightLimits"><span class="hs-identifier hs-type">PeerFetchInFlightLimits</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1045"></span><span>                       </span><span id="local-6989586621679211153"><span class="annot"><span class="annottext">SizeInBytes
inFlightBytesLowWatermark :: PeerFetchInFlightLimits -&gt; SizeInBytes
inFlightBytesLowWatermark :: SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#inFlightBytesLowWatermark"><span class="hs-identifier hs-var hs-var">inFlightBytesLowWatermark</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1046"></span><span>                       </span><span id="local-6989586621679211154"><span class="annot"><span class="annottext">SizeInBytes
inFlightBytesHighWatermark :: PeerFetchInFlightLimits -&gt; SizeInBytes
inFlightBytesHighWatermark :: SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.DeltaQ.html#inFlightBytesHighWatermark"><span class="hs-identifier hs-var hs-var">inFlightBytesHighWatermark</span></a></span></span><span>
</span><span id="line-1047"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-1048"></span><span>                     </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchInFlight"><span class="hs-identifier hs-type">PeerFetchInFlight</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-1049"></span><span>                       </span><span id="local-6989586621679211155"><span class="annot"><span class="annottext">Word
peerFetchReqsInFlight :: forall header. PeerFetchInFlight header -&gt; Word
peerFetchReqsInFlight :: Word
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchReqsInFlight"><span class="hs-identifier hs-var hs-var">peerFetchReqsInFlight</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-1050"></span><span>                       </span><span id="local-6989586621679211156"><span class="annot"><span class="annottext">SizeInBytes
peerFetchBytesInFlight :: forall header. PeerFetchInFlight header -&gt; SizeInBytes
peerFetchBytesInFlight :: SizeInBytes
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#peerFetchBytesInFlight"><span class="hs-identifier hs-var hs-var">peerFetchBytesInFlight</span></a></span></span><span>
</span><span id="line-1051"></span><span>                     </span><span class="hs-special">}</span><span>
</span><span id="line-1052"></span><span>                     </span><span id="local-6989586621679211157"><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="#local-6989586621679211157"><span class="hs-identifier hs-var">peerFetchStatus</span></a></span></span><span>
</span><span id="line-1053"></span><span>                     </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679211158"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211158"><span class="hs-identifier hs-var">fetchFragments</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1054"></span><span>
</span><span id="line-1055"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211155"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211148"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a></span><span>
</span><span id="line-1056"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecline -&gt; Either FetchDecline (FetchRequest header))
-&gt; FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineReqsInFlightLimit"><span class="hs-identifier hs-var">FetchDeclineReqsInFlightLimit</span></a></span><span>
</span><span id="line-1057"></span><span>             </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211148"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a></span><span>
</span><span id="line-1058"></span><span>
</span><span id="line-1059"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211156"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; SizeInBytes -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211154"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a></span><span>
</span><span id="line-1060"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecline -&gt; Either FetchDecline (FetchRequest header))
-&gt; FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; SizeInBytes -&gt; SizeInBytes -&gt; FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineBytesInFlightLimit"><span class="hs-identifier hs-var">FetchDeclineBytesInFlightLimit</span></a></span><span>
</span><span id="line-1061"></span><span>             </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211156"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a></span><span>
</span><span id="line-1062"></span><span>             </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211153"><span class="hs-identifier hs-var">inFlightBytesLowWatermark</span></a></span><span>
</span><span id="line-1063"></span><span>             </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211154"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a></span><span>
</span><span id="line-1064"></span><span>
</span><span id="line-1065"></span><span>    </span><span class="hs-comment">-- This covers the case when we could still fit in more reqs or bytes, but</span><span>
</span><span id="line-1066"></span><span>    </span><span class="hs-comment">-- we want to let it drop below a low water mark before sending more so we</span><span>
</span><span id="line-1067"></span><span>    </span><span class="hs-comment">-- get a bit more batching behaviour, rather than lots of 1-block reqs.</span><span>
</span><span id="line-1068"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
</span><a href="#local-6989586621679211157"><span class="hs-identifier hs-var">peerFetchStatus</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header -&gt; PeerFetchStatus header -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">PeerFetchStatus header
forall header. PeerFetchStatus header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#PeerFetchStatusBusy"><span class="hs-identifier hs-var">PeerFetchStatusBusy</span></a></span><span>
</span><span id="line-1069"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecline -&gt; Either FetchDecline (FetchRequest header))
-&gt; FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; SizeInBytes -&gt; SizeInBytes -&gt; FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclinePeerBusy"><span class="hs-identifier hs-var">FetchDeclinePeerBusy</span></a></span><span>
</span><span id="line-1070"></span><span>             </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211156"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a></span><span>
</span><span id="line-1071"></span><span>             </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211153"><span class="hs-identifier hs-var">inFlightBytesLowWatermark</span></a></span><span>
</span><span id="line-1072"></span><span>             </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211154"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a></span><span>
</span><span id="line-1073"></span><span>
</span><span id="line-1074"></span><span>    </span><span class="hs-comment">-- Refuse any blockrequest if we're above the concurrency limit.</span><span>
</span><span id="line-1075"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679211160"><span class="annot"><span class="annottext">maxConcurrentFetchPeers :: Word
</span><a href="#local-6989586621679211160"><span class="hs-identifier hs-var hs-var">maxConcurrentFetchPeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211150"><span class="hs-identifier hs-var">fetchMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1076"></span><span>                                    </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211146"><span class="hs-identifier hs-var">maxConcurrencyBulkSync</span></a></span><span>
</span><span id="line-1077"></span><span>                                    </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeDeadline</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211147"><span class="hs-identifier hs-var">maxConcurrencyDeadline</span></a></span><span>
</span><span id="line-1078"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211151"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211160"><span class="hs-identifier hs-var">maxConcurrentFetchPeers</span></a></span><span>
</span><span id="line-1079"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecline -&gt; Either FetchDecline (FetchRequest header))
-&gt; FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FetchMode -&gt; Word -&gt; FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineConcurrencyLimit"><span class="hs-identifier hs-var">FetchDeclineConcurrencyLimit</span></a></span><span>
</span><span id="line-1080"></span><span>             </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211150"><span class="hs-identifier hs-var">fetchMode</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211160"><span class="hs-identifier hs-var">maxConcurrentFetchPeers</span></a></span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span>    </span><span class="hs-comment">-- If we're at the concurrency limit refuse any additional peers.</span><span>
</span><span id="line-1083"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211155"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1084"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679211161"><span class="annot"><span class="annottext">maxConcurrentFetchPeers :: Word
</span><a href="#local-6989586621679211161"><span class="hs-identifier hs-var hs-var">maxConcurrentFetchPeers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211150"><span class="hs-identifier hs-var">fetchMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1085"></span><span>                                    </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeBulkSync</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211146"><span class="hs-identifier hs-var">maxConcurrencyBulkSync</span></a></span><span>
</span><span id="line-1086"></span><span>                                    </span><span class="annot"><span class="annottext">FetchMode
</span><span class="hs-identifier hs-var">FetchModeDeadline</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211147"><span class="hs-identifier hs-var">maxConcurrencyDeadline</span></a></span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211151"><span class="hs-identifier hs-var">nConcurrentFetchPeers</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211161"><span class="hs-identifier hs-var">maxConcurrentFetchPeers</span></a></span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchDecline -&gt; Either FetchDecline (FetchRequest header))
-&gt; FetchDecline -&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FetchMode -&gt; Word -&gt; FetchDecline
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#FetchDeclineConcurrencyLimit"><span class="hs-identifier hs-var">FetchDeclineConcurrencyLimit</span></a></span><span>
</span><span id="line-1089"></span><span>             </span><span class="annot"><span class="annottext">FetchMode
</span><a href="#local-6989586621679211150"><span class="hs-identifier hs-var">fetchMode</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211161"><span class="hs-identifier hs-var">maxConcurrentFetchPeers</span></a></span><span>
</span><span id="line-1090"></span><span>
</span><span id="line-1091"></span><span>    </span><span class="hs-comment">-- We've checked our request limit and our byte limit. We are then</span><span>
</span><span id="line-1092"></span><span>    </span><span class="hs-comment">-- guaranteed to get at least one non-empty request range.</span><span>
</span><span id="line-1093"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-1094"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; Either FetchDecline (FetchRequest header)
-&gt; Either FetchDecline (FetchRequest header)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211155"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211148"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either FetchDecline (FetchRequest header)
 -&gt; Either FetchDecline (FetchRequest header))
-&gt; Either FetchDecline (FetchRequest header)
-&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1095"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; Either FetchDecline (FetchRequest header)
-&gt; Either FetchDecline (FetchRequest header)
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AnchoredFragment header] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211158"><span class="hs-identifier hs-var">fetchFragments</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either FetchDecline (FetchRequest header)
 -&gt; Either FetchDecline (FetchRequest header))
-&gt; Either FetchDecline (FetchRequest header)
-&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1096"></span><span>
</span><span id="line-1097"></span><span>    </span><span class="annot"><span class="annottext">FetchRequest header -&gt; Either FetchDecline (FetchRequest header)
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(FetchRequest header -&gt; Either FetchDecline (FetchRequest header))
-&gt; FetchRequest header -&gt; Either FetchDecline (FetchRequest header)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(header -&gt; SizeInBytes)
-&gt; Word
-&gt; Word
-&gt; SizeInBytes
-&gt; SizeInBytes
-&gt; [AnchoredFragment header]
-&gt; FetchRequest header
forall header.
HasHeader header =&gt;
(header -&gt; SizeInBytes)
-&gt; Word
-&gt; Word
-&gt; SizeInBytes
-&gt; SizeInBytes
-&gt; [AnchoredFragment header]
-&gt; FetchRequest header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#selectBlocksUpToLimits"><span class="hs-identifier hs-var">selectBlocksUpToLimits</span></a></span><span>
</span><span id="line-1098"></span><span>              </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679211149"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span>
</span><span id="line-1099"></span><span>              </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211155"><span class="hs-identifier hs-var">peerFetchReqsInFlight</span></a></span><span>
</span><span id="line-1100"></span><span>              </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211148"><span class="hs-identifier hs-var">maxInFlightReqsPerPeer</span></a></span><span>
</span><span id="line-1101"></span><span>              </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211156"><span class="hs-identifier hs-var">peerFetchBytesInFlight</span></a></span><span>
</span><span id="line-1102"></span><span>              </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211154"><span class="hs-identifier hs-var">inFlightBytesHighWatermark</span></a></span><span>
</span><span id="line-1103"></span><span>              </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211158"><span class="hs-identifier hs-var">fetchFragments</span></a></span><span>
</span><span id="line-1104"></span><span>
</span><span id="line-1105"></span><span>
</span><span id="line-1106"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-1107"></span><span class="hs-comment">--</span><span>
</span><span id="line-1108"></span><span class="hs-comment">-- Precondition: The result will be non-empty if</span><span>
</span><span id="line-1109"></span><span class="hs-comment">--</span><span>
</span><span id="line-1110"></span><span class="hs-comment">-- Property: result is non-empty if preconditions satisfied</span><span>
</span><span id="line-1111"></span><span class="hs-comment">--</span><span>
</span><span id="line-1112"></span><span class="annot"><a href="Ouroboros.Network.BlockFetch.Decision.html#selectBlocksUpToLimits"><span class="hs-identifier hs-type">selectBlocksUpToLimits</span></a></span><span>
</span><span id="line-1113"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679210474"><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">HasHeader</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1114"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ Block body size</span></span><span>
</span><span id="line-1115"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Current number of requests in flight</span></span><span>
</span><span id="line-1116"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Maximum number of requests in flight allowed</span></span><span>
</span><span id="line-1117"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Current number of bytes in flight</span></span><span>
</span><span id="line-1118"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Maximum number of bytes in flight allowed</span></span><span>
</span><span id="line-1119"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1120"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-type">FetchRequest</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1121"></span><span id="selectBlocksUpToLimits"><span class="annot"><span class="annottext">selectBlocksUpToLimits :: forall header.
HasHeader header =&gt;
(header -&gt; SizeInBytes)
-&gt; Word
-&gt; Word
-&gt; SizeInBytes
-&gt; SizeInBytes
-&gt; [AnchoredFragment header]
-&gt; FetchRequest header
</span><a href="Ouroboros.Network.BlockFetch.Decision.html#selectBlocksUpToLimits"><span class="hs-identifier hs-var hs-var">selectBlocksUpToLimits</span></a></span></span><span> </span><span id="local-6989586621679211185"><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679211185"><span class="hs-identifier hs-var">blockFetchSize</span></a></span></span><span> </span><span id="local-6989586621679211186"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211186"><span class="hs-identifier hs-var">nreqs0</span></a></span></span><span> </span><span id="local-6989586621679211187"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211187"><span class="hs-identifier hs-var">maxreqs</span></a></span></span><span> </span><span id="local-6989586621679211188"><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211188"><span class="hs-identifier hs-var">nbytes0</span></a></span></span><span> </span><span id="local-6989586621679211189"><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211189"><span class="hs-identifier hs-var">maxbytes</span></a></span></span><span> </span><span id="local-6989586621679211190"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211190"><span class="hs-identifier hs-var">fragments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1122"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; FetchRequest header -&gt; FetchRequest header
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211186"><span class="hs-identifier hs-var">nreqs0</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211187"><span class="hs-identifier hs-var">maxreqs</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211188"><span class="hs-identifier hs-var">nbytes0</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; SizeInBytes -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211189"><span class="hs-identifier hs-var">maxbytes</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[AnchoredFragment header] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211190"><span class="hs-identifier hs-var">fragments</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FetchRequest header -&gt; FetchRequest header)
-&gt; FetchRequest header -&gt; FetchRequest header
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1123"></span><span>    </span><span class="hs-comment">-- The case that we are already over our limits has to be checked earlier,</span><span>
</span><span id="line-1124"></span><span>    </span><span class="hs-comment">-- outside of this function. From here on however we check for limits.</span><span>
</span><span id="line-1125"></span><span>
</span><span id="line-1126"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679211191"><span class="annot"><span class="annottext">fragments' :: [AnchoredFragment header]
</span><a href="#local-6989586621679211191"><span class="hs-identifier hs-var hs-var">fragments'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
-&gt; SizeInBytes
-&gt; [AnchoredFragment header]
-&gt; [AnchoredFragment header]
</span><a href="#local-6989586621679211192"><span class="hs-identifier hs-var">goFrags</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211186"><span class="hs-identifier hs-var">nreqs0</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211188"><span class="hs-identifier hs-var">nbytes0</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211190"><span class="hs-identifier hs-var">fragments</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-1127"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; FetchRequest header -&gt; FetchRequest header
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#assert"><span class="hs-identifier hs-var hs-var">assert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(AnchoredFragment header -&gt; Bool)
-&gt; [AnchoredFragment header] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Foldable.html#all"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (AnchoredFragment header -&gt; Bool)
-&gt; AnchoredFragment header
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; Bool
forall v a b. AnchoredSeq v a b -&gt; Bool
</span><span class="hs-identifier hs-var">AF.null</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211191"><span class="hs-identifier hs-var">fragments'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(FetchRequest header -&gt; FetchRequest header)
-&gt; FetchRequest header -&gt; FetchRequest header
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-1128"></span><span>    </span><span class="annot"><span class="annottext">[AnchoredFragment header] -&gt; FetchRequest header
forall header. [AnchoredFragment header] -&gt; FetchRequest header
</span><a href="Ouroboros.Network.BlockFetch.ClientState.html#FetchRequest"><span class="hs-identifier hs-var">FetchRequest</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211191"><span class="hs-identifier hs-var">fragments'</span></a></span><span>
</span><span id="line-1129"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1130"></span><span>    </span><span class="annot"><a href="#local-6989586621679211192"><span class="hs-identifier hs-type">goFrags</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-1131"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span>
</span><span id="line-1132"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1133"></span><span>    </span><span id="local-6989586621679211192"><span class="annot"><span class="annottext">goFrags :: Word
-&gt; SizeInBytes
-&gt; [AnchoredFragment header]
-&gt; [AnchoredFragment header]
</span><a href="#local-6989586621679211192"><span class="hs-identifier hs-var hs-var">goFrags</span></a></span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-identifier">_</span></span><span>     </span><span class="annot"><span class="annottext">SizeInBytes
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1134"></span><span>    </span><span class="annot"><a href="#local-6989586621679211192"><span class="hs-identifier hs-var">goFrags</span></a></span><span> </span><span id="local-6989586621679211194"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211194"><span class="hs-identifier hs-var">nreqs</span></a></span></span><span> </span><span id="local-6989586621679211195"><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211195"><span class="hs-identifier hs-var">nbytes</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679211196"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211196"><span class="hs-identifier hs-var">c</span></a></span></span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679211197"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211197"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1135"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211194"><span class="hs-identifier hs-var">nreqs</span></a></span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span>  </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211187"><span class="hs-identifier hs-var">maxreqs</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1136"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
-&gt; SizeInBytes
-&gt; AnchoredFragment header
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
-&gt; [AnchoredFragment header]
</span><a href="#local-6989586621679211198"><span class="hs-identifier hs-var">goFrag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211194"><span class="hs-identifier hs-var">nreqs</span></a></span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Word
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211195"><span class="hs-identifier hs-var">nbytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Anchor header -&gt; AnchoredFragment header
forall v a b. Anchorable v a b =&gt; a -&gt; AnchoredSeq v a b
</span><span class="hs-identifier hs-var">AF.Empty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; Anchor header
forall v a b. AnchoredSeq v a b -&gt; a
</span><span class="hs-identifier hs-var">AF.anchor</span></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211196"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211196"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211197"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-1137"></span><span>      </span><span class="hs-comment">-- Each time we have to pick from a new discontiguous chain fragment then</span><span>
</span><span id="line-1138"></span><span>      </span><span class="hs-comment">-- that will become a new request, which contributes to our in-flight</span><span>
</span><span id="line-1139"></span><span>      </span><span class="hs-comment">-- request count. We never break the maxreqs limit.</span><span>
</span><span id="line-1140"></span><span>
</span><span id="line-1141"></span><span>    </span><span class="annot"><a href="#local-6989586621679211198"><span class="hs-identifier hs-type">goFrag</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Word"><span class="hs-identifier hs-type">Word</span></a></span><span>
</span><span id="line-1142"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SizeInBytes</span></span><span>
</span><span id="line-1143"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1144"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span>
</span><span id="line-1145"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">AnchoredFragment</span></span><span> </span><span class="annot"><a href="#local-6989586621679210474"><span class="hs-identifier hs-type">header</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1146"></span><span>    </span><span id="local-6989586621679211198"><span class="annot"><span class="annottext">goFrag :: Word
-&gt; SizeInBytes
-&gt; AnchoredFragment header
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
-&gt; [AnchoredFragment header]
</span><a href="#local-6989586621679211198"><span class="hs-identifier hs-var hs-var">goFrag</span></a></span></span><span> </span><span id="local-6989586621679211201"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211201"><span class="hs-identifier hs-var">nreqs</span></a></span></span><span> </span><span id="local-6989586621679211202"><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211202"><span class="hs-identifier hs-var">nbytes</span></a></span></span><span> </span><span id="local-6989586621679211203"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211203"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Empty</span></span><span> </span><span class="annot"><span class="annottext">Anchor header
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679211204"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211204"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211203"><span class="hs-identifier hs-var">c'</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
-&gt; [AnchoredFragment header] -&gt; [AnchoredFragment header]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">Word
-&gt; SizeInBytes
-&gt; [AnchoredFragment header]
-&gt; [AnchoredFragment header]
</span><a href="#local-6989586621679211192"><span class="hs-identifier hs-var">goFrags</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211201"><span class="hs-identifier hs-var">nreqs</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211202"><span class="hs-identifier hs-var">nbytes</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211204"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-1147"></span><span>    </span><span class="annot"><a href="#local-6989586621679211198"><span class="hs-identifier hs-var">goFrag</span></a></span><span> </span><span id="local-6989586621679211205"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211205"><span class="hs-identifier hs-var">nreqs</span></a></span></span><span> </span><span id="local-6989586621679211206"><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211206"><span class="hs-identifier hs-var">nbytes</span></a></span></span><span> </span><span id="local-6989586621679211207"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211207"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679211208"><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211208"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:&lt;</span></span><span> </span><span id="local-6989586621679211210"><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211210"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span>  </span><span id="local-6989586621679211211"><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211211"><span class="hs-identifier hs-var">cs</span></a></span></span><span>
</span><span id="line-1148"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211212"><span class="hs-identifier hs-var">nbytes'</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; SizeInBytes -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211189"><span class="hs-identifier hs-var">maxbytes</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211207"><span class="hs-identifier hs-var">c'</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; header -&gt; AnchoredFragment header
forall v a b.
Anchorable v a b =&gt;
AnchoredSeq v a b -&gt; b -&gt; AnchoredSeq v a b
</span><span class="hs-operator hs-var">:&gt;</span></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211208"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1149"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word
-&gt; SizeInBytes
-&gt; AnchoredFragment header
-&gt; AnchoredFragment header
-&gt; [AnchoredFragment header]
-&gt; [AnchoredFragment header]
</span><a href="#local-6989586621679211198"><span class="hs-identifier hs-var">goFrag</span></a></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679211205"><span class="hs-identifier hs-var">nreqs</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211212"><span class="hs-identifier hs-var">nbytes'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211207"><span class="hs-identifier hs-var">c'</span></a></span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header -&gt; header -&gt; AnchoredFragment header
forall v a b.
Anchorable v a b =&gt;
AnchoredSeq v a b -&gt; b -&gt; AnchoredSeq v a b
</span><span class="hs-operator hs-var">:&gt;</span></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211208"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnchoredFragment header
</span><a href="#local-6989586621679211210"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">[AnchoredFragment header]
</span><a href="#local-6989586621679211211"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-1150"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-1151"></span><span>        </span><span id="local-6989586621679211212"><span class="annot"><span class="annottext">nbytes' :: SizeInBytes
</span><a href="#local-6989586621679211212"><span class="hs-identifier hs-var hs-var">nbytes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SizeInBytes
</span><a href="#local-6989586621679211206"><span class="hs-identifier hs-var">nbytes</span></a></span><span> </span><span class="annot"><span class="annottext">SizeInBytes -&gt; SizeInBytes -&gt; SizeInBytes
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/9f69j6hfgwz5xdil7lfn1c1mbhrhidl1-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">header -&gt; SizeInBytes
</span><a href="#local-6989586621679211185"><span class="hs-identifier hs-var">blockFetchSize</span></a></span><span> </span><span class="annot"><span class="annottext">header
</span><a href="#local-6989586621679211208"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1152"></span><span>      </span><span class="hs-comment">-- Note that we always pick the one last block that crosses the maxbytes</span><span>
</span><span id="line-1153"></span><span>      </span><span class="hs-comment">-- limit. This cover the case where we otherwise wouldn't even be able to</span><span>
</span><span id="line-1154"></span><span>      </span><span class="hs-comment">-- request a single block, as it's too large.</span><span>
</span><span id="line-1155"></span></pre></body></html>